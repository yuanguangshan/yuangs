<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æœ€åé˜²çº¿: å®Œç¾æ“æ§ç‰ˆ</title>
    <style>
        /* --- æ ¸å¿ƒåŸºç¡€è®¾ç½® --- */
        body { 
            margin: 0; overflow: hidden; background-color: #000; 
            touch-action: none; /* ç¦æ­¢æµè§ˆå™¨é»˜è®¤è§¦æ‘¸è¡Œä¸º */
            -webkit-touch-callout: none;
            user-select: none; -webkit-user-select: none;
            font-family: Arial, sans-serif;
        }

        /* æ¸¸æˆç”»é¢å±‚ */
        #game-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }

        /* UI å®¹å™¨ (å±‚çº§ 100) */
        #ui-layer { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 100; pointer-events: none; /* è®©è§¦æ‘¸ç©¿é€ç©ºç™½åŒºåŸŸ */
        }

        /* --- è§¦æ‘¸æ§åˆ¶åŒº (å±‚çº§ 101) --- */
        /* å·¦åŠå±ï¼šç§»åŠ¨ */
        #zone-move {
            position: absolute; top: 0; left: 0; width: 50%; height: 100%;
            z-index: 101; pointer-events: auto;
            /* background: rgba(0, 255, 0, 0.1); è°ƒè¯•ç”¨ */
        }
        /* å³åŠå±ï¼šç„å‡† */
        #zone-aim {
            position: absolute; top: 0; right: 0; width: 50%; height: 100%;
            z-index: 101; pointer-events: auto;
            /* background: rgba(0, 0, 255, 0.1); è°ƒè¯•ç”¨ */
        }

        /* --- æŒ‰é’®ç»„ (å±‚çº§ 102 - æœ€é«˜) --- */
        .btn {
            position: absolute; z-index: 102; pointer-events: auto;
            background: rgba(0, 0, 0, 0.5); border: 2px solid #fff; border-radius: 50%;
            color: white; font-weight: bold; display: flex; justify-content: center; align-items: center;
            box-shadow: 0 0 5px #000; touch-action: none;
        }
        .btn:active { background: rgba(255, 255, 255, 0.5); transform: scale(0.9); }

        /* æŒ‰é’®ä½ç½® */
        #btn-fire { bottom: 80px; right: 40px; width: 80px; height: 80px; background: rgba(255, 50, 50, 0.5); border-color: #ff5555; }
        #btn-reload { bottom: 180px; right: 50px; width: 50px; height: 50px; }
        #btn-switch { bottom: 180px; right: 120px; width: 50px; height: 50px; }
        #btn-scope { display: none; bottom: 250px; right: 50px; width: 60px; height: 60px; background: rgba(0, 255, 255, 0.3); }

        /* è™šæ‹Ÿæ‘‡æ†è§†è§‰ (ä»…æ˜¾ç¤º) */
        #stick-bg {
            position: absolute; width: 100px; height: 100px;
            border: 2px solid rgba(255,255,255,0.3); border-radius: 50%;
            pointer-events: none; display: none; z-index: 105;
        }
        #stick-head {
            position: absolute; width: 40px; height: 40px;
            background: rgba(255,255,255,0.8); border-radius: 50%;
            top: 30px; left: 30px; pointer-events: none;
        }

        /* HUD */
        #hud {
            position: absolute; top: 10px; left: 10px; z-index: 105;
            color: #0f0; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 5px;
            font-size: 14px; pointer-events: none;
        }
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 20px; height: 20px;
            transform: translate(-50%, -50%); pointer-events: none; z-index: 105;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><circle cx="10" cy="10" r="8" fill="none" stroke="white" stroke-width="2"/><line x1="10" y1="2" x2="10" y2="18" stroke="white"/><line x1="2" y1="10" x2="18" y2="10" stroke="white"/></svg>');
        }

        /* é€‰æªç•Œé¢ */
        #menu {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10,10,10,0.95); z-index: 200;
            display: flex; flex-direction: column; align-items: center; padding-top: 20px;
            pointer-events: auto;
        }
        .card {
            background: #222; border: 1px solid #444; width: 80%; padding: 15px; margin: 5px;
            color: #ccc; border-radius: 5px; cursor: pointer;
        }
        .card.selected { border-color: #0f0; background: #003300; color: white; }
        #start-btn {
            margin-top: 20px; padding: 15px 40px; font-size: 20px; background: #444; color: #888;
            border: none; border-radius: 30px; pointer-events: none;
        }
        #start-btn.active { background: #0f0; color: #000; pointer-events: auto; }
        
        /* è¡€æ¡ */
        .hp-bar { position: absolute; height: 4px; background: red; z-index: 90; pointer-events: none; display: none; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>

    <div id="game-container"></div>

    <!-- UI -->
    <div id="ui-layer">
        <div id="hud">
            HP: <span id="ui-hp">100</span> | <span id="ui-wp">--</span> | <span id="ui-ammo">--</span>
            <div id="log" style="font-size:10px; color:yellow; margin-top:5px;">ç­‰å¾…å¼€å§‹...</div>
        </div>
        <div id="crosshair"></div>

        <!-- è§¦æ‘¸åˆ†åŒº -->
        <div id="zone-move"></div>
        <div id="zone-aim"></div>

        <!-- æ‘‡æ†è§†è§‰ -->
        <div id="stick-bg"><div id="stick-head"></div></div>

        <!-- æŒ‰é’® -->
        <div id="btn-fire" class="btn">ğŸ”¥</div>
        <div id="btn-reload" class="btn">â™»ï¸</div>
        <div id="btn-switch" class="btn">âš”ï¸</div>
        <div id="btn-scope" class="btn">ğŸ¯</div>
    </div>

    <!-- èœå• -->
    <div id="menu">
        <h2 style="color:#0f0">ç‚¹å‡»é€‰æ‹© 2 æŠŠæ­¦å™¨</h2>
        <div class="card" onclick="selectWp(0, this)">1. æ­»ç¥ç‹™å‡» (8å€é•œ)</div>
        <div class="card" onclick="selectWp(1, this)">2. å†²é”‹æª (å°„é€Ÿå¿«)</div>
        <div class="card" onclick="selectWp(2, this)">3. é›·ç”µæª (è¿é”é—ªç”µ)</div>
        <div class="card" onclick="selectWp(3, this)">4. åŠ ç‰¹æ— (å¼¹é›¨)</div>
        <div class="card" onclick="selectWp(4, this)">5. ç«ç®­ç‚® (çˆ†ç‚¸AOE)</div>
        <button id="start-btn" onclick="startGame()">å¼€å§‹æˆ˜æ–—</button>
    </div>

<script>
    // --- å…¨å±€çŠ¶æ€ ---
    const GAME = {
        scene: null, camera: null, renderer: null, player: null,
        inputs: { move: {x:0, y:0}, lookX: 0, fire: false }, // lookX æ˜¯æ¯å¸§çš„å¢é‡
        weapons: [], selected: [], curIdx: 0,
        bullets: [], enemies: [], allies: [], particles: [],
        isScoped: false, hp: 100, wave: 1, lastTime: 0,
        isPlaying: false
    };

    const WEAPONS = [
        { name: "æ­»ç¥ç‹™å‡»", dmg: 100, rate: 1.5, mag: 6, type: 'hitscan', sniper: true },
        { name: "å†²é”‹æª", dmg: 12, rate: 0.1, mag: 60, type: 'hitscan' },
        { name: "é›·ç”µæª", dmg: 40, rate: 0.8, mag: 6, type: 'chain' },
        { name: "åŠ ç‰¹æ—", dmg: 8, rate: 0.05, mag: 500, type: 'hitscan' },
        { name: "ç«ç®­ç‚®", dmg: 0, rate: 1.5, mag: 5, type: 'rocket' }
    ];

    function log(msg) { document.getElementById('log').innerText = msg; }

    // --- èœå•é€»è¾‘ ---
    function selectWp(id, el) {
        if(GAME.selected.includes(id)) {
            GAME.selected = GAME.selected.filter(i=>i!==id);
            el.classList.remove('selected');
        } else if(GAME.selected.length < 2) {
            GAME.selected.push(id);
            el.classList.add('selected');
        }
        const btn = document.getElementById('start-btn');
        if(GAME.selected.length===2) btn.classList.add('active');
        else btn.classList.remove('active');
    }

    function startGame() {
        if(GAME.selected.length !== 2) return;
        document.getElementById('menu').style.display = 'none';
        GAME.selected.forEach(id => {
            const w = WEAPONS[id];
            GAME.weapons.push({...w, curAmmo: w.mag, lastFire: 0});
        });
        initThree();
    }

    // --- è¾“å…¥ç³»ç»Ÿ (æ ¸å¿ƒä¿®å¤) ---
    function initInputs() {
        // 1. å·¦ä¾§ç§»åŠ¨ (Zone Move)
        const zMove = document.getElementById('zone-move');
        const stickBg = document.getElementById('stick-bg');
        const stickHead = document.getElementById('stick-head');
        let moveTouchId = null;
        let startX = 0, startY = 0;

        zMove.addEventListener('touchstart', e => {
            e.preventDefault();
            if(moveTouchId !== null) return; // å·²ç»æœ‰æ‰‹æŒ‡äº†
            const t = e.changedTouches[0];
            moveTouchId = t.identifier;
            startX = t.clientX;
            startY = t.clientY;
            
            stickBg.style.display = 'block';
            stickBg.style.left = (startX - 50) + 'px';
            stickBg.style.top = (startY - 50) + 'px';
            stickHead.style.transform = `translate(0px, 0px)`;
            log("ç§»åŠ¨æ‘‡æ†å¯åŠ¨");
        }, {passive: false});

        zMove.addEventListener('touchmove', e => {
            e.preventDefault();
            for(let i=0; i<e.changedTouches.length; i++) {
                if(e.changedTouches[i].identifier === moveTouchId) {
                    const t = e.changedTouches[i];
                    const dx = t.clientX - startX;
                    const dy = t.clientY - startY;
                    const dist = Math.min(Math.sqrt(dx*dx+dy*dy), 40);
                    const angle = Math.atan2(dy, dx);
                    
                    const mx = Math.cos(angle)*dist;
                    const my = Math.sin(angle)*dist;
                    
                    stickHead.style.transform = `translate(${mx}px, ${my}px)`;
                    GAME.inputs.move = { x: mx/40, y: my/40 };
                }
            }
        }, {passive: false});

        const endMove = (e) => {
            for(let i=0; i<e.changedTouches.length; i++) {
                if(e.changedTouches[i].identifier === moveTouchId) {
                    moveTouchId = null;
                    stickBg.style.display = 'none';
                    GAME.inputs.move = {x:0, y:0};
                    log("ç§»åŠ¨åœæ­¢");
                }
            }
        };
        zMove.addEventListener('touchend', endMove);
        zMove.addEventListener('touchcancel', endMove);

        // 2. å³ä¾§ç„å‡† (Zone Aim)
        const zAim = document.getElementById('zone-aim');
        let aimTouchId = null;
        let lastAimX = 0;

        zAim.addEventListener('touchstart', e => {
            e.preventDefault();
            if(aimTouchId !== null) return;
            const t = e.changedTouches[0];
            aimTouchId = t.identifier;
            lastAimX = t.clientX;
            log("ç„å‡†å¯åŠ¨");
        }, {passive: false});

        zAim.addEventListener('touchmove', e => {
            e.preventDefault();
            for(let i=0; i<e.changedTouches.length; i++) {
                if(e.changedTouches[i].identifier === aimTouchId) {
                    const t = e.changedTouches[i];
                    const delta = t.clientX - lastAimX;
                    GAME.inputs.lookX = delta;
                    lastAimX = t.clientX;
                }
            }
        }, {passive: false});

        const endAim = (e) => {
            for(let i=0; i<e.changedTouches.length; i++) {
                if(e.changedTouches[i].identifier === aimTouchId) {
                    aimTouchId = null;
                    GAME.inputs.lookX = 0;
                }
            }
        };
        zAim.addEventListener('touchend', endAim);
        zAim.addEventListener('touchcancel', endAim);

        // 3. æŒ‰é’® (Buttons) - ä½¿ç”¨ touchstart ç¡®ä¿å“åº”æœ€å¿«
        const bindBtn = (id, actionDown, actionUp) => {
            const btn = document.getElementById(id);
            btn.addEventListener('touchstart', e => {
                e.preventDefault(); e.stopPropagation();
                if(actionDown) actionDown();
                btn.style.transform = 'scale(0.9)';
            }, {passive: false});
            btn.addEventListener('touchend', e => {
                e.preventDefault(); e.stopPropagation();
                if(actionUp) actionUp();
                btn.style.transform = 'scale(1)';
            });
        };

        bindBtn('btn-fire', () => GAME.inputs.fire = true, () => GAME.inputs.fire = false);
        
        bindBtn('btn-switch', () => {
            GAME.curIdx = (GAME.curIdx + 1) % 2;
            GAME.isScoped = false;
            updateUI();
            log("åˆ‡æª: " + GAME.weapons[GAME.curIdx].name);
        });

        bindBtn('btn-reload', () => {
            GAME.weapons[GAME.curIdx].curAmmo = GAME.weapons[GAME.curIdx].mag;
            updateUI();
            log("æ¢å¼¹");
        });

        bindBtn('btn-scope', () => {
            GAME.isScoped = !GAME.isScoped;
            updateUI();
        });
    }

    // --- Three.js é€»è¾‘ ---
    function initThree() {
        GAME.scene = new THREE.Scene();
        GAME.scene.background = new THREE.Color(0x0a0a10);
        GAME.scene.fog = new THREE.Fog(0x0a0a10, 20, 100);

        GAME.camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 2000);
        
        GAME.renderer = new THREE.WebGLRenderer({ antialias: true });
        GAME.renderer.setSize(window.innerWidth, window.innerHeight);
        GAME.renderer.shadowMap.enabled = true;
        document.getElementById('game-container').appendChild(GAME.renderer.domElement);

        // ç¯å¢ƒ
        GAME.scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        const dir = new THREE.DirectionalLight(0xffffff, 0.8);
        dir.position.set(50, 80, 50); dir.castShadow = true;
        GAME.scene.add(dir);

        // æ— é™åœ°é¢
        const plane = new THREE.Mesh(new THREE.PlaneGeometry(2000, 2000), new THREE.MeshStandardMaterial({ color: 0x151515 }));
        plane.rotation.x = -Math.PI/2; plane.receiveShadow = true;
        GAME.scene.add(plane);
        GAME.scene.add(new THREE.GridHelper(2000, 200, 0x333333, 0x111111));

        // ç©å®¶
        const pGeo = new THREE.ConeGeometry(0.5, 1.5, 8); pGeo.rotateX(Math.PI/2);
        GAME.player = new THREE.Mesh(pGeo, new THREE.MeshLambertMaterial({color: 0x00ccff}));
        GAME.player.position.y = 1; GAME.player.castShadow = true;
        GAME.scene.add(GAME.player);

        // å†›é˜Ÿ (æ–¹å—äºº)
        for(let i=0; i<10; i++) {
            const ally = new THREE.Mesh(new THREE.BoxGeometry(0.6,0.6,0.6), new THREE.MeshLambertMaterial({color: 0x0044ff}));
            ally.castShadow = true; ally.userData = { lastFire: 0, offsetAngle: (i/10)*Math.PI*2 };
            GAME.scene.add(ally); GAME.allies.push(ally);
        }

        initInputs();
        GAME.isPlaying = true;
        updateUI();
        
        // ç”Ÿæˆæµ‹è¯•æ•Œäºº
        spawnEnemy(); spawnEnemy(); spawnEnemy();
        
        requestAnimationFrame(loop);
    }

    function spawnEnemy() {
        const angle = Math.random() * Math.PI * 2;
        const dist = 30 + Math.random() * 20;
        const group = new THREE.Group();
        group.position.set(GAME.player.position.x + Math.sin(angle)*dist, 0, GAME.player.position.z + Math.cos(angle)*dist);
        
        const body = new THREE.Mesh(new THREE.CylinderGeometry(0.5,0.5,1.8,8), new THREE.MeshLambertMaterial({color:0x00ff00}));
        body.position.y = 0.9;
        const head = new THREE.Mesh(new THREE.BoxGeometry(0.6,0.6,0.6), new THREE.MeshLambertMaterial({color:0x005500}));
        head.position.y = 2.1;
        
        group.add(body); group.add(head);
        group.userData = { hp: 50, maxHp: 50, speed: 4 };

        // è¡€æ¡DOM
        const bar = document.createElement('div');
        bar.className = 'hp-bar';
        bar.style.width = '30px';
        document.body.appendChild(bar);
        group.userData.bar = bar;

        GAME.scene.add(group); GAME.enemies.push(group);
    }

    function loop(time) {
        requestAnimationFrame(loop);
        if(!GAME.isPlaying) return;
        const dt = 0.016; const now = time/1000;

        // 1. ç§»åŠ¨ç©å®¶
        const moveSpd = 10;
        const camDir = new THREE.Vector3(); GAME.camera.getWorldDirection(camDir); camDir.y=0; camDir.normalize();
        const camRight = new THREE.Vector3().crossVectors(camDir, new THREE.Vector3(0,1,0));
        GAME.player.position.addScaledVector(camRight, GAME.inputs.move.x * moveSpd * dt);
        GAME.player.position.addScaledVector(camDir, -GAME.inputs.move.y * moveSpd * dt);

        // 2. æ—‹è½¬è§†è§’
        if(GAME.inputs.lookX !== 0) {
            const sens = GAME.isScoped ? 0.002 : 0.005;
            GAME.player.rotation.y -= GAME.inputs.lookX * sens;
            GAME.inputs.lookX = 0; // æ¶ˆè€—è¾“å…¥
        }

        // 3. ç›¸æœºè·Ÿéš
        const targetPos = GAME.isScoped ? new THREE.Vector3(0.5, 1.5, 1.5) : new THREE.Vector3(0, 5, 8);
        const lookOff = GAME.isScoped ? new THREE.Vector3(0, 1.5, -20) : new THREE.Vector3(0, 1, 0);
        GAME.camera.fov = GAME.isScoped ? 15 : 70;
        GAME.camera.position.lerp(targetPos.applyMatrix4(GAME.player.matrixWorld), 0.2);
        GAME.camera.lookAt(lookOff.applyMatrix4(GAME.player.matrixWorld));
        GAME.camera.updateProjectionMatrix();

        // 4. å†›é˜Ÿè·Ÿéš & æ”»å‡»
        GAME.allies.forEach(a => {
            const tX = GAME.player.position.x + Math.cos(a.userData.offsetAngle)*3;
            const tZ = GAME.player.position.z + Math.sin(a.userData.offsetAngle)*3;
            a.position.x += (tX - a.position.x)*0.1;
            a.position.z += (tZ - a.position.z)*0.1;

            if(now - a.userData.lastFire > 1.0) {
                let near = null, minDist = 6;
                GAME.enemies.forEach(e => { const d=a.position.distanceTo(e.position); if(d<minDist){minDist=d; near=e;} });
                if(near) {
                    a.userData.lastFire = now; a.lookAt(near.position);
                    near.userData.hp -= 10;
                    createSparkle(near.position, 0x0000ff, 3);
                }
            }
        });

        // 5. å°„å‡»é€»è¾‘
        const wp = GAME.weapons[GAME.curIdx];
        if(GAME.inputs.fire && now - wp.lastFire > wp.rate && wp.curAmmo > 0) {
            wp.lastFire = now; wp.curAmmo--; updateUI();
            
            const gunPos = GAME.player.position.clone().add(new THREE.Vector3(0,1,0));
            if(wp.type === 'rocket') {
                const b = new THREE.Mesh(new THREE.SphereGeometry(0.3), new THREE.MeshBasicMaterial({color:'red'}));
                b.position.copy(gunPos);
                const dir = new THREE.Vector3(); GAME.camera.getWorldDirection(dir);
                b.userData = { vel: dir.multiplyScalar(30), type: 'rocket' };
                GAME.scene.add(b); GAME.bullets.push(b);
            } else {
                const ray = new THREE.Raycaster(); ray.setFromCamera(new THREE.Vector2(0,0), GAME.camera);
                const hits = ray.intersectObjects(GAME.enemies, true);
                const endPoint = hits.length ? hits[0].point : new THREE.Vector3(0,0,-100).applyMatrix4(GAME.camera.matrixWorld);
                
                // å…‰æŸç‰¹æ•ˆ
                createTracer(gunPos, endPoint);

                if(hits.length) {
                    const group = hits[0].object.parent;
                    if(group && group.userData.hp) {
                        group.userData.hp -= wp.dmg;
                        createSparkle(endPoint, 0xffff00, 8); // å‡»ä¸­ç‰¹æ•ˆ
                        
                        if(wp.type === 'chain') { // é—ªç”µé“¾
                            GAME.enemies.forEach(e => {
                                if(e!==group && e.position.distanceTo(group.position)<10) {
                                    e.userData.hp -= wp.dmg;
                                    createLightning(group.position, e.position);
                                }
                            });
                        }
                    }
                }
            }
        }

        // 6. æ•Œäººé€»è¾‘
        if(Math.random()<0.01) spawnEnemy(); // éšæœºç”Ÿæˆ
        GAME.enemies.forEach((e, i) => {
            const dir = new THREE.Vector3().subVectors(GAME.player.position, e.position).normalize();
            e.position.addScaledVector(dir, e.userData.speed*dt);
            e.lookAt(GAME.player.position);

            // è¡€æ¡æ›´æ–°
            const bar = e.userData.bar;
            const screen = e.position.clone().add(new THREE.Vector3(0,2.5,0)).project(GAME.camera);
            if(screen.z < 1) {
                bar.style.display = 'block';
                bar.style.left = ((screen.x * 0.5 + 0.5) * window.innerWidth - 15) + 'px';
                bar.style.top = ((-screen.y * 0.5 + 0.5) * window.innerHeight) + 'px';
                bar.style.width = (e.userData.hp / e.userData.maxHp * 30) + 'px';
            } else bar.style.display = 'none';

            if(e.userData.hp <= 0) {
                createExplosion(e.position, 0x00ff00);
                bar.remove(); GAME.scene.remove(e); GAME.enemies.splice(i, 1);
            }
        });

        // 7. å­å¼¹ä¸ç²’å­æ›´æ–°
        for(let i=GAME.bullets.length-1; i>=0; i--) {
            const b = GAME.bullets[i]; b.position.addScaledVector(b.userData.vel, dt);
            if(b.userData.type==='rocket' && b.position.y < 0) {
                createExplosion(b.position, 0xff5500); // çˆ†ç‚¸
                GAME.enemies.forEach(e => { if(e.position.distanceTo(b.position)<15) e.userData.hp-=30; });
                GAME.scene.remove(b); GAME.bullets.splice(i,1);
            } else if(b.position.distanceTo(GAME.player.position)>100) {
                GAME.scene.remove(b); GAME.bullets.splice(i,1);
            }
        }
        updateParticles(dt);

        GAME.renderer.render(GAME.scene, GAME.camera);
    }

    // --- ç‰¹æ•ˆç³»ç»Ÿ ---
    function createTracer(start, end) {
        const mat = new THREE.LineBasicMaterial({color: 0xffaa00, transparent:true, opacity:1});
        const geo = new THREE.BufferGeometry().setFromPoints([start, end]);
        const line = new THREE.Line(geo, mat);
        GAME.scene.add(line);
        setTimeout(() => GAME.scene.remove(line), 50); // ç¬é—´æ¶ˆå¤±
    }

    function createLightning(start, end) {
        const mid = new THREE.Vector3().lerpVectors(start, end, 0.5).add(new THREE.Vector3(Math.random()-0.5, Math.random(), Math.random()-0.5));
        const mat = new THREE.LineBasicMaterial({color: 0x00ffff});
        const geo = new THREE.BufferGeometry().setFromPoints([start, mid, end]);
        const line = new THREE.Line(geo, mat);
        GAME.scene.add(line);
        setTimeout(() => GAME.scene.remove(line), 100);
    }

    function createExplosion(pos, color) {
        for(let i=0; i<10; i++) {
            const p = new THREE.Mesh(new THREE.BoxGeometry(0.5,0.5,0.5), new THREE.MeshBasicMaterial({color: color}));
            p.position.copy(pos);
            const vel = new THREE.Vector3(Math.random()-0.5, Math.random(), Math.random()-0.5).multiplyScalar(10);
            GAME.particles.push({mesh:p, vel:vel, life:1.0});
            GAME.scene.add(p);
        }
    }

    function createSparkle(pos, color, count) { createExplosion(pos, color); }

    function updateParticles(dt) {
        for(let i=GAME.particles.length-1; i>=0; i--) {
            const p = GAME.particles[i]; p.life -= dt;
            p.mesh.position.addScaledVector(p.vel, dt); p.vel.y -= 20*dt;
            p.mesh.scale.setScalar(p.life);
            if(p.life<=0 || p.mesh.position.y<0) {
                GAME.scene.remove(p.mesh); GAME.particles.splice(i,1);
            }
        }
    }

    function updateUI() {
        const w = GAME.weapons[GAME.curIdx];
        document.getElementById('ui-wp').innerText = w.name;
        document.getElementById('ui-ammo').innerText = w.curAmmo + '/' + w.mag;
        document.getElementById('btn-scope').style.display = w.sniper ? 'flex':'none';
        document.getElementById('btn-scope').style.background = GAME.isScoped?'rgba(0,255,255,0.8)':'rgba(0,255,255,0.3)';
    }
</script>
</body>
</html>