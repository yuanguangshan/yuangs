<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æœ€åé˜²çº¿: ç»ˆæä¿®å¤ç‰ˆ</title>
    <style>
        /* åŸºç¡€è®¾ç½® */
        body { 
            margin: 0; overflow: hidden; background-color: #000; 
            touch-action: none; -webkit-touch-callout: none;
            font-family: 'Arial', sans-serif;
            user-select: none; -webkit-user-select: none;
        }
        #game-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        /* UIå±‚ */
        #ui-layer { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 100; pointer-events: none;
        }
        
        .interactive { pointer-events: auto; }

        /* å·¦ä¸Šè§’ HUD */
        #hud-box {
            position: absolute; top: 10px; left: 10px;
            background: rgba(0,0,0,0.5); padding: 10px; border-radius: 8px;
            color: #0f0; font-weight: bold; font-size: 14px;
            border: 1px solid #0f0;
        }

        /* è°ƒè¯•æ—¥å¿— */
        #debug-log {
            color: yellow; font-size: 12px; margin-top: 5px;
        }

        /* æ‘‡æ† */
        .joystick-zone {
            position: absolute; bottom: 40px; width: 120px; height: 120px;
            background: rgba(255, 255, 255, 0.1); border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: flex; justify-content: center; align-items: center;
        }
        #stick-left { left: 40px; }
        #stick-right { right: 40px; }
        
        .stick-knob {
            width: 50px; height: 50px; background: rgba(255, 255, 255, 0.8);
            border-radius: 50%; position: absolute;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        /* æŒ‰é’® */
        .btn {
            position: absolute; background: rgba(0, 0, 0, 0.5); 
            border: 2px solid #fff; border-radius: 50%; 
            color: white; font-weight: bold; font-size: 12px;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 0 5px #000;
        }
        .btn:active { background: rgba(255, 255, 255, 0.5); transform: scale(0.95); }

        #btn-fire { bottom: 80px; right: 180px; width: 70px; height: 70px; background: rgba(255, 0, 0, 0.5); border-color: red; }
        #btn-reload { bottom: 180px; right: 50px; width: 50px; height: 50px; }
        #btn-switch { bottom: 180px; right: 120px; width: 50px; height: 50px; }
        #btn-scope { display: none; bottom: 250px; right: 40px; width: 60px; height: 60px; background: rgba(0, 255, 255, 0.3); }

        /* é€‰æªç•Œé¢ */
        #selection-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 20, 10, 0.95); z-index: 200; 
            display: flex; flex-direction: column; align-items: center; 
            overflow-y: auto; padding-top: 20px;
        }
        .weapon-card {
            background: #222; margin: 8px; padding: 15px; border-radius: 8px; width: 80%; 
            border: 1px solid #444; color: #ccc; display: flex; justify-content: space-between;
            transition: 0.2s;
        }
        .weapon-card.selected { border-color: #0f0; background: #003300; color: #fff; transform: scale(1.02); }
        #start-btn {
            margin: 20px; padding: 15px 40px; font-size: 20px; background: #333; 
            color: #888; border: none; border-radius: 50px; pointer-events: none;
            transition: 0.3s;
        }
        #start-btn.active { background: #00ff00; color: #000; pointer-events: auto; box-shadow: 0 0 20px #0f0; }
        
        /* å‡†å¿ƒ */
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 24px; height: 24px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="2" x2="12" y2="22"/><line x1="2" y1="12" x2="22" y2="12"/></svg>') no-repeat center;
            transform: translate(-50%, -50%); opacity: 0.8; pointer-events: none;
        }

        /* é”å®šæ¡† */
        #lock-box {
            position: absolute; width: 60px; height: 60px;
            border: 2px dashed #f00; border-radius: 50%;
            pointer-events: none; display: none;
            box-shadow: 0 0 10px #f00;
            animation: spin 4s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* è¡€æ¡å®¹å™¨ */
        .hp-bar-container {
            position: absolute; width: 40px; height: 6px; background: #300;
            pointer-events: none; z-index: 10; display: none; border: 1px solid #fff;
        }
        .hp-bar-fill { height: 100%; background: #f00; width: 100%; transition: width 0.1s; }
    </style>
    <!-- ä½¿ç”¨æ›´æ–°ç‰ˆæœ¬çš„ Three.js ç¡®ä¿å…¼å®¹æ€§ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>

    <div id="game-container"></div>
    
    <!-- UIå±‚ -->
    <div id="ui-layer">
        <div id="hud-box">
            <div>HP: <span id="hp" style="color:white">100</span></div>
            <div>æ­¦å™¨: <span id="wp-name" style="color:yellow">--</span></div>
            <div>å¼¹è¯: <span id="ammo" style="color:cyan">--</span></div>
            <div>æ³¢æ•°: <span id="wave" style="color:orange">1</span></div>
            <div id="debug-log">è¯·é€‰æ‹©æ­¦å™¨...</div>
        </div>
        
        <div id="crosshair"></div>
        <div id="lock-box"></div>

        <!-- æ§ä»¶ -->
        <div id="stick-left" class="joystick-zone interactive"><div class="stick-knob"></div></div>
        <div id="stick-right" class="joystick-zone interactive"><div class="stick-knob"></div></div>

        <div id="btn-fire" class="btn interactive">ğŸ”¥</div>
        <div id="btn-reload" class="btn interactive">â™»ï¸</div>
        <div id="btn-switch" class="btn interactive">âš”ï¸</div>
        <div id="btn-scope" class="btn interactive">ğŸ¯</div>
    </div>

    <!-- é€‰æªç•Œé¢ -->
    <div id="selection-screen">
        <h2 style="color:#0f0; text-shadow:0 0 10px #0f0">ç‚¹å‡»é€‰æ‹© 2 æŠŠæ­¦å™¨</h2>
        <div class="weapon-card interactive" onclick="selectWeapon(0, this)">
            <div><strong>1. æ­»ç¥ç‹™å‡»æª</strong><br><small>æé«˜ä¼¤å®³ | 8å€é•œ</small></div>
        </div>
        <div class="weapon-card interactive" onclick="selectWeapon(1, this)">
            <div><strong>2. ç–¾é£å†²é”‹æª</strong><br><small>æå¿«å°„é€Ÿ | 60å‘</small></div>
        </div>
        <div class="weapon-card interactive" onclick="selectWeapon(2, this)">
            <div><strong>3. é›·éœ†è¿é”æª</strong><br><small>é—ªç”µæ”»å‡»å‘¨å›´æ•Œäºº</small></div>
        </div>
        <div class="weapon-card interactive" onclick="selectWeapon(3, this)">
            <div><strong>4. æ— æ•ŒåŠ ç‰¹æ—</strong><br><small>500å‘ | å¼¹é›¨å‹åˆ¶</small></div>
        </div>
        <div class="weapon-card interactive" onclick="selectWeapon(4, this)">
            <div><strong>5. æ¯ç­ç«ç®­ç‚®</strong><br><small>èŒƒå›´çˆ†ç‚¸ | AOE</small></div>
        </div>
        <button id="start-btn" class="interactive" onclick="startGame()">å¯åŠ¨é˜²å¾¡ç³»ç»Ÿ</button>
    </div>

<script>
    // --- æ—¥å¿— ---
    function log(msg) {
        document.getElementById('debug-log').innerText = msg;
    }

    // --- æ¸¸æˆçŠ¶æ€ ---
    const GAME = {
        scene: null, camera: null, renderer: null,
        player: null,
        inputs: { move: {x:0, y:0}, aim: {x:0, y:0}, fire: false },
        bullets: [], enemies: [], allies: [],
        weapons: [], selected: [], currentIdx: 0,
        isScoped: false,
        hp: 100,
        wave: 1,
        enemySpawnTimer: 0,
        isPlaying: false
    };

    const WEAPONS_DB = [
        { name: "æ­»ç¥ç‹™å‡»", dmg: 100, rate: 1.5, mag: 6, type: 'hitscan', sniper: true },
        { name: "å†²é”‹æª", dmg: 12, rate: 0.1, mag: 60, type: 'hitscan' },
        { name: "é›·ç”µæª", dmg: 40, rate: 0.8, mag: 6, type: 'chain' },
        { name: "åŠ ç‰¹æ—", dmg: 8, rate: 0.05, mag: 500, type: 'hitscan' },
        { name: "ç«ç®­ç‚®", dmg: 0, rate: 1.5, mag: 5, type: 'rocket' }
    ];

    // --- é€‰æª ---
    function selectWeapon(id, el) {
        if (GAME.selected.includes(id)) {
            GAME.selected = GAME.selected.filter(i => i !== id);
            el.classList.remove('selected');
        } else {
            if (GAME.selected.length < 2) {
                GAME.selected.push(id);
                el.classList.add('selected');
            }
        }
        const btn = document.getElementById('start-btn');
        if (GAME.selected.length === 2) {
            btn.classList.add('active');
            btn.innerText = ">>> ç‚¹å‡»å¼€å§‹æˆ˜æ–— <<<";
        } else {
            btn.classList.remove('active');
            btn.innerText = `å·²é€‰ ${GAME.selected.length}/2`;
        }
    }

    function startGame() {
        if (GAME.selected.length !== 2) return;
        document.getElementById('selection-screen').style.display = 'none';
        
        // è½½å…¥æ­¦å™¨
        GAME.selected.forEach(idx => {
            const w = WEAPONS_DB[idx];
            GAME.weapons.push({ ...w, curAmmo: w.mag, lastFire: 0 });
        });

        initGame();
    }

    // --- æ‘‡æ†ç³»ç»Ÿ (Pointer Events) ---
    function bindJoystick(id, inputKey) {
        const zone = document.getElementById(id);
        const knob = zone.querySelector('.stick-knob');
        let startX=0, startY=0, dragging=false;

        zone.addEventListener('pointerdown', e => {
            dragging = true;
            zone.setPointerCapture(e.pointerId);
            const rect = zone.getBoundingClientRect();
            startX = rect.left + rect.width/2;
            startY = rect.top + rect.height/2;
            handleMove(e);
        });

        zone.addEventListener('pointermove', e => { if(dragging) handleMove(e); });
        
        zone.addEventListener('pointerup', () => {
            dragging = false;
            knob.style.transform = `translate(0px,0px)`;
            GAME.inputs[inputKey] = {x:0, y:0};
        });

        function handleMove(e) {
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            const dist = Math.min(Math.sqrt(dx*dx+dy*dy), 40);
            const angle = Math.atan2(dy, dx);
            const mx = Math.cos(angle)*dist;
            const my = Math.sin(angle)*dist;
            knob.style.transform = `translate(${mx}px, ${my}px)`;
            GAME.inputs[inputKey] = { x: mx/40, y: my/40 };
        }
    }

    // --- æŒ‰é’®ç³»ç»Ÿ ---
    function bindButtons() {
        const btnFire = document.getElementById('btn-fire');
        btnFire.addEventListener('pointerdown', e => { 
            e.preventDefault(); GAME.inputs.fire = true; btnFire.style.transform='scale(0.9)'; 
        });
        btnFire.addEventListener('pointerup', e => { 
            e.preventDefault(); GAME.inputs.fire = false; btnFire.style.transform='scale(1)'; 
        });

        document.getElementById('btn-switch').addEventListener('pointerdown', e => {
            e.preventDefault();
            GAME.currentIdx = (GAME.currentIdx + 1) % 2;
            GAME.isScoped = false;
            updateUI();
            log("åˆ‡æ¢æ­¦å™¨: " + GAME.weapons[GAME.currentIdx].name);
        });

        document.getElementById('btn-reload').addEventListener('pointerdown', e => {
            e.preventDefault();
            GAME.weapons[GAME.currentIdx].curAmmo = GAME.weapons[GAME.currentIdx].mag;
            updateUI();
            log("è£…å¼¹å®Œæ¯•!");
        });

        document.getElementById('btn-scope').addEventListener('pointerdown', e => {
            e.preventDefault();
            GAME.isScoped = !GAME.isScoped;
            updateUI();
        });
    }

    // --- Three.js åˆå§‹åŒ– ---
    function initGame() {
        GAME.scene = new THREE.Scene();
        GAME.scene.background = new THREE.Color(0x050505); // æ·±é»‘èƒŒæ™¯
        GAME.scene.fog = new THREE.Fog(0x050505, 15, 60);

        GAME.camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 100);
        GAME.renderer = new THREE.WebGLRenderer({ antialias: true });
        GAME.renderer.setSize(window.innerWidth, window.innerHeight);
        GAME.renderer.shadowMap.enabled = true;
        document.getElementById('game-container').appendChild(GAME.renderer.domElement);

        // ç¯å…‰
        const amb = new THREE.AmbientLight(0xffffff, 0.4);
        GAME.scene.add(amb);
        const dir = new THREE.DirectionalLight(0xffffff, 0.8);
        dir.position.set(20, 40, 20);
        dir.castShadow = true;
        GAME.scene.add(dir);

        // åœ°é¢
        const plane = new THREE.Mesh(
            new THREE.PlaneGeometry(100, 100),
            new THREE.MeshStandardMaterial({ color: 0x222222 })
        );
        plane.rotation.x = -Math.PI/2;
        plane.receiveShadow = true;
        GAME.scene.add(plane);
        
        // åœ°é¢ç½‘æ ¼
        GAME.scene.add(new THREE.GridHelper(100, 20, 0x444444, 0x111111));

        // ç©å®¶ (é£èˆ¹)
        const pGeo = new THREE.ConeGeometry(0.8, 2, 8);
        pGeo.rotateX(Math.PI/2);
        GAME.player = new THREE.Mesh(
            pGeo,
            new THREE.MeshLambertMaterial({ color: 0x00aaff, emissive: 0x0044aa })
        );
        GAME.player.position.y = 1.5;
        GAME.player.add(new THREE.PointLight(0x00aaff, 1, 10));
        GAME.scene.add(GAME.player);

        // å†›é˜Ÿ (è“è‰²æ–¹å—é˜µ)
        for(let i=0; i<10; i++) {
            const angle = (i/10)*Math.PI*2;
            const ally = new THREE.Mesh(
                new THREE.BoxGeometry(0.6, 0.6, 0.6),
                new THREE.MeshLambertMaterial({ color: 0x0000ff })
            );
            ally.position.set(Math.cos(angle)*4, 0.5, Math.sin(angle)*4);
            ally.userData = { lastFire: 0 };
            GAME.scene.add(ally);
            GAME.allies.push(ally);
        }

        bindJoystick('stick-left', 'move');
        bindJoystick('stick-right', 'aim');
        bindButtons();

        GAME.isPlaying = true;
        updateUI();
        
        // åˆå§‹ç”Ÿæˆ3ä¸ªå¤–æ˜Ÿäºº
        for(let i=0; i<3; i++) spawnEnemy();
        log("ç³»ç»Ÿå¯åŠ¨! å¤–æ˜Ÿäººæ¥è¿‘ä¸­!");

        animate();
    }

    // --- å¤–æ˜Ÿäººç”Ÿæˆ (ä¿®å¤ç‰ˆ) ---
    function spawnEnemy() {
        // åœ¨ç©å®¶å‘¨å›´ 20-30 ç±³ç”Ÿæˆ
        const angle = Math.random() * Math.PI * 2;
        const dist = 20 + Math.random() * 10;
        const x = GAME.player.position.x + Math.sin(angle)*dist;
        const z = GAME.player.position.z + Math.cos(angle)*dist;

        const group = new THREE.Group();
        group.position.set(x, 0, z);

        // èº«ä½“ - ä½¿ç”¨ Cylinder è€Œä¸æ˜¯ Capsule ä»¥é˜²ç‰ˆæœ¬ä¸å…¼å®¹
        const body = new THREE.Mesh(
            new THREE.CylinderGeometry(0.5, 0.5, 1.8, 8),
            new THREE.MeshStandardMaterial({ color: 0x00ff00, emissive: 0x004400 })
        );
        body.position.y = 0.9;
        
        // å¤´éƒ¨
        const head = new THREE.Mesh(
            new THREE.BoxGeometry(0.8, 0.6, 0.8),
            new THREE.MeshStandardMaterial({ color: 0x008800 })
        );
        head.position.y = 2.0;

        // çœ¼ç› (çº¢è‰²å‘å…‰)
        const eye = new THREE.Mesh(
            new THREE.SphereGeometry(0.15),
            new THREE.MeshBasicMaterial({ color: 0xff0000 })
        );
        eye.position.set(0, 2.1, 0.4);

        group.add(body);
        group.add(head);
        group.add(eye);
        
        // æ•°æ®
        group.userData = { hp: 50, maxHp: 50, speed: 3 + Math.random()*2 };
        
        // è¡€æ¡ DOM
        const bar = document.createElement('div');
        bar.className = 'hp-bar-container';
        bar.innerHTML = '<div class="hp-bar-fill"></div>';
        document.body.appendChild(bar);
        group.userData.bar = bar;

        GAME.scene.add(group);
        GAME.enemies.push(group);
    }

    // --- æ ¸å¿ƒå¾ªç¯ ---
    function animate() {
        requestAnimationFrame(animate);
        if(!GAME.isPlaying) return;

        const dt = 0.016;
        const now = performance.now()/1000;

        // 1. ç©å®¶ç§»åŠ¨
        const camDir = new THREE.Vector3();
        GAME.camera.getWorldDirection(camDir);
        camDir.y=0; camDir.normalize();
        const camRight = new THREE.Vector3().crossVectors(camDir, new THREE.Vector3(0,1,0));
        
        GAME.player.position.addScaledVector(camRight, GAME.inputs.move.x * 10 * dt);
        GAME.player.position.addScaledVector(camDir, -GAME.inputs.move.y * 10 * dt);

        // 2. ç„å‡†æ—‹è½¬
        GAME.player.rotation.y -= GAME.inputs.aim.x * 2.5 * dt;

        // 3. ç›¸æœºè·Ÿéš
        if(GAME.isScoped) {
            GAME.camera.fov = 15;
            const target = GAME.player.position.clone().add(new THREE.Vector3(0, 2, 0));
            const offset = new THREE.Vector3(0.5, 1.5, 1).applyMatrix4(GAME.player.matrixWorld);
            GAME.camera.position.lerp(offset, 0.5);
            
            const lookAtPoint = new THREE.Vector3(0, 1.5, -20).applyMatrix4(GAME.player.matrixWorld);
            GAME.camera.lookAt(lookAtPoint);
        } else {
            GAME.camera.fov = 70;
            const target = GAME.player.position.clone().add(new THREE.Vector3(0, 2, 0));
            const offset = new THREE.Vector3(0, 6, 8).applyMatrix4(GAME.player.matrixWorld);
            GAME.camera.position.lerp(offset, 0.1);
            GAME.camera.lookAt(target);
        }
        GAME.camera.updateProjectionMatrix();

        // 4. å†›é˜Ÿè·Ÿéš
        GAME.allies.forEach((a, i) => {
            const angle = (i/10)*Math.PI*2 + now*0.5; // æ—‹è½¬é˜µå‹
            const tx = GAME.player.position.x + Math.cos(angle)*5;
            const tz = GAME.player.position.z + Math.sin(angle)*5;
            a.position.x += (tx - a.position.x)*0.1;
            a.position.z += (tz - a.position.z)*0.1;
            
            // å†›é˜Ÿè‡ªåŠ¨æ”»å‡»
            if(now - a.userData.lastFire > 2.0) {
                const target = getNearestEnemy(a.position, 25);
                if(target) {
                    a.userData.lastFire = now;
                    shootEffect(a.position, target.position, 0x00ffff);
                    target.userData.hp -= 15;
                }
            }
        });

        // 5. æ•Œäººé€»è¾‘
        GAME.enemySpawnTimer += dt;
        if(GAME.enemySpawnTimer > 2.0) { // æ¯2ç§’ç”Ÿæˆ
            GAME.enemySpawnTimer = 0;
            spawnEnemy();
        }

        // è‡ªåŠ¨é”å®šæœ€è¿‘æ•Œäººç”¨äºUIæ˜¾ç¤º
        const nearest = getNearestEnemy(GAME.player.position, 100);
        const lockBox = document.getElementById('lock-box');
        if(nearest) {
            const pos = nearest.position.clone();
            pos.y += 1.5;
            pos.project(GAME.camera);
            if(pos.z < 1) {
                const x = (pos.x * .5 + .5) * window.innerWidth;
                const y = (-pos.y * .5 + .5) * window.innerHeight;
                lockBox.style.display = 'block';
                lockBox.style.left = (x-30)+'px';
                lockBox.style.top = (y-30)+'px';
            } else { lockBox.style.display = 'none'; }
        } else { lockBox.style.display = 'none'; }

        GAME.enemies.forEach((en, i) => {
            // ç§»åŠ¨
            const dir = new THREE.Vector3().subVectors(GAME.player.position, en.position).normalize();
            en.position.addScaledVector(dir, en.userData.speed * dt);
            en.lookAt(GAME.player.position);

            // è¡€æ¡æ›´æ–°
            const bar = en.userData.bar;
            const screenPos = en.position.clone().add(new THREE.Vector3(0, 3, 0)).project(GAME.camera);
            if(screenPos.z < 1) {
                bar.style.display = 'block';
                bar.style.left = ((screenPos.x*.5+.5)*window.innerWidth - 20) + 'px';
                bar.style.top = ((-screenPos.y*.5+.5)*window.innerHeight) + 'px';
                bar.children[0].style.width = (en.userData.hp/en.userData.maxHp*100)+'%';
            } else { bar.style.display = 'none'; }

            // ä¼¤å®³åˆ¤å®š
            if(en.position.distanceTo(GAME.player.position) < 1.5) {
                GAME.hp -= 0.2;
                updateUI();
            }

            // æ­»äº¡
            if(en.userData.hp <= 0) {
                bar.remove();
                GAME.scene.remove(en);
                GAME.enemies.splice(i, 1);
                createExplosion(en.position, 0x00ff00);
            }
        });

        // 6. å°„å‡»
        const wp = GAME.weapons[GAME.currentIdx];
        if(GAME.inputs.fire && now - wp.lastFire > wp.rate && wp.curAmmo > 0) {
            wp.lastFire = now;
            wp.curAmmo--;
            updateUI();
            
            if(wp.type === 'rocket') {
                const b = new THREE.Mesh(new THREE.SphereGeometry(0.5), new THREE.MeshBasicMaterial({color:'red'}));
                b.position.copy(GAME.player.position).add(new THREE.Vector3(0,1,0));
                const dir = new THREE.Vector3();
                GAME.camera.getWorldDirection(dir);
                b.userData = { vel: dir.multiplyScalar(30), type:'rocket' };
                GAME.scene.add(b);
                GAME.bullets.push(b);
            } else {
                // å°„çº¿
                const ray = new THREE.Raycaster();
                ray.setFromCamera(new THREE.Vector2(0,0), GAME.camera);
                const hits = ray.intersectObjects(GAME.enemies, true); // true æ£€æµ‹å­å¯¹è±¡
                
                // è§†è§‰çº¿
                const end = new THREE.Vector3(0,0,-100).applyMatrix4(GAME.camera.matrixWorld);
                
                if(hits.length > 0) {
                    const hitObj = hits[0].object;
                    const group = hitObj.parent; // è·å–ç»„
                    if(group && group.userData.hp) {
                        group.userData.hp -= wp.dmg;
                        shootEffect(GAME.player.position, hits[0].point, 0xffff00);
                        
                        // è¿é”é—ªç”µ
                        if(wp.type === 'chain') {
                            GAME.enemies.forEach(other => {
                                if(other !== group && other.position.distanceTo(group.position) < 15) {
                                    other.userData.hp -= wp.dmg;
                                    shootEffect(group.position, other.position, 0x00ffff);
                                }
                            });
                        }
                    }
                } else {
                    shootEffect(GAME.player.position, end, 0xffff00);
                }
            }
        }

        // 7. å­å¼¹(ç«ç®­)æ›´æ–°
        for(let i=GAME.bullets.length-1; i>=0; i--) {
            const b = GAME.bullets[i];
            b.position.addScaledVector(b.userData.vel, dt);
            if(b.position.distanceTo(GAME.player.position) > 100 || b.position.y < 0) {
                if(b.userData.type === 'rocket') {
                    createExplosion(b.position, 0xffaa00);
                    // çˆ†ç‚¸ä¼¤å®³
                    GAME.enemies.forEach(en => {
                        if(en.position.distanceTo(b.position) < 15) en.userData.hp -= 30;
                    });
                }
                GAME.scene.remove(b);
                GAME.bullets.splice(i, 1);
            }
        }

        GAME.renderer.render(GAME.scene, GAME.camera);
    }

    function getNearestEnemy(pos, range) {
        let best = null, minDist = range;
        GAME.enemies.forEach(en => {
            const d = en.position.distanceTo(pos);
            if(d < minDist) { minDist = d; best = en; }
        });
        return best;
    }

    function shootEffect(start, end, color) {
        const geo = new THREE.BufferGeometry().setFromPoints([start, end]);
        const line = new THREE.Line(geo, new THREE.LineBasicMaterial({ color: color }));
        GAME.scene.add(line);
        setTimeout(() => GAME.scene.remove(line), 100);
    }

    function createExplosion(pos, color) {
        const p = new THREE.Mesh(new THREE.BoxGeometry(2,2,2), new THREE.MeshBasicMaterial({color:color}));
        p.position.copy(pos);
        GAME.scene.add(p);
        setTimeout(() => GAME.scene.remove(p), 200);
    }

    function updateUI() {
        if(GAME.hp <= 0) { alert("ä»»åŠ¡å¤±è´¥!"); location.reload(); }
        const wp = GAME.weapons[GAME.currentIdx];
        document.getElementById('hp').innerText = Math.floor(GAME.hp);
        document.getElementById('wp-name').innerText = wp.name;
        document.getElementById('ammo').innerText = wp.curAmmo + '/' + wp.mag;
        
        const btnScope = document.getElementById('btn-scope');
        btnScope.style.display = wp.sniper ? 'flex' : 'none';
        btnScope.style.background = GAME.isScoped ? 'rgba(0,255,255,0.8)' : 'rgba(0,255,255,0.3)';
    }

</script>
</body>
</html>