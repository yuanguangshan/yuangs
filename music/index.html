<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ÂπøÂ±±Èü≥‰πê</title>

    <!-- PWA Ê†∏ÂøÉÈÖçÁΩÆ -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#0a0a0a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ÂπøÂ±±Èü≥‰πê">
    
    <!-- ÂõæÊ†áÈÖçÁΩÆ -->
    <link rel="icon" type="image/x-icon" href="./icon/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="./icon/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./icon/icon-16x16.png">
    <link rel="apple-touch-icon" href="./icon/apple-touch-icon.png">

    <style>
        :root {
            --primary: #1db954;
            --primary-dark: #1aa34a;
            --accent: #ff6b6b;
            --bg: #0a0a0a;
            --card: #161616;
            --card-hover: #1f1f1f;
            --text: #ffffff;
            --text-secondary: #a0a0a0;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        /* Ëá™ÂÆö‰πâÊªöÂä®Êù° */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
            position: relative;
        }

        /* Âä®ÊÄÅËÉåÊôØ */
        .bg-gradient {
            position: fixed;
            inset: 0;
            z-index: 0;
            opacity: 0.6;
            transition: opacity 0.8s ease;
            background: radial-gradient(ellipse at 50% 0%, var(--primary) 0%, transparent 50%),
                        radial-gradient(ellipse at 80% 50%, #6366f1 0%, transparent 40%),
                        radial-gradient(ellipse at 20% 80%, #ec4899 0%, transparent 40%);
            filter: blur(80px) saturate(150%);
        }

        .bg-album {
            position: fixed;
            inset: 0;
            z-index: 0;
            background-size: cover;
            background-position: center;
            opacity: 0;
            transition: opacity 1s ease;
            filter: blur(60px) brightness(0.4) saturate(120%);
        }

        .bg-album.active {
            opacity: 0.7;
        }

        /* È°∂ÈÉ®ÊêúÁ¥¢Ê†è */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: calc(8px + var(--safe-top)) 16px 8px;
            background: linear-gradient(to bottom, rgba(10,10,10,0.95) 0%, rgba(10,10,10,0.8) 70%, transparent 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .search-box {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .search-input {
            width: 100%;
            height: 40px;
            padding: 0 40px 0 18px; /* Add padding on the right to make space for clear button */
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            background: var(--glass);
            color: var(--text);
            font-size: 15px;
            outline: none;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: var(--primary);
            background: rgba(29, 185, 84, 0.1);
        }

        .search-input::placeholder {
            color: var(--text-secondary);
        }

        .search-input-container {
            position: relative;
            flex: 1;
            min-width: 120px;
            max-width: 300px;
        }

        .search-clear-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .search-clear-btn:hover {
            background: var(--glass-border);
            color: var(--text);
        }

        .btn {
            height: 40px;
            padding: 0 18px;
            border-radius: 20px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: var(--text);
            font-size: 18px;
        }

        .btn-icon:hover {
            background: var(--glass-border);
        }

        /* ÂÜÖÂÆπÂå∫ */
        .content {
            position: relative;
            z-index: 1;
            padding: calc(72px + var(--safe-top)) 16px calc(200px + var(--safe-bottom));
            min-height: 100vh;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
        }

        /* Ê≠åÊõ≤Âç°Áâá */
        .song-card {
            background: var(--card);
            border-radius: 12px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            position: relative;
        }

        .song-options {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .song-card:hover .song-options {
            opacity: 1;
        }

        .song-card:hover {
            background: var(--card-hover);
            transform: translateY(-4px);
            border-color: var(--glass-border);
        }

        .song-card:active {
            transform: scale(0.98);
        }

        .song-card.playing {
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(29, 185, 84, 0.3);
        }

        .song-cover {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 12px;
            object-fit: cover;
            background: #222;
            margin-bottom: 8px;
            position: relative;
            overflow: hidden;
        }

        .song-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .song-card:hover .song-cover img {
            transform: scale(1.05);
        }

        .play-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .song-card:hover .play-overlay,
        .song-card.playing .play-overlay {
            opacity: 1;
        }

        .play-overlay-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }

        .song-title {
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }

        .song-artist {
            font-size: 11px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Â∫ïÈÉ®Êí≠ÊîæÂô® - ÂÖ®Êñ∞ËÆæËÆ° */
        .player {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 0 16px calc(16px + var(--safe-bottom));
            background: linear-gradient(to top, rgba(10,10,10,1) 0%, rgba(10,10,10,0.95) 50%, transparent 100%);
            pointer-events: none;
        }

        .player-card {
            background: var(--card);
            border-radius: 24px;
            padding: 12px 16px 16px;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            box-shadow: 0 -4px 30px rgba(0,0,0,0.5);
            pointer-events: auto;
        }

        /* È°∂ÈÉ®‰ø°ÊÅØÊ†è */
        .player-info-bar {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 12px;
            padding: 8px 12px;
            background: var(--glass);
            border-radius: 12px;
            overflow: hidden;
            position: relative; /* Allow proper alignment of the wiki button */
        }

        .player-label {
            font-size: 12px;
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .player-text-wrapper {
            overflow: hidden;
            white-space: nowrap;
            flex-shrink: 1;
            min-width: 0;
            position: relative;
        }

        .title-wrapper {
            max-width: 200px;
        }

        .artist-wrapper {
            max-width: 150px;
        }

        .player-title-text {
            display: inline-block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            cursor: pointer;
            transition: color 0.2s ease;
            white-space: nowrap;
        }

        .player-title-text:hover {
            color: var(--primary);
        }

        .player-separator {
            font-size: 12px;
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .player-artist-text {
            display: inline-block;
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.2s ease;
            white-space: nowrap;
        }

        .player-artist-text:hover {
            color: var(--primary);
        }

        /* ÂìçÂ∫îÂºèË∞ÉÊï¥ */
        @media (max-width: 767px) {
            .title-wrapper {
                max-width: 120px;
            }
            .artist-wrapper {
                max-width: 100px;
            }
        }

        .player-wiki-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary); /* Default not highlighted */
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
            padding: 0;
            margin-left: auto; /* Push to the right */
        }

        .player-wiki-btn:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
        }

        /* ÊªöÂä®Âä®Áîª */
        .scroll-text {
            animation: scroll-left var(--duration, 10s) linear infinite alternate;
        }
        
        @keyframes scroll-left {
            0%, 10% { transform: translateX(0); }
            90%, 100% { transform: translateX(var(--scroll-distance, -50%)); }
        }

        /* ‰∏ªÊéßÂà∂Âå∫ */
        .player-main {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .player-cover {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            object-fit: cover;
            background: #222;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            cursor: pointer;
        }

        .player-cover.spinning {
            animation: spin 8s linear infinite;
            border-radius: 50%;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(-360deg); }
        }

        .player-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
            margin-left: auto;
        }

        .ctrl-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: var(--text);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            opacity: 0.6;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ctrl-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            opacity: 1;
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(29, 185, 84, 0.5);
        }

        .ctrl-btn:active {
            transform: scale(0.95);
        }

        .ctrl-btn.play {
            width: 56px;
            height: 56px;
            background: var(--primary);
            color: white;
            font-size: 24px;
            opacity: 0.9;
            box-shadow: 0 0 25px rgba(29, 185, 84, 0.3);
        }

        .ctrl-btn.play:hover {
            background: var(--primary-dark);
            opacity: 1;
            transform: scale(1.08);
            box-shadow: 0 0 30px rgba(29, 185, 84, 0.6);
        }

        .ctrl-btn.play:active {
            transform: scale(0.95);
        }

        /* ËøõÂ∫¶Êù° */
        .progress-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .time {
            font-size: 11px;
            color: var(--text-secondary);
            min-width: 36px;
            text-align: center;
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            border-radius: 2px;
            transition: width 0.1s linear;
        }

        .progress-bar:hover .progress-fill {
            background: #1ed760;
        }

        /* Ê≠åËØçËØ¶ÊÉÖÈ°µ */
        .lyrics-modal {
            position: fixed;
            inset: 0;
            z-index: 200;
            background: var(--bg);
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            overflow-y: auto;
            padding: calc(60px + var(--safe-top)) 24px calc(24px + var(--safe-bottom));
        }

        .lyrics-modal.show {
            transform: translateY(0);
        }

        .lyrics-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: calc(16px + var(--safe-top)) 24px 16px;
            background: linear-gradient(to bottom, var(--bg) 0%, transparent 100%);
            z-index: 10;
        }

        .lyrics-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--glass);
            border: none;
            color: var(--text);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lyrics-cover {
            width: 200px;
            height: 200px;
            border-radius: 20px;
            margin: 0 auto 24px;
            display: block;
            box-shadow: 0 8px 40px rgba(0,0,0,0.5);
        }

        .lyrics-title {
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 8px;
        }

        .lyrics-artist {
            font-size: 16px;
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 32px;
            display: inline-block;
        }

        .lyrics-artist-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 32px;
        }

        .lyrics-artist.clickable:hover {
            color: var(--primary);
        }

        .lyrics-wiki {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            border-left: 3px solid var(--primary);
            display: none;
        }

        .lyrics-wiki.show {
            display: block;
        }

        .lyrics-wiki-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .lyrics-wiki-text {
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .lyrics-text {
            font-size: 18px;
            line-height: 2;
            color: var(--text-secondary);
            text-align: center;
            white-space: pre-wrap;
        }

        /* ÂºπÂπï */
        .danmaku {
            position: fixed;
            top: calc(100px + var(--safe-top));
            left: 0;
            right: 0;
            height: 200px;
            z-index: 50;
            pointer-events: none;
            overflow: hidden;
            mask-image: linear-gradient(to bottom, transparent, black 15%, black 85%, transparent);
            display: none;
        }

        .danmaku.show {
            display: block;
        }

        .danmaku-item {
            position: absolute;
            left: 100%;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            white-space: nowrap;
            animation: danmaku-slide linear forwards;
        }

        .danmaku-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }

        .danmaku-name {
            color: var(--primary);
            font-weight: 600;
            font-size: 13px;
        }

        .danmaku-text {
            font-size: 13px;
            color: var(--text);
        }

        @keyframes danmaku-slide {
            from { transform: translateX(0); }
            to { transform: translateX(calc(-100% - 100vw)); }
        }

        /* Á©∫Áä∂ÊÄÅ */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
        }

        .empty-desc {
            font-size: 14px;
            line-height: 1.6;
        }

        /* Âä†ËΩΩÁä∂ÊÄÅ */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--glass-border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: loading-spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes loading-spin {
            to { transform: rotate(360deg); }
        }

        /* PWA ÂÆâË£ÖÊèêÁ§∫ */
        .install-prompt {
            position: fixed;
            bottom: calc(200px + var(--safe-bottom));
            left: 16px;
            right: 16px;
            z-index: 150;
            background: var(--card);
            border-radius: 16px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            animation: slide-up 0.4s ease;
        }

        @keyframes slide-up {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
        }

        .install-icon {
            font-size: 32px;
        }

        .install-text {
            flex: 1;
        }

        .install-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .install-desc {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .install-btn {
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 20px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
        }

        .install-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--glass);
            border: none;
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Êî∂ËóèÊåâÈíÆÊ†∑Âºè */
        .favorite-btn {
            font-size: 22px;
            transition: all 0.3s ease;
            border: none;
            box-shadow: none !important;
        }

        .ctrl-btn.favorite-btn:hover,
        .favorite-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            box-shadow: none !important;
            transform: scale(1.1);
        }

        .favorite-btn.favorited {
            color: #ff6b6b;
            animation: heartBeat 0.3s ease;
        }

        @keyframes heartBeat {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.3); }
            50% { transform: scale(1.1); }
            75% { transform: scale(1.2); }
        }

        /* Êî∂ËóèÂíåÂéÜÂè≤ÂºπÁ™ó */
        .collection-modal {
            position: fixed;
            inset: 0;
            z-index: 200;
            background: var(--bg);
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .collection-modal.show {
            transform: translateY(0);
        }

        .collection-header {
            position: sticky;
            top: 0;
            padding: calc(20px + var(--safe-top)) 24px 20px;
            background: linear-gradient(to bottom, var(--bg) 0%, rgba(10,10,10,0.95) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--glass-border);
        }

        .collection-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text);
        }

        .collection-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn-action {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: var(--text);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .btn-action:hover {
            background: var(--glass-border);
            transform: scale(1.1);
        }

        .btn-action:active {
            transform: scale(0.95);
        }

        .collection-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--glass);
            border: none;
            color: var(--text);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .collection-close:hover {
            background: var(--accent);
            color: white;
        }

        .collection-content {
            flex: 1;
            padding: 24px;
            padding-bottom: calc(24px + var(--safe-bottom));
        }

        .collection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
        }

        .collection-item {
            background: var(--card);
            border-radius: 12px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            position: relative;
        }

        .collection-item:hover {
            background: var(--card-hover);
            transform: translateY(-4px);
            border-color: var(--glass-border);
        }

        .collection-item-cover {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 12px;
            object-fit: cover;
            background: #222;
            margin-bottom: 8px;
        }

        .collection-item-title {
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }

        .collection-item-artist {
            font-size: 11px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .collection-item-time {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .collection-item-remove {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(255, 107, 107, 0.9);
            color: white;
            border: none;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .collection-item:hover .collection-item-remove {
            opacity: 1;
        }

        /* ÂìçÂ∫îÂºè */
        @media (max-width: 767px) {
            .grid {
                /* ‰ΩøÁî® minmax(0, 1fr) Âº∫Âà∂‰∏§ÂàóÂπ≥ÂàÜÔºåÈò≤Ê≠¢Ë¢´ÂÜÖÂÆπÊíëÂ§ß */
                grid-template-columns: repeat(2, minmax(0, 1fr));
                gap: 10px;
            }

            .song-card {
                padding: 6px;
                /* Á°Æ‰øùÂç°Áâá‰∏ç‰ºöË∂ÖÂá∫ÁΩëÊ†ºÂçïÂÖÉ */
                width: 100%;
                min-width: 0;
            }
            
            /* Á°Æ‰øùÂÜÖÂÆπÂå∫Â∑¶Âè≥ËæπË∑ùÈÄÇ‰∏≠ */
            .content {
                padding-left: 12px;
                padding-right: 12px;
            }
        }

        @media (min-width: 768px) {
            .grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }

            .player-card {
                max-width: 600px;
                margin: 0 auto;
            }
        }
    </style>
</head>
<body>
    <!-- ËÉåÊôØ -->
    <div class="bg-gradient"></div>
    <div class="bg-album" id="bg-album"></div>

    <!-- È°∂ÈÉ®ÊêúÁ¥¢ -->
    <header class="header">
        <div class="search-box">
            <div class="search-input-container">
                <input type="text" class="search-input" id="search-input" placeholder="Ê≠åÊâã/Ê≠åÊõ≤...">
                <button class="search-clear-btn" id="search-clear-btn" title="Ê∏ÖÁ©∫ÊêúÁ¥¢" style="display: none;">‚úï</button>
            </div>
            <button class="btn btn-icon" onclick="searchMusic()" title="ÊêúÁ¥¢">üîç</button>
            <button class="btn btn-icon" onclick="randomSearch()" title="ÈöèÊú∫Êé¢Á¥¢">üé≤</button>
            <button class="btn btn-icon" onclick="searchByWeather()" title="ÁúãÂ§©Âê¨Ê≠å">üå§Ô∏è</button>
            <button class="btn btn-icon" onclick="openHistory()" title="Êí≠ÊîæÂéÜÂè≤">üìñ</button>
            <button class="btn btn-icon" onclick="openFavorites()" title="ÊàëÁöÑÊî∂Ëóè">‚ù§Ô∏è</button>
        </div>
    </header>

    <!-- ÂÜÖÂÆπÂå∫ -->
    <main class="content">
        <div class="grid" id="results">
            <div class="empty-state" style="grid-column: 1/-1;">
                <div class="empty-icon">üéß</div>
                <div class="empty-title">ÂèëÁé∞Èü≥‰πê</div>
                <div class="empty-desc">ÁÇπÂáª üé≤ ÈöèÊú∫Êé¢Á¥¢ÔºåÊàñÊêúÁ¥¢‰Ω†ÂñúÊ¨¢ÁöÑÊ≠åÊõ≤</div>
            </div>
        </div>
    </main>

    <!-- ÂºπÂπï -->
    <div class="danmaku" id="danmaku"></div>

    <!-- Â∫ïÈÉ®Êí≠ÊîæÂô® -->
    <div class="player">
        <div class="player-card">
            <!-- È°∂ÈÉ®Ê≠åÊõ≤‰ø°ÊÅØÊ†è -->
            <div class="player-info-bar">
                <span class="player-label">Ê≠£Âú®Êí≠ÊîæÔºö</span>
                <div class="player-text-wrapper title-wrapper">
                    <span class="player-title-text" id="player-title-text">ÂπøÂ±±Èü≥‰πê</span>
                </div>
                <span class="player-separator">-</span>
                <div class="player-text-wrapper artist-wrapper">
                    <span class="player-artist-text" id="player-artist-text">Á≠âÂæÖÊí≠Êîæ</span>
                </div>
                <button class="player-wiki-btn" id="player-wiki-btn" title="Êü•ÁúãËâ∫ÊúØÂÆ∂Áª¥Âü∫ÁôæÁßë" style="display: none;">üìñ</button>
            </div>
            
            <!-- ‰∏ªÊéßÂà∂Âå∫ -->
            <div class="player-main">
                <img class="player-cover" id="player-cover" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%23222' width='100' height='100'/%3E%3Ccircle cx='50' cy='50' r='30' fill='none' stroke='%23333' stroke-width='2'/%3E%3Ccircle cx='50' cy='50' r='10' fill='%23333'/%3E%3C/svg%3E" alt="Cover">
                <button class="ctrl-btn favorite-btn" id="favorite-btn" onclick="toggleFavorite()" title="Êî∂Ëóè">ü§ç</button>
                <div class="player-controls">
                    <button class="ctrl-btn" id="mode-btn" onclick="togglePlayMode()" title="ÂàóË°®Âæ™ÁéØ">üîÅ</button>
                    <button class="ctrl-btn" onclick="playPrevious()">‚èÆ</button>
                    <button class="ctrl-btn play" id="play-btn" onclick="togglePlay()">‚ñ∂</button>
                    <button class="ctrl-btn" onclick="playNext()">‚è≠</button>
                </div>
            </div>
            
            <!-- ËøõÂ∫¶Êù° -->
            <div class="progress-container">
                <span class="time" id="current-time">0:00</span>
                <div class="progress-bar" id="progress-bar" onclick="seek(event)">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <span class="time" id="total-time">0:30</span>
            </div>
        </div>
    </div>

    <!-- Ê≠åËØçËØ¶ÊÉÖ -->
    <div class="lyrics-modal" id="lyrics-modal">
        <div class="lyrics-header">
            <button class="lyrics-close" onclick="closeLyrics()">‚úï</button>
        </div>
        <img class="lyrics-cover" id="lyrics-cover" src="" alt="">
        <h2 class="lyrics-title" id="lyrics-title"></h2>
        <div class="lyrics-artist-container">
            <p class="lyrics-artist clickable" id="lyrics-artist" style="cursor: pointer; text-decoration: underline;" title="ÁÇπÂáªËÆøÈóÆÁª¥Âü∫ÁôæÁßë"></p>
        </div>
        <div class="lyrics-wiki" id="lyrics-wiki">
            <div class="lyrics-wiki-title" id="wiki-title"></div>
            <div class="lyrics-wiki-text" id="wiki-text"></div>
        </div>
        <div class="lyrics-text" id="lyrics-text">Âä†ËΩΩ‰∏≠...</div>
    </div>

    <!-- ÂéÜÂè≤ËÆ∞ÂΩïÂºπÁ™ó -->
    <div class="collection-modal" id="history-modal">
        <div class="collection-header">
            <h2 class="collection-title">üìñ Êí≠ÊîæÂéÜÂè≤</h2>
            <div class="collection-actions">
                <button class="btn-action" onclick="exportHistory()" title="ÂØºÂá∫ÂéÜÂè≤">üì§</button>
                <button class="btn-action" onclick="importHistory()" title="ÂØºÂÖ•ÂéÜÂè≤">üì•</button>
                <button class="btn-action" onclick="clearHistory()" title="Ê∏ÖÁ©∫ÂéÜÂè≤">üóëÔ∏è</button>
                <button class="collection-close" onclick="closeHistory()">‚úï</button>
            </div>
        </div>
        <div class="collection-content" id="history-content">
            <div class="empty-state">
                <div class="empty-icon">üìñ</div>
                <div class="empty-title">ÊöÇÊó†Êí≠ÊîæÂéÜÂè≤</div>
                <div class="empty-desc">ÂºÄÂßãÊí≠ÊîæÈü≥‰πêÂêé‰ºöËá™Âä®ËÆ∞ÂΩï</div>
            </div>
        </div>
    </div>

    <!-- Êî∂ËóèÂàóË°®ÂºπÁ™ó -->
    <div class="collection-modal" id="favorites-modal">
        <div class="collection-header">
            <h2 class="collection-title">‚ù§Ô∏è ÊàëÁöÑÊî∂Ëóè</h2>
            <div class="collection-actions">
                <button class="btn-action" onclick="exportFavorites()" title="ÂØºÂá∫Êî∂Ëóè">üì§</button>
                <button class="btn-action" onclick="importFavorites()" title="ÂØºÂÖ•Êî∂Ëóè">üì•</button>
                <button class="btn-action" onclick="clearFavorites()" title="Ê∏ÖÁ©∫Êî∂Ëóè">üóëÔ∏è</button>
                <button class="collection-close" onclick="closeFavorites()">‚úï</button>
            </div>
        </div>
        <div class="collection-content" id="favorites-content">
            <div class="empty-state">
                <div class="empty-icon">‚ù§Ô∏è</div>
                <div class="empty-title">ÊöÇÊó†Êî∂Ëóè</div>
                <div class="empty-desc">ÁÇπÂáªÊí≠ÊîæÂô®‰∏≠ÁöÑÁà±ÂøÉÊåâÈíÆÊî∂ËóèÊ≠åÊõ≤</div>
            </div>
        </div>
    </div>

    <!-- ÈöêËóèÁöÑÊñá‰ª∂ËæìÂÖ•Ê°Ü -->
    <input type="file" id="import-file-input" accept=".json" style="display: none;">

    <audio id="audio" crossorigin="anonymous"></audio>

    <script>
        // Áä∂ÊÄÅÁÆ°ÁêÜ
        const state = {
            currentTrack: null,
            playlist: [],
            currentIndex: -1,
            isPlaying: false,
            playMode: 'sequence', // sequence, random, single
            danmakuInterval: null,
            danmakuCache: [],
            tracks: [false, false, false, false, false]
        };

        // ÁºìÂ≠òÁ≥ªÁªü
        const CacheManager = {
            // Ëé∑ÂèñÁºìÂ≠òÁöÑÊï∞ÊçÆ
            get: (key) => {
                try {
                    const cached = localStorage.getItem(key);
                    if (!cached) return null;

                    const parsed = JSON.parse(cached);
                    const now = Date.now();

                    // Ê£ÄÊü•ÊòØÂê¶ËøáÊúü
                    if (parsed.expiry && now > parsed.expiry) {
                        localStorage.removeItem(key);
                        return null;
                    }

                    return parsed.data;
                } catch (e) {
                    console.warn('Cache get error:', e);
                    return null;
                }
            },

            // ËÆæÁΩÆÁºìÂ≠òÊï∞ÊçÆ
            set: (key, data, expiryHours = 24) => {
                try {
                    const expiry = Date.now() + (expiryHours * 60 * 60 * 1000);
                    const cacheObj = {
                        data: data,
                        expiry: expiry
                    };
                    localStorage.setItem(key, JSON.stringify(cacheObj));
                } catch (e) {
                    console.warn('Cache set error:', e);
                }
            },

            // Âà†Èô§ÁºìÂ≠òÊï∞ÊçÆ
            remove: (key) => {
                try {
                    localStorage.removeItem(key);
                } catch (e) {
                    console.warn('Cache remove error:', e);
                }
            }
        };

        // Êî∂ËóèÁÆ°ÁêÜÂô®
        const FavoritesManager = {
            STORAGE_KEY: 'music_favorites',
            
            // Ëé∑ÂèñÊâÄÊúâÊî∂Ëóè
            getAll: () => {
                try {
                    const data = localStorage.getItem(FavoritesManager.STORAGE_KEY);
                    return data ? JSON.parse(data) : [];
                } catch (e) {
                    console.error('Failed to get favorites:', e);
                    return [];
                }
            },
            
            // ‰øùÂ≠òÊî∂Ëóè
            save: (favorites) => {
                try {
                    localStorage.setItem(FavoritesManager.STORAGE_KEY, JSON.stringify(favorites));
                } catch (e) {
                    console.error('Failed to save favorites:', e);
                }
            },
            
            // Ê∑ªÂä†Êî∂Ëóè
            add: (song) => {
                const favorites = FavoritesManager.getAll();
                const exists = favorites.some(f => f.trackId === song.trackId);
                if (!exists) {
                    favorites.unshift({
                        ...song,
                        favoritedAt: Date.now()
                    });
                    FavoritesManager.save(favorites);
                    return true;
                }
                return false;
            },
            
            // ÁßªÈô§Êî∂Ëóè
            remove: (trackId) => {
                const favorites = FavoritesManager.getAll();
                const filtered = favorites.filter(f => f.trackId !== trackId);
                FavoritesManager.save(filtered);
            },
            
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤Êî∂Ëóè
            isFavorited: (trackId) => {
                const favorites = FavoritesManager.getAll();
                return favorites.some(f => f.trackId === trackId);
            },
            
            // Ê∏ÖÁ©∫Êî∂Ëóè
            clear: () => {
                FavoritesManager.save([]);
            },
            
            // ÂØºÂá∫Êî∂Ëóè
            export: () => {
                const favorites = FavoritesManager.getAll();
                const dataStr = JSON.stringify(favorites, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `music-favorites-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            },
            
            // ÂØºÂÖ•Êî∂Ëóè
            import: (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (Array.isArray(data)) {
                                FavoritesManager.save(data);
                                resolve(data.length);
                            } else {
                                reject(new Error('Invalid format'));
                            }
                        } catch (err) {
                            reject(err);
                        }
                    };
                    reader.onerror = reject;
                    reader.readAsText(file);
                });
            }
        };

        // ÂéÜÂè≤ËÆ∞ÂΩïÁÆ°ÁêÜÂô®
        const HistoryManager = {
            STORAGE_KEY: 'music_history',
            MAX_ITEMS: 100,
            
            // Ëé∑ÂèñÊâÄÊúâÂéÜÂè≤
            getAll: () => {
                try {
                    const data = localStorage.getItem(HistoryManager.STORAGE_KEY);
                    return data ? JSON.parse(data) : [];
                } catch (e) {
                    console.error('Failed to get history:', e);
                    return [];
                }
            },
            
            // ‰øùÂ≠òÂéÜÂè≤
            save: (history) => {
                try {
                    localStorage.setItem(HistoryManager.STORAGE_KEY, JSON.stringify(history));
                } catch (e) {
                    console.error('Failed to save history:', e);
                }
            },
            
            // Ê∑ªÂä†ÂéÜÂè≤ËÆ∞ÂΩï
            add: (song) => {
                let history = HistoryManager.getAll();
                // ÁßªÈô§ÈáçÂ§çÈ°π
                history = history.filter(h => h.trackId !== song.trackId);
                // Ê∑ªÂä†Âà∞ÂºÄÂ§¥
                history.unshift({
                    ...song,
                    playedAt: Date.now()
                });
                // ÈôêÂà∂Êï∞Èáè
                if (history.length > HistoryManager.MAX_ITEMS) {
                    history = history.slice(0, HistoryManager.MAX_ITEMS);
                }
                HistoryManager.save(history);
            },
            
            // ÁßªÈô§ÂéÜÂè≤ËÆ∞ÂΩï
            remove: (trackId) => {
                const history = HistoryManager.getAll();
                const filtered = history.filter(h => h.trackId !== trackId);
                HistoryManager.save(filtered);
            },
            
            // Ê∏ÖÁ©∫ÂéÜÂè≤
            clear: () => {
                HistoryManager.save([]);
            },
            
            // ÂØºÂá∫ÂéÜÂè≤
            export: () => {
                const history = HistoryManager.getAll();
                const dataStr = JSON.stringify(history, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `music-history-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            },
            
            // ÂØºÂÖ•ÂéÜÂè≤
            import: (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (Array.isArray(data)) {
                                HistoryManager.save(data);
                                resolve(data.length);
                            } else {
                                reject(new Error('Invalid format'));
                            }
                        } catch (err) {
                            reject(err);
                        }
                    };
                    reader.onerror = reject;
                    reader.readAsText(file);
                });
            }
        };

        // ÁîüÊàêÁºìÂ≠òÈîÆ
        const generateCacheKey = (artist, title) => {
            return `song_${encodeURIComponent(artist)}_${encodeURIComponent(title)}`;
        };

        // DOM ÂÖÉÁ¥†
        const $ = id => document.getElementById(id);
        const audio = $('audio');

        // ÂÖ≥ÈîÆËØçÂ∫ì (500+ ËØçÊ±áÊâ©ÂÖÖÁâà)
const keywords = [
    // --- ÂéüÂßãÊ†∏ÂøÉËØç ---
    "Love", "Dream", "Night", "Summer", "Rain", "Happy", "Sad", "Dance", "Party", "Heart", "Soul", "Fire", "Stars", "Blue", "Gold", "Wild", "Sweet", "Crazy", "Beautiful", "Forever", "Kiss", "Miss", "Baby", "Believe", "Free", "Smile", "Hope", "Joy", "Tears", "Faith", "Paradise", "Heaven", "Promise", "Secret", "Lost", "Alone", "Together", "Brave", "Angel", "Devil", "Hero", "Legend", "Magic", "Power", "Glory", "King", "Queen", "Life", "Time",

    // --- ÊÉÖÁª™‰∏éÊ∞õÂõ¥ (Vibes & Moods) ---
    "Chill", "Relax", "Cozy", "Mellow", "Groovy", "Funky", "Energetic", "Upbeat", "Melancholy", "Nostalgia", "Sentimental", "Romantic", "Sexy", "Dark", "Gloomy", "Mystery", "Euphoria", "Hypnotic", "Psychedelic", "Peaceful", "Calm", "Serene", "Focus", "Intense", "Dramatic", "Epic", "Cinematic", "Ethereal", "Dreamy", "Floating", "Heavy", "Soft", "Warm", "Cold", "Spooky", "Creepy", "Funny", "Weird", "Cool", "Fresh", "Vintage", "Retro", "Classic", "Modern", "Futuristic", "Urban", "Rural", "Pastel", "Neon", "Cyberpunk", "Aesthetic",

    // --- Âú∫ÊôØ‰∏éÊ¥ªÂä® (Scenarios) ---
    "Workout", "Gym", "Running", "Jogging", "Driving", "Road Trip", "Car Music", "Study", "Coding", "Reading", "Focus", "Sleep", "Meditation", "Yoga", "Spa", "Gaming", "Background", "Coffee Shop", "Cafe", "Dinner", "Cooking", "Cleaning", "Shower", "Bath", "Morning", "Wake Up", "Late Night", "Midnight", "Sunset", "Sunrise", "Weekend", "Friday", "Sunday", "Holiday", "Vacation", "Beach", "Pool", "Camping", "Festival", "Club", "Bar", "Lounge", "Wedding", "Birthday", "Christmas", "Halloween", "New Year", "Valentine",

    // --- Èü≥‰πêÊµÅÊ¥æ (Genres) ---
    "Pop", "Rock", "Jazz", "Blues", "Soul", "R&B", "Hip Hop", "Rap", "Trap", "Country", "Folk", "Indie", "Alternative", "Metal", "Heavy Metal", "Punk", "Grunge", "Emo", "Ska", "Reggae", "Dancehall", "Latin", "Salsa", "Bachata", "Reggaeton", "K-Pop", "J-Pop", "C-Pop", "Mandopop", "Cantopop", "EDM", "House", "Deep House", "Techno", "Trance", "Dubstep", "Drum and Bass", "Garage", "Disco", "Funk", "Motown", "Gospel", "Christian", "Classical", "Opera", "Symphony", "Orchestra", "Piano", "Violin", "Cello", "Acoustic", "Instrumental", "Acapella", "Lo-Fi", "Lofi Hip Hop", "Synthwave", "Vaporwave", "Retrowave", "Ambient", "New Age", "Experimental", "Soundtrack", "OST", "Anime", "Disney", "Musical", "Broadway",

    // --- ËëóÂêçËâ∫‰∫∫‰∏é‰πêÈòü (Artists - Modern & Legends) ---
    // Pop/Mainstream
    "Taylor Swift", "Ed Sheeran", "Ariana Grande", "Justin Bieber", "The Weeknd", "Dua Lipa", "Billie Eilish", "Harry Styles", "Bruno Mars", "Adele", "Rihanna", "Beyonce", "Lady Gaga", "Katy Perry", "Miley Cyrus", "Shawn Mendes", "Camila Cabello", "Selena Gomez", "Post Malone", "Maroon 5", "Imagine Dragons", "OneRepublic", "Coldplay", "Sia", "Sam Smith", "Charlie Puth",
    // Hip-Hop/Rap/R&B
    "Drake", "Kendrick Lamar", "Kanye West", "Eminem", "Jay-Z", "Travis Scott", "J. Cole", "Nicki Minaj", "Cardi B", "Doja Cat", "SZA", "Frank Ocean", "Chris Brown", "Usher", "Alicia Keys", "John Legend", "Pharrell Williams", "Snoop Dogg", "Dr. Dre", "2Pac", "Notorious BIG", "Wu-Tang Clan",
    // Rock/Indie/Alternative
    "Beatles", "Queen", "Rolling Stones", "Pink Floyd", "Led Zeppelin", "AC/DC", "Nirvana", "Guns N Roses", "Metallica", "Red Hot Chili Peppers", "Linkin Park", "Green Day", "Blink-182", "Radiohead", "Arctic Monkeys", "The Strokes", "Tame Impala", "The Killers", "Oasis", "Blur", "U2", "Bon Jovi", "Aerosmith", "Eagles", "Fleetwood Mac", "David Bowie", "Prince", "Elton John", "Bob Dylan",
    // Electronic/Dance
    "Daft Punk", "Calvin Harris", "Avicii", "David Guetta", "Tiesto", "Martin Garrix", "Marshmello", "The Chainsmokers", "Zedd", "Skrillex", "Diplo", "Kygo", "Alan Walker", "Disclosure", "Kraftwerk",
    // K-Pop/Asian
    "BTS", "Blackpink", "Twice", "EXO", "Big Bang", "NewJeans", "Stray Kids", "Seventeen", "IU", "Jay Chou", "JJ Lin", "Eason Chan",

    // --- Âú∞ÁÇπ‰∏éËá™ÁÑ∂ (Places & Nature) ---
    "California", "New York", "London", "Paris", "Tokyo", "Seoul", "Hong Kong", "Shanghai", "Miami", "Ibiza", "Hawaii", "Space", "Galaxy", "Universe", "Moon", "Sun", "Sky", "Ocean", "Sea", "River", "Forest", "Jungle", "Mountain", "Desert", "City", "Street", "Highway", "Rain", "Storm", "Thunder", "Snow", "Wind", "Fire", "Water", "Earth", "Air", "Flower", "Rose", "Cherry Blossom",

    // --- ÂΩ±ËßÜ‰∏éÊñáÂåñ (Culture) ---
    "Marvel", "DC", "Star Wars", "Harry Potter", "Lord of the Rings", "Game of Thrones", "Stranger Things", "Cyberpunk 2077", "GTA", "FIFA", "Nintendo", "Mario", "Zelda", "Pokemon", "Ghibli", "Hans Zimmer", "John Williams", "Joe Hisaishi", "Ennio Morricone", "80s Hits", "90s Hits", "00s Hits", "Top 100", "Viral", "TikTok Songs",
    // --- Ê†∏ÂøÉÊµÅÊ¥æ‰∏éÈ£éÊ†º (Chinese Genres) ---
    "ÂçéËØ≠ÊµÅË°å (Mandopop)", "Á≤§ËØ≠ÊµÅË°å (Cantopop)", "Âè∞ËØ≠/ÈóΩÂçóËØ≠ (Hokkien Pop)", 
    "Âè§È£é (Ancient Style/Gufeng)", "‰∏≠ÂõΩÈ£é (China Wave)", "ÊàèËÖî (Opera Vocals)", 
    "ÂõΩÊΩÆ (China Chic)", "‰ªô‰æ† (Xianxia)", "Ê≠¶‰æ† (Wuxia)", "Ê±üÊπñ (Jianghu)",
    "Ê∞ëË∞£ (Folk)", "Ê†°Âõ≠Ê∞ëË∞£ (Campus Folk)", "ÂüéÂ∏ÇÊ∞ëË∞£ (Urban Folk)", 
    "ÂçéËØ≠ÊëáÊªö (Chinese Rock)", "ÂçéËØ≠ËØ¥Âî± (Chinese Hip-Hop)", "‰∏≠ÂõΩÊúâÂòªÂìà (Rap of China)",
    "ÊäíÊÉÖÊ≠å (Ballad)", "Ëã¶ÊÉÖÊ≠å (Sad Love Song)", "ÁîúÊ≠å (Sweet Song)", "Âè£Ê∞¥Ê≠å (Bubblegum Pop)",
    "ÁΩëÁªúÊ≠åÊõ≤ (Internet Songs)", "ÊäñÈü≥Á•ûÊõ≤ (Douyin/TikTok Hits)", "Ê¥óËÑëÁ•ûÊõ≤ (Earworms)",
    "ÁªèÂÖ∏ËÄÅÊ≠å (Oldies)", "ÊÄÄÊóßÈáëÊõ≤ (Nostalgic Hits)", "KTVÂøÖÁÇπ (KTV Classics)",
    "ÂΩ±ËßÜÂéüÂ£∞ (OST)", "ÁîµËßÜÂâßÊèíÊõ≤ (Drama OST)", "Âä®Êº´‰∏ªÈ¢òÊõ≤ (Anime OP/ED)",

    // --- ÊÉÖÊÑü‰∏é‰∏ªÈ¢ò (Themes & Vibes) ---
    "ÂàùÊÅã (First Love)", "ÊöóÊÅã (Crush)", "Â§±ÊÅã (Heartbreak)", "ÂàÜÊâã (Breakup)", 
    "Â§áËÉé (Second Choice)", "ÈÅóÊÜæ (Regret)", "ÊàêÂÖ® (Sacrifice)", "ÊößÊòß (Situationship)",
    "ÈùíÊò• (Youth)", "ÊØï‰∏ö (Graduation)", "ÂõûÂøÜ (Memories)", "ÊàêÈïø (Growing Up)",
    "ÊÄù‰π° (Homesickness)", "ÊºÇÊ≥ä (Drifting)", "ÂåóÊºÇ/Ê≤™ÊºÇ (City Struggle)", "Â•ãÊñó (Struggle)",
    "Ê≤ªÊÑà (Healing)", "Ê∏©Êöñ (Warmth)", "Âä±Âøó (Inspirational)", "Ê≠£ËÉΩÈáè (Positive Energy)",
    "Â≠§Áã¨ (Loneliness)", "Ê∑±Â§úÁΩëÊäë‰∫ë (Late Night Depression)", "emoÊó∂Âàª",
    "ÁîúËúú (Sweet)", "ÊííÁ≥ñ (Lovey-dovey)", "ÂëäÁôΩ (Confession)", "Â©öÁ§º (Wedding)",

    // --- ‰πêÂô®‰∏éÂÖÉÁ¥† (Instruments & Elements) ---
    "Âè§Á≠ù (Guzheng)", "ÁêµÁê∂ (Pipa)", "‰∫åËÉ° (Erhu)", "Á¨õÂ≠ê (Flute)", "Ëêß (Xiao)", "Âî¢Âëê (Suona)",
    "Èí¢Áê¥ (Piano)", "Âêâ‰ªñ (Guitar)", "Â∞§ÂÖãÈáåÈáå (Ukulele)", 
    "ÁÉüÂóì (Husky Voice)", "È´òÈü≥ (High Note)", "Êµ∑Ë±öÈü≥ (Whistle Register)", "‰ΩéÈü≥ (Bass)",
    "‰∫∫Â£∞ (Vocal)", "Ê∏ÖÂî± (Acapella)", "Áé∞Âú∫Áâà (Live)", "ÁøªÂî± (Cover)",

    // --- ÂçéËØ≠‰πêÂùõ‰ª£Ë°®‰∫∫Áâ© (Iconic Artists Expansion) ---
    // ‰º†Â•á/Â§©ÁéãÂ§©Âêé (Legends)
    "ÈÇì‰∏ΩÂêõ (Teresa Teng)", "Âº†ÂõΩËç£ (Leslie Cheung)", "ÁéãËè≤ (Faye Wong)", "Ê¢ÖËâ≥Ëä≥ (Anita Mui)",
    "Âº†Â≠¶Âèã (Jacky Cheung)", "ÂàòÂæ∑Âçé (Andy Lau)", "ÈªéÊòé (Leon Lai)", "ÈÉ≠ÂØåÂüé (Aaron Kwok)",
    "ÁΩóÂ§ß‰Ωë (Lo Ta-yu)", "ÊùéÂÆóÁõõ (Jonathan Lee)", "Â¥îÂÅ• (Cui Jian)", "Á™¶ÂîØ (Dou Wei)",
    "‰ºç‰Ω∞ (Wu Bai)", "Beyond", "ËçâËú¢ (Grasshopper)", "Âº†Èõ®Áîü (Tom Chang)",

    // ÂçÉÁ¶ß‰∏Ä‰ª£/ÈªÑÈáëÊó∂‰ª£ (2000s Icons)
    "Âë®Êù∞‰º¶ (Jay Chou)", "Êûó‰øäÊù∞ (JJ Lin)", "ÈôàÂ•ïËøÖ (Eason Chan)", "ÁéãÂäõÂÆè (Leehom Wang)", "Èô∂ÂñÜ (David Tao)",
    "Ëî°‰æùÊûó (Jolin Tsai)", "Â≠ôÁáïÂßø (Stefanie Sun)", "Ê¢ÅÈùôËåπ (Fish Leong)", "Ëêß‰∫öËΩ© (Elva Hsiao)", "Âº†ÊÉ†Â¶π (A-Mei)",
    "‰∫îÊúàÂ§© (Mayday)", "ËãèÊâìÁªø (Sodagreen)", "S.H.E", "Twins", "È£ûÂÑø‰πêÂõ¢ (F.I.R)",
    "ÊΩòÁéÆÊüè (Willber Pan)", "ÁΩóÂøóÁ•• (Show Lo)", "Êù®‰∏ûÁê≥ (Rainie Yang)", "ÁéãÂøÉÂáå (Cyndi Wang)", "Âº†Èü∂Ê∂µ (Angela Chang)",

    // Áé∞‰ª£ÊµÅË°å/Êñ∞Áîü‰ª£ (Modern/Trending)
    "ÈÇìÁ¥´Ê£ã (G.E.M.)", "ÊùéËç£Êµ© (Li Ronghao)", "Ëñõ‰πãË∞¶ (Joker Xue)", "Âë®Ê∑± (Zhou Shen)", "ÊØõ‰∏çÊòì (Mao Buyi)",
    "ÂçéÊô®ÂÆá (Hua Chenyu)", "Âº†Êù∞ (Jason Zhang)", "Ê±™ËãèÊ≥∑ (Silence Wang)", "ËÆ∏Âµ© (Vae)",
    "Âëä‰∫î‰∫∫ (Accusefive)", "Ëçâ‰∏úÊ≤°ÊúâÊ¥æÂØπ (No Party For Cao Dong)", "Êñ∞Ë£§Â≠ê (New Pants)", "Áóõ‰ª∞ (Miserable Faith)",
    "ÈôàÁ≤í (Chen Li)", "ËµµÈõ∑ (Zhao Lei)", "ÂÆãÂÜ¨Èáé", "Êàø‰∏úÁöÑÁå´",

    // ËØ¥Âî±/ÂòªÂìà (Rap/Hip-Hop)
    "Gai (Âë®Âª∂)", "È©¨ÊÄùÂîØ (MaSiWei)", "Higher Brothers", "ÁÉ≠Áãó (MC HotDog)", 
    "È°ΩÁ´•MJ116", "ËõãÂ†° (Soft Lipa)", "‰∏áÂ¶ÆËææ (Vinida)", "ËâæÁÉ≠ (Air)",

    // --- Âú∫ÊôØ‰∏éÁâπÂÆöÂêçËØç (Scenarios & Terms) ---
    "Êò•Êôö (Spring Festival Gala)", "ÂπøÂú∫Ëàû (Square Dance)", "Â§úÂ∫ó (Clubbing)", 
    "ÂíñÂï°È¶Ü (Cafe)", "‰π¶Â∫ó (Bookstore)", "ÊóÖË°å (Travel)", "Ëá™È©æ (Road Trip)",
    "‰∏ãÈõ®Â§© (Rainy Day)", "ÊôöÂÆâ (Good Night)", "Êó©ÂÆâ (Good Morning)",
    "ÁªºËâ∫ (Variety Show)", "ÊàëÊòØÊ≠åÊâã (I Am A Singer)", "‰πêÈòüÁöÑÂ§èÂ§© (The Big Band)",
    "ÈÄâÁßÄ (Talent Show)", "Â•≥Âõ¢ (Girl Group)", "Áî∑Âõ¢ (Boy Group)"
];
        // ÂàùÂßãÂåñ
        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            randomSearch();
            const searchInput = $('search-input');
            const searchClearBtn = $('search-clear-btn');
            let searchTimeout;

            searchInput.addEventListener('keypress', e => {
                if (e.key === 'Enter') {
                    clearTimeout(searchTimeout);
                    searchMusic();
                }
            });

            // Show/hide clear button based on input value and debounce search
            searchInput.addEventListener('input', () => {
                searchClearBtn.style.display = searchInput.value ? 'flex' : 'none';
                
                // Èò≤ÊäñÊêúÁ¥¢
                clearTimeout(searchTimeout);
                if (searchInput.value.trim()) {
                    searchTimeout = setTimeout(() => {
                        searchMusic();
                    }, 800);
                }
            });

            // Show clear button if search input already has value on load
            searchClearBtn.style.display = searchInput.value ? 'flex' : 'none';

            // Clear search input when clear button is clicked
            searchClearBtn.addEventListener('click', () => {
                clearTimeout(searchTimeout);
                searchInput.value = '';
                searchClearBtn.style.display = 'none';
                searchInput.focus();
            });

            // ÂèåÂáªÂ∞ÅÈù¢ÊâìÂºÄÊ≠åËØç
            $('player-cover').addEventListener('dblclick', openLyrics);
        });

        // ÊêúÁ¥¢Ëâ∫ÊúØÂÆ∂
        function searchByArtist(artistName) {
            const cleanArtist = artistName.split(/&|,|feat\.|ft\./i)[0].trim();
            $('search-input').value = cleanArtist;
            searchMusic();
        }

        // ÊêúÁ¥¢Ê≠åÊõ≤
        function searchBySong(songName) {
            // Remove parentheses and brackets with their contents from song name
            let cleanSongName = songName.replace(/\([^)]*\)|\[[^\]]*\]/g, '').trim();
            $('search-input').value = cleanSongName;
            searchMusic();
        }

        // ÈöèÊú∫ÊêúÁ¥¢
        function randomSearch() {
            $('search-input').value = keywords[Math.floor(Math.random() * keywords.length)];
            searchMusic();
        }

        // ÊêúÁ¥¢Èü≥‰πê
        async function searchMusic() {
            const query = $('search-input').value.trim();
            if (!query) return;

            // Â∞ùËØï‰ªéÁºìÂ≠òËé∑ÂèñÊêúÁ¥¢ÁªìÊûú
            const cacheKey = `search_${query}`;
            let cachedResults = CacheManager.get(cacheKey);

            if (cachedResults) {
                console.log('Using cached search results for:', query);
                state.playlist = cachedResults;
                renderResults(cachedResults);
                return;
            }

            $('results').innerHTML = `
                <div class="loading" style="grid-column: 1/-1;">
                    <div class="loading-spinner"></div>
                    <div>Ê≠£Âú®ÊêúÁ¥¢...</div>
                </div>
            `;

            try {
                const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(query)}&entity=song&limit=48&country=cn`);
                const data = await res.json();

                // ÁºìÂ≠òÊêúÁ¥¢ÁªìÊûúÔºàÊúâÊïàÊúü1Â∞èÊó∂Ôºâ
                CacheManager.set(cacheKey, data.results, 1);

                state.playlist = data.results;
                renderResults(data.results);

                // ÂêåÊó∂ÁºìÂ≠òÊØè‰∏™Ê≠åÊõ≤ÁöÑÂÖÉÊï∞ÊçÆ
                data.results.forEach(song => {
                    const songCacheKey = generateCacheKey(song.artistName, song.trackName);
                    CacheManager.set(songCacheKey, {
                        trackName: song.trackName,
                        artistName: song.artistName,
                        artworkUrl: song.artworkUrl100,
                        previewUrl: song.previewUrl,
                        collectionName: song.collectionName
                    }, 24); // 24Â∞èÊó∂ÊúâÊïàÊúü
                });
            } catch (e) {
                $('results').innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="empty-icon">üòµ</div>
                        <div class="empty-title">ÁΩëÁªúÈîôËØØ</div>
                        <div class="empty-desc">ËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÂêéÈáçËØï</div>
                    </div>
                `;
            }
        }

        // Ê∏≤ÊüìÁªìÊûú
        function renderResults(songs) {
            if (songs.length === 0) {
                $('results').innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="empty-icon">üîç</div>
                        <div class="empty-title">Êú™ÊâæÂà∞ÁªìÊûú</div>
                        <div class="empty-desc">Êç¢‰∏™ÂÖ≥ÈîÆËØçËØïËØï</div>
                    </div>
                `;
                return;
            }

            $('results').innerHTML = songs.map((song, index) => {
                // Ê£ÄÊü•ÊòØÂê¶ÊúâÁºìÂ≠òÁöÑÂÖÉÊï∞ÊçÆ
                const songCacheKey = generateCacheKey(song.artistName, song.trackName);
                const cachedSong = CacheManager.get(songCacheKey);

                // ‰ΩøÁî®ÁºìÂ≠òÁöÑÊàñÂéüÂßãÁöÑÂ∞ÅÈù¢URL
                const coverUrl = (cachedSong?.artworkUrl || song.artworkUrl100).replace('100x100bb', '300x300bb');

                return `
                    <div class="song-card" data-index="${index}" onclick="playSong(${index})">
                        <div class="song-cover">
                            <img src="${coverUrl}" loading="lazy" alt="">
                            <div class="play-overlay">
                                <div class="play-overlay-btn">‚ñ∂</div>
                            </div>
                            ${song.trackId ? `<div class="song-options" onclick="event.stopPropagation(); playFullSong('${song.trackId}', '${escapeHtml(song.trackName)}', '${escapeHtml(song.artistName)}')">‚ãØ</div>` : ''}
                        </div>
                        <div class="song-title">${escapeHtml(song.trackName)}</div>
                        <div class="song-artist">${escapeHtml(song.artistName)}</div>
                    </div>
                `;
            }).join('');
        }

        // HTML ËΩ¨‰πâ
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Êí≠ÊîæÊ≠åÊõ≤
        function playSong(index) {
            const song = state.playlist[index];
            if (!song) return;

            state.currentTrack = song;
            state.currentIndex = index;

            // ‰ªéÁºìÂ≠òËé∑ÂèñÂÆåÊï¥Êï∞ÊçÆÔºåÂ¶ÇÊûúÊúâÁöÑËØù
            const songCacheKey = generateCacheKey(song.artistName, song.trackName);
            const cachedSong = CacheManager.get(songCacheKey);

            // ‰ΩøÁî®ÁºìÂ≠òÊï∞ÊçÆÊàñÂéüÂßãÊï∞ÊçÆ
            const trackName = cachedSong?.trackName || song.trackName;
            const artistName = cachedSong?.artistName || song.artistName;
            const artworkUrl = cachedSong?.artworkUrl || song.artworkUrl100;
            const previewUrl = cachedSong?.previewUrl || song.previewUrl;
            const collectionName = cachedSong?.collectionName || song.collectionName || song.collectionName;

            const cover = artworkUrl.replace('100x100bb', '600x600bb');

            // Êõ¥Êñ∞È°∂ÈÉ®‰ø°ÊÅØÊ†è
            const titleTextEl = $('player-title-text');
            const artistTextEl = $('player-artist-text');
            const wikiBtn = $('player-wiki-btn');

            titleTextEl.textContent = trackName;
            artistTextEl.textContent = artistName;
            $('player-cover').src = cover;

            // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂Âà∞Ê†áÈ¢òÔºàÊêúÁ¥¢Ê≠åÊõ≤ÂêçÔºâ
            titleTextEl.onclick = () => {
                searchBySong(trackName);
            };
            titleTextEl.title = 'ÁÇπÂáªÊêúÁ¥¢ËØ•Ê≠åÊõ≤';

            // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂Âà∞Ëâ∫ÊúØÂÆ∂ÂêçÁß∞ÔºàÊêúÁ¥¢Ëâ∫ÊúØÂÆ∂Ôºâ
            artistTextEl.onclick = () => {
                searchByArtist(artistName);
            };
            artistTextEl.title = 'ÁÇπÂáªÊêúÁ¥¢ËØ•Ëâ∫ÊúØÂÆ∂ÁöÑÊ≠åÊõ≤';
            
            // ËÆæÁΩÆÁª¥Âü∫ÁôæÁßëÊåâÈíÆ
            const cleanArtistName = artistName.split(/&|,|feat\.|ft\./i)[0].trim();
            wikiBtn.style.display = 'flex';
            wikiBtn.onclick = () => {
                const wikiUrl = `https://zh.wikipedia.org/wiki/${encodeURIComponent(cleanArtistName)}`;
                window.open(wikiUrl, '_blank');
            };
            wikiBtn.title = `Êü•Áúã ${cleanArtistName} ÁöÑÁª¥Âü∫ÁôæÁßë`;
            
            // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊªöÂä®
            const checkScroll = (el) => {
                // ÂÖàÈáçÁΩÆÔºå‰ª•‰æøÂáÜÁ°ÆÊµãÈáè
                el.classList.remove('scroll-text');
                el.style.transform = 'none';
                
                // ÊØîËæÉÂÜÖÈÉ®ÊñáÊú¨ÂÆΩÂ∫¶ÂíåÂ§ñÈÉ®ÂÆπÂô®ÂÆΩÂ∫¶
                const containerWidth = el.parentElement.clientWidth;
                const textWidth = el.scrollWidth;
                
                if (textWidth > containerWidth) {
                    const distance = containerWidth - textWidth; // Ë¥üÂÄºÔºåÂêëÂ∑¶ÁßªÂä®
                    const duration = Math.abs(distance) / 30 + 2; // ÈÄüÂ∫¶ÊéßÂà∂ÔºöÊØèÁßí30pxÔºåÂü∫Á°Ä2s
                    
                    el.style.setProperty('--scroll-distance', `${distance}px`);
                    el.style.setProperty('--duration', `${duration}s`);
                    el.classList.add('scroll-text');
                }
            };
            
            // Á®çÂæÆÂª∂Êó∂‰∏ÄÁÇπÔºåÁ°Æ‰øù DOM Ê∏≤ÊüìÂÆåÊàê
            setTimeout(() => {
                checkScroll(titleTextEl);
                checkScroll(artistTextEl);
            }, 50);

            // ËÉåÊôØ
            $('bg-album').style.backgroundImage = `url(${cover})`;
            $('bg-album').classList.add('active');

            // Ê†áËÆ∞ÂΩìÂâçÊí≠Êîæ
            document.querySelectorAll('.song-card').forEach((card, i) => {
                card.classList.toggle('playing', i === index);
            });

            // Êí≠Êîæ
            audio.src = previewUrl;
            audio.play()
                .then(() => updatePlayState(true))
                .catch(() => updatePlayState(false));

            // ÂºπÂπï
            startDanmaku();

            // È¢ÑÂä†ËΩΩÊ≠åËØç
            $('lyrics-title').textContent = trackName;
            $('lyrics-artist').textContent = artistName;
            // Set up Wikipedia link for artist name
            setupWikipediaLink(artistName);
            $('lyrics-cover').src = cover;
            $('lyrics-text').textContent = 'Âä†ËΩΩ‰∏≠...';
            $('lyrics-wiki').classList.remove('show');

            fetchLyrics(artistName, trackName);
            fetchArtistWiki(artistName);

            // Add click event to artist name to search for artist's songs (left click)
            // and open Wikipedia (Ctrl/Cmd+click)
            $('lyrics-artist').onclick = function(event) {
                if (event.ctrlKey || event.metaKey) {
                    // Ctrl/Cmd + click: open Wikipedia
                    const wikiUrl = $('lyrics-artist').dataset.wikiUrl || `https://zh.wikipedia.org/wiki/${encodeURIComponent(artistName.split(/&|,|feat\.|ft\./i)[0].trim())}`;
                    window.open(wikiUrl, '_blank');
                } else {
                    // Regular click: search for artist's songs
                    searchByArtist(artistName);
                }
            };
            $('lyrics-artist').style.cursor = 'pointer';
            $('lyrics-artist').title = 'ÁÇπÂáªÊêúÁ¥¢ËØ•Ëâ∫ÊúØÂÆ∂ÁöÑÊ≠åÊõ≤ (Ctrl/Cmd+ÁÇπÂáªËÆøÈóÆÁª¥Âü∫ÁôæÁßë)';
            
            // Ê∑ªÂä†Âà∞ÂéÜÂè≤ËÆ∞ÂΩï
            HistoryManager.add(song);
            
            // Êõ¥Êñ∞Á≥ªÁªüÂ™í‰Ωì‰∏≠ÂøÉÊéßÂà∂ (Media Session API)
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: trackName,
                    artist: artistName,
                    album: collectionName || 'ÂπøÂ±±Èü≥‰πê',
                    artwork: [
                        { src: artworkUrl.replace('100x100bb', '96x96bb'), sizes: '96x96', type: 'image/jpeg' },
                        { src: artworkUrl.replace('100x100bb', '128x128bb'), sizes: '128x128', type: 'image/jpeg' },
                        { src: artworkUrl.replace('100x100bb', '192x192bb'), sizes: '192x192', type: 'image/jpeg' },
                        { src: artworkUrl.replace('100x100bb', '256x256bb'), sizes: '256x256', type: 'image/jpeg' },
                        { src: cover, sizes: '512x512', type: 'image/jpeg' }
                    ]
                });

                navigator.mediaSession.setActionHandler('play', togglePlay);
                navigator.mediaSession.setActionHandler('pause', togglePlay);
                navigator.mediaSession.setActionHandler('previoustrack', playPrevious);
                navigator.mediaSession.setActionHandler('nexttrack', () => playNext(false));
            }
            
            // Êõ¥Êñ∞Êî∂ËóèÊåâÈíÆÁä∂ÊÄÅ
            updateFavoriteButton();
        }

        // Êõ¥Êñ∞Êí≠ÊîæÁä∂ÊÄÅ
        function updatePlayState(playing) {
            state.isPlaying = playing;
            const btn = $('play-btn');
            btn.textContent = playing ? '‚è∏' : '‚ñ∂';
            btn.setAttribute('data-playing', playing); // Áî®‰∫é CSS Ê†∑Âºè‰øÆÊ≠£
            $('player-cover').classList.toggle('spinning', playing);
        }

        // Êí≠Êîæ/ÊöÇÂÅú
        function togglePlay() {
            if (!state.currentTrack && state.playlist.length > 0) {
                // Â¶ÇÊûúÊ≤°ÊúâÂΩìÂâçÊí≠ÊîæÁöÑÊ≠åÊõ≤‰ΩÜÊúâÊí≠ÊîæÂàóË°®ÔºåÂàôÊí≠ÊîæÁ¨¨‰∏ÄÈ¶ñ
                playSong(0);
            } else if (audio.src) {
                if (audio.paused) {
                    audio.play();
                    updatePlayState(true);
                } else {
                    audio.pause();
                    updatePlayState(false);
                }
            }
        }

        // ÂàáÊç¢Êí≠ÊîæÊ®°Âºè
        function togglePlayMode() {
            const modes = ['sequence', 'random', 'single'];
            const currentIdx = modes.indexOf(state.playMode);
            const nextIdx = (currentIdx + 1) % modes.length;
            state.playMode = modes[nextIdx];
            
            const btn = $('mode-btn');
            switch (state.playMode) {
                case 'sequence':
                    btn.textContent = 'üîÅ';
                    btn.title = 'ÂàóË°®Âæ™ÁéØ';
                    showToast('ÂàóË°®Âæ™ÁéØ');
                    break;
                case 'random':
                    btn.textContent = 'üîÄ';
                    btn.title = 'ÈöèÊú∫Êí≠Êîæ';
                    showToast('ÈöèÊú∫Êí≠Êîæ');
                    break;
                case 'single':
                    btn.textContent = 'üîÇ';
                    btn.title = 'ÂçïÊõ≤Âæ™ÁéØ';
                    showToast('ÂçïÊõ≤Âæ™ÁéØ');
                    break;
            }
        }

        // ‰∏ä‰∏ÄÈ¶ñ/‰∏ã‰∏ÄÈ¶ñ
        function playPrevious() {
            if (state.playlist.length === 0) return;
            
            let newIndex;
            if (state.playMode === 'random') {
                newIndex = Math.floor(Math.random() * state.playlist.length);
            } else {
                newIndex = (state.currentIndex - 1 + state.playlist.length) % state.playlist.length;
            }
            playSong(newIndex);
        }

        function playNext(auto = false) {
            if (state.playlist.length === 0) return;
            
            // Â¶ÇÊûúÊòØËá™Âä®Êí≠ÊîæÔºàÊí≠ÊîæÁªìÊùüËß¶ÂèëÔºâ‰∏îÊòØÂçïÊõ≤Âæ™ÁéØ
            if (auto && state.playMode === 'single') {
                audio.currentTime = 0;
                audio.play();
                return;
            }
            
            let newIndex;
            if (state.playMode === 'random') {
                newIndex = Math.floor(Math.random() * state.playlist.length);
                // Â∞ΩÈáèÈÅøÂÖçÈöèÊú∫Âà∞Âêå‰∏ÄÈ¶ñÔºàÈô§ÈùûÂè™Êúâ‰∏ÄÈ¶ñÔºâ
                if (state.playlist.length > 1 && newIndex === state.currentIndex) {
                    newIndex = (newIndex + 1) % state.playlist.length;
                }
            } else {
                newIndex = (state.currentIndex + 1) % state.playlist.length;
            }
            playSong(newIndex);
        }

        // ËøõÂ∫¶Êù°
        audio.ontimeupdate = () => {
            if (isNaN(audio.duration)) return;
            const pct = (audio.currentTime / audio.duration) * 100;
            $('progress-fill').style.width = pct + '%';
            $('current-time').textContent = formatTime(audio.currentTime);
        };

        audio.onloadedmetadata = () => {
            $('total-time').textContent = formatTime(audio.duration);
        };

        audio.onended = () => {
            updatePlayState(false);
            playNext(true); // ‰º†ÂÖ• true Ë°®Á§∫Ëá™Âä®Êí≠Êîæ
        };

        function seek(e) {
            if (!audio.src) return;
            const rect = $('progress-bar').getBoundingClientRect();
            const pct = (e.clientX - rect.left) / rect.width;
            audio.currentTime = pct * audio.duration;
        }

        function formatTime(sec) {
            const m = Math.floor(sec / 60);
            const s = Math.floor(sec % 60);
            return `${m}:${s.toString().padStart(2, '0')}`;
        }

        // Êí≠ÊîæÂÆåÊï¥Ê≠åÊõ≤ÔºàÂú®Apple Music‰∏≠Ôºâ
function playFullSong(trackId, trackName, artistName) {
    const song = state.playlist.find(s => s.trackId == trackId);
    const albumId = song?.collectionId || trackId;
    
    const musicAppUrl = `music://music.apple.com/cn/album/${albumId}?i=${trackId}`;
    const webUrl = `https://music.apple.com/cn/album/${albumId}?i=${trackId}`;
    
    // Ê£ÄÊµãËÆæÂ§áÁ±ªÂûã
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isMac = /Macintosh/.test(navigator.userAgent);
    const isAppleDevice = isIOS || isMac;
    
    if (isAppleDevice) {
        // Apple ËÆæÂ§áÔºöÂ∞ùËØïÊâìÂºÄ App
        const startTime = Date.now();
        
        // ‰ΩøÁî® visibilitychange Ê£ÄÊµãÊòØÂê¶ÊàêÂäüË∑≥ËΩ¨Âà∞ App
        const handleVisibilityChange = () => {
            if (document.hidden) {
                // È°µÈù¢Ë¢´ÈöêËóèÔºåËØ¥ÊòéÊàêÂäüÊâìÂºÄ‰∫Ü App
                clearTimeout(fallbackTimer);
                document.removeEventListener('visibilitychange', handleVisibilityChange);
            }
        };
        document.addEventListener('visibilitychange', handleVisibilityChange);
        
        // Â∞ùËØïÊâìÂºÄ App
        window.location.href = musicAppUrl;
        
        // ËÆæÁΩÆÈôçÁ∫ßÂÆöÊó∂Âô®
        const fallbackTimer = setTimeout(() => {
            document.removeEventListener('visibilitychange', handleVisibilityChange);
            
            // Â¶ÇÊûúÈ°µÈù¢ËøòÂèØËßÅ‰∏îÊó∂Èó¥ÂæàÁü≠ÔºåËØ¥Êòé App Ê≤°ÊâìÂºÄ
            if (!document.hidden && Date.now() - startTime < 2000) {
                showFallbackOptions(trackName, artistName, webUrl);
            }
        }, 1500);
        
    } else {
        // Èùû Apple ËÆæÂ§áÔºöÁõ¥Êé•ÊâìÂºÄÁΩëÈ°µÁâà
        window.open(webUrl, '_blank');
        showToast(`Ê≠£Âú®ÊâìÂºÄ "${trackName}" - ${artistName}`);
    }
}

// ÊòæÁ§∫ÈôçÁ∫ßÈÄâÈ°π
function showFallbackOptions(trackName, artistName, webUrl) {
    // ÂàõÂª∫‰∏Ä‰∏™Êõ¥ÂèãÂ•ΩÁöÑÊèêÁ§∫Ê°Ü
    const modal = document.createElement('div');
    modal.className = 'apple-music-modal';
    modal.innerHTML = `
        <div class="modal-overlay" onclick="this.parentElement.remove()">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-icon">üéµ</div>
                <h3>ÊâìÂºÄ Apple Music</h3>
                <p>Âç≥Â∞ÜÊí≠Êîæ "${trackName}"<br><span class="artist">${artistName}</span></p>
                <div class="modal-buttons">
                    <a href="${webUrl}" target="_blank" class="btn-primary" onclick="this.closest('.apple-music-modal').remove()">
                        Âú®ÁΩëÈ°µ‰∏≠ÊâìÂºÄ
                    </a>
                    <button class="btn-secondary" onclick="this.closest('.apple-music-modal').remove()">
                        ÂèñÊ∂à
                    </button>
                </div>
                <p class="hint">ÊèêÁ§∫ÔºöÂÆâË£Ö Apple Music Â∫îÁî®ÂèØËé∑ÂæóÊõ¥Â•Ω‰ΩìÈ™å</p>
            </div>
        </div>
    `;
    
    // Ê∑ªÂä†Ê†∑Âºè
    if (!document.querySelector('#apple-music-modal-styles')) {
        const styles = document.createElement('style');
        styles.id = 'apple-music-modal-styles';
        styles.textContent = `
            .apple-music-modal .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: fadeIn 0.2s ease;
            }
            .apple-music-modal .modal-content {
                background: white;
                border-radius: 16px;
                padding: 24px;
                max-width: 320px;
                width: 90%;
                text-align: center;
                animation: slideUp 0.3s ease;
            }
            .apple-music-modal .modal-icon {
                font-size: 48px;
                margin-bottom: 12px;
            }
            .apple-music-modal h3 {
                margin: 0 0 8px;
                font-size: 18px;
                color: #1a1a1a;
            }
            .apple-music-modal p {
                margin: 0 0 16px;
                color: #666;
                font-size: 14px;
                line-height: 1.5;
            }
            .apple-music-modal .artist {
                color: #999;
            }
            .apple-music-modal .modal-buttons {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            .apple-music-modal .btn-primary {
                background: linear-gradient(135deg, #fc3c44, #d93a41);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 10px;
                font-size: 16px;
                font-weight: 500;
                cursor: pointer;
                text-decoration: none;
                display: block;
            }
            .apple-music-modal .btn-secondary {
                background: #f0f0f0;
                color: #333;
                border: none;
                padding: 12px 24px;
                border-radius: 10px;
                font-size: 16px;
                cursor: pointer;
            }
            .apple-music-modal .hint {
                font-size: 12px;
                color: #999;
                margin-top: 16px;
                margin-bottom: 0;
            }
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            @keyframes slideUp {
                from { transform: translateY(20px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
        `;
        document.head.appendChild(styles);
    }
    
    document.body.appendChild(modal);
}

// Toast ÊèêÁ§∫
function showToast(message) {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 10000;
        animation: fadeIn 0.3s ease;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'fadeOut 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
    }, 2000);
}

        // Ê≠åËØç
        async function fetchLyrics(artist, title) {
            // ÁîüÊàêÁºìÂ≠òÈîÆ
            const cacheKey = `lyrics_${encodeURIComponent(artist)}_${encodeURIComponent(title)}`;
            const cachedLyrics = CacheManager.get(cacheKey);

            if (cachedLyrics) {
                console.log('Using cached lyrics for:', artist, title);
                $('lyrics-text').textContent = cachedLyrics;
                return;
            }

            try {
                const cleanTitle = title.split('(')[0].split('-')[0].trim();
                const cleanArtist = artist.split('&')[0].split(',')[0].trim();
                const res = await fetch(`https://api.lyrics.ovh/v1/${encodeURIComponent(cleanArtist)}/${encodeURIComponent(cleanTitle)}`);

                if (res.ok) {
                    const data = await res.json();
                    if (data.lyrics) {
                        $('lyrics-text').textContent = data.lyrics;
                        // ÁºìÂ≠òÊ≠åËØçÔºàÊúâÊïàÊúü24Â∞èÊó∂Ôºâ
                        CacheManager.set(cacheKey, data.lyrics, 24);
                        return;
                    }
                }
                showCatFallback();
            } catch {
                showCatFallback();
            }
        }

        async function showCatFallback() {
            try {
                const res = await fetch('https://api.thecatapi.com/v1/images/search');
                const data = await res.json();
                if (data?.[0]?.url) {
                    $('lyrics-text').innerHTML = `
                        <div style="margin-bottom: 20px; color: var(--text-secondary);">ÊöÇÊó†Ê≠åËØçÔºåÈÄÅ‰Ω†‰∏ÄÂè™Áå´ üê±</div>
                        <img src="${data[0].url}" style="max-width: 280px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.4);">
                    `;
                    return;
                }
            } catch {}
            $('lyrics-text').textContent = 'ÊöÇÊó†Ê≠åËØç';
        }

        // ËÆæÁΩÆÁª¥Âü∫ÁôæÁßëÈìæÊé•
        function setupWikipediaLink(artistName) {
            const cleanName = artistName.split(/&|,|feat\.|ft\./i)[0].trim();
            const encodedName = encodeURIComponent(cleanName);

            // Â≠òÂÇ®ÈìæÊé•Âà∞Ëâ∫ÊúØÂÆ∂ÂÖÉÁ¥†ÁöÑÊï∞ÊçÆÂ±ûÊÄß as fallback
            $('lyrics-artist').dataset.wikiUrl = `https://zh.wikipedia.org/wiki/${encodedName}`;

            // È™åËØÅÈìæÊé•ÊòØÂê¶Â≠òÂú®ÔºàÂºÇÊ≠•Ê£ÄÊü•Ôºâ
            verifyWikipediaPageExists(cleanName);
        }

        // È™åËØÅÁª¥Âü∫ÁôæÁßëÈ°µÈù¢ÊòØÂê¶Â≠òÂú®
        async function verifyWikipediaPageExists(artistName) {
            const cleanName = artistName.split(/&|,|feat\.|ft\./i)[0].trim();
            const encodedName = encodeURIComponent(cleanName);

            // È¶ñÂÖàÂ∞ùËØï‰∏≠ÊñáÁª¥Âü∫ÁôæÁßë
            try {
                const res = await fetch(`https://zh.wikipedia.org/api/rest_v1/page/summary/${encodedName}`);

                if (res.ok) {
                    const data = await res.json();
                    if (data.title) {
                        // ‰∏≠ÊñáÁª¥Âü∫ÁôæÁßëÂ≠òÂú®Ôºå‰ΩøÁî®‰∏≠ÊñáÈìæÊé•
                        $('lyrics-artist').dataset.wikiUrl = `https://zh.wikipedia.org/wiki/${encodedName}`;
                        return;
                    }
                }
            } catch {}

            // Â¶ÇÊûú‰∏≠Êñá‰∏çÂ≠òÂú®ÔºåÂ∞ùËØïËã±ÊñáÁª¥Âü∫ÁôæÁßë
            try {
                const res = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodedName}`);

                if (res.ok) {
                    const data = await res.json();
                    if (data.title) {
                        // Ëã±ÊñáÁª¥Âü∫ÁôæÁßëÂ≠òÂú®Ôºå‰ΩøÁî®Ëã±ÊñáÈìæÊé•
                        $('lyrics-artist').dataset.wikiUrl = `https://en.wikipedia.org/wiki/${encodedName}`;
                        return;
                    }
                }
            } catch {}

            // Â¶ÇÊûúÈÉΩ‰∏çÂ≠òÂú®ÔºåËÆæÁΩÆ‰∏∫ÊêúÁ¥¢È°µÈù¢
            $('lyrics-artist').dataset.wikiUrl = `https://zh.wikipedia.org/wiki/Special:Search?search=${encodedName}`;
        }

        // Ê≠åÊâãÁôæÁßë
        async function fetchArtistWiki(artistName) {
            const cleanName = artistName.split(/&|,|feat\.|ft\./i)[0].trim();
            const cacheKey = `wiki_${encodeURIComponent(cleanName)}`;
            const cachedWiki = CacheManager.get(cacheKey);

            if (cachedWiki) {
                console.log('Using cached wiki for:', cleanName);
                $('wiki-title').textContent = `ÂÖ≥‰∫é ${cachedWiki.title}`;
                $('wiki-text').textContent = cachedWiki.extract;
                $('lyrics-wiki').classList.add('show');
                return;
            }

            try {
                let res = await fetch(`https://zh.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(cleanName)}`);
                if (!res.ok) {
                    res = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(cleanName)}`);
                }

                if (res.ok) {
                    const data = await res.json();
                    if (data.extract) {
                        $('wiki-title').textContent = `ÂÖ≥‰∫é ${data.title}`;
                        $('wiki-text').textContent = data.extract;
                        $('lyrics-wiki').classList.add('show');
                        // ÁºìÂ≠òÁª¥Âü∫ÁôæÁßëÊï∞ÊçÆÔºàÊúâÊïàÊúü12Â∞èÊó∂Ôºâ
                        CacheManager.set(cacheKey, {
                            title: data.title,
                            extract: data.extract
                        }, 12);
                    } else {
                        // If no wiki summary found, hide the wiki section
                        $('lyrics-wiki').classList.remove('show');
                    }
                }
            } catch {}
        }

        // Ê≠åËØçÈ°µÈù¢
        function openLyrics() {
            if (!state.currentTrack) return;
            $('lyrics-modal').classList.add('show');
        }

        function closeLyrics() {
            $('lyrics-modal').classList.remove('show');
        }

        // Â§©Ê∞îÊêúÁ¥¢ - ÈöèÊú∫ÂÖ≥ÈîÆËØçÂ¢ûÂº∫Áâà
async function searchByWeather() {
    try {
        // 1. Ëé∑ÂèñÂú∞ÁêÜ‰ΩçÁΩÆ
        const geoRes = await fetch('https://get.geojs.io/v1/ip/geo.json');
        const geo = await geoRes.json();
        
        // 2. Ëé∑ÂèñÂ§©Ê∞îÊï∞ÊçÆ
        const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${geo.latitude}&longitude=${geo.longitude}&current_weather=true`);
        const weatherData = await weatherRes.json();
        const code = weatherData.current_weather.weathercode;
        
        // 3. ÂÆö‰πâÂèòÈáè
        let keywordOptions = []; // ÂÄôÈÄâÂÖ≥ÈîÆËØçÂàóË°®
        let weatherLabel = 'Êú™Áü•'; // Â§©Ê∞î‰∏≠ÊñáÂêç
        
        // 4. Ê†πÊçÆÂ§©Ê∞î‰ª£Á†ÅÂàÜÈÖçÂÖ≥ÈîÆËØçÂ∫ì
        if (code <= 3) { 
            // Êô¥Êúó (0-3)
            weatherLabel = 'Êô¥Êúó'; 
            keywordOptions = ['Sunny Day', 'Summer Vibes', 'Road Trip', 'Happy Pop', 'Feel Good', 'Energetic', 'Disco'];
        }
        else if (code >= 45 && code <= 48) { 
            // ÈõæÂ§© (45, 48)
            weatherLabel = 'ÈõæÂ§©'; 
            keywordOptions = ['Foggy Mood', 'Ambient', 'Mystery', 'Dreamy', 'Shoegaze', 'Haze', 'Cinematic'];
        }
        else if (code >= 51 && code <= 67) { 
            // ‰∏ãÈõ® (51-67)
            weatherLabel = '‰∏ãÈõ®'; 
            keywordOptions = ['Rainy Day', 'Acoustic', 'Jazz', 'Lofi Hip Hop', 'Sad Songs', 'R&B', 'Cozy'];
        }
        else if (code >= 71 && code <= 86) { 
            // ‰∏ãÈõ™ (71-86)
            weatherLabel = '‰∏ãÈõ™'; 
            keywordOptions = ['Snow Winter', 'Christmas', 'Piano', 'Chillout', 'Classical', 'Fireplace', 'Soft Jazz'];
        }
        else if (code >= 95) { 
            // Èõ∑Êö¥ (95+)
            weatherLabel = 'Èõ∑Êö¥'; 
            keywordOptions = ['Thunder Storm', 'Rock', 'Heavy Metal', 'Epic', 'Dark Wave', 'Intense', 'Dramatic'];
        }
        else { 
            // Â§ö‰∫ë/Èò¥Â§© (ÂÖ∂‰ªñÊÉÖÂÜµ)
            weatherLabel = 'Â§ö‰∫ë'; 
            keywordOptions = ['Cloudy Sky', 'Indie', 'Folk', 'Mellow', 'Soft Rock', 'Chill', 'Coffee Shop'];
        }

        // 5. Ê†∏ÂøÉÔºö‰ªéÊï∞ÁªÑ‰∏≠ÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™ÂÖ≥ÈîÆËØç
        const randomKeyword = keywordOptions[Math.floor(Math.random() * keywordOptions.length)];

        // 6. ÊâßË°åÊêúÁ¥¢‰∏éÊèêÁ§∫
        const searchInput = document.getElementById('search-input') || document.querySelector('#search-input'); // ÂÖºÂÆπÂÜôÊ≥ïÔºåÈò≤Ê≠¢ $ Êú™ÂÆö‰πâ
        if (searchInput) {
            searchInput.value = randomKeyword;
        } else {
             // Â¶ÇÊûú‰Ω†Áî®ÁöÑÊòØ jQuery ÊàñËÄÖËá™ÂÆö‰πâÁöÑ $ ÂáΩÊï∞ÔºåËØ∑‰øùÁïôÂéüÊ†∑Ôºö
             // $('search-input').value = randomKeyword;
             console.warn('Êú™ÊâæÂà∞ËæìÂÖ•Ê°ÜÂÖÉÁ¥†');
        }
        
        // ÂÅáËÆæ searchMusic() ÊòØ‰Ω†ÂÆö‰πâÂ•ΩÁöÑÊêúÁ¥¢ÂáΩÊï∞
        if (typeof searchMusic === 'function') {
            searchMusic();
        }
        
        alert(`üìç ${geo.city || 'Êú™Áü•'}\nüå§Ô∏è ${weatherLabel}\nüé≤ ÈöèÊú∫ÂøÉÊÉÖ: ${randomKeyword}`);

    } catch (e) {
        console.error(e);
        alert('Ëé∑ÂèñÂ§©Ê∞îÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªú');
    }
}

        // ÂºπÂπïÁ≥ªÁªü
        function startDanmaku() {
            $('danmaku').classList.add('show');
            $('danmaku').innerHTML = '';
            
            if (state.danmakuInterval) clearInterval(state.danmakuInterval);
            
            spawnDanmaku();
            state.danmakuInterval = setInterval(spawnDanmaku, 4000);
        }

        async function spawnDanmaku() {
            const useCache = state.danmakuCache.length > 0 && Math.random() < 0.5;
            
            if (useCache) {
                renderDanmaku(state.danmakuCache[Math.floor(Math.random() * state.danmakuCache.length)]);
            } else {
                try {
                    const [userRes, textRes] = await Promise.all([
                        fetch('https://randomuser.me/api/?inc=name,picture'),
                        Math.random() > 0.5 
                            ? fetch('https://api.kanye.rest/') 
                            : fetch('https://v1.hitokoto.cn/?c=a&c=b')
                    ]);
                    
                    const user = await userRes.json();
                    const text = await textRes.json();
                    
                    const data = {
                        name: user.results[0].name.first,
                        avatar: user.results[0].picture.thumbnail,
                        text: text.quote || text.hitokoto
                    };
                    
                    state.danmakuCache.push(data);
                    if (state.danmakuCache.length > 30) state.danmakuCache.shift();
                    
                    renderDanmaku(data);
                } catch {}
            }
        }

        function renderDanmaku(data) {
            let track = state.tracks.findIndex(t => !t);
            if (track === -1) track = Math.floor(Math.random() * 5);
            
            state.tracks[track] = true;
            
            const item = document.createElement('div');
            item.className = 'danmaku-item';
            item.style.top = (track * 40 + 10) + 'px';
            item.style.animationDuration = (12 + Math.random() * 5) + 's';
            
            item.innerHTML = `
                <img class="danmaku-avatar" src="${data.avatar}" alt="">
                <span class="danmaku-name">${escapeHtml(data.name)}:</span>
                <span class="danmaku-text">${escapeHtml(data.text)}</span>
            `;
            
            item.onanimationend = () => {
                item.remove();
                state.tracks[track] = false;
            };
            
            $('danmaku').appendChild(item);
        }

        // PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('SW registered:', reg.scope))
                .catch(err => console.log('SW failed:', err));
        }

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', e => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallPrompt();
        });

        function showInstallPrompt() {
            if (document.querySelector('.install-prompt')) return;
            
            const div = document.createElement('div');
            div.className = 'install-prompt';
            div.innerHTML = `
                <div class="install-icon">üì±</div>
                <div class="install-text">
                    <div class="install-title">Ê∑ªÂä†Âà∞‰∏ªÂ±èÂπï</div>
                    <div class="install-desc">Ëé∑ÂæóÊõ¥Â•ΩÁöÑÂÖ®Â±è‰ΩìÈ™å</div>
                </div>
                <button class="install-btn" onclick="installApp()">ÂÆâË£Ö</button>
                <button class="install-close" onclick="this.parentElement.remove()">√ó</button>
            `;
            document.body.appendChild(div);
            
            setTimeout(() => div.remove(), 10000);
        }

        // ========== Êî∂ËóèÂíåÂéÜÂè≤ÂäüËÉΩ ==========
        
        // ÂàáÊç¢Êî∂ËóèÁä∂ÊÄÅ
        function toggleFavorite() {
            if (!state.currentTrack) return;
            
            const trackId = state.currentTrack.trackId;
            const btn = $('favorite-btn');
            
            if (FavoritesManager.isFavorited(trackId)) {
                FavoritesManager.remove(trackId);
                btn.textContent = 'ü§ç';
                btn.classList.remove('favorited');
                showToast('Â∑≤ÂèñÊ∂àÊî∂Ëóè');
            } else {
                FavoritesManager.add(state.currentTrack);
                btn.textContent = '‚ù§Ô∏è';
                btn.classList.add('favorited');
                showToast('Â∑≤Ê∑ªÂä†Âà∞Êî∂Ëóè');
            }
        }
        
        // Êõ¥Êñ∞Êî∂ËóèÊåâÈíÆÁä∂ÊÄÅ
        function updateFavoriteButton() {
            if (!state.currentTrack) return;
            
            const btn = $('favorite-btn');
            const isFavorited = FavoritesManager.isFavorited(state.currentTrack.trackId);
            
            btn.textContent = isFavorited ? '‚ù§Ô∏è' : 'ü§ç';
            if (isFavorited) {
                btn.classList.add('favorited');
            } else {
                btn.classList.remove('favorited');
            }
        }
        
        // ÊâìÂºÄÂéÜÂè≤ËÆ∞ÂΩï
        function openHistory() {
            $('history-modal').classList.add('show');
            renderHistory();
        }
        
        // ÂÖ≥Èó≠ÂéÜÂè≤ËÆ∞ÂΩï
        function closeHistory() {
            $('history-modal').classList.remove('show');
        }
        
        // Ê∏≤ÊüìÂéÜÂè≤ËÆ∞ÂΩï
        function renderHistory() {
            const history = HistoryManager.getAll();
            const container = $('history-content');
            
            if (history.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìñ</div>
                        <div class="empty-title">ÊöÇÊó†Êí≠ÊîæÂéÜÂè≤</div>
                        <div class="empty-desc">ÂºÄÂßãÊí≠ÊîæÈü≥‰πêÂêé‰ºöËá™Âä®ËÆ∞ÂΩï</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="collection-grid">
                    ${history.map(song => `
                        <div class="collection-item" onclick="playHistoryItem('${song.trackId}')">
                            <img class="collection-item-cover" src="${(song.artworkUrl100 || song.artworkUrl || '').replace('100x100bb', '300x300bb')}" alt="">
                            <div class="collection-item-title">${escapeHtml(song.trackName)}</div>
                            <div class="collection-item-artist">${escapeHtml(song.artistName)}</div>
                            <div class="collection-item-time">${formatDate(song.playedAt)}</div>
                            <button class="collection-item-remove" onclick="event.stopPropagation(); removeHistory('${song.trackId}')" title="Âà†Èô§">√ó</button>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // Êí≠ÊîæÂéÜÂè≤‰∏≠ÁöÑÊ≠åÊõ≤
        function playHistoryItem(trackId) {
            const history = HistoryManager.getAll();
            const song = history.find(s => s.trackId == trackId);
            if (song) {
                // Â∞ÜÊ≠åÊõ≤Ê∑ªÂä†Âà∞Êí≠ÊîæÂàóË°®Âπ∂Êí≠Êîæ
                state.playlist = [song];
                state.currentIndex = 0;
                playSong(0);
                closeHistory();
            }
        }
        
        // Âà†Èô§ÂéÜÂè≤ËÆ∞ÂΩï
        function removeHistory(trackId) {
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ÂéÜÂè≤ËÆ∞ÂΩïÂêóÔºü')) {
                HistoryManager.remove(trackId);
                renderHistory();
                showToast('Â∑≤Âà†Èô§');
            }
        }
        
        // Ê∏ÖÁ©∫ÂéÜÂè≤
        function clearHistory() {
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÊí≠ÊîæÂéÜÂè≤ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ')) {
                HistoryManager.clear();
                renderHistory();
                showToast('ÂéÜÂè≤ËÆ∞ÂΩïÂ∑≤Ê∏ÖÁ©∫');
            }
        }
        
        // ÂØºÂá∫ÂéÜÂè≤
        function exportHistory() {
            const history = HistoryManager.getAll();
            if (history.length === 0) {
                alert('ÊöÇÊó†ÂéÜÂè≤ËÆ∞ÂΩïÂèØÂØºÂá∫');
                return;
            }
            HistoryManager.export();
            showToast('ÂéÜÂè≤ËÆ∞ÂΩïÂ∑≤ÂØºÂá∫');
        }
        
        // ÂØºÂÖ•ÂéÜÂè≤
        function importHistory() {
            const input = $('import-file-input');
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const count = await HistoryManager.import(file);
                        renderHistory();
                        showToast(`ÊàêÂäüÂØºÂÖ• ${count} Êù°ÂéÜÂè≤ËÆ∞ÂΩï`);
                    } catch (err) {
                        alert('ÂØºÂÖ•Â§±Ë¥•Ôºö' + err.message);
                    }
                }
                input.value = '';
            };
            input.click();
        }
        
        // ÊâìÂºÄÊî∂ËóèÂàóË°®
        function openFavorites() {
            $('favorites-modal').classList.add('show');
            renderFavorites();
        }
        
        // ÂÖ≥Èó≠Êî∂ËóèÂàóË°®
        function closeFavorites() {
            $('favorites-modal').classList.remove('show');
        }
        
        // Ê∏≤ÊüìÊî∂ËóèÂàóË°®
        function renderFavorites() {
            const favorites = FavoritesManager.getAll();
            const container = $('favorites-content');
            
            if (favorites.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚ù§Ô∏è</div>
                        <div class="empty-title">ÊöÇÊó†Êî∂Ëóè</div>
                        <div class="empty-desc">ÁÇπÂáªÊí≠ÊîæÂô®‰∏≠ÁöÑÁà±ÂøÉÊåâÈíÆÊî∂ËóèÊ≠åÊõ≤</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="collection-grid">
                    ${favorites.map(song => `
                        <div class="collection-item" onclick="playFavoriteItem('${song.trackId}')">
                            <img class="collection-item-cover" src="${(song.artworkUrl100 || song.artworkUrl || '').replace('100x100bb', '300x300bb')}" alt="">
                            <div class="collection-item-title">${escapeHtml(song.trackName)}</div>
                            <div class="collection-item-artist">${escapeHtml(song.artistName)}</div>
                            <div class="collection-item-time">${formatDate(song.favoritedAt)}</div>
                            <button class="collection-item-remove" onclick="event.stopPropagation(); removeFavorite('${song.trackId}')" title="ÂèñÊ∂àÊî∂Ëóè">√ó</button>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // Êí≠ÊîæÊî∂Ëóè‰∏≠ÁöÑÊ≠åÊõ≤
        function playFavoriteItem(trackId) {
            const favorites = FavoritesManager.getAll();
            const song = favorites.find(s => s.trackId == trackId);
            if (song) {
                // Â∞ÜÊ≠åÊõ≤Ê∑ªÂä†Âà∞Êí≠ÊîæÂàóË°®Âπ∂Êí≠Êîæ
                state.playlist = [song];
                state.currentIndex = 0;
                playSong(0);
                closeFavorites();
            }
        }
        
        // ÂèñÊ∂àÊî∂Ëóè
        function removeFavorite(trackId) {
            if (confirm('Á°ÆÂÆöË¶ÅÂèñÊ∂àÊî∂ËóèËøôÈ¶ñÊ≠åÂêóÔºü')) {
                FavoritesManager.remove(trackId);
                renderFavorites();
                updateFavoriteButton();
                showToast('Â∑≤ÂèñÊ∂àÊî∂Ëóè');
            }
        }
        
        // Ê∏ÖÁ©∫Êî∂Ëóè
        function clearFavorites() {
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÊî∂ËóèÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ')) {
                FavoritesManager.clear();
                renderFavorites();
                updateFavoriteButton();
                showToast('Êî∂ËóèÂ∑≤Ê∏ÖÁ©∫');
            }
        }
        
        // ÂØºÂá∫Êî∂Ëóè
        function exportFavorites() {
            const favorites = FavoritesManager.getAll();
            if (favorites.length === 0) {
                alert('ÊöÇÊó†Êî∂ËóèÂèØÂØºÂá∫');
                return;
            }
            FavoritesManager.export();
            showToast('Êî∂ËóèÂ∑≤ÂØºÂá∫');
        }
        
        // ÂØºÂÖ•Êî∂Ëóè
        function importFavorites() {
            const input = $('import-file-input');
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const count = await FavoritesManager.import(file);
                        renderFavorites();
                        updateFavoriteButton();
                        showToast(`ÊàêÂäüÂØºÂÖ• ${count} È¶ñÊî∂Ëóè`);
                    } catch (err) {
                        alert('ÂØºÂÖ•Â§±Ë¥•Ôºö' + err.message);
                    }
                }
                input.value = '';
            };
            input.click();
        }
        
        // Ê†ºÂºèÂåñÊó•Êúü
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            // Â∞è‰∫é1ÂàÜÈíü
            if (diff < 60000) {
                return 'ÂàöÂàö';
            }
            // Â∞è‰∫é1Â∞èÊó∂
            if (diff < 3600000) {
                return Math.floor(diff / 60000) + 'ÂàÜÈíüÂâç';
            }
            // Â∞è‰∫é1Â§©
            if (diff < 86400000) {
                return Math.floor(diff / 3600000) + 'Â∞èÊó∂Ââç';
            }
            // Â∞è‰∫é7Â§©
            if (diff < 604800000) {
                return Math.floor(diff / 86400000) + 'Â§©Ââç';
            }
            // ÊòæÁ§∫ÂÖ∑‰ΩìÊó•Êúü
            return date.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' });
        }

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(() => {
                    deferredPrompt = null;
                    document.querySelector('.install-prompt')?.remove();
                });
            }
        }
    </script>
</body>
</html>