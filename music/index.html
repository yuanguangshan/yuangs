<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ÂπøÂ±±Èü≥‰πê</title>

    <!-- PWA Ê†∏ÂøÉÈÖçÁΩÆ -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#0a0a0a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ÂπøÂ±±Èü≥‰πê">

    <!-- ÂõæÊ†áÈÖçÁΩÆ -->
    <link rel="icon" type="image/x-icon" href="./icon/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="./icon/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./icon/icon-16x16.png">
    <link rel="apple-touch-icon" href="./icon/apple-touch-icon.png">

    <style>
        :root {
            --primary: #1db954;
            --primary-dark: #1aa34a;
            --accent: #ff6b6b;
            --bg: #0a0a0a;
            --card: #161616;
            --card-hover: #1f1f1f;
            --text: #ffffff;
            --text-secondary: #a0a0a0;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        /* Ëá™ÂÆö‰πâÊªöÂä®Êù° */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
            position: relative;
        }

        /* Âä®ÊÄÅËÉåÊôØ */
        .bg-gradient {
            position: fixed;
            inset: 0;
            z-index: 0;
            opacity: 0.6;
            transition: opacity 0.8s ease;
            background: radial-gradient(ellipse at 50% 0%, var(--primary) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 50%, #6366f1 0%, transparent 40%),
                radial-gradient(ellipse at 20% 80%, #ec4899 0%, transparent 40%);
            filter: blur(80px) saturate(150%);
        }

        .bg-album {
            position: fixed;
            inset: 0;
            z-index: 0;
            background-size: cover;
            background-position: center;
            opacity: 0;
            transition: opacity 1s ease;
            filter: blur(60px) brightness(0.4) saturate(120%);
        }

        .bg-album.active {
            opacity: 0.7;
        }

        /* È°∂ÈÉ®ÊêúÁ¥¢Ê†è */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: calc(8px + var(--safe-top)) 16px 8px;
            background: linear-gradient(to bottom, rgba(10, 10, 10, 0.95) 0%, rgba(10, 10, 10, 0.8) 70%, transparent 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .search-box {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .search-input {
            width: 100%;
            height: 40px;
            padding: 0 40px 0 18px;
            /* Add padding on the right to make space for clear button */
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            background: var(--glass);
            color: var(--text);
            font-size: 15px;
            outline: none;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: var(--primary);
            background: rgba(29, 185, 84, 0.1);
        }

        .search-input::placeholder {
            color: var(--text-secondary);
        }

        .search-input-container {
            position: relative;
            flex: 1;
            min-width: 120px;
            max-width: 300px;
        }

        .search-clear-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .search-clear-btn:hover {
            background: var(--glass-border);
            color: var(--text);
        }

        .btn {
            height: 40px;
            padding: 0 18px;
            border-radius: 20px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: var(--text);
            font-size: 18px;
        }

        .btn-icon:hover {
            background: var(--glass-border);
        }

        /* ÂÜÖÂÆπÂå∫ */
        .content {
            position: relative;
            z-index: 1;
            padding: calc(72px + var(--safe-top)) 16px calc(200px + var(--safe-bottom));
            min-height: 100vh;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
        }

        /* Ê≠åÊõ≤Âç°Áâá */
        .song-card {
            background: var(--card);
            border-radius: 12px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            position: relative;
        }

        .song-options {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .song-card:hover .song-options {
            opacity: 1;
        }

        .song-card:hover {
            background: var(--card-hover);
            transform: translateY(-4px);
            border-color: var(--glass-border);
        }

        .song-card:active {
            transform: scale(0.98);
        }

        .song-card.playing {
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(29, 185, 84, 0.3);
        }

        .song-cover {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 12px;
            object-fit: cover;
            background: #222;
            margin-bottom: 8px;
            position: relative;
            overflow: hidden;
        }

        .song-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .song-card:hover .song-cover img {
            transform: scale(1.05);
        }

        .play-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .song-card:hover .play-overlay,
        .song-card.playing .play-overlay {
            opacity: 1;
        }

        .play-overlay-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .song-title {
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }

        .song-artist {
            font-size: 11px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Â∫ïÈÉ®Êí≠ÊîæÂô® - ÂÖ®Êñ∞ËÆæËÆ° */
        .player {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 0 16px calc(16px + var(--safe-bottom));
            background: linear-gradient(to top, rgba(10, 10, 10, 1) 0%, rgba(10, 10, 10, 0.95) 50%, transparent 100%);
            pointer-events: none;
        }

        .player-card {
            background: var(--card);
            border-radius: 24px;
            padding: 12px 16px 16px;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.5);
            pointer-events: auto;
        }

        /* È°∂ÈÉ®‰ø°ÊÅØÊ†è */
        .player-info-bar {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 12px;
            padding: 8px 12px;
            background: var(--glass);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            /* Allow proper alignment of the wiki button */
        }

        .player-label {
            font-size: 12px;
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .player-text-wrapper {
            overflow: hidden;
            white-space: nowrap;
            flex-shrink: 1;
            min-width: 0;
            position: relative;
        }

        .title-wrapper {
            max-width: 200px;
        }

        .artist-wrapper {
            max-width: 150px;
        }

        .player-title-text {
            display: inline-block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            cursor: pointer;
            transition: color 0.2s ease;
            white-space: nowrap;
        }

        .player-title-text:hover {
            color: var(--primary);
        }

        .player-separator {
            font-size: 12px;
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .player-artist-text {
            display: inline-block;
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.2s ease;
            white-space: nowrap;
        }

        .player-artist-text:hover {
            color: var(--primary);
        }

        /* ÂìçÂ∫îÂºèË∞ÉÊï¥ */
        @media (max-width: 767px) {
            .title-wrapper {
                max-width: 120px;
            }

            .artist-wrapper {
                max-width: 100px;
            }
        }

        .player-wiki-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
            /* Default not highlighted */
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
            padding: 0;
            margin-left: auto;
            /* Push to the right */
        }

        .player-wiki-btn:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
        }

        /* ÊªöÂä®Âä®Áîª */
        .scroll-text {
            animation: scroll-left var(--duration, 10s) linear infinite alternate;
        }

        @keyframes scroll-left {

            0%,
            10% {
                transform: translateX(0);
            }

            90%,
            100% {
                transform: translateX(var(--scroll-distance, -50%));
            }
        }

        /* ‰∏ªÊéßÂà∂Âå∫ */
        .player-main {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .player-cover {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            object-fit: cover;
            background: #222;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            cursor: pointer;
        }

        .player-cover.spinning {
            animation: spin 8s linear infinite;
            border-radius: 50%;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(-360deg);
            }
        }

        .player-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
            margin-left: auto;
        }

        .ctrl-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: var(--text);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            opacity: 0.6;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ctrl-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            opacity: 1;
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(29, 185, 84, 0.5);
        }

        .ctrl-btn:active {
            transform: scale(0.95);
        }

        .ctrl-btn.play {
            width: 56px;
            height: 56px;
            background: var(--primary);
            color: white;
            font-size: 24px;
            opacity: 0.9;
            box-shadow: 0 0 25px rgba(29, 185, 84, 0.3);
        }

        .ctrl-btn.play:hover {
            background: var(--primary-dark);
            opacity: 1;
            transform: scale(1.08);
            box-shadow: 0 0 30px rgba(29, 185, 84, 0.6);
        }

        .ctrl-btn.play:active {
            transform: scale(0.95);
        }

        /* ËøõÂ∫¶Êù° */
        .progress-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .time {
            font-size: 11px;
            color: var(--text-secondary);
            min-width: 36px;
            text-align: center;
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            border-radius: 2px;
            transition: width 0.1s linear;
        }

        .progress-bar:hover .progress-fill {
            background: #1ed760;
        }

        /* Ê≠åËØçËØ¶ÊÉÖÈ°µ */
        .lyrics-modal {
            position: fixed;
            inset: 0;
            z-index: 200;
            background: var(--bg);
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            overflow-y: auto;
            padding: calc(60px + var(--safe-top)) 24px calc(24px + var(--safe-bottom));
        }

        .lyrics-modal.show {
            transform: translateY(0);
        }

        .lyrics-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: calc(16px + var(--safe-top)) 24px 16px;
            background: linear-gradient(to bottom, var(--bg) 0%, transparent 100%);
            z-index: 10;
        }

        .lyrics-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--glass);
            border: none;
            color: var(--text);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lyrics-cover {
            width: 200px;
            height: 200px;
            border-radius: 20px;
            margin: 0 auto 24px;
            display: block;
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.5);
        }

        .lyrics-title {
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 8px;
        }

        .lyrics-artist {
            font-size: 16px;
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 32px;
            display: inline-block;
        }

        .lyrics-artist-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 32px;
        }

        .lyrics-artist.clickable:hover {
            color: var(--primary);
        }

        .lyrics-wiki {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            border-left: 3px solid var(--primary);
            display: none;
        }

        .lyrics-wiki.show {
            display: block;
        }

        .lyrics-wiki-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .lyrics-wiki-text {
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .lyrics-text {
            font-size: 18px;
            line-height: 2;
            color: var(--text-secondary);
            text-align: center;
            white-space: pre-wrap;
        }

        /* ÂºπÂπï */
        .danmaku {
            position: fixed;
            top: calc(100px + var(--safe-top));
            left: 0;
            right: 0;
            height: 200px;
            z-index: 50;
            pointer-events: none;
            overflow: hidden;
            mask-image: linear-gradient(to bottom, transparent, black 15%, black 85%, transparent);
            display: none;
        }

        .danmaku.show {
            display: block;
        }

        .danmaku-item {
            position: absolute;
            left: 100%;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            white-space: nowrap;
            animation: danmaku-slide linear forwards;
        }

        .danmaku-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }

        .danmaku-name {
            color: var(--primary);
            font-weight: 600;
            font-size: 13px;
        }

        .danmaku-text {
            font-size: 13px;
            color: var(--text);
        }

        @keyframes danmaku-slide {
            from {
                transform: translateX(0);
            }

            to {
                transform: translateX(calc(-100% - 100vw));
            }
        }

        /* Á©∫Áä∂ÊÄÅ */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
        }

        .empty-desc {
            font-size: 14px;
            line-height: 1.6;
        }

        /* Âä†ËΩΩÁä∂ÊÄÅ */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--glass-border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: loading-spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes loading-spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* PWA ÂÆâË£ÖÊèêÁ§∫ */
        .install-prompt {
            position: fixed;
            bottom: calc(200px + var(--safe-bottom));
            left: 16px;
            right: 16px;
            z-index: 150;
            background: var(--card);
            border-radius: 16px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            animation: slide-up 0.4s ease;
        }

        @keyframes slide-up {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
        }

        /* Êé®ËçêÊ†áÁ≠æÊ†∑Âºè */
        .recommendation-tag {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: var(--text);
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .recommendation-tag:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .install-icon {
            font-size: 32px;
        }

        .install-text {
            flex: 1;
        }

        .install-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .install-desc {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .install-btn {
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 20px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
        }

        .install-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--glass);
            border: none;
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Êî∂ËóèÊåâÈíÆÊ†∑Âºè */
        .favorite-btn {
            font-size: 22px;
            transition: all 0.3s ease;
            border: none;
            box-shadow: none !important;
        }

        .ctrl-btn.favorite-btn:hover,
        .favorite-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            box-shadow: none !important;
            transform: scale(1.1);
        }

        .favorite-btn.favorited {
            color: #ff6b6b;
            animation: heartBeat 0.3s ease;
        }

        /* Ensure favorite button maintains consistent styling in all states */
        .ctrl-btn.favorite-btn {
            box-shadow: none !important;
        }

        /* More specific rules to override default hover behavior */
        .ctrl-btn.favorite-btn:hover {
            background: rgba(255, 255, 255, 0.1) !important;
            border-color: rgba(255, 255, 255, 0.1) !important;
            box-shadow: none !important;
        }

        .ctrl-btn.favorite-btn.favorited:hover {
            background: rgba(255, 255, 255, 0.1) !important;
            border-color: rgba(255, 255, 255, 0.1) !important;
            box-shadow: none !important;
        }

        @keyframes heartBeat {

            0%,
            100% {
                transform: scale(1);
            }

            25% {
                transform: scale(1.3);
            }

            50% {
                transform: scale(1.1);
            }

            75% {
                transform: scale(1.2);
            }
        }

        /* Êî∂ËóèÂíåÂéÜÂè≤ÂºπÁ™ó */
        .collection-modal {
            position: fixed;
            inset: 0;
            z-index: 200;
            background: var(--bg);
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .collection-modal.show {
            transform: translateY(0);
        }

        .collection-header {
            position: sticky;
            top: 0;
            padding: calc(20px + var(--safe-top)) 24px 20px;
            background: linear-gradient(to bottom, var(--bg) 0%, rgba(10, 10, 10, 0.95) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--glass-border);
        }

        .collection-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text);
        }

        .collection-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn-action {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: var(--text);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .btn-action:hover {
            background: var(--glass-border);
            transform: scale(1.1);
        }

        .btn-action:active {
            transform: scale(0.95);
        }

        .collection-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--glass);
            border: none;
            color: var(--text);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .collection-close:hover {
            background: var(--accent);
            color: white;
        }

        .collection-content {
            flex: 1;
            padding: 24px;
            padding-bottom: calc(24px + var(--safe-bottom));
        }

        .collection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
        }

        .collection-item {
            background: var(--card);
            border-radius: 12px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            position: relative;
        }

        .collection-item:hover {
            background: var(--card-hover);
            transform: translateY(-4px);
            border-color: var(--glass-border);
        }

        .collection-item-cover {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 12px;
            object-fit: cover;
            background: #222;
            margin-bottom: 8px;
        }

        .collection-item-title {
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }

        .collection-item-artist {
            font-size: 11px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .collection-item-time {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .collection-item-remove {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(255, 107, 107, 0.9);
            color: white;
            border: none;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .collection-item:hover .collection-item-remove {
            opacity: 1;
        }

        /* ÂìçÂ∫îÂºè */
        @media (max-width: 767px) {
            .grid {
                /* ‰ΩøÁî® minmax(0, 1fr) Âº∫Âà∂‰∏§ÂàóÂπ≥ÂàÜÔºåÈò≤Ê≠¢Ë¢´ÂÜÖÂÆπÊíëÂ§ß */
                grid-template-columns: repeat(2, minmax(0, 1fr));
                gap: 10px;
            }

            .song-card {
                padding: 6px;
                /* Á°Æ‰øùÂç°Áâá‰∏ç‰ºöË∂ÖÂá∫ÁΩëÊ†ºÂçïÂÖÉ */
                width: 100%;
                min-width: 0;
            }

            /* Á°Æ‰øùÂÜÖÂÆπÂå∫Â∑¶Âè≥ËæπË∑ùÈÄÇ‰∏≠ */
            .content {
                padding-left: 12px;
                padding-right: 12px;
            }
        }

        @media (min-width: 768px) {
            .grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }

            .player-card {
                max-width: 600px;
                margin: 0 auto;
            }
        }
    </style>
</head>

<body>
    <!-- ËÉåÊôØ -->
    <div class="bg-gradient"></div>
    <div class="bg-album" id="bg-album"></div>

    <!-- È°∂ÈÉ®ÊêúÁ¥¢ -->
    <header class="header">
        <div class="search-box">
            <div class="search-input-container">
                <input type="text" class="search-input" id="search-input" placeholder="Ê≠åÊâã/Ê≠åÊõ≤...">
                <button class="search-clear-btn" id="search-clear-btn" title="Ê∏ÖÁ©∫ÊêúÁ¥¢" style="display: none;">‚úï</button>
            </div>
            <button class="btn btn-icon" onclick="searchMusic()" title="ÊêúÁ¥¢">üîç</button>
            <button class="btn btn-icon" onclick="smartRandomSearch()" title="Êô∫ËÉΩÊé¢Á¥¢">üé≤</button>
            <button class="btn btn-icon" onclick="searchByWeather()" title="ÁúãÂ§©Âê¨Ê≠å">üå§Ô∏è</button>
            <button class="btn btn-icon" onclick="openHistory()" title="Êí≠ÊîæÂéÜÂè≤">üìñ</button>
            <button class="btn btn-icon" onclick="openFavorites()" title="ÊàëÁöÑÊî∂Ëóè">‚ù§Ô∏è</button>
        </div>
    </header>

    <!-- ÂÜÖÂÆπÂå∫ -->
    <main class="content">
        <div class="grid" id="results">
            <div class="empty-state" style="grid-column: 1/-1;">
                <div class="empty-icon">üéß</div>
                <div class="empty-title">ÂèëÁé∞Èü≥‰πê</div>
                <div class="empty-desc">ÁÇπÂáª üé≤ ÈöèÊú∫Êé¢Á¥¢ÔºåÊàñÊêúÁ¥¢‰Ω†ÂñúÊ¨¢ÁöÑÊ≠åÊõ≤</div>
            </div>
        </div>
    </main>

    <!-- ÂºπÂπï -->
    <div class="danmaku" id="danmaku"></div>

    <!-- Â∫ïÈÉ®Êí≠ÊîæÂô® -->
    <div class="player">
        <div class="player-card">
            <!-- È°∂ÈÉ®Ê≠åÊõ≤‰ø°ÊÅØÊ†è -->
            <div class="player-info-bar">
                <span class="player-label">Ê≠£Âú®Êí≠ÊîæÔºö</span>
                <div class="player-text-wrapper title-wrapper">
                    <span class="player-title-text" id="player-title-text">ÂπøÂ±±Èü≥‰πê</span>
                </div>
                <span class="player-separator">-</span>
                <div class="player-text-wrapper artist-wrapper">
                    <span class="player-artist-text" id="player-artist-text">Á≠âÂæÖÊí≠Êîæ</span>
                </div>
                <button class="player-wiki-btn" id="player-tag-btn" title="Êü•ÁúãÊ≠åÊõ≤Ê†áÁ≠æÊé®Ëçê"
                    style="display: none; margin-right: 8px;">üè∑Ô∏è</button>
                <button class="player-wiki-btn" id="player-wiki-btn" title="Êü•ÁúãËâ∫ÊúØÂÆ∂Áª¥Âü∫ÁôæÁßë"
                    style="display: none;">üìñ</button>
            </div>

            <!-- ‰∏ªÊéßÂà∂Âå∫ -->
            <div class="player-main">
                <img class="player-cover" id="player-cover"
                    src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%23222' width='100' height='100'/%3E%3Ccircle cx='50' cy='50' r='30' fill='none' stroke='%23333' stroke-width='2'/%3E%3Ccircle cx='50' cy='50' r='10' fill='%23333'/%3E%3C/svg%3E"
                    alt="Cover">
                <button class="ctrl-btn favorite-btn" id="favorite-btn" onclick="toggleFavorite()"
                    title="Êî∂Ëóè">ü§ç</button>
                <div class="player-controls">
                    <button class="ctrl-btn" id="mode-btn" onclick="togglePlayMode()" title="ÂàóË°®Âæ™ÁéØ">üîÅ</button>
                    <button class="ctrl-btn" onclick="playPrevious()">‚èÆ</button>
                    <button class="ctrl-btn play" id="play-btn" onclick="togglePlay()">‚ñ∂</button>
                    <button class="ctrl-btn" onclick="playNext()">‚è≠</button>
                </div>
            </div>

            <!-- ËøõÂ∫¶Êù° -->
            <div class="progress-container">
                <span class="time" id="current-time">0:00</span>
                <div class="progress-bar" id="progress-bar" onclick="seek(event)">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <span class="time" id="total-time">0:30</span>
            </div>

            <!-- Êé®ËçêÊ†áÁ≠æÂå∫ -->
            <div class="recommendation-tags" id="recommendation-tags" style="margin-top: 12px; display: none;">
                <div class="player-label" style="margin-bottom: 6px;">Áõ∏ÂÖ≥Êé®ËçêÔºö</div>
                <div class="recommendation-tags-container" id="recommendation-tags-container"
                    style="display: flex; flex-wrap: wrap; gap: 6px; max-height: 40px; overflow-y: auto;"></div>
                <div class="show-more-recommendations" id="show-more-recommendations"
                    style="margin-top: 6px; color: var(--primary); font-size: 12px; cursor: pointer; display: none;">
                    Â±ïÂºÄÊõ¥Â§öÊé®Ëçê</div>
            </div>
        </div>
    </div>

    <!-- Ê≠åËØçËØ¶ÊÉÖ -->
    <div class="lyrics-modal" id="lyrics-modal">
        <div class="lyrics-header">
            <button class="lyrics-close" onclick="closeLyrics()">‚úï</button>
        </div>
        <img class="lyrics-cover" id="lyrics-cover" src="" alt="">
        <h2 class="lyrics-title" id="lyrics-title"></h2>
        <div class="lyrics-artist-container">
            <p class="lyrics-artist clickable" id="lyrics-artist" style="cursor: pointer; text-decoration: underline;"
                title="ÁÇπÂáªËÆøÈóÆÁª¥Âü∫ÁôæÁßë"></p>
        </div>
        <div class="lyrics-wiki" id="lyrics-wiki">
            <div class="lyrics-wiki-title" id="wiki-title"></div>
            <div class="lyrics-wiki-text" id="wiki-text"></div>
        </div>
        <div class="lyrics-text" id="lyrics-text">Âä†ËΩΩ‰∏≠...</div>
    </div>

    <!-- ÂéÜÂè≤ËÆ∞ÂΩïÂºπÁ™ó -->
    <div class="collection-modal" id="history-modal">
        <div class="collection-header">
            <h2 class="collection-title">üìñ Êí≠ÊîæÂéÜÂè≤</h2>
            <div class="collection-actions">
                <button class="btn-action" onclick="exportHistory()" title="ÂØºÂá∫ÂéÜÂè≤">üì§</button>
                <button class="btn-action" onclick="importHistory()" title="ÂØºÂÖ•ÂéÜÂè≤">üì•</button>
                <button class="btn-action" onclick="clearHistory()" title="Ê∏ÖÁ©∫ÂéÜÂè≤">üóëÔ∏è</button>
                <button class="collection-close" onclick="closeHistory()">‚úï</button>
            </div>
        </div>
        <div class="collection-content" id="history-content">
            <div class="empty-state">
                <div class="empty-icon">üìñ</div>
                <div class="empty-title">ÊöÇÊó†Êí≠ÊîæÂéÜÂè≤</div>
                <div class="empty-desc">ÂºÄÂßãÊí≠ÊîæÈü≥‰πêÂêé‰ºöËá™Âä®ËÆ∞ÂΩï</div>
            </div>
        </div>
    </div>

    <!-- Êî∂ËóèÂàóË°®ÂºπÁ™ó -->
    <div class="collection-modal" id="favorites-modal">
        <div class="collection-header">
            <h2 class="collection-title">‚ù§Ô∏è ÊàëÁöÑÊî∂Ëóè</h2>
            <div class="collection-actions">
                <button class="btn-action" onclick="exportFavorites()" title="ÂØºÂá∫Êî∂Ëóè">üì§</button>
                <button class="btn-action" onclick="importFavorites()" title="ÂØºÂÖ•Êî∂Ëóè">üì•</button>
                <button class="btn-action" onclick="clearFavorites()" title="Ê∏ÖÁ©∫Êî∂Ëóè">üóëÔ∏è</button>
                <button class="collection-close" onclick="closeFavorites()">‚úï</button>
            </div>
        </div>
        <div class="collection-content" id="favorites-content">
            <div class="empty-state">
                <div class="empty-icon">‚ù§Ô∏è</div>
                <div class="empty-title">ÊöÇÊó†Êî∂Ëóè</div>
                <div class="empty-desc">ÁÇπÂáªÊí≠ÊîæÂô®‰∏≠ÁöÑÁà±ÂøÉÊåâÈíÆÊî∂ËóèÊ≠åÊõ≤</div>
            </div>
        </div>
    </div>

    <!-- ÈöêËóèÁöÑÊñá‰ª∂ËæìÂÖ•Ê°Ü -->
    <input type="file" id="import-file-input" accept=".json" style="display: none;">

    <audio id="audio" crossorigin="anonymous"></audio>

    <!-- YouTube Iframe API -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // Áä∂ÊÄÅÁÆ°ÁêÜ
        const state = {
            currentTrack: null,
            playlist: [],
            currentIndex: -1,
            isPlaying: false,
            playMode: 'sequence', // sequence, random, single
            danmakuInterval: null,
            danmakuCache: [],
            tracks: [false, false, false, false, false],
            displayedDanmaku: new Set(),  // Track currently displayed danmaku content to prevent duplicates
            youtubePlayer: null,  // YouTube player instance
            isYouTubePlaying: false,  // Track if YouTube player is currently playing
            youtubeProgressInterval: null,  // Interval for YouTube progress updates
            lastPosition: 0  // Store last playback position when app goes to background
        };

        // ÁºìÂ≠òÁ≥ªÁªü
        const CacheManager = {
            // Ëé∑ÂèñÁºìÂ≠òÁöÑÊï∞ÊçÆ
            get: (key) => {
                try {
                    const cached = localStorage.getItem(key);
                    if (!cached) return null;

                    const parsed = JSON.parse(cached);
                    const now = Date.now();

                    // Ê£ÄÊü•ÊòØÂê¶ËøáÊúü
                    if (parsed.expiry && now > parsed.expiry) {
                        localStorage.removeItem(key);
                        return null;
                    }

                    return parsed.data;
                } catch (e) {
                    console.warn('Cache get error:', e);
                    return null;
                }
            },

            // ËÆæÁΩÆÁºìÂ≠òÊï∞ÊçÆ
            set: (key, data, expiryHours = 24) => {
                try {
                    const expiry = Date.now() + (expiryHours * 60 * 60 * 1000);
                    const cacheObj = {
                        data: data,
                        expiry: expiry
                    };
                    localStorage.setItem(key, JSON.stringify(cacheObj));
                } catch (e) {
                    console.warn('Cache set error:', e);
                }
            },

            // Âà†Èô§ÁºìÂ≠òÊï∞ÊçÆ
            remove: (key) => {
                try {
                    localStorage.removeItem(key);
                } catch (e) {
                    console.warn('Cache remove error:', e);
                }
            }
        };

        // Êî∂ËóèÁÆ°ÁêÜÂô®
        const FavoritesManager = {
            STORAGE_KEY: 'music_favorites',

            // Ëé∑ÂèñÊâÄÊúâÊî∂Ëóè
            getAll: () => {
                try {
                    const data = localStorage.getItem(FavoritesManager.STORAGE_KEY);
                    return data ? JSON.parse(data) : [];
                } catch (e) {
                    console.error('Failed to get favorites:', e);
                    return [];
                }
            },

            // ‰øùÂ≠òÊî∂Ëóè
            save: (favorites) => {
                try {
                    localStorage.setItem(FavoritesManager.STORAGE_KEY, JSON.stringify(favorites));
                } catch (e) {
                    console.error('Failed to save favorites:', e);
                }
            },

            // Ê∑ªÂä†Êî∂Ëóè
            add: (song) => {
                const favorites = FavoritesManager.getAll();
                const exists = favorites.some(f => f.trackId === song.trackId);
                if (!exists) {
                    favorites.unshift({
                        ...song,
                        favoritedAt: Date.now()
                    });
                    FavoritesManager.save(favorites);
                    return true;
                }
                return false;
            },

            // ÁßªÈô§Êî∂Ëóè
            remove: (trackId) => {
                const favorites = FavoritesManager.getAll();
                const filtered = favorites.filter(f => f.trackId !== trackId);
                FavoritesManager.save(filtered);
            },

            // Ê£ÄÊü•ÊòØÂê¶Â∑≤Êî∂Ëóè
            isFavorited: (trackId) => {
                const favorites = FavoritesManager.getAll();
                return favorites.some(f => f.trackId === trackId);
            },

            // Ê∏ÖÁ©∫Êî∂Ëóè
            clear: () => {
                FavoritesManager.save([]);
            },

            // ÂØºÂá∫Êî∂Ëóè
            export: () => {
                const favorites = FavoritesManager.getAll();
                const dataStr = JSON.stringify(favorites, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `music-favorites-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            },

            // ÂØºÂÖ•Êî∂Ëóè
            import: (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (Array.isArray(data)) {
                                FavoritesManager.save(data);
                                resolve(data.length);
                            } else {
                                reject(new Error('Invalid format'));
                            }
                        } catch (err) {
                            reject(err);
                        }
                    };
                    reader.onerror = reject;
                    reader.readAsText(file);
                });
            }
        };

        // ÂéÜÂè≤ËÆ∞ÂΩïÁÆ°ÁêÜÂô®
        const HistoryManager = {
            STORAGE_KEY: 'music_history',
            MAX_ITEMS: 100,

            // Ëé∑ÂèñÊâÄÊúâÂéÜÂè≤
            getAll: () => {
                try {
                    const data = localStorage.getItem(HistoryManager.STORAGE_KEY);
                    return data ? JSON.parse(data) : [];
                } catch (e) {
                    console.error('Failed to get history:', e);
                    return [];
                }
            },

            // ‰øùÂ≠òÂéÜÂè≤
            save: (history) => {
                try {
                    localStorage.setItem(HistoryManager.STORAGE_KEY, JSON.stringify(history));
                } catch (e) {
                    console.error('Failed to save history:', e);
                }
            },

            // Ê∑ªÂä†ÂéÜÂè≤ËÆ∞ÂΩï
            add: (song) => {
                let history = HistoryManager.getAll();
                // ÁßªÈô§ÈáçÂ§çÈ°π
                history = history.filter(h => h.trackId !== song.trackId);
                // Ê∑ªÂä†Âà∞ÂºÄÂ§¥
                history.unshift({
                    ...song,
                    playedAt: Date.now()
                });
                // ÈôêÂà∂Êï∞Èáè
                if (history.length > HistoryManager.MAX_ITEMS) {
                    history = history.slice(0, HistoryManager.MAX_ITEMS);
                }
                HistoryManager.save(history);
            },

            // ÁßªÈô§ÂéÜÂè≤ËÆ∞ÂΩï
            remove: (trackId) => {
                const history = HistoryManager.getAll();
                const filtered = history.filter(h => h.trackId !== trackId);
                HistoryManager.save(filtered);
            },

            // Ê∏ÖÁ©∫ÂéÜÂè≤
            clear: () => {
                HistoryManager.save([]);
            },

            // ÂØºÂá∫ÂéÜÂè≤
            export: () => {
                const history = HistoryManager.getAll();
                const dataStr = JSON.stringify(history, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `music-history-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            },

            // ÂØºÂÖ•ÂéÜÂè≤
            import: (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (Array.isArray(data)) {
                                HistoryManager.save(data);
                                resolve(data.length);
                            } else {
                                reject(new Error('Invalid format'));
                            }
                        } catch (err) {
                            reject(err);
                        }
                    };
                    reader.onerror = reject;
                    reader.readAsText(file);
                });
            }
        };

        // ÁîüÊàêÁºìÂ≠òÈîÆ
        const generateCacheKey = (artist, title) => {
            return `song_${encodeURIComponent(artist)}_${encodeURIComponent(title)}`;
        };

        // DOM ÂÖÉÁ¥†
        const $ = id => document.getElementById(id);
        const audio = $('audio');

        // Â±ÇÊ¨°ÂåñÈü≥‰πêÊ†áÁ≠æÁ≥ªÁªü
        const musicTags = {
            // ‰∏ÄÁ∫ßÂàÜÁ±ªÔºöÈü≥‰πêÂ±ûÊÄß
            attributes: {
                // ‰∫åÁ∫ßÂàÜÁ±ªÔºöÊÉÖÁª™‰∏éÊ∞õÂõ¥ (Vibes & Moods)
                moods: {
                    positive: ["Happy", "Joy", "Cheerful", "Uplifting", "Energetic", "Upbeat", "Euphoria", "Peaceful", "Calm", "Serene", "Chill", "Relax", "Cozy", "Mellow", "Groovy", "Cool", "Fresh"],
                    romantic: ["Love", "Romantic", "Heart", "Kiss", "Miss", "Baby", "Intimate", "Affection", "Passion", "Sensual", "Sexy"],
                    melancholy: ["Sad", "Melancholy", "Nostalgia", "Sentimental", "Blue", "Tears", "Lonely", "Gloomy", "Melancholic", "Heartbreak"],
                    intense: ["Drama", "Intense", "Power", "Epic", "Cinematic", "Dark", "Mystery", "Mysterious", "Heavy", "Spooky", "Creepy", "Mysterious", "Supernatural"],
                    spiritual: ["Faith", "Believe", "Angels", "Heaven", "Paradise", "Divine", "Sacred", "Spiritual", "Transcendent", "Soulful"]
                },
                // ‰∫åÁ∫ßÂàÜÁ±ªÔºöÈü≥‰πêÈ£éÊ†º (Stylistic Elements)
                styles: {
                    sonic: ["Acoustic", "Electric", "Instrumental", "Acapella", "Live", "Studio", "Remix", "Cover", "Original"],
                    aesthetic: ["Vintage", "Retro", "Classic", "Modern", "Futuristic", "Cyberpunk", "Aesthetic", "Pastel", "Neon", "Funky"]
                }
            },
            // ‰∏ÄÁ∫ßÂàÜÁ±ªÔºöÈü≥‰πêÁ±ªÂûã
            genres: {
                // ‰∫åÁ∫ßÂàÜÁ±ªÔºö‰∏ªË¶ÅÊµÅÊ¥æ (Main Genres)
                main: {
                    pop: ["Pop", "Mandopop", "Cantopop", "K-Pop", "J-Pop", "Jazz", "Soul", "R&B"],
                    rock: ["Rock", "Alternative", "Indie", "Punk", "Grunge", "Emo", "Metal", "Heavy Metal"],
                    electronic: ["EDM", "House", "Techno", "Trance", "Dubstep", "Drum and Bass", "Garage", "Ambient"],
                    hip_hop: ["Hip Hop", "Rap", "Trap", "R&B"],
                    traditional: ["Country", "Folk", "Classical", "Opera", "Blues"],
                    world: ["Latin", "Reggae", "Dancehall", "Salsa", "Bachata", "Reggaeton", "Anime", "Ghibli"]
                },
                // ‰∏âÁ∫ßÂàÜÁ±ªÔºöË°çÁîüÊµÅÊ¥æ (Sub-Genres)
                sub_genres: {
                    pop_sub: ["Synthpop", "Electropop", "Dance-pop", "Indie Pop", "Art Pop"],
                    rock_sub: ["Glam Rock", "Progressive Rock", "Punk Rock", "Hard Rock", "Grunge Rock", "Alternative Rock"],
                    electronic_sub: ["Lo-Fi", "Lofi Hip Hop", "Synthwave", "Vaporwave", "Retrowave", "Deep House", "Future Bass"],
                    hip_hop_sub: ["Old School Hip Hop", "Trap", "Drill", "Conscious Rap", "Mumble Rap"],
                    traditional_sub: ["Bluegrass", "Folk Rock", "Baroque", "Chamber Music", "Contemporary Classical"]
                }
            },
            // ‰∏ÄÁ∫ßÂàÜÁ±ªÔºöÂú∫ÊôØÊ¥ªÂä®
            scenarios: {
                // ‰∫åÁ∫ßÂàÜÁ±ªÔºöÊó∂Èó¥Âú∫ÊôØ (Time-based)
                time_based: {
                    daily_routine: ["Morning", "Wake Up", "Afternoon", "Evening", "Late Night", "Midnight", "Sunrise", "Sunset"],
                    weekly: ["Weekend", "Friday", "Sunday", "Monday", "Workday"],
                    seasonal: ["Spring", "Summer", "Autumn", "Winter", "Holiday", "New Year", "Valentine", "Christmas", "Halloween"],
                    special_occasions: ["Birthday", "Wedding", "Graduation", "Travel", "Vacation", "Beach", "Camping", "Festival"]
                },
                // ‰∫åÁ∫ßÂàÜÁ±ªÔºöÊ¥ªÂä®Âú∫ÊôØ (Activity-based)
                activity_based: {
                    exercise: ["Workout", "Gym", "Running", "Jogging", "Yoga", "Meditation", "Stretching"],
                    work_study: ["Study", "Coding", "Reading", "Focus", "Background", "Concentration", "Deep Work"],
                    travel: ["Driving", "Road Trip", "Car Music", "Commuting", "Long Drive"],
                    social: ["Party", "Club", "Bar", "Lounge", "Dinner", "Cooking", "Cleaning"],
                    relaxation: ["Sleep", "Meditation", "Spa", "Shower", "Bath", "Coffee Shop", "Cafe"]
                }
            },
            // ‰∏ÄÁ∫ßÂàÜÁ±ªÔºöÊñáÂåñÂÖÉÁ¥†
            culture: {
                // ‰∫åÁ∫ßÂàÜÁ±ªÔºöÂú∞ÂüüÊñáÂåñ (Regional Culture)
                regional: {
                    western: ["American", "British", "European", "African", "Caribbean"],
                    asian: ["Chinese", "Korean", "Japanese", "Taiwanese", "Hong Kong", "Southeast Asian"],
                    latin: ["Latin America", "Brazil", "Mexico", "Caribbean"]
                },
                // ‰∫åÁ∫ßÂàÜÁ±ªÔºöËâ∫ÊúØÂÆ∂‰∏é‰ΩúÂìÅ (Artists & Works)
                artists: {
                    western_mainstream: [
                        "Taylor Swift", "Ed Sheeran", "Ariana Grande", "Justin Bieber", "The Weeknd", "Dua Lipa",
                        "Billie Eilish", "Harry Styles", "Bruno Mars", "Adele", "Rihanna", "Beyonce", "Lady Gaga",
                        "Katy Perry", "Miley Cyrus", "Post Malone", "Coldplay", "Imagine Dragons", "OneRepublic",
                        "Drake", "Kendrick Lamar", "Eminem", "Jay-Z", "Travis Scott", "Kanye West", "J. Cole",
                        "Beatles", "Queen", "Pink Floyd", "Led Zeppelin", "AC/DC", "Red Hot Chili Peppers",
                        "Linkin Park", "Arctic Monkeys", "Tame Impala", "Oasis", "David Bowie", "Prince",
                        "Elton John", "Bob Dylan", "Beyonc√©", "Alicia Keys", "John Legend"
                    ],
                    korean: ["BTS", "Blackpink", "Twice", "EXO", "Big Bang", "NewJeans", "Stray Kids", "IU", "SEVENTEEN"],
                    chinese: ["Âë®Êù∞‰º¶", "Êûó‰øäÊù∞", "ÈôàÂ•ïËøÖ", "ÁéãÂäõÂÆè", "Èô∂ÂñÜ", "Ëî°‰æùÊûó", "Â≠ôÁáïÂßø", "Ê¢ÅÈùôËåπ", "‰∫îÊúàÂ§©",
                        "Beyond", "ÈÇì‰∏ΩÂêõ", "Âº†ÂõΩËç£", "ÁéãËè≤", "Âº†Â≠¶Âèã", "ÂàòÂæ∑Âçé", "ÈªéÊòé", "ÈÉ≠ÂØåÂüé", "ÁΩóÂ§ß‰Ωë",
                        "ÊùéÂÆóÁõõ", "Â¥îÂÅ•", "Á™¶ÂîØ", "‰ºç‰Ω∞", "Âº†Èõ®Áîü", "ÈÇìÁ¥´Ê£ã", "ÊùéËç£Êµ©", "Ëñõ‰πãË∞¶", "Âë®Ê∑±",
                        "ÊØõ‰∏çÊòì", "ÂçéÊô®ÂÆá", "Âº†Êù∞", "ËÆ∏Âµ©", "Âëä‰∫î‰∫∫", "Áóõ‰ª∞", "ÈôàÁ≤í", "ËµµÈõ∑"],
                    japanese: ["ÂÆâÂÆ§Â•àÁæéÊÅµ", "ÂÆáÂ§öÁî∞„Éí„Ç´„É´", "Á±≥Ê¥•ÁéÑÂ∏´", "RADWIMPS", "YOASOBI"],
                    instrumental: ["Hans Zimmer", "John Williams", "Joe Hisaishi", "Ennio Morricone", "Ludwig G√∂ransson"]
                },
                // ‰∫åÁ∫ßÂàÜÁ±ªÔºöÂΩ±ËßÜÊñáÂåñ (Media Culture)
                media: {
                    franchises: ["Marvel", "DC", "Star Wars", "Harry Potter", "Lord of the Rings", "Game of the Thrones"],
                    shows: ["Stranger Things", "Friends", "Simpsons", "Breaking Bad", "The Office"],
                    games: ["Cyberpunk 2077", "GTA", "FIFA", "Mario", "Zelda", "Pokemon", "Fortnite"],
                    other: ["Disney", "Musical", "Broadway", "Anime OST", "Video Game Music"]
                }
            },
            // ‰∏ÄÁ∫ßÂàÜÁ±ªÔºöËá™ÁÑ∂‰∏éÊäΩË±°
            nature_abstract: {
                // ‰∫åÁ∫ßÂàÜÁ±ªÔºöËá™ÁÑ∂ÂÖÉÁ¥† (Natural Elements)
                nature: {
                    weather: ["Rain", "Storm", "Thunder", "Snow", "Wind", "Sun", "Moon", "Stars"],
                    landscapes: ["Ocean", "Sea", "River", "Forest", "Jungle", "Mountain", "Desert"],
                    locations: ["California", "New York", "London", "Paris", "Tokyo", "Seoul", "Hong Kong", "Shanghai", "Miami", "Ibiza", "Hawaii", "Space", "Galaxy", "Universe", "City", "Street", "Highway"]
                },
                // ‰∫åÁ∫ßÂàÜÁ±ªÔºöÊäΩË±°Ê¶ÇÂøµ (Abstract Concepts)
                abstract: {
                    transcendental: ["Dream", "Night", "Fire", "Gold", "Wild", "Free", "Magic", "Legend", "Hero", "Angel", "Devil", "King", "Queen", "Life", "Time", "Eternity"],
                    emotions: ["Hope", "Smile", "Believe", "Together", "Alone", "Lost", "Forever", "Secret", "Promise"]
                }
            }
        };

        // ‰ªéÂ±ÇÊ¨°ÂåñÊ†áÁ≠æÁ≥ªÁªü‰∏≠ÊèêÂèñÊâÄÊúâÊ†áÁ≠æËØçÔºåÁî®‰∫éÈöèÊú∫ÊêúÁ¥¢
        function getAllKeywords() {
            const keywords = [];

            function collectKeywords(obj) {
                for (const key in obj) {
                    if (Array.isArray(obj[key])) {
                        // ÂÖàÊ£ÄÊü•ÊòØÂê¶‰∏∫Êï∞ÁªÑ
                        obj[key].forEach(item => keywords.push(item));
                    } else if (typeof obj[key] === 'object' && obj[key] !== null) {
                        // ÂÜçÊ£ÄÊü•ÊòØÂê¶‰∏∫ÂØπË±°ÔºàÊéíÈô§nullÔºâ
                        collectKeywords(obj[key]);
                    }
                }
            }

            collectKeywords(musicTags);
            return keywords;
        }

        // Ëé∑ÂèñÊ†áÁ≠æÊé®Ëçê
        function getRecommendationsByTag(tag, limit = 20) {
            const recommendations = [];

            function findRelatedTags(obj, currentPath = []) {
                for (const key in obj) {
                    if (typeof obj[key] === 'object' && !Array.isArray(obj[key])) {
                        findRelatedTags(obj[key], [...currentPath, key]);
                    } else if (Array.isArray(obj[key])) {
                        // Ê£ÄÊü•ÂΩìÂâçÊ†áÁ≠æÊòØÂê¶Âú®Êï∞ÁªÑ‰∏≠
                        if (obj[key].includes(tag)) {
                            // Ê∑ªÂä†ÂêåÁ∫ßÁöÑÂÖ∂‰ªñÊ†áÁ≠æ
                            obj[key].forEach(item => {
                                if (item !== tag && !recommendations.includes(item)) {
                                    recommendations.push(item);
                                }
                            });

                            // Ê∑ªÂä†ÂêåÁªÑÁöÑÂÖ∂‰ªñÊ†áÁ≠æÔºàÂ¶ÇÊûúÊúâÔºâ
                            if (currentPath.length > 0) {
                                const parentPath = currentPath.slice(0, -1);
                                const parentObj = getParentObject(musicTags, parentPath);

                                for (const parentKey in parentObj) {
                                    if (Array.isArray(parentObj[parentKey]) && parentObj[parentKey] !== obj[key]) {
                                        parentObj[parentKey].forEach(item => {
                                            if (!recommendations.includes(item)) {
                                                recommendations.push(item);
                                            }
                                        });
                                    }
                                }
                            }
                        }
                    }
                }
            }

            function getParentObject(obj, path) {
                let current = obj;
                for (const key of path) {
                    current = current[key];
                }
                return current;
            }

            findRelatedTags(musicTags);

            // Âè™ËøîÂõûÊåáÂÆöÊï∞ÈáèÁöÑÊé®Ëçê
            return recommendations.slice(0, limit);
        }

        // Ëé∑ÂèñÊ†áÁ≠æÁöÑÂ±ÇÊ¨°‰ø°ÊÅØ
        function getTagHierarchy(tag) {
            const hierarchy = [];

            function findTag(obj, currentPath = []) {
                for (const key in obj) {
                    if (typeof obj[key] === 'object' && !Array.isArray(obj[key])) {
                        if (findTag(obj[key], [...currentPath, key])) {
                            return true;
                        }
                    } else if (Array.isArray(obj[key])) {
                        if (obj[key].includes(tag)) {
                            hierarchy.push(...currentPath, key);
                            return true;
                        }
                    }
                }
                return false;
            }

            findTag(musicTags);
            return hierarchy;
        }

        // Ëé∑ÂèñÂΩìÂâçÊí≠ÊîæÊ≠åÊõ≤ÁöÑÁõ∏ÂÖ≥Ê†áÁ≠æÊé®Ëçê
        function getSongRecommendations(song) {
            // Ê£ÄÊü•Ê≠åÊõ≤ÂØπË±°ÊòØÂê¶ÊúâÊïà
            if (!song || !song.artistName || !song.trackName) {
                return [];
            }

            // Á°Æ‰øùÂ≠óÁ¨¶‰∏≤Â±ûÊÄßÂ≠òÂú®‰∏î‰∏ç‰∏∫Á©∫
            const artistName = song.artistName || '';
            const trackName = song.trackName || '';

            // Âü∫‰∫éËâ∫ÊúØÂÆ∂ÁöÑÊé®Ëçê
            const artistRecommendations = [];
            for (const category in musicTags.culture.artists) {
                if (musicTags.culture.artists[category].includes(artistName)) {
                    // Ê∑ªÂä†ÂêåÁ±ªÂûãËâ∫ÊúØÂÆ∂
                    musicTags.culture.artists[category].forEach(artist => {
                        if (artist !== artistName && !artistRecommendations.includes(artist)) {
                            artistRecommendations.push(artist);
                        }
                    });
                }
            }

            // Âü∫‰∫éÊµÅÊ¥æÁöÑÊé®Ëçê
            const genreRecommendations = [];
            for (const category in musicTags.genres.main) {
                if (musicTags.genres.main[category].some(genre =>
                    trackName.toLowerCase().includes(genre.toLowerCase()) ||
                    artistName.toLowerCase().includes(genre.toLowerCase()))) {
                    // Ê∑ªÂä†ÂêåÁ±ªÊµÅÊ¥æ
                    musicTags.genres.main[category].forEach(genre => {
                        if (!genreRecommendations.includes(genre) &&
                            !artistRecommendations.includes(genre)) {
                            genreRecommendations.push(genre);
                        }
                    });

                    // Ê∑ªÂä†Â≠êÊµÅÊ¥æ
                    if (musicTags.genres.sub_genres[`${category}_sub`]) {
                        musicTags.genres.sub_genres[`${category}_sub`].forEach(subGenre => {
                            if (!genreRecommendations.includes(subGenre)) {
                                genreRecommendations.push(subGenre);
                            }
                        });
                    }
                }
            }

            // ÂêàÂπ∂ÊâÄÊúâÊé®ËçêÂπ∂ÈôêÂà∂Êï∞Èáè
            const allRecommendations = [...artistRecommendations, ...genreRecommendations];
            return [...new Set(allRecommendations)].slice(0, 10);
        }

        // ‰ªéÂ±ÇÊ¨°ÂåñÊ†áÁ≠æ‰∏≠Ëé∑ÂèñÊâÄÊúâÂÖ≥ÈîÆËØç
        const keywords = getAllKeywords();

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            randomSearch();
            const searchInput = $('search-input');
            const searchClearBtn = $('search-clear-btn');
            let searchTimeout;

            searchInput.addEventListener('keypress', e => {
                if (e.key === 'Enter') {
                    clearTimeout(searchTimeout);
                    searchMusic();
                }
            });

            // Show/hide clear button based on input value and debounce search
            searchInput.addEventListener('input', () => {
                searchClearBtn.style.display = searchInput.value ? 'flex' : 'none';

                // Èò≤ÊäñÊêúÁ¥¢
                clearTimeout(searchTimeout);
                if (searchInput.value.trim()) {
                    searchTimeout = setTimeout(() => {
                        searchMusic();
                    }, 800);
                }
            });

            // Show clear button if search input already has value on load
            searchClearBtn.style.display = searchInput.value ? 'flex' : 'none';

            // Clear search input when clear button is clicked
            searchClearBtn.addEventListener('click', () => {
                clearTimeout(searchTimeout);
                searchInput.value = '';
                searchClearBtn.style.display = 'none';
                searchInput.focus();
            });

            // ÂèåÂáªÂ∞ÅÈù¢ÊâìÂºÄÊ≠åËØç
            $('player-cover').addEventListener('dblclick', openLyrics);
        });

        // ÊêúÁ¥¢Ëâ∫ÊúØÂÆ∂
        function searchByArtist(artistName) {
            const cleanArtist = artistName.split(/&|,|feat\.|ft\./i)[0].trim();
            $('search-input').value = cleanArtist;
            searchMusic();
        }

        // ÊêúÁ¥¢Ê≠åÊõ≤
        function searchBySong(songName) {
            // Remove parentheses and brackets with their contents from song name
            let cleanSongName = songName.replace(/\([^)]*\)|\[[^\]]*\]/g, '').trim();
            $('search-input').value = cleanSongName;
            searchMusic();
        }

        // ÈöèÊú∫ÊêúÁ¥¢
        function randomSearch() {
            $('search-input').value = keywords[Math.floor(Math.random() * keywords.length)];
            searchMusic();
        }

        // Êô∫ËÉΩÈöèÊú∫ÊêúÁ¥¢ - Âü∫‰∫éÊ†áÁ≠æÂ±ÇÊ¨°ÁªìÊûÑ
        function smartRandomSearch() {
            // ‰ªéÊ†áÁ≠æÁöÑÈ°∂Â±ÇÁ±ªÂà´‰∏≠ÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™
            const topLevelCategories = Object.keys(musicTags);
            if (topLevelCategories.length === 0) {
                randomSearch(); // ÂõûÈÄÄÂà∞ÊôÆÈÄöÈöèÊú∫ÊêúÁ¥¢
                return;
            }
            const randomCategory = topLevelCategories[Math.floor(Math.random() * topLevelCategories.length)];

            // ‰ªéËØ•Á±ªÂà´‰∏≠ÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™Â≠êÁ±ªÂà´
            const subCategories = Object.keys(musicTags[randomCategory]);
            if (subCategories.length === 0) {
                randomSearch(); // ÂõûÈÄÄÂà∞ÊôÆÈÄöÈöèÊú∫ÊêúÁ¥¢
                return;
            }
            const randomSubCategory = subCategories[Math.floor(Math.random() * subCategories.length)];

            // ‰ªéÂ≠êÁ±ªÂà´‰∏≠ÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™Ê†áÁ≠æ
            const tagsInSubCategory = musicTags[randomCategory][randomSubCategory];
            if (Array.isArray(tagsInSubCategory) && tagsInSubCategory.length > 0) {
                const randomTag = tagsInSubCategory[Math.floor(Math.random() * tagsInSubCategory.length)];
                if (randomTag) {  // Á°Æ‰øùÊ†áÁ≠æ‰∏ç‰∏∫undefinedÊàñnull
                    $('search-input').value = randomTag;
                    searchMusic();
                    showToast(`Êô∫ËÉΩÊé®ËçêÔºö${randomTag} (${randomCategory} > ${randomSubCategory})`);
                } else {
                    randomSearch(); // ÂõûÈÄÄÂà∞ÊôÆÈÄöÈöèÊú∫ÊêúÁ¥¢
                }
            } else {
                // Â¶ÇÊûúÂ≠êÁ±ªÂà´‰∏çÊòØÊï∞ÁªÑËÄåÊòØÊõ¥Ê∑±Â±ÇÁªìÊûÑÔºåÂàôÁªßÁª≠Ê∑±ÂÖ•
                const deeperCategories = Object.keys(musicTags[randomCategory][randomSubCategory]);
                if (deeperCategories && deeperCategories.length > 0) {
                    const randomDeeperCategory = deeperCategories[Math.floor(Math.random() * deeperCategories.length)];
                    const tagsInDeeperCategory = musicTags[randomCategory][randomSubCategory][randomDeeperCategory];
                    if (Array.isArray(tagsInDeeperCategory) && tagsInDeeperCategory.length > 0) {
                        const randomTag = tagsInDeeperCategory[Math.floor(Math.random() * tagsInDeeperCategory.length)];
                        if (randomTag) {  // Á°Æ‰øùÊ†áÁ≠æ‰∏ç‰∏∫undefinedÊàñnull
                            $('search-input').value = randomTag;
                            searchMusic();
                            showToast(`Êô∫ËÉΩÊé®ËçêÔºö${randomTag} (${randomCategory} > ${randomSubCategory} > ${randomDeeperCategory})`);
                        } else {
                            randomSearch(); // ÂõûÈÄÄÂà∞ÊôÆÈÄöÈöèÊú∫ÊêúÁ¥¢
                        }
                    } else {
                        // ÂõûÈÄÄÂà∞ÊôÆÈÄöÈöèÊú∫ÊêúÁ¥¢
                        randomSearch();
                    }
                } else {
                    // ÂõûÈÄÄÂà∞ÊôÆÈÄöÈöèÊú∫ÊêúÁ¥¢
                    randomSearch();
                }
            }
        }

        // ÊêúÁ¥¢Èü≥‰πê
        async function searchMusic() {
            const query = $('search-input').value?.trim();
            if (!query) return;

            // Â∞ùËØï‰ªéÁºìÂ≠òËé∑ÂèñÊêúÁ¥¢ÁªìÊûú
            const cacheKey = `search_${query}`;
            let cachedResults = CacheManager.get(cacheKey);

            if (cachedResults) {
                console.log('Using cached search results for:', query);
                state.playlist = cachedResults;
                renderResults(cachedResults);
                return;
            }

            $('results').innerHTML = `
                <div class="loading" style="grid-column: 1/-1;">
                    <div class="loading-spinner"></div>
                    <div>Ê≠£Âú®ÊêúÁ¥¢...</div>
                </div>
            `;

            // È¶ñÂÖàÂ∞ùËØï iTunes API
            let iTunesData = null;
            try {
                const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(query)}&entity=song&limit=24&country=cn`);
                if (res.ok) {
                    iTunesData = await res.json();
                } else {
                    console.error('iTunes API ËØ∑Ê±ÇÂ§±Ë¥•ÔºåÁä∂ÊÄÅÁ†Å:', res.status);
                    iTunesData = { results: [] };
                }
            } catch (e) {
                console.error('iTunes API ÊêúÁ¥¢Â§±Ë¥•:', e);
                iTunesData = { results: [] };
            }

            // ÂêåÊó∂ÊêúÁ¥¢ YouTube
            let youTubeData = [];
            try {
                const youTubeRes = await fetch(`https://api.yuangs.cc/youtubeapi/search/song?q=${encodeURIComponent(query)}&limit=24`);
                if (youTubeRes.ok) {
                    const youTubeJson = await youTubeRes.json();
                    console.log('YouTube API ÂìçÂ∫î:', youTubeJson); // Debug log

                    // Check if response has the expected structure
                    if (youTubeJson && youTubeJson.data) {
                        // If the API returns data in the expected format
                        youTubeData = youTubeJson.data.map(item => ({
                            // Â∞Ü YouTube Êï∞ÊçÆËΩ¨Êç¢‰∏∫ iTunes Ê†ºÂºè
                            trackId: item.video_id || item.id,
                            trackName: item.title || item.name,
                            artistName: Array.isArray(item.artists) ? item.artists.join(', ') : (item.artist || item.author || 'Unknown Artist'),
                            collectionName: item.album || 'YouTube Music',
                            artworkUrl100: item.thumbnail || item.thumbnails?.[0]?.url || item.image || 'https://i.ytimg.com/img/no_thumbnail.jpg',
                            previewUrl: `https://www.youtube.com/watch?v=${item.video_id || item.id}`,
                            kind: 'youtube',  // Ê†áËÆ∞‰∏∫ YouTube Êù•Ê∫ê
                            genre: item.category || item.genre || 'YouTube',
                            releaseDate: item.publish_date || item.publishedAt || new Date().toISOString(),
                            duration: item.duration || 'Unknown Duration'  // Ê∑ªÂä†Êó∂Èïø‰ø°ÊÅØ
                        }));
                    } else {
                        console.warn('YouTube API ÂìçÂ∫îÊ†ºÂºè‰∏çÊ≠£Á°Æ:', youTubeJson);
                    }
                } else {
                    console.error('YouTube API ËØ∑Ê±ÇÂ§±Ë¥•ÔºåÁä∂ÊÄÅÁ†Å:', youTubeRes.status);
                }
            } catch (e) {
                console.error('YouTube API ÊêúÁ¥¢Â§±Ë¥•:', e);
                // ÂèØËÉΩÊòØ CORS ÊàñÁΩëÁªúÈóÆÈ¢òÔºå‰∏ç‰∏≠Êñ≠Êï¥‰∏™ÊêúÁ¥¢ÊµÅÁ®ã
            }

            // ÂêàÂπ∂ÁªìÊûúÔºö‰ºòÂÖà‰ΩøÁî® iTunes Êï∞ÊçÆÔºåË°•ÂÖÖ YouTube Êï∞ÊçÆ
            let combinedResults = [...iTunesData.results];

            // Âè™Ê∑ªÂä†‰∏éÊêúÁ¥¢Êü•ËØ¢Áõ∏ÂÖ≥ÁöÑ YouTube ÁªìÊûú
            const youTubeResultsToAdd = youTubeData.filter(ytSong => {
                const songMatch = ytSong.trackName.toLowerCase().includes(query.toLowerCase());
                const artistMatch = ytSong.artistName.toLowerCase().includes(query.toLowerCase());
                return songMatch || artistMatch;
            });

            // ÈÅøÂÖçÈáçÂ§çÔºåÊåâÊ≠åÊõ≤ÂíåËâ∫ÊúØÂÆ∂ÂåπÈÖç
            const existingTracks = new Set();
            combinedResults.forEach(song => {
                const trackKey = `${song.trackName.toLowerCase()}-${song.artistName.toLowerCase()}`;
                existingTracks.add(trackKey);
            });

            for (const ytSong of youTubeResultsToAdd) {
                const trackKey = `${ytSong.trackName.toLowerCase()}-${ytSong.artistName.toLowerCase()}`;
                if (!existingTracks.has(trackKey)) {
                    combinedResults.push(ytSong);
                    existingTracks.add(trackKey);
                }
            }

            // ÁºìÂ≠òÊêúÁ¥¢ÁªìÊûúÔºàÊúâÊïàÊúü1Â∞èÊó∂Ôºâ
            CacheManager.set(cacheKey, combinedResults, 1);

            state.playlist = combinedResults;
            renderResults(combinedResults);

            // ÂêåÊó∂ÁºìÂ≠òÊØè‰∏™Ê≠åÊõ≤ÁöÑÂÖÉÊï∞ÊçÆ
            combinedResults.forEach(song => {
                const songCacheKey = generateCacheKey(song.artistName, song.trackName);
                CacheManager.set(songCacheKey, {
                    trackName: song.trackName,
                    artistName: song.artistName,
                    artworkUrl: song.artworkUrl100,
                    previewUrl: song.previewUrl,
                    collectionName: song.collectionName,
                    kind: song.kind  // ‰øùÂ≠òÊù•Ê∫êÁ±ªÂûã
                }, 24); // 24Â∞èÊó∂ÊúâÊïàÊúü
            });
        }

        // Ê∏≤ÊüìÁªìÊûú
        function renderResults(songs) {
            if (songs.length === 0) {
                $('results').innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="empty-icon">üîç</div>
                        <div class="empty-title">Êú™ÊâæÂà∞ÁªìÊûú</div>
                        <div class="empty-desc">Êç¢‰∏™ÂÖ≥ÈîÆËØçËØïËØï</div>
                    </div>
                `;
                return;
            }

            $('results').innerHTML = songs.map((song, index) => {
                // Ê£ÄÊü•ÊòØÂê¶ÊúâÁºìÂ≠òÁöÑÂÖÉÊï∞ÊçÆ
                const songCacheKey = generateCacheKey(song.artistName, song.trackName);
                const cachedSong = CacheManager.get(songCacheKey);

                // ‰ΩøÁî®ÁºìÂ≠òÁöÑÊàñÂéüÂßãÁöÑÂ∞ÅÈù¢URL
                const coverUrl = (cachedSong?.artworkUrl || song.artworkUrl100).replace('100x100bb', '300x300bb');

                // Ê£ÄÊü•ÊòØÂê¶ÊòØ YouTube Êù•Ê∫ê
                const isYouTube = song.kind === 'youtube' || song.previewUrl?.includes('youtube.com');

                return `
                    <div class="song-card" data-index="${index}" onclick="playSong(${index})">
                        <div class="song-cover">
                            <img src="${coverUrl}" loading="lazy" alt="">
                            <div class="play-overlay">
                                <div class="play-overlay-btn">‚ñ∂</div>
                            </div>
                            ${song.trackId ? `<div class="song-options" onclick="event.stopPropagation(); ${isYouTube ? `playYouTubeFullSong('${song.trackId}', '${escapeHtml(song.trackName)}', '${escapeHtml(song.artistName)}', '${coverUrl}')` : `playFullSong('${song.trackId}', '${escapeHtml(song.trackName)}', '${escapeHtml(song.artistName)}')`}">‚ãØ</div>` : ''}
                        </div>
                        <div class="song-title">${isYouTube ? '<span style="color: #ff6b6b;">‚ñ∂</span> ' : ''}${escapeHtml(song.trackName)}</div>
                        <div class="song-artist">${escapeHtml(song.artistName)}</div>
                    </div>
                `;
            }).join('');
        }

        // HTML ËΩ¨‰πâ
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Êí≠ÊîæÊ≠åÊõ≤
        function playSong(index) {
            const song = state.playlist[index];
            if (!song) return;

            // Ê£ÄÊü•ÊòØÂê¶ÊòØ YouTube Êù•Ê∫êÁöÑÊ≠åÊõ≤
            const isYouTube = song.kind === 'youtube' || song.previewUrl?.includes('youtube.com');

            if (isYouTube) {
                // Â¶ÇÊûúÊòØ YouTube Ê≠åÊõ≤Ôºå‰ΩøÁî® YouTube Êí≠ÊîæÂáΩÊï∞
                playYouTubeSong(
                    song.trackId,
                    song.trackName || 'Êú™Áü•Ê≠åÊõ≤',
                    song.artistName || 'Êú™Áü•Ëâ∫ÊúØÂÆ∂',
                    song.artworkUrl100 || song.thumbnails?.[0]?.url || 'https://i.ytimg.com/img/no_thumbnail.jpg'
                );
                return;
            }

            state.currentTrack = song;
            state.currentIndex = index;

            // ‰ªéÁºìÂ≠òËé∑ÂèñÂÆåÊï¥Êï∞ÊçÆÔºåÂ¶ÇÊûúÊúâÁöÑËØù
            const songCacheKey = generateCacheKey(song.artistName, song.trackName);
            const cachedSong = CacheManager.get(songCacheKey);

            // ‰ΩøÁî®ÁºìÂ≠òÊï∞ÊçÆÊàñÂéüÂßãÊï∞ÊçÆ
            const trackName = cachedSong?.trackName || song.trackName;
            const artistName = cachedSong?.artistName || song.artistName;
            const artworkUrl = cachedSong?.artworkUrl || song.artworkUrl100;
            const previewUrl = cachedSong?.previewUrl || song.previewUrl;
            const collectionName = cachedSong?.collectionName || song.collectionName || song.collectionName;

            const cover = artworkUrl.replace('100x100bb', '600x600bb');

            // Êõ¥Êñ∞È°∂ÈÉ®‰ø°ÊÅØÊ†è
            const titleTextEl = $('player-title-text');
            const artistTextEl = $('player-artist-text');
            const wikiBtn = $('player-wiki-btn');

            titleTextEl.textContent = trackName;
            artistTextEl.textContent = artistName;
            $('player-cover').src = cover;

            // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂Âà∞Ê†áÈ¢òÔºàÊêúÁ¥¢Ê≠åÊõ≤ÂêçÔºâ
            titleTextEl.onclick = () => {
                searchBySong(trackName);
            };
            titleTextEl.title = 'ÁÇπÂáªÊêúÁ¥¢ËØ•Ê≠åÊõ≤';

            // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂Âà∞Ëâ∫ÊúØÂÆ∂ÂêçÁß∞ÔºàÊêúÁ¥¢Ëâ∫ÊúØÂÆ∂Ôºâ
            artistTextEl.onclick = () => {
                searchByArtist(artistName);
            };
            artistTextEl.title = 'ÁÇπÂáªÊêúÁ¥¢ËØ•Ëâ∫ÊúØÂÆ∂ÁöÑÊ≠åÊõ≤';

            // ËÆæÁΩÆÁª¥Âü∫ÁôæÁßëÊåâÈíÆ
            const cleanArtistName = artistName.split(/&|,|feat\.|ft\./i)[0].trim();
            wikiBtn.style.display = 'flex';
            wikiBtn.onclick = () => {
                const wikiUrl = `https://zh.wikipedia.org/wiki/${encodeURIComponent(cleanArtistName)}`;
                window.open(wikiUrl, '_blank');
            };
            wikiBtn.title = `Êü•Áúã ${cleanArtistName} ÁöÑÁª¥Âü∫ÁôæÁßë`;

            // ËÆæÁΩÆÊ†áÁ≠æÊé®ËçêÊåâÈíÆ
            const tagBtn = $('player-tag-btn');
            tagBtn.style.display = 'flex';
            tagBtn.onclick = () => {
                showCurrentSongTags();
            };
            tagBtn.title = 'Êü•ÁúãÊ≠åÊõ≤Ê†áÁ≠æÊé®Ëçê';

            // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊªöÂä®
            const checkScroll = (el) => {
                // ÂÖàÈáçÁΩÆÔºå‰ª•‰æøÂáÜÁ°ÆÊµãÈáè
                el.classList.remove('scroll-text');
                el.style.transform = 'none';

                // ÊØîËæÉÂÜÖÈÉ®ÊñáÊú¨ÂÆΩÂ∫¶ÂíåÂ§ñÈÉ®ÂÆπÂô®ÂÆΩÂ∫¶
                const containerWidth = el.parentElement.clientWidth;
                const textWidth = el.scrollWidth;

                if (textWidth > containerWidth) {
                    const distance = containerWidth - textWidth; // Ë¥üÂÄºÔºåÂêëÂ∑¶ÁßªÂä®
                    const duration = Math.abs(distance) / 30 + 2; // ÈÄüÂ∫¶ÊéßÂà∂ÔºöÊØèÁßí30pxÔºåÂü∫Á°Ä2s

                    el.style.setProperty('--scroll-distance', `${distance}px`);
                    el.style.setProperty('--duration', `${duration}s`);
                    el.classList.add('scroll-text');
                }
            };

            // Á®çÂæÆÂª∂Êó∂‰∏ÄÁÇπÔºåÁ°Æ‰øù DOM Ê∏≤ÊüìÂÆåÊàê
            setTimeout(() => {
                checkScroll(titleTextEl);
                checkScroll(artistTextEl);
            }, 50);

            // ËÉåÊôØ
            $('bg-album').style.backgroundImage = `url(${cover})`;
            $('bg-album').classList.add('active');

            // Ê†áËÆ∞ÂΩìÂâçÊí≠Êîæ
            document.querySelectorAll('.song-card').forEach((card, i) => {
                card.classList.toggle('playing', i === index);
            });

            // Êí≠Êîæ
            audio.src = previewUrl;
            audio.play()
                .then(() => updatePlayState(true))
                .catch(() => updatePlayState(false));

            // ÂºπÂπï
            startDanmaku();

            // È¢ÑÂä†ËΩΩÊ≠åËØç
            $('lyrics-title').textContent = trackName;
            $('lyrics-artist').textContent = artistName;
            // Set up Wikipedia link for artist name
            setupWikipediaLink(artistName);
            $('lyrics-cover').src = cover;
            $('lyrics-text').textContent = 'Âä†ËΩΩ‰∏≠...';
            $('lyrics-wiki').classList.remove('show');

            fetchLyrics(artistName, trackName);
            fetchArtistWiki(artistName);

            // Add click event to artist name to search for artist's songs (left click)
            // and open Wikipedia (Ctrl/Cmd+click)
            $('lyrics-artist').onclick = function (event) {
                if (event.ctrlKey || event.metaKey) {
                    // Ctrl/Cmd + click: open Wikipedia
                    const wikiUrl = $('lyrics-artist').dataset.wikiUrl || `https://zh.wikipedia.org/wiki/${encodeURIComponent(artistName.split(/&|,|feat\.|ft\./i)[0].trim())}`;
                    window.open(wikiUrl, '_blank');
                } else {
                    // Regular click: search for artist's songs
                    searchByArtist(artistName);
                }
            };
            $('lyrics-artist').style.cursor = 'pointer';
            $('lyrics-artist').title = 'ÁÇπÂáªÊêúÁ¥¢ËØ•Ëâ∫ÊúØÂÆ∂ÁöÑÊ≠åÊõ≤ (Ctrl/Cmd+ÁÇπÂáªËÆøÈóÆÁª¥Âü∫ÁôæÁßë)';

            // Ê∑ªÂä†Âà∞ÂéÜÂè≤ËÆ∞ÂΩï
            HistoryManager.add(song);

            // Êõ¥Êñ∞Á≥ªÁªüÂ™í‰Ωì‰∏≠ÂøÉÊéßÂà∂ (Media Session API)
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: trackName,
                    artist: artistName,
                    album: collectionName || 'ÂπøÂ±±Èü≥‰πê',
                    artwork: [
                        { src: artworkUrl.replace('100x100bb', '96x96bb'), sizes: '96x96', type: 'image/jpeg' },
                        { src: artworkUrl.replace('100x100bb', '128x128bb'), sizes: '128x128', type: 'image/jpeg' },
                        { src: artworkUrl.replace('100x100bb', '192x192bb'), sizes: '192x192', type: 'image/jpeg' },
                        { src: artworkUrl.replace('100x100bb', '256x256bb'), sizes: '256x256', type: 'image/jpeg' },
                        { src: cover, sizes: '512x512', type: 'image/jpeg' }
                    ]
                });

                navigator.mediaSession.setActionHandler('play', togglePlay);
                navigator.mediaSession.setActionHandler('pause', togglePlay);
                navigator.mediaSession.setActionHandler('previoustrack', playPrevious);
                navigator.mediaSession.setActionHandler('nexttrack', () => playNext(false));
            }

            // Êõ¥Êñ∞Êî∂ËóèÊåâÈíÆÁä∂ÊÄÅ
            updateFavoriteButton();

            // Êõ¥Êñ∞Êé®ËçêÊ†áÁ≠æ
            updateRecommendationTags(song);
        }

        // Êõ¥Êñ∞Êé®ËçêÊ†áÁ≠æ
        function updateRecommendationTags(song) {
            const recommendations = getSongRecommendations(song);
            const container = $('recommendation-tags-container');
            const tagsElement = $('recommendation-tags');
            const showMoreBtn = $('show-more-recommendations');

            if (!recommendations || recommendations.length === 0) {
                tagsElement.style.display = 'none';
                return;
            }

            // ËøáÊª§ÊéâÊó†ÊïàÁöÑÊé®ËçêÊ†áÁ≠æ
            const validRecommendations = recommendations.filter(tag => tag && typeof tag === 'string');

            if (validRecommendations.length === 0) {
                tagsElement.style.display = 'none';
                return;
            }

            // Âè™ÊòæÁ§∫Ââç5‰∏™Êé®Ëçê
            const displayRecommendations = validRecommendations.slice(0, 5);

            // Ê∏≤ÊüìÊé®ËçêÊ†áÁ≠æ
            container.innerHTML = displayRecommendations.map(tag => `
                <span class="recommendation-tag" onclick="searchByTag('${tag}')">${escapeHtml(tag)}</span>
            `).join('');

            // Â¶ÇÊûúËøòÊúâÊõ¥Â§öÊé®ËçêÔºåÊòæÁ§∫"Â±ïÂºÄÊõ¥Â§ö"ÊåâÈíÆ
            if (validRecommendations.length > 5) {
                showMoreBtn.style.display = 'block';
                showMoreBtn.onclick = () => {
                    // ÊòæÁ§∫ÊâÄÊúâÊé®Ëçê
                    container.innerHTML = validRecommendations.map(tag => `
                        <span class="recommendation-tag" onclick="searchByTag('${tag}')">${escapeHtml(tag)}</span>
                    `).join('');
                    showMoreBtn.style.display = 'none';
                };
            } else {
                showMoreBtn.style.display = 'none';
            }

            // ÊòæÁ§∫Êé®ËçêÂå∫Âüü
            tagsElement.style.display = 'block';
        }

        // YouTube Èü≥‰πê API ÊêúÁ¥¢ÂáΩÊï∞
        async function searchYouTubeMusic(query) {
            try {
                const response = await fetch(`https://api.yuangs.cc/youtubeapi/search/song?q=${encodeURIComponent(query)}&limit=10`);
                if (response.ok) {
                    const data = await response.json();
                    console.log('YouTube search API ÂìçÂ∫î:', data); // Debug log

                    if (data && data.data && data.data.length > 0) {
                        // Á°Æ‰øùËøîÂõûÁöÑÊï∞ÊçÆÊ†ºÂºè‰∏ÄËá¥
                        return data.data.map(item => ({
                            ...item,
                            // Á°Æ‰øùËâ∫ÊúØÂÆ∂Â≠óÊÆµÊ≠£Á°ÆÊò†Â∞Ñ
                            artist: Array.isArray(item.artists) ? item.artists.join(', ') : item.artist,
                            // Â¶ÇÊûúÈúÄË¶Å iTunes ÂÖºÂÆπÊ†ºÂºè
                            artistName: Array.isArray(item.artists) ? item.artists.join(', ') : (item.artist || item.author || 'Unknown Artist'),
                            trackName: item.title || item.name
                        }));
                    }
                } else {
                    console.error('YouTube API ËØ∑Ê±ÇÂ§±Ë¥•ÔºåÁä∂ÊÄÅÁ†Å:', response.status);
                }
                return [];
            } catch (error) {
                console.error('YouTube API ÊêúÁ¥¢Â§±Ë¥•:', error);
                return [];
            }
        }

        // Êí≠Êîæ YouTube ÂÆåÊï¥Ê≠åÊõ≤
        async function playYouTubeSong(videoId, title, artist, coverUrl = '') {
            if (!videoId) return;

            // ÂàõÂª∫ YouTube Èü≥È¢ëÊµÅ URL
            const audioUrl = `https://www.youtube.com/watch?v=${videoId}`;

            // Êõ¥Êñ∞Êí≠ÊîæÁä∂ÊÄÅ
            state.currentTrack = {
                trackId: videoId,
                trackName: title,
                artistName: artist,
                artworkUrl100: coverUrl || 'https://i.ytimg.com/img/no_thumbnail.jpg',
                previewUrl: audioUrl
            };

            // Êõ¥Êñ∞Êí≠ÊîæÂô® UI
            const cover = coverUrl || 'https://i.ytimg.com/img/no_thumbnail.jpg';
            $('player-cover').src = cover;

            const titleTextEl = $('player-title-text');
            const artistTextEl = $('player-artist-text');

            titleTextEl.textContent = title;
            artistTextEl.textContent = artist;

            // Êõ¥Êñ∞È°∂ÈÉ®‰ø°ÊÅØÊ†è
            $('player-cover').src = cover;
            $('bg-album').style.backgroundImage = `url(${cover})`;
            $('bg-album').classList.add('active');

            // ËÆæÁΩÆÁª¥Âü∫ÁôæÁßëÊåâÈíÆ
            const wikiBtn = $('player-wiki-btn');
            const cleanArtistName = artist.split(/&|,|feat\.|ft\./i)[0].trim();
            wikiBtn.style.display = 'flex';
            wikiBtn.onclick = () => {
                const wikiUrl = `https://zh.wikipedia.org/wiki/${encodeURIComponent(cleanArtistName)}`;
                window.open(wikiUrl, '_blank');
            };
            wikiBtn.title = `Êü•Áúã ${cleanArtistName} ÁöÑÁª¥Âü∫ÁôæÁßë`;

            // ËÆæÁΩÆÊ†áÁ≠æÊé®ËçêÊåâÈíÆ
            const tagBtn = $('player-tag-btn');
            tagBtn.style.display = 'flex';
            tagBtn.onclick = () => {
                showCurrentSongTags();
            };
            tagBtn.title = 'Êü•ÁúãÊ≠åÊõ≤Ê†áÁ≠æÊé®Ëçê';

            // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊªöÂä®
            const checkScroll = (el) => {
                el.classList.remove('scroll-text');
                el.style.transform = 'none';

                const containerWidth = el.parentElement.clientWidth;
                const textWidth = el.scrollWidth;

                if (textWidth > containerWidth) {
                    const distance = containerWidth - textWidth;
                    const duration = Math.abs(distance) / 30 + 2;

                    el.style.setProperty('--scroll-distance', `${distance}px`);
                    el.style.setProperty('--duration', `${duration}s`);
                    el.classList.add('scroll-text');
                }
            };

            setTimeout(() => {
                checkScroll(titleTextEl);
                checkScroll(artistTextEl);
            }, 50);

            // Êí≠ÊîæÈü≥È¢ë
            audio.src = audioUrl;
            audio.load(); // Âä†ËΩΩÊñ∞Èü≥È¢ëÊ∫ê
            audio.play()
                .then(() => updatePlayState(true))
                .catch(error => {
                    console.error('Êí≠ÊîæÂ§±Ë¥•:', error);
                    updatePlayState(false);

                    // Â∞ùËØï‰ΩøÁî® YouTube Music URL
                    const musicAudioUrl = `https://music.youtube.com/watch?v=${videoId}`;
                    audio.src = musicAudioUrl;
                    audio.load();
                    audio.play()
                        .then(() => updatePlayState(true))
                        .catch(err => {
                            console.error('YouTube Music Êí≠Êîæ‰πüÂ§±Ë¥•:', err);
                            showToast('Êí≠ÊîæÂ§±Ë¥•ÔºåËØ∑Â∞ùËØïÂÖ∂‰ªñÊ≠åÊõ≤');
                        });
                });

            // ÂºπÂπï
            startDanmaku();

            // È¢ÑÂä†ËΩΩÊ≠åËØç
            $('lyrics-title').textContent = title;
            $('lyrics-artist').textContent = artist;
            setupWikipediaLink(artist);
            $('lyrics-cover').src = cover;
            $('lyrics-text').textContent = 'Âä†ËΩΩ‰∏≠...';
            $('lyrics-wiki').classList.remove('show');

            fetchLyrics(artist, title);
            fetchArtistWiki(artist);

            // Ê∑ªÂä†Âà∞ÂéÜÂè≤ËÆ∞ÂΩï
            HistoryManager.add({
                trackId: videoId,
                trackName: title,
                artistName: artist,
                artworkUrl100: cover
            });

            // Êõ¥Êñ∞Á≥ªÁªüÂ™í‰Ωì‰∏≠ÂøÉÊéßÂà∂ (Media Session API)
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: title,
                    artist: artist,
                    album: 'YouTube Music',
                    artwork: [
                        { src: cover, sizes: '96x96', type: 'image/jpeg' },
                        { src: cover, sizes: '128x128', type: 'image/jpeg' },
                        { src: cover, sizes: '192x192', type: 'image/jpeg' },
                        { src: cover, sizes: '256x256', type: 'image/jpeg' },
                        { src: cover, sizes: '512x512', type: 'image/jpeg' }
                    ]
                });

                navigator.mediaSession.setActionHandler('play', togglePlay);
                navigator.mediaSession.setActionHandler('pause', togglePlay);
                navigator.mediaSession.setActionHandler('previoustrack', playPrevious);
                navigator.mediaSession.setActionHandler('nexttrack', () => playNext(false));
            }

            // Êõ¥Êñ∞Êî∂ËóèÊåâÈíÆÁä∂ÊÄÅ
            updateFavoriteButton();

            // Êõ¥Êñ∞Êé®ËçêÊ†áÁ≠æ
            updateRecommendationTags(state.currentTrack);
        }

        // ‰ªé YouTube ÊêúÁ¥¢Âπ∂Êí≠ÊîæÊ≠åÊõ≤
        async function searchAndPlayYouTubeSong(query) {
            const results = await searchYouTubeMusic(query);
            if (results && results.length > 0) {
                const song = results[0]; // ‰ΩøÁî®Á¨¨‰∏Ä‰∏™ÁªìÊûú
                playYouTubeSong(
                    song.video_id,
                    song.title || 'Êú™Áü•Ê≠åÊõ≤',
                    song.artist || 'Êú™Áü•Ëâ∫ÊúØÂÆ∂',
                    song.thumbnail || song.thumbnails?.[0]?.url || ''
                );
                return true;
            }
            return false;
        }

        // ÊåâÊ†áÁ≠æÊêúÁ¥¢
        function searchByTag(tag) {
            if (!tag) {
                return;
            }
            $('search-input').value = tag;
            searchMusic();
        }

        // ÊòæÁ§∫ÂΩìÂâçÊí≠ÊîæÊ≠åÊõ≤ÁöÑÊ†áÁ≠æÂ±ÇÊ¨°ÁªìÊûÑ
        function showCurrentSongTags() {
            if (!state.currentTrack) {
                showToast('ËØ∑ÂÖàÊí≠Êîæ‰∏ÄÈ¶ñÊ≠åÊõ≤');
                return;
            }

            const song = state.currentTrack;
            const recommendations = getSongRecommendations(song);

            if (!recommendations || recommendations.length === 0) {
                showToast('Êú™ÊâæÂà∞Áõ∏ÂÖ≥Ê†áÁ≠æ');
                return;
            }

            // ËøáÊª§ÊéâÊó†ÊïàÁöÑÊé®ËçêÊ†áÁ≠æ
            const validRecommendations = recommendations.filter(tag => tag && typeof tag === 'string');

            if (validRecommendations.length === 0) {
                showToast('Êú™ÊâæÂà∞ÊúâÊïàÊ†áÁ≠æ');
                return;
            }

            // ÂàõÂª∫Ê†áÁ≠æËØ¶ÊÉÖÂºπÁ™ó
            const modal = document.createElement('div');
            modal.className = 'tag-details-modal';
            modal.innerHTML = `
                <div class="modal-overlay" onclick="this.parentElement.remove()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <h3>Áõ∏ÂÖ≥Ê†áÁ≠æÊé®Ëçê</h3>
                        <div class="tags-list">
                            ${validRecommendations.map(tag => `
                                <div class="tag-item" onclick="searchByTag('${tag}')">
                                    <span class="tag-name">${escapeHtml(tag)}</span>
                                    <span class="tag-search-btn">üîç</span>
                                </div>
                            `).join('')}
                        </div>
                        <button class="modal-close-btn" onclick="this.parentElement.parentElement.remove()">ÂÖ≥Èó≠</button>
                    </div>
                </div>
            `;

            // Ê∑ªÂä†Ê†∑Âºè
            if (!document.querySelector('#tag-details-modal-styles')) {
                const styles = document.createElement('style');
                styles.id = 'tag-details-modal-styles';
                styles.textContent = `
                    .tag-details-modal .modal-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0,0,0,0.8);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10000;
                    }
                    .tag-details-modal .modal-content {
                        background: var(--card);
                        border-radius: 16px;
                        padding: 24px;
                        max-width: 400px;
                        width: 90%;
                        max-height: 80vh;
                        overflow-y: auto;
                        border: 1px solid var(--glass-border);
                        backdrop-filter: blur(20px);
                    }
                    .tag-details-modal h3 {
                        margin: 0 0 16px;
                        color: var(--text);
                        text-align: center;
                    }
                    .tags-list {
                        display: flex;
                        flex-direction: column;
                        gap: 8px;
                        margin-bottom: 16px;
                    }
                    .tag-item {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 10px 12px;
                        background: var(--glass);
                        border-radius: 8px;
                        cursor: pointer;
                        transition: all 0.2s ease;
                    }
                    .tag-item:hover {
                        background: var(--primary);
                        color: white;
                    }
                    .tag-search-btn {
                        opacity: 0.7;
                        transition: opacity 0.2s ease;
                    }
                    .tag-item:hover .tag-search-btn {
                        opacity: 1;
                    }
                    .modal-close-btn {
                        width: 100%;
                        padding: 12px;
                        background: var(--glass);
                        border: 1px solid var(--glass-border);
                        color: var(--text);
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: 500;
                    }
                    .modal-close-btn:hover {
                        background: var(--card-hover);
                    }
                `;
                document.head.appendChild(styles);
            }

            document.body.appendChild(modal);
        }

        // Êõ¥Êñ∞Êí≠ÊîæÁä∂ÊÄÅ
        function updatePlayState(playing) {
            state.isPlaying = playing;
            const btn = $('play-btn');
            btn.textContent = playing ? '‚è∏' : '‚ñ∂';
            btn.setAttribute('data-playing', playing); // Áî®‰∫é CSS Ê†∑Âºè‰øÆÊ≠£
            $('player-cover').classList.toggle('spinning', playing);
        }

        // ÈöêËóèÊí≠ÊîæÂô®ÊåâÈíÆ
        function hidePlayerButtons() {
            const wikiBtn = $('player-wiki-btn');
            const tagBtn = $('player-tag-btn');
            if (wikiBtn) wikiBtn.style.display = 'none';
            if (tagBtn) tagBtn.style.display = 'none';
        }

        // Êí≠Êîæ/ÊöÇÂÅú
        function togglePlay() {
            if (!state.currentTrack && state.playlist.length > 0) {
                // Â¶ÇÊûúÊ≤°ÊúâÂΩìÂâçÊí≠ÊîæÁöÑÊ≠åÊõ≤‰ΩÜÊúâÊí≠ÊîæÂàóË°®ÔºåÂàôÊí≠ÊîæÁ¨¨‰∏ÄÈ¶ñ
                playSong(0);
            } else if (state.currentTrack) {
                // Ê£ÄÊü•ÊòØÂê¶ÊòØ YouTube Êù•Ê∫êÁöÑÊ≠åÊõ≤
                const isYouTube = state.currentTrack.kind === 'youtube' ||
                    (state.currentTrack.previewUrl && state.currentTrack.previewUrl.includes('youtube.com'));

                if (isYouTube) {
                    toggleYouTubePlay();
                } else {
                    // ÂØπ‰∫é iTunes Ê≠åÊõ≤ÔºåÁªßÁª≠‰ΩøÁî®Ê†áÂáÜÈü≥È¢ëÂÖÉÁ¥†
                    if (audio.src) {
                        if (audio.paused) {
                            audio.play();
                            updatePlayState(true);
                        } else {
                            audio.pause();
                            updatePlayState(false);
                        }
                    }
                }
            }
        }

        // Âú® YouTube Êí≠ÊîæÂô®‰∏≠Êí≠Êîæ‰∏ã‰∏ÄÈ¶ñ
        function playNextForYouTube() {
            if (state.playMode === 'single') {
                // ÂçïÊõ≤Âæ™ÁéØÔºåÈáçÊñ∞Êí≠ÊîæÂΩìÂâçÊ≠åÊõ≤
                if (state.youtubePlayer) {
                    state.youtubePlayer.seekTo(0);
                    state.youtubePlayer.playVideo();
                }
                return;
            }

            if (state.playlist.length === 0) return;

            let newIndex;
            if (state.playMode === 'random') {
                newIndex = Math.floor(Math.random() * state.playlist.length);
                // Â∞ΩÈáèÈÅøÂÖçÈöèÊú∫Âà∞Âêå‰∏ÄÈ¶ñÔºàÈô§ÈùûÂè™Êúâ‰∏ÄÈ¶ñÔºâ
                if (state.playlist.length > 1 && newIndex === state.currentIndex) {
                    newIndex = (newIndex + 1) % state.playlist.length;
                }
            } else {
                newIndex = (state.currentIndex + 1) % state.playlist.length;
            }
            playSong(newIndex);
        }

        // ÂàáÊç¢Êí≠ÊîæÊ®°Âºè
        function togglePlayMode() {
            const modes = ['sequence', 'random', 'single'];
            const currentIdx = modes.indexOf(state.playMode);
            const nextIdx = (currentIdx + 1) % modes.length;
            state.playMode = modes[nextIdx];

            const btn = $('mode-btn');
            switch (state.playMode) {
                case 'sequence':
                    btn.textContent = 'üîÅ';
                    btn.title = 'ÂàóË°®Âæ™ÁéØ';
                    showToast('ÂàóË°®Âæ™ÁéØ');
                    break;
                case 'random':
                    btn.textContent = 'üîÄ';
                    btn.title = 'ÈöèÊú∫Êí≠Êîæ';
                    showToast('ÈöèÊú∫Êí≠Êîæ');
                    break;
                case 'single':
                    btn.textContent = 'üîÇ';
                    btn.title = 'ÂçïÊõ≤Âæ™ÁéØ';
                    showToast('ÂçïÊõ≤Âæ™ÁéØ');
                    break;
            }
        }

        // ‰∏ä‰∏ÄÈ¶ñ/‰∏ã‰∏ÄÈ¶ñ
        function playPrevious() {
            if (state.playlist.length === 0) return;

            let newIndex;
            if (state.playMode === 'random') {
                newIndex = Math.floor(Math.random() * state.playlist.length);
            } else {
                newIndex = (state.currentIndex - 1 + state.playlist.length) % state.playlist.length;
            }
            playSong(newIndex);
        }

        function playNext(auto = false) {
            if (state.playlist.length === 0) return;

            // Â¶ÇÊûúÊòØËá™Âä®Êí≠ÊîæÔºàÊí≠ÊîæÁªìÊùüËß¶ÂèëÔºâ‰∏îÊòØÂçïÊõ≤Âæ™ÁéØ
            if (auto && state.playMode === 'single') {
                audio.currentTime = 0;
                audio.play();
                return;
            }

            let newIndex;
            if (state.playMode === 'random') {
                newIndex = Math.floor(Math.random() * state.playlist.length);
                // Â∞ΩÈáèÈÅøÂÖçÈöèÊú∫Âà∞Âêå‰∏ÄÈ¶ñÔºàÈô§ÈùûÂè™Êúâ‰∏ÄÈ¶ñÔºâ
                if (state.playlist.length > 1 && newIndex === state.currentIndex) {
                    newIndex = (newIndex + 1) % state.playlist.length;
                }
            } else {
                newIndex = (state.currentIndex + 1) % state.playlist.length;
            }
            playSong(newIndex);
        }

        // ËøõÂ∫¶Êù°
        audio.ontimeupdate = () => {
            // Only update progress bar for non-YouTube sources (iTunes previews)
            if (!state.currentTrack || !(state.currentTrack.kind === 'youtube' ||
                (state.currentTrack.previewUrl && state.currentTrack.previewUrl.includes('youtube.com')))) {
                if (isNaN(audio.duration)) return;
                const pct = (audio.currentTime / audio.duration) * 100;
                $('progress-fill').style.width = pct + '%';
                $('current-time').textContent = formatTime(audio.currentTime);
            }
        };

        audio.onloadedmetadata = () => {
            // Only update duration for non-YouTube sources
            if (!state.currentTrack || !(state.currentTrack.kind === 'youtube' ||
                (state.currentTrack.previewUrl && state.currentTrack.previewUrl.includes('youtube.com')))) {
                $('total-time').textContent = formatTime(audio.duration);
            }
        };

        audio.onended = () => {
            // For YouTube, we rely on the YouTube player's onStateChange event
            if (!state.currentTrack || !(state.currentTrack.kind === 'youtube' ||
                (state.currentTrack.previewUrl && state.currentTrack.previewUrl.includes('youtube.com')))) {
                updatePlayState(false);
                playNext(true); // ‰º†ÂÖ• true Ë°®Á§∫Ëá™Âä®Êí≠Êîæ
            }
        };

        // ‰∏∫ YouTube Êí≠ÊîæÂô®ÂàõÂª∫ÂÆöÊó∂Âô®Êù•Êõ¥Êñ∞ËøõÂ∫¶ - ‰ΩøÁî®Êõ¥È¢ëÁπÅÁöÑÊõ¥Êñ∞
        // Using a more robust interval that can continue in background
        let youtubeProgressInterval = setInterval(() => {
            if (state.youtubePlayer && state.isYouTubePlaying) {
                try {
                    const currentTime = state.youtubePlayer.getCurrentTime();
                    const duration = state.youtubePlayer.getDuration();

                    if (!isNaN(duration) && !isNaN(currentTime) && duration > 0) {
                        const pct = (currentTime / duration) * 100;
                        $('progress-fill').style.width = pct + '%';
                        $('current-time').textContent = formatTime(currentTime);
                        $('total-time').textContent = formatTime(duration);

                        // Update media session position state for background playback controls
                        if ('setPositionState' in navigator.mediaSession) {
                            navigator.mediaSession.setPositionState({
                                duration: duration,
                                playbackRate: 1.0,
                                position: currentTime
                            });
                        }
                    }
                } catch (e) {
                    // Â¶ÇÊûú YouTube Êí≠ÊîæÂô®ËøòÊ≤°ÂáÜÂ§áÂ•ΩÔºåÂøΩÁï•ÈîôËØØ
                }
            }
        }, 500); // ÊØè0.5ÁßíÊõ¥Êñ∞‰∏ÄÊ¨°ËøõÂ∫¶Ôºå‰ΩøÊó∂Èó¥ËΩ¥Êõ¥ÊµÅÁïÖ

        // Store the interval ID so we can clear it if needed
        state.youtubeProgressInterval = youtubeProgressInterval;

        // ÂÅúÊ≠¢ÂºπÂπïÁ≥ªÁªü
        function stopDanmaku() {
            if (state.danmakuInterval) {
                clearInterval(state.danmakuInterval);
                state.danmakuInterval = null;
            }
            $('danmaku').classList.remove('show');
            $('danmaku').innerHTML = '';
            // Clear the displayed danmaku set
            state.displayedDanmaku.clear();
            // Clear recent danmaku indices
            if (state.recentDanmakuIndices) {
                state.recentDanmakuIndices = [];
            }
            // Reset tracks
            state.tracks = [false, false, false, false, false];
            // ÂÅúÊ≠¢ÂÆöÊúüÂà∑Êñ∞ÂºπÂπïÊï∞ÊçÆ
            DanmakuManager.stopRefresh();
        }

        function seek(e) {
            if (!audio.src) return;
            const rect = $('progress-bar').getBoundingClientRect();
            const pct = (e.clientX - rect.left) / rect.width;
            audio.currentTime = pct * audio.duration;
        }

        function formatTime(sec) {
            const m = Math.floor(sec / 60);
            const s = Math.floor(sec % 60);
            return `${m}:${s.toString().padStart(2, '0')}`;
        }

        // Êí≠ÊîæÂÆåÊï¥Ê≠åÊõ≤ÔºàÂú®Apple Music‰∏≠Ôºâ
        function playFullSong(trackId, trackName, artistName) {
            const song = state.playlist.find(s => s.trackId == trackId);
            const albumId = song?.collectionId || trackId;

            const musicAppUrl = `music://music.apple.com/cn/album/${albumId}?i=${trackId}`;
            const webUrl = `https://music.apple.com/cn/album/${albumId}?i=${trackId}`;

            // Ê£ÄÊµãËÆæÂ§áÁ±ªÂûã
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isMac = /Macintosh/.test(navigator.userAgent);
            const isAppleDevice = isIOS || isMac;

            if (isAppleDevice) {
                // Apple ËÆæÂ§áÔºöÂ∞ùËØïÊâìÂºÄ App
                const startTime = Date.now();

                // ‰ΩøÁî® visibilitychange Ê£ÄÊµãÊòØÂê¶ÊàêÂäüË∑≥ËΩ¨Âà∞ App
                const handleVisibilityChange = () => {
                    if (document.hidden) {
                        // È°µÈù¢Ë¢´ÈöêËóèÔºåËØ¥ÊòéÊàêÂäüÊâìÂºÄ‰∫Ü App
                        clearTimeout(fallbackTimer);
                        document.removeEventListener('visibilitychange', handleVisibilityChange);
                    }
                };
                document.addEventListener('visibilitychange', handleVisibilityChange);

                // Â∞ùËØïÊâìÂºÄ App
                window.location.href = musicAppUrl;

                // ËÆæÁΩÆÈôçÁ∫ßÂÆöÊó∂Âô®
                const fallbackTimer = setTimeout(() => {
                    document.removeEventListener('visibilitychange', handleVisibilityChange);

                    // Â¶ÇÊûúÈ°µÈù¢ËøòÂèØËßÅ‰∏îÊó∂Èó¥ÂæàÁü≠ÔºåËØ¥Êòé App Ê≤°ÊâìÂºÄ
                    if (!document.hidden && Date.now() - startTime < 2000) {
                        showFallbackOptions(trackName, artistName, webUrl);
                    }
                }, 1500);

            } else {
                // Èùû Apple ËÆæÂ§áÔºöÁõ¥Êé•ÊâìÂºÄÁΩëÈ°µÁâà
                window.open(webUrl, '_blank');
                showToast(`Ê≠£Âú®ÊâìÂºÄ "${trackName}" - ${artistName}`);
            }
        }

        // Êí≠Êîæ YouTube ÂÆåÊï¥Ê≠åÊõ≤ÔºàÈÄâÈ°πËèúÂçïË∞ÉÁî®Ôºâ
        function playYouTubeFullSong(videoId, trackName, artistName, coverUrl) {
            playYouTubeSong(videoId, trackName, artistName, coverUrl);
        }

        // ÊòæÁ§∫ÈôçÁ∫ßÈÄâÈ°π
        function showFallbackOptions(trackName, artistName, webUrl) {
            // ÂàõÂª∫‰∏Ä‰∏™Êõ¥ÂèãÂ•ΩÁöÑÊèêÁ§∫Ê°Ü
            const modal = document.createElement('div');
            modal.className = 'apple-music-modal';
            modal.innerHTML = `
        <div class="modal-overlay" onclick="this.parentElement.remove()">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-icon">üéµ</div>
                <h3>ÊâìÂºÄ Apple Music</h3>
                <p>Âç≥Â∞ÜÊí≠Êîæ "${trackName}"<br><span class="artist">${artistName}</span></p>
                <div class="modal-buttons">
                    <a href="${webUrl}" target="_blank" class="btn-primary" onclick="this.closest('.apple-music-modal').remove()">
                        Âú®ÁΩëÈ°µ‰∏≠ÊâìÂºÄ
                    </a>
                    <button class="btn-secondary" onclick="this.closest('.apple-music-modal').remove()">
                        ÂèñÊ∂à
                    </button>
                </div>
                <p class="hint">ÊèêÁ§∫ÔºöÂÆâË£Ö Apple Music Â∫îÁî®ÂèØËé∑ÂæóÊõ¥Â•Ω‰ΩìÈ™å</p>
            </div>
        </div>
    `;

            // Ê∑ªÂä†Ê†∑Âºè
            if (!document.querySelector('#apple-music-modal-styles')) {
                const styles = document.createElement('style');
                styles.id = 'apple-music-modal-styles';
                styles.textContent = `
            .apple-music-modal .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: fadeIn 0.2s ease;
            }
            .apple-music-modal .modal-content {
                background: white;
                border-radius: 16px;
                padding: 24px;
                max-width: 320px;
                width: 90%;
                text-align: center;
                animation: slideUp 0.3s ease;
            }
            .apple-music-modal .modal-icon {
                font-size: 48px;
                margin-bottom: 12px;
            }
            .apple-music-modal h3 {
                margin: 0 0 8px;
                font-size: 18px;
                color: #1a1a1a;
            }
            .apple-music-modal p {
                margin: 0 0 16px;
                color: #666;
                font-size: 14px;
                line-height: 1.5;
            }
            .apple-music-modal .artist {
                color: #999;
            }
            .apple-music-modal .modal-buttons {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            .apple-music-modal .btn-primary {
                background: linear-gradient(135deg, #fc3c44, #d93a41);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 10px;
                font-size: 16px;
                font-weight: 500;
                cursor: pointer;
                text-decoration: none;
                display: block;
            }
            .apple-music-modal .btn-secondary {
                background: #f0f0f0;
                color: #333;
                border: none;
                padding: 12px 24px;
                border-radius: 10px;
                font-size: 16px;
                cursor: pointer;
            }
            .apple-music-modal .hint {
                font-size: 12px;
                color: #999;
                margin-top: 16px;
                margin-bottom: 0;
            }
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            @keyframes slideUp {
                from { transform: translateY(20px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
        `;
                document.head.appendChild(styles);
            }

            document.body.appendChild(modal);
        }

        // YouTube Player functions
        function onYouTubeIframeAPIReady() {
            console.log('YouTube Iframe API ready');
        }

        // Initialize YouTube player
        function initYouTubePlayer(videoId) {
            return new Promise((resolve, reject) => {
                // Initialize background audio context before creating player
                initializeBackgroundAudio();

                // Create container for YouTube player if it doesn't exist
                let playerContainer = document.getElementById('youtube-player-container');
                if (!playerContainer) {
                    playerContainer = document.createElement('div');
                    playerContainer.id = 'youtube-player-container';
                    playerContainer.style.display = 'none';
                    document.body.appendChild(playerContainer);
                }

                // Create the YouTube player
                const player = new YT.Player('youtube-player-container', {
                    videoId: videoId,
                    playerVars: {
                        'playsinline': 1,
                        'controls': 0,  // Hide controls to play audio only
                        'disablekb': 1, // Disable keyboard controls
                        'fs': 0,       // Disable fullscreen
                        'iv_load_policy': 3, // Disable annotations
                        'modestbranding': 1, // Reduce YouTube branding
                        'rel': 0, // Don't show related videos at the end
                        'autoplay': 0, // Don't autoplay, we'll control it
                        'mute': 0 // Don't mute initially
                    },
                    events: {
                        'onReady': function (event) {
                            console.log('YouTube player ready');
                            // Resume audio context when player is ready
                            if (backgroundAudioContext && backgroundAudioContext.state !== 'running') {
                                backgroundAudioContext.resume();
                            }

                            // Set initial position state with duration for MediaSession API
                            // This ensures duration displays correctly in UI and lock screen
                            try {
                                const duration = event.target.getDuration();
                                if (!isNaN(duration) && duration > 0) {
                                    $('total-time').textContent = formatTime(duration);

                                    if ('setPositionState' in navigator.mediaSession) {
                                        navigator.mediaSession.setPositionState({
                                            duration: duration,
                                            playbackRate: 1.0,
                                            position: 0
                                        });
                                    }
                                }
                            } catch (e) {
                                console.log('Could not get duration on ready:', e);
                            }

                            // Autoplay if requested - make sure to call this directly in response to user interaction
                            if (state.shouldAutoplayYouTube) {
                                // Try to play immediately, but handle potential autoplay policy restrictions
                                requestAudioPlayback().then(() => {
                                    event.target.playVideo();
                                    state.isYouTubePlaying = true;
                                    updatePlayState(true);
                                    state.shouldAutoplayYouTube = false;
                                }).catch(() => {
                                    // If requestAudioPlayback fails, try to play anyway
                                    // The browser might still allow playback if called directly from user interaction
                                    event.target.playVideo();
                                    state.isYouTubePlaying = true;
                                    updatePlayState(true);
                                    state.shouldAutoplayYouTube = false;
                                });
                            }

                            resolve(event.target);
                        },
                        'onStateChange': function (event) {
                            console.log('YouTube player state:', event.data);
                            // Update our state based on YouTube player state
                            if (event.data === YT.PlayerState.PLAYING) {
                                state.isYouTubePlaying = true;
                                updatePlayState(true);
                                // Ensure audio context is running
                                if (backgroundAudioContext && backgroundAudioContext.state === 'suspended') {
                                    backgroundAudioContext.resume();
                                }
                            } else if (event.data === YT.PlayerState.PAUSED) {
                                state.isYouTubePlaying = false;
                                updatePlayState(false);
                            } else if (event.data === YT.PlayerState.ENDED) {
                                // ÂΩì YouTube Ê≠åÊõ≤Êí≠ÊîæÁªìÊùüÊó∂
                                state.isYouTubePlaying = false;
                                updatePlayState(false);
                                // Âª∂Ëøü‰∏ÄÁÇπÊó∂Èó¥ÂÜçÊí≠Êîæ‰∏ã‰∏ÄÈ¶ñÔºåÁ°Æ‰øùÁä∂ÊÄÅÊõ¥Êñ∞ÂÆåÊàê
                                setTimeout(() => {
                                    playNextForYouTube();
                                }, 300);
                            } else if (event.data === YT.PlayerState.BUFFERING) {
                                // Ensure audio context remains active during buffering
                                if (backgroundAudioContext && backgroundAudioContext.state === 'suspended') {
                                    backgroundAudioContext.resume();
                                }
                            }
                        },
                        'onError': function (error) {
                            console.error('YouTube player error:', error);
                            // Retry initialization with different parameters if there's an error
                            if (error.data === 100 || error.data === 101 || error.data === 150) {
                                // Video not found or not allowed to play - propagate error
                                reject(error);
                            } else {
                                // Other errors - might be recoverable
                                console.log('YouTube player error, but continuing:', error);
                                // Don't reject for other errors, as the player might still work
                                // Resolve with the player instance anyway
                                resolve(event.target);
                            }
                        }
                    }
                });
            });
        }

        // Update the playYouTubeSong function to use YouTube player
        async function playYouTubeSong(videoId, title, artist, coverUrl = '') {
            if (!videoId) return;

            try {
                // Update state and UI first
                state.currentTrack = {
                    trackId: videoId,
                    trackName: title,
                    artistName: artist,
                    artworkUrl100: coverUrl || 'https://i.ytimg.com/img/no_thumbnail.jpg',
                    kind: 'youtube'
                };

                // Update player UI
                const cover = coverUrl || 'https://i.ytimg.com/img/no_thumbnail.jpg';
                $('player-cover').src = cover;

                const titleTextEl = $('player-title-text');
                const artistTextEl = $('player-artist-text');

                titleTextEl.textContent = title;
                artistTextEl.textContent = artist;

                // Update top info bar
                $('player-cover').src = cover;
                $('bg-album').style.backgroundImage = `url(${cover})`;
                $('bg-album').classList.add('active');

                // Setup Wikipedia button
                const wikiBtn = $('player-wiki-btn');
                const cleanArtistName = artist.split(/&|,|feat\.|ft\./i)[0].trim();
                wikiBtn.style.display = 'flex';
                wikiBtn.onclick = () => {
                    const wikiUrl = `https://zh.wikipedia.org/wiki/${encodeURIComponent(cleanArtistName)}`;
                    window.open(wikiUrl, '_blank');
                };
                wikiBtn.title = `Êü•Áúã ${cleanArtistName} ÁöÑÁª¥Âü∫ÁôæÁßë`;

                // Setup tag recommendation button
                const tagBtn = $('player-tag-btn');
                tagBtn.style.display = 'flex';
                tagBtn.onclick = () => {
                    showCurrentSongTags();
                };
                tagBtn.title = 'Êü•ÁúãÊ≠åÊõ≤Ê†áÁ≠æÊé®Ëçê';

                // Check if text needs scrolling
                const checkScroll = (el) => {
                    el.classList.remove('scroll-text');
                    el.style.transform = 'none';

                    const containerWidth = el.parentElement.clientWidth;
                    const textWidth = el.scrollWidth;

                    if (textWidth > containerWidth) {
                        const distance = containerWidth - textWidth;
                        const duration = Math.abs(distance) / 30 + 2;

                        el.style.setProperty('--scroll-distance', `${distance}px`);
                        el.style.setProperty('--duration', `${duration}s`);
                        el.classList.add('scroll-text');
                    }
                };

                setTimeout(() => {
                    checkScroll(titleTextEl);
                    checkScroll(artistTextEl);
                }, 50);


                // Danmaku
                startDanmaku();

                // Preload lyrics
                $('lyrics-title').textContent = title;
                $('lyrics-artist').textContent = artist;
                setupWikipediaLink(artist);
                $('lyrics-cover').src = cover;
                $('lyrics-text').textContent = 'Âä†ËΩΩ‰∏≠...';
                $('lyrics-wiki').classList.remove('show');

                fetchLyrics(artist, title);
                fetchArtistWiki(artist);

                // Add to history
                HistoryManager.add({
                    trackId: videoId,
                    trackName: title,
                    artistName: artist,
                    artworkUrl100: cover,
                    kind: 'youtube'
                });

                // Update media session (with updated metadata)
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.metadata = new MediaMetadata({
                        title: title,
                        artist: artist,
                        album: 'YouTube Music',
                        artwork: [
                            { src: cover, sizes: '96x96', type: 'image/jpeg' },
                            { src: cover, sizes: '128x128', type: 'image/jpeg' },
                            { src: cover, sizes: '192x192', type: 'image/jpeg' },
                            { src: cover, sizes: '256x256', type: 'image/jpeg' },
                            { src: cover, sizes: '512x512', type: 'image/jpeg' }
                        ]
                    });

                    navigator.mediaSession.setActionHandler('play', toggleYouTubePlay);
                    navigator.mediaSession.setActionHandler('pause', toggleYouTubePlay);
                    navigator.mediaSession.setActionHandler('previoustrack', playPrevious);
                    navigator.mediaSession.setActionHandler('nexttrack', () => playNext(false));
                }

                // Update favorite button state
                updateFavoriteButton();

                // Update recommendation tags
                updateRecommendationTags(state.currentTrack);

                // Initialize or update YouTube player
                if (!state.youtubePlayer) {
                    // Set flag to autoplay when ready
                    state.shouldAutoplayYouTube = true;
                    state.youtubePlayer = await initYouTubePlayer(videoId);
                } else {
                    state.youtubePlayer.loadVideoById(videoId);
                    // For already-initialized player, try to play immediately after loading
                    // Wait a bit for the video to load, then play it
                    setTimeout(() => {
                        if (state.youtubePlayer) {
                            // Try to play the video directly from this context which should still be user-initiated
                            requestAudioPlayback().then(() => {
                                state.youtubePlayer.playVideo();
                                state.isYouTubePlaying = true;
                                updatePlayState(true);
                            }).catch(() => {
                                // If requestAudioPlayback fails, try to play anyway
                                state.youtubePlayer.playVideo();
                                state.isYouTubePlaying = true;
                                updatePlayState(true);
                            });
                        }
                    }, 100); // Reduced timeout to be faster
                }

                // For immediate playback after user interaction (in case user clicked to play)
                if (state.youtubePlayer && state.youtubePlayer.getVideoUrl && state.youtubePlayer.getVideoUrl().includes(videoId)) {
                    // If player is already ready and loaded with the right video, try to play now
                    try {
                        // Try to play immediately if available
                        if (state.youtubePlayer && state.youtubePlayer.getPlayerState &&
                            state.youtubePlayer.getPlayerState() !== YT.PlayerState.PLAYING) {
                            requestAudioPlayback().then(() => {
                                state.youtubePlayer.playVideo();
                                state.isYouTubePlaying = true;
                                updatePlayState(true);
                            }).catch(() => {
                                state.youtubePlayer.playVideo();
                                state.isYouTubePlaying = true;
                                updatePlayState(true);
                            });
                        }
                    } catch (e) {
                        console.log("Could not play immediately:", e);
                    }
                }

            } catch (error) {
                console.error('Error initializing YouTube player:', error);
                showToast('YouTube Êí≠ÊîæÂô®ÂàùÂßãÂåñÂ§±Ë¥•ÔºåÂ∞ùËØï‰ΩøÁî®Â§áÁî®ÊñπÊ°à...');

                // Fallback: use the audio element with YouTube video URL (may not work in all browsers)
                const audioUrl = `https://www.youtube.com/watch?v=${videoId}`;
                audio.src = audioUrl;
                audio.load();
                audio.play()
                    .then(() => {
                        updatePlayState(true);
                        state.isYouTubePlaying = true;
                    })
                    .catch(err => {
                        console.error('Fallback also failed:', err);
                        showToast('Êí≠ÊîæÂ§±Ë¥•ÔºåËØ∑Â∞ùËØïÂÖ∂‰ªñÊ≠åÊõ≤');
                        updatePlayState(false);
                        state.isYouTubePlaying = false;
                    });
            }
        }

        // Toggle play/pause for YouTube player
        function toggleYouTubePlay() {
            if (state.youtubePlayer) {
                if (state.isYouTubePlaying) {
                    state.youtubePlayer.pauseVideo();
                    state.isYouTubePlaying = false;
                } else {
                    // Request user interaction to enable audio in background
                    requestAudioPlayback().then(() => {
                        state.youtubePlayer.playVideo();
                        state.isYouTubePlaying = true;
                        updatePlayState(true);
                    }).catch(() => {
                        try {
                            state.youtubePlayer.playVideo();
                            state.isYouTubePlaying = true;
                            updatePlayState(true);
                        } catch (error) {
                            console.error('Failed to play YouTube video:', error);
                            updatePlayState(false);
                            showToast('Êó†Ê≥ïÊí≠ÊîæYouTubeÈü≥‰πêÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•');
                        }
                    });
                }
                updatePlayState(state.isYouTubePlaying);
            }
        }

        // Audio context for maintaining background audio on mobile
        let backgroundAudioContext = null;

        // Initialize audio context for background playback
        function initializeBackgroundAudio() {
            if (backgroundAudioContext) return;

            if (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') {
                backgroundAudioContext = new (AudioContext || webkitAudioContext)();

                // Create a minimal silent buffer to maintain the audio context
                const silentBuffer = backgroundAudioContext.createBuffer(1, 1, 22050);
                const source = backgroundAudioContext.createBufferSource();
                source.buffer = silentBuffer;

                // Connect to output without amplification (essentially silent)
                const gainNode = backgroundAudioContext.createGain();
                gainNode.gain.value = 0; // Completely silent
                source.connect(gainNode);
                gainNode.connect(backgroundAudioContext.destination);

                // Loop the silent buffer indefinitely
                source.loop = true;
                source.start();

                // Resume if suspended
                if (backgroundAudioContext.state === 'suspended') {
                    backgroundAudioContext.resume();
                }
            }
        }

        // Request audio playback permission on mobile devices
        function requestAudioPlayback() {
            return new Promise((resolve, reject) => {
                // Initialize background audio context
                initializeBackgroundAudio();

                // Resume audio context if suspended
                if (backgroundAudioContext && backgroundAudioContext.state === 'suspended') {
                    backgroundAudioContext.resume().then(() => {
                        resolve();
                    }).catch(reject);
                } else {
                    resolve();
                }
            });
        }

        // Handle visibility changes for mobile background audio
        document.addEventListener('visibilitychange', function () {
            if (document.visibilityState === 'visible') {
                // When returning to foreground, ensure audio is properly resumed
                if (state.youtubePlayer && state.isYouTubePlaying) {
                    // Small delay to ensure YouTube player is ready
                    setTimeout(() => {
                        if (state.youtubePlayer.getPlayerState() !== YT.PlayerState.PLAYING) {
                            toggleYouTubePlay();
                        }
                    }, 100);
                }
            }
        });

        // Additional mobile-specific handling
        if ('mediaSession' in navigator) {
            navigator.mediaSession.setActionHandler('play', toggleYouTubePlay);
            navigator.mediaSession.setActionHandler('pause', toggleYouTubePlay);

            // Handle seek actions to maintain audio session
            try {
                navigator.mediaSession.setActionHandler('seekbackward', () => {
                    if (state.youtubePlayer) {
                        const currentTime = state.youtubePlayer.getCurrentTime();
                        state.youtubePlayer.seekTo(Math.max(0, currentTime - 10), true);
                    }
                });

                navigator.mediaSession.setActionHandler('seekforward', () => {
                    if (state.youtubePlayer) {
                        const currentTime = state.youtubePlayer.getCurrentTime();
                        const duration = state.youtubePlayer.getDuration();
                        state.youtubePlayer.seekTo(Math.min(duration, currentTime + 10), true);
                    }
                });
            } catch (error) {
                console.log('Seek actions not supported:', error);
            }
        }

        // Additional event listeners to handle app lifecycle and backgrounding
        window.addEventListener('pagehide', function () {
            // Try to maintain audio when page is hidden (e.g., switching apps)
            if (state.youtubePlayer && state.isYouTubePlaying) {
                // Store the current time to resume from when returning
                state.lastPosition = state.youtubePlayer.getCurrentTime();
            }
        });

        // Handle page visibility changes more comprehensively
        document.addEventListener('visibilitychange', function () {
            if (document.visibilityState === 'visible') {
                // When returning to foreground, resume audio if needed
                if (state.youtubePlayer && state.isYouTubePlaying) {
                    // Small delay to ensure YouTube player is ready after page becomes visible
                    setTimeout(() => {
                        const playerState = state.youtubePlayer.getPlayerState();
                        if (playerState !== YT.PlayerState.PLAYING) {
                            // Try to resume playback
                            state.youtubePlayer.playVideo();
                        }
                    }, 500);
                }
            }
        });

        // Handle focus/blur events which can affect audio on mobile
        window.addEventListener('focus', function () {
            // On iOS Safari especially, audio may need to be resumed when window regains focus
            if (state.youtubePlayer && state.isYouTubePlaying && state.youtubePlayer.getPlayerState() !== YT.PlayerState.PLAYING) {
                setTimeout(() => {
                    state.youtubePlayer.playVideo();
                }, 100);
            }
        });

        window.addEventListener('blur', function () {
            // Store position when leaving the page
            if (state.youtubePlayer && state.isYouTubePlaying) {
                state.lastPosition = state.youtubePlayer.getCurrentTime();
            }
        });

        // Toast ÊèêÁ§∫
        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 10000;
        animation: fadeIn 0.3s ease;
    `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease forwards';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        // Ê≠åËØç
        async function fetchLyrics(artist, title) {
            // ÁîüÊàêÁºìÂ≠òÈîÆ
            const cacheKey = `lyrics_${encodeURIComponent(artist)}_${encodeURIComponent(title)}`;
            const cachedLyrics = CacheManager.get(cacheKey);

            if (cachedLyrics) {
                console.log('Using cached lyrics for:', artist, title);
                $('lyrics-text').textContent = cachedLyrics;
                return;
            }

            try {
                const cleanTitle = title.split('(')[0].split('-')[0].trim();
                const cleanArtist = artist.split('&')[0].split(',')[0].trim();

                // Â∞ùËØï‰ΩøÁî® YouTube API Ëé∑ÂèñÊ≠åËØçÔºàÂ¶ÇÊûúÂΩìÂâçÊí≠ÊîæÁöÑÊòØ YouTube Ê≠åÊõ≤Ôºâ
                if (state.currentTrack && state.currentTrack.trackId &&
                    (state.currentTrack.kind === 'youtube' || state.currentTrack.previewUrl?.includes('youtube.com'))) {
                    try {
                        const youTubeLyricsRes = await fetch(`https://api.yuangs.cc/youtubeapi/lyrics/${state.currentTrack.trackId}`);
                        if (youTubeLyricsRes.ok) {
                            const youTubeLyricsData = await youTubeLyricsRes.json();

                            if (youTubeLyricsData.success && youTubeLyricsData.data && youTubeLyricsData.data.lyrics) {
                                $('lyrics-text').textContent = youTubeLyricsData.data.lyrics;
                                // ÁºìÂ≠òÊ≠åËØçÔºàÊúâÊïàÊúü24Â∞èÊó∂Ôºâ
                                CacheManager.set(cacheKey, youTubeLyricsData.data.lyrics, 24);
                                return;
                            }
                        } else {
                            console.error('YouTube lyrics API ËØ∑Ê±ÇÂ§±Ë¥•ÔºåÁä∂ÊÄÅÁ†Å:', youTubeLyricsRes.status);
                        }
                    } catch (e) {
                        console.error('YouTube lyrics API failed:', e);
                        // Â¶ÇÊûú YouTube API Â§±Ë¥•ÔºåÁªßÁª≠Â∞ùËØïÂÖ∂‰ªñ API
                    }
                }

                // Â∞ùËØï‰ΩøÁî®ÂéüÁâà API
                const res = await fetch(`https://api.lyrics.ovh/v1/${encodeURIComponent(cleanArtist)}/${encodeURIComponent(cleanTitle)}`);

                if (res.ok) {
                    const data = await res.json();
                    if (data.lyrics) {
                        $('lyrics-text').textContent = data.lyrics;
                        // ÁºìÂ≠òÊ≠åËØçÔºàÊúâÊïàÊúü24Â∞èÊó∂Ôºâ
                        CacheManager.set(cacheKey, data.lyrics, 24);
                        return;
                    }
                }
                showCatFallback();
            } catch {
                showCatFallback();
            }
        }

        async function showCatFallback() {
            try {
                const res = await fetch('https://api.thecatapi.com/v1/images/search');
                const data = await res.json();
                if (data?.[0]?.url) {
                    $('lyrics-text').innerHTML = `
                        <div style="margin-bottom: 20px; color: var(--text-secondary);">ÊöÇÊó†Ê≠åËØçÔºåÈÄÅ‰Ω†‰∏ÄÂè™Áå´ üê±</div>
                        <img src="${data[0].url}" style="max-width: 280px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.4);">
                    `;
                    return;
                }
            } catch { }
            $('lyrics-text').textContent = 'ÊöÇÊó†Ê≠åËØç';
        }

        // ËÆæÁΩÆÁª¥Âü∫ÁôæÁßëÈìæÊé•
        function setupWikipediaLink(artistName) {
            const cleanName = artistName.split(/&|,|feat\.|ft\./i)[0].trim();
            const encodedName = encodeURIComponent(cleanName);

            // Â≠òÂÇ®ÈìæÊé•Âà∞Ëâ∫ÊúØÂÆ∂ÂÖÉÁ¥†ÁöÑÊï∞ÊçÆÂ±ûÊÄß as fallback
            $('lyrics-artist').dataset.wikiUrl = `https://zh.wikipedia.org/wiki/${encodedName}`;

            // È™åËØÅÈìæÊé•ÊòØÂê¶Â≠òÂú®ÔºàÂºÇÊ≠•Ê£ÄÊü•Ôºâ
            verifyWikipediaPageExists(cleanName);
        }

        // È™åËØÅÁª¥Âü∫ÁôæÁßëÈ°µÈù¢ÊòØÂê¶Â≠òÂú®
        async function verifyWikipediaPageExists(artistName) {
            const cleanName = artistName.split(/&|,|feat\.|ft\./i)[0].trim();
            const encodedName = encodeURIComponent(cleanName);

            // È¶ñÂÖàÂ∞ùËØï‰∏≠ÊñáÁª¥Âü∫ÁôæÁßë
            try {
                const res = await fetch(`https://zh.wikipedia.org/api/rest_v1/page/summary/${encodedName}`);

                if (res.ok) {
                    const data = await res.json();
                    if (data.title) {
                        // ‰∏≠ÊñáÁª¥Âü∫ÁôæÁßëÂ≠òÂú®Ôºå‰ΩøÁî®‰∏≠ÊñáÈìæÊé•
                        $('lyrics-artist').dataset.wikiUrl = `https://zh.wikipedia.org/wiki/${encodedName}`;
                        return;
                    }
                }
            } catch { }

            // Â¶ÇÊûú‰∏≠Êñá‰∏çÂ≠òÂú®ÔºåÂ∞ùËØïËã±ÊñáÁª¥Âü∫ÁôæÁßë
            try {
                const res = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodedName}`);

                if (res.ok) {
                    const data = await res.json();
                    if (data.title) {
                        // Ëã±ÊñáÁª¥Âü∫ÁôæÁßëÂ≠òÂú®Ôºå‰ΩøÁî®Ëã±ÊñáÈìæÊé•
                        $('lyrics-artist').dataset.wikiUrl = `https://en.wikipedia.org/wiki/${encodedName}`;
                        return;
                    }
                }
            } catch { }

            // Â¶ÇÊûúÈÉΩ‰∏çÂ≠òÂú®ÔºåËÆæÁΩÆ‰∏∫ÊêúÁ¥¢È°µÈù¢
            $('lyrics-artist').dataset.wikiUrl = `https://zh.wikipedia.org/wiki/Special:Search?search=${encodedName}`;
        }

        // Ê≠åÊâãÁôæÁßë
        async function fetchArtistWiki(artistName) {
            const cleanName = artistName.split(/&|,|feat\.|ft\./i)[0].trim();
            const cacheKey = `wiki_${encodeURIComponent(cleanName)}`;
            const cachedWiki = CacheManager.get(cacheKey);

            if (cachedWiki) {
                console.log('Using cached wiki for:', cleanName);
                $('wiki-title').textContent = `ÂÖ≥‰∫é ${cachedWiki.title}`;
                $('wiki-text').textContent = cachedWiki.extract;
                $('lyrics-wiki').classList.add('show');
                return;
            }

            try {
                let res = await fetch(`https://zh.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(cleanName)}`);
                if (!res.ok) {
                    res = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(cleanName)}`);
                }

                if (res.ok) {
                    const data = await res.json();
                    if (data.extract) {
                        $('wiki-title').textContent = `ÂÖ≥‰∫é ${data.title}`;
                        $('wiki-text').textContent = data.extract;
                        $('lyrics-wiki').classList.add('show');
                        // ÁºìÂ≠òÁª¥Âü∫ÁôæÁßëÊï∞ÊçÆÔºàÊúâÊïàÊúü12Â∞èÊó∂Ôºâ
                        CacheManager.set(cacheKey, {
                            title: data.title,
                            extract: data.extract
                        }, 12);
                    } else {
                        // If no wiki summary found, hide the wiki section
                        $('lyrics-wiki').classList.remove('show');
                    }
                }
            } catch { }
        }

        // Ê≠åËØçÈ°µÈù¢
        function openLyrics() {
            if (!state.currentTrack) return;
            $('lyrics-modal').classList.add('show');
        }

        function closeLyrics() {
            $('lyrics-modal').classList.remove('show');
        }

        // Â§©Ê∞îÊêúÁ¥¢ - ÈöèÊú∫ÂÖ≥ÈîÆËØçÂ¢ûÂº∫Áâà
        async function searchByWeather() {
            try {
                // 1. Ëé∑ÂèñÂú∞ÁêÜ‰ΩçÁΩÆ
                const geoRes = await fetch('https://get.geojs.io/v1/ip/geo.json');
                const geo = await geoRes.json();

                // 2. Ëé∑ÂèñÂ§©Ê∞îÊï∞ÊçÆ
                const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${geo.latitude}&longitude=${geo.longitude}&current_weather=true`);
                const weatherData = await weatherRes.json();
                const code = weatherData.current_weather.weathercode;

                // 3. ÂÆö‰πâÂèòÈáè
                let keywordOptions = []; // ÂÄôÈÄâÂÖ≥ÈîÆËØçÂàóË°®
                let weatherLabel = 'Êú™Áü•'; // Â§©Ê∞î‰∏≠ÊñáÂêç

                // 4. Ê†πÊçÆÂ§©Ê∞î‰ª£Á†ÅÂàÜÈÖçÂÖ≥ÈîÆËØçÂ∫ìÔºåÂπ∂‰∏éÊ†áÁ≠æÁ≥ªÁªüÂÖ≥ËÅî
                if (code <= 3) {
                    // Êô¥Êúó (0-3)
                    weatherLabel = 'Êô¥Êúó';
                    // ‰ªéÊÉÖÁª™Ê†áÁ≠æ‰∏≠ÁöÑÁßØÊûÅÊÉÖÁª™‰∏≠ÈÄâÊã©
                    keywordOptions = [...musicTags.attributes.moods.positive, ...musicTags.scenarios.activity_based.exercise, ...musicTags.scenarios.activity_based.social];
                }
                else if (code >= 45 && code <= 48) {
                    // ÈõæÂ§© (45, 48)
                    weatherLabel = 'ÈõæÂ§©';
                    // ‰ªéÊ∞õÂõ¥Ê†áÁ≠æ‰∏≠ÈÄâÊã©Á•ûÁßò„ÄÅÊ¢¶ÂπªÁöÑÊ†áÁ≠æ
                    keywordOptions = [...musicTags.attributes.moods.intense, ...musicTags.attributes.moods.melancholy, ...musicTags.attributes.styles.aesthetic];
                }
                else if (code >= 51 && code <= 67) {
                    // ‰∏ãÈõ® (51-67)
                    weatherLabel = '‰∏ãÈõ®';
                    // ÈÄâÊã©ÂÆâÈùô„ÄÅËàíÈÄÇÁöÑÈü≥‰πêÁ±ªÂûã
                    keywordOptions = [...musicTags.attributes.moods.melancholy, ...musicTags.scenarios.activity_based.relaxation, ...musicTags.genres.main.traditional];
                }
                else if (code >= 71 && code <= 86) {
                    // ‰∏ãÈõ™ (71-86)
                    weatherLabel = '‰∏ãÈõ™';
                    // ÈÄâÊã©Ê∏©Êöñ„ÄÅËäÇÊó•ÁöÑÈü≥‰πêÁ±ªÂûã
                    keywordOptions = [...musicTags.scenarios.special_occasions, ...musicTags.genres.main.traditional, ...musicTags.nature_abstract.nature.weather];
                }
                else if (code >= 95) {
                    // Èõ∑Êö¥ (95+)
                    weatherLabel = 'Èõ∑Êö¥';
                    // ÈÄâÊã©Âº∫ÁÉà„ÄÅÊúâÂÜ≤ÂáªÂäõÁöÑÈü≥‰πêÁ±ªÂûã
                    keywordOptions = [...musicTags.attributes.moods.intense, ...musicTags.genres.main.rock, ...musicTags.genres.main.electronic];
                }
                else {
                    // Â§ö‰∫ë/Èò¥Â§© (ÂÖ∂‰ªñÊÉÖÂÜµ)
                    weatherLabel = 'Â§ö‰∫ë';
                    // ÈÄâÊã©Ê∏©Âíå„ÄÅÊó•Â∏∏ÁöÑÈü≥‰πêÁ±ªÂûã
                    keywordOptions = [...musicTags.attributes.moods.mellow, ...musicTags.scenarios.time_based.daily_routine, ...musicTags.genres.main.pop];
                }

                // 5. Ê†∏ÂøÉÔºö‰ªéÊï∞ÁªÑ‰∏≠ÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™ÂÖ≥ÈîÆËØç
                const randomKeyword = keywordOptions[Math.floor(Math.random() * keywordOptions.length)];
                if (!randomKeyword) {
                    // Â¶ÇÊûúÊ†áÁ≠æÂ∫ì‰∏≠Ê≤°ÊúâÂØπÂ∫îÁ±ªÂà´Ôºå‰ΩøÁî®ÈªòËÆ§Â§©Ê∞îÁõ∏ÂÖ≥ÁöÑÂÖ≥ÈîÆËØç
                    const defaultKeywords = [
                        'Sunny Day', 'Rainy Day', 'Snow Winter', 'Cloudy Sky',
                        'Foggy Mood', 'Thunder Storm', 'Summer Vibes', 'Winter Mood'
                    ];
                    const randomKeyword = defaultKeywords[Math.floor(Math.random() * defaultKeywords.length)];
                    $('search-input').value = randomKeyword;
                } else {
                    $('search-input').value = randomKeyword;
                }

                // 6. ÊâßË°åÊêúÁ¥¢‰∏éÊèêÁ§∫
                searchMusic();
                alert(`üìç ${geo.city || 'Êú™Áü•'}\nüå§Ô∏è ${weatherLabel}\nüé≤ Êô∫ËÉΩÊé®Ëçê: ${$('search-input').value}`);

            } catch (e) {
                console.error(e);
                alert('Ëé∑ÂèñÂ§©Ê∞îÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªú');
            }
        }

        // ÂºπÂπïÁ≥ªÁªü
        function startDanmaku() {
            $('danmaku').classList.add('show');
            $('danmaku').innerHTML = '';
            // Clear the displayed danmaku set when starting
            state.displayedDanmaku.clear();
            // Clear recent danmaku indices to allow more variety
            if (state.recentDanmakuIndices) {
                state.recentDanmakuIndices = [];
            }
            // Reset tracks
            state.tracks = [false, false, false, false, false];

            if (state.danmakuInterval) clearInterval(state.danmakuInterval);

            // ÂàùÂßãÂåñÂºπÂπïÊï∞ÊçÆ
            DanmakuManager.fetchAndFill().then(() => {
                // Á´ãÂç≥ÁîüÊàêÂá†Êù°ÂºπÂπï‰ª•Â¢ûÂä†Â§öÊ†∑ÊÄß
                for (let i = 0; i < 3; i++) {
                    setTimeout(() => {
                        spawnDanmaku();
                    }, i * 800); // ÈîôÂºÄÊó∂Èó¥ÊòæÁ§∫ÔºåÈÅøÂÖçÂêåÊó∂Âá∫Áé∞
                }

                // ËÆæÁΩÆÂÆöÊó∂Âô®ÊåÅÁª≠ÁîüÊàêÂºπÂπï
                state.danmakuInterval = setInterval(spawnDanmaku, 2000); // ÂáèÂ∞ëÈó¥Èöî‰ª•Â¢ûÂä†È¢ëÁéá
                // ÂºÄÂßãÂÆöÊúüÂà∑Êñ∞ÂºπÂπïÊï∞ÊçÆ
                DanmakuManager.startRefresh();
            });
        }

        async function spawnDanmaku() {
            // ‰ªéÂÖ®Â±ÄÂºπÂπïÂ≠òÂÇ®‰∏≠Ëé∑ÂèñÈöèÊú∫ÂºπÂπï
            const danmaku = DanmakuManager.getRandom();

            if (danmaku) {
                renderDanmaku(danmaku);
            } else {
                // Â¶ÇÊûúÊ≤°ÊúâÂèØÁî®ÂºπÂπïÔºåËé∑ÂèñÊñ∞Êï∞ÊçÆ
                await DanmakuManager.fillNewRecords(5);
                const newDanmaku = DanmakuManager.getRandom();
                if (newDanmaku) {
                    renderDanmaku(newDanmaku);
                }
            }
        }

        function renderDanmaku(data) {
            // Create a unique content identifier to prevent duplicates
            const content = `${data.name}:${data.text}`;
            const fullContent = `${data.name}:${data.text}:${Date.now()}`; // Add timestamp to make it always unique for display

            // Check if this content is already displayed in the current view
            // Only check for recent duplicates (last 20 items) to avoid the issue of no fresh content
            if (state.displayedDanmaku.size > 20) {
                // Clear the set if it gets too large to avoid memory issues and allow refresh
                const recent = Array.from(state.displayedDanmaku).slice(-10); // Keep last 10 items as recent
                state.displayedDanmaku.clear();
                recent.forEach(item => state.displayedDanmaku.add(item));
            }

            if (state.displayedDanmaku.has(content)) {
                // If this exact content is already displayed recently, try to get another one
                setTimeout(async () => {
                    const alternativeDanmaku = DanmakuManager.getRandom();
                    if (alternativeDanmaku) {
                        renderDanmaku(alternativeDanmaku);
                    } else {
                        // If no alternative, try to fill with new records
                        await DanmakuManager.fillNewRecords(3);
                        const newDanmaku = DanmakuManager.getRandom();
                        if (newDanmaku) {
                            renderDanmaku(newDanmaku);
                        }
                    }
                }, 100); // Small delay to avoid blocking
                return;
            }

            let track = state.tracks.findIndex(t => !t);
            if (track === -1) {
                // If all tracks are busy, try to find the one that will finish earliest or just pick randomly
                track = Math.floor(Math.random() * 5);
            }

            state.tracks[track] = true;

            const item = document.createElement('div');
            item.className = 'danmaku-item';
            item.style.top = (track * 40 + 10) + 'px';
            item.style.animationDuration = (12 + Math.random() * 5) + 's';

            item.innerHTML = `
                <img class="danmaku-avatar" src="${data.avatar}" alt="">
                <span class="danmaku-name">${escapeHtml(data.name)}:</span>
                <span class="danmaku-text">${escapeHtml(data.text)}</span>
            `;

            // Add content to the displayed set
            state.displayedDanmaku.add(content);

            item.onanimationend = () => {
                // Remove content from the displayed set when animation ends
                state.displayedDanmaku.delete(content);
                item.remove();
                state.tracks[track] = false;
            };

            // Also handle manual removal if element is removed for other reasons
            const originalRemove = item.remove;
            item.remove = function () {
                state.displayedDanmaku.delete(content);
                state.tracks[track] = false;
                originalRemove.call(this);
            };

            $('danmaku').appendChild(item);
        }

        // ÂºπÂπïÁÆ°ÁêÜÂô®
        const DanmakuManager = {
            STORAGE_KEY: 'danmaku_records',
            MAX_RECORDS: 100,
            EXPIRY_TIME: 12 * 60 * 60 * 1000, // 12 hours in milliseconds
            REFRESH_INTERVAL: null, // ÂÆöÊó∂Âà∑Êñ∞ÂÆöÊó∂Âô®

            // Ëé∑ÂèñÊâÄÊúâÂºπÂπïËÆ∞ÂΩï
            getAll: () => {
                try {
                    const data = localStorage.getItem(DanmakuManager.STORAGE_KEY);
                    if (!data) return [];

                    const records = JSON.parse(data);
                    const now = Date.now();

                    // ËøáÊª§ÊéâËøáÊúüÁöÑËÆ∞ÂΩï
                    const validRecords = records.filter(record => now - record.timestamp < DanmakuManager.EXPIRY_TIME);

                    // Â¶ÇÊûúÊúâËøáÊúüËÆ∞ÂΩïÔºåÊõ¥Êñ∞Â≠òÂÇ®
                    if (records.length !== validRecords.length) {
                        localStorage.setItem(DanmakuManager.STORAGE_KEY, JSON.stringify(validRecords));
                    }

                    return validRecords;
                } catch (e) {
                    console.error('Failed to get danmaku records:', e);
                    return [];
                }
            },

            // ‰øùÂ≠òÂºπÂπïËÆ∞ÂΩïÔºàÊúÄÂ§ö100Êù°ÔºåË∂ÖÂá∫ÂàôÁßªÈô§ÊúÄÊóßÁöÑÔºâ
            save: (records) => {
                try {
                    // Á°Æ‰øù‰∏çË∂ÖËøáÊúÄÂ§ßÊï∞Èáè
                    if (records.length > DanmakuManager.MAX_RECORDS) {
                        records = records.slice(-DanmakuManager.MAX_RECORDS);
                    }

                    localStorage.setItem(DanmakuManager.STORAGE_KEY, JSON.stringify(records));
                } catch (e) {
                    console.error('Failed to save danmaku records:', e);
                }
            },

            // Ê∑ªÂä†Êñ∞ÂºπÂπïËÆ∞ÂΩï
            add: (danmaku) => {
                let records = DanmakuManager.getAll();
                records.push({
                    ...danmaku,
                    timestamp: Date.now()
                });

                // ‰øùÂ≠òÊó∂Ëá™Âä®Ê∏ÖÁêÜËøáÊúüËÆ∞ÂΩïÂπ∂ÈôêÂà∂Êï∞Èáè
                DanmakuManager.save(records);
            },

            // ÈöèÊú∫Ëé∑Âèñ‰∏ÄÊù°ÂºπÂπïËÆ∞ÂΩïÔºåÈÅøÂÖçÁü≠Êó∂Èó¥ÂÜÖÈáçÂ§ç
            getRandom: () => {
                const records = DanmakuManager.getAll();
                if (records.length === 0) return null;

                // Â¶ÇÊûúËÆ∞ÂΩïÊï∞ÈáèÂ§ß‰∫é5ÔºåÂ∞ùËØïÈÅøÂÖçËøîÂõûÊúÄËøëËøîÂõûËøáÁöÑÂºπÂπï
                if (records.length > 5) {
                    // ‰øùÂ≠òÊúÄËøëËøîÂõûÁöÑÂºπÂπïÁ¥¢ÂºïÔºåÈÅøÂÖçÈáçÂ§ç
                    if (!state.recentDanmakuIndices) {
                        state.recentDanmakuIndices = [];
                    }

                    // Ê∏ÖÈô§ËøáÊúüÁöÑÁ¥¢ÂºïËÆ∞ÂΩïÔºàË∂ÖËøá10‰∏™Â∞±‰øùÁïôÊúÄÊñ∞ÁöÑ5‰∏™Ôºâ
                    if (state.recentDanmakuIndices.length > 10) {
                        state.recentDanmakuIndices = state.recentDanmakuIndices.slice(-5);
                    }

                    // Â∞ùËØïÊâæÂà∞‰∏Ä‰∏™‰∏çÂú®ÊúÄËøëÂàóË°®‰∏≠ÁöÑÂºπÂπï
                    let validIndices = [];
                    for (let i = 0; i < records.length; i++) {
                        if (!state.recentDanmakuIndices.includes(i)) {
                            validIndices.push(i);
                        }
                    }

                    // Â¶ÇÊûúÊâÄÊúâÂºπÂπïÈÉΩÂú®ÊúÄËøëÂàóË°®‰∏≠ÔºåÊàñËÄÖÊúâÊïàÈÄâÈ°πÂ§™Â∞ëÔºåÂàô‰ΩøÁî®ÊâÄÊúâËÆ∞ÂΩï
                    if (validIndices.length < 3) {
                        validIndices = Array.from({ length: records.length }, (_, i) => i);
                    }

                    const randomIndex = validIndices[Math.floor(Math.random() * validIndices.length)];
                    state.recentDanmakuIndices.push(randomIndex);

                    return records[randomIndex];
                }

                // Â¶ÇÊûúËÆ∞ÂΩïÊï∞ÈáèÂ∞ë‰∫éÁ≠â‰∫é5ÔºåÁõ¥Êé•ÈöèÊú∫ËøîÂõû
                return records[Math.floor(Math.random() * records.length)];
            },

            // Ëé∑ÂèñÂπ∂Â°´ÂÖÖÊñ∞ÂºπÂπïÊï∞ÊçÆÔºàÂ¶ÇÊûúËÆ∞ÂΩï‰∏∫Á©∫ÊàñËøáÊúüÔºâ
            fetchAndFill: async () => {
                const records = DanmakuManager.getAll();
                const now = Date.now();

                // Â¶ÇÊûúËÆ∞ÂΩïÂ∞ë‰∫é15Êù°ÔºåËØ∑Ê±ÇÊñ∞Êï∞ÊçÆÔºàÂ¢ûÂä†Êï∞Èáè‰ª•Á°Æ‰øùÊúâË∂≥Â§üÁöÑÂºπÂπïÔºâ
                if (records.length < 15) {
                    await DanmakuManager.fillNewRecords(30); // Â¢ûÂä†Â°´ÂÖÖÊï∞Èáè
                } else {
                    // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊõ¥Êñ∞
                    const oldestRecord = records.reduce((oldest, record) => {
                        return record.timestamp < oldest.timestamp ? record : oldest;
                    }, records[0]);

                    if (now - oldestRecord.timestamp > DanmakuManager.EXPIRY_TIME * 0.5) { // Èôç‰ΩéÊõ¥Êñ∞ÈòàÂÄºÂà∞50%ÊúâÊïàÊúü
                        await DanmakuManager.fillNewRecords(15); // Â¢ûÂä†ÊØèÊ¨°Â°´ÂÖÖÁöÑÊï∞Èáè
                    }
                }
            },

            // ÂºÄÂßãÂÆöÊúüÂà∑Êñ∞ÂºπÂπïÊï∞ÊçÆ
            startRefresh: () => {
                // ÂÅúÊ≠¢‰πãÂâçÁöÑÂà∑Êñ∞ÂÆöÊó∂Âô®
                if (DanmakuManager.REFRESH_INTERVAL) {
                    clearInterval(DanmakuManager.REFRESH_INTERVAL);
                }

                // ÊØè10ÂàÜÈíüÊ£ÄÊü•‰∏ÄÊ¨°ÊòØÂê¶ÈúÄË¶ÅÊõ¥Êñ∞ÂºπÂπïÊï∞ÊçÆ
                DanmakuManager.REFRESH_INTERVAL = setInterval(async () => {
                    await DanmakuManager.fetchAndFill();
                }, 10 * 60 * 1000); // 10ÂàÜÈíü
            },

            // ÂÅúÊ≠¢ÂÆöÊúüÂà∑Êñ∞ÂºπÂπïÊï∞ÊçÆ
            stopRefresh: () => {
                if (DanmakuManager.REFRESH_INTERVAL) {
                    clearInterval(DanmakuManager.REFRESH_INTERVAL);
                    DanmakuManager.REFRESH_INTERVAL = null;
                }
            },

            // Â°´ÂÖÖÊñ∞ÁöÑÂºπÂπïËÆ∞ÂΩï
            fillNewRecords: async (count) => {
                try {
                    for (let i = 0; i < count; i++) {
                        // ÈöèÊú∫ÁîüÊàêÂºπÂπïÊï∞ÊçÆÔºàÂ¶ÇÊûúAPIË∞ÉÁî®Â§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§ÂÄºÔºâ
                        const useKanye = Math.random() > 0.5;

                        const [userRes, textRes] = await Promise.all([
                            fetch('https://randomuser.me/api/?inc=name,picture'),
                            useKanye
                                ? fetch('https://api.kanye.rest/')
                                : fetch('https://v1.hitokoto.cn/?c=a&c=b')
                        ]);

                        const user = await userRes.json();
                        const text = await textRes.json();

                        const danmaku = {
                            name: user.results[0].name.first,
                            avatar: user.results[0].picture.thumbnail,
                            text: text.quote || text.hitokoto
                        };

                        DanmakuManager.add(danmaku);
                    }
                } catch (err) {
                    console.error('Failed to fetch new danmaku records:', err);
                    // Â¶ÇÊûúAPIË∞ÉÁî®Â§±Ë¥•ÔºåÁîüÊàê‰∏Ä‰∫õÈªòËÆ§ÂºπÂπï
                    for (let i = 0; i < count; i++) {
                        const danmaku = {
                            name: 'Áî®Êà∑' + (Math.floor(Math.random() * 10000)),
                            avatar: 'data:image/svg+xml;charset=UTF-8,%3Csvg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50"%3E%3Ccircle cx="25" cy="25" r="25" fill="%23ccc"/%3E%3C/svg%3E',
                            text: 'ËøôÊòØ‰∏ÄÊù°ÈöèÊú∫ÂºπÂπï'
                        };
                        DanmakuManager.add(danmaku);
                    }
                }
            }
        };

        // PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('SW registered:', reg.scope))
                .catch(err => console.log('SW failed:', err));
        }

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', e => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallPrompt();
        });

        function showInstallPrompt() {
            if (document.querySelector('.install-prompt')) return;

            const div = document.createElement('div');
            div.className = 'install-prompt';
            div.innerHTML = `
                <div class="install-icon">üì±</div>
                <div class="install-text">
                    <div class="install-title">Ê∑ªÂä†Âà∞‰∏ªÂ±èÂπï</div>
                    <div class="install-desc">Ëé∑ÂæóÊõ¥Â•ΩÁöÑÂÖ®Â±è‰ΩìÈ™å</div>
                </div>
                <button class="install-btn" onclick="installApp()">ÂÆâË£Ö</button>
                <button class="install-close" onclick="this.parentElement.remove()">√ó</button>
            `;
            document.body.appendChild(div);

            setTimeout(() => div.remove(), 10000);
        }

        // ========== Êî∂ËóèÂíåÂéÜÂè≤ÂäüËÉΩ ==========

        // ÂàáÊç¢Êî∂ËóèÁä∂ÊÄÅ
        function toggleFavorite() {
            if (!state.currentTrack) return;

            const trackId = state.currentTrack.trackId;
            const btn = $('favorite-btn');

            if (FavoritesManager.isFavorited(trackId)) {
                FavoritesManager.remove(trackId);
                btn.textContent = 'ü§ç';
                btn.classList.remove('favorited');
                showToast('Â∑≤ÂèñÊ∂àÊî∂Ëóè');
            } else {
                FavoritesManager.add(state.currentTrack);
                btn.textContent = '‚ù§Ô∏è';
                btn.classList.add('favorited');
                showToast('Â∑≤Ê∑ªÂä†Âà∞Êî∂Ëóè');
            }
        }

        // Êõ¥Êñ∞Êî∂ËóèÊåâÈíÆÁä∂ÊÄÅ
        function updateFavoriteButton() {
            if (!state.currentTrack) return;

            const btn = $('favorite-btn');
            const isFavorited = FavoritesManager.isFavorited(state.currentTrack.trackId);

            btn.textContent = isFavorited ? '‚ù§Ô∏è' : 'ü§ç';
            if (isFavorited) {
                btn.classList.add('favorited');
            } else {
                btn.classList.remove('favorited');
            }
        }

        // ÊâìÂºÄÂéÜÂè≤ËÆ∞ÂΩï
        function openHistory() {
            $('history-modal').classList.add('show');
            renderHistory();
        }

        // ÂÖ≥Èó≠ÂéÜÂè≤ËÆ∞ÂΩï
        function closeHistory() {
            $('history-modal').classList.remove('show');
        }

        // Ê∏≤ÊüìÂéÜÂè≤ËÆ∞ÂΩï
        function renderHistory() {
            const history = HistoryManager.getAll();
            const container = $('history-content');

            if (history.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìñ</div>
                        <div class="empty-title">ÊöÇÊó†Êí≠ÊîæÂéÜÂè≤</div>
                        <div class="empty-desc">ÂºÄÂßãÊí≠ÊîæÈü≥‰πêÂêé‰ºöËá™Âä®ËÆ∞ÂΩï</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="collection-grid">
                    ${history.map(song => `
                        <div class="collection-item" onclick="playHistoryItem('${song.trackId}')">
                            <img class="collection-item-cover" src="${(song.artworkUrl100 || song.artworkUrl || '').replace('100x100bb', '300x300bb')}" alt="">
                            <div class="collection-item-title">${escapeHtml(song.trackName)}</div>
                            <div class="collection-item-artist">${escapeHtml(song.artistName)}</div>
                            <div class="collection-item-time">${formatDate(song.playedAt)}</div>
                            <button class="collection-item-remove" onclick="event.stopPropagation(); removeHistory('${song.trackId}')" title="Âà†Èô§">√ó</button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Êí≠ÊîæÂéÜÂè≤‰∏≠ÁöÑÊ≠åÊõ≤
        function playHistoryItem(trackId) {
            const history = HistoryManager.getAll();
            const song = history.find(s => s.trackId == trackId);
            if (song) {
                // Â∞ÜÊ≠åÊõ≤Ê∑ªÂä†Âà∞Êí≠ÊîæÂàóË°®Âπ∂Êí≠Êîæ
                state.playlist = [song];
                state.currentIndex = 0;
                playSong(0);
                closeHistory();
            }
        }

        // Âà†Èô§ÂéÜÂè≤ËÆ∞ÂΩï
        function removeHistory(trackId) {
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ÂéÜÂè≤ËÆ∞ÂΩïÂêóÔºü')) {
                HistoryManager.remove(trackId);
                renderHistory();
                showToast('Â∑≤Âà†Èô§');
            }
        }

        // Ê∏ÖÁ©∫ÂéÜÂè≤
        function clearHistory() {
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÊí≠ÊîæÂéÜÂè≤ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ')) {
                HistoryManager.clear();
                renderHistory();
                showToast('ÂéÜÂè≤ËÆ∞ÂΩïÂ∑≤Ê∏ÖÁ©∫');
            }
        }

        // ÂØºÂá∫ÂéÜÂè≤
        function exportHistory() {
            const history = HistoryManager.getAll();
            if (history.length === 0) {
                alert('ÊöÇÊó†ÂéÜÂè≤ËÆ∞ÂΩïÂèØÂØºÂá∫');
                return;
            }
            HistoryManager.export();
            showToast('ÂéÜÂè≤ËÆ∞ÂΩïÂ∑≤ÂØºÂá∫');
        }

        // ÂØºÂÖ•ÂéÜÂè≤
        function importHistory() {
            const input = $('import-file-input');
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const count = await HistoryManager.import(file);
                        renderHistory();
                        showToast(`ÊàêÂäüÂØºÂÖ• ${count} Êù°ÂéÜÂè≤ËÆ∞ÂΩï`);
                    } catch (err) {
                        alert('ÂØºÂÖ•Â§±Ë¥•Ôºö' + err.message);
                    }
                }
                input.value = '';
            };
            input.click();
        }

        // ÊâìÂºÄÊî∂ËóèÂàóË°®
        function openFavorites() {
            $('favorites-modal').classList.add('show');
            renderFavorites();
        }

        // ÂÖ≥Èó≠Êî∂ËóèÂàóË°®
        function closeFavorites() {
            $('favorites-modal').classList.remove('show');
        }

        // Ê∏≤ÊüìÊî∂ËóèÂàóË°®
        function renderFavorites() {
            const favorites = FavoritesManager.getAll();
            const container = $('favorites-content');

            if (favorites.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚ù§Ô∏è</div>
                        <div class="empty-title">ÊöÇÊó†Êî∂Ëóè</div>
                        <div class="empty-desc">ÁÇπÂáªÊí≠ÊîæÂô®‰∏≠ÁöÑÁà±ÂøÉÊåâÈíÆÊî∂ËóèÊ≠åÊõ≤</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="collection-grid">
                    ${favorites.map(song => `
                        <div class="collection-item" onclick="playFavoriteItem('${song.trackId}')">
                            <img class="collection-item-cover" src="${(song.artworkUrl100 || song.artworkUrl || '').replace('100x100bb', '300x300bb')}" alt="">
                            <div class="collection-item-title">${escapeHtml(song.trackName)}</div>
                            <div class="collection-item-artist">${escapeHtml(song.artistName)}</div>
                            <div class="collection-item-time">${formatDate(song.favoritedAt)}</div>
                            <button class="collection-item-remove" onclick="event.stopPropagation(); removeFavorite('${song.trackId}')" title="ÂèñÊ∂àÊî∂Ëóè">√ó</button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Êí≠ÊîæÊî∂Ëóè‰∏≠ÁöÑÊ≠åÊõ≤
        function playFavoriteItem(trackId) {
            const favorites = FavoritesManager.getAll();
            const song = favorites.find(s => s.trackId == trackId);
            if (song) {
                // Â∞ÜÊ≠åÊõ≤Ê∑ªÂä†Âà∞Êí≠ÊîæÂàóË°®Âπ∂Êí≠Êîæ
                state.playlist = [song];
                state.currentIndex = 0;
                playSong(0);
                closeFavorites();
            }
        }

        // ÂèñÊ∂àÊî∂Ëóè
        function removeFavorite(trackId) {
            if (confirm('Á°ÆÂÆöË¶ÅÂèñÊ∂àÊî∂ËóèËøôÈ¶ñÊ≠åÂêóÔºü')) {
                FavoritesManager.remove(trackId);
                renderFavorites();
                updateFavoriteButton();
                showToast('Â∑≤ÂèñÊ∂àÊî∂Ëóè');
            }
        }

        // Ê∏ÖÁ©∫Êî∂Ëóè
        function clearFavorites() {
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÊî∂ËóèÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ')) {
                FavoritesManager.clear();
                renderFavorites();
                updateFavoriteButton();
                showToast('Êî∂ËóèÂ∑≤Ê∏ÖÁ©∫');
            }
        }

        // ÂØºÂá∫Êî∂Ëóè
        function exportFavorites() {
            const favorites = FavoritesManager.getAll();
            if (favorites.length === 0) {
                alert('ÊöÇÊó†Êî∂ËóèÂèØÂØºÂá∫');
                return;
            }
            FavoritesManager.export();
            showToast('Êî∂ËóèÂ∑≤ÂØºÂá∫');
        }

        // ÂØºÂÖ•Êî∂Ëóè
        function importFavorites() {
            const input = $('import-file-input');
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const count = await FavoritesManager.import(file);
                        renderFavorites();
                        updateFavoriteButton();
                        showToast(`ÊàêÂäüÂØºÂÖ• ${count} È¶ñÊî∂Ëóè`);
                    } catch (err) {
                        alert('ÂØºÂÖ•Â§±Ë¥•Ôºö' + err.message);
                    }
                }
                input.value = '';
            };
            input.click();
        }

        // Ê†ºÂºèÂåñÊó•Êúü
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;

            // Â∞è‰∫é1ÂàÜÈíü
            if (diff < 60000) {
                return 'ÂàöÂàö';
            }
            // Â∞è‰∫é1Â∞èÊó∂
            if (diff < 3600000) {
                return Math.floor(diff / 60000) + 'ÂàÜÈíüÂâç';
            }
            // Â∞è‰∫é1Â§©
            if (diff < 86400000) {
                return Math.floor(diff / 3600000) + 'Â∞èÊó∂Ââç';
            }
            // Â∞è‰∫é7Â§©
            if (diff < 604800000) {
                return Math.floor(diff / 86400000) + 'Â§©Ââç';
            }
            // ÊòæÁ§∫ÂÖ∑‰ΩìÊó•Êúü
            return date.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' });
        }

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(() => {
                    deferredPrompt = null;
                    document.querySelector('.install-prompt')?.remove();
                });
            }
        }
    </script>
</body>

</html>