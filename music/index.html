<!DOCTYPE html>
<html lang="zh-CN" data-theme="default">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ÂπøÂ±±Èü≥‰πê</title>

    <!-- PWA  Ê†∏ÂøÉÈÖçÁΩÆ -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#0a0a0a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ÂπøÂ±±Èü≥‰πê">

    <!-- ÂõæÊ†áÈÖçÁΩÆ -->
    <link rel="icon" type="image/x-icon" href="./icon/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="./icon/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./icon/icon-16x16.png">
    <link rel="apple-touch-icon" href="./icon/apple-touch-icon.png">

    <style>
        :root {
            /* ÈªòËÆ§‰∏ªÈ¢ò (Dark Green) */
            --primary: #1db954;
            --primary-dark: #1aa34a;
            --accent: #ff6b6b;
            --bg: #0a0a0a;
            --card: #161616;
            --card-hover: #1f1f1f;
            --text: #ffffff;
            --text-secondary: #a0a0a0;
            --glass: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.1);
            --player-bg: rgba(10, 10, 10, 0.95);
            --player-gradient: linear-gradient(to top, rgba(10, 10, 10, 1) 0%, rgba(10, 10, 10, 0.95) 50%, transparent 100%);
            --header-bg: rgba(10, 10, 10, 0.8);
            --grad-1: var(--primary);
            --grad-2: #6366f1;
            --grad-3: #ec4899;
            
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        /* ÊûÅÁÆÄÁôΩ (Light) */
        [data-theme="light"] {
            --primary: #fa233b;
            --primary-dark: #d61e32;
            --accent: #5e5ce6;
            --bg: #f2f2f7;
            --card: #ffffff;
            --card-hover: #f9f9f9;
            --text: #1d1d1f;
            --text-secondary: #86868b;
            --glass: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(0, 0, 0, 0.05);
            --player-bg: rgba(255, 255, 255, 0.9);
            --player-gradient: linear-gradient(to top, rgba(242, 242, 247, 1) 0%, rgba(242, 242, 247, 0.95) 50%, transparent 100%);
            --header-bg: rgba(242, 242, 247, 0.8);
            --grad-1: rgba(250, 35, 59, 0.3);
            --grad-2: rgba(94, 92, 230, 0.3);
            --grad-3: rgba(255, 149, 0, 0.3);
        }

        /* Ê∑±Êµ∑Ëìù (Ocean) */
        [data-theme="ocean"] {
            --primary: #00d2ff;
            --primary-dark: #00a8cc;
            --accent: #3a7bd5;
            --bg: #0f172a;
            --card: #1e293b;
            --card-hover: #334155;
            --text: #f8fafc;
            --text-secondary: #94a3b8;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.08);
            --player-bg: rgba(15, 23, 42, 0.95);
            --player-gradient: linear-gradient(to top, rgba(15, 23, 42, 1) 0%, rgba(15, 23, 42, 0.95) 50%, transparent 100%);
            --header-bg: rgba(15, 23, 42, 0.8);
            --grad-1: #3a7bd5;
            --grad-2: #00d2ff;
            --grad-3: #8e2de2;
        }

        /* ËµõÂçöÁ¥´ (Cyber) */
        [data-theme="cyber"] {
            --primary: #d946ef;
            --primary-dark: #c026d3;
            --accent: #22d3ee;
            --bg: #120b18;
            --card: #271a33;
            --card-hover: #362247;
            --text: #fae8ff;
            --text-secondary: #d8b4fe;
            --glass: rgba(217, 70, 239, 0.1);
            --glass-border: rgba(217, 70, 239, 0.2);
            --player-bg: rgba(18, 11, 24, 0.95);
            --player-gradient: linear-gradient(to top, rgba(18, 11, 24, 1) 0%, rgba(18, 11, 24, 0.95) 50%, transparent 100%);
            --header-bg: rgba(18, 11, 24, 0.8);
            --grad-1: #d946ef;
            --grad-2: #8b5cf6;
            --grad-3: #22d3ee;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        /* Ensure input elements work properly in PWA */
        input, textarea, select {
            -webkit-user-select: auto;
            -moz-user-select: auto;
            -ms-user-select: auto;
            user-select: auto;
            -webkit-touch-callout: default;
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
        }

        /* Ëá™ÂÆö‰πâÊªöÂä®Êù° */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(128, 128, 128, 0.2);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(128, 128, 128, 0.4);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
            position: relative;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* Âä®ÊÄÅËÉåÊôØ */
        .bg-gradient {
            position: fixed;
            inset: 0;
            z-index: 0;
            opacity: 0.6;
            transition: opacity 0.8s ease;
            background: radial-gradient(ellipse at 50% 0%, var(--grad-1) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 50%, var(--grad-2) 0%, transparent 40%),
                radial-gradient(ellipse at 20% 80%, var(--grad-3) 0%, transparent 40%);
            filter: blur(80px) saturate(150%);
        }

        .bg-album {
            position: fixed;
            inset: 0;
            z-index: 0;
            background-size: cover;
            background-position: center;
            opacity: 0;
            transition: opacity 1s ease;
            filter: blur(60px) brightness(0.4) saturate(120%);
        }

        /* ‰∫ÆËâ≤Ê®°Âºè‰∏ãÂáèÂº±‰∏ìËæëËÉåÊôØÁöÑ‰∫ÆÂ∫¶ÂΩ±Âìç */
        [data-theme="light"] .bg-album {
            filter: blur(60px) brightness(1.2) saturate(120%) opacity(0.3);
        }

        .bg-album.active {
            opacity: 0.7;
        }

        /* È°∂ÈÉ®ÊêúÁ¥¢Ê†è  */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: calc(8px + var(--safe-top)) 16px 8px;
            background: linear-gradient(to bottom, var(--header-bg) 0%, rgba(var(--bg), 0.8) 70%, transparent 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .search-box {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .search-input {
            width: 100%;
            height: 40px;
            padding: 0 40px 0 18px;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            background: var(--glass);
            color: var(--text);
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
            -webkit-appearance: none;
            -moz-appearance: textfield;
            appearance: none;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            cursor: text;
        }

        .search-input:focus {
            border-color: var(--primary);
            background: var(--card);
            outline: 2px solid var(--primary);
            outline-offset: -1px;
        }

        .search-input-container {
            position: relative;
            cursor: text;
            flex: 1;
            min-width: 120px;
            max-width: 500px;
        }

        .search-input-container:focus-within {
            z-index: 2;
        }

        .search-input::placeholder {
            color: var(--text-secondary);
        }

        .search-clear-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .more-menu-btn {
            background: transparent;
            border: none;
            color: var(--text);
            cursor: pointer;
            font-size: 18px;
            padding: 8px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .more-menu-btn:hover {
            background: var(--glass-border);
        }

        .more-menu {
            position: absolute;
            top: 45px;
            right: 0;
            background: var(--card);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            padding: 8px 0;
            min-width: 160px;
            z-index: 1000;
            display: none;
        }

        .more-menu.visible {
            display: block;
        }

        .more-menu-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: var(--text);
            text-decoration: none;
            font-size: 14px;
            gap: 10px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .more-menu-item:hover {
            background: var(--card-hover);
        }

        .search-clear-btn:hover {
            background: var(--glass-border);
            color: var(--text);
        }

        .btn {
            height: 40px;
            padding: 0 18px;
            border-radius: 20px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: var(--text);
            font-size: 18px;
            flex-shrink: 0;
        }

        .btn-icon:hover {
            background: var(--glass-border);
            color: var(--primary);
        }

        /* ÂÜÖÂÆπÂå∫ */
        .content {
            position: relative;
            z-index: 1;
            padding: calc(72px + var(--safe-top)) 16px calc(200px + var(--safe-bottom));
            min-height: 100vh;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
        }

        /* Ê≠åÊõ≤Âç°Áâá */
        .song-card {
            background: var(--card);
            border-radius: 12px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            position: relative;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .song-options {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .song-card:hover .song-options {
            opacity: 1;
        }

        .song-duration {
            position: absolute;
            top: 8px;
            right: 36px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            z-index: 5;
            pointer-events: none;
        }

        .song-card:hover {
            background: var(--card-hover);
            transform: translateY(-4px);
            border-color: var(--glass-border);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .song-card:active {
            transform: scale(0.98);
        }

        .song-card.playing {
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(var(--primary), 0.3);
        }
        
        /* Fix for box-shadow color parsing if primary is hex */
        [data-theme="default"] .song-card.playing { box-shadow: 0 0 20px rgba(29, 185, 84, 0.3); }
        [data-theme="light"] .song-card.playing { box-shadow: 0 0 20px rgba(250, 35, 59, 0.3); }
        [data-theme="ocean"] .song-card.playing { box-shadow: 0 0 20px rgba(0, 210, 255, 0.3); }
        [data-theme="cyber"] .song-card.playing { box-shadow: 0 0 20px rgba(217, 70, 239, 0.3); }

        .song-cover {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 12px;
            object-fit: cover;
            background: #222;
            margin-bottom: 8px;
            position: relative;
            overflow: hidden;
        }

        .song-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .song-card:hover .song-cover img {
            transform: scale(1.05);
        }

        .play-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .song-card:hover .play-overlay,
        .song-card.playing .play-overlay {
            opacity: 1;
        }

        .play-overlay-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .song-title {
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 2px;
            color: var(--text);
        }

        .song-artist {
            font-size: 11px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ‰∏§ÂàóÁªìÊûúÂ∏ÉÂ±Ä */
        .results-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            width: 100%;
        }

        .results-column {
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .simple-header {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            padding-left: 4px;
        }

        .empty-message {
            grid-column: 1/-1;
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .results-columns {
                gap: 12px;
            }
            .results-column .grid {
                grid-template-columns: 1fr;
            }
        }

        /* Â∫ïÈÉ®Êí≠ÊîæÂô® - ÂÖ®Êñ∞ËÆæËÆ° */
        .player {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 0 16px calc(16px + var(--safe-bottom));
            background: var(--player-gradient);
            pointer-events: none;
        }

        /* ÂµåÂÖ•ÂºèÊí≠ÊîæÂô®Ê®°Âºè */
        .player.embedded {
            position: relative;
            bottom: auto;
            top: 0;
            padding: 20px;
            margin: 0 auto;
            max-width: 400px;
            background: var(--bg);
        }

        .player.embedded .player-card {
            border-radius: 16px;
            margin: 0 auto;
        }

        body.embedded-mode {
            background: var(--bg);
            overflow: hidden;
        }

        .player-card {
            background: var(--card);
            border-radius: 24px;
            padding: 12px 16px 16px;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            pointer-events: auto;
        }

        /* È°∂ÈÉ®‰ø°ÊÅØÊ†è */
        .player-info-bar {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 12px;
            padding: 8px 12px;
            background: var(--glass);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .player-label {
            font-size: 12px;
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .player-text-wrapper {
            overflow: hidden;
            white-space: nowrap;
            flex-shrink: 1;
            min-width: 0;
            position: relative;
        }

        .title-wrapper {
            max-width: 200px;
        }

        .artist-wrapper {
            max-width: 150px;
        }

        .player-title-text {
            display: inline-block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            cursor: pointer;
            transition: color 0.2s ease;
            white-space: nowrap;
        }

        .player-title-text:hover {
            color: var(--primary);
        }

        .player-separator {
            font-size: 12px;
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .player-artist-text {
            display: inline-block;
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.2s ease;
            white-space: nowrap;
        }

        .player-artist-text:hover {
            color: var(--primary);
        }

        /* ÂìçÂ∫îÂºèË∞ÉÊï¥ */
        @media (max-width: 767px) {
            .title-wrapper {
                max-width: 120px;
            }

            .artist-wrapper {
                max-width: 100px;
            }
        }

        .player-wiki-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
            padding: 0;
            margin-left: auto;
        }

        .player-wiki-btn:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
        }

        /* ÊªöÂä®Âä®Áîª */
        .scroll-text {
            animation: scroll-left var(--duration, 10s) linear infinite alternate;
        }

        @keyframes scroll-left {
            0%, 10% { transform: translateX(0); }
            90%, 100% { transform: translateX(var(--scroll-distance, -50%)); }
        }

        /* ‰∏ªÊéßÂà∂Âå∫ */
        .player-main {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .player-cover {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            object-fit: cover;
            background: #222;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            cursor: pointer;
        }

        .player-cover.spinning {
            animation: spin 8s linear infinite;
            border-radius: 50%;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(-360deg); }
        }

        .player-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
            margin-left: auto;
        }

        .ctrl-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: var(--text);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            opacity: 0.8;
            border: 1px solid transparent;
        }
        
        [data-theme="default"] .ctrl-btn { border-color: rgba(255,255,255,0.1); }
        [data-theme="light"] .ctrl-btn { border-color: rgba(0,0,0,0.05); }

        .ctrl-btn:hover {
            background: var(--glass);
            color: var(--primary);
            opacity: 1;
            transform: scale(1.1);
        }

        .ctrl-btn:active {
            transform: scale(0.95);
        }

        .ctrl-btn.play {
            width: 56px;
            height: 56px;
            background: var(--primary);
            color: white;
            font-size: 24px;
            opacity: 1;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .ctrl-btn.play:hover {
            background: var(--primary-dark);
            transform: scale(1.08);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        /* ËøõÂ∫¶Êù° */
        .progress-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .time {
            font-size: 11px;
            color: var(--text-secondary);
            min-width: 36px;
            text-align: center;
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background: var(--glass-border);
            border-radius: 2px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        [data-theme="default"] .progress-bar { background: rgba(255,255,255,0.1); }
        [data-theme="light"] .progress-bar { background: rgba(0,0,0,0.1); }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            border-radius: 2px;
            transition: width 0.1s linear;
        }

        /* Ê≠åËØçËØ¶ÊÉÖÈ°µ */
        .lyrics-modal {
            position: fixed;
            inset: 0;
            z-index: 200;
            background: var(--bg);
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            overflow-y: auto;
            padding: calc(60px + var(--safe-top)) 24px calc(24px + var(--safe-bottom));
        }

        .lyrics-modal.show {
            transform: translateY(0);
        }

        .lyrics-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: calc(16px + var(--safe-top)) 24px 16px;
            background: linear-gradient(to bottom, var(--bg) 0%, transparent 100%);
            z-index: 10;
        }

        .lyrics-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--glass);
            border: none;
            color: var(--text);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lyrics-cover {
            width: 200px;
            height: 200px;
            border-radius: 20px;
            margin: 0 auto 24px;
            display: block;
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.5);
        }

        .lyrics-title {
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 8px;
            color: var(--text);
        }

        .lyrics-artist {
            font-size: 16px;
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 32px;
            display: inline-block;
        }

        .lyrics-artist-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 32px;
        }

        .lyrics-artist.clickable:hover {
            color: var(--primary);
        }

        .lyrics-wiki {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            border-left: 3px solid var(--primary);
            display: none;
        }

        .lyrics-wiki.show {
            display: block;
        }

        .lyrics-wiki-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .lyrics-wiki-text {
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .lyrics-text {
            font-size: 18px;
            line-height: 2;
            color: var(--text-secondary);
            text-align: center;
            white-space: pre-wrap;
        }

        /* ÂºπÂπï */
        .danmaku {
            position: fixed;
            top: calc(100px + var(--safe-top));
            left: 0;
            right: 0;
            height: 200px;
            z-index: 50;
            pointer-events: none;
            overflow: hidden;
            mask-image: linear-gradient(to bottom, transparent, black 15%, black 85%, transparent);
            -webkit-mask-image: linear-gradient(to bottom, transparent, black 15%, black 85%, transparent);
            display: none;
        }

        .danmaku.show {
            display: block;
        }

        .danmaku-item {
            position: absolute;
            left: 100%;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            white-space: nowrap;
            animation: danmaku-slide linear forwards;
        }
        
        [data-theme="light"] .danmaku-item {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .danmaku-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }

        .danmaku-name {
            color: var(--primary);
            font-weight: 600;
            font-size: 13px;
        }

        .danmaku-text {
            font-size: 13px;
            color: white;
        }
        
        [data-theme="light"] .danmaku-text { color: #333; }

        @keyframes danmaku-slide {
            from { transform: translateX(0); }
            to { transform: translateX(calc(-100% - 100vw)); }
        }

        /* Á©∫Áä∂ÊÄÅ */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
        }

        .empty-desc {
            font-size: 14px;
            line-height: 1.6;
        }

        /* Âä†ËΩΩÁä∂ÊÄÅ */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--glass-border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: loading-spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes loading-spin {
            to { transform: rotate(360deg); }
        }

        /* Êé®ËçêÊ†áÁ≠æÊ†∑Âºè */
        .recommendation-tag {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: var(--text);
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .recommendation-tag:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: scale(1.05);
        }

        /* Êî∂ËóèÂíåÂéÜÂè≤ÂºπÁ™ó */
        .collection-modal {
            position: fixed;
            inset: 0;
            z-index: 200;
            background: var(--bg);
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .collection-modal.show {
            transform: translateY(0);
        }

        .collection-header {
            position: sticky;
            top: 0;
            padding: calc(20px + var(--safe-top)) 24px 20px;
            background: linear-gradient(to bottom, var(--bg) 0%, var(--header-bg) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--glass-border);
        }

        .collection-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text);
        }

        .collection-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn-action {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: var(--text);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .btn-action:hover {
            background: var(--glass-border);
            transform: scale(1.1);
        }

        .collection-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--glass);
            border: none;
            color: var(--text);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .collection-close:hover {
            background: var(--accent);
            color: white;
        }

        .collection-content {
            flex: 1;
            padding: 24px;
            padding-bottom: calc(24px + var(--safe-bottom));
        }

        .collection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
        }

        .collection-item {
            background: var(--card);
            border-radius: 12px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            position: relative;
        }

        .collection-item:hover {
            background: var(--card-hover);
            transform: translateY(-4px);
            border-color: var(--glass-border);
        }

        .collection-item-cover {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 12px;
            object-fit: cover;
            background: #222;
            margin-bottom: 8px;
        }

        .collection-item-title {
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 2px;
            color: var(--text);
        }

        .collection-item-artist {
            font-size: 11px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .collection-item-time {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .collection-item-remove {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(255, 107, 107, 0.9);
            color: white;
            border: none;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .collection-item:hover .collection-item-remove {
            opacity: 1;
        }

        /* ‰∏ªÈ¢òÂàáÊç¢ÂºπÁ™ó */
        .theme-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: var(--card);
            padding: 24px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            z-index: 1000;
            min-width: 300px;
            border: 1px solid var(--glass-border);
            opacity: 0;
            pointer-events: none;
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .theme-modal.visible {
            opacity: 1;
            pointer-events: auto;
            transform: translate(-50%, -50%) scale(1);
        }

        .theme-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }
        
        .theme-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .theme-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
            color: var(--text);
        }

        .theme-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .theme-btn {
            padding: 12px;
            border-radius: 12px;
            border: 2px solid transparent;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            background: var(--glass);
            transition: all 0.2s ease;
        }

        .theme-btn:hover {
            transform: scale(1.05);
        }

        .theme-btn.active {
            border-color: var(--primary);
            background: var(--glass-border);
        }

        .theme-preview {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.2);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .theme-name {
            font-size: 13px;
            color: var(--text);
        }

        /* ÂìçÂ∫îÂºè */
        @media (max-width: 767px) {
            .grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
                gap: 10px;
            }

            .song-card {
                padding: 6px;
                width: 100%;
                min-width: 0;
            }

            .content {
                padding-left: 12px;
                padding-right: 12px;
            }
        }

        @media (min-width: 768px) {
            .grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }

            .player-card {
                max-width: 600px;
                margin: 0 auto;
            }
        }
    </style>
</head>

<body>
    <!-- ËÉåÊôØ -->
    <div class="bg-gradient"></div>
    <div class="bg-album" id="bg-album"></div>

    <!-- È°∂ÈÉ®ÊêúÁ¥¢ -->
    <header class="header">
        <div class="search-box">
            <div class="search-input-container" id="search-input-container" style="display: none;">
                <input type="search" class="search-input" id="search-input" placeholder="Ê≠åÊâã/Ê≠åÊõ≤..." inputmode="text" enterkeyhint="search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" required>
                <button class="search-clear-btn" id="search-clear-btn" title="Ê∏ÖÁ©∫ÊêúÁ¥¢" style="display: none;">‚úï</button>
            </div>
            <button class="btn btn-icon" onclick="smartRandomSearch()" title="Êô∫ËÉΩÊé¢Á¥¢">üé≤</button>
            <button class="btn btn-icon" onclick="openHistory()" title="Êí≠ÊîæÂéÜÂè≤">üìñ</button>
            <button class="btn btn-icon" onclick="openFavorites()" title="ÊàëÁöÑÊî∂Ëóè">‚ù§Ô∏è</button>
            <button class="btn btn-icon" onclick="openThemeModal()" title="ÂàáÊç¢‰∏ªÈ¢ò">üé®</button>
            <button class="more-menu-btn" id="more-menu-btn" title="Êõ¥Â§öÂäüËÉΩ">‚ãØ</button>
            <div class="more-menu" id="more-menu">
                <div class="more-menu-item" onclick="toggleSearchInput(event)" title="ÊêúÁ¥¢">
                    <span>üîç</span>
                    <span>ÊêúÁ¥¢</span>
                </div>
                <div class="more-menu-item" onclick="searchByWeather()" title="ÁúãÂ§©Âê¨Ê≠å">
                    <span>üå§Ô∏è</span>
                    <span>ÁúãÂ§©Âê¨Ê≠å</span>
                </div>
            </div>
        </div>
    </header>

    <!-- ÂÜÖÂÆπÂå∫ -->
    <main class="content">
        <div class="grid" id="results">
            <div class="empty-state" style="grid-column: 1/-1;">
                <div class="empty-icon">üéß</div>
                <div class="empty-title">ÂèëÁé∞Èü≥‰πê</div>
                <div class="empty-desc">ÁÇπÂáª üé≤ ÈöèÊú∫Êé¢Á¥¢ÔºåÊàñÊêúÁ¥¢‰Ω†ÂñúÊ¨¢ÁöÑÊ≠åÊõ≤</div>
            </div>
        </div>
    </main>

    <!-- ÂºπÂπï -->
    <div class="danmaku" id="danmaku"></div>

    <!-- Â∫ïÈÉ®Êí≠ÊîæÂô® -->
    <div class="player">
        <div class="player-card">
            <!-- È°∂ÈÉ®Ê≠åÊõ≤‰ø°ÊÅØÊ†è -->
            <div class="player-info-bar">
                <span class="player-label">Ê≠£Âú®Êí≠ÊîæÔºö</span>
                <div class="player-text-wrapper title-wrapper">
                    <span class="player-title-text" id="player-title-text">ÂπøÂ±±Èü≥‰πê</span>
                </div>
                <span class="player-separator">-</span>
                <div class="player-text-wrapper artist-wrapper">
                    <span class="player-artist-text" id="player-artist-text">Á≠âÂæÖÊí≠Êîæ</span>
                </div>
                <button class="player-wiki-btn" id="player-tag-btn" title="Êü•ÁúãÊ≠åÊõ≤Ê†áÁ≠æÊé®Ëçê"
                    style="display: none; margin-right: 8px;">üè∑Ô∏è</button>
                <button class="player-wiki-btn" id="player-wiki-btn" title="Êü•ÁúãËâ∫ÊúØÂÆ∂Áª¥Âü∫ÁôæÁßë"
                    style="display: none;">üìñ</button>
            </div>

            <!-- ‰∏ªÊéßÂà∂Âå∫ -->
            <div class="player-main">
                <img class="player-cover" id="player-cover"
                    src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%23222' width='100' height='100'/%3E%3Ccircle cx='50' cy='50' r='30' fill='none' stroke='%23333' stroke-width='2'/%3E%3Ccircle cx='50' cy='50' r='10' fill='%23333'/%3E%3C/svg%3E"
                    alt="Cover">
                <button class="ctrl-btn favorite-btn" id="favorite-btn" onclick="toggleFavorite()"
                    title="Êî∂Ëóè">ü§ç</button>
                <div class="player-controls">
                    <button class="ctrl-btn" id="mode-btn" onclick="togglePlayMode()" title="ÂàóË°®Âæ™ÁéØ">üîÅ</button>
                    <button class="ctrl-btn" onclick="playPrevious()">‚èÆ</button>
                    <button class="ctrl-btn play" id="play-btn" onclick="togglePlay()">‚ñ∂</button>
                    <button class="ctrl-btn" onclick="playNext()">‚è≠</button>
                </div>
            </div>

            <!-- ËøõÂ∫¶Êù° -->
            <div class="progress-container">
                <span class="time" id="current-time">0:00</span>
                <div class="progress-bar" id="progress-bar" onclick="seek(event)">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <span class="time" id="total-time">0:30</span>
            </div>

            <!-- Êé®ËçêÊ†áÁ≠æÂå∫ -->
            <div class="recommendation-tags" id="recommendation-tags" style="margin-top: 12px; display: none;">
                <div class="player-label" style="margin-bottom: 6px;">Áõ∏ÂÖ≥Êé®ËçêÔºö</div>
                <div class="recommendation-tags-container" id="recommendation-tags-container"
                    style="display: flex; flex-wrap: wrap; gap: 6px; max-height: 40px; overflow-y: auto;"></div>
                <div class="show-more-recommendations" id="show-more-recommendations"
                    style="margin-top: 6px; color: var(--primary); font-size: 12px; cursor: pointer; display: none;">
                    Â±ïÂºÄÊõ¥Â§öÊé®Ëçê</div>
            </div>
        </div>
    </div>

    <!-- Ê≠åËØçËØ¶ÊÉÖ -->
    <div class="lyrics-modal" id="lyrics-modal">
        <div class="lyrics-header">
            <button class="lyrics-close" onclick="closeLyrics()">‚úï</button>
        </div>
        <img class="lyrics-cover" id="lyrics-cover" src="" alt="">
        <h2 class="lyrics-title" id="lyrics-title"></h2>
        <div class="lyrics-artist-container">
            <p class="lyrics-artist clickable" id="lyrics-artist" style="cursor: pointer; text-decoration: underline;"
                title="ÁÇπÂáªËÆøÈóÆÁª¥Âü∫ÁôæÁßë"></p>
        </div>
        <div class="lyrics-wiki" id="lyrics-wiki">
            <div class="lyrics-wiki-title" id="wiki-title"></div>
            <div class="lyrics-wiki-text" id="wiki-text"></div>
        </div>
        <div class="lyrics-text" id="lyrics-text">Âä†ËΩΩ‰∏≠...</div>
    </div>

    <!-- ÂéÜÂè≤ËÆ∞ÂΩïÂºπÁ™ó -->
    <div class="collection-modal" id="history-modal">
        <div class="collection-header">
            <h2 class="collection-title">üìñ Êí≠ÊîæÂéÜÂè≤</h2>
            <div class="collection-actions">
                <button class="btn-action" onclick="exportHistory()" title="ÂØºÂá∫ÂéÜÂè≤">üì§</button>
                <button class="btn-action" onclick="importHistory()" title="ÂØºÂÖ•ÂéÜÂè≤">üì•</button>
                <button class="btn-action" onclick="clearHistory()" title="Ê∏ÖÁ©∫ÂéÜÂè≤">üóëÔ∏è</button>
                <button class="collection-close" onclick="closeHistory()">‚úï</button>
            </div>
        </div>
        <div class="collection-content" id="history-content">
            <div class="empty-state">
                <div class="empty-icon">üìñ</div>
                <div class="empty-title">ÊöÇÊó†Êí≠ÊîæÂéÜÂè≤</div>
                <div class="empty-desc">ÂºÄÂßãÊí≠ÊîæÈü≥‰πêÂêé‰ºöËá™Âä®ËÆ∞ÂΩï</div>
            </div>
        </div>
    </div>

    <!-- Êî∂ËóèÂàóË°®ÂºπÁ™ó -->
    <div class="collection-modal" id="favorites-modal">
        <div class="collection-header">
            <h2 class="collection-title">‚ù§Ô∏è ÊàëÁöÑÊî∂Ëóè</h2>
            <div class="collection-actions">
                <button class="btn-action" onclick="exportFavorites()" title="ÂØºÂá∫Êî∂Ëóè">üì§</button>
                <button class="btn-action" onclick="importFavorites()" title="ÂØºÂÖ•Êî∂Ëóè">üì•</button>
                <button class="btn-action" onclick="clearFavorites()" title="Ê∏ÖÁ©∫Êî∂Ëóè">üóëÔ∏è</button>
                <button class="collection-close" onclick="closeFavorites()">‚úï</button>
            </div>
        </div>
        <div class="collection-content" id="favorites-content">
            <div class="empty-state">
                <div class="empty-icon">‚ù§Ô∏è</div>
                <div class="empty-title">ÊöÇÊó†Êî∂Ëóè</div>
                <div class="empty-desc">ÁÇπÂáªÊí≠ÊîæÂô®‰∏≠ÁöÑÁà±ÂøÉÊåâÈíÆÊî∂ËóèÊ≠åÊõ≤</div>
            </div>
        </div>
    </div>

    <!-- ‰∏ªÈ¢òÂàáÊç¢ÂºπÁ™ó -->
    <div class="theme-overlay" id="theme-overlay" onclick="closeThemeModal()"></div>
    <div class="theme-modal" id="theme-modal">
        <div class="theme-title">ÈÄâÊã©‰∏ªÈ¢ò</div>
        <div class="theme-grid">
            <div class="theme-btn" onclick="changeTheme('default')" data-theme-btn="default">
                <div class="theme-preview" style="background: linear-gradient(135deg, #0a0a0a, #1db954);"></div>
                <span class="theme-name">ÊöóÂ§úÁªø</span>
            </div>
            <div class="theme-btn" onclick="changeTheme('light')" data-theme-btn="light">
                <div class="theme-preview" style="background: linear-gradient(135deg, #ffffff, #fa233b);"></div>
                <span class="theme-name">ÊûÅÁÆÄÁôΩ</span>
            </div>
            <div class="theme-btn" onclick="changeTheme('ocean')" data-theme-btn="ocean">
                <div class="theme-preview" style="background: linear-gradient(135deg, #0f172a, #00d2ff);"></div>
                <span class="theme-name">Ê∑±Êµ∑Ëìù</span>
            </div>
            <div class="theme-btn" onclick="changeTheme('cyber')" data-theme-btn="cyber">
                <div class="theme-preview" style="background: linear-gradient(135deg, #120b18, #d946ef);"></div>
                <span class="theme-name">ËµõÂçöÁ¥´</span>
            </div>
        </div>
    </div>

    <!-- ÈöêËóèÁöÑÊñá‰ª∂ËæìÂÖ•Ê°Ü -->
    <input type="file" id="import-file-input" accept=".json" style="display: none;">

    <audio id="audio" crossorigin="anonymous"></audio>

    <!-- YouTube Player Manager -->
    <script src="YouTubePlayerManager.js"></script>

    <script>
        // Áä∂ÊÄÅÁÆ°ÁêÜ
        const state = {
            currentTrack: null,
            playlist: [],
            currentIndex: -1,
            isPlaying: false,
            playMode: 'sequence', // sequence, random, single
            danmakuInterval: null,
            danmakuCache: [],
            tracks: [false, false, false, false, false],
            displayedDanmaku: new Set(),  // Track currently displayed danmaku content to prevent duplicates
            youtubePlayer: null,  // YouTube player instance
            isYouTubePlaying: false,  // Track if YouTube player is currently playing
            youtubeProgressInterval: null,  // Interval for YouTube progress updates
            lastPosition: 0  // Store last playback position when app goes to background
        };

        // URLÂèÇÊï∞Ëß£ÊûêÂáΩÊï∞
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                apple: params.get('apple') === 'true',
                youtube: params.get('youtube') === 'true'
            };
        }

        // ‰∏ªÈ¢òÁÆ°ÁêÜÂô®
        const ThemeManager = {
            STORAGE_KEY: 'music_theme',
            
            init: () => {
                const savedTheme = localStorage.getItem(ThemeManager.STORAGE_KEY) || 'default';
                ThemeManager.set(savedTheme);
            },
            
            set: (theme) => {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem(ThemeManager.STORAGE_KEY, theme);
                
                // Êõ¥Êñ∞ÈÄâ‰∏≠Áä∂ÊÄÅ
                document.querySelectorAll('.theme-btn').forEach(btn => {
                    if (btn.dataset.themeBtn === theme) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            },
            
            get: () => {
                return localStorage.getItem(ThemeManager.STORAGE_KEY) || 'default';
            }
        };

        // ÁºìÂ≠òÁ≥ªÁªü
        const CacheManager = {
            // Ëé∑ÂèñÁºìÂ≠òÁöÑÊï∞ÊçÆ
            get: (key) => {
                try {
                    const cached = localStorage.getItem(key);
                    if (!cached) return null;

                    const parsed = JSON.parse(cached);
                    const now = Date.now();

                    // Ê£ÄÊü•ÊòØÂê¶ËøáÊúü
                    if (parsed.expiry && now > parsed.expiry) {
                        localStorage.removeItem(key);
                        return null;
                    }

                    return parsed.data;
                } catch (e) {
                    console.warn('Cache get error:', e);
                    return null;
                }
            },

            // ËÆæÁΩÆÁºìÂ≠òÊï∞ÊçÆ
            set: (key, data, expiryHours = 24) => {
                try {
                    const expiry = Date.now() + (expiryHours * 60 * 60 * 1000);
                    const cacheObj = {
                        data: data,
                        expiry: expiry
                    };
                    localStorage.setItem(key, JSON.stringify(cacheObj));
                } catch (e) {
                    console.warn('Cache set error:', e);
                }
            },

            // Âà†Èô§ÁºìÂ≠òÊï∞ÊçÆ
            remove: (key) => {
                try {
                    localStorage.removeItem(key);
                } catch (e) {
                    console.warn('Cache remove error:', e);
                }
            }
        };

        // Êî∂ËóèÁÆ°ÁêÜÂô®
        const FavoritesManager = {
            STORAGE_KEY: 'music_favorites',

            // Ëé∑ÂèñÊâÄÊúâÊî∂Ëóè
            getAll: () => {
                try {
                    const data = localStorage.getItem(FavoritesManager.STORAGE_KEY);
                    return data ? JSON.parse(data) : [];
                } catch (e) {
                    console.error('Failed to get favorites:', e);
                    return [];
                }
            },

            // ‰øùÂ≠òÊî∂Ëóè
            save: (favorites) => {
                try {
                    localStorage.setItem(FavoritesManager.STORAGE_KEY, JSON.stringify(favorites));
                } catch (e) {
                    console.error('Failed to save favorites:', e);
                }
            },

            // Ê∑ªÂä†Êî∂Ëóè
            add: (song) => {
                const favorites = FavoritesManager.getAll();
                const exists = favorites.some(f => f.trackId === song.trackId);
                if (!exists) {
                    favorites.unshift({
                        ...song,
                        favoritedAt: Date.now()
                    });
                    FavoritesManager.save(favorites);
                    return true;
                }
                return false;
            },

            // ÁßªÈô§Êî∂Ëóè
            remove: (trackId) => {
                const favorites = FavoritesManager.getAll();
                const filtered = favorites.filter(f => f.trackId !== trackId);
                FavoritesManager.save(filtered);
            },

            // Ê£ÄÊü•ÊòØÂê¶Â∑≤Êî∂Ëóè
            isFavorited: (trackId) => {
                const favorites = FavoritesManager.getAll();
                return favorites.some(f => f.trackId === trackId);
            },

            // Ê∏ÖÁ©∫Êî∂Ëóè
            clear: () => {
                FavoritesManager.save([]);
            },

            // ÂØºÂá∫Êî∂Ëóè
            export: () => {
                const favorites = FavoritesManager.getAll();
                const dataStr = JSON.stringify(favorites, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `music-favorites-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            },

            // ÂØºÂÖ•Êî∂Ëóè
            import: (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (Array.isArray(data)) {
                                FavoritesManager.save(data);
                                resolve(data.length);
                            } else {
                                reject(new Error('Invalid format'));
                            }
                        } catch (err) {
                            reject(err);
                        }
                    };
                    reader.onerror = reject;
                    reader.readAsText(file);
                });
            }
        };

        // ÂéÜÂè≤ËÆ∞ÂΩïÁÆ°ÁêÜÂô®
        const HistoryManager = {
            STORAGE_KEY: 'music_history',
            MAX_ITEMS: 100,

            // Ëé∑ÂèñÊâÄÊúâÂéÜÂè≤
            getAll: () => {
                try {
                    const data = localStorage.getItem(HistoryManager.STORAGE_KEY);
                    return data ? JSON.parse(data) : [];
                } catch (e) {
                    console.error('Failed to get history:', e);
                    return [];
                }
            },

            // ‰øùÂ≠òÂéÜÂè≤
            save: (history) => {
                try {
                    localStorage.setItem(HistoryManager.STORAGE_KEY, JSON.stringify(history));
                } catch (e) {
                    console.error('Failed to save history:', e);
                }
            },

            // Ê∑ªÂä†ÂéÜÂè≤ËÆ∞ÂΩï
            add: (song) => {
                let history = HistoryManager.getAll();
                // ÁßªÈô§ÈáçÂ§çÈ°π
                history = history.filter(h => h.trackId !== song.trackId);
                // Ê∑ªÂä†Âà∞ÂºÄÂ§¥
                history.unshift({
                    ...song,
                    playedAt: Date.now()
                });
                // ÈôêÂà∂Êï∞Èáè
                if (history.length > HistoryManager.MAX_ITEMS) {
                    history = history.slice(0, HistoryManager.MAX_ITEMS);
                }
                HistoryManager.save(history);
            },

            // ÁßªÈô§ÂéÜÂè≤ËÆ∞ÂΩï
            remove: (trackId) => {
                const history = HistoryManager.getAll();
                const filtered = history.filter(h => h.trackId !== trackId);
                HistoryManager.save(filtered);
            },

            // Ê∏ÖÁ©∫ÂéÜÂè≤
            clear: () => {
                HistoryManager.save([]);
            },

            // ÂØºÂá∫ÂéÜÂè≤
            export: () => {
                const history = HistoryManager.getAll();
                const dataStr = JSON.stringify(history, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `music-history-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            },

            // ÂØºÂÖ•ÂéÜÂè≤
            import: (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (Array.isArray(data)) {
                                HistoryManager.save(data);
                                resolve(data.length);
                            } else {
                                reject(new Error('Invalid format'));
                            }
                        } catch (err) {
                            reject(err);
                        }
                    };
                    reader.onerror = reject;
                    reader.readAsText(file);
                });
            }
        };

        // ÁîüÊàêÁºìÂ≠òÈîÆ
        const generateCacheKey = (artist, title) => {
            return `song_${encodeURIComponent(artist)}_${encodeURIComponent(title)}`;
        };

        // DOM ÂÖÉÁ¥†
        const $ = id => document.getElementById(id);
        const audio = $('audio');

        // ÁªëÂÆö‰∫ã‰ª∂
        $('search-input-container').addEventListener('click', () => {
            setTimeout(() => $('search-input').focus(), 150);
        });

        // Êõ¥Â§öËèúÂçïÂäüËÉΩ
        const moreMenuBtn = document.getElementById('more-menu-btn');
        const moreMenu = document.getElementById('more-menu');

        moreMenuBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            moreMenu.classList.toggle('visible');
        });

        // ÁÇπÂáªÈ°µÈù¢ÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠ËèúÂçï
        document.addEventListener('click', (e) => {
            if (!moreMenu.contains(e.target) && e.target !== moreMenuBtn) {
                moreMenu.classList.remove('visible');
            }
        });

        // ÂàáÊç¢ÊêúÁ¥¢Ê°ÜÂèØËßÅÊÄß
        function toggleSearchInput(e) {
            if (e) {
                e.preventDefault();
                e.stopPropagation();
            }
            const searchContainer = $('search-input-container');
            const searchInput = $('search-input');
            const isVisible = searchContainer.style.display !== 'none';

            if (isVisible) {
                searchContainer.style.display = 'none';
            } else {
                searchContainer.style.display = 'block';
                setTimeout(() => {
                    searchInput.focus();
                }, 150); // Â¢ûÂä†Âª∂Ëøü
            }

            // Close the more menu after opening/closing search
            const moreMenu = document.getElementById('more-menu');
            if (moreMenu) {
                moreMenu.classList.remove('visible');
            }
        }


        // Â±ÇÊ¨°ÂåñÈü≥‰πêÊ†áÁ≠æÁ≥ªÁªü
        const musicTags = {
            // ‰∏ÄÁ∫ßÂàÜÁ±ªÔºöÈü≥‰πêÂ±ûÊÄß
            attributes: {
                // ‰∫åÁ∫ßÂàÜÁ±ªÔºöÊÉÖÁª™‰∏éÊ∞õÂõ¥ (Vibes & Moods)
                moods: {
                    positive: ["Happy", "Joy", "Cheerful", "Uplifting", "Energetic", "Upbeat", "Euphoria", "Peaceful", "Calm", "Serene", "Chill", "Relax", "Cozy", "Mellow", "Groovy", "Cool", "Fresh"],
                    romantic: ["Love", "Romantic", "Heart", "Kiss", "Miss", "Baby", "Intimate", "Affection", "Passion", "Sensual", "Sexy"],
                    melancholy: ["Sad", "Melancholy", "Nostalgia", "Sentimental", "Blue", "Tears", "Lonely", "Gloomy", "Melancholic", "Heartbreak"],
                    intense: ["Drama", "Intense", "Power", "Epic", "Cinematic", "Dark", "Mystery", "Mysterious", "Heavy", "Spooky", "Creepy", "Mysterious", "Supernatural"],
                    spiritual: ["Faith", "Believe", "Angels", "Heaven", "Paradise", "Divine", "Sacred", "Spiritual", "Transcendent", "Soulful"]
                },
                // ‰∫åÁ∫ßÂàÜÁ±ªÔºöÈü≥‰πêÈ£éÊ†º (Stylistic Elements)
                styles: {
                    sonic: ["Acoustic", "Electric", "Instrumental", "Acapella", "Live", "Studio", "Remix", "Cover", "Original"],
                    aesthetic: ["Vintage", "Retro", "Classic", "Modern", "Futuristic", "Cyberpunk", "Aesthetic", "Pastel", "Neon", "Funky"]
                }
            },
            // ‰∏ÄÁ∫ßÂàÜÁ±ªÔºöÈü≥‰πêÁ±ªÂûã
            genres: {
                // ‰∫åÁ∫ßÂàÜÁ±ªÔºö‰∏ªË¶ÅÊµÅÊ¥æ (Main Genres)
                main: {
                    pop: ["Pop", "Mandopop", "Cantopop", "K-Pop", "J-Pop", "Jazz", "Soul", "R&B"],
                    rock: ["Rock", "Alternative", "Indie", "Punk", "Grunge", "Emo", "Metal", "Heavy Metal"],
                    electronic: ["EDM", "House", "Techno", "Trance", "Dubstep", "Drum and Bass", "Garage", "Ambient"],
                    hip_hop: ["Hip Hop", "Rap", "Trap", "R&B"],
                    traditional: ["Country", "Folk", "Classical", "Opera", "Blues"],
                    world: ["Latin", "Reggae", "Dancehall", "Salsa", "Bachata", "Reggaeton", "Anime", "Ghibli"]
                },
                // ‰∏âÁ∫ßÂàÜÁ±ªÔºöË°çÁîüÊµÅÊ¥æ (Sub-Genres)
                sub_genres: {
                    pop_sub: ["Synthpop", "Electropop", "Dance-pop", "Indie Pop", "Art Pop"],
                    rock_sub: ["Glam Rock", "Progressive Rock", "Punk Rock", "Hard Rock", "Grunge Rock", "Alternative Rock"],
                    electronic_sub: ["Lo-Fi", "Lofi Hip Hop", "Synthwave", "Vaporwave", "Retrowave", "Deep House", "Future Bass"],
                    hip_hop_sub: ["Old School Hip Hop", "Trap", "Drill", "Conscious Rap", "Mumble Rap"],
                    traditional_sub: ["Bluegrass", "Folk Rock", "Baroque", "Chamber Music", "Contemporary Classical"]
                }
            },
            // ‰∏ÄÁ∫ßÂàÜÁ±ªÔºöÂú∫ÊôØÊ¥ªÂä®
            scenarios: {
                // ‰∫åÁ∫ßÂàÜÁ±ªÔºöÊó∂Èó¥Âú∫ÊôØ (Time-based)
                time_based: {
                    daily_routine: ["Morning", "Wake Up", "Afternoon", "Evening", "Late Night", "Midnight", "Sunrise", "Sunset"],
                    weekly: ["Weekend", "Friday", "Sunday", "Monday", "Workday"],
                    seasonal: ["Spring", "Summer", "Autumn", "Winter", "Holiday", "New Year", "Valentine", "Christmas", "Halloween"],
                    special_occasions: ["Birthday", "Wedding", "Graduation", "Travel", "Vacation", "Beach", "Camping", "Festival"]
                },
                // ‰∫åÁ∫ßÂàÜÁ±ªÔºöÊ¥ªÂä®Âú∫ÊôØ (Activity-based)
                activity_based: {
                    exercise: ["Workout", "Gym", "Running", "Jogging", "Yoga", "Meditation", "Stretching"],
                    work_study: ["Study", "Coding", "Reading", "Focus", "Background", "Concentration", "Deep Work"],
                    travel: ["Driving", "Road Trip", "Car Music", "Commuting", "Long Drive"],
                    social: ["Party", "Club", "Bar", "Lounge", "Dinner", "Cooking", "Cleaning"],
                    relaxation: ["Sleep", "Meditation", "Spa", "Shower", "Bath", "Coffee Shop", "Cafe"]
                }
            },
            // ‰∏ÄÁ∫ßÂàÜÁ±ªÔºöÊñáÂåñÂÖÉÁ¥†
            culture: {
                // ‰∫åÁ∫ßÂàÜÁ±ªÔºöÂú∞ÂüüÊñáÂåñ (Regional Culture)
                regional: {
                    western: ["American", "British", "European", "African", "Caribbean"],
                    asian: ["Chinese", "Korean", "Japanese", "Taiwanese", "Hong Kong", "Southeast Asian"],
                    latin: ["Latin America", "Brazil", "Mexico", "Caribbean"]
                },
                // ‰∫åÁ∫ßÂàÜÁ±ªÔºöËâ∫ÊúØÂÆ∂‰∏é‰ΩúÂìÅ (Artists & Works)
                artists: {
                    western_mainstream: [
                        "Taylor Swift", "Ed Sheeran", "Ariana Grande", "Justin Bieber", "The Weeknd", "Dua Lipa",
                        "Billie Eilish", "Harry Styles", "Bruno Mars", "Adele", "Rihanna", "Beyonce", "Lady Gaga",
                        "Katy Perry", "Miley Cyrus", "Post Malone", "Coldplay", "Imagine Dragons", "OneRepublic",
                        "Drake", "Kendrick Lamar", "Eminem", "Jay-Z", "Travis Scott", "Kanye West", "J. Cole",
                        "Beatles", "Queen", "Pink Floyd", "Led Zeppelin", "AC/DC", "Red Hot Chili Peppers",
                        "Linkin Park", "Arctic Monkeys", "Tame Impala", "Oasis", "David Bowie", "Prince",
                        "Elton John", "Bob Dylan", "Beyonc√©", "Alicia Keys", "John Legend"
                    ],
                    korean: ["BTS", "Blackpink", "Twice", "EXO", "Big Bang", "NewJeans", "Stray Kids", "IU", "SEVENTEEN"],
                    chinese: ["Âë®Êù∞‰º¶", "Êûó‰øäÊù∞", "ÈôàÂ•ïËøÖ", "ÁéãÂäõÂÆè", "Èô∂ÂñÜ", "Ëî°‰æùÊûó", "Â≠ôÁáïÂßø", "Ê¢ÅÈùôËåπ", "‰∫îÊúàÂ§©",
                        "Beyond", "ÈÇì‰∏ΩÂêõ", "Âº†ÂõΩËç£", "ÁéãËè≤", "Âº†Â≠¶Âèã", "ÂàòÂæ∑Âçé", "ÈªéÊòé", "ÈÉ≠ÂØåÂüé", "ÁΩóÂ§ß‰Ωë",
                        "ÊùéÂÆóÁõõ", "Â¥îÂÅ•", "Á™¶ÂîØ", "‰ºç‰Ω∞", "Âº†Èõ®Áîü", "ÈÇìÁ¥´Ê£ã", "ÊùéËç£Êµ©", "Ëñõ‰πãË∞¶", "Âë®Ê∑±",
                        "ÊØõ‰∏çÊòì", "ÂçéÊô®ÂÆá", "Âº†Êù∞", "ËÆ∏Âµ©", "Âëä‰∫î‰∫∫", "Áóõ‰ª∞", "ÈôàÁ≤í", "ËµµÈõ∑"],
                    japanese: ["ÂÆâÂÆ§Â•àÁæéÊÅµ", "ÂÆáÂ§öÁî∞„Éí„Ç´„É´", "Á±≥Ê¥•ÁéÑÂ∏´", "RADWIMPS", "YOASOBI"],
                    instrumental: ["Hans Zimmer", "John Williams", "Joe Hisaishi", "Ennio Morricone", "Ludwig G√∂ransson"]
                },
                // ‰∫åÁ∫ßÂàÜÁ±ªÔºöÂΩ±ËßÜÊñáÂåñ (Media Culture)
                media: {
                    franchises: ["Marvel", "DC", "Star Wars", "Harry Potter", "Lord of the Rings", "Game of the Thrones"],
                    shows: ["Stranger Things", "Friends", "Simpsons", "Breaking Bad", "The Office"],
                    games: ["Cyberpunk 2077", "GTA", "FIFA", "Mario", "Zelda", "Pokemon", "Fortnite"],
                    other: ["Disney", "Musical", "Broadway", "Anime OST", "Video Game Music"]
                }
            },
            // ‰∏ÄÁ∫ßÂàÜÁ±ªÔºöËá™ÁÑ∂‰∏éÊäΩË±°
            nature_abstract: {
                // ‰∫åÁ∫ßÂàÜÁ±ªÔºöËá™ÁÑ∂ÂÖÉÁ¥† (Natural Elements)
                nature: {
                    weather: ["Rain", "Storm", "Thunder", "Snow", "Wind", "Sun", "Moon", "Stars"],
                    landscapes: ["Ocean", "Sea", "River", "Forest", "Jungle", "Mountain", "Desert"],
                    locations: ["California", "New York", "London", "Paris", "Tokyo", "Seoul", "Hong Kong", "Shanghai", "Miami", "Ibiza", "Hawaii", "Space", "Galaxy", "Universe", "City", "Street", "Highway"]
                },
                // ‰∫åÁ∫ßÂàÜÁ±ªÔºöÊäΩË±°Ê¶ÇÂøµ (Abstract Concepts)
                abstract: {
                    transcendental: ["Dream", "Night", "Fire", "Gold", "Wild", "Free", "Magic", "Legend", "Hero", "Angel", "Devil", "King", "Queen", "Life", "Time", "Eternity"],
                    emotions: ["Hope", "Smile", "Believe", "Together", "Alone", "Lost", "Forever", "Secret", "Promise"]
                }
            }
        };

        // ‰ªéÂ±ÇÊ¨°ÂåñÊ†áÁ≠æÁ≥ªÁªü‰∏≠ÊèêÂèñÊâÄÊúâÊ†áÁ≠æËØçÔºåÁî®‰∫éÈöèÊú∫ÊêúÁ¥¢
        function getAllKeywords() {
            const keywords = [];

            function collectKeywords(obj) {
                for (const key in obj) {
                    if (Array.isArray(obj[key])) {
                        // ÂÖàÊ£ÄÊü•ÊòØÂê¶‰∏∫Êï∞ÁªÑ
                        obj[key].forEach(item => keywords.push(item));
                    } else if (typeof obj[key] === 'object' && obj[key] !== null) {
                        // ÂÜçÊ£ÄÊü•ÊòØÂê¶‰∏∫ÂØπË±°ÔºàÊéíÈô§nullÔºâ
                        collectKeywords(obj[key]);
                    }
                }
            }

            collectKeywords(musicTags);
            return keywords;
        }

        // Ëé∑ÂèñÊ†áÁ≠æÊé®Ëçê
        function getRecommendationsByTag(tag, limit = 20) {
            const recommendations = [];

            function findRelatedTags(obj, currentPath = []) {
                for (const key in obj) {
                    if (typeof obj[key] === 'object' && !Array.isArray(obj[key])) {
                        findRelatedTags(obj[key], [...currentPath, key]);
                    } else if (Array.isArray(obj[key])) {
                        // Ê£ÄÊü•ÂΩìÂâçÊ†áÁ≠æÊòØÂê¶Âú®Êï∞ÁªÑ‰∏≠
                        if (obj[key].includes(tag)) {
                            // Ê∑ªÂä†ÂêåÁ∫ßÁöÑÂÖ∂‰ªñÊ†áÁ≠æ
                            obj[key].forEach(item => {
                                if (item !== tag && !recommendations.includes(item)) {
                                    recommendations.push(item);
                                }
                            });

                            // Ê∑ªÂä†ÂêåÁªÑÁöÑÂÖ∂‰ªñÊ†áÁ≠æÔºàÂ¶ÇÊûúÊúâÔºâ
                            if (currentPath.length > 0) {
                                const parentPath = currentPath.slice(0, -1);
                                const parentObj = getParentObject(musicTags, parentPath);

                                for (const parentKey in parentObj) {
                                    if (Array.isArray(parentObj[parentKey]) && parentObj[parentKey] !== obj[key]) {
                                        parentObj[parentKey].forEach(item => {
                                            if (!recommendations.includes(item)) {
                                                recommendations.push(item);
                                            }
                                        });
                                    }
                                }
                            }
                        }
                    }
                }
            }

            function getParentObject(obj, path) {
                let current = obj;
                for (const key of path) {
                    current = current[key];
                }
                return current;
            }

            findRelatedTags(musicTags);

            // Âè™ËøîÂõûÊåáÂÆöÊï∞ÈáèÁöÑÊé®Ëçê
            return recommendations.slice(0, limit);
        }

        // Ëé∑ÂèñÊ†áÁ≠æÁöÑÂ±ÇÊ¨°‰ø°ÊÅØ
        function getTagHierarchy(tag) {
            const hierarchy = [];

            function findTag(obj, currentPath = []) {
                for (const key in obj) {
                    if (typeof obj[key] === 'object' && !Array.isArray(obj[key])) {
                        if (findTag(obj[key], [...currentPath, key])) {
                            return true;
                        }
                    } else if (Array.isArray(obj[key])) {
                        if (obj[key].includes(tag)) {
                            hierarchy.push(...currentPath, key);
                            return true;
                        }
                    }
                }
                return false;
            }

            findTag(musicTags);
            return hierarchy;
        }

        // Ëé∑ÂèñÂΩìÂâçÊí≠ÊîæÊ≠åÊõ≤ÁöÑÁõ∏ÂÖ≥Ê†áÁ≠æÊé®Ëçê
        function getSongRecommendations(song) {
            // Ê£ÄÊü•Ê≠åÊõ≤ÂØπË±°ÊòØÂê¶ÊúâÊïà
            if (!song || !song.artistName || !song.trackName) {
                return [];
            }

            // Á°Æ‰øùÂ≠óÁ¨¶‰∏≤Â±ûÊÄßÂ≠òÂú®‰∏î‰∏ç‰∏∫Á©∫
            const artistName = song.artistName || '';
            const trackName = song.trackName || '';

            // Âü∫‰∫éËâ∫ÊúØÂÆ∂ÁöÑÊé®Ëçê
            const artistRecommendations = [];
            for (const category in musicTags.culture.artists) {
                if (musicTags.culture.artists[category].includes(artistName)) {
                    // Ê∑ªÂä†ÂêåÁ±ªÂûãËâ∫ÊúØÂÆ∂
                    musicTags.culture.artists[category].forEach(artist => {
                        if (artist !== artistName && !artistRecommendations.includes(artist)) {
                            artistRecommendations.push(artist);
                        }
                    });
                }
            }

            // Âü∫‰∫éÊµÅÊ¥æÁöÑÊé®Ëçê
            const genreRecommendations = [];
            for (const category in musicTags.genres.main) {
                if (musicTags.genres.main[category].some(genre =>
                    trackName.toLowerCase().includes(genre.toLowerCase()) ||
                    artistName.toLowerCase().includes(genre.toLowerCase()))) {
                    // Ê∑ªÂä†ÂêåÁ±ªÊµÅÊ¥æ
                    musicTags.genres.main[category].forEach(genre => {
                        if (!genreRecommendations.includes(genre) &&
                            !artistRecommendations.includes(genre)) {
                            genreRecommendations.push(genre);
                        }
                    });

                    // Ê∑ªÂä†Â≠êÊµÅÊ¥æ
                    if (musicTags.genres.sub_genres[`${category}_sub`]) {
                        musicTags.genres.sub_genres[`${category}_sub`].forEach(subGenre => {
                            if (!genreRecommendations.includes(subGenre)) {
                                genreRecommendations.push(subGenre);
                            }
                        });
                    }
                }
            }

            // ÂêàÂπ∂ÊâÄÊúâÊé®ËçêÂπ∂ÈôêÂà∂Êï∞Èáè
            const allRecommendations = [...artistRecommendations, ...genreRecommendations];
            return [...new Set(allRecommendations)].slice(0, 10);
        }

        // ‰ªéÂ±ÇÊ¨°ÂåñÊ†áÁ≠æ‰∏≠Ëé∑ÂèñÊâÄÊúâÂÖ≥ÈîÆËØç
        const keywords = getAllKeywords();

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            // ÂàùÂßãÂåñ‰∏ªÈ¢ò
            ThemeManager.init();

            // Ê£ÄÊü•URLÂèÇÊï∞ÔºåÂ¶ÇÊûúÂåÖÂê´youtube_embedÔºåÂàôÊòæÁ§∫ÂµåÂÖ•ÂºèÊí≠ÊîæÂô®
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('youtube_embed') === 'true') {
                // ÊòæÁ§∫ÂµåÂÖ•ÂºèÊí≠ÊîæÂô®
                const videoId = urlParams.get('video_id');
                const title = urlParams.get('title') || 'Unknown Title';
                const artist = urlParams.get('artist') || 'Unknown Artist';

                if (videoId) {
                    // Ê∑ªÂä†ÂµåÂÖ•ÂºèÊ®°ÂºèÁ±ªÂà∞body
                    document.body.classList.add('embedded-mode');
                    // ÈöêËóè‰∏çÂøÖË¶ÅÁöÑUIÂÖÉÁ¥†
                    document.querySelector('.header').style.display = 'none';
                    document.querySelector('.content').style.display = 'none';
                    const playerElement = document.querySelector('.player');
                    playerElement.style.display = 'block';
                    playerElement.classList.add('embedded'); // Ê∑ªÂä†ÂµåÂÖ•ÂºèÊ†∑ÂºèÁ±ª
                    document.querySelector('.bg-gradient').style.display = 'none';
                    document.querySelector('.bg-album').style.display = 'none';
                    $('danmaku').style.display = 'none';

                    // ÂàùÂßãÂåñÊí≠ÊîæÂô®UI
                    const cover = 'https://i.ytimg.com/img/no_thumbnail.jpg'; // ÈªòËÆ§Â∞ÅÈù¢
                    $('player-cover').src = cover;

                    const titleTextEl = $('player-title-text');
                    const artistTextEl = $('player-artist-text');

                    titleTextEl.textContent = title;
                    artistTextEl.textContent = artist;

                    // ËÆæÁΩÆÁª¥Âü∫ÁôæÁßëÊåâÈíÆ
                    const wikiBtn = $('player-wiki-btn');
                    const cleanArtistName = artist.split(/&|,|feat\.|ft\./i)[0].trim();
                    wikiBtn.style.display = 'flex';
                    wikiBtn.onclick = () => {
                        const wikiUrl = `https://zh.wikipedia.org/wiki/${encodeURIComponent(cleanArtistName)}`;
                        window.open(wikiUrl, '_blank');
                    };
                    wikiBtn.title = `Êü•Áúã ${cleanArtistName} ÁöÑÁª¥Âü∫ÁôæÁßë`;

                    // ËÆæÁΩÆÊ†áÁ≠æÊé®ËçêÊåâÈíÆ
                    const tagBtn = $('player-tag-btn');
                    tagBtn.style.display = 'flex';
                    tagBtn.onclick = () => {
                        showCurrentSongTags();
                    };
                    tagBtn.title = 'Êü•ÁúãÊ≠åÊõ≤Ê†áÁ≠æÊé®Ëçê';

                    // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊªöÂä®
                    const checkScroll = (el) => {
                        el.classList.remove('scroll-text');
                        el.style.transform = 'none';

                        const containerWidth = el.parentElement.clientWidth;
                        const textWidth = el.scrollWidth;

                        if (textWidth > containerWidth) {
                            const distance = containerWidth - textWidth;
                            const duration = Math.abs(distance) / 30 + 2;

                            el.style.setProperty('--scroll-distance', `${distance}px`);
                            el.style.setProperty('--duration', `${duration}s`);
                            el.classList.add('scroll-text');
                        }
                    };

                    setTimeout(() => {
                        checkScroll(titleTextEl);
                        checkScroll(artistTextEl);
                    }, 50);

                    // Êí≠ÊîæYouTubeÊ≠åÊõ≤
                    playYouTubeSong(videoId, title, artist, cover);
                }
            } else {
                // Ê≠£Â∏∏Ê®°ÂºèÔºöÊâßË°åÊêúÁ¥¢Âπ∂ÊòæÁ§∫ÁïåÈù¢
                randomSearch();
                // Á°Æ‰øùbody‰∏çÂåÖÂê´ÂµåÂÖ•ÂºèÊ®°ÂºèÁ±ª
                document.body.classList.remove('embedded-mode');
            }

            const searchInput = $('search-input');
            const searchClearBtn = $('search-clear-btn');
            let searchTimeout;

            // Remove problematic event listeners and simplify focus handling
            // Standard input handling for PWA mode
            searchInput.addEventListener('keypress', e => {
                if (e.key === 'Enter') {
                    clearTimeout(searchTimeout);
                    searchMusic();
                }
            });

            // Handle focus event properly without forcing focus
            searchInput.addEventListener('focus', () => {
                // Do not prevent default or stop propagation here as it interferes with input method
                console.log('Search input focused');
            });

            // Handle input event with debounce
            searchInput.addEventListener('input', () => {
                searchClearBtn.style.display = searchInput.value ? 'flex' : 'none';

                // Èò≤ÊäñÊêúÁ¥¢
                clearTimeout(searchTimeout);
                if (searchInput.value.trim()) {
                    searchTimeout = setTimeout(() => {
                        searchMusic();
                    }, 800);
                }
            });

            // Show clear button if search input already has value on load
            searchClearBtn.style.display = searchInput.value ? 'flex' : 'none';

            // Clear search input when clear button is clicked
            searchClearBtn.addEventListener('click', () => {
                clearTimeout(searchTimeout);
                searchInput.value = '';
                searchClearBtn.style.display = 'none';
                // Simply focus input without interfering with input methods
                setTimeout(() => {
                    searchInput.focus();
                    if (typeof searchInput.select === 'function') {
                        searchInput.select();
                    }
                }, 50);
            });

            // Simplified click handler on container
            const searchInputContainer = document.querySelector('.search-input-container');
            if (searchInputContainer) {
                searchInputContainer.addEventListener('click', (e) => {
                    // Do not prevent default or stop propagation to allow proper input method handling
                    if (e.target === searchInputContainer || e.target.closest('.search-input-container')) {
                        // Just ensure the input gets focus naturally
                        setTimeout(() => {
                            searchInput.focus();
                        }, 0);
                    }
                });
            }

            // ÂèåÂáªÂ∞ÅÈù¢ÊâìÂºÄÊ≠åËØç
            $('player-cover').addEventListener('dblclick', openLyrics);
        });

        // ÊêúÁ¥¢Ëâ∫ÊúØÂÆ∂
        function searchByArtist(artistName) {
            const cleanArtist = artistName.split(/&|,|feat\.|ft\./i)[0].trim();
            $('search-input').value = cleanArtist;
            searchMusic();
        }

        // ÊêúÁ¥¢Ê≠åÊõ≤
        function searchBySong(songName) {
            // Remove parentheses and brackets with their contents from song name
            let cleanSongName = songName.replace(/\([^)]*\)|\[[^\]]*\]/g, '').trim();
            $('search-input').value = cleanSongName;
            searchMusic();
        }

        // ÈöèÊú∫ÊêúÁ¥¢
        function randomSearch() {
            $('search-input').value = keywords[Math.floor(Math.random() * keywords.length)];
            searchMusic();
        }

        // Êô∫ËÉΩÈöèÊú∫ÊêúÁ¥¢ - Âü∫‰∫éÊ†áÁ≠æÂ±ÇÊ¨°ÁªìÊûÑ
        function smartRandomSearch() {
            // ‰ªéÊ†áÁ≠æÁöÑÈ°∂Â±ÇÁ±ªÂà´‰∏≠ÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™
            const topLevelCategories = Object.keys(musicTags);
            if (topLevelCategories.length === 0) {
                randomSearch(); // ÂõûÈÄÄÂà∞ÊôÆÈÄöÈöèÊú∫ÊêúÁ¥¢
                return;
            }
            const randomCategory = topLevelCategories[Math.floor(Math.random() * topLevelCategories.length)];

            // ‰ªéËØ•Á±ªÂà´‰∏≠ÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™Â≠êÁ±ªÂà´
            const subCategories = Object.keys(musicTags[randomCategory]);
            if (subCategories.length === 0) {
                randomSearch(); // ÂõûÈÄÄÂà∞ÊôÆÈÄöÈöèÊú∫ÊêúÁ¥¢
                return;
            }
            const randomSubCategory = subCategories[Math.floor(Math.random() * subCategories.length)];

            // ‰ªéÂ≠êÁ±ªÂà´‰∏≠ÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™Ê†áÁ≠æ
            const tagsInSubCategory = musicTags[randomCategory][randomSubCategory];
            if (Array.isArray(tagsInSubCategory) && tagsInSubCategory.length > 0) {
                const randomTag = tagsInSubCategory[Math.floor(Math.random() * tagsInSubCategory.length)];
                if (randomTag) {  // Á°Æ‰øùÊ†áÁ≠æ‰∏ç‰∏∫undefinedÊàñnull
                    $('search-input').value = randomTag;
                    searchMusic();
                    showToast(`Êô∫ËÉΩÊé®ËçêÔºö${randomTag} (${randomCategory} > ${randomSubCategory})`);
                } else {
                    randomSearch(); // ÂõûÈÄÄÂà∞ÊôÆÈÄöÈöèÊú∫ÊêúÁ¥¢
                }
            } else {
                // Â¶ÇÊûúÂ≠êÁ±ªÂà´‰∏çÊòØÊï∞ÁªÑËÄåÊòØÊõ¥Ê∑±Â±ÇÁªìÊûÑÔºåÂàôÁªßÁª≠Ê∑±ÂÖ•
                const deeperCategories = Object.keys(musicTags[randomCategory][randomSubCategory]);
                if (deeperCategories && deeperCategories.length > 0) {
                    const randomDeeperCategory = deeperCategories[Math.floor(Math.random() * deeperCategories.length)];
                    const tagsInDeeperCategory = musicTags[randomCategory][randomSubCategory][randomDeeperCategory];
                    if (Array.isArray(tagsInDeeperCategory) && tagsInDeeperCategory.length > 0) {
                        const randomTag = tagsInDeeperCategory[Math.floor(Math.random() * tagsInDeeperCategory.length)];
                        if (randomTag) {  // Á°Æ‰øùÊ†áÁ≠æ‰∏ç‰∏∫undefinedÊàñnull
                            $('search-input').value = randomTag;
                            searchMusic();
                            showToast(`Êô∫ËÉΩÊé®ËçêÔºö${randomTag} (${randomCategory} > ${randomSubCategory} > ${randomDeeperCategory})`);
                        } else {
                            randomSearch(); // ÂõûÈÄÄÂà∞ÊôÆÈÄöÈöèÊú∫ÊêúÁ¥¢
                        }
                    } else {
                        // ÂõûÈÄÄÂà∞ÊôÆÈÄöÈöèÊú∫ÊêúÁ¥¢
                        randomSearch();
                    }
                } else {
                    // ÂõûÈÄÄÂà∞ÊôÆÈÄöÈöèÊú∫ÊêúÁ¥¢
                    randomSearch();
                }
            }
        }

        // ÊêúÁ¥¢Èü≥‰πê
        async function searchMusic() {
            const query = $('search-input').value?.trim();
            if (!query) return;

            // Ëß£ÊûêURLÂèÇÊï∞
            const urlParams = getUrlParams();
            const isAppleOnly = urlParams.apple && !urlParams.youtube;
            const isYouTubeOnly = urlParams.youtube && !urlParams.apple;
            const isBoth = !isAppleOnly && !isYouTubeOnly; // ÈªòËÆ§ÊÉÖÂÜµÔºåÊòæÁ§∫‰∏§‰∏™Êù•Ê∫ê

            // Â∞ùËØï‰ªéÁºìÂ≠òËé∑ÂèñÊêúÁ¥¢ÁªìÊûú
            const cacheKey = `search_${query}`;
            let cachedResults = CacheManager.get(cacheKey);

            if (cachedResults) {
                console.log('Using cached search results for:', query);
                state.playlist = cachedResults;
                renderResults(cachedResults);
                return;
            }

            $('results').innerHTML = `
                <div class="loading" style="grid-column: 1/-1;">
                    <div class="loading-spinner"></div>
                    <div>Ê≠£Âú®ÊêúÁ¥¢...</div>
                </div>
            `;

            let iTunesResults = [];
            let youTubeResults = [];

            // Ê†πÊçÆURLÂèÇÊï∞ÂÜ≥ÂÆöÊêúÁ¥¢Âì™‰∏™Êù•Ê∫ê
            if (!isYouTubeOnly) {
                // ÊêúÁ¥¢ iTunes API (Â¶ÇÊûúÊú™ÊåáÂÆöÂè™Áî®YouTube)
                try {
                    const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(query)}&entity=song&limit=48&country=cn`);
                    if (res.ok) {
                        const iTunesData = await res.json();
                        iTunesResults = iTunesData.results || [];
                    } else {
                        console.error('iTunes API ËØ∑Ê±ÇÂ§±Ë¥•ÔºåÁä∂ÊÄÅÁ†Å:', res.status);
                        iTunesResults = [];
                    }
                } catch (e) {
                    console.error('iTunes API ÊêúÁ¥¢Â§±Ë¥•:', e);
                    iTunesResults = [];
                }
            }

            if (!isAppleOnly) {
                // ÊêúÁ¥¢ YouTube (Â¶ÇÊûúÊú™ÊåáÂÆöÂè™Áî®iTunes)
                try {
                    const youTubeRes = await fetch(`https://api.yuangs.cc/youtubeapi/search/song?q=${encodeURIComponent(query)}&limit=48`);
                    if (youTubeRes.ok) {
                        const youTubeJson = await youTubeRes.json();
                        // console.log('YouTube API ÂìçÂ∫î:', youTubeJson); // Debug log

                        // Check if response has the expected structure
                        if (youTubeJson && youTubeJson.data) {
                            // If the API returns data in the expected format
                            youTubeResults = youTubeJson.data.map(item => ({
                                // Â∞Ü YouTube Êï∞ÊçÆËΩ¨Êç¢‰∏∫ iTunes Ê†ºÂºè
                                trackId: item.video_id || item.id,
                                trackName: item.title || item.name,
                                artistName: Array.isArray(item.artists) ? item.artists.join(', ') : (item.artist || item.author || 'Unknown Artist'),
                                collectionName: item.album || 'YouTube Music',
                                artworkUrl100: item.thumbnail || item.thumbnails?.[1]?.url || item.image || 'https://i.ytimg.com/img/no_thumbnail.jpg',
                                previewUrl: `https://www.youtube.com/watch?v=${item.video_id || item.id}`,
                                kind: 'youtube',  // Ê†áËÆ∞‰∏∫ YouTube Êù•Ê∫ê
                                genre: item.category || item.genre || 'YouTube',
                                releaseDate: item.publish_date || item.publishedAt || new Date().toISOString(),
                                duration: item.duration || 'Unknown Duration'  // Ê∑ªÂä†Êó∂Èïø‰ø°ÊÅØ
                            }));
                        } else {
                            console.warn('YouTube API ÂìçÂ∫îÊ†ºÂºè‰∏çÊ≠£Á°Æ:', youTubeJson);
                        }
                    } else {
                        console.error('YouTube API ËØ∑Ê±ÇÂ§±Ë¥•ÔºåÁä∂ÊÄÅÁ†Å:', youTubeRes.status);
                    }
                } catch (e) {
                    console.error('YouTube API ÊêúÁ¥¢Â§±Ë¥•:', e);
                    // ÂèØËÉΩÊòØ CORS ÊàñÁΩëÁªúÈóÆÈ¢òÔºå‰∏ç‰∏≠Êñ≠Êï¥‰∏™ÊêúÁ¥¢ÊµÅÁ®ã
                }
            }

            // Ê†πÊçÆURLÂèÇÊï∞ÂÜ≥ÂÆöÊúÄÁªàÂ±ïÁ§∫ÁöÑÊ≠åÊõ≤Êï∞ÈáèÔºàÊÄªÂÖ±48È¶ñÔºâ
            if (isAppleOnly) {
                // Âè™Â±ïÁ§∫iTunesÊù•Ê∫êÔºåÂèñÂâç48È¶ñ
                iTunesResults = iTunesResults.slice(0, 48);
                youTubeResults = [];
            } else if (isYouTubeOnly) {
                // Âè™Â±ïÁ§∫YouTubeÊù•Ê∫êÔºåÂèñÂâç48È¶ñ
                youTubeResults = youTubeResults.slice(0, 48);
                iTunesResults = [];
            } else {
                // ÈªòËÆ§ÊÉÖÂÜµÔºåÊØè‰∏™Êù•Ê∫êÂ±ïÁ§∫24È¶ñÔºàÊÄªÂÖ±48È¶ñÔºâ
                iTunesResults = iTunesResults.slice(0, 24);
                youTubeResults = youTubeResults.slice(0, 24);
            }

            // ÁºìÂ≠òÊêúÁ¥¢ÁªìÊûúÔºàÊúâÊïàÊúü1Â∞èÊó∂Ôºâ
            CacheManager.set(cacheKey, { itunes: iTunesResults, youtube: youTubeResults }, 1);

            // ‰øùÂ≠òÂà∞ stateÔºåÁî®‰∫éÊí≠Êîæ
            state.playlist = [...iTunesResults, ...youTubeResults];

            // Ê∏≤Êüì‰∏§ÂàóÁªìÊûú
            renderSeparateResults(iTunesResults, youTubeResults);

            // ÂêåÊó∂ÁºìÂ≠òÊØè‰∏™Ê≠åÊõ≤ÁöÑÂÖÉÊï∞ÊçÆ
            [...iTunesResults, ...youTubeResults].forEach(song => {
                const songCacheKey = generateCacheKey(song.artistName, song.trackName);
                CacheManager.set(songCacheKey, {
                    trackName: song.trackName,
                    artistName: song.artistName,
                    artworkUrl: song.artworkUrl100,
                    previewUrl: song.previewUrl,
                    collectionName: song.collectionName,
                    kind: song.kind  // ‰øùÂ≠òÊù•Ê∫êÁ±ªÂûã
                }, 24); // 24Â∞èÊó∂ÊúâÊïàÊúü
            });
        }

        // Ê∏≤ÊüìÂàÜÁ¶ªÁöÑÁªìÊûúÔºàiTunes Âíå YouTube ÂàÜÂàóÊòæÁ§∫Ôºâ
        function renderSeparateResults(iTunesSongs, youTubeSongs) {
            if (iTunesSongs.length === 0 && youTubeSongs.length === 0) {
                $('results').innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="empty-icon">üîç</div>
                        <div class="empty-title">Êú™ÊâæÂà∞ÁªìÊûú</div>
                        <div class="empty-desc">Êç¢‰∏™ÂÖ≥ÈîÆËØçËØïËØï</div>
                    </div>
                `;
                return;
            }

            // Ëß£ÊûêURLÂèÇÊï∞Êù•Á°ÆÂÆöÊòæÁ§∫Ê®°Âºè
            const urlParams = getUrlParams();
            const isAppleOnly = urlParams.apple && !urlParams.youtube;
            const isYouTubeOnly = urlParams.youtube && !urlParams.apple;

            const renderSongList = (songs, startIndex) => {
                return songs.map((song, index) => {
                    const actualIndex = startIndex + index;
                    const songCacheKey = generateCacheKey(song.artistName, song.trackName);
                    const cachedSong = CacheManager.get(songCacheKey);
                    const coverUrl = (cachedSong?.artworkUrl || song.artworkUrl100).replace('100x100bb', '300x300bb');
                    const isYouTube = song.kind === 'youtube' || song.previewUrl?.includes('youtube.com');

                    return `
                        <div class="song-card" data-index="${actualIndex}" onclick="playSong(${actualIndex})">
                            <div class="song-cover">
                                <img src="${coverUrl}" loading="lazy" alt="">
                                <div class="play-overlay">
                                    <div class="play-overlay-btn">‚ñ∂</div>
                                </div>
                                ${song.trackId ? `<div class="song-options" onclick="event.stopPropagation(); toggleOptionsMenu(event, '${song.trackId}', '${escapeHtml(song.trackName)}', '${escapeHtml(song.artistName)}', '${coverUrl}', ${isYouTube})">‚ãØ</div>` : ''}
                                ${isYouTube && song.duration ? `<div class="song-duration">${escapeHtml(song.duration)}</div>` : ''}
                            </div>
                            <div class="song-title">${isYouTube ? '<span style="color: var(--accent);">‚ñ∂</span> ' : ''}${escapeHtml(song.trackName)}</div>
                            <div class="song-artist">${escapeHtml(song.artistName)}</div>
                        </div>
                    `;
                }).join('');
            };

            // Ê†πÊçÆURLÂèÇÊï∞ÂÜ≥ÂÆöÊ∏≤ÊüìÊ®°Âºè
            if (isAppleOnly || isYouTubeOnly) {
                // Âè™ÊòæÁ§∫‰∏Ä‰∏™Êù•Ê∫êÔºå‰ΩÜËÆ©ÁΩëÊ†ºÂ∏ÉÂ±Ä‰ªçÁÑ∂ÊòæÁ§∫Ê≠åÊõ≤‰∏∫Â§öÂàó
                const sourceName = isAppleOnly ? 'Apple Music' : 'YouTube Music';
                const songsToDisplay = isAppleOnly ? iTunesSongs : youTubeSongs;

                $('results').innerHTML = `
                    <div class="results-columns" style="grid-column: 1 / -1;">
                        <div class="results-column" style="grid-column: 1 / -1;"> <!-- Use full width -->
                            <div class="simple-header">${sourceName}</div>
                            <div class="grid">
                                ${songsToDisplay.length > 0 ? renderSongList(songsToDisplay, 0) : '<div class="empty-message">ÊöÇÊó†ÁªìÊûú</div>'}
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // ÈªòËÆ§ÊòæÁ§∫‰∏§‰∏™Êù•Ê∫ê
                $('results').innerHTML = `
                    <div class="results-columns" style="grid-column: 1 / -1;">
                        <div class="results-column">
                            <div class="simple-header">iTunes</div>
                            <div class="grid">
                                ${iTunesSongs.length > 0 ? renderSongList(iTunesSongs, 0) : '<div class="empty-message">ÊöÇÊó†ÁªìÊûú</div>'}
                            </div>
                        </div>
                        <div class="results-column">
                            <div class="simple-header">YouTube</div>
                            <div class="grid">
                                ${youTubeSongs.length > 0 ? renderSongList(youTubeSongs, iTunesSongs.length) : '<div class="empty-message">ÊöÇÊó†ÁªìÊûú</div>'}
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Ê∏≤ÊüìÁªìÊûú
        function renderResults(songs) {
            if (songs.length === 0) {
                $('results').innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="empty-icon">üîç</div>
                        <div class="empty-title">Êú™ÊâæÂà∞ÁªìÊûú</div>
                        <div class="empty-desc">Êç¢‰∏™ÂÖ≥ÈîÆËØçËØïËØï</div>
                    </div>
                `;
                return;
            }

            $('results').innerHTML = songs.map((song, index) => {
                // Ê£ÄÊü•ÊòØÂê¶ÊúâÁºìÂ≠òÁöÑÂÖÉÊï∞ÊçÆ
                const songCacheKey = generateCacheKey(song.artistName, song.trackName);
                const cachedSong = CacheManager.get(songCacheKey);

                // ‰ΩøÁî®ÁºìÂ≠òÁöÑÊàñÂéüÂßãÁöÑÂ∞ÅÈù¢URL
                const coverUrl = (cachedSong?.artworkUrl || song.artworkUrl100).replace('100x100bb', '300x300bb');

                // Ê£ÄÊü•ÊòØÂê¶ÊòØ YouTube Êù•Ê∫ê
                const isYouTube = song.kind === 'youtube' || song.previewUrl?.includes('youtube.com');

                return `
                    <div class="song-card" data-index="${index}" onclick="playSong(${index})">
                        <div class="song-cover">
                            <img src="${coverUrl}" loading="lazy" alt="">
                            <div class="play-overlay">
                                <div class="play-overlay-btn">‚ñ∂</div>
                            </div>
                            ${song.trackId ? `<div class="song-options" onclick="event.stopPropagation(); toggleOptionsMenu(event, '${song.trackId}', '${escapeHtml(song.trackName)}', '${escapeHtml(song.artistName)}', '${coverUrl}', ${isYouTube})">‚ãØ</div>` : ''}
                            ${isYouTube && song.duration ? `<div class="song-duration">${escapeHtml(song.duration)}</div>` : ''}
                        </div>
                        <div class="song-title">${isYouTube ? '<span style="color: var(--accent);">‚ñ∂</span> ' : ''}${escapeHtml(song.trackName)}</div>
                        <div class="song-artist">${escapeHtml(song.artistName)}</div>
                    </div>
                `;
            }).join('');
        }

        // HTML ËΩ¨‰πâ
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Êí≠ÊîæÊ≠åÊõ≤
        function playSong(index) {
            const song = state.playlist[index];
            if (!song) return;

            // Ê£ÄÊü•ÊòØÂê¶ÊòØ YouTube Êù•Ê∫êÁöÑÊ≠åÊõ≤
            const isYouTube = song.kind === 'youtube' || song.previewUrl?.includes('youtube.com');

            if (isYouTube) {
                // Â¶ÇÊûúÊòØ YouTube Ê≠åÊõ≤Ôºå‰ΩøÁî® YouTube Êí≠ÊîæÂáΩÊï∞
                // ÂÖàËÆæÁΩÆÁä∂ÊÄÅÔºåÁ°Æ‰øù state.currentIndex Ê≠£Á°ÆÊõ¥Êñ∞
                state.currentTrack = song;
                state.currentIndex = index;

                playYouTubeSong(
                    song.trackId,
                    song.trackName || 'Êú™Áü•Ê≠åÊõ≤',
                    song.artistName || 'Êú™Áü•Ëâ∫ÊúØÂÆ∂',
                    song.artworkUrl100 || song.thumbnails?.[1]?.url || 'https://i.ytimg.com/img/no_thumbnail.jpg'
                );
                return;
            }

            state.currentTrack = song;
            state.currentIndex = index;

            // ‰ªéÁºìÂ≠òËé∑ÂèñÂÆåÊï¥Êï∞ÊçÆÔºåÂ¶ÇÊûúÊúâÁöÑËØù
            const songCacheKey = generateCacheKey(song.artistName, song.trackName);
            const cachedSong = CacheManager.get(songCacheKey);

            // ‰ΩøÁî®ÁºìÂ≠òÊï∞ÊçÆÊàñÂéüÂßãÊï∞ÊçÆ
            const trackName = cachedSong?.trackName || song.trackName;
            const artistName = cachedSong?.artistName || song.artistName;
            const artworkUrl = cachedSong?.artworkUrl || song.artworkUrl100;
            const previewUrl = cachedSong?.previewUrl || song.previewUrl;
            const collectionName = cachedSong?.collectionName || song.collectionName || song.collectionName;

            const cover = artworkUrl.replace('100x100bb', '600x600bb');

            // Êõ¥Êñ∞È°∂ÈÉ®‰ø°ÊÅØÊ†è
            const titleTextEl = $('player-title-text');
            const artistTextEl = $('player-artist-text');
            const wikiBtn = $('player-wiki-btn');

            titleTextEl.textContent = trackName;
            artistTextEl.textContent = artistName;
            $('player-cover').src = cover;

            // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂Âà∞Ê†áÈ¢òÔºàÊêúÁ¥¢Ê≠åÊõ≤ÂêçÔºâ
            titleTextEl.onclick = () => {
                searchBySong(trackName);
            };
            titleTextEl.title = 'ÁÇπÂáªÊêúÁ¥¢ËØ•Ê≠åÊõ≤';

            // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂Âà∞Ëâ∫ÊúØÂÆ∂ÂêçÁß∞ÔºàÊêúÁ¥¢Ëâ∫ÊúØÂÆ∂Ôºâ
            artistTextEl.onclick = () => {
                searchByArtist(artistName);
            };
            artistTextEl.title = 'ÁÇπÂáªÊêúÁ¥¢ËØ•Ëâ∫ÊúØÂÆ∂ÁöÑÊ≠åÊõ≤';

            // ËÆæÁΩÆÁª¥Âü∫ÁôæÁßëÊåâÈíÆ
            const cleanArtistName = artistName.split(/&|,|feat\.|ft\./i)[0].trim();
            wikiBtn.style.display = 'flex';
            wikiBtn.onclick = () => {
                const wikiUrl = `https://zh.wikipedia.org/wiki/${encodeURIComponent(cleanArtistName)}`;
                window.open(wikiUrl, '_blank');
            };
            wikiBtn.title = `Êü•Áúã ${cleanArtistName} ÁöÑÁª¥Âü∫ÁôæÁßë`;

            // ËÆæÁΩÆÊ†áÁ≠æÊé®ËçêÊåâÈíÆ
            const tagBtn = $('player-tag-btn');
            tagBtn.style.display = 'flex';
            tagBtn.onclick = () => {
                showCurrentSongTags();
            };
            tagBtn.title = 'Êü•ÁúãÊ≠åÊõ≤Ê†áÁ≠æÊé®Ëçê';

            // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊªöÂä®
            const checkScroll = (el) => {
                // ÂÖàÈáçÁΩÆÔºå‰ª•‰æøÂáÜÁ°ÆÊµãÈáè
                el.classList.remove('scroll-text');
                el.style.transform = 'none';

                // ÊØîËæÉÂÜÖÈÉ®ÊñáÊú¨ÂÆΩÂ∫¶ÂíåÂ§ñÈÉ®ÂÆπÂô®ÂÆΩÂ∫¶
                const containerWidth = el.parentElement.clientWidth;
                const textWidth = el.scrollWidth;

                if (textWidth > containerWidth) {
                    const distance = containerWidth - textWidth; // Ë¥üÂÄºÔºåÂêëÂ∑¶ÁßªÂä®
                    const duration = Math.abs(distance) / 30 + 2; // ÈÄüÂ∫¶ÊéßÂà∂ÔºöÊØèÁßí30pxÔºåÂü∫Á°Ä2s

                    el.style.setProperty('--scroll-distance', `${distance}px`);
                    el.style.setProperty('--duration', `${duration}s`);
                    el.classList.add('scroll-text');
                }
            };

            // Á®çÂæÆÂª∂Êó∂‰∏ÄÁÇπÔºåÁ°Æ‰øù DOM Ê∏≤ÊüìÂÆåÊàê
            setTimeout(() => {
                checkScroll(titleTextEl);
                checkScroll(artistTextEl);
            }, 50);

            // ËÉåÊôØ
            $('bg-album').style.backgroundImage = `url(${cover})`;
            $('bg-album').classList.add('active');

            // Ê†áËÆ∞ÂΩìÂâçÊí≠Êîæ
            document.querySelectorAll('.song-card').forEach((card, i) => {
                card.classList.toggle('playing', i === index);
            });

            // Êí≠Êîæ
            audio.src = previewUrl;
            audio.play()
                .then(() => updatePlayState(true))
                .catch(() => updatePlayState(false));

            // ÂºπÂπï
            startDanmaku();

            // È¢ÑÂä†ËΩΩÊ≠åËØç
            $('lyrics-title').textContent = trackName;
            $('lyrics-artist').textContent = artistName;
            // Set up Wikipedia link for artist name
            setupWikipediaLink(artistName);
            $('lyrics-cover').src = cover;
            $('lyrics-text').textContent = 'Âä†ËΩΩ‰∏≠...';
            $('lyrics-wiki').classList.remove('show');

            fetchLyrics(artistName, trackName);
            fetchArtistWiki(artistName);

            // Add click event to artist name to search for artist's songs (left click)
            // and open Wikipedia (Ctrl/Cmd+click)
            $('lyrics-artist').onclick = function (event) {
                if (event.ctrlKey || event.metaKey) {
                    // Ctrl/Cmd + click: open Wikipedia
                    const wikiUrl = $('lyrics-artist').dataset.wikiUrl || `https://zh.wikipedia.org/wiki/${encodeURIComponent(artistName.split(/&|,|feat\.|ft\./i)[0].trim())}`;
                    window.open(wikiUrl, '_blank');
                } else {
                    // Regular click: search for artist's songs
                    searchByArtist(artistName);
                }
            };
            $('lyrics-artist').style.cursor = 'pointer';
            $('lyrics-artist').title = 'ÁÇπÂáªÊêúÁ¥¢ËØ•Ëâ∫ÊúØÂÆ∂ÁöÑÊ≠åÊõ≤ (Ctrl/Cmd+ÁÇπÂáªËÆøÈóÆÁª¥Âü∫ÁôæÁßë)';

            // Ê∑ªÂä†Âà∞ÂéÜÂè≤ËÆ∞ÂΩï
            HistoryManager.add(song);

            // Êõ¥Êñ∞Á≥ªÁªüÂ™í‰Ωì‰∏≠ÂøÉÊéßÂà∂ (Media Session API)
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: trackName,
                    artist: artistName,
                    album: collectionName || 'ÂπøÂ±±Èü≥‰πê',
                    artwork: [
                        { src: artworkUrl.replace('100x100bb', '96x96bb'), sizes: '96x96', type: 'image/jpeg' },
                        { src: artworkUrl.replace('100x100bb', '128x128bb'), sizes: '128x128', type: 'image/jpeg' },
                        { src: artworkUrl.replace('100x100bb', '192x192bb'), sizes: '192x192', type: 'image/jpeg' },
                        { src: artworkUrl.replace('100x100bb', '256x256bb'), sizes: '256x256', type: 'image/jpeg' },
                        { src: cover, sizes: '512x512', type: 'image/jpeg' }
                    ]
                });

                navigator.mediaSession.setActionHandler('play', togglePlay);
                navigator.mediaSession.setActionHandler('pause', togglePlay);
                navigator.mediaSession.setActionHandler('previoustrack', playPrevious);
                navigator.mediaSession.setActionHandler('nexttrack', () => playNext(false));
            }

            // Êõ¥Êñ∞Êî∂ËóèÊåâÈíÆÁä∂ÊÄÅ
            updateFavoriteButton();

            // Êõ¥Êñ∞Êé®ËçêÊ†áÁ≠æ
            updateRecommendationTags(song);
        }

        // Êõ¥Êñ∞Êé®ËçêÊ†áÁ≠æ
        function updateRecommendationTags(song) {
            const recommendations = getSongRecommendations(song);
            const container = $('recommendation-tags-container');
            const tagsElement = $('recommendation-tags');
            const showMoreBtn = $('show-more-recommendations');

            if (!recommendations || recommendations.length === 0) {
                tagsElement.style.display = 'none';
                return;
            }

            // ËøáÊª§ÊéâÊó†ÊïàÁöÑÊé®ËçêÊ†áÁ≠æ
            const validRecommendations = recommendations.filter(tag => tag && typeof tag === 'string');

            if (validRecommendations.length === 0) {
                tagsElement.style.display = 'none';
                return;
            }

            // Âè™ÊòæÁ§∫Ââç5‰∏™Êé®Ëçê
            const displayRecommendations = validRecommendations.slice(0, 5);

            // Ê∏≤ÊüìÊé®ËçêÊ†áÁ≠æ
            container.innerHTML = displayRecommendations.map(tag => `
                <span class="recommendation-tag" onclick="searchByTag('${tag}')">${escapeHtml(tag)}</span>
            `).join('');

            // Â¶ÇÊûúËøòÊúâÊõ¥Â§öÊé®ËçêÔºåÊòæÁ§∫"Â±ïÂºÄÊõ¥Â§ö"ÊåâÈíÆ
            if (validRecommendations.length > 5) {
                showMoreBtn.style.display = 'block';
                showMoreBtn.onclick = () => {
                    // ÊòæÁ§∫ÊâÄÊúâÊé®Ëçê
                    container.innerHTML = validRecommendations.map(tag => `
                        <span class="recommendation-tag" onclick="searchByTag('${tag}')">${escapeHtml(tag)}</span>
                    `).join('');
                    showMoreBtn.style.display = 'none';
                };
            } else {
                showMoreBtn.style.display = 'none';
            }

            // ÊòæÁ§∫Êé®ËçêÂå∫Âüü
            tagsElement.style.display = 'block';
        }

        // YouTube Èü≥‰πê API ÊêúÁ¥¢ÂáΩÊï∞
        async function searchYouTubeMusic(query) {
            try {
                const response = await fetch(`https://api.yuangs.cc/youtubeapi/search/song?q=${encodeURIComponent(query)}&limit=10`);
                if (response.ok) {
                    const data = await response.json();
                    console.log('YouTube search API ÂìçÂ∫î:', data); // Debug log

                    if (data && data.data && data.data.length > 0) {
                        // Á°Æ‰øùËøîÂõûÁöÑÊï∞ÊçÆÊ†ºÂºè‰∏ÄËá¥
                        return data.data.map(item => ({
                            ...item,
                            // Á°Æ‰øùËâ∫ÊúØÂÆ∂Â≠óÊÆµÊ≠£Á°ÆÊò†Â∞Ñ
                            artist: Array.isArray(item.artists) ? item.artists.join(', ') : item.artist,
                            // Â¶ÇÊûúÈúÄË¶Å iTunes ÂÖºÂÆπÊ†ºÂºè
                            artistName: Array.isArray(item.artists) ? item.artists.join(', ') : (item.artist || item.author || 'Unknown Artist'),
                            trackName: item.title || item.name
                        }));
                    }
                } else {
                    console.error('YouTube API ËØ∑Ê±ÇÂ§±Ë¥•ÔºåÁä∂ÊÄÅÁ†Å:', response.status);
                }
                return [];
            } catch (error) {
                console.error('YouTube API ÊêúÁ¥¢Â§±Ë¥•:', error);
                return [];
            }
        }

        // ‰ªé YouTube ÊêúÁ¥¢Âπ∂Êí≠ÊîæÊ≠åÊõ≤
        async function searchAndPlayYouTubeSong(query) {
            const results = await searchYouTubeMusic(query);
            if (results && results.length > 0) {
                const song = results[0]; // ‰ΩøÁî®Á¨¨‰∏Ä‰∏™ÁªìÊûú
                playYouTubeSong(
                    song.video_id,
                    song.title || 'Êú™Áü•Ê≠åÊõ≤',
                    song.artist || 'Êú™Áü•Ëâ∫ÊúØÂÆ∂',
                    song.thumbnail || song.thumbnails?.[1]?.url || ''
                );
                return true;
            }
            return false;
        }

        // ÊåâÊ†áÁ≠æÊêúÁ¥¢
        function searchByTag(tag) {
            if (!tag) {
                return;
            }
            $('search-input').value = tag;
            searchMusic();
        }

        // ÊòæÁ§∫ÂΩìÂâçÊí≠ÊîæÊ≠åÊõ≤ÁöÑÊ†áÁ≠æÂ±ÇÊ¨°ÁªìÊûÑ
        function showCurrentSongTags() {
            if (!state.currentTrack) {
                showToast('ËØ∑ÂÖàÊí≠Êîæ‰∏ÄÈ¶ñÊ≠åÊõ≤');
                return;
            }

            const song = state.currentTrack;
            const recommendations = getSongRecommendations(song);

            if (!recommendations || recommendations.length === 0) {
                showToast('Êú™ÊâæÂà∞Áõ∏ÂÖ≥Ê†áÁ≠æ');
                return;
            }

            // ËøáÊª§ÊéâÊó†ÊïàÁöÑÊé®ËçêÊ†áÁ≠æ
            const validRecommendations = recommendations.filter(tag => tag && typeof tag === 'string');

            if (validRecommendations.length === 0) {
                showToast('Êú™ÊâæÂà∞ÊúâÊïàÊ†áÁ≠æ');
                return;
            }

            // ÂàõÂª∫Ê†áÁ≠æËØ¶ÊÉÖÂºπÁ™ó
            const modal = document.createElement('div');
            modal.className = 'tag-details-modal';
            modal.innerHTML = `
                <div class="modal-overlay" onclick="this.parentElement.remove()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <h3>Áõ∏ÂÖ≥Ê†áÁ≠æÊé®Ëçê</h3>
                        <div class="tags-list">
                            ${validRecommendations.map(tag => `
                                <div class="tag-item" onclick="searchByTag('${tag}')">
                                    <span class="tag-name">${escapeHtml(tag)}</span>
                                    <span class="tag-search-btn">üîç</span>
                                </div>
                            `).join('')}
                        </div>
                        <button class="modal-close-btn" onclick="this.parentElement.parentElement.remove()">ÂÖ≥Èó≠</button>
                    </div>
                </div>
            `;

            // Ê∑ªÂä†Ê†∑Âºè
            if (!document.querySelector('#tag-details-modal-styles')) {
                const styles = document.createElement('style');
                styles.id = 'tag-details-modal-styles';
                styles.textContent = `
                    .tag-details-modal .modal-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0,0,0,0.8);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10000;
                    }
                    .tag-details-modal .modal-content {
                        background: var(--card);
                        border-radius: 16px;
                        padding: 24px;
                        max-width: 400px;
                        width: 90%;
                        max-height: 80vh;
                        overflow-y: auto;
                        border: 1px solid var(--glass-border);
                        backdrop-filter: blur(20px);
                    }
                    .tag-details-modal h3 {
                        margin: 0 0 16px;
                        color: var(--text);
                        text-align: center;
                    }
                    .tags-list {
                        display: flex;
                        flex-direction: column;
                        gap: 8px;
                        margin-bottom: 16px;
                    }
                    .tag-item {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 10px 12px;
                        background: var(--glass);
                        border-radius: 8px;
                        cursor: pointer;
                        transition: all 0.2s ease;
                    }
                    .tag-item:hover {
                        background: var(--primary);
                        color: white;
                    }
                    .tag-search-btn {
                        opacity: 0.7;
                        transition: opacity 0.2s ease;
                    }
                    .tag-item:hover .tag-search-btn {
                        opacity: 1;
                    }
                    .modal-close-btn {
                        width: 100%;
                        padding: 12px;
                        background: var(--glass);
                        border: 1px solid var(--glass-border);
                        color: var(--text);
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: 500;
                    }
                    .modal-close-btn:hover {
                        background: var(--card-hover);
                    }
                `;
                document.head.appendChild(styles);
            }

            document.body.appendChild(modal);
        }

        // Êõ¥Êñ∞Êí≠ÊîæÁä∂ÊÄÅ
        function updatePlayState(playing) {
            state.isPlaying = playing;
            const btn = $('play-btn');
            btn.textContent = playing ? '‚è∏' : '‚ñ∂';
            btn.setAttribute('data-playing', playing); // Áî®‰∫é CSS Ê†∑Âºè‰øÆÊ≠£
            $('player-cover').classList.toggle('spinning', playing);
        }

        // ÈöêËóèÊí≠ÊîæÂô®ÊåâÈíÆ
        function hidePlayerButtons() {
            const wikiBtn = $('player-wiki-btn');
            const tagBtn = $('player-tag-btn');
            if (wikiBtn) wikiBtn.style.display = 'none';
            if (tagBtn) tagBtn.style.display = 'none';
        }

        // Êí≠Êîæ/ÊöÇÂÅú
        function togglePlay() {
            if (!state.currentTrack && state.playlist.length > 0) {
                // Â¶ÇÊûúÊ≤°ÊúâÂΩìÂâçÊí≠ÊîæÁöÑÊ≠åÊõ≤‰ΩÜÊúâÊí≠ÊîæÂàóË°®ÔºåÂàôÊí≠ÊîæÁ¨¨‰∏ÄÈ¶ñ
                playSong(0);
            } else if (state.currentTrack) {
                // Ê£ÄÊü•ÊòØÂê¶ÊòØ YouTube Êù•Ê∫êÁöÑÊ≠åÊõ≤
                const isYouTube = state.currentTrack.kind === 'youtube' ||
                    (state.currentTrack.previewUrl && state.currentTrack.previewUrl.includes('youtube.com'));

                if (isYouTube) {
                    toggleYouTubePlay();
                } else {
                    // ÂØπ‰∫é iTunes Ê≠åÊõ≤ÔºåÁªßÁª≠‰ΩøÁî®Ê†áÂáÜÈü≥È¢ëÂÖÉÁ¥†
                    if (audio.src) {
                        if (audio.paused) {
                            audio.play()
                                .then(() => updatePlayState(true))
                                .catch(error => {
                                    console.error('Êó†Ê≥ïÊí≠ÊîæÈü≥È¢ë:', error);
                                    // If standard audio fails, try to initialize YouTube player if it's a YouTube source
                                    if (isYouTube) {
                                        toggleYouTubePlay();
                                    }
                                });
                        } else {
                            audio.pause();
                            updatePlayState(false);
                        }
                    }
                }
            }
        }

        // Helper function to find the next track by source type
        // findYouTube: true to find YouTube tracks, false to find non-YouTube tracks
        function findNextTrackBySource(currentIndex, findYouTube) {
            if (state.playlist.length <= 1) return -1;

            let index = (currentIndex + 1) % state.playlist.length;
            let initialIndex = currentIndex;

            // Loop through the playlist to find the next track of the desired source
            while (index !== initialIndex) {
                const track = state.playlist[index];
                const isYouTubeTrack = track.kind === 'youtube' || (track.previewUrl && track.previewUrl.includes('youtube.com'));

                if (findYouTube && isYouTubeTrack) {
                    // Looking for YouTube track and found one
                    return index;
                } else if (!findYouTube && !isYouTubeTrack) {
                    // Looking for non-YouTube track and found one
                    return index;
                }

                index = (index + 1) % state.playlist.length;

                // If we've looped back to the starting point, break to avoid infinite loop
                if (index === initialIndex) {
                    break;
                }
            }

            // No track of the desired source was found
            return -1;
        }

        // Helper function to find the previous track by source type
        // findYouTube: true to find YouTube tracks, false to find non-YouTube tracks
        function findPreviousTrackBySource(currentIndex, findYouTube) {
            if (state.playlist.length <= 1) return -1;

            let index = (currentIndex - 1 + state.playlist.length) % state.playlist.length;
            let initialIndex = currentIndex;

            // Loop through the playlist backwards to find the previous track of the desired source
            while (index !== initialIndex) {
                const track = state.playlist[index];
                const isYouTubeTrack = track.kind === 'youtube' || (track.previewUrl && track.previewUrl.includes('youtube.com'));

                if (findYouTube && isYouTubeTrack) {
                    // Looking for YouTube track and found one
                    return index;
                } else if (!findYouTube && !isYouTubeTrack) {
                    // Looking for non-YouTube track and found one
                    return index;
                }

                index = (index - 1 + state.playlist.length) % state.playlist.length;

                // If we've looped back to the starting point, break to avoid infinite loop
                if (index === initialIndex) {
                    break;
                }
            }

            // No track of the desired source was found
            return -1;
        }

        // Âú® YouTube Êí≠ÊîæÂô®‰∏≠Êí≠Êîæ‰∏ã‰∏ÄÈ¶ñ - ‰ΩøÁî®‰∏ÄËá¥ÁöÑÈÄªËæë
        function playNextForYouTube() {
            if (state.playMode === 'single') {
                // ÂçïÊõ≤Âæ™ÁéØÔºåÈáçÊñ∞Êí≠ÊîæÂΩìÂâçÊ≠åÊõ≤
                if (youtubePlayerManager.getPlayer()) {
                    youtubePlayerManager.seekTo(0);
                    youtubePlayerManager.playVideo();
                }
                return;
            }

            if (state.playlist.length === 0) return;

            let newIndex;
            if (state.playMode === 'random') {
                newIndex = Math.floor(Math.random() * state.playlist.length);
                // Â∞ΩÈáèÈÅøÂÖçÈöèÊú∫Âà∞Âêå‰∏ÄÈ¶ñÔºàÈô§ÈùûÂè™Êúâ‰∏ÄÈ¶ñÔºâ
                if (state.playlist.length > 1 && newIndex === state.currentIndex) {
                    newIndex = (newIndex + 1) % state.playlist.length;
                }
            } else {
                // Êîπ‰∏∫ÂßãÁªàÊåâÈ°∫Â∫èÊí≠Êîæ‰∏ã‰∏ÄÈ¶ñÔºåÊó†ËÆ∫Êù•Ê∫êÁ±ªÂûã
                newIndex = (state.currentIndex + 1) % state.playlist.length;
            }
            playSong(newIndex);
        }

        // ÂàáÊç¢Êí≠ÊîæÊ®°Âºè
        function togglePlayMode() {
            const modes = ['sequence', 'random', 'single'];
            const currentIdx = modes.indexOf(state.playMode);
            const nextIdx = (currentIdx + 1) % modes.length;
            state.playMode = modes[nextIdx];

            const btn = $('mode-btn');
            switch (state.playMode) {
                case 'sequence':
                    btn.textContent = 'üîÅ';
                    btn.title = 'ÂàóË°®Âæ™ÁéØ';
                    showToast('ÂàóË°®Âæ™ÁéØ');
                    break;
                case 'random':
                    btn.textContent = 'üîÄ';
                    btn.title = 'ÈöèÊú∫Êí≠Êîæ';
                    showToast('ÈöèÊú∫Êí≠Êîæ');
                    break;
                case 'single':
                    btn.textContent = 'üîÇ';
                    btn.title = 'ÂçïÊõ≤Âæ™ÁéØ';
                    showToast('ÂçïÊõ≤Âæ™ÁéØ');
                    break;
            }
        }

        // ‰∏ä‰∏ÄÈ¶ñ/‰∏ã‰∏ÄÈ¶ñ
        function playPrevious() {
            if (state.playlist.length === 0) return;

            let newIndex;
            if (state.playMode === 'random') {
                newIndex = Math.floor(Math.random() * state.playlist.length);
            } else {
                // Êîπ‰∏∫ÂßãÁªàÊåâÈ°∫Â∫èÊí≠Êîæ‰∏ä‰∏ÄÈ¶ñÔºåÊó†ËÆ∫Êù•Ê∫êÁ±ªÂûã
                newIndex = (state.currentIndex - 1 + state.playlist.length) % state.playlist.length;
            }
            playSong(newIndex);
        }

        function playNext(auto = false) {
            if (state.playlist.length === 0) return;

            // Â¶ÇÊûúÊòØËá™Âä®Êí≠ÊîæÔºàÊí≠ÊîæÁªìÊùüËß¶ÂèëÔºâ‰∏îÊòØÂçïÊõ≤Âæ™ÁéØ
            if (auto && state.playMode === 'single') {
                audio.currentTime = 0;
                audio.play();
                return;
            }

            let newIndex;
            if (state.playMode === 'random') {
                newIndex = Math.floor(Math.random() * state.playlist.length);
                // Â∞ΩÈáèÈÅøÂÖçÈöèÊú∫Âà∞Âêå‰∏ÄÈ¶ñÔºàÈô§ÈùûÂè™Êúâ‰∏ÄÈ¶ñÔºâ
                if (state.playlist.length > 1 && newIndex === state.currentIndex) {
                    newIndex = (newIndex + 1) % state.playlist.length;
                }
            } else {
                // Êîπ‰∏∫ÂßãÁªàÊåâÈ°∫Â∫èÊí≠Êîæ‰∏ã‰∏ÄÈ¶ñÔºåÊó†ËÆ∫Êù•Ê∫êÁ±ªÂûã
                newIndex = (state.currentIndex + 1) % state.playlist.length;
            }
            playSong(newIndex);
        }

        // ËøõÂ∫¶Êù°
        audio.ontimeupdate = () => {
            // Only update progress bar for non-YouTube sources (iTunes previews)
            if (!state.currentTrack || !(state.currentTrack.kind === 'youtube' ||
                (state.currentTrack.previewUrl && state.currentTrack.previewUrl.includes('youtube.com')))) {
                if (isNaN(audio.duration)) return;
                const pct = (audio.currentTime / audio.duration) * 100;
                $('progress-fill').style.width = pct + '%';
                $('current-time').textContent = formatTime(audio.currentTime);
            }
        };

        audio.onloadedmetadata = () => {
            // Only update duration for non-YouTube sources
            if (!state.currentTrack || !(state.currentTrack.kind === 'youtube' ||
                (state.currentTrack.previewUrl && state.currentTrack.previewUrl.includes('youtube.com')))) {
                $('total-time').textContent = formatTime(audio.duration);
            }
        };

        audio.onended = () => {
            // For YouTube, we rely on the YouTube player's onStateChange event
            if (!state.currentTrack || !(state.currentTrack.kind === 'youtube' ||
                (state.currentTrack.previewUrl && state.currentTrack.previewUrl.includes('youtube.com')))) {
                updatePlayState(false);
                playNext(true); // ‰º†ÂÖ• true Ë°®Á§∫Ëá™Âä®Êí≠Êîæ
            }
        };

        // ‰∏∫ YouTube Êí≠ÊîæÂô®ÂàõÂª∫ÂÆöÊó∂Âô®Êù•Êõ¥Êñ∞ËøõÂ∫¶ - ‰ΩøÁî®Êõ¥È¢ëÁπÅÁöÑÊõ¥Êñ∞
        // Using a more robust interval that can continue in background
        let youtubeProgressInterval = setInterval(() => {
            if (youtubePlayerManager.getPlayer() && youtubePlayerManager.isPlaying()) {
                try {
                    const currentTime = youtubePlayerManager.getCurrentTime();
                    const duration = youtubePlayerManager.getDuration();

                    if (!isNaN(duration) && !isNaN(currentTime) && duration > 0) {
                        const pct = (currentTime / duration) * 100;
                        $('progress-fill').style.width = pct + '%';
                        $('current-time').textContent = formatTime(currentTime);
                        $('total-time').textContent = formatTime(duration);

                        // Update media session position state for background playback controls
                        if ('setPositionState' in navigator.mediaSession) {
                            navigator.mediaSession.setPositionState({
                                duration: duration,
                                playbackRate: 1.0,
                                position: currentTime
                            });
                        }
                    }
                } catch (e) {
                    // Â¶ÇÊûú YouTube Êí≠ÊîæÂô®ËøòÊ≤°ÂáÜÂ§áÂ•ΩÔºåÂøΩÁï•ÈîôËØØ
                }
            }
        }, 500); // ÊØè0.5ÁßíÊõ¥Êñ∞‰∏ÄÊ¨°ËøõÂ∫¶Ôºå‰ΩøÊó∂Èó¥ËΩ¥Êõ¥ÊµÅÁïÖ

        // Store the interval ID so we can clear it if needed
        state.youtubeProgressInterval = youtubeProgressInterval;

        // Additional progress update function specifically for PWA compatibility
        let pwaProgressInterval = null;

        function startPWAProgressUpdates() {
            if (pwaProgressInterval) {
                clearInterval(pwaProgressInterval);
            }

            pwaProgressInterval = setInterval(() => {
                if (youtubePlayerManager.getPlayer() && youtubePlayerManager.isPlaying()) {
                    updateYouTubeProgress();
                }
            }, 800); // Slightly longer than the main interval to avoid conflicts
        }

        function stopPWAProgressUpdates() {
            if (pwaProgressInterval) {
                clearInterval(pwaProgressInterval);
                pwaProgressInterval = null;
            }
        }

        function updateYouTubeProgress() {
            if (youtubePlayerManager.getPlayer()) {
                try {
                    const currentTime = youtubePlayerManager.getCurrentTime();
                    const duration = youtubePlayerManager.getDuration();

                    if (!isNaN(duration) && !isNaN(currentTime) && duration > 0) {
                        const pct = (currentTime / duration) * 100;
                        $('progress-fill').style.width = pct + '%';
                        $('current-time').textContent = formatTime(currentTime);
                        $('total-time').textContent = formatTime(duration);

                        // Update media session position state for background playback controls
                        if ('setPositionState' in navigator.mediaSession) {
                            navigator.mediaSession.setPositionState({
                                duration: duration,
                                playbackRate: 1.0,
                                position: currentTime
                            });
                        }
                    }
                } catch (e) {
                    // Â¶ÇÊûú YouTube Êí≠ÊîæÂô®ËøòÊ≤°ÂáÜÂ§áÂ•ΩÔºåÂøΩÁï•ÈîôËØØ
                }
            }
        }

        // ÂÅúÊ≠¢ÂºπÂπïÁ≥ªÁªü
        function stopDanmaku() {
            if (state.danmakuInterval) {
                clearInterval(state.danmakuInterval);
                state.danmakuInterval = null;
            }
            $('danmaku').classList.remove('show');
            $('danmaku').innerHTML = '';
            // Clear the displayed danmaku set
            state.displayedDanmaku.clear();
            // Clear recent danmaku indices
            if (state.recentDanmakuIndices) {
                state.recentDanmakuIndices = [];
            }
            // Reset tracks
            state.tracks = [false, false, false, false, false];
            // ÂÅúÊ≠¢ÂÆöÊúüÂà∑Êñ∞ÂºπÂπïÊï∞ÊçÆ
            DanmakuManager.stopRefresh();
        }

        function seek(e) {
            if (!audio.src) return;
            const rect = $('progress-bar').getBoundingClientRect();
            const pct = (e.clientX - rect.left) / rect.width;
            audio.currentTime = pct * audio.duration;
        }

        function formatTime(sec) {
            const m = Math.floor(sec / 60);
            const s = Math.floor(sec % 60);
            return `${m}:${s.toString().padStart(2, '0')}`;
        }

        // Êí≠ÊîæÂÆåÊï¥Ê≠åÊõ≤ÔºàÂú®Apple Music‰∏≠Ôºâ
        function playFullSong(trackId, trackName, artistName) {
            const song = state.playlist.find(s => s.trackId == trackId);
            const albumId = song?.collectionId || trackId;

            const musicAppUrl = `music://music.apple.com/cn/album/${albumId}?i=${trackId}`;
            const webUrl = `https://music.apple.com/cn/album/${albumId}?i=${trackId}`;

            // Ê£ÄÊµãËÆæÂ§áÁ±ªÂûã
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isMac = /Macintosh/.test(navigator.userAgent);
            const isAppleDevice = isIOS || isMac;

            if (isAppleDevice) {
                // Apple ËÆæÂ§áÔºöÂ∞ùËØïÊâìÂºÄ App
                const startTime = Date.now();

                // ‰ΩøÁî® visibilitychange Ê£ÄÊµãÊòØÂê¶ÊàêÂäüË∑≥ËΩ¨Âà∞ App 
                const handleVisibilityChange = () => {
                    if (document.hidden) {
                        // È°µÈù¢Ë¢´ÈöêËóèÔºåËØ¥ÊòéÊàêÂäüÊâìÂºÄ‰∫Ü App
                        clearTimeout(fallbackTimer);
                        document.removeEventListener('visibilitychange', handleVisibilityChange);
                    }
                };
                document.addEventListener('visibilitychange', handleVisibilityChange);

                // Â∞ùËØïÊâìÂºÄ App
                window.location.href = musicAppUrl;

                // ËÆæÁΩÆÈôçÁ∫ßÂÆöÊó∂Âô®
                const fallbackTimer = setTimeout(() => {
                    document.removeEventListener('visibilitychange', handleVisibilityChange);

                    // Â¶ÇÊûúÈ°µÈù¢ËøòÂèØËßÅ‰∏îÊó∂Èó¥ÂæàÁü≠ÔºåËØ¥Êòé App Ê≤°ÊâìÂºÄ
                    if (!document.hidden && Date.now() - startTime < 2000) {
                        showFallbackOptions(trackName, artistName, webUrl);
                    }
                }, 1500);

            } else {
                // Èùû Apple ËÆæÂ§áÔºöÁõ¥Êé•ÊâìÂºÄÁΩëÈ°µÁâà
                window.open(webUrl, '_blank');
                showToast(`Ê≠£Âú®ÊâìÂºÄ "${trackName}" - ${artistName}`);
            }
        }

        // Êí≠Êîæ YouTube ÂÆåÊï¥Ê≠åÊõ≤ÔºàÈÄâÈ°πËèúÂçïË∞ÉÁî®Ôºâ
        function playYouTubeFullSong(videoId, trackName, artistName, coverUrl) {
            playYouTubeSong(videoId, trackName, artistName, coverUrl);
        }

        // ÊâìÂºÄ iTunes Ê≠åÊõ≤Âú® Apple Music Â∫îÁî®ÊàñÁΩëÈ°µ‰∏≠
        function openAppleMusic(trackId, trackName, artistName) {
            const song = state.playlist.find(s => s.trackId == trackId);
            const albumId = song?.collectionId || trackId;

            const musicAppUrl = `music://music.apple.com/cn/album/${albumId}?i=${trackId}`;
            const webUrl = `https://music.apple.com/cn/album/${albumId}?i=${trackId}`;

            // Ê£ÄÊµãËÆæÂ§áÁ±ªÂûã
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isMac = /Macintosh/.test(navigator.userAgent);
            const isAppleDevice = isIOS || isMac;

            if (isAppleDevice) {
                // Apple ËÆæÂ§áÔºöÂ∞ùËØïÊâìÂºÄ App
                const startTime = Date.now();

                // ‰ΩøÁî® visibilitychange Ê£ÄÊµãÊòØÂê¶ÊàêÂäüË∑≥ËΩ¨Âà∞ App
                const handleVisibilityChange = () => {
                    if (document.hidden) {
                        // È°µÈù¢Ë¢´ÈöêËóèÔºåËØ¥ÊòéÊàêÂäüÊâìÂºÄ‰∫Ü App
                        clearTimeout(fallbackTimer);
                        document.removeEventListener('visibilitychange', handleVisibilityChange);
                    }
                };
                document.addEventListener('visibilitychange', handleVisibilityChange);

                // Â∞ùËØïÊâìÂºÄ App
                window.location.href = musicAppUrl;

                // ËÆæÁΩÆÈôçÁ∫ßÂÆöÊó∂Âô®
                const fallbackTimer = setTimeout(() => {
                    document.removeEventListener('visibilitychange', handleVisibilityChange);

                    // Â¶ÇÊûúÈ°µÈù¢ËøòÂèØËßÅ‰∏îÊó∂Èó¥ÂæàÁü≠ÔºåËØ¥Êòé App Ê≤°ÊâìÂºÄ
                    if (!document.hidden && Date.now() - startTime < 2000) {
                        showFallbackOptions(trackName, artistName, webUrl);
                    }
                }, 1500);

            } else {
                // Èùû Apple ËÆæÂ§áÔºöÁõ¥Êé•ÊâìÂºÄÁΩëÈ°µÁâà
                window.open(webUrl, '_blank');
                showToast(`Ê≠£Âú®ÊâìÂºÄ "${trackName}" - ${artistName}`);
            }
        }

            // ÊâìÂºÄ YouTube Ê≠åÊõ≤Âú® YouTube Â∫îÁî®ÊàñÁΩëÈ°µ‰∏≠
            function openYouTubeApp(videoId, trackName, artistName) {
                const webUrl = `https://www.youtube.com/watch?v=${videoId}`;
        // Android Intent (Chrome Êé®ËçêÊñπÂºè)
        // S.browser_fallback_url ÊåáÂÆö‰∫ÜÂ¶ÇÊûúÊ≤°ÂÆâË£Ö App Ë∑≥ËΩ¨ÁöÑÂú∞ÂùÄ
        const androidIntent = `intent://www.youtube.com/watch?v=${videoId}#Intent;package=com.google.android.youtube;scheme=https;S.browser_fallback_url=${encodeURIComponent(webUrl)};end`;
        // iOS Scheme (‰∏çÊé®ËçêÔºåÊé®ËçêÁõ¥Êé•Áî® webUrlÔºå‰ΩÜÂú®Êüê‰∫õÂú∫ÊôØÂèØÁî®)
        const iosScheme = `youtube://watch?v=${videoId}`;

        // 1. Êõ¥Á≤æÂáÜÁöÑËÆæÂ§áÊ£ÄÊµã
        const u = navigator.userAgent;
        const isAndroid = u.indexOf('Android') > -1 || u.indexOf('Adr') > -1;
        // ÂÖºÂÆπ iPad Desktop Mode ÁöÑÊ£ÄÊµã
        const isIOS = !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

        showToast(`Ê≠£Âú®ÊâìÂºÄ "${trackName}" - ${artistName}`);

        if (isAndroid) {
            // Android ÊúÄ‰Ω≥ÂÆûË∑µ: ‰ΩøÁî® Intent
            // Â¶ÇÊûúÂ∑≤ÂÆâË£Ö AppÔºåÁ≥ªÁªüÁõ¥Êé•ÊâìÂºÄÔºõÊ≤°ÂÆâË£ÖÔºåChrome ‰ºöËá™Âä®Â§ÑÁêÜ fallback Âà∞ÁΩëÈ°µ
            window.location.href = androidIntent;
        } else if (isIOS) {
            // iOS ÊúÄ‰Ω≥ÂÆûË∑µ: Áõ¥Êé•ËÆøÈóÆ Universal Link (HTTPS)
            // iOS Á≥ªÁªü‰ºöËá™Âä®Êã¶Êà™Ëøô‰∏™ÈìæÊé•Âπ∂ËØ¢ÈóÆÊòØÂê¶Âú® App ‰∏≠ÊâìÂºÄ
            // Âº∫Ë°åÁî® Scheme ÂæÄÂæÄ‰ΩìÈ™å‰∏çÂ•ΩÔºå‰∏îÂæàÈöæÂáÜÁ°ÆÂà§Êñ≠ÊòØÂê¶ÂÆâË£Ö
            window.location.href = webUrl;
            
            // --- Â¶ÇÊûú‰Ω†ÈùûË¶ÅÂº∫Ë°åÂ∞ùËØï Scheme (‰∏çÊé®Ëçê) ---
            // window.location.href = iosScheme; 
            // setTimeout(() => {
            //    // iOS ‰∏ä‰∏çËÉΩÂú® timeout Èáå window.openÔºåÂè™ËÉΩÊîπÂèò location
            //    window.location.href = webUrl; 
            // }, 2000);
            // ----------------------------------------
        } else {
            // Ê°åÈù¢Á´Ø
            window.open(webUrl, '_blank');
        }
    }
        // ÊâìÂºÄ YouTube Ê≠åÊõ≤Âú® YouTube Music Â∫îÁî®ÊàñÁΩëÈ°µ‰∏≠
        function openYouTubeMusic(videoId, trackName, artistName) {
            const webUrl = `https://music.youtube.com/watch?v=${videoId}`;
            const ytmusicUrl = `https://www.youtube.com/watch?v=${videoId}`; // YouTube Music app scheme
            const youtubemusicUrl = `https://www.youtube.com/watch?v=${videoId}`; // Alternative scheme

            // Ê£ÄÊµãËÆæÂ§áÁ±ªÂûã
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);
            const isMobile = isIOS || isAndroid;

            if (isMobile) {
                // ÁßªÂä®ËÆæÂ§áÔºöÂ∞ùËØïÊâìÂºÄ YouTube Music App with multiple fallbacks
                const startTime = Date.now();

                // Try YouTube Music specific schemes first
                const schemesToTry = [ytmusicUrl, youtubemusicUrl];

                let schemeIndex = 0;
                const tryNextScheme = () => {
                    if (schemeIndex < schemesToTry.length) {
                        const schemeUrl = schemesToTry[schemeIndex];
                        schemeIndex++;

                        // ‰ΩøÁî® iframe ÊñπÂºèÂ∞ùËØïÊâìÂºÄÔºåËøôÊ†∑‰∏ç‰ºöË¢´Êã¶Êà™
                        const iframe = document.createElement('iframe');
                        iframe.style.display = 'none';
                        iframe.src = schemeUrl;
                        document.body.appendChild(iframe);

                        // Remove the iframe after a short time
                        setTimeout(() => {
                            if (iframe.parentNode) {
                                document.body.removeChild(iframe);
                            }

                            // Check if app opened by measuring elapsed time
                            if (Date.now() - startTime < 2000 && schemeIndex < schemesToTry.length) {
                                // If still on page, try next scheme
                                tryNextScheme();
                            } else if (Date.now() - startTime < 2000) {
                                // If still on page and all schemes tried, fallback to web
                                window.open(webUrl, '_blank');
                                showToast(`Ê≠£Âú®ÊâìÂºÄ "${trackName}" - ${artistName}`);
                            }
                        }, 800); // Reduced timeout to try schemes faster
                    } else {
                        // All schemes tried, fallback to web
                        if (Date.now() - startTime < 2000) {
                            window.open(webUrl, '_blank');
                            showToast(`Ê≠£Âú®ÊâìÂºÄ "${trackName}" - ${artistName}`);
                        }
                    }
                };

                tryNextScheme();

            } else {
                // Ê°åÈù¢ËÆæÂ§áÔºöÁõ¥Êé•ÊâìÂºÄÁΩëÈ°µÁâà
                window.open(webUrl, '_blank');
                showToast(`Ê≠£Âú®ÊâìÂºÄ "${trackName}" - ${artistName}`);
            }
        }

        // ÊòæÁ§∫Ê≠åÊõ≤ÈÄâÈ°πËèúÂçï
        function toggleOptionsMenu(event, trackId, trackName, artistName, coverUrl, isYouTube) {
            event.stopPropagation();

            // ÁßªÈô§Â∑≤Â≠òÂú®ÁöÑÈÄâÈ°πËèúÂçï
            const existingMenu = document.querySelector('.song-options-menu');
            if (existingMenu) {
                existingMenu.remove();
            }

            // ÂàõÂª∫ÈÄâÈ°πËèúÂçï
            const menu = document.createElement('div');
            menu.className = 'song-options-menu';
            menu.style.cssText = `
                position: absolute;
                top: 32px;
                right: 8px;
                background: var(--card);
                border: 1px solid var(--glass-border);
                border-radius: 12px;
                padding: 8px 0;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                z-index: 100;
                min-width: 160px;
            `;

            // Ê†πÊçÆÊù•Ê∫êÊûÑÂª∫ËèúÂçïÈ°π
            if (isYouTube) {
                menu.innerHTML = `
                    <div class="option-item" onclick="playYouTubeSong('${trackId}', '${trackName}', '${artistName}', '${coverUrl}'); this.closest('.song-options-menu').remove();">
                        <span>üéµ Âú®Ê≠§Êí≠Êîæ</span>
                    </div>
                    <div class="option-item" onclick="openYouTubeApp('${trackId}', '${trackName}', '${artistName}'); this.closest('.song-options-menu').remove();">
                        <span>‚ñ∂Ô∏è ÊâìÂºÄ YouTube Â∫îÁî®</span>
                    </div>
                    <div class="option-item" onclick="openJumpLink('${escapeHtml(trackName)}', '${escapeHtml(artistName)}'); this.closest('.song-options-menu').remove();">
                        <span>üîó Ë∑≥ËΩ¨ÈìæÊé•</span>
                    </div>
                `;
            } else {
                menu.innerHTML = `
                    <div class="option-item" onclick="playFullSong('${trackId}', '${trackName}', '${artistName}'); this.closest('.song-options-menu').remove();">
                        <span>üéµ Âú®Ê≠§Êí≠Êîæ</span>
                    </div>
                    <div class="option-item" onclick="openAppleMusic('${trackId}', '${trackName}', '${artistName}'); this.closest('.song-options-menu').remove();">
                        <span>üì± ÊâìÂºÄ Apple Music</span>
                    </div>
                `;
            }

            // Ê∑ªÂä†ÈÄâÈ°πÈ°πÁöÑÊ†∑Âºè
            if (!document.querySelector('#song-options-menu-styles')) {
                const styles = document.createElement('style');
                styles.id = 'song-options-menu-styles';
                styles.textContent = `
                    .option-item {
                        padding: 10px 16px;
                        cursor: pointer;
                        transition: background 0.2s ease;
                        font-size: 14px;
                        color: var(--text);
                    }
                    .option-item:hover {
                        background: var(--glass-border);
                    }
                    .song-options-menu {
                        position: absolute;
                        top: 32px;
                        right: 8px;
                        background: var(--card);
                        border: 1px solid var(--glass-border);
                        border-radius: 12px;
                        padding: 8px 0;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                        z-index: 100;
                        min-width: 160px;
                    }
                `;
                document.head.appendChild(styles);
            }

            // Ê∑ªÂä†ËèúÂçïÂà∞È°µÈù¢
            document.body.appendChild(menu);

            // ÂÆö‰ΩçËèúÂçïÔºàÁõ∏ÂØπ‰∫éÁÇπÂáªÁöÑÁõÆÊ†áÂÖÉÁ¥†Ôºâ
            const targetRect = event.target.getBoundingClientRect();
            menu.style.top = `${targetRect.bottom + window.scrollY - 8}px`;
            menu.style.right = `${window.innerWidth - targetRect.right - 16}px`;

            // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠ËèúÂçï
            setTimeout(() => {
                const closeMenu = (e) => {
                    if (!menu.contains(e.target) && e.target !== event.target) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                };
                document.addEventListener('click', closeMenu);
            }, 10);
        }

        // ÊòæÁ§∫ÈôçÁ∫ßÈÄâÈ°π
        function showFallbackOptions(trackName, artistName, webUrl) {
            // ÂàõÂª∫‰∏Ä‰∏™Êõ¥ÂèãÂ•ΩÁöÑÊèêÁ§∫Ê°Ü
            const modal = document.createElement('div');
            modal.className = 'apple-music-modal';
            modal.innerHTML = `
        <div class="modal-overlay" onclick="this.parentElement.remove()">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-icon">üéµ</div>
                <h3>ÊâìÂºÄ Apple Music</h3>
                <p>Âç≥Â∞ÜÊí≠Êîæ "${trackName}"<br><span class="artist">${artistName}</span></p>
                <div class="modal-buttons">
                    <a href="${webUrl}" target="_blank" class="btn-primary" onclick="this.closest('.apple-music-modal').remove()">
                        Âú®ÁΩëÈ°µ‰∏≠ÊâìÂºÄ
                    </a>
                    <button class="btn-secondary" onclick="this.closest('.apple-music-modal').remove()">
                        ÂèñÊ∂à
                    </button>
                </div>
                <p class="hint">ÊèêÁ§∫ÔºöÂÆâË£Ö Apple Music Â∫îÁî®ÂèØËé∑ÂæóÊõ¥Â•Ω‰ΩìÈ™å</p>
            </div>
        </div>
    `;

            // Ê∑ªÂä†Ê†∑Âºè
            if (!document.querySelector('#apple-music-modal-styles')) {
                const styles = document.createElement('style');
                styles.id = 'apple-music-modal-styles';
                styles.textContent = `
            .apple-music-modal .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: fadeIn 0.2s ease;
            }
            .apple-music-modal .modal-content {
                background: white;
                border-radius: 16px;
                padding: 24px;
                max-width: 320px;
                width: 90%;
                text-align: center;
                animation: slideUp 0.3s ease;
            }
            .apple-music-modal .modal-icon {
                font-size: 48px;
                margin-bottom: 12px;
            }
            .apple-music-modal h3 {
                margin: 0 0 8px;
                font-size: 18px;
                color: #1a1a1a;
            }
            .apple-music-modal p {
                margin: 0 0 16px;
                color: #666;
                font-size: 14px;
                line-height: 1.5;
            }
            .apple-music-modal .artist {
                color: #999;
            }
            .apple-music-modal .modal-buttons {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            .apple-music-modal .btn-primary {
                background: linear-gradient(135deg, #fc3c44, #d93a41);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 10px;
                font-size: 16px;
                font-weight: 500;
                cursor: pointer;
                text-decoration: none;
                display: block;
            }
            .apple-music-modal .btn-secondary {
                background: #f0f0f0;
                color: #333;
                border: none;
                padding: 12px 24px;
                border-radius: 10px;
                font-size: 16px;
                cursor: pointer;
            }
            .apple-music-modal .hint {
                font-size: 12px;
                color: #999;
                margin-top: 16px;
                margin-bottom: 0;
            }
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            @keyframes slideUp {
                from { transform: translateY(20px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
        `;
                document.head.appendChild(styles);
            }

            document.body.appendChild(modal);
        }

        // Initialize YouTube player manager
        const youtubePlayerManager = new YouTubePlayerManager();

        // Set up event listeners for YouTube player events
        document.addEventListener('youtubePlayerReady', (e) => {
            console.log('Event caught: Player is ready.');
            // Update UI and initialize PWA progress updates
            // Only update play state, actual play is handled by calling function
            updatePlayState(youtubePlayerManager.isPlaying());
        });

        document.addEventListener('youtubePlayerPlaying', (e) => {
            console.log('Event caught: Player is playing.');
            // Update global state
            state.isYouTubePlaying = true;
            updatePlayState(true);
            // Start PWA progress updates
            startPWAProgressUpdates();
        });

        document.addEventListener('youtubePlayerPaused', (e) => {
            console.log('Event caught: Player is paused.');
            state.isYouTubePlaying = false;
            updatePlayState(false);
            stopPWAProgressUpdates();
        });

        document.addEventListener('youtubePlayerEnded', (e) => {
            console.log('Event caught: Player has ended.');
            state.isYouTubePlaying = false;
            updatePlayState(false);
            stopPWAProgressUpdates();
            setTimeout(() => playNext(true), 300); // Use the same logic as non-YouTube sources, with auto=true for automatic playback
        });

        document.addEventListener('youtubePlayerError', (e) => {
            console.log('Event caught: Player error.', e.detail.error);
            // Handle error appropriately
            state.isYouTubePlaying = false;
            updatePlayState(false);
            stopPWAProgressUpdates();
            showToast('YouTube Êí≠ÊîæÂá∫Áé∞ÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï');
        });

        // Update the playYouTubeSong function to use YouTube player
        async function playYouTubeSong(videoId, title, artist, coverUrl = '') {
            if (!videoId) return;

            try {
                // Update state and UI first
                state.currentTrack = {
                    trackId: videoId,
                    trackName: title,
                    artistName: artist,
                    artworkUrl100: coverUrl || 'https://i.ytimg.com/img/no_thumbnail.jpg',
                    kind: 'youtube'
                };

                // Update player UI
                const cover = coverUrl || 'https://i.ytimg.com/img/no_thumbnail.jpg';
                $('player-cover').src = cover;

                const titleTextEl = $('player-title-text');
                const artistTextEl = $('player-artist-text');

                titleTextEl.textContent = title;
                artistTextEl.textContent = artist;

                // Add search functionality to title and artist
                titleTextEl.onclick = () => searchBySong(title);
                artistTextEl.onclick = () => searchByArtist(artist);
                titleTextEl.style.cursor = 'pointer';
                artistTextEl.style.cursor = 'pointer';

                // Update top info bar
                $('player-cover').src = cover;
                $('bg-album').style.backgroundImage = `url(${cover})`;
                $('bg-album').classList.add('active');

                // Setup Wikipedia button
                const wikiBtn = $('player-wiki-btn');
                const cleanArtistName = artist.split(/&|,|feat\.|ft\./i)[0].trim();
                wikiBtn.style.display = 'flex';
                wikiBtn.onclick = () => {
                    const wikiUrl = `https://zh.wikipedia.org/wiki/${encodeURIComponent(cleanArtistName)}`;
                    window.open(wikiUrl, '_blank');
                };
                wikiBtn.title = `Êü•Áúã ${cleanArtistName} ÁöÑÁª¥Âü∫ÁôæÁßë`;

                // Setup tag recommendation button
                const tagBtn = $('player-tag-btn');
                tagBtn.style.display = 'flex';
                tagBtn.onclick = () => {
                    showCurrentSongTags();
                };
                tagBtn.title = 'Êü•ÁúãÊ≠åÊõ≤Ê†áÁ≠æÊé®Ëçê';

                // Check if text needs scrolling
                const checkScroll = (el) => {
                    el.classList.remove('scroll-text');
                    el.style.transform = 'none';

                    const containerWidth = el.parentElement.clientWidth;
                    const textWidth = el.scrollWidth;

                    if (textWidth > containerWidth) {
                        const distance = containerWidth - textWidth;
                        const duration = Math.abs(distance) / 30 + 2;

                        el.style.setProperty('--scroll-distance', `${distance}px`);
                        el.style.setProperty('--duration', `${duration}s`);
                        el.classList.add('scroll-text');
                    }
                };

                setTimeout(() => {
                    checkScroll(titleTextEl);
                    checkScroll(artistTextEl);
                }, 50);


                // Danmaku
                startDanmaku();

                // Preload lyrics
                $('lyrics-title').textContent = title;
                $('lyrics-artist').textContent = artist;
                setupWikipediaLink(artist);
                $('lyrics-cover').src = cover;
                $('lyrics-text').textContent = 'Âä†ËΩΩ‰∏≠...';
                $('lyrics-wiki').classList.remove('show');

                fetchLyrics(artist, title);
                fetchArtistWiki(artist);

                // Add to history
                HistoryManager.add({
                    trackId: videoId,
                    trackName: title,
                    artistName: artist,
                    artworkUrl100: cover,
                    kind: 'youtube'
                });

                // Update media session (with updated metadata)
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.metadata = new MediaMetadata({
                        title: title,
                        artist: artist,
                        album: 'YouTube Music',
                        artwork: [
                            { src: cover, sizes: '96x96', type: 'image/jpeg' },
                            { src: cover, sizes: '128x128', type: 'image/jpeg' },
                            { src: cover, sizes: '192x192', type: 'image/jpeg' },
                            { src: cover, sizes: '256x256', type: 'image/jpeg' },
                            { src: cover, sizes: '512x512', type: 'image/jpeg' }
                        ]
                    });

                    navigator.mediaSession.setActionHandler('play', toggleYouTubePlay);
                    navigator.mediaSession.setActionHandler('pause', toggleYouTubePlay);
                    navigator.mediaSession.setActionHandler('previoustrack', playPrevious);
                    navigator.mediaSession.setActionHandler('nexttrack', () => playNext(false));
                }

                // Update favorite button state
                updateFavoriteButton();

                // Update recommendation tags
                updateRecommendationTags(state.currentTrack);

                // Ê£ÄÊµãÊòØÂê¶‰∏∫ÁßªÂä®ËÆæÂ§á
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

                // Use the YouTubePlayerManager to initialize and play the video
                try {
                    // Ensure the YouTube API is loaded
                    await youtubePlayerManager.loadAPI();

                    // Set up container if it doesn't exist
                    let playerContainer = document.getElementById('youtube-player-container');
                    if (!playerContainer) {
                        playerContainer = document.createElement('div');
                        playerContainer.id = 'youtube-player-container';
                        document.body.appendChild(playerContainer);
                    }
                    
                    // Always ensure correct styling to avoid display:none issues
                    playerContainer.style.position = 'absolute';
                    playerContainer.style.top = '-9999px';
                    playerContainer.style.left = '-9999px';
                    playerContainer.style.width = '1px';
                    playerContainer.style.height = '1px';
                    playerContainer.style.opacity = '0';
                    playerContainer.style.pointerEvents = 'none';
                    playerContainer.style.display = 'block'; // Explicitly override any display:none

                    // Configure player parameters
                    const playerOptions = {
                        videoId: videoId,
                        playerVars: {
                            'playsinline': 1,
                            'controls': 0,
                            'disablekb': 1,
                            'fs': 0,
                            'iv_load_policy': 3,
                            'modestbranding': 1,
                            'rel': 0,
                            'autoplay': 1,
                            'mute': 0,
                            'enablejsapi': 1,
                            'origin': window.location.origin
                        }
                    };

                    // Initialize the player with the manager
                    const player = await youtubePlayerManager.initPlayer('youtube-player-container', playerOptions);

                    // Update state to indicate that YouTube player is being used
                    youtubePlayerManager.setState({ shouldAutoplayYouTube: true });

                    // Explicitly play the video after initialization
                    setTimeout(() => {
                        if (youtubePlayerManager.getPlayer()) {
                            youtubePlayerManager.playVideo();
                        }
                    }, 100); // Small delay to ensure player is fully ready

                    if (isMobile) {
                        showToast('Êí≠ÊîæÂô®Â∑≤Â∞±Áª™...');
                    }
                } catch (error) {
                    console.error('Error initializing YouTube player with manager:', error);
                    showToast('YouTube Êí≠ÊîæÂô®ÂàùÂßãÂåñÂ§±Ë¥•...');

                    // Fallback: use the audio element with YouTube video URL (may not work in all browsers due to CORS)
                    const audioUrl = `https://www.youtube.com/watch?v=${videoId}`;
                    audio.src = audioUrl;
                    audio.load();
                    audio.play()
                        .then(() => {
                            updatePlayState(true);
                            state.isYouTubePlaying = true;
                        })
                        .catch(err => {
                            console.error('Fallback also failed:', err);
                            showToast('Âç≥Â∞ÜÂáÜÂ§áÂ∞±Áª™ÔºåÂà´ÁùÄÊÄ•');
                            updatePlayState(false);
                            state.isYouTubePlaying = false;
                        });
                }
            } catch (error) {
                console.error('Error initializing YouTube player:', error);
                showToast('YouTube Êí≠ÊîæÂô®ÂàùÂßãÂåñÂ§±Ë¥•...');

                // Fallback: use the audio element with YouTube video URL (may not work in all browsers)
                const audioUrl = `https://www.youtube.com/watch?v=${videoId}`;
                audio.src = audioUrl;
                audio.load();
                audio.play()
                    .then(() => {
                        updatePlayState(true);
                        state.isYouTubePlaying = true;
                    })
                    .catch(err => {
                        console.error('Fallback also failed:', err);
                        showToast('Âç≥Â∞ÜÂáÜÂ§áÂ∞±Áª™ÔºåÂà´ÁùÄÊÄ•');
                        updatePlayState(false);
                        state.isYouTubePlaying = false;
                    });
            }
        }

        // Toggle play/pause for YouTube player
        function toggleYouTubePlay() {
            if (youtubePlayerManager && youtubePlayerManager.getPlayer()) {
                if (youtubePlayerManager.isPlaying()) {
                    // ÊöÇÂÅúÊí≠Êîæ
                    youtubePlayerManager.pauseVideo();
                    // State will be updated via event listener
                } else {
                    // ÂºÄÂßãÊí≠Êîæ - Á°Æ‰øùÂú®Áî®Êà∑‰∫§‰∫í‰∏ä‰∏ãÊñá‰∏≠
                    // Ê£ÄÊµãÊòØÂê¶‰∏∫ÁßªÂä®ËÆæÂ§á
                    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

                    if (isMobile) {
                        showToast('Ê≠£Âú®ÂáÜÂ§áÊí≠ÊîæÔºåËØ∑Á®çÂÄô...');
                    }

                    // Á´ãÂç≥Â∞ùËØïÊí≠ÊîæÔºàÂú®Áî®Êà∑‰∫§‰∫íÁöÑ‰∏ä‰∏ãÊñá‰∏≠Ôºâ
                    try {
                        // Á°Æ‰øùÈü≥È¢ë‰∏ä‰∏ãÊñáÂ∞±Áª™
                        requestAudioPlayback().then(() => {
                            // Á´ãÂç≥Êí≠ÊîæËßÜÈ¢ë
                            youtubePlayerManager.playVideo();
                            // State will be updated via event listener
                            if (isMobile) {
                                showToast('ÂºÄÂßãÊí≠Êîæ');
                            }
                        }).catch(err => {
                            console.warn('Audio context playback request failed:', err);
                            // Âç≥‰ΩøÈü≥È¢ë‰∏ä‰∏ãÊñáÊúâÈóÆÈ¢òÔºå‰ªçÁÑ∂Â∞ùËØïÊí≠ÊîæËßÜÈ¢ë
                            youtubePlayerManager.playVideo();
                            // State will be updated via event listener
                            if (isMobile) {
                                showToast('ÂºÄÂßãÊí≠Êîæ');
                            }
                        });
                    } catch (error) {
                        console.error('Failed to play YouTube video:', error);

                        // Ê£ÄÊµãÊòØÂê¶‰∏∫ÁßªÂä®ËÆæÂ§áÂπ∂Êèê‰æõÊõ¥ÂÖ∑‰ΩìÁöÑÊèêÁ§∫
                        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

                        if (isMobile) {
                            // ÂØπ‰∫éÁßªÂä®ËÆæÂ§áÔºåÊèê‰æõÊõ¥Â§öÁöÑÁ≠âÂæÖÊó∂Èó¥
                            setTimeout(() => {
                                try {
                                    youtubePlayerManager.playVideo();
                                    // State will be updated via event listener
                                    showToast('ÂºÄÂßãÊí≠Êîæ');
                                } catch (retryError) {
                                    console.error('ÈáçËØïÊí≠ÊîæÂ§±Ë¥•:', retryError);
                                    // Show more helpful message about browser autoplay restrictions
                                    showToast('È¶ñÊ¨°Êí≠ÊîæÂèØËÉΩÈúÄË¶ÅÁî®Êà∑‰∫§‰∫íÔºåËØ∑ÁÇπÂáªÊí≠ÊîæÊåâÈíÆÈáçËØï');
                                    updatePlayState(false);
                                }
                            }, 500); // ÂáèÂ∞ëÂª∂ËøüÊó∂Èó¥
                        } else {
                            // Show more helpful message about browser autoplay restrictions
                            showToast('È¶ñÊ¨°Êí≠ÊîæÂèØËÉΩÈúÄË¶ÅÁî®Êà∑‰∫§‰∫íÔºåËØ∑ÁÇπÂáªÊí≠ÊîæÊåâÈíÆÈáçËØï');
                            updatePlayState(false);
                        }
                    }
                }
            }
        }

        // ÊâìÂºÄË∑≥ËΩ¨ÈìæÊé•Ôºå‰ΩøÁî®Ê†áÈ¢òÂíå‰ΩúËÄÖ‰Ωú‰∏∫Êü•ËØ¢ÂèÇÊï∞
        function openJumpLink(trackName, artistName) {
            // ÁªÑÂêàÊ†áÈ¢òÂíå‰ΩúËÄÖÔºåÁî®Á©∫Ê†ºÂàÜÈöî
            const query = `${trackName} ${artistName}`;
            // ÂàõÂª∫ÁõÆÊ†áURLÔºå‰ΩøÁî®Êèê‰æõÁöÑÊ†ºÂºè
            const jumpUrl = `https://wealth.want.biz/pages/youtubeMusic.html?query=${encodeURIComponent(query)}`;

            // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®ÂçäÂ±èÊ®°ÊÄÅÊ°ÜÔºåÂ¶ÇÊûúÂ≠òÂú®ÂàôÁßªÈô§
            const existingModal = document.querySelector('.half-screen-modal');
            if (existingModal) {
                existingModal.remove();
            }

            // ÂàõÂª∫ÂçäÂ±èÊ®°ÊÄÅÊ°Ü
            const modal = document.createElement('div');
            modal.className = 'half-screen-modal';
            modal.innerHTML = `
                <div class="modal-overlay" onclick="closeHalfScreenModal()"></div>
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-drag-bar"></div>
                        <div class="modal-actions">
                            <button class="modal-close-btn" onclick="closeHalfScreenModal()">‚úï</button>
                        </div>
                    </div>
                    <iframe src="${jumpUrl}" class="modal-iframe" allow="autoplay; fullscreen"></iframe>
                </div>
            `;

            // Ê∑ªÂä†Ê®°ÊÄÅÊ°ÜÊ†∑ÂºèÔºàÂ¶ÇÊûúÂ∞öÊú™Ê∑ªÂä†Ôºâ
            if (!document.querySelector('#half-screen-modal-styles')) {
                const styles = document.createElement('style');
                styles.id = 'half-screen-modal-styles';
                styles.textContent = `
                    .half-screen-modal {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        z-index: 10000;
                        display: flex;
                        flex-direction: column;
                    }

                    .modal-overlay {
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.6);
                        z-index: 1;
                        opacity: 0;
                        animation: fadeIn 0.3s ease forwards;
                    }

                    .modal-content {
                        position: absolute;
                        bottom: 0;
                        left: 0;
                        width: 100%;
                        height: 50vh;
                        background: var(--bg);
                        border-top-left-radius: 20px;
                        border-top-right-radius: 20px;
                        z-index: 2;
                        transform: translateY(100%);
                        animation: slideUp 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
                        display: flex;
                        flex-direction: column;
                        overflow: hidden;
                    }

                    .modal-header {
                        padding: 12px 16px 8px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        position: relative;
                        z-index: 3;
                        background: var(--bg);
                        border-bottom: 1px solid var(--glass-border);
                    }

                    .modal-drag-bar {
                        position: absolute;
                        top: 8px;
                        left: 50%;
                        transform: translateX(-50%);
                        width: 40px;
                        height: 4px;
                        background: var(--text-secondary);
                        border-radius: 2px;
                    }

                    .modal-actions {
                        display: flex;
                        gap: 8px;
                        z-index: 4;
                    }

                    .modal-close-btn {
                        width: 36px;
                        height: 36px;
                        border-radius: 50%;
                        background: var(--glass);
                        border: 1px solid var(--glass-border);
                        color: var(--text);
                        font-size: 18px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: all 0.2s ease;
                    }

                    .modal-close-btn:hover {
                        background: var(--glass-border);
                        transform: scale(1.1);
                    }

                    .modal-iframe {
                        flex: 1;
                        border: none;
                        width: 100%;
                        height: calc(100% - 60px); /* Account for header height */
                    }

                    @keyframes slideUp {
                        from {
                            transform: translateY(100%);
                        }
                        to {
                            transform: translateY(0);
                        }
                    }

                    @keyframes fadeIn {
                        from {
                            opacity: 0;
                        }
                        to {
                            opacity: 1;
                        }
                    }

                    /* ÂìçÂ∫îÂºèÈÄÇÈÖç */
                    @media (min-width: 768px) {
                        .modal-content {
                            height: 60vh;
                            max-height: 700px;
                        }
                    }
                `;
                document.head.appendChild(styles);
            }

            document.body.appendChild(modal);
        }

        // ÂÖ≥Èó≠ÂçäÂ±èÊ®°ÊÄÅÊ°Ü
        function closeHalfScreenModal() {
            const modal = document.querySelector('.half-screen-modal');
            if (modal) {
                // Ê∑ªÂä†ÂÖ≥Èó≠Âä®Áîª
                const content = modal.querySelector('.modal-content');
                const overlay = modal.querySelector('.modal-overlay');

                content.style.animation = 'slideUp 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards';
                content.style.animationDirection = 'reverse';

                overlay.style.animation = 'fadeIn 0.3s ease forwards';
                overlay.style.animationDirection = 'reverse';

                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
        }

        // Audio context for maintaining background audio across browsers
        let backgroundAudioContext = null;

        // Initialize audio context for background playback with better approach
        function initializeBackgroundAudio() {
            if (backgroundAudioContext) return;

            if (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') {
                backgroundAudioContext = new (AudioContext || webkitAudioContext)();

                // Create a very low-volume oscillator to keep context active without audible output
                const oscillator = backgroundAudioContext.createOscillator();
                const gainNode = backgroundAudioContext.createGain();

                // Set gain to extremely low value (nearly silent but keeps context active)
                gainNode.gain.value = 0.00001;

                oscillator.connect(gainNode);
                gainNode.connect(backgroundAudioContext.destination);
                oscillator.start(0);

                // Stop after a brief moment to avoid continuous processing
                if (backgroundAudioContext.currentTime) {
                    oscillator.stop(backgroundAudioContext.currentTime + 0.01);
                }

                // Resume if suspended
                if (backgroundAudioContext.state === 'suspended') {
                    backgroundAudioContext.resume();
                }
            }
        }

        // More aggressive audio context initialization on user interaction
        function aggressiveAudioContextInit() {
            if (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') {
                if (!backgroundAudioContext) {
                    backgroundAudioContext = new (AudioContext || webkitAudioContext)();
                }

                // Try to resume if suspended, regardless of whether we've created it before
                if (backgroundAudioContext.state === 'suspended') {
                    backgroundAudioContext.resume().catch(err => {
                        console.warn('Audio context resume failed:', err);
                    });
                }

                // Create and start a very brief audio source to fully activate context
                try {
                    const source = backgroundAudioContext.createBufferSource();
                    const silentBuffer = backgroundAudioContext.createBuffer(1, 1, 22050);
                    source.buffer = silentBuffer;
                    source.connect(backgroundAudioContext.destination);
                    source.start(0);
                    if (backgroundAudioContext.currentTime) {
                        source.stop(backgroundAudioContext.currentTime + 0.001);
                    }
                } catch (e) {
                    console.warn('Could not create silent buffer:', e);
                }
            }
        }

        // Request audio playback permission on mobile devices
        function requestAudioPlayback() {
            return new Promise((resolve, reject) => {
                // Initialize background audio context
                initializeBackgroundAudio();

                // Try to resume in all possible ways
                const resumePromises = [];

                if (backgroundAudioContext && backgroundAudioContext.state === 'suspended') {
                    resumePromises.push(backgroundAudioContext.resume());
                }

                if (resumePromises.length > 0) {
                    Promise.all(resumePromises)
                        .then(() => resolve())
                        .catch(() => {
                            // Even if resume fails, we proceed - the YouTube player might still work
                            // due to being called from user interaction
                            resolve();
                        });
                } else {
                    resolve();
                }
            });
        }

        // Initialize audio context immediately on any user interaction
        function initAudioOnInteraction() {
            // Initialize audio context aggressively on first user interaction
            aggressiveAudioContextInit();

            // Remove the event listener after first interaction to avoid repeated initialization
            ['click', 'touchstart', 'keydown', 'mousedown'].forEach(eventType => {
                document.removeEventListener(eventType, initAudioOnInteraction, { passive: true });
            });
        }

        // Add event listeners for immediate audio context initialization
        ['click', 'touchstart', 'keydown', 'mousedown'].forEach(eventType => {
            document.addEventListener(eventType, initAudioOnInteraction, { passive: true });
        });

        // Handle visibility changes for mobile background audio
        document.addEventListener('visibilitychange', function () {
            if (document.visibilityState === 'visible') {
                // When returning to foreground, ensure audio is properly resumed
                if (youtubePlayerManager.getPlayer() && youtubePlayerManager.isPlaying()) {
                    // Small delay to ensure YouTube player is ready
                    setTimeout(() => {
                        if (youtubePlayerManager.getPlayerState() !== YT.PlayerState.PLAYING) {
                            toggleYouTubePlay();
                        } else {
                            // If already playing, make sure PWA updates are running
                            startPWAProgressUpdates();
                        }
                    }, 100);
                }
            } else {
                // When going to background, ensure PWA updates continue if needed
                if (youtubePlayerManager.getPlayer() && youtubePlayerManager.isPlaying()) {
                    // PWA updates should continue in background, so no need to stop them here
                }
            }
        });

        // Additional mobile-specific handling
        if ('mediaSession' in navigator) {
            navigator.mediaSession.setActionHandler('play', toggleYouTubePlay);
            navigator.mediaSession.setActionHandler('pause', toggleYouTubePlay);

            // Handle seek actions to maintain audio session
            try {
                navigator.mediaSession.setActionHandler('seekbackward', () => {
                    if (youtubePlayerManager.getPlayer()) {
                        const currentTime = youtubePlayerManager.getCurrentTime();
                        youtubePlayerManager.seekTo(Math.max(0, currentTime - 10), true);
                    }
                });

                navigator.mediaSession.setActionHandler('seekforward', () => {
                    if (youtubePlayerManager.getPlayer()) {
                        const currentTime = youtubePlayerManager.getCurrentTime();
                        const duration = youtubePlayerManager.getDuration();
                        youtubePlayerManager.seekTo(Math.min(duration, currentTime + 10), true);
                    }
                });
            } catch (error) {
                console.log('Seek actions not supported:', error);
            }
        }

        // Additional event listeners to handle app lifecycle and backgrounding
        window.addEventListener('pagehide', function () {
            // Try to maintain audio when page is hidden (e.g., switching apps)
            if (youtubePlayerManager.getPlayer() && youtubePlayerManager.isPlaying()) {
                // Store the current time to resume from when returning
                state.lastPosition = youtubePlayerManager.getCurrentTime();
            }
        });

        // Handle page visibility changes more comprehensively
        document.addEventListener('visibilitychange', function () {
            if (document.visibilityState === 'visible') {
                // When returning to foreground, resume audio if needed
                if (youtubePlayerManager.getPlayer() && youtubePlayerManager.isPlaying()) {
                    // Small delay to ensure YouTube player is ready after page becomes visible
                    setTimeout(() => {
                        const playerState = youtubePlayerManager.getPlayerState();
                        if (playerState !== YT.PlayerState.PLAYING) {
                            // Try to resume playback
                            youtubePlayerManager.playVideo();
                            startPWAProgressUpdates(); // Ensure PWA updates start when resuming
                        } else {
                            // If already playing, make sure PWA updates are running
                            startPWAProgressUpdates();
                        }
                    }, 500);
                }
            } else {
                // When going to background, ensure PWA updates continue if playing
                if (youtubePlayerManager.getPlayer() && youtubePlayerManager.isPlaying()) {
                    // Ensure PWA updates are running when going to background
                    startPWAProgressUpdates();
                }
            }
        });

        // Handle focus/blur events which can affect audio on mobile
        window.addEventListener('focus', function () {
            // On iOS Safari especially, audio may need to be resumed when window regains focus
            if (youtubePlayerManager.getPlayer() && youtubePlayerManager.isPlaying() && youtubePlayerManager.getPlayerState() !== YT.PlayerState.PLAYING) {
                setTimeout(() => {
                    youtubePlayerManager.playVideo();
                }, 100);
            }
        });

        window.addEventListener('blur', function () {
            // Store position when leaving the page
            if (youtubePlayerManager.getPlayer() && youtubePlayerManager.isPlaying()) {
                state.lastPosition = youtubePlayerManager.getCurrentTime();
            }
        });

        // Theme switching functions
        function openThemeModal() {
            document.getElementById('theme-overlay').classList.add('visible');
            document.getElementById('theme-modal').classList.add('visible');
        }

        function closeThemeModal() {
            document.getElementById('theme-overlay').classList.remove('visible');
            document.getElementById('theme-modal').classList.remove('visible');
        }

        function changeTheme(themeName) {
            ThemeManager.set(themeName);
            // Close modal after a short delay for better UX
            setTimeout(closeThemeModal, 200);
        }

        // Toast ÊèêÁ§∫
        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 10000;
        animation: fadeIn 0.3s ease;
    `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease forwards';
                setTimeout(() => toast.remove(), 300);
            }, 500);
        }

        // Ê≠åËØç
        async function fetchLyrics(artist, title) {
            // ÁîüÊàêÁºìÂ≠òÈîÆ
            const cacheKey = `lyrics_${encodeURIComponent(artist)}_${encodeURIComponent(title)}`;
            const cachedLyrics = CacheManager.get(cacheKey);

            if (cachedLyrics) {
                console.log('Using cached lyrics for:', artist, title);
                $('lyrics-text').textContent = cachedLyrics;
                return;
            }

            try {
                const cleanTitle = title.split('(')[0].split('-')[0].trim();
                const cleanArtist = artist.split('&')[0].split(',')[0].trim();

                // Â∞ùËØï‰ΩøÁî® YouTube API Ëé∑ÂèñÊ≠åËØçÔºàÂ¶ÇÊûúÂΩìÂâçÊí≠ÊîæÁöÑÊòØ YouTube Ê≠åÊõ≤Ôºâ
                if (state.currentTrack && state.currentTrack.trackId &&
                    (state.currentTrack.kind === 'youtube' || state.currentTrack.previewUrl?.includes('youtube.com'))) {
                    try {
                        const youTubeLyricsRes = await fetch(`https://api.yuangs.cc/youtubeapi/lyrics/${state.currentTrack.trackId}`);
                        if (youTubeLyricsRes.ok) {
                            const youTubeLyricsData = await youTubeLyricsRes.json();

                            if (youTubeLyricsData.success && youTubeLyricsData.data && youTubeLyricsData.data.lyrics) {
                                $('lyrics-text').textContent = youTubeLyricsData.data.lyrics;
                                // ÁºìÂ≠òÊ≠åËØçÔºàÊúâÊïàÊúü24Â∞èÊó∂Ôºâ
                                CacheManager.set(cacheKey, youTubeLyricsData.data.lyrics, 24);
                                return;
                            }
                        } else {
                            console.error('YouTube lyrics API ËØ∑Ê±ÇÂ§±Ë¥•ÔºåÁä∂ÊÄÅÁ†Å:', youTubeLyricsRes.status);
                        }
                    } catch (e) {
                        console.error('YouTube lyrics API failed:', e);
                        // Â¶ÇÊûú YouTube API Â§±Ë¥•ÔºåÁªßÁª≠Â∞ùËØïÂÖ∂‰ªñ API
                    }
                }

                // Â∞ùËØï‰ΩøÁî®ÂéüÁâà API
                const res = await fetch(`https://api.lyrics.ovh/v1/${encodeURIComponent(cleanArtist)}/${encodeURIComponent(cleanTitle)}`);

                if (res.ok) {
                    const data = await res.json();
                    if (data.lyrics) {
                        $('lyrics-text').textContent = data.lyrics;
                        // ÁºìÂ≠òÊ≠åËØçÔºàÊúâÊïàÊúü24Â∞èÊó∂Ôºâ
                        CacheManager.set(cacheKey, data.lyrics, 24);
                        return;
                    }
                }
                showCatFallback();
            } catch {
                showCatFallback();
            }
        }

        async function showCatFallback() {
            try {
                const res = await fetch('https://api.thecatapi.com/v1/images/search');
                const data = await res.json();
                if (data?.[0]?.url) {
                    $('lyrics-text').innerHTML = `
                        <div style="margin-bottom: 20px; color: var(--text-secondary);">ÊöÇÊó†Ê≠åËØçÔºåÈÄÅ‰Ω†‰∏ÄÂè™Áå´ üê±</div>
                        <img src="${data[0].url}" style="max-width: 280px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.4);">
                    `;
                    return;
                }
            } catch { }
            $('lyrics-text').textContent = 'ÊöÇÊó†Ê≠åËØç';
        }

        // ËÆæÁΩÆÁª¥Âü∫ÁôæÁßëÈìæÊé•
        function setupWikipediaLink(artistName) {
            const cleanName = artistName.split(/&|,|feat\.|ft\./i)[0].trim();
            const encodedName = encodeURIComponent(cleanName);

            // Â≠òÂÇ®ÈìæÊé•Âà∞Ëâ∫ÊúØÂÆ∂ÂÖÉÁ¥†ÁöÑÊï∞ÊçÆÂ±ûÊÄß as fallback
            $('lyrics-artist').dataset.wikiUrl = `https://zh.wikipedia.org/wiki/${encodedName}`;

            // È™åËØÅÈìæÊé•ÊòØÂê¶Â≠òÂú®ÔºàÂºÇÊ≠•Ê£ÄÊü•Ôºâ
            verifyWikipediaPageExists(cleanName);
        }

        // È™åËØÅÁª¥Âü∫ÁôæÁßëÈ°µÈù¢ÊòØÂê¶Â≠òÂú®
        async function verifyWikipediaPageExists(artistName) {
            const cleanName = artistName.split(/&|,|feat\.|ft\./i)[0].trim();
            const encodedName = encodeURIComponent(cleanName);

            // È¶ñÂÖàÂ∞ùËØï‰∏≠ÊñáÁª¥Âü∫ÁôæÁßë
            try {
                const res = await fetch(`https://zh.wikipedia.org/api/rest_v1/page/summary/${encodedName}`);

                if (res.ok) {
                    const data = await res.json();
                    if (data.title) {
                        // ‰∏≠ÊñáÁª¥Âü∫ÁôæÁßëÂ≠òÂú®Ôºå‰ΩøÁî®‰∏≠ÊñáÈìæÊé•
                        $('lyrics-artist').dataset.wikiUrl = `https://zh.wikipedia.org/wiki/${encodedName}`;
                        return;
                    }
                }
            } catch { }

            // Â¶ÇÊûú‰∏≠Êñá‰∏çÂ≠òÂú®ÔºåÂ∞ùËØïËã±ÊñáÁª¥Âü∫ÁôæÁßë
            try {
                const res = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodedName}`);

                if (res.ok) {
                    const data = await res.json();
                    if (data.title) {
                        // Ëã±ÊñáÁª¥Âü∫ÁôæÁßëÂ≠òÂú®Ôºå‰ΩøÁî®Ëã±ÊñáÈìæÊé•
                        $('lyrics-artist').dataset.wikiUrl = `https://en.wikipedia.org/wiki/${encodedName}`;
                        return;
                    }
                }
            } catch { }

            // Â¶ÇÊûúÈÉΩ‰∏çÂ≠òÂú®ÔºåËÆæÁΩÆ‰∏∫ÊêúÁ¥¢È°µÈù¢
            $('lyrics-artist').dataset.wikiUrl = `https://zh.wikipedia.org/wiki/Special:Search?search=${encodedName}`;
        }

        // Ê≠åÊâãÁôæÁßë
        async function fetchArtistWiki(artistName) {
            const cleanName = artistName.split(/&|,|feat\.|ft\./i)[0].trim();
            const cacheKey = `wiki_${encodeURIComponent(cleanName)}`;
            const cachedWiki = CacheManager.get(cacheKey);

            if (cachedWiki) {
                console.log('Using cached wiki for:', cleanName);
                $('wiki-title').textContent = `ÂÖ≥‰∫é ${cachedWiki.title}`;
                $('wiki-text').textContent = cachedWiki.extract;
                $('lyrics-wiki').classList.add('show');
                return;
            }

            try {
                let res = await fetch(`https://zh.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(cleanName)}`);
                if (!res.ok) {
                    res = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(cleanName)}`);
                }

                if (res.ok) {
                    const data = await res.json();
                    if (data.extract) {
                        $('wiki-title').textContent = `ÂÖ≥‰∫é ${data.title}`;
                        $('wiki-text').textContent = data.extract;
                        $('lyrics-wiki').classList.add('show');
                        // ÁºìÂ≠òÁª¥Âü∫ÁôæÁßëÊï∞ÊçÆÔºàÊúâÊïàÊúü12Â∞èÊó∂Ôºâ
                        CacheManager.set(cacheKey, {
                            title: data.title,
                            extract: data.extract
                        }, 12);
                    } else {
                        // If no wiki summary found, hide the wiki section
                        $('lyrics-wiki').classList.remove('show');
                    }
                }
            } catch { }
        }

        // Ê≠åËØçÈ°µÈù¢
        function openLyrics() {
            if (!state.currentTrack) return;
            $('lyrics-modal').classList.add('show');
        }

        function closeLyrics() {
            $('lyrics-modal').classList.remove('show');
        }

        // Â§©Ê∞îÊêúÁ¥¢ - ÈöèÊú∫ÂÖ≥ÈîÆËØçÂ¢ûÂº∫Áâà
        async function searchByWeather() {
            try {
                // 1. Ëé∑ÂèñÂú∞ÁêÜ‰ΩçÁΩÆ
                const geoRes = await fetch('https://get.geojs.io/v1/ip/geo.json');
                const geo = await geoRes.json();

                // 2. Ëé∑ÂèñÂ§©Ê∞îÊï∞ÊçÆ
                const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${geo.latitude}&longitude=${geo.longitude}&current_weather=true`);
                const weatherData = await weatherRes.json();
                const code = weatherData.current_weather.weathercode;

                // 3. ÂÆö‰πâÂèòÈáè
                let keywordOptions = []; // ÂÄôÈÄâÂÖ≥ÈîÆËØçÂàóË°®
                let weatherLabel = 'Êú™Áü•'; // Â§©Ê∞î‰∏≠ÊñáÂêç

                // 4. Ê†πÊçÆÂ§©Ê∞î‰ª£Á†ÅÂàÜÈÖçÂÖ≥ÈîÆËØçÂ∫ìÔºåÂπ∂‰∏éÊ†áÁ≠æÁ≥ªÁªüÂÖ≥ËÅî
                if (code <= 3) {
                    // Êô¥Êúó (0-3)
                    weatherLabel = 'Êô¥Êúó';
                    // ‰ªéÊÉÖÁª™Ê†áÁ≠æ‰∏≠ÁöÑÁßØÊûÅÊÉÖÁª™‰∏≠ÈÄâÊã©
                    keywordOptions = [...musicTags.attributes.moods.positive, ...musicTags.scenarios.activity_based.exercise, ...musicTags.scenarios.activity_based.social];
                }
                else if (code >= 45 && code <= 48) {
                    // ÈõæÂ§© (45, 48)
                    weatherLabel = 'ÈõæÂ§©';
                    // ‰ªéÊ∞õÂõ¥Ê†áÁ≠æ‰∏≠ÈÄâÊã©Á•ûÁßò„ÄÅÊ¢¶ÂπªÁöÑÊ†áÁ≠æ
                    keywordOptions = [...musicTags.attributes.moods.intense, ...musicTags.attributes.moods.melancholy, ...musicTags.attributes.styles.aesthetic];
                }
                else if (code >= 51 && code <= 67) {
                    // ‰∏ãÈõ® (51-67)
                    weatherLabel = '‰∏ãÈõ®';
                    // ÈÄâÊã©ÂÆâÈùô„ÄÅËàíÈÄÇÁöÑÈü≥‰πêÁ±ªÂûã
                    keywordOptions = [...musicTags.attributes.moods.melancholy, ...musicTags.scenarios.activity_based.relaxation, ...musicTags.genres.main.traditional];
                }
                else if (code >= 71 && code <= 86) {
                    // ‰∏ãÈõ™ (71-86)
                    weatherLabel = '‰∏ãÈõ™';
                    // ÈÄâÊã©Ê∏©Êöñ„ÄÅËäÇÊó•ÁöÑÈü≥‰πêÁ±ªÂûã
                    keywordOptions = [...musicTags.scenarios.special_occasions, ...musicTags.genres.main.traditional, ...musicTags.nature_abstract.nature.weather];
                }
                else if (code >= 95) {
                    // Èõ∑Êö¥ (95+)
                    weatherLabel = 'Èõ∑Êö¥';
                    // ÈÄâÊã©Âº∫ÁÉà„ÄÅÊúâÂÜ≤ÂáªÂäõÁöÑÈü≥‰πêÁ±ªÂûã
                    keywordOptions = [...musicTags.attributes.moods.intense, ...musicTags.genres.main.rock, ...musicTags.genres.main.electronic];
                }
                else {
                    // Â§ö‰∫ë/Èò¥Â§© (ÂÖ∂‰ªñÊÉÖÂÜµ)
                    weatherLabel = 'Â§ö‰∫ë';
                    // ÈÄâÊã©Ê∏©Âíå„ÄÅÊó•Â∏∏ÁöÑÈü≥‰πêÁ±ªÂûã
                    keywordOptions = [...musicTags.attributes.moods.mellow, ...musicTags.scenarios.time_based.daily_routine, ...musicTags.genres.main.pop];
                }

                // 5. Ê†∏ÂøÉÔºö‰ªéÊï∞ÁªÑ‰∏≠ÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™ÂÖ≥ÈîÆËØç
                const randomKeyword = keywordOptions[Math.floor(Math.random() * keywordOptions.length)];
                if (!randomKeyword) {
                    // Â¶ÇÊûúÊ†áÁ≠æÂ∫ì‰∏≠Ê≤°ÊúâÂØπÂ∫îÁ±ªÂà´Ôºå‰ΩøÁî®ÈªòËÆ§Â§©Ê∞îÁõ∏ÂÖ≥ÁöÑÂÖ≥ÈîÆËØç
                    const defaultKeywords = [
                        'Sunny Day', 'Rainy Day', 'Snow Winter', 'Cloudy Sky',
                        'Foggy Mood', 'Thunder Storm', 'Summer Vibes', 'Winter Mood'
                    ];
                    const randomKeyword = defaultKeywords[Math.floor(Math.random() * defaultKeywords.length)];
                    $('search-input').value = randomKeyword;
                } else {
                    $('search-input').value = randomKeyword;
                }

                // 6. ÊâßË°åÊêúÁ¥¢‰∏éÊèêÁ§∫
                searchMusic();
                alert(`üìç ${geo.city || 'Êú™Áü•'}\nüå§Ô∏è ${weatherLabel}\nüé≤ Êô∫ËÉΩÊé®Ëçê: ${$('search-input').value}`);

            } catch (e) {
                console.error(e);
                alert('Ëé∑ÂèñÂ§©Ê∞îÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªú');
            }
        }

        // ÂºπÂπïÁ≥ªÁªü
        function startDanmaku() {
            $('danmaku').classList.add('show');
            $('danmaku').innerHTML = '';
            // Clear the displayed danmaku set when starting
            state.displayedDanmaku.clear();
            // Clear recent danmaku indices to allow more variety
            if (state.recentDanmakuIndices) {
                state.recentDanmakuIndices = [];
            }
            // Reset tracks
            state.tracks = [false, false, false, false, false];

            if (state.danmakuInterval) clearInterval(state.danmakuInterval);

            // ÂàùÂßãÂåñÂºπÂπïÊï∞ÊçÆ
            DanmakuManager.fetchAndFill().then(() => {
                // Á´ãÂç≥ÁîüÊàêÂá†Êù°ÂºπÂπï‰ª•Â¢ûÂä†Â§öÊ†∑ÊÄß
                for (let i = 0; i < 3; i++) {
                    setTimeout(() => {
                        spawnDanmaku();
                    }, i * 800); // ÈîôÂºÄÊó∂Èó¥ÊòæÁ§∫ÔºåÈÅøÂÖçÂêåÊó∂Âá∫Áé∞
                }

                // ËÆæÁΩÆÂÆöÊó∂Âô®ÊåÅÁª≠ÁîüÊàêÂºπÂπï
                state.danmakuInterval = setInterval(spawnDanmaku, 2000); // ÂáèÂ∞ëÈó¥Èöî‰ª•Â¢ûÂä†È¢ëÁéá
                // ÂºÄÂßãÂÆöÊúüÂà∑Êñ∞ÂºπÂπïÊï∞ÊçÆ
                DanmakuManager.startRefresh();
            });
        }

        async function spawnDanmaku() {
            // ‰ªéÂÖ®Â±ÄÂºπÂπïÂ≠òÂÇ®‰∏≠Ëé∑ÂèñÈöèÊú∫ÂºπÂπï
            const danmaku = DanmakuManager.getRandom();

            if (danmaku) {
                renderDanmaku(danmaku);
            } else {
                // Â¶ÇÊûúÊ≤°ÊúâÂèØÁî®ÂºπÂπïÔºåËé∑ÂèñÊñ∞Êï∞ÊçÆ
                await DanmakuManager.fillNewRecords(5);
                const newDanmaku = DanmakuManager.getRandom();
                if (newDanmaku) {
                    renderDanmaku(newDanmaku);
                }
            }
        }

        function renderDanmaku(data) {
            // Create a unique content identifier to prevent duplicates
            const content = `${data.name}:${data.text}`;
            const fullContent = `${data.name}:${data.text}:${Date.now()}`; // Add timestamp to make it always unique for display

            // Check if this content is already displayed in the current view
            // Only check for recent duplicates (last 20 items) to avoid the issue of no fresh content
            if (state.displayedDanmaku.size > 20) {
                // Clear the set if it gets too large to avoid memory issues and allow refresh
                const recent = Array.from(state.displayedDanmaku).slice(-10); // Keep last 10 items as recent
                state.displayedDanmaku.clear();
                recent.forEach(item => state.displayedDanmaku.add(item));
            }

            if (state.displayedDanmaku.has(content)) {
                // If this exact content is already displayed recently, try to get another one
                setTimeout(async () => {
                    const alternativeDanmaku = DanmakuManager.getRandom();
                    if (alternativeDanmaku) {
                        renderDanmaku(alternativeDanmaku);
                    } else {
                        // If no alternative, try to fill with new records
                        await DanmakuManager.fillNewRecords(3);
                        const newDanmaku = DanmakuManager.getRandom();
                        if (newDanmaku) {
                            renderDanmaku(newDanmaku);
                        }
                    }
                }, 100); // Small delay to avoid blocking
                return;
            }

            let track = state.tracks.findIndex(t => !t);
            if (track === -1) {
                // If all tracks are busy, try to find the one that will finish earliest or just pick randomly
                track = Math.floor(Math.random() * 5);
            }

            state.tracks[track] = true;

            const item = document.createElement('div');
            item.className = 'danmaku-item';
            item.style.top = (track * 40 + 10) + 'px';
            item.style.animationDuration = (12 + Math.random() * 5) + 's';

            item.innerHTML = `
                <img class="danmaku-avatar" src="${data.avatar}" alt="">
                <span class="danmaku-name">${escapeHtml(data.name)}:</span>
                <span class="danmaku-text">${escapeHtml(data.text)}</span>
            `;

            // Add content to the displayed set
            state.displayedDanmaku.add(content);

            item.onanimationend = () => {
                // Remove content from the displayed set when animation ends
                state.displayedDanmaku.delete(content);
                item.remove();
                state.tracks[track] = false;
            };

            // Also handle manual removal if element is removed for other reasons
            const originalRemove = item.remove;
            item.remove = function () {
                state.displayedDanmaku.delete(content);
                state.tracks[track] = false;
                originalRemove.call(this);
            };

            $('danmaku').appendChild(item);
        }

        // ÂºπÂπïÁÆ°ÁêÜÂô®
        const DanmakuManager = {
            STORAGE_KEY: 'danmaku_records',
            MAX_RECORDS: 100,
            EXPIRY_TIME: 12 * 60 * 60 * 1000, // 12 hours in milliseconds
            REFRESH_INTERVAL: null, // ÂÆöÊó∂Âà∑Êñ∞ÂÆöÊó∂Âô®

            // Ëé∑ÂèñÊâÄÊúâÂºπÂπïËÆ∞ÂΩï
            getAll: () => {
                try {
                    const data = localStorage.getItem(DanmakuManager.STORAGE_KEY);
                    if (!data) return [];

                    const records = JSON.parse(data);
                    const now = Date.now();

                    // ËøáÊª§ÊéâËøáÊúüÁöÑËÆ∞ÂΩï
                    const validRecords = records.filter(record => now - record.timestamp < DanmakuManager.EXPIRY_TIME);

                    // Â¶ÇÊûúÊúâËøáÊúüËÆ∞ÂΩïÔºåÊõ¥Êñ∞Â≠òÂÇ®
                    if (records.length !== validRecords.length) {
                        localStorage.setItem(DanmakuManager.STORAGE_KEY, JSON.stringify(validRecords));
                    }

                    return validRecords;
                } catch (e) {
                    console.error('Failed to get danmaku records:', e);
                    return [];
                }
            },

            // ‰øùÂ≠òÂºπÂπïËÆ∞ÂΩïÔºàÊúÄÂ§ö100Êù°ÔºåË∂ÖÂá∫ÂàôÁßªÈô§ÊúÄÊóßÁöÑÔºâ
            save: (records) => {
                try {
                    // Á°Æ‰øù‰∏çË∂ÖËøáÊúÄÂ§ßÊï∞Èáè
                    if (records.length > DanmakuManager.MAX_RECORDS) {
                        records = records.slice(-DanmakuManager.MAX_RECORDS);
                    }

                    localStorage.setItem(DanmakuManager.STORAGE_KEY, JSON.stringify(records));
                } catch (e) {
                    console.error('Failed to save danmaku records:', e);
                }
            },

            // Ê∑ªÂä†Êñ∞ÂºπÂπïËÆ∞ÂΩï
            add: (danmaku) => {
                let records = DanmakuManager.getAll();
                records.push({
                    ...danmaku,
                    timestamp: Date.now()
                });

                // ‰øùÂ≠òÊó∂Ëá™Âä®Ê∏ÖÁêÜËøáÊúüËÆ∞ÂΩïÂπ∂ÈôêÂà∂Êï∞Èáè
                DanmakuManager.save(records);
            },

            // ÈöèÊú∫Ëé∑Âèñ‰∏ÄÊù°ÂºπÂπïËÆ∞ÂΩïÔºåÈÅøÂÖçÁü≠Êó∂Èó¥ÂÜÖÈáçÂ§ç
            getRandom: () => {
                const records = DanmakuManager.getAll();
                if (records.length === 0) return null;

                // Â¶ÇÊûúËÆ∞ÂΩïÊï∞ÈáèÂ§ß‰∫é5ÔºåÂ∞ùËØïÈÅøÂÖçËøîÂõûÊúÄËøëËøîÂõûËøáÁöÑÂºπÂπï
                if (records.length > 5) {
                    // ‰øùÂ≠òÊúÄËøëËøîÂõûÁöÑÂºπÂπïÁ¥¢ÂºïÔºåÈÅøÂÖçÈáçÂ§ç
                    if (!state.recentDanmakuIndices) {
                        state.recentDanmakuIndices = [];
                    }

                    // Ê∏ÖÈô§ËøáÊúüÁöÑÁ¥¢ÂºïËÆ∞ÂΩïÔºàË∂ÖËøá10‰∏™Â∞±‰øùÁïôÊúÄÊñ∞ÁöÑ5‰∏™Ôºâ
                    if (state.recentDanmakuIndices.length > 10) {
                        state.recentDanmakuIndices = state.recentDanmakuIndices.slice(-5);
                    }

                    // Â∞ùËØïÊâæÂà∞‰∏Ä‰∏™‰∏çÂú®ÊúÄËøëÂàóË°®‰∏≠ÁöÑÂºπÂπï
                    let validIndices = [];
                    for (let i = 0; i < records.length; i++) {
                        if (!state.recentDanmakuIndices.includes(i)) {
                            validIndices.push(i);
                        }
                    }

                    // Â¶ÇÊûúÊâÄÊúâÂºπÂπïÈÉΩÂú®ÊúÄËøëÂàóË°®‰∏≠ÔºåÊàñËÄÖÊúâÊïàÈÄâÈ°πÂ§™Â∞ëÔºåÂàô‰ΩøÁî®ÊâÄÊúâËÆ∞ÂΩï
                    if (validIndices.length < 3) {
                        validIndices = Array.from({ length: records.length }, (_, i) => i);
                    }

                    const randomIndex = validIndices[Math.floor(Math.random() * validIndices.length)];
                    state.recentDanmakuIndices.push(randomIndex);

                    return records[randomIndex];
                }

                // Â¶ÇÊûúËÆ∞ÂΩïÊï∞ÈáèÂ∞ë‰∫éÁ≠â‰∫é5ÔºåÁõ¥Êé•ÈöèÊú∫ËøîÂõû
                return records[Math.floor(Math.random() * records.length)];
            },

            // Ëé∑ÂèñÂπ∂Â°´ÂÖÖÊñ∞ÂºπÂπïÊï∞ÊçÆÔºàÂ¶ÇÊûúËÆ∞ÂΩï‰∏∫Á©∫ÊàñËøáÊúüÔºâ
            fetchAndFill: async () => {
                const records = DanmakuManager.getAll();
                const now = Date.now();

                // Â¶ÇÊûúËÆ∞ÂΩïÂ∞ë‰∫é15Êù°ÔºåËØ∑Ê±ÇÊñ∞Êï∞ÊçÆÔºàÂ¢ûÂä†Êï∞Èáè‰ª•Á°Æ‰øùÊúâË∂≥Â§üÁöÑÂºπÂπïÔºâ
                if (records.length < 15) {
                    await DanmakuManager.fillNewRecords(30); // Â¢ûÂä†Â°´ÂÖÖÊï∞Èáè
                } else {
                    // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊõ¥Êñ∞
                    const oldestRecord = records.reduce((oldest, record) => {
                        return record.timestamp < oldest.timestamp ? record : oldest;
                    }, records[0]);

                    if (now - oldestRecord.timestamp > DanmakuManager.EXPIRY_TIME * 0.5) { // Èôç‰ΩéÊõ¥Êñ∞ÈòàÂÄºÂà∞50%ÊúâÊïàÊúü
                        await DanmakuManager.fillNewRecords(15); // Â¢ûÂä†ÊØèÊ¨°Â°´ÂÖÖÁöÑÊï∞Èáè
                    }
                }
            },

            // ÂºÄÂßãÂÆöÊúüÂà∑Êñ∞ÂºπÂπïÊï∞ÊçÆ
            startRefresh: () => {
                // ÂÅúÊ≠¢‰πãÂâçÁöÑÂà∑Êñ∞ÂÆöÊó∂Âô®
                if (DanmakuManager.REFRESH_INTERVAL) {
                    clearInterval(DanmakuManager.REFRESH_INTERVAL);
                }

                // ÊØè10ÂàÜÈíüÊ£ÄÊü•‰∏ÄÊ¨°ÊòØÂê¶ÈúÄË¶ÅÊõ¥Êñ∞ÂºπÂπïÊï∞ÊçÆ
                DanmakuManager.REFRESH_INTERVAL = setInterval(async () => {
                    await DanmakuManager.fetchAndFill();
                }, 10 * 60 * 1000); // 10ÂàÜÈíü
            },

            // ÂÅúÊ≠¢ÂÆöÊúüÂà∑Êñ∞ÂºπÂπïÊï∞ÊçÆ
            stopRefresh: () => {
                if (DanmakuManager.REFRESH_INTERVAL) {
                    clearInterval(DanmakuManager.REFRESH_INTERVAL);
                    DanmakuManager.REFRESH_INTERVAL = null;
                }
            },

            // Â°´ÂÖÖÊñ∞ÁöÑÂºπÂπïËÆ∞ÂΩï
            fillNewRecords: async (count) => {
                try {
                    for (let i = 0; i < count; i++) {
                        // ÈöèÊú∫ÁîüÊàêÂºπÂπïÊï∞ÊçÆÔºàÂ¶ÇÊûúAPIË∞ÉÁî®Â§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§ÂÄºÔºâ
                        const useKanye = Math.random() > 0.5;

                        const [userRes, textRes] = await Promise.all([
                            fetch('https://randomuser.me/api/?inc=name,picture'),
                            useKanye
                                ? fetch('https://api.kanye.rest/')
                                : fetch('https://v1.hitokoto.cn/?c=a&c=b')
                        ]);

                        const user = await userRes.json();
                        const text = await textRes.json();

                        const danmaku = {
                            name: user.results[0].name.first,
                            avatar: user.results[0].picture.thumbnail,
                            text: text.quote || text.hitokoto
                        };

                        DanmakuManager.add(danmaku);
                    }
                } catch (err) {
                    console.error('Failed to fetch new danmaku records:', err);
                    // Â¶ÇÊûúAPIË∞ÉÁî®Â§±Ë¥•ÔºåÁîüÊàê‰∏Ä‰∫õÈªòËÆ§ÂºπÂπï
                    for (let i = 0; i < count; i++) {
                        const danmaku = {
                            name: 'Áî®Êà∑' + (Math.floor(Math.random() * 10000)),
                            avatar: 'data:image/svg+xml;charset=UTF-8,%3Csvg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50"%3E%3Ccircle cx="25" cy="25" r="25" fill="%23ccc"/%3E%3C/svg%3E',
                            text: 'ËøôÊòØ‰∏ÄÊù°ÈöèÊú∫ÂºπÂπï'
                        };
                        DanmakuManager.add(danmaku);
                    }
                }
            }
        };

        // PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('SW registered:', reg.scope))
                .catch(err => console.log('SW failed:', err));
        }

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', e => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallPrompt();
        });

        function showInstallPrompt() {
            if (document.querySelector('.install-prompt')) return;

            const div = document.createElement('div');
            div.className = 'install-prompt';
            div.innerHTML = `
                <div class="install-icon">üì±</div>
                <div class="install-text">
                    <div class="install-title">Ê∑ªÂä†Âà∞‰∏ªÂ±èÂπï</div>
                    <div class="install-desc">Ëé∑ÂæóÊõ¥Â•ΩÁöÑÂÖ®Â±è‰ΩìÈ™å</div>
                </div>
                <button class="install-btn" onclick="installApp()">ÂÆâË£Ö</button>
                <button class="install-close" onclick="this.parentElement.remove()">√ó</button>
            `;
            document.body.appendChild(div);

            setTimeout(() => div.remove(), 10000);
        }

        // ========== Êî∂ËóèÂíåÂéÜÂè≤ÂäüËÉΩ ==========

        // ÂàáÊç¢Êî∂ËóèÁä∂ÊÄÅ
        function toggleFavorite() {
            if (!state.currentTrack) return;

            const trackId = state.currentTrack.trackId;
            const btn = $('favorite-btn');

            if (FavoritesManager.isFavorited(trackId)) {
                FavoritesManager.remove(trackId);
                btn.textContent = 'ü§ç';
                btn.classList.remove('favorited');
                showToast('Â∑≤ÂèñÊ∂àÊî∂Ëóè');
            } else {
                FavoritesManager.add(state.currentTrack);
                btn.textContent = '‚ù§Ô∏è';
                btn.classList.add('favorited');
                showToast('Â∑≤Ê∑ªÂä†Âà∞Êî∂Ëóè');
            }
        }

        // Êõ¥Êñ∞Êî∂ËóèÊåâÈíÆÁä∂ÊÄÅ
        function updateFavoriteButton() {
            if (!state.currentTrack) return;

            const btn = $('favorite-btn');
            const isFavorited = FavoritesManager.isFavorited(state.currentTrack.trackId);

            btn.textContent = isFavorited ? '‚ù§Ô∏è' : 'ü§ç';
            if (isFavorited) {
                btn.classList.add('favorited');
            } else {
                btn.classList.remove('favorited');
            }
        }

        // ÊâìÂºÄÂéÜÂè≤ËÆ∞ÂΩï
        function openHistory() {
            $('history-modal').classList.add('show');
            renderHistory();
        }

        // ÂÖ≥Èó≠ÂéÜÂè≤ËÆ∞ÂΩï
        function closeHistory() {
            $('history-modal').classList.remove('show');
        }

        // Ê∏≤ÊüìÂéÜÂè≤ËÆ∞ÂΩï
        function renderHistory() {
            const history = HistoryManager.getAll();
            const container = $('history-content');

            if (history.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìñ</div>
                        <div class="empty-title">ÊöÇÊó†Êí≠ÊîæÂéÜÂè≤</div>
                        <div class="empty-desc">ÂºÄÂßãÊí≠ÊîæÈü≥‰πêÂêé‰ºöËá™Âä®ËÆ∞ÂΩï</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="collection-grid">
                    ${history.map(song => `
                        <div class="collection-item" onclick="playHistoryItem('${song.trackId}')">
                            <img class="collection-item-cover" src="${(song.artworkUrl100 || song.artworkUrl || '').replace('100x100bb', '300x300bb')}" alt="">
                            <div class="collection-item-title">${escapeHtml(song.trackName)}</div>
                            <div class="collection-item-artist">${escapeHtml(song.artistName)}</div>
                            <div class="collection-item-time">${formatDate(song.playedAt)}</div>
                            <button class="collection-item-remove" onclick="event.stopPropagation(); removeHistory('${song.trackId}')" title="Âà†Èô§">√ó</button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Êí≠ÊîæÂéÜÂè≤‰∏≠ÁöÑÊ≠åÊõ≤
        function playHistoryItem(trackId) {
            const history = HistoryManager.getAll();
            const song = history.find(s => s.trackId == trackId);
            if (song) {
                // Â∞ÜÊ≠åÊõ≤Ê∑ªÂä†Âà∞Êí≠ÊîæÂàóË°®Âπ∂Êí≠Êîæ
                state.playlist = [song];
                state.currentIndex = 0;
                playSong(0);
                closeHistory();
            }
        }

        // Âà†Èô§ÂéÜÂè≤ËÆ∞ÂΩï
        function removeHistory(trackId) {
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ÂéÜÂè≤ËÆ∞ÂΩïÂêóÔºü')) {
                HistoryManager.remove(trackId);
                renderHistory();
                showToast('Â∑≤Âà†Èô§');
            }
        }

        // Ê∏ÖÁ©∫ÂéÜÂè≤
        function clearHistory() {
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÊí≠ÊîæÂéÜÂè≤ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ')) {
                HistoryManager.clear();
                renderHistory();
                showToast('ÂéÜÂè≤ËÆ∞ÂΩïÂ∑≤Ê∏ÖÁ©∫');
            }
        }

        // ÂØºÂá∫ÂéÜÂè≤
        function exportHistory() {
            const history = HistoryManager.getAll();
            if (history.length === 0) {
                alert('ÊöÇÊó†ÂéÜÂè≤ËÆ∞ÂΩïÂèØÂØºÂá∫');
                return;
            }
            HistoryManager.export();
            showToast('ÂéÜÂè≤ËÆ∞ÂΩïÂ∑≤ÂØºÂá∫');
        }

        // ÂØºÂÖ•ÂéÜÂè≤
        function importHistory() {
            const input = $('import-file-input');
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const count = await HistoryManager.import(file);
                        renderHistory();
                        showToast(`ÊàêÂäüÂØºÂÖ• ${count} Êù°ÂéÜÂè≤ËÆ∞ÂΩï`);
                    } catch (err) {
                        alert('ÂØºÂÖ•Â§±Ë¥•Ôºö' + err.message);
                    }
                }
                input.value = '';
            };
            input.click();
        }

        // ÊâìÂºÄÊî∂ËóèÂàóË°®
        function openFavorites() {
            $('favorites-modal').classList.add('show');
            renderFavorites();
        }

        // ÂÖ≥Èó≠Êî∂ËóèÂàóË°®
        function closeFavorites() {
            $('favorites-modal').classList.remove('show');
        }

        // Ê∏≤ÊüìÊî∂ËóèÂàóË°®
        function renderFavorites() {
            const favorites = FavoritesManager.getAll();
            const container = $('favorites-content');

            if (favorites.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚ù§Ô∏è</div>
                        <div class="empty-title">ÊöÇÊó†Êî∂Ëóè</div>
                        <div class="empty-desc">ÁÇπÂáªÊí≠ÊîæÂô®‰∏≠ÁöÑÁà±ÂøÉÊåâÈíÆÊî∂ËóèÊ≠åÊõ≤</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="collection-grid">
                    ${favorites.map(song => `
                        <div class="collection-item" onclick="playFavoriteItem('${song.trackId}')">
                            <img class="collection-item-cover" src="${(song.artworkUrl100 || song.artworkUrl || '').replace('100x100bb', '300x300bb')}" alt="">
                            <div class="collection-item-title">${escapeHtml(song.trackName)}</div>
                            <div class="collection-item-artist">${escapeHtml(song.artistName)}</div>
                            <div class="collection-item-time">${formatDate(song.favoritedAt)}</div>
                            <button class="collection-item-remove" onclick="event.stopPropagation(); removeFavorite('${song.trackId}')" title="ÂèñÊ∂àÊî∂Ëóè">√ó</button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Êí≠ÊîæÊî∂Ëóè‰∏≠ÁöÑÊ≠åÊõ≤
        function playFavoriteItem(trackId) {
            const favorites = FavoritesManager.getAll();
            const song = favorites.find(s => s.trackId == trackId);
            if (song) {
                // Â∞ÜÊ≠åÊõ≤Ê∑ªÂä†Âà∞Êí≠ÊîæÂàóË°®Âπ∂Êí≠Êîæ
                state.playlist = [song];
                state.currentIndex = 0;
                playSong(0);
                closeFavorites();
            }
        }

        // ÂèñÊ∂àÊî∂Ëóè
        function removeFavorite(trackId) {
            if (confirm('Á°ÆÂÆöË¶ÅÂèñÊ∂àÊî∂ËóèËøôÈ¶ñÊ≠åÂêóÔºü')) {
                FavoritesManager.remove(trackId);
                renderFavorites();
                updateFavoriteButton();
                showToast('Â∑≤ÂèñÊ∂àÊî∂Ëóè');
            }
        }

        // Ê∏ÖÁ©∫Êî∂Ëóè
        function clearFavorites() {
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÊî∂ËóèÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ')) {
                FavoritesManager.clear();
                renderFavorites();
                updateFavoriteButton();
                showToast('Êî∂ËóèÂ∑≤Ê∏ÖÁ©∫');
            }
        }

        // ÂØºÂá∫Êî∂Ëóè
        function exportFavorites() {
            const favorites = FavoritesManager.getAll();
            if (favorites.length === 0) {
                alert('ÊöÇÊó†Êî∂ËóèÂèØÂØºÂá∫');
                return;
            }
            FavoritesManager.export();
            showToast('Êî∂ËóèÂ∑≤ÂØºÂá∫');
        }

        // ÂØºÂÖ•Êî∂Ëóè
        function importFavorites() {
            const input = $('import-file-input');
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const count = await FavoritesManager.import(file);
                        renderFavorites();
                        updateFavoriteButton();
                        showToast(`ÊàêÂäüÂØºÂÖ• ${count} È¶ñÊî∂Ëóè`);
                    } catch (err) {
                        alert('ÂØºÂÖ•Â§±Ë¥•Ôºö' + err.message);
                    }
                }
                input.value = '';
            };
            input.click();
        }

        // Ê†ºÂºèÂåñÊó•Êúü
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;

            // Â∞è‰∫é1ÂàÜÈíü
            if (diff < 60000) {
                return 'ÂàöÂàö';
            }
            // Â∞è‰∫é1Â∞èÊó∂
            if (diff < 3600000) {
                return Math.floor(diff / 60000) + 'ÂàÜÈíüÂâç';
            }
            // Â∞è‰∫é1Â§©
            if (diff < 86400000) {
                return Math.floor(diff / 3600000) + 'Â∞èÊó∂Ââç';
            }
            // Â∞è‰∫é7Â§©
            if (diff < 604800000) {
                return Math.floor(diff / 86400000) + 'Â§©Ââç';
            }
            // ÊòæÁ§∫ÂÖ∑‰ΩìÊó•Êúü
            return date.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' });
        }

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(() => {
                    deferredPrompt = null;
                    document.querySelector('.install-prompt')?.remove();
                });
            }
        }

        // ÂàáÊç¢ÊêúÁ¥¢ËæìÂÖ•Ê°ÜÊòæÁ§∫/ÈöêËóè (ÈáçÊûÑÂêé)
        function toggleSearchInput() {
            const searchContainer = document.getElementById('search-input-container');
            const searchInput = document.getElementById('search-input');
            const isVisible = searchContainer.style.display === 'flex';

            if (isVisible) {
                searchContainer.style.display = 'none';
            } else {
                searchContainer.style.display = 'flex';
                // Âª∂ËøüËÅöÁÑ¶‰ª•Ëß£ÂÜ≥PWAÁéØÂ¢É‰∏ãÁöÑÊ∏≤ÊüìÈóÆÈ¢ò
        setTimeout(() => searchInput.focus(), 100); // ÂÖ≥ÈîÆÔºöÂª∂ËøüËÅöÁÑ¶‰ª•Ëß£ÂÜ≥PWAÈóÆÈ¢ò
            }
        }
    </script>
</body>
</html>