<!doctype html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>解锁页面示例</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f0f0f0;
        padding: 16px;
        margin: 0;
      }

      /* 蒙板样式 */
      #unlockOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7); /* 半透明黑色背景 */
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000; /* 确保在最上层 */
      }

      #unlockPrompt {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
      }

      #unlockPrompt input {
        padding: 8px;
        font-size: 16px;
        margin-top: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      #unlockPrompt button {
        padding: 8px 12px;
        font-size: 16px;
        margin-top: 10px;
        border: none;
        color: white;
        background-color: #007bff;
        border-radius: 4px;
        cursor: pointer;
      }

      #unlockPrompt button:hover {
        background-color: #0056b3;
      }

      /* 禁用页面的交互 */
      body.locked * {
        pointer-events: none; /* 禁用所有交互 */
      }

      /* 蒙板上的提示框可操作 */
      body.locked #unlockOverlay * {
        pointer-events: auto;
      }
    </style>
  </head>
  <body class="locked">
    <!-- 添加 locked 类以禁用交互 -->
    <!-- 页面内容 -->
    <div id="content">
      <h1>欢迎来到我的网站</h1>
      <p>请解锁页面以继续操作。</p>
      <!-- 其他页面内容 -->
    </div>

    <!-- 蒙板覆盖层，用于解锁 -->
    <div id="unlockOverlay">
      <div id="unlockPrompt">
        <h3>请输入密码以解锁页面</h3>
        <input type="tel" id="unlockInput" placeholder="输入密码" />
        <button id="unlockButton">解锁</button>
      </div>
    </div>

    <script>
      // 解锁服务类
      class UnlockService {
        constructor(apiEndpoint) {
          this.apiEndpoint = apiEndpoint;
          this.unlockCode = null;
        }

        // 请求服务器生成并发送解锁码
        async requestUnlockCode() {
          try {
            const response = await fetch(`${this.apiEndpoint}/generate-unlock-code`, {
              method: 'POST'
            });
            const result = await response.json();
            if (result.success && typeof result.code === 'number') {
              this.unlockCode = result.code;
              return this.unlockCode;
            } else {
              console.error('生成解锁码失败:', result.message);
            }
          } catch (error) {
            console.error('请求生成解锁码失败:', error);
          }
        }

        // 显示解锁提示框并验证密码
        showUnlockPrompt() {
          return new Promise((resolve) => {
            const unlockButton = document.getElementById('unlockButton');
            unlockButton.addEventListener('click', () => {
              const userInput = document.getElementById('unlockInput').value;
              if (parseInt(userInput) === this.unlockCode) {
                resolve(true);
              } else {
                alert('输入的密码不正确，请重试！');
              }
            });
          });
        }

        // 初始化服务并显示解锁提示框
        async init() {
          await this.requestUnlockCode();
          const unlocked = await this.showUnlockPrompt();
          return unlocked;
        }
      }

      // 页面加载后初始化解锁服务
      document.addEventListener('DOMContentLoaded', async () => {
        const apiEndpoint = 'https://unlock-code-service.yuanguangshan.workers.dev'; // 替换为你的 Cloudflare Worker URL

        const unlockService = new UnlockService(apiEndpoint);

        // 显示加载提示
        console.log('正在请求解锁码，请稍候...');

        const unlocked = await unlockService.init();

        if (unlocked) {
          document.body.classList.remove('locked'); // 移除禁用交互的类
          document.getElementById('unlockOverlay').style.display = 'none'; // 隐藏蒙板
        }
      });

      // 监听回车键事件
      document.getElementById('unlockInput').addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
          document.getElementById('unlockButton').click();
        }
      });
    </script>
  </body>
</html>
