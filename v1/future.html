<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>期货市场概览</title>
  <!-- 引入FontAwesome图标库 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- 引入ECharts可视化库 -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <style>
    /* CSS变量定义 - 优化后的现代设计风格 */
    :root {
      /* 主色调 */
      --primary: #5A8DEE; /* 调整为主色 */
      --primary-light: #90B0F2;
      --secondary: #4776D0; /* 调整为辅色 */
      --accent: #3DC4F3; /* 强调色 */

      /* 中性色 */
      --dark-1: #161d31;
      --dark-2: #2c3e50; /* 深灰，用于主要文本 */
      --dark-3: #566f82; /* 次要文本 */
      --light-1: #ffffff; /* 主要背景 */
      --light-2: #f7f9fc; /* 次要背景/卡片 */
      --light-3: #e8edf1; /* 边框/分割线 */

      /* 功能色 */
      --success: #3dd598; /* 绿色 */
      --info: #3498db;    /* 蓝色 */
      --warning: #ffc107; /* 黄色 */
      --danger: #ff6b6b;  /* 红色 */

      /* 主题色 */
      --bg-color: var(--light-1);
      --bg-secondary: var(--light-2);
      --text-color: var(--dark-2);
      --text-secondary: var(--dark-3);
      --border-color: var(--light-3);

      /* 图表 */
      --chart-height: 380px; /* 稍微降低高度 */
      --chart-title-color: var(--text-color);
      --chart-grid-color: var(--border-color);

      /* 动效 */
      --transition-fast: 0.2s ease-out;
      --transition-normal: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      --transition-fancy: 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);

      /* 阴影 - 更柔和 */
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.07);
      --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.08);

      /* 圆角 */
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 12px;

      /* 字体 */
      --font-family: 'PingFang SC', 'Microsoft YaHei', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    }

    /* 暗色主题 */
    [data-theme="dark"] {
      --primary: #5A8DEE;
      --primary-light: #789ff0;
      --secondary: #6a9cf3;
      --accent: #4cc9f0;

      --dark-1: #ffffff; /* 反转 */
      --dark-2: #e0e0e0;
      --dark-3: #b0b0b0;
      --light-1: #1a1a2e; /* 深色背景 */
      --light-2: #242c40; /* 深色卡片 */
      --light-3: #3a415e; /* 深色边框 */

      --bg-color: var(--light-1);
      --bg-secondary: var(--light-2);
      --text-color: var(--dark-2);
      --text-secondary: var(--dark-3);
      --border-color: var(--light-3);

      --chart-title-color: var(--text-color);
      --chart-grid-color: var(--border-color);

      --shadow-sm: 0 2px 5px rgba(0, 0, 0, 0.2);
      --shadow-md: 0 5px 10px rgba(0, 0, 0, 0.3);
      --shadow-lg: 0 12px 25px rgba(0, 0, 0, 0.3);
    }

    /* 基础样式重置 */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: var(--font-family);
      /* 移除固定宽度，使其响应式 */
      /* width: 380px; */
      max-width: 420px; /* 在大屏幕上保持较窄视图 */
      min-height: 100vh; /* 确保 body 至少和视口一样高 */
      margin: 0 auto; /* 居中显示 */
      color: var(--text-color);
      background-color: var(--bg-color);
      transition: background-color var(--transition-normal), color var(--transition-normal);
      overflow-x: hidden;
      overscroll-behavior-y: contain; /* 防止移动端下拉刷新干扰 */
      display: flex;
      flex-direction: column; /* 让 body 成为 flex 容器 */
    }

    /* 美化滚动条 (仅Webkit) */
    ::-webkit-scrollbar {
      width: 5px;
      height: 5px;
    }
    ::-webkit-scrollbar-track {
      background: var(--bg-secondary);
      border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 10px;
      transition: background var(--transition-fast);
    }
    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }


    .container {
      padding: 0;
      /* height: 100%; */ /* 改为 flex 布局 */
      display: flex;
      flex-direction: column;
      flex-grow: 1; /* 占据 body 剩余空间 */
    }

    /* 顶部导航栏 - 优化 */
    .header {
      /* background: linear-gradient(135deg, var(--primary), var(--secondary)); */
      background-color: var(--primary); /* 使用单色或更柔和的渐变 */
      color: white;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-md);
      position: sticky; /* 固定在顶部 */
      top: 0;
      z-index: 1000; /* 提高层级 */
      flex-shrink: 0; /* 防止被压缩 */
    }

    .header-title {
      font-size: 17px; /* 略微减小 */
      font-weight: 600;
      letter-spacing: 0.5px;
      flex-grow: 1;
      text-align: center;
      margin: 0 10px; /* 给两边图标留空间 */
    }

    .header-icon, .header-button {
      color: rgba(255, 255, 255, 0.95);
      font-size: 16px;
      transition: opacity var(--transition-fast), transform var(--transition-fast);
      background: none;
      border: none;
      padding: 5px;
      cursor: pointer;
      line-height: 1; /* 确保图标垂直居中 */
      border-radius: var(--radius-sm);
    }
    .header-icon:hover, .header-button:hover {
      opacity: 1;
      transform: scale(1.1);
    }
    .header-icon {
        text-decoration: none; /* 去掉a标签下划线 */
    }
     /* 特殊处理 header 内的按钮 */
    .header .btn-outline {
      color: white;
      border-color: rgba(255, 255, 255, 0.7);
      padding: 5px 10px;
      font-size: 12px;
      border-radius: var(--radius-md);
    }
    .header .btn-outline:hover {
      background-color: rgba(255, 255, 255, 0.1);
      border-color: white;
      color: white;
      transform: none; /* 移除默认按钮的hover效果 */
      box-shadow: none;
    }
    .header .btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }


    /* 按钮样式 - 优化 */
    .btn {
      display: inline-block;
      padding: 9px 18px; /* 调整 padding */
      border-radius: var(--radius-md); /* 统一圆角 */
      font-weight: 500; /* 调整字重 */
      cursor: pointer;
      transition: all var(--transition-normal); /* 平滑过渡 */
      border: 1px solid transparent; /* 添加透明边框防止抖动 */
      text-align: center;
      font-size: 14px; /* 统一字体大小 */
      line-height: 1.4;
      text-decoration: none; /* 确保按钮文本无下划线 */
      -webkit-tap-highlight-color: transparent; /* 移除移动端点击高亮 */
    }
    .btn i {
        margin-right: 6px;
    }

    .btn-primary {
      background-color: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    .btn-primary:hover {
      background-color: var(--secondary);
      border-color: var(--secondary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    .btn-primary:active {
        transform: translateY(0);
        box-shadow: none;
    }
    .btn-primary:disabled {
        background-color: var(--border-color);
        border-color: var(--border-color);
        color: var(--text-secondary);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .btn-outline {
      background-color: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
    }
    .btn-outline:hover {
      background-color: var(--primary-light);
      border-color: var(--primary-light);
      color: white;
      transform: translateY(-1px);
    }
    .btn-outline:active {
        background-color: var(--primary);
        color: white;
        transform: translateY(0);
    }
     /* 小型按钮 */
    .btn-sm {
        padding: 4px 10px;
        font-size: 12px;
    }


    /* 卡片样式 - 优化 */
    .card {
      background-color: var(--bg-secondary); /* 使用次要背景色 */
      border-radius: var(--radius-lg); /* 更大的圆角 */
      box-shadow: var(--shadow-sm);
      padding: 16px;
      margin-bottom: 16px; /* 增加间距 */
      transition: transform var(--transition-normal), box-shadow var(--transition-normal);
      border: 1px solid var(--border-color); /* 添加细边框 */
    }
    .card:hover {
      /* box-shadow: var(--shadow-md); */
      /* transform: translateY(-3px); */
      /* 悬停效果可以更 subtle */
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px; /* 增加标题下间距 */
      color: var(--text-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
    }
    .card-title span:first-child {
        flex-grow: 1;
    }

    /* 主要内容区域 */
    .content {
      flex: 1; /* 占据剩余空间 */
      overflow-y: auto; /* 内部滚动 */
      padding: 16px;
      /* 添加淡入效果 */
      opacity: 0;
      animation: fadeIn 0.5s var(--transition-normal) forwards;
    }
    @keyframes fadeIn {
        to { opacity: 1; }
    }
    /* 隐藏时的内容区域 */
    #content[style*="display: none"] {
        animation: none; /* 隐藏时不执行动画 */
        opacity: 0;
    }


    /* 加载指示器 - 优化 */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      position: fixed; /* 使用固定定位 */
      top: 50%; /* 垂直居中 */
      left: 50%; /* 水平居中 */
      transform: translate(-50%, -50%); /* 精确居中 */
      z-index: 1000; /* 确保在内容之上 */
      background-color: var(--bg-color); /* 背景色 */
      padding: 20px; /* 内边距 */
      border-radius: var(--radius-md); /* 圆角 */
      box-shadow: var(--shadow-md); /* 阴影 */
      min-width: 150px; /* 最小宽度 */
    }
    /* 保留 SVG 进度圈样式 */
    .loading svg {
        margin-bottom: 15px;
    }
    .loading div {
        font-size: 14px;
    }


    /* 错误信息样式 - 优化 */
    .error {
      color: var(--danger);
      text-align: center;
      padding: 12px 16px;
      background-color: rgba(255, 107, 107, 0.1);
      border: 1px solid rgba(255, 107, 107, 0.3);
      border-radius: var(--radius-md);
      margin: 16px;
      font-size: 14px;
    }
    /* 缓存警告样式 */
    .cache-warning {
        font-size: 12px;
        padding: 8px 12px;
        margin-bottom: 10px;
        color: var(--warning);
        background-color: rgba(255, 193, 7, 0.1);
        border: 1px solid rgba(255, 193, 7, 0.3);
    }

    /* 市场状态指示器 */
    .status-indicator {
      display: inline-block;
      width: 9px; /* 稍微增大 */
      height: 9px;
      border-radius: 50%;
      margin-right: 6px;
      vertical-align: middle; /* 垂直居中 */
    }

    /* 更新信息区域样式 - 优化 */
    .update-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 14px; /* 调整 padding */
      margin-bottom: 16px; /* 增加间距 */
      background-color: var(--bg-secondary);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
      font-size: 13px; /* 调整字体 */
      color: var(--text-secondary);
      transition: var(--transition-normal);
      border: 1px solid var(--border-color);
    }

    .market-status, .data-time {
      display: flex;
      align-items: center;
      flex-direction: row; /* 确保水平显示 */
    }

    .status-normal {
      background-color: var(--success);
      box-shadow: 0 0 10px var(--success); /* 增强辉光效果 */
      animation: pulse 1.5s infinite cubic-bezier(0.4, 0, 0.6, 1);
    }

    .status-paused {
      background-color: var(--warning);
      box-shadow: 0 0 8px var(--warning);
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(0.9); opacity: 0.6; box-shadow: 0 0 12px var(--success); }
    }

    /* 期货列表样式 - 优化 */
    .futures-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .futures-item {
      display: flex;
      align-items: center;
      padding: 12px 4px; /* 调整 padding */
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: background-color var(--transition-fast), transform var(--transition-fast);
    }
    .futures-item:last-child {
      border-bottom: none;
    }
    .futures-item:hover {
      background-color: var(--bg-color); /* 悬停时使用更浅的背景 */
      transform: translateX(3px);
    }

    /* 涨跌箭头样式 - 优化 */
    .change-arrow {
      width: 0;
      height: 0;
      margin-right: 8px; /* 增加间距 */
      margin-left: 4px;
      flex-shrink: 0;
      transition: border-color var(--transition-fast);
    }
    .change-arrow.up {
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
      border-bottom: 7px solid var(--danger); /* 调整大小 */
    }
    .change-arrow.down {
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
      border-top: 7px solid var(--success); /* 调整大小 */
    }
    .change-arrow.neutral {
      width: 7px; /* 调整大小 */
      height: 2.5px;
      background-color: var(--info);
      border-radius: 1px;
      margin-top: 2.5px; /* 调整位置 */
    }

    /* 期货品种信息 - 优化 */
    .futures-name {
      width: 75px; /* 调整宽度 */
      font-size: 14px; /* 增大字体 */
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--text-color); /* 使用主要文本色 */
      padding-right: 5px;
    }

    .futures-change {
      flex: 1;
      min-width: 0;
      padding: 0 10px; /* 增加 padding */
    }

    .change-bar {
      height: 18px; /* 增加高度 */
      background-color: var(--border-color); /* 更浅的背景 */
      border-radius: var(--radius-sm);
      position: relative;
      overflow: hidden;
    }

    .change-value {
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
      border-radius: var(--radius-sm);
      transition: width var(--transition-normal), background-color var(--transition-normal); /* 平滑过渡 */
      background-image: linear-gradient(to right, rgba(255,255,255,0.1), rgba(255,255,255,0)); /* 添加细微渐变 */
    }

    .change-text {
      position: absolute;
      right: 6px; /* 调整位置 */
      top: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-color); /* 确保文本可见 */
      text-shadow: 0 0 2px var(--bg-secondary); /* 添加细微阴影提高对比度 */
    }

    .futures-posrate {
      width: 70px; /* 增加宽度 */
      text-align: right;
      font-weight: 500;
      font-size: 13px;
      padding-right: 8px; /* 增加 padding */
      transition: color var(--transition-fast);
    }
    .futures-posrate.up {
      color: var(--danger);
    }
    .futures-posrate.down {
      color: var(--success);
    }
    .futures-posrate.neutral {
      color: var(--info);
    }
    .futures-posrate:hover {
        opacity: 0.8; /* 悬停时降低透明度 */
    }

    /* 统计卡片样式 - 优化 */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 16px; /* 增加间距 */
    }

    .stat-card {
      background-color: var(--bg-secondary); /* 使用次要背景色 */
      border-radius: var(--radius-md);
      padding: 14px 10px; /* 调整 padding */
      text-align: center;
      box-shadow: var(--shadow-sm);
      transition: transform var(--transition-normal), box-shadow var(--transition-normal);
      border: 1px solid var(--border-color);
    }
    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-md);
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 8px; /* 增加间距 */
    }

    .stat-value {
      font-size: 18px;
      font-weight: 600;
      line-height: 1.2;
    }
    .stat-value.up { color: var(--danger); }
    .stat-value.down { color: var(--success); }
    .stat-value.neutral { color: var(--info); }

    /* 合约表格样式 - 优化 */
    .contracts-table-container {
        max-height: 350px; /* 调整最大高度 */
        overflow-y: auto;
        border-radius: var(--radius-md);
        border: 1px solid var(--border-color);
        position: relative; /* 为了表头固定 */
    }
    .contracts-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px; /* 调整字体大小 */
    }

    .contracts-table th, .contracts-table td {
      padding: 10px 8px; /* 调整 padding */
      text-align: left;
      border-bottom: 1px solid var(--border-color);
      white-space: nowrap; /* 防止换行 */
    }
     /* 调整列宽 */
    .contracts-table th:nth-child(1), .contracts-table td:nth-child(1) { width: 25%; text-align: left;} /* 合约 */
    .contracts-table th:nth-child(2), .contracts-table td:nth-child(2) { width: 20%; text-align: right;} /* 最新 */
    .contracts-table th:nth-child(3), .contracts-table td:nth-child(3) { width: 20%; text-align: right;} /* 涨幅 */
    .contracts-table th:nth-child(4), .contracts-table td:nth-child(4) { width: 17%; text-align: right;} /* 成交 */
    .contracts-table th:nth-child(5), .contracts-table td:nth-child(5) { width: 18%; text-align: right; padding-right: 12px;} /* 持仓 */


    .contracts-table thead {
        position: sticky;
        top: 0;
        z-index: 10;
    }
    .contracts-table th {
      font-weight: 500; /* 调整字重 */
      color: var(--text-secondary);
      background-color: var(--bg-secondary); /* 表头背景 */
      font-size: 12px;
      text-transform: uppercase; /* 字母大写 */
      letter-spacing: 0.5px;
    }

    .contracts-table tbody tr {
      cursor: pointer;
      transition: background-color var(--transition-fast);
    }
    .contracts-table tbody tr:hover {
      background-color: var(--bg-color); /* 使用更浅的悬停背景 */
    }
     .contracts-table tbody tr:last-child td {
        border-bottom: none;
    }

    .price-up { color: var(--danger); }
    .price-down { color: var(--success); }

    /* 合约详情样式 - 优化 */
    .contract-detail {
      display: none;
      background-color: var(--bg-secondary); /* 使用次要背景 */
      border-radius: var(--radius-lg); /* 增大圆角 */
      padding: 0; /* 移除外部 padding */
      margin-bottom: 16px;
      box-shadow: var(--shadow-md); /* 更明显的阴影 */
      border: 1px solid var(--border-color);
      position: relative;
      overflow: hidden; /* 隐藏内部溢出 */
    }

    .contract-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px; /* 调整 padding */
      border-bottom: 1px solid var(--border-color);
      background-color: var(--bg-color); /* 页眉用更浅背景 */
    }

    .contract-name {
      font-size: 17px; /* 调整字体 */
      font-weight: 600;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px; /* 增大图标 */
      color: var(--text-secondary);
      cursor: pointer;
      padding: 5px;
      line-height: 1;
      border-radius: 50%;
      transition: var(--transition-fast);
    }
    .close-btn:hover {
      background-color: var(--border-color); /* 轻微背景 */
      color: var(--text-color);
      transform: rotate(90deg); /* 添加旋转效果 */
    }

    /* 合约信息网格 - 优化 */
    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px; /* 调整间距 */
      padding: 16px; /* 添加内边距 */
    }

    .info-item {
      background-color: var(--bg-color); /* 更浅的背景 */
      border-radius: var(--radius-md); /* 调整圆角 */
      padding: 12px; /* 调整 padding */
      border: 1px solid var(--border-color);
    }

    .info-label {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 5px; /* 调整间距 */
    }

    .info-value {
      font-size: 15px; /* 调整字体 */
      font-weight: 600;
    }
    .info-value.up { color: var(--danger); }
    .info-value.down { color: var(--success); }

    /* 图表容器样式 */
    .chart-container {
        width: 100%;
        height: var(--chart-height);
        padding: 16px;
        background-color: var(--bg-color); /* 图表区域背景 */
        border-top: 1px solid var(--border-color); /* 分隔线 */
    }
    .chart-container > div { /* ECharts 容器 */
        width: 100%;
        height: 100%;
    }

    /* 品种选择器样式 */
    #variety-select {
        width: 100%;
        padding: 10px 12px; /* 调整 padding */
        border-radius: var(--radius-md);
        border: 1px solid var(--border-color);
        background-color: var(--bg-color);
        color: var(--text-color);
        font-size: 14px;
        appearance: none; /* 移除默认样式 */
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23${(props) => props.theme.textSecondary.substring(1)}' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E"); /* 自定义下拉箭头 */
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 16px 16px;
        cursor: pointer;
        transition: border-color var(--transition-fast);
    }
    #variety-select:hover {
        border-color: var(--primary);
    }
    /* 动态填充SVG颜色 */
    <script>
        function updateSelectArrowColor() {
            const select = document.getElementById('variety-select');
            if (select) {
                const textColor = getCssVariable('--text-secondary', '#888888').substring(1); // 获取颜色并移除#
                select.style.backgroundImage = `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23${textColor}' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E")`;
            }
        }
        // 初始化和主题变化时调用
        document.addEventListener('DOMContentLoaded', updateSelectArrowColor);
        // (在 handleThemeChange 中也需要调用 updateSelectArrowColor)
    </script>

    /* 底部刷新按钮区域 */
    .footer-actions {
        padding: 16px;
        background-color: var(--bg-color);
        border-top: 1px solid var(--border-color);
        flex-shrink: 0; /* 防止被压缩 */
        box-shadow: 0 -2px 5px rgba(0,0,0,0.05); /* 顶部阴影 */
    }
     [data-theme="dark"] .footer-actions {
         box-shadow: 0 -2px 5px rgba(0,0,0,0.2);
     }

    /* 响应式调整 */
    /* 因为移除了固定宽度，这里的调整可能不再必要或需要重新评估 */
    /* @media (max-width: 400px) { */
      /* body { */
        /* width: 100%; */
      /* } */
      /* .futures-name { */
        /* width: 70px; */
      /* } */
      /* .futures-posrate { */
        /* width: 50px; */
      /* } */
    /* } */

  </style>
</head>
<body>
  <div class="container">
    <!-- 顶部导航栏 -->
    <header class="header">
      <a href="https://i.want.biz/long-and-short-position" target="_blank" class="header-icon" aria-label="访问 Want.biz 多空持仓">
        <i class="fas fa-external-link-alt"></i>
      </a>
      <h1 class="header-title">期货市场概览</h1>
      <button id="refresh-btn-header" class="btn btn-outline" aria-label="切换自动刷新状态">
        暂停刷新
      </button>
    </header>

    <!-- 主要内容区域 -->
    <div class="content" id="main-content-area">
      <!-- 市场状态信息 -->
      <div class="update-info">
        <div class="market-status" id="market-status">
          <span class="status-indicator status-normal"></span>
          <span>状态: 交易中</span>
        </div>
        <div class="data-time">
          <span style="margin-right: 4px;">更新:</span>
          <span id="update-time">-</span>
        </div>
      </div>

      <!-- 加载指示器 -->
      <div id="loading" class="loading">
        <!-- SVG 进度圈将由 JS 生成 -->
        <div>加载数据中...</div>
      </div>

      <!-- 错误信息显示区域 -->
      <div id="error" class="error" style="display: none;"></div>
      <!-- 缓存提示信息区域 -->
      <div id="cache-warning-container"></div>


      <!-- 主内容区域 -->
      <div id="content" style="display: none;">
        <!-- 市场概览部分 -->
        <div id="overview-section">
          <div class="card">
            <div class="card-title">
              <span>品种涨跌幅 & 增仓率</span>
              <button id="toggle-futures-btn" class="btn btn-outline btn-sm" aria-label="展开或折叠期货列表">展开全部</button>
            </div>
            <ul id="futures-list" class="futures-list">
              <!-- 期货品种列表将通过JavaScript生成 -->
            </ul>
          </div>

          <!-- 统计卡片 - 组合 -->
          <div class="stats-container">
            <div class="stat-card">
              <div class="stat-label">上涨数量</div>
              <div id="up-count" class="stat-value up">-</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">下跌数量</div>
              <div id="down-count" class="stat-value down">-</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">持平数量</div>
              <div id="neutral-count" class="stat-value neutral">-</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">平均涨幅</div>
              <div id="limit-up-count" class="stat-value up">-</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">平均跌幅</div>
              <div id="limit-down-count" class="stat-value down">-</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">合约总数</div>
              <div id="total-count" class="stat-value">-</div>
            </div>
          </div>
        </div>

        <!-- 品种选择器部分 -->
        <div id="contract-selector" class="card" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color);">
                <button id="back-to-overview" class="btn btn-outline btn-sm" aria-label="返回市场概览">
                    <i class="fas fa-arrow-left"></i>返回概览
                </button>
                <h2 style="font-size: 16px; font-weight: 600; margin: 0;" id="variety-title">选择品种</h2>
                 <button id="refresh-variety-data" class="btn btn-primary btn-sm" aria-label="查看当前品种龙虎榜">
                    <i class="fas fa-crown"></i>龙虎榜
                 </button>
            </div>

            <div style="margin-bottom: 16px;">
                <select id="variety-select" aria-label="选择期货品种">
                <option value="">请选择品种</option>
                </select>
            </div>

            <!-- 升贴水图表容器 -->
            <div class="chart-container" id="premium-chart-wrapper">
                <div id="premium-chart-container"></div>
            </div>

            <!-- 合约表格容器 -->
            <h3 style="font-size: 14px; font-weight: 600; margin: 16px 0 10px 0; color: var(--text-secondary);">合约列表</h3>
            <div class="contracts-table-container">
                <table id="contracts-table" class="contracts-table">
                <thead>
                    <tr>
                    <th>合约</th>
                    <th>最新</th>
                    <th>涨幅</th>
                    <th>成交量</th>
                    <th>持仓量</th>
                    </tr>
                </thead>
                <tbody id="contracts-body">
                    <!-- 合约数据将通过JavaScript填充 -->
                </tbody>
                </table>
            </div>
        </div>

        <!-- 合约详情视图 -->
        <div id="contract-detail" class="contract-detail">
          <div class="contract-header">
            <div class="contract-name" id="contract-name"></div>
            <button id="close-detail" class="close-btn" aria-label="关闭合约详情">×</button>
          </div>

          <!-- 合约信息网格 -->
          <div class="info-grid">
            <div class="info-item">
              <div class="info-label">最新价</div>
              <div id="contract-price" class="info-value">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">涨跌幅</div>
              <div id="contract-change" class="info-value">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">成交量</div>
              <div id="contract-volume" class="info-value">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">持仓量</div>
              <div id="contract-position" class="info-value">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">成交额</div>
              <div id="contract-cje" class="info-value">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">沉淀资金</div>
              <div id="contract-cdzj" class="info-value">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">增仓率</div>
              <div id="contract-zcl" class="info-value">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">五日涨幅</div>
              <div id="contract-zdf5" class="info-value">-</div>
            </div>
          </div>

          <!-- 合约升贴水图表 -->
          <div class="chart-container" id="contract-premium-chart-wrapper">
            <div id="contract-premium-chart"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- 底部刷新按钮 -->
    <div class="footer-actions">
      <button id="refresh-btn" class="btn btn-primary" style="width: 100%;" aria-label="手动刷新数据">
        <i class="fas fa-sync-alt"></i>刷新数据
      </button>
    </div>
  </div>

  <script>
    // --- 全局变量定义 ---
    let premiumChart = null;
    let contractDetailChart = null;
    let echartsLoadRetries = 0;
    const MAX_RETRIES = 3;
    let autoUpdateInterval = null;
    let isAutoUpdateEnabled = true;
    let isFetching = false; // 防止重复请求
    let futuresData = [];
    let contractsData = {}; // 存储每个品种的合约数据 { varietyId: [contracts] }
    let varietyIdMap = {}; // 品种名称/代码到 msgid 的映射
    let currentVariety = null; // 当前选中的品种 msgid
    let showAllFutures = false; // 是否显示所有期货品种
    let isDarkMode = false; // 当前是否为暗色模式

    // 数据备份和回退机制
    let lastSuccessfulFuturesData = null;
    let lastSuccessfulContractsData = {};
    let lastUpdateTime = null;

    // 交易所映射表
    const EXCHANGE_MAP = { 'SHFE': 113, 'DCE': 114, 'CZCE': 115, 'GFEX': 225, 'INE': 142, 'CFFEX': 220 };

    // DOM 元素引用
    const loadingIndicator = document.getElementById('loading');
    const contentElement = document.getElementById('content');
    const errorElement = document.getElementById('error');
    const cacheWarningContainer = document.getElementById('cache-warning-container');
    const refreshBtn = document.getElementById('refresh-btn');
    const refreshBtnHeader = document.getElementById('refresh-btn-header');
    const refreshVarietyBtn = document.getElementById('refresh-variety-data');
    const toggleBtn = document.getElementById('toggle-futures-btn');
    const varietySelect = document.getElementById('variety-select');
    const backToOverviewBtn = document.getElementById('back-to-overview');
    const closeDetailBtn = document.getElementById('close-detail');
    const overviewSection = document.getElementById('overview-section');
    const contractSelectorSection = document.getElementById('contract-selector');
    const contractDetailSection = document.getElementById('contract-detail');
    const updateTimeElement = document.getElementById('update-time');
    const marketStatusElement = document.getElementById('market-status');
    const statusIndicator = marketStatusElement?.querySelector('.status-indicator');
    const futuresListContainer = document.getElementById('futures-list');
    const contractsBody = document.getElementById('contracts-body');
    const premiumChartWrapper = document.getElementById('premium-chart-wrapper');
    const premiumChartContainer = document.getElementById('premium-chart-container');
    const contractPremiumChartWrapper = document.getElementById('contract-premium-chart-wrapper');
    const contractPremiumChartContainer = document.getElementById('contract-premium-chart');
    const varietyTitleElement = document.getElementById('variety-title');

    // --- 初始化 ---
    document.addEventListener('DOMContentLoaded', function() {
      initializeTheme();
      bindEventListeners();
      initializeState();
      checkEChartsLoaded(); // 加载 ECharts 并开始获取数据
      startAutoUpdate();
    });

    // --- 主题处理 ---
    function initializeTheme() {
        const savedTheme = localStorage.getItem('theme-preference');
        const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        isDarkMode = savedTheme ? savedTheme === 'dark' : systemDark;
        applyTheme();

        // 监听系统主题变化 (仅当未手动设置时)
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            if (!localStorage.getItem('theme-preference')) {
            isDarkMode = e.matches;
            applyTheme();
            }
        });

        // 监听 localStorage 变化 (用于跨标签页同步)
        window.addEventListener('storage', (event) => {
            if (event.key === 'theme-preference') {
            const newPreference = event.newValue;
            if (newPreference === 'dark' || newPreference === 'light') {
                isDarkMode = newPreference === 'dark';
                applyTheme();
            }
            }
        });
    }

    function applyTheme() {
        document.documentElement.setAttribute('data-theme', isDarkMode ? 'dark' : '');
        updateSelectArrowColor(); // 更新下拉箭头颜色
        handleThemeChangeForCharts(); // 更新图表
        console.log(`主题已应用: ${isDarkMode ? 'Dark' : 'Light'}`);
    }

    function toggleTheme() {
        isDarkMode = !isDarkMode;
        localStorage.setItem('theme-preference', isDarkMode ? 'dark' : 'light');
        applyTheme();
    }

    function handleThemeChangeForCharts() {
        // 稍微延迟以确保 CSS 变量更新
        setTimeout(() => {
            try {
                if (premiumChart && typeof premiumChart.setOption === 'function') {
                    // 重新渲染或更新选项
                   if (currentVariety && contractsData[currentVariety]) {
                       renderPremiumChart(currentVariety, contractsData[currentVariety]);
                   }
                    console.log('升贴水图表主题已更新');
                }
                 if (contractDetailChart && typeof contractDetailChart.setOption === 'function') {
                    const contractCode = document.getElementById('contract-name').textContent;
                    const contracts = contractsData[currentVariety] || [];
                    const contract = contracts.find(c => c.code === contractCode);
                    if (contract) {
                        renderContractPremiumChart(contract);
                    }
                    console.log('合约详情图表主题已更新');
                }
            } catch (e) {
            console.warn('更新图表主题时出错:', e);
            }
        }, 100); // 100ms 延迟
    }

    // --- 事件绑定 ---
    function bindEventListeners() {
        refreshBtn.addEventListener('click', handleManualRefresh);
        refreshBtnHeader.addEventListener('click', toggleAutoUpdate);
        refreshVarietyBtn.addEventListener('click', navigateToLongShortPage);
        toggleBtn.addEventListener('click', toggleFuturesListDisplay);
        backToOverviewBtn.addEventListener('click', showOverview);
        closeDetailBtn.addEventListener('click', closeContractDetail);
        varietySelect.addEventListener('change', handleVarietyChange);

        // 清理图表实例
        window.addEventListener('beforeunload', () => {
            safeDisposeChart(premiumChart);
            safeDisposeChart(contractDetailChart);
        });

        // 图表响应式调整
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                 safeResizeChart(premiumChart);
                 safeResizeChart(contractDetailChart);
            }, 250);
        });
    }

     // --- 状态初始化 ---
    function initializeState() {
        errorElement.style.display = 'none';
        cacheWarningContainer.innerHTML = '';

        // 读取本地存储的列表展开偏好
        const savedPreference = localStorage.getItem('showAllFutures');
        if (savedPreference !== null) {
            showAllFutures = savedPreference === 'true';
            toggleBtn.textContent = showAllFutures ? '折叠列表' : '展开全部';
            toggleBtn.setAttribute('aria-expanded', showAllFutures);
        }

        // 读取 sessionStorage 的当前品种选择
        try {
            const savedVariety = sessionStorage.getItem('currentVariety');
            if (savedVariety) {
                currentVariety = savedVariety;
            }
        } catch (e) {
            console.warn('无法从 sessionStorage 读取当前品种:', e);
        }

        // 处理 URL 参数，用于直接跳转到品种详情
        const urlParams = new URLSearchParams(window.location.search);
        const varietyParam = urlParams.get('variety'); // 期望是 msgid 格式
        const showPremiumParam = urlParams.get('showPremium');

        if (varietyParam && showPremiumParam === 'true') {
            // 需要延迟执行，等待 futuresData 加载后才能正确设置下拉框
            // 在 fetchData 成功后处理
        } else {
            showOverview(); // 默认显示概览
        }
    }

    // --- ECharts 加载检查 ---
    function checkEChartsLoaded() {
        if (typeof echarts !== 'undefined') {
            console.log('ECharts 已加载');
            fetchData(); // 开始获取数据
        } else if (echartsLoadRetries < MAX_RETRIES) {
            console.warn(`ECharts 未加载，尝试重新加载 (${echartsLoadRetries + 1}/${MAX_RETRIES})`);
            echartsLoadRetries++;
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js';
            script.onload = () => { checkEChartsLoaded(); }; // 成功后再次检查并获取数据
            script.onerror = () => { setTimeout(checkEChartsLoaded, 2000); }; // 失败后稍等重试
            document.head.appendChild(script);
        } else {
            console.error('ECharts 加载失败，已达到最大重试次数');
            showErrorMessage('图表库加载失败，请检查网络连接或刷新页面。');
            loadingIndicator.style.display = 'none';
        }
    }

    // --- 数据获取与处理 ---
    async function fetchWithTimeout(url, options = {}, timeout = 10000) {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeout);
      try {
        const response = await fetch(url, { ...options, signal: controller.signal });
        clearTimeout(id);
        return response;
      } catch (error) {
        clearTimeout(id);
        // 如果是 AbortError，抛出 TimeoutError
        if (error.name === 'AbortError') {
            throw new Error(`Request timed out after ${timeout / 1000} seconds`);
        }
        throw error;
      }
    }

    async function fetchWithRetry(url, options = {}, retries = 2, delay = 1000) {
      let lastError;
      for (let i = 0; i <= retries; i++) {
        try {
          return await fetchWithTimeout(url, options);
        } catch (error) {
          console.warn(`请求失败 (${i + 1}/${retries + 1}): ${url}`, error.message);
          lastError = error;
          if (i < retries) {
            await new Promise(resolve => setTimeout(resolve, delay * (i + 1))); // 递增延迟
          }
        }
      }
      console.error(`请求重试 ${retries} 次后仍然失败: ${url}`);
      throw lastError;
    }

    async function fetchData() {
        if (isFetching) {
            console.log("正在获取数据，请稍候...");
            return;
        }
        isFetching = true;
        showLoadingProgress(); // 显示加载进度
        errorElement.style.display = 'none';
        cacheWarningContainer.innerHTML = ''; // 清除旧警告
        setRefreshButtonState(true); // 禁用刷新按钮

        try {
            if (typeof echarts === 'undefined') throw new Error('ECharts 未加载');

            const apiUrl = isDaySession() ? 'https://q.want.biz/' : 'https://q.want.biz/night';
            console.log(`获取期货概览数据: ${apiUrl}`);
            const response = await fetchWithRetry(apiUrl);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            const data = await response.json();
            if (!data || !data.list || !Array.isArray(data.list)) throw new Error('概览数据格式错误');
            if (data.list.length === 0) console.warn("获取到的概览数据列表为空");


            futuresData = data.list;
            lastSuccessfulFuturesData = [...data.list]; // 深拷贝备份
            lastUpdateTime = new Date();

            buildVarietyIdMap(); // 构建映射表，依赖 futuresData
            const analysisResults = analyzeFuturesData(futuresData);

            // 更新 UI
            updateFuturesList(futuresData);
            updateSummary(analysisResults);
            updateVarietySelect(currentVariety); // 更新下拉列表，并尝试选中 currentVariety

             // 处理 URL 跳转
            const urlParams = new URLSearchParams(window.location.search);
            const varietyParam = urlParams.get('variety');
            const showPremiumParam = urlParams.get('showPremium');
            if (varietyParam && showPremiumParam === 'true' && overviewSection.style.display !== 'none') {
                 // 确保 varietyParam 是 msgid 格式
                let targetVarietyId = varietyIdMap[varietyParam];
                if (!targetVarietyId && varietyParam.includes('_')) {
                    targetVarietyId = varietyParam;
                }
                
                if (targetVarietyId) {
                    currentVariety = targetVarietyId;
                    varietySelect.value = targetVarietyId; // 设置下拉框选中
                    console.log(`URL 参数跳转到品种: ${targetVarietyId}`);
                    showContractSelector(targetVarietyId); // 显示合约选择器并加载数据
                } else {
                    console.warn(`URL 参数中的品种 ${varietyParam} 无法映射到有效的 msgid`);
                    showOverview(); // 跳转失败，显示概览
                }
            } else if (contractSelectorSection.style.display === 'block' && currentVariety) {
                // 如果当前显示的是合约选择器，刷新其数据
                fetchVarietyContracts(currentVariety);
            } else {
                 // 确保显示了内容区域
                 contentElement.style.display = 'block';
            }

             loadingIndicator.style.display = 'none'; // 隐藏加载指示器


        } catch (error) {
            console.error('获取或处理概览数据时出错:', error);
            loadingIndicator.style.display = 'none';

            if (lastSuccessfulFuturesData && lastSuccessfulFuturesData.length > 0) {
                console.warn('数据获取失败，使用缓存数据');
                futuresData = [...lastSuccessfulFuturesData]; // 使用缓存
                const analysisResults = analyzeFuturesData(futuresData);
                analysisResults.lastUpdated += ' (缓存)';

                updateFuturesList(futuresData);
                updateSummary(analysisResults);
                updateVarietySelect(currentVariety); // 即使失败也要更新下拉框

                createCacheWarning(`概览数据更新失败 (${error.message})，当前显示的是缓存数据。`, cacheWarningContainer);
                contentElement.style.display = 'block'; // 确保内容区域可见

                // 如果原本要显示合约选择器，也尝试用缓存加载
                if (contractSelectorSection.style.display === 'block' && currentVariety) {
                    fetchVarietyContracts(currentVariety); // 会尝试使用合约缓存
                }

            } else {
                showErrorMessage(`加载概览数据失败: ${error.message}`);
                contentElement.style.display = 'none'; // 无数据显示时隐藏内容区
            }
        } finally {
            isFetching = false;
            setRefreshButtonState(false); // 启用刷新按钮
        }
    }

    async function fetchVarietyContracts(varietyId) {
        if (!varietyId) {
            console.warn("尝试获取合约但品种 ID 为空");
            renderContractsTable([]); // 清空表格
            renderPremiumChart(null, []); // 清空图表
            return;
        }
         if (isFetching) {
            console.log("正在获取数据，合约加载稍后...");
            // 可以考虑在 fetchData完成后重新调用此函数
            return;
        }
        isFetching = true;
        setRefreshButtonState(true); // 禁用刷新按钮
        console.log(`开始获取品种 ${varietyId} 的合约数据`);

        // 更新加载状态显示
        if (premiumChartContainer) premiumChartContainer.innerHTML = `<div class="loading" style="min-height: 150px; padding: 20px 0;"><div class="spinner"></div><div>加载图表中...</div></div>`;
        if (contractsBody) contractsBody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding: 20px 0;"><div class="loading" style="min-height: 50px; padding: 0;"><div class="spinner" style="width:20px; height:20px; border-width: 3px;"></div><div>加载合约中...</div></div></td></tr>`;

        try {
            // 1. 获取合约代码列表 (从 Redis API)
            let contractCodes = [];
            let marketId = ''; // 用于后续价格请求
            const redisUrl = `https://q.889.ink/redis?msgid=${encodeURIComponent(varietyId)}`;
            console.log(`请求合约列表: ${redisUrl}`);
            try {
                const contractsResponse = await fetchWithRetry(redisUrl);
                if (!contractsResponse.ok) throw new Error(`获取合约列表 HTTP error! status: ${contractsResponse.status}`);
                const responseText = await contractsResponse.text();
                const contractsRawData = JSON.parse(responseText); // 假设返回是 JSON 数组

                if (!Array.isArray(contractsRawData)) throw new Error('合约列表数据格式不正确');
                console.log(`获取到 ${contractsRawData.length} 条原始合约信息`);

                contractCodes = contractsRawData
                    .filter(item => item && item.code && /\d{3,4}$/.test(item.code)) // 过滤有效合约代码 (通常是3或4位数字结尾)
                    .map(item => {
                        if (!marketId && item.mktid) marketId = item.mktid; // 获取市场 ID
                        return `${item.mktid}_${item.code}`; // 组合成 mktid_code 格式
                    });

                if (contractCodes.length === 0) {
                     console.warn(`品种 ${varietyId} 未找到有效的合约代码`);
                     // 即使没有合约，也尝试用缓存
                     if(lastSuccessfulContractsData[varietyId]) {
                         console.log('使用缓存合约数据（因未找到新合约）');
                         createCacheWarning(`未找到 ${varietyId} 的有效合约，使用缓存数据。`, cacheWarningContainer);
                         renderContractsTable(lastSuccessfulContractsData[varietyId]);
                         renderPremiumChart(varietyId, lastSuccessfulContractsData[varietyId]);
                         return; // 直接返回，不再请求价格
                     } else {
                         throw new Error(`未找到有效的合约代码`);
                     }
                }
                console.log(`提取到 ${contractCodes.length} 个合约代码用于价格请求`);

            } catch (contractListError) {
                console.error('获取合约列表失败:', contractListError);
                // 尝试使用缓存
                if (lastSuccessfulContractsData[varietyId]) {
                    console.warn(`获取合约列表失败，使用缓存数据 (${varietyId})`);
                    createCacheWarning(`合约列表更新失败 (${contractListError.message})，使用缓存数据。`, cacheWarningContainer);
                    renderContractsTable(lastSuccessfulContractsData[varietyId]);
                    renderPremiumChart(varietyId, lastSuccessfulContractsData[varietyId]);
                    return; // 使用缓存成功，直接返回
                }
                throw contractListError; // 无缓存，抛出错误
            }

            // 2. 获取合约价格等详细信息 (从 Custom API)
            const customUrl = `https://q.889.ink/custom/${contractCodes.join(',')}?orderBy=code&sort=asc&pageSize=200&pageIndex=0&callbackName=`; // 增加 pageSize
            console.log(`请求价格数据: ${customUrl.substring(0, 100)}...`);
            try {
                const pricesResponse = await fetchWithRetry(customUrl);
                if (!pricesResponse.ok) throw new Error(`获取价格数据 HTTP error! status: ${pricesResponse.status}`);
                const pricesText = await pricesResponse.text();
                const jsonStr = pricesText.replace(/^[^({]*\(|\)[^}]*$/g, ''); // 移除可能的 JSONP 包裹
                const pricesData = JSON.parse(jsonStr);

                if (!pricesData || !pricesData.list || !Array.isArray(pricesData.list)) throw new Error('价格数据格式不正确');

                const prices = pricesData.list;
                if (prices.length === 0) {
                    console.warn(`获取到 ${contractCodes.length} 个合约的价格数据为空`);
                     // 尝试用缓存
                     if(lastSuccessfulContractsData[varietyId]) {
                         console.log('使用缓存合约数据（因价格数据为空）');
                         createCacheWarning(`价格数据为空，使用缓存数据。`, cacheWarningContainer);
                         renderContractsTable(lastSuccessfulContractsData[varietyId]);
                         renderPremiumChart(varietyId, lastSuccessfulContractsData[varietyId]);
                         return;
                     } else {
                         throw new Error('未获取到价格数据');
                     }
                }

                const formattedPrices = prices.map(item => ({
                    code: item.name || '', // 合约代码
                    price: item.p || '0',  // 最新价
                    change: item.zdf || '0', // 涨跌幅
                    volume: item.vol || '0', // 成交量
                    position: item.ccl || '0', // 持仓量 (当前)
                    cje: item.cje || '0',      // 成交额
                    cdzj: item.cdzj || '0',    // 沉淀资金
                    zcl: calculatePositionChangeRate(item), // 增仓率
                    zdf5: item.zdf5 || '0'     // 五日涨幅
                }));

                // 存储数据并备份
                contractsData[varietyId] = formattedPrices;
                lastSuccessfulContractsData[varietyId] = [...formattedPrices]; // 深拷贝备份

                console.log(`成功获取并处理了 ${varietyId} 的 ${formattedPrices.length} 条合约数据`);

                // 更新 UI
                renderContractsTable(formattedPrices);
                renderPremiumChart(varietyId, formattedPrices);

            } catch (pricesError) {
                console.error('获取价格数据失败:', pricesError);
                // 尝试使用缓存
                if (lastSuccessfulContractsData[varietyId]) {
                    console.warn(`获取价格数据失败，使用缓存数据 (${varietyId})`);
                     createCacheWarning(`价格数据更新失败 (${pricesError.message})，使用缓存数据。`, cacheWarningContainer);
                    renderContractsTable(lastSuccessfulContractsData[varietyId]);
                    renderPremiumChart(varietyId, lastSuccessfulContractsData[varietyId]);
                    return; // 使用缓存成功，直接返回
                }
                throw pricesError; // 无缓存，抛出错误
            }

        } catch (error) {
            console.error(`获取品种 ${varietyId} 合约数据整体失败:`, error);
            // 显示错误信息到 UI
            if (premiumChartContainer) premiumChartContainer.innerHTML = `<div class="error" style="margin: 0; height: 100%; display: flex; align-items: center; justify-content: center;">图表数据加载失败:<br>${error.message}</div>`;
            if (contractsBody) contractsBody.innerHTML = `<tr><td colspan="5" class="error" style="text-align:center; margin: 0;">合约列表加载失败:<br>${error.message}</td></tr>`;

            // 清空可能存在的旧数据
            contractsData[varietyId] = [];
            renderContractsTable([]);
            renderPremiumChart(varietyId, []);
        } finally {
             isFetching = false;
             setRefreshButtonState(false); // 启用刷新按钮
        }
    }

    // --- UI 更新函数 ---

    function updateFuturesList(data) {
        if (!futuresListContainer) return;
        futuresListContainer.innerHTML = ''; // 清空列表

        if (!data || data.length === 0) {
            futuresListContainer.innerHTML = '<li style="text-align: center; padding: 20px; color: var(--text-secondary);">无品种数据</li>';
            return;
        }

        try {
            const sortedData = [...data].sort((a, b) => {
                const changeA = parseFloat(a.zdf) || 0;
                const changeB = parseFloat(b.zdf) || 0;
                // 按绝对涨跌幅降序，如果相同，则按增仓率降序
                if (Math.abs(changeB) !== Math.abs(changeA)) {
                    return Math.abs(changeB) - Math.abs(changeA);
                }
                const posRateA = parseFloat(calculatePositionChangeRate(a)) || 0;
                const posRateB = parseFloat(calculatePositionChangeRate(b)) || 0;
                return Math.abs(posRateB) - Math.abs(posRateA);
            });

            const displayData = showAllFutures ? sortedData : sortedData.slice(0, 10); // 默认显示前10

            displayData.forEach(item => {
                const li = document.createElement('li');
                li.className = 'futures-item';
                li.setAttribute('role', 'button');
                li.setAttribute('tabindex', '0'); // Make it focusable

                const change = parseFloat(item.zdf) || 0;
                const posChangeRate = calculatePositionChangeRate(item);
                const posRateNum = parseFloat(posChangeRate) || 0;

                let posRateStatusClass = 'neutral';
                if (posRateNum > 0.01) posRateStatusClass = 'up'; // 增加一点阈值避免0.00显示颜色
                else if (posRateNum < -0.01) posRateStatusClass = 'down';

                const changeColor = change > 0 ? 'var(--danger)' : (change < 0 ? 'var(--success)' : 'var(--info)');
                const scaledWidth = Math.min(Math.abs(change) * 8, 90); // 调整缩放比例

                const varietyId = getVarietyIdFromName(item.name); // 获取 msgid
                const varietyCodeOnly = varietyId ? varietyId.split('_')[1] || '' : extractVarietyCode(item.name).toLowerCase();

                li.innerHTML = `
                    <div class="change-arrow ${posRateStatusClass}"></div>
                    <div class="futures-name" title="${item.name}">${item.name}</div>
                    <div class="futures-change">
                    <div class="change-bar">
                        <div class="change-value" style="width: ${scaledWidth}%; background-color: ${changeColor};"></div>
                        <div class="change-text">${change > 0 ? '+' : ''}${change.toFixed(2)}%</div>
                    </div>
                    </div>
                    <div class="futures-posrate ${posRateStatusClass}"
                        style="cursor: pointer;"
                        title="点击查看 ${item.name} 多空持仓 (${posChangeRate > 0 ? '+' : ''}${posChangeRate}%)">
                    ${posRateNum > 0 ? '+' : ''}${posChangeRate}%
                    </div>
                `;

                // 点击整行跳转到合约选择器
                li.addEventListener('click', () => {
                    if (varietyId) {
                        showContractSelector(varietyId);
                    } else {
                        console.warn(`无法找到品种 ${item.name} 的 ID，无法跳转`);
                        alert(`无法确定品种 ${item.name} 的信息`);
                    }
                });
                 li.addEventListener('keydown', (e) => { // Add keyboard accessibility
                    if (e.key === 'Enter' || e.key === ' ') {
                        li.click();
                    }
                 });

                // 点击增仓率跳转到龙虎榜
                const posrateElement = li.querySelector('.futures-posrate');
                if (posrateElement) {
                    posrateElement.addEventListener('click', (event) => {
                    event.stopPropagation(); // 阻止冒泡到 li 的点击事件
                    if (varietyCodeOnly) {
                        window.open(`longshort.html?variety=${encodeURIComponent(varietyCodeOnly)}`, '_self'); // 新标签页打开
                    } else {
                        alert(`无法确定品种 ${item.name} 的代码，无法查看龙虎榜`);
                    }
                    });
                }

                futuresListContainer.appendChild(li);
            });

            // 如果列表没有显示全部，添加一个提示或按钮
            if (!showAllFutures && sortedData.length > 10) {
                 const showMoreLi = document.createElement('li');
                 showMoreLi.style.textAlign = 'center';
                 showMoreLi.style.padding = '10px 0';
                 showMoreLi.style.borderTop = `1px solid ${getCssVariable('--border-color')}`;
                 showMoreLi.innerHTML = `<button class="btn btn-outline btn-sm">查看全部 (${sortedData.length})</button>`;
                 showMoreLi.querySelector('button').addEventListener('click', toggleFuturesListDisplay);
                 futuresListContainer.appendChild(showMoreLi);
            }

        } catch (error) {
            console.error('更新期货列表出错:', error);
            futuresListContainer.innerHTML = `<li class="error" style="margin: 0;">列表加载失败: ${error.message}</li>`;
        }
    }

    function updateSummary(data) {
        if (!marketStatusElement || !updateTimeElement) return;

        const trading = isTradingHours();
        // 修改这里，使用innerHTML完全替换内容，而不是修改textContent
        marketStatusElement.innerHTML = `
          <span class="status-indicator ${trading ? 'status-normal' : 'status-paused'}"></span>
          <span>状态: ${trading ? '交易中' : '休市中'}</span>
        `;

        updateTimeElement.textContent = data.lastUpdated || new Date().toLocaleString('zh-CN');

        // 更新统计数据
        document.getElementById('up-count').textContent = data.upCount;
        document.getElementById('down-count').textContent = data.downCount;
        document.getElementById('neutral-count').textContent = data.neutralCount;
        document.getElementById('limit-up-count').textContent = data.avgUpChange + '%';
        document.getElementById('limit-down-count').textContent = data.avgDownChange + '%';
        document.getElementById('total-count').textContent = data.totalContracts;

         // 更新自动刷新按钮状态和指示灯
        updateAutoRefreshUI();
    }

    function renderContractsTable(contracts) {
        if (!contractsBody) return;
        contractsBody.innerHTML = ''; // 清空

        if (!contracts || contracts.length === 0) {
            contractsBody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding: 30px 0; color: var(--text-secondary);">无合约数据</td></tr>`;
            return;
        }

        try {
            // 按合约月份排序 (改进版，处理 AU00 等特殊情况)
            contracts.sort((a, b) => {
                const codeA = a.code || '';
                const codeB = b.code || '';
                const matchA = codeA.match(/(\d{2})(\d{2})$/); // 匹配年月 YYMM
                const matchB = codeB.match(/(\d{2})(\d{2})$/);

                if (matchA && matchB) {
                    const yearA = parseInt(matchA[1], 10);
                    const monthA = parseInt(matchA[2], 10);
                    const yearB = parseInt(matchB[1], 10);
                    const monthB = parseInt(matchB[2], 10);

                    // 简单处理跨世纪问题，假设20xx年
                    const fullYearA = yearA < 50 ? 2000 + yearA : 1900 + yearA;
                    const fullYearB = yearB < 50 ? 2000 + yearB : 1900 + yearB;

                    if (fullYearA !== fullYearB) return fullYearA - fullYearB;
                    return monthA - monthB;
                }
                // 如果无法解析年月，按原始代码字符串排序
                return codeA.localeCompare(codeB);
            });

            contracts.forEach(contract => {
                const row = document.createElement('tr');
                row.setAttribute('role', 'button');
                row.setAttribute('tabindex', '0');

                const change = parseFloat(contract.change) || 0;
                const changeClass = change > 0 ? 'price-up' : (change < 0 ? 'price-down' : '');
                const changeSign = change > 0 ? '+' : '';
                const changeText = change ? `${changeSign}${change}%` : '0.00%';

                row.innerHTML = `
                    <td>${contract.code || '-'}</td>
                    <td class="${changeClass}">${contract.price || '-'}</td>
                    <td class="${changeClass}">${changeText}</td>
                    <td>${formatNumber(contract.volume)}</td>
                    <td>${formatNumber(contract.position)}</td>
                `;

                row.addEventListener('click', () => showContractDetail(contract));
                 row.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        row.click();
                    }
                 });

                contractsBody.appendChild(row);
            });
        } catch (error) {
            console.error('渲染合约表格失败:', error);
            contractsBody.innerHTML = `<tr><td colspan="5" class="error" style="text-align:center; margin: 0;">渲染表格失败: ${error.message}</td></tr>`;
        }
    }

    function updateVarietySelect(selectedVarietyId) {
        if (!varietySelect) return;
        const previousValue = varietySelect.value; // 保留下拉框的当前值
        varietySelect.innerHTML = '<option value="">--- 请选择品种 ---</option>'; // 清空并添加默认项

        try {
            const varieties = [];
             // 使用全局 futuresData 构建下拉选项
            if (!futuresData || futuresData.length === 0) {
                 console.warn("无法更新品种下拉框，因为概览数据为空");
                 return;
            }

            futuresData.forEach(item => {
                if (!item.uid || !item.name) return;
                const msgid = getVarietyIdFromName(item.name); // 确保能拿到 msgid
                const name = extractVarietyCode(item.name); // 品种中文名
                const codeMatch = item.uid.match(/\|([A-Za-z]+)/); // 提取品种字母代码
                const code = codeMatch ? codeMatch[1].toUpperCase() : '';

                if (msgid && name && code && !varieties.some(v => v.msgid === msgid)) {
                    varieties.push({ msgid, name, code });
                }
            });

            varieties.sort((a, b) => a.code.localeCompare(b.code)); // 按字母代码排序

            varieties.forEach(v => {
                const option = document.createElement('option');
                option.value = v.msgid;
                option.textContent = `${v.name} (${v.code})`;
                varietySelect.appendChild(option);
            });

             // 尝试恢复之前的选择或选中传入的 ID
             if (selectedVarietyId && varietySelect.querySelector(`option[value="${selectedVarietyId}"]`)) {
                 varietySelect.value = selectedVarietyId;
                 updateVarietyTitle(selectedVarietyId);
             } else if (previousValue && varietySelect.querySelector(`option[value="${previousValue}"]`)) {
                 varietySelect.value = previousValue; // 恢复之前的选择
                 updateVarietyTitle(previousValue);
             } else {
                 updateVarietyTitle(null); // 没有选中项
             }


        } catch (error) {
            console.error('更新品种选择框失败:', error);
            // 可以选择添加一个错误提示的 option
            const errorOption = document.createElement('option');
            errorOption.value = '';
            errorOption.textContent = '加载品种列表失败';
            errorOption.disabled = true;
            varietySelect.appendChild(errorOption);
        }
    }

     function updateVarietyTitle(varietyId) {
        if (varietyTitleElement) {
            if (varietyId && varietySelect) {
                 const selectedOption = varietySelect.querySelector(`option[value="${varietyId}"]`);
                 varietyTitleElement.textContent = selectedOption ? selectedOption.textContent : '合约详情';
            } else {
                 varietyTitleElement.textContent = '选择品种';
            }
        }
     }

    function showContractDetail(contract) {
        if (!contract || !contract.code) {
            console.error('无效的合约数据，无法显示详情');
            alert('无法显示合约详情，数据不完整。');
            return;
        }
        console.log('显示合约详情:', contract.code);

        // 隐藏其他视图
        overviewSection.style.display = 'none';
        contractSelectorSection.style.display = 'none';

        // 填充数据
        document.getElementById('contract-name').textContent = contract.code;
        document.getElementById('contract-price').textContent = contract.price || '-';

        const change = parseFloat(contract.change) || 0;
        const changeValueElement = document.getElementById('contract-change');
        changeValueElement.textContent = change ? `${change >= 0 ? '+' : ''}${change}%` : '-';
        changeValueElement.className = `info-value ${change >= 0 ? 'price-up' : 'price-down'}`;

        document.getElementById('contract-volume').textContent = formatNumber(contract.volume);
        document.getElementById('contract-position').textContent = formatNumber(contract.position);
        document.getElementById('contract-cje').textContent = formatNumber(contract.cje);
        document.getElementById('contract-cdzj').textContent = formatNumber(contract.cdzj);

        const zcl = parseFloat(contract.zcl) || 0;
        const zclElement = document.getElementById('contract-zcl');
        zclElement.textContent = zcl ? `${zcl > 0 ? '+' : ''}${contract.zcl}%` : '-';
        zclElement.className = `info-value ${zcl > 0 ? 'price-up' : (zcl < 0 ? 'price-down' : '')}`;


        const zdf5 = parseFloat(contract.zdf5) || 0;
        const zdf5Element = document.getElementById('contract-zdf5');
        zdf5Element.textContent = zdf5 ? `${zdf5 >= 0 ? '+' : ''}${contract.zdf5}%` : '-';
        zdf5Element.className = `info-value ${zdf5 >= 0 ? 'price-up' : 'price-down'}`;

        // 显示详情视图
        contractDetailSection.style.display = 'block';

        // 渲染图表 (延迟确保容器可见)
        setTimeout(() => {
            renderContractPremiumChart(contract);
        }, 50);
    }

    // --- 图表渲染 ---
    function getChartThemeColors() {
        return {
            backgroundColor: getCssVariable('--bg-color', '#ffffff'),
            textColor: getCssVariable('--text-color', '#333'),
            axisLineColor: getCssVariable('--border-color', '#ccc'),
            splitLineColor: getCssVariable('--border-color', '#eee'),
            tooltipBgColor: getCssVariable('--bg-secondary', '#f7f9fc'),
            tooltipBorderColor: getCssVariable('--border-color', '#e8edf1'),
            positiveColor: getCssVariable('--danger', '#ff6b6b'),
            negativeColor: getCssVariable('--success', '#3dd598'),
            neutralColor: getCssVariable('--info', '#3498db'),
            emphasisColor: getCssVariable('--primary-light', '#90B0F2'), // K线图中性色/选中色
        };
    }

    function renderPremiumChart(varietyId, contracts) {
        safeDisposeChart(premiumChart); // 先销毁旧图表
        premiumChart = null;
        if (!premiumChartContainer) return;

        if (typeof echarts === 'undefined') {
            premiumChartContainer.innerHTML = `<div class="error" style="margin:0;">ECharts 未加载</div>`;
            return;
        }
        if (!contracts || contracts.length === 0) {
            premiumChartContainer.innerHTML = `<div style="display:flex;justify-content:center;align-items:center;height:100%;color:var(--text-secondary);">无合约数据可供绘图</div>`;
            return;
        }

        const validContracts = contracts.filter(c => c.price && !isNaN(parseFloat(c.price)));
        if (validContracts.length === 0) {
             premiumChartContainer.innerHTML = `<div style="display:flex;justify-content:center;align-items:center;height:100%;color:var(--text-secondary);">无有效价格数据</div>`;
            return;
        }

        try {
            const themeColors = getChartThemeColors();
            premiumChart = echarts.init(premiumChartContainer);

            validContracts.sort((a, b) => { // 按合约月份排序
                const monthA = a.code.match(/\d+/) ? a.code.match(/\d+/)[0] : '';
                const monthB = b.code.match(/\d+/) ? b.code.match(/\d+/)[0] : '';
                return monthA.localeCompare(monthB);
            });

            const basePrice = parseFloat(validContracts[0].price); // 以最近月为基准
             if (isNaN(basePrice) || basePrice === 0) {
                 premiumChartContainer.innerHTML = `<div style="display:flex;justify-content:center;align-items:center;height:100%;color:var(--text-secondary);">基准合约价格无效</div>`;
                 return;
             }

            const chartData = validContracts.map((c, index) => {
                const price = parseFloat(c.price) || 0;
                const premiumValue = ((price - basePrice) / basePrice * 100);
                const position = parseInt(c.position) || 0;
                const month = c.code.match(/\d+/) ? c.code.match(/\d+/)[0] : c.code;
                return {
                    code: c.code,
                    month: month,
                    price: price,
                    premium: premiumValue.toFixed(2),
                    position: position,
                    color: index === 0 ? themeColors.emphasisColor : (premiumValue >= 0 ? themeColors.positiveColor : themeColors.negativeColor)
                };
            });

            const totalPosition = chartData.reduce((sum, item) => sum + item.position, 0);

            const option = {
                backgroundColor: 'transparent', // 使用容器背景色
                title: {
                    // text: `${extractVarietyCode(validContracts[0].code)} 合约升贴水`, // 标题可以省略或简化
                    text: `升贴水结构 (基准: ${validContracts[0].code})`,
                    left: 'center',
                    top: 5,
                    textStyle: { fontSize: 14, fontWeight: 'normal', color: themeColors.textColor }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross', crossStyle: { color: '#999' } },
                    backgroundColor: themeColors.tooltipBgColor,
                    borderColor: themeColors.tooltipBorderColor,
                    textStyle: { color: themeColors.textColor, fontSize: 12 },
                    formatter: (params) => {
                        const dataIndex = params[0].dataIndex;
                        const currentContract = chartData[dataIndex];
                        let html = `${currentContract.code}<br/>`;
                        params.forEach(param => {
                            if (param.seriesName === '升贴水') {
                            html += `价格: ${currentContract.price}<br/>升贴水: ${param.value}%<br/>`;
                            } else if (param.seriesName === '持仓占比') {
                            html += `持仓量: ${formatNumber(currentContract.position)}<br/>占比: ${param.value}%`;
                            }
                        });
                        return html;
                    }
                },
                grid: { left: '5%', right: '8%', bottom: '8%', top: '25%', containLabel: true },
                legend: {
                    data: ['升贴水', '持仓占比'],
                    top: '8%', // 调整图例位置
                    right: 'center',
                    textStyle: { color: themeColors.textColor, fontSize: 11 }
                },
                xAxis: {
                    type: 'category',
                    data: chartData.map(item => item.month),
                    axisLabel: { interval: 0, fontSize: 11, color: themeColors.textColor },
                    axisLine: { lineStyle: { color: themeColors.axisLineColor } },
                    axisTick: { alignWithLabel: true }
                },
                yAxis: [
                    {
                        type: 'value', name: '升贴水(%)',
                        nameTextStyle: { fontSize: 11, color: themeColors.textColor },
                        axisLabel: { formatter: '{value}%', fontSize: 10, color: themeColors.textColor },
                        splitLine: { lineStyle: { type: 'dashed', color: themeColors.splitLineColor } },
                        axisLine: { show: true, lineStyle: { color: themeColors.axisLineColor } }
                    },
                    {
                        type: 'value', name: '持仓占比(%)', position: 'right', // 放右边
                        nameTextStyle: { fontSize: 11, color: themeColors.neutralColor },
                        axisLabel: { formatter: '{value}%', fontSize: 10, color: themeColors.neutralColor },
                        splitLine: { show: false },
                        axisLine: { show: true, lineStyle: { color: themeColors.neutralColor } } // Y轴线用蓝色
                    }
                ],
                series: [
                    {
                        name: '升贴水', type: 'bar', barWidth: '60%', yAxisIndex: 0,
                        data: chartData.map(item => ({
                            value: item.premium,
                            itemStyle: { color: item.color }
                        })),
                        label: { show: true, position: 'top', formatter: '{c}%', fontSize: 9, color: themeColors.textColor }
                    },
                    {
                        name: '持仓占比', type: 'line', yAxisIndex: 1, symbol: 'circle', symbolSize: 5, smooth: true,
                        itemStyle: { color: themeColors.neutralColor },
                        lineStyle: { width: 2, color: themeColors.neutralColor },
                        data: chartData.map(item => totalPosition > 0 ? ((item.position / totalPosition) * 100).toFixed(2) : 0),
                         label: { show: false } // 线图标签通常太密集，隐藏
                    }
                ]
            };
            premiumChart.setOption(option);

        } catch (error) {
            console.error('渲染升贴水图表失败:', error);
            premiumChartContainer.innerHTML = `<div class="error" style="margin:0;">渲染图表失败: ${error.message}</div>`;
        }
    }

    function renderContractPremiumChart(contract) {
        safeDisposeChart(contractDetailChart);
        contractDetailChart = null;
        if (!contractPremiumChartContainer) return;

         if (typeof echarts === 'undefined') {
            contractPremiumChartContainer.innerHTML = `<div class="error" style="margin:0;">ECharts 未加载</div>`;
            return;
        }

        // 获取当前品种的所有合约数据
        const varietyId = currentVariety; // 使用全局 currentVariety
        let allContracts = contractsData[varietyId] || lastSuccessfulContractsData[varietyId];

         if (!allContracts || allContracts.length === 0) {
            contractPremiumChartContainer.innerHTML = `<div style="display:flex;justify-content:center;align-items:center;height:100%;color:var(--text-secondary);">无法获取同品种合约数据</div>`;
            return;
        }

        const validContracts = allContracts.filter(c => c.price && !isNaN(parseFloat(c.price)));
        if (validContracts.length === 0) {
             contractPremiumChartContainer.innerHTML = `<div style="display:flex;justify-content:center;align-items:center;height:100%;color:var(--text-secondary);">无有效价格数据</div>`;
            return;
        }

        try {
            const themeColors = getChartThemeColors();
            contractDetailChart = echarts.init(contractPremiumChartContainer);

            validContracts.sort((a, b) => { // 按合约月份排序
                const monthA = a.code.match(/\d+/) ? a.code.match(/\d+/)[0] : '';
                const monthB = b.code.match(/\d+/) ? b.code.match(/\d+/)[0] : '';
                return monthA.localeCompare(monthB);
            });

            const basePrice = parseFloat(contract.price); // 以当前合约为基准
             if (isNaN(basePrice) || basePrice === 0) {
                 contractPremiumChartContainer.innerHTML = `<div style="display:flex;justify-content:center;align-items:center;height:100%;color:var(--text-secondary);">当前合约价格无效</div>`;
                 return;
             }

            const chartData = validContracts.map(c => {
                const price = parseFloat(c.price) || 0;
                const premiumValue = ((price - basePrice) / basePrice * 100);
                const position = parseInt(c.position) || 0;
                const month = c.code.match(/\d+/) ? c.code.match(/\d+/)[0] : c.code;
                return {
                    code: c.code,
                    month: month,
                    price: price,
                    premium: premiumValue.toFixed(2),
                    position: position,
                    // 当前合约用强调色，其他按正负
                    color: c.code === contract.code ? themeColors.emphasisColor : (premiumValue >= 0 ? themeColors.positiveColor : themeColors.negativeColor)
                };
            });

            const totalPosition = chartData.reduce((sum, item) => sum + item.position, 0);

            const option = {
                backgroundColor: 'transparent',
                title: {
                    // text: `${contract.code} 相对升贴水`,
                    text: `相对升贴水 (基准: ${contract.code})`,
                    left: 'center',
                    top: 5,
                    textStyle: { fontSize: 14, fontWeight: 'normal', color: themeColors.textColor }
                },
                tooltip: { // Tooltip 配置与上面类似
                    trigger: 'axis',
                    axisPointer: { type: 'cross', crossStyle: { color: '#999' } },
                    backgroundColor: themeColors.tooltipBgColor,
                    borderColor: themeColors.tooltipBorderColor,
                    textStyle: { color: themeColors.textColor, fontSize: 12 },
                    formatter: (params) => {
                        const dataIndex = params[0].dataIndex;
                        const currentItem = chartData[dataIndex];
                        let html = `${currentItem.code}<br/>`;
                        params.forEach(param => {
                             if (param.seriesName === '升贴水') {
                            html += `价格: ${currentItem.price}<br/>升贴水: ${param.value}%<br/>`;
                            } else if (param.seriesName === '持仓占比') {
                            html += `持仓量: ${formatNumber(currentItem.position)}<br/>占比: ${param.value}%`;
                            }
                        });
                        return html;
                    }
                },
                grid: { left: '5%', right: '8%', bottom: '8%', top: '25%', containLabel: true },
                legend: { // 图例可以隐藏，因为标题说明了基准
                     show: false
                },
                xAxis: { // X轴配置与上面类似
                    type: 'category',
                    data: chartData.map(item => item.month),
                    axisLabel: { interval: 0, fontSize: 11, color: themeColors.textColor },
                    axisLine: { lineStyle: { color: themeColors.axisLineColor } },
                    axisTick: { alignWithLabel: true }
                },
                yAxis: [ // Y轴配置与上面类似
                    {
                        type: 'value', name: '升贴水(%)',
                        nameTextStyle: { fontSize: 11, color: themeColors.textColor },
                        axisLabel: { formatter: '{value}%', fontSize: 10, color: themeColors.textColor },
                        splitLine: { lineStyle: { type: 'dashed', color: themeColors.splitLineColor } },
                        axisLine: { show: true, lineStyle: { color: themeColors.axisLineColor } }
                    },
                    {
                        type: 'value', name: '持仓占比(%)', position: 'right',
                        nameTextStyle: { fontSize: 11, color: themeColors.neutralColor },
                        axisLabel: { formatter: '{value}%', fontSize: 10, color: themeColors.neutralColor },
                        splitLine: { show: false },
                        axisLine: { show: true, lineStyle: { color: themeColors.neutralColor } }
                    }
                ],
                series: [ // Series 配置与上面类似
                     {
                        name: '升贴水', type: 'bar', barWidth: '60%', yAxisIndex: 0,
                        data: chartData.map(item => ({
                            value: item.premium,
                            itemStyle: { color: item.color }
                        })),
                        label: { show: true, position: 'top', formatter: '{c}%', fontSize: 9, color: themeColors.textColor }
                    },
                    {
                        name: '持仓占比', type: 'line', yAxisIndex: 1, symbol: 'circle', symbolSize: 5, smooth: true,
                        itemStyle: { color: themeColors.neutralColor },
                        lineStyle: { width: 2, color: themeColors.neutralColor },
                        data: chartData.map(item => totalPosition > 0 ? ((item.position / totalPosition) * 100).toFixed(2) : 0),
                         label: { show: false }
                    }
                ]
            };
            contractDetailChart.setOption(option);

        } catch (error) {
            console.error('渲染合约详情图表失败:', error);
            contractPremiumChartContainer.innerHTML = `<div class="error" style="margin:0;">渲染图表失败: ${error.message}</div>`;
        }
    }

    // --- 导航与视图切换 ---
    function showOverview() {
        overviewSection.style.display = 'block';
        contractSelectorSection.style.display = 'none';
        contractDetailSection.style.display = 'none';
        currentVariety = null; // 清除当前选中的品种
        try { // 清除 sessionStorage
            sessionStorage.removeItem('currentVariety');
        } catch(e) { console.warn("无法清除 sessionStorage"); }
        // 可能需要重新渲染概览部分的数据或图表（如果概览部分有图表）
        safeDisposeChart(premiumChart); // 销毁品种图表
        safeDisposeChart(contractDetailChart); // 销毁合约图表
    }

    function showContractSelector(varietyId) {
        console.log('显示合约选择器，品种:', varietyId);
        overviewSection.style.display = 'none';
        contractDetailSection.style.display = 'none';
        contractSelectorSection.style.display = 'block';

        currentVariety = varietyId; // 设置当前品种
        try {
             sessionStorage.setItem('currentVariety', varietyId);
        } catch (e) { console.warn("无法保存当前品种到 sessionStorage"); }

        updateVarietySelect(varietyId); // 更新下拉框并选中传入的 ID
        fetchVarietyContracts(varietyId); // 获取并显示该品种的合约数据和图表
    }

     function closeContractDetail() {
        safeDisposeChart(contractDetailChart); // 销毁合约图表
        contractDetailSection.style.display = 'none';
        // 返回到合约选择器视图
        contractSelectorSection.style.display = 'block';
        // 可能需要重新渲染合约选择器的图表 (如果它被销毁了)
        if (currentVariety && contractsData[currentVariety]) {
            renderPremiumChart(currentVariety, contractsData[currentVariety]);
        }
     }

    // --- 事件处理函数 ---
    function handleManualRefresh() {
        console.log("手动刷新...");
        fetchData(); // 强制获取最新数据
        // 如果当前在合约视图，也强制刷新合约数据
        if (contractSelectorSection.style.display === 'block' && currentVariety) {
             fetchVarietyContracts(currentVariety);
        }
    }

    function toggleAutoUpdate() {
        isAutoUpdateEnabled = !isAutoUpdateEnabled;
        if (isAutoUpdateEnabled) {
            startAutoUpdate();
            console.log("自动刷新已开启");
        } else {
            stopAutoUpdate();
            console.log("自动刷新已暂停");
        }
         updateAutoRefreshUI();
    }

     function updateAutoRefreshUI() {
         if (!statusIndicator || !refreshBtnHeader) return;
         if (isAutoUpdateEnabled) {
            refreshBtnHeader.textContent = '暂停刷新';
            statusIndicator.classList.remove('status-paused');
            statusIndicator.classList.add('status-normal');
         } else {
            refreshBtnHeader.textContent = '自动刷新';
            statusIndicator.classList.add('status-paused');
            statusIndicator.classList.remove('status-normal');
         }
         refreshBtnHeader.setAttribute('aria-pressed', isAutoUpdateEnabled);
     }


    function navigateToLongShortPage() {
        const selectedVarietyId = varietySelect.value;
        if (!selectedVarietyId) {
            alert('请先选择一个品种');
            return;
        }
         // 从 msgid (e.g., 114_c) 中提取品种代码 (e.g., c)
         const varietyCodeOnly = selectedVarietyId.split('_')[1] || '';
         if(varietyCodeOnly) {
             console.log(`跳转到龙虎榜页面，品种代码: ${varietyCodeOnly}`);
             window.open(`longshort.html?variety=${encodeURIComponent(varietyCodeOnly)}`, '_blank');
         } else {
              console.warn(`无法从 ${selectedVarietyId} 提取品种代码`);
              alert('无法确定品种代码，无法跳转到龙虎榜页面');
         }
    }

    function toggleFuturesListDisplay() {
        showAllFutures = !showAllFutures;
        toggleBtn.textContent = showAllFutures ? '折叠列表' : '展开全部';
        toggleBtn.setAttribute('aria-expanded', showAllFutures);
        try {
            localStorage.setItem('showAllFutures', showAllFutures);
        } catch(e) { console.warn("无法保存列表展开偏好"); }
        updateFuturesList(futuresData); // 使用当前数据重新渲染列表
    }

    function handleVarietyChange() {
        const selectedVarietyId = varietySelect.value;
        console.log('品种选择变更:', selectedVarietyId);
        if (selectedVarietyId) {
            currentVariety = selectedVarietyId;
            updateVarietyTitle(selectedVarietyId); // 更新标题
            fetchVarietyContracts(selectedVarietyId); // 获取新选择品种的数据
        } else {
            // 清空合约列表和图表
            currentVariety = null;
            updateVarietyTitle(null);
            renderContractsTable([]);
            renderPremiumChart(null, []);
        }
    }

    // --- 自动更新控制 ---
    function startAutoUpdate() {
        isAutoUpdateEnabled = true;
        updateAutoRefreshUI();
        fetchData().finally(() => { // 首次立即执行，完成后设置定时器
            if (isAutoUpdateEnabled) {
                if (autoUpdateInterval) clearTimeout(autoUpdateInterval);
                autoUpdateInterval = setTimeout(startAutoUpdate, 30000); // 30秒间隔
                console.log("下一次自动刷新将在 30 秒后");
            }
        });
    }

    function stopAutoUpdate() {
        isAutoUpdateEnabled = false;
        if (autoUpdateInterval) {
            clearTimeout(autoUpdateInterval);
            autoUpdateInterval = null;
            console.log("自动刷新定时器已清除");
        }
        updateAutoRefreshUI();
    }


    // --- 辅助函数 ---
    function getCssVariable(varName, defaultValue = '') {
        // 确保在 DOMContentLoaded 之后调用或元素已渲染
        try {
            return getComputedStyle(document.documentElement).getPropertyValue(varName).trim() || defaultValue;
        } catch (e) {
             console.warn(`获取 CSS 变量 ${varName} 失败:`, e);
             return defaultValue;
        }
    }

    function buildVarietyIdMap() {
      varietyIdMap = {};
      if (!futuresData || futuresData.length === 0) return;

      futuresData.forEach(item => {
        if (!item.uid || !item.name) return;
        const [exchange, code] = item.uid.split('|');
        if (!exchange || !code || !EXCHANGE_MAP[exchange]) return;

        const variety = code.replace(/\d+/g, ''); // 品种字母代码
        const varietyName = extractVarietyCode(item.name); // 品种中文名
        const msgid = `${EXCHANGE_MAP[exchange]}_${variety.toLowerCase()}`;

        if (varietyName) varietyIdMap[varietyName] = msgid; // 中文名 -> msgid
        if (variety) varietyIdMap[variety.toLowerCase()] = msgid; // 小写字母代码 -> msgid
        if (item.code) varietyIdMap[item.code.toLowerCase()] = msgid; // 有时 item.code 是小写品种代码
      });
      // console.log('品种ID映射表已构建:', varietyIdMap);
    }

    function getVarietyIdFromName(name) {
        if (!name) return '';
        const varietyName = extractVarietyCode(name); // 中文名
        if (varietyIdMap[varietyName]) {
            return varietyIdMap[varietyName];
        }
        // 如果中文名找不到，尝试用可能的字母代码找
        const possibleCode = name.match(/^[A-Za-z]+/); // 提取开头的字母
        if (possibleCode && varietyIdMap[possibleCode[0].toLowerCase()]) {
            return varietyIdMap[possibleCode[0].toLowerCase()];
        }
         // 最终回退，尝试直接用提取的中文名（不推荐，但作为最后手段）
         // console.warn(`无法从名称 "${name}" 映射到 msgid`);
        return varietyIdMap[varietyName] || null; // 返回 null 表示未找到
    }


    function extractVarietyCode(name) {
      if (!name) return '';
      // 移除数字、括号以及括号内的内容，并去除首尾空格
      return name.replace(/\d+|[()（].*?[）)]/g, '').trim();
    }

    function isDaySession() {
        // 简单判断，上午 8:30 到下午 15:30 认为是日盘
        const now = new Date();
        const hours = now.getHours();
        const minutes = now.getMinutes();
        const currentTimeInMinutes = hours * 60 + minutes;
        const startOfDaySession = 8 * 60 + 30;
        const endOfDaySession = 15 * 60 + 30;
        return currentTimeInMinutes >= startOfDaySession && currentTimeInMinutes <= endOfDaySession;
    }

     function isTradingHours() {
         // 更精确的交易时间判断 (示例，可能需要根据实际情况调整)
        const now = new Date();
        const day = now.getDay(); // 0=周日, 6=周六
        const hours = now.getHours();
        const minutes = now.getMinutes();
        const totalMinutes = hours * 60 + minutes;

        if (day === 0 || day === 6) return false; // 周末休市

        // 日盘交易时间段
        const daySession1Start = 9 * 60;
        const daySession1End = 11 * 60 + 30;
        const daySession2Start = 13 * 60 + 30;
        const daySession2End = 15 * 60;

        // 夜盘交易时间段 (跨零点)
        const nightSessionStart = 21 * 60;
        const nightSessionEnd = 2 * 60 + 30; // 次日凌晨 2:30

        if ((totalMinutes >= daySession1Start && totalMinutes < daySession1End) ||
            (totalMinutes >= daySession2Start && totalMinutes < daySession2End)) {
            return true;
        }
        if (totalMinutes >= nightSessionStart || totalMinutes < nightSessionEnd) {
            // 需要排除凌晨 2:30 到早上 9:00 的休市时间
            if (totalMinutes >= nightSessionEnd && totalMinutes < daySession1Start) {
                 return false;
            }
            return true;
        }
        return false;
    }


    function calculatePositionChangeRate(item) {
      const rz = parseFloat(item.rz) || 0; // 日增仓
      const ccl = parseFloat(item.ccl) || 0; // 当前持仓
      const yesterdayPosition = ccl - rz; // 昨日持仓

      if (yesterdayPosition === 0) {
        // 如果昨日持仓为0，无法计算比率，可以返回 Infinity 或特定值，这里返回 0
        return '0.00';
      }

      const rate = (rz / yesterdayPosition) * 100;
      return rate.toFixed(2);
    }

    function analyzeFuturesData(data) {
        let result = {
            totalContracts: 0, upCount: 0, downCount: 0, neutralCount: 0,
            avgUpChange: '0.00', avgDownChange: '0.00',
            lastUpdated: lastUpdateTime ? lastUpdateTime.toLocaleString('zh-CN', { hour12: false }) : '-'
        };
        if (!data || data.length === 0) return result;

        try {
            let totalUpChange = 0;
            let totalDownChange = 0;

            data.forEach(item => {
            const change = parseFloat(item.zdf) || 0;
            if (change > 0) {
                result.upCount++;
                totalUpChange += change;
            } else if (change < 0) {
                result.downCount++;
                totalDownChange += change;
            } else {
                result.neutralCount++;
            }
            });

            result.totalContracts = data.length;
            if (result.upCount > 0) result.avgUpChange = (totalUpChange / result.upCount).toFixed(2);
            if (result.downCount > 0) result.avgDownChange = (totalDownChange / result.downCount).toFixed(2);

        } catch (error) {
            console.error('分析期货数据出错:', error);
        }
        return result;
    }

    function formatNumber(numStr) {
        const num = parseFloat(numStr);
        if (isNaN(num) || num === 0) return '0';

        if (Math.abs(num) >= 100000000) { // 亿
            return (num / 100000000).toFixed(1) + '亿';
        } else if (Math.abs(num) >= 10000) { // 万
            return (num / 10000).toFixed(1) + '万';
        } else {
            return num.toString(); // 小于1万直接显示
        }
    }

    function showErrorMessage(message) {
      if (errorElement) {
        errorElement.textContent = message;
        errorElement.style.display = 'block';
        // 考虑添加一个关闭按钮或自动隐藏
      }
    }

    function createCacheWarning(message, container) {
      if (!container) container = cacheWarningContainer; // 默认容器
      if (!container) return;

      // 清除旧的警告
      container.innerHTML = '';

      const warningDiv = document.createElement('div');
      warningDiv.className = 'error cache-warning'; // 使用 .error 基础样式 + 特定样式
      warningDiv.textContent = `⚠️ ${message}`; // 添加图标
      warningDiv.setAttribute('role', 'alert');

      container.appendChild(warningDiv);

      // 5秒后自动移除 (可选)
      /*
      setTimeout(() => {
        if (warningDiv.parentNode === container) {
          container.removeChild(warningDiv);
        }
      }, 5000);
      */
    }

    function showLoadingProgress() {
        if (!loadingIndicator) return;
        loadingIndicator.style.display = 'flex'; // 确保可见
        // 使用 SVG 进度圈
        loadingIndicator.innerHTML = `
            <svg width="50" height="50" viewBox="0 0 50 50" style="margin-bottom: 15px;">
              <circle cx="25" cy="25" r="20" fill="none" stroke="${getCssVariable('--border-color', '#eee')}" stroke-width="4" />
              <circle cx="25" cy="25" r="20" fill="none" stroke="${getCssVariable('--primary', '#5A8DEE')}" stroke-width="4"
                stroke-dasharray="125.66" stroke-dashoffset="94.24" /* 25% */
                transform="rotate(-90 25 25)"
                style="animation: loading-circle 1.5s linear infinite;" />
            </svg>
            <div>加载数据中...</div>
            <style>
              @keyframes loading-circle {
                0% { stroke-dashoffset: 120; } /* Start almost full */
                50% { stroke-dashoffset: 30; } /* Almost empty */
                100% { stroke-dashoffset: 120; transform: rotate(-90 25 25) rotate(360deg); } /* Rotate */
              }
            </style>
        `;
    }

    function setRefreshButtonState(loading) {
        const iconClass = loading ? 'fa-spin' : ''; // 加载时旋转图标
        if (refreshBtn) {
             refreshBtn.disabled = loading;
             refreshBtn.innerHTML = loading
                 ? `<i class="fas fa-sync-alt ${iconClass}"></i> 刷新中...`
                 : `<i class="fas fa-sync-alt"></i> 刷新数据`;
        }
        // Header 刷新按钮仅禁用，不改文本
        if (refreshBtnHeader) {
             refreshBtnHeader.disabled = loading;
        }
    }

     function safeDisposeChart(chartInstance) {
        if (chartInstance && typeof chartInstance.dispose === 'function') {
            try {
                // 检查 DOM 元素是否存在且 chart 实例是否绑定到它上面
                 if (chartInstance.getDom() && document.body.contains(chartInstance.getDom())) {
                    chartInstance.dispose();
                    // console.log('图表实例已销毁');
                 } else {
                     // console.warn('图表 DOM 不存在或已分离，跳过销毁');
                 }
            } catch (e) {
                console.warn('销毁图表实例失败:', e);
            }
        }
    }

     function safeResizeChart(chartInstance) {
         if (chartInstance && typeof chartInstance.resize === 'function') {
             try {
                 // 检查 DOM 元素是否存在
                 if (chartInstance.getDom() && document.body.contains(chartInstance.getDom())) {
                    chartInstance.resize();
                    // console.log('图表已重置大小');
                 }
             } catch (e) {
                 console.warn('重置图表大小失败:', e);
             }
         }
     }

     function updateSelectArrowColor() {
        if (varietySelect) {
            const color = getCssVariable('--text-secondary', '#888888').substring(1); // 获取颜色并移除#
            varietySelect.style.backgroundImage = `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23${color}' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E")`;
        }
    }

  </script>
</body>
</html>