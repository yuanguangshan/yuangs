<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ËÅäÂ§©ÂÆ§</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí¨</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --background-light: #f8f9fa;
            --background-dark: #e9ecef;
            --text-color-dark: #343a40;
            --text-color-light: #6c757d;
            --border-color: #dee2e6;
            --chat-bubble-self: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --chat-bubble-other: #e9ecef;
            --chat-bubble-text-self: white;
            --chat-bubble-text-other: #343a40;
        }
        body {
            font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(to right bottom, #667eea, #764ba2);
            color: var(--text-color-dark);
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .chat-container {
            display: flex;
            width: 90%;
            max-width: 1200px;
            height: 90vh;
            max-height: 900px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
        }
        .sidebar {
            width: 280px;
            background: var(--background-dark);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            padding: 20px;
            box-sizing: border-box;
            position: relative;
            z-index: 1;
        }
        .sidebar-header {
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .sidebar-header h2 {
            margin: 0;
            font-size: 1.2em;
            color: var(--primary-color);
        }
        .online-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: #28a745;
            border-radius: 50%;
            box-shadow: 0 0 5px #28a745;
        }
        .user-list-container, .user-stats-container {
            margin-bottom: 20px;
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .user-list-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 0.95em;
            border-bottom: 1px solid var(--background-dark);
            padding-bottom: 8px;
        }
        .user-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .user-names {
            flex: 1;
            min-width: 120px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .user-item {
            padding: 5px 0;
            color: var(--text-color-dark);
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .user-item::before {
            content: '‚Ä¢';
            color: #28a745;
            font-size: 1.2em;
            line-height: 1;
        }
        .user-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
            font-size: 0.85em;
            color: var(--text-color-light);
            text-align: right;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        .info-label { font-weight: 500; }
        .info-value { color: var(--primary-color); font-weight: 600; }
        #user-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #user-list li {
            padding: 8px 0;
            border-bottom: 1px dashed var(--border-color);
            color: var(--text-color-dark);
            font-size: 0.9em;
        }
        #user-list li:last-child { border-bottom: none; }
        .user-stats-item {
            background: var(--background-light);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        .user-stats-item:last-child { margin-bottom: 0; }
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            font-size: 0.85em;
        }
        .stat-label { color: var(--text-color-light); }
        .stat-value { font-weight: 500; color: var(--text-color-dark); }
        .online-status { color: #28a745; font-weight: 600; }
        .offline-status { color: #6c757d; font-weight: 500; }
        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .chat-header {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            background: white;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .sidebar-toggle {
            background: none;
            border: none;
            font-size: 24px;
            margin-right: 15px;
            cursor: pointer;
            color: var(--text-color-dark);
            display: none;
        }
        .chat-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-grow: 1;
        }
        .room-icon {
            width: 40px;
            height: 40px;
            background: var(--primary-color);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
            color: white;
            flex-shrink: 0;
        }
        .chat-details {
            display: flex;
            flex-direction: column;
        }
        .room-name {
            margin: 0;
            font-size: 1.1em;
            color: var(--text-color-dark);
        }
        .user-status {
            margin: 0;
            font-size: 0.85em;
            color: var(--text-color-light);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .connection-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #28a745;
            border-radius: 50%;
        }
        .connection-dot.disconnected {
            background-color: #dc3545;
        }
        #username-display {
            font-weight: 500;
            color: var(--primary-color);
            cursor: pointer;
        }
        #username-display:hover { text-decoration: underline; }
        .online-users-display {
            background: var(--background-dark);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            color: var(--text-color-dark);
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .online-users-display:hover { background: var(--border-color); }
        .users-menu {
            display: none;
            position: absolute;
            top: 60px;
            right: 20px;
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 1000;
            min-width: 150px;
        }
        .users-menu.show { display: block; }
        .users-menu ul {
            list-style: none;
            padding: 10px 0;
            margin: 0;
        }
        .users-menu ul li {
            padding: 8px 15px;
            cursor: pointer;
            color: var(--text-color-dark);
            font-size: 0.9em;
        }
        .users-menu ul li:hover { background-color: var(--background-light); }
        #chat-window {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: var(--background-light);
            display: flex;
            flex-direction: column;
            gap: 15px;
            scroll-behavior: smooth;
        }
        .message {
            display: flex;
            flex-direction: column;
            max-width: 70%;
            word-wrap: break-word;
            position: relative;
        }
        .message.self {
            align-self: flex-end;
            align-items: flex-end;
        }
        .message .info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }
        .message.self .info { flex-direction: row-reverse; }
        .message .username {
            font-weight: 600;
            font-size: 0.9em;
            color: var(--text-color-dark);
        }
        .message .timestamp {
            font-size: 0.75em;
            color: var(--text-color-light);
        }
        .message .text {
            padding: 12px 18px;
            border-radius: 20px;
            line-height: 1.5;
            font-size: 0.95em;
            position: relative;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .message.self .text {
            background: var(--chat-bubble-self);
            color: var(--chat-bubble-text-self);
            border-bottom-right-radius: 4px;
        }
        .message:not(.self) .text {
            background: var(--chat-bubble-other);
            color: var(--chat-bubble-text-other);
            border-bottom-left-radius: 4px;
        }
        .message .text p { margin: 0 0 1em 0; }
        .message .text p:last-child { margin-bottom: 0; }
        .message .text ul, .message .text ol { margin: 1em 0; padding-left: 20px; }
        .message .text li { margin-bottom: 0.25em; }
        .message .text pre { background-color: #2d2d2d; color: #f8f8f2; padding: 1em; border-radius: 8px; overflow-x: auto; font-family: 'Courier New', Courier, monospace; font-size: 0.9em; margin: 1em 0; }
        .message.self .text pre { background-color: rgba(0, 0, 0, 0.2); }
        .message .text code { background-color: rgba(0,0,0,0.05); padding: 0.2em 0.4em; border-radius: 4px; font-family: 'Courier New', Courier, monospace; }
        .message.self .text code { background-color: rgba(255, 255, 255, 0.2); }
        .message .text pre > code { background-color: transparent; padding: 0; }
        .message .text blockquote { border-left: 4px solid #ccc; padding-left: 1em; margin: 1em 0; color: #666; }
        .message.self .text blockquote { border-left-color: rgba(255, 255, 255, 0.5); color: rgba(255, 255, 255, 0.8); }
        .message .text table { border-collapse: collapse; width: 100%; margin: 1em 0; }
        .message .text th, .message .text td { border: 1px solid #ddd; padding: 0.5em; }
        .message.self .text th, .message.self .text td { border-color: rgba(255, 255, 255, 0.3); }
        .message .text th { background-color: #f2f2f2; }
        .message.self .text th { background-color: rgba(0, 0, 0, 0.1); }
        .message .text a { color: #007bff; text-decoration: none; }
        .message .text a:hover { text-decoration: underline; }
        .message.self .text a { color: #a0c8ff; }
        .message-image { padding: 4px; background: white; border-radius: 16px; max-width: 300px; box-shadow: 0 1px 6px rgba(0,0,0,0.08); border: 1px solid #e9ecef; overflow: hidden; cursor: pointer; transition: all 0.3s ease; position: relative; }
        .message-image:hover { transform: scale(1.02); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .message-image img { width: 100%; height: auto; border-radius: 12px; display: block; }
        .message.self .message-image { background: rgba(255,255,255,0.1); border: none; }
        .message-audio { display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: #f1f3f5; border-radius: 16px; border: 1px solid #e9ecef; }
        .message.self .message-audio { background: #7783EA; border: none; }
        .message-audio audio { outline: none; }
        .image-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; animation: fadeIn 0.3s ease; }
        .image-modal.show { display: flex; }
        .image-modal img { max-width: 90%; max-height: 90%; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .image-modal-close { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
        .image-modal-close:hover { background: rgba(255,255,255,0.3); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        #message-form { position: sticky; bottom: env(safe-area-inset-bottom, 0); display: flex; padding: 12px 15px; gap: 8px; align-items: center; border-top: 1px solid #e9ecef; background: white; box-shadow: 0 -2px 15px rgba(0,0,0,0.08); z-index: 100; }
        .icon-btn { background: none; border: none; color: #6c757d; font-size: 24px; cursor: pointer; padding: 0; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; flex-shrink: 0; width: 44px; height: 44px; }
        .icon-btn:hover { background: #f1f3f5; color: #667eea; }
        .input-wrapper { flex: 1; position: relative; }
        #message-input { width: 100%; padding: 12px 18px; border: 2px solid #e9ecef; border-radius: 22px; outline: none; font-size: 0.95em; font-family: inherit; resize: none; min-height: 20px; max-height: 100px; line-height: 1.4; transition: all 0.3s ease; box-sizing: border-box; }
        #message-input:focus { border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        #image-input { display: none; }
        .image-preview { position: absolute; bottom: 100%; left: 0; right: 0; background: white; border: 2px solid #667eea; border-radius: 12px; padding: 12px; margin-bottom: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); display: none; }
        .image-preview.show { display: block; }
        .preview-content { display: flex; align-items: center; gap: 12px; }
        .preview-image { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; border: 1px solid #e9ecef; }
        .preview-info { flex: 1; min-width: 0; }
        .preview-name { font-size: 0.9em; font-weight: 600; color: #333; margin-bottom: 4px; word-break: break-all; }
        .preview-size { font-size: 0.8em; color: #6c757d; }
        .preview-remove { background: #e74c3c; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; transition: all 0.3s ease; }
        .preview-remove:hover { background: #c0392b; }
        .uploading { opacity: 0.6; pointer-events: none; }
        .upload-progress { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(102, 126, 234, 0.9); color: white; padding: 8px 12px; border-radius: 8px; font-size: 0.8em; font-weight: 500; }
        #send-button { padding: 10px 20px; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 22px; cursor: pointer; font-size: 0.9em; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 3px 12px rgba(102, 126, 234, 0.3); min-width: 70px; }
        #send-button:hover { transform: translateY(-1px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        #send-button:active { transform: translateY(0); }
        #send-button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .context-menu { display: none; position: absolute; background-color: #f1f1f1; border: 1px solid #ccc; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.15); z-index: 1000; }
        .context-menu ul { list-style: none; padding: 5px 0; margin: 0; }
        .context-menu ul li { padding: 8px 15px; cursor: pointer; }
        .context-menu ul li:hover { background-color: #ddd; }
        #call-controls-container { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; z-index: 1001; }
        .call-control-panel { background: rgba(0,0,0,0.7); color: white; padding: 10px 20px; border-radius: 20px; display: flex; align-items: center; gap: 15px; }
        .hang-up-btn { background: #e74c3c; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; }
        .user-menu-item-with-call { display: flex; justify-content: space-between; align-items: center; }
        .call-btn { background: #2ecc71; color: white; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; margin-left: 10px; }
        .unmute-notice { background: #f39c12; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-left: 10px; }
        .context-menu .ai-explain-option { display: flex; align-items: center; gap: 8px; }
        .context-menu .ai-explain-option::before { content: 'ü§ñ'; font-size: 14px; }   
        .ai-explanation { position: relative; background-color: #f0f4f8; border: 1px solid #d1d9e6; border-radius: 12px; padding: 12px 16px; margin-top: 8px; font-size: 0.85em; color: #334; line-height: 1.5; animation: fadeInUp 0.4s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.05); max-width: 75%; box-sizing: border-box; align-self: flex-start; }
        .message.self .ai-explanation { align-self: flex-end; }
        .ai-explanation::before { content: 'ü§ñ AI Ëß£Èáä:'; font-weight: 600; color: #556; display: block; margin-bottom: 6px; font-size: 0.9em; }
        .ai-explanation p { margin: 0; }
        .ai-explanation-close { background: none; border: none; color: #889; font-size: 16px; cursor: pointer; width: 24px; height: 24px; line-height: 24px; text-align: center; border-radius: 50%; transition: all 0.2s ease; }
        .ai-explanation-close:hover { background-color: #e1e5e9; color: #333; }
        .ai-explanation-copy { background: none; border: none; color: #889; font-size: 16px; cursor: pointer; width: 24px; height: 24px; line-height: 24px; text-align: center; border-radius: 50%; transition: all 0.2s ease; margin-right: 5px; }
        .ai-explanation-copy:hover { background-color: #e1e5e9; color: #333; }
        .ai-explanation-buttons { position: absolute; top: 6px; right: 6px; display: flex; gap: 5px; }
        .ai-explanation .markdown-content { font-size: 0.9em; line-height: 1.6; text-align: left; }
        .ai-explanation .markdown-content p { margin-bottom: 12px; }
        .ai-explanation .markdown-content p:last-child { margin-bottom: 0; }
        .ai-explanation .markdown-content h1, .ai-explanation .markdown-content h2, .ai-explanation .markdown-content h3 { margin-top: 16px; margin-bottom: 8px; border-bottom: 1px solid #d1d9e6; padding-bottom: 4px; }
        .ai-explanation .markdown-content pre { background-color: #2d2d2d; color: #f8f8f2; padding: 12px; border-radius: 8px; overflow-x: auto; font-family: 'Courier New', Courier, monospace; font-size: 0.85em; }
        .ai-explanation .markdown-content code { background-color: #e8e8e8; padding: 2px 5px; border-radius: 4px; font-family: 'Courier New', Courier, monospace; }
        .ai-explanation .markdown-content pre code { background-color: transparent; padding: 0; }
        .ai-explanation .markdown-content ul, .ai-explanation .markdown-content ol { padding-left: 20px; margin-top: 8px; margin-bottom: 12px; }
        .ai-explanation .markdown-content blockquote { border-left: 4px solid #b0c4de; padding-left: 12px; margin: 12px 0; color: #556; background-color: #f9f9f9; }
        .ai-explanation .markdown-content a { color: #007bff; text-decoration: none; }
        .ai-explanation .markdown-content a:hover { text-decoration: underline; }
        .loading-dots { display: inline-block; width: 1.5em; text-align: left; }
        .loading-dots::after { content: '.'; animation: dots 1s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); } 40% { color: black; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); } 60% { text-shadow: .25em 0 0 black, .5em 0 0 rgba(0,0,0,0); } 80%, 100% { text-shadow: .25em 0 0 black, .5em 0 0 black; } }
        @media (max-width: 768px) {
            html, body { overflow: visible; align-items: flex-start; }
            .chat-container { width: 100%; height: 100%; border-radius: 0; box-shadow: none; }
            .sidebar { position: absolute; left: -280px; top: 0; height: 100%; z-index: 1000; transition: left 0.3s ease; }
            .sidebar.open { left: 0; }
            .sidebar-toggle { display: flex; }
            .chat-header { padding: 10px 15px; }
            .chat-info { gap: 10px; }
            .room-icon { width: 28px; height: 28px; font-size: 14px; }
            .room-name { font-size: 1em; }
            .user-status { font-size: 0.75em; }
            .header-users { display: none; }
            .online-users-display { margin-left: auto; font-size: 0.75em; padding: 4px 8px; }
            .message-image { max-width: 250px; }
            #message-form { padding: 12px 15px; padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px)); }
            #message-input { padding: 10px 40px 10px 15px; font-size: 16px; }
            .users-menu { right: 15px; }
            .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; }
            .overlay.show { display: block; }
            .user-row { flex-direction: column; align-items: stretch; gap: 12px; }
            .user-names, .user-info { flex: none; width: 100%; }
        }
        .header-users { display: none; }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="overlay" id="overlay"></div>
        <div class="image-modal" id="image-modal">
            <button class="image-modal-close" id="modal-close">√ó</button>
            <img id="modal-image" src="" alt="Preview">
        </div>
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2><span class="online-indicator"></span> Âú®Á∫øÁî®Êà∑</h2>
            </div>
            <div class="user-list-container">
                <div class="user-list-title">Áî®Êà∑ & ÊàøÈó¥‰ø°ÊÅØ</div>
                <div class="user-row">
                    <div class="user-names" id="user-names"></div>
                    <div class="user-info">
                        <div class="info-row">
                            <span class="info-label">Âú®Á∫ø</span>
                            <span class="info-value online-count" id="online-count">0</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ÊàøÈó¥</span>
                            <span class="info-value room-name-sidebar" id="sidebar-room-name">--</span>
                        </div>
                    </div>
                </div>
                <ul id="user-list" style="display: none;"></ul>
            </div>
            <div class="user-stats-container">
                <div class="user-list-title">Áî®Êà∑ÁªüËÆ°</div>
                <div id="user-stats-list"></div>
            </div>
        </aside>
        <main class="main-chat">
            <header class="chat-header">
                <button class="sidebar-toggle" id="sidebar-toggle">‚ò∞</button>
                <div class="chat-info">
                    <div class="room-icon">üí¨</div>
                    <div class="chat-details">
                        <h1 class="room-name" id="room-name">Room: test</h1>
                        <p class="user-status">
                            <span class="connection-dot" id="connection-dot"></span>
                            <span id="status">Ê≠£Âú®ËøûÊé•...</span>
                            <span id="username-display" title="ÁÇπÂáª‰øÆÊîπÁî®Êà∑Âêç"></span>
                        </p>
                    </div>
                </div>
                <div class="header-users" id="header-users"></div>
                <div class="online-users-display" id="online-users-display">Âú®Á∫ø: 0</div>
                <div class="users-menu" id="users-menu">
                    <ul id="users-menu-list"></ul>
                </div>
            </header>
            <div id="chat-window"></div>
            <form id="message-form">
                <button type="button" class="icon-btn" id="attachment-btn">üìé</button>
                <input type="file" id="image-input" accept="image/*">
                <div class="input-wrapper">
                    <div class="image-preview" id="image-preview">
                        <div class="upload-progress" id="upload-progress" style="display: none;"></div>
                        <div class="preview-content">
                            <img class="preview-image" id="preview-image" src="" alt="Preview">
                            <div class="preview-info">
                                <div class="preview-name" id="preview-name"></div>
                                <div class="preview-size" id="preview-size"></div>
                            </div>
                            <button type="button" class="preview-remove" id="preview-remove">√ó</button>
                        </div>
                    </div>
                    <textarea id="message-input" placeholder="ËØ∑ËæìÂÖ•..." rows="1"></textarea>
                </div>
                <button type="button" class="icon-btn" id="record-button">üé§</button>
                <button id="send-button" type="submit" disabled>ÂèëÈÄÅ</button>
            </form>
        </main>
    </div>
    <div id="context-menu" class="context-menu">
        <ul>
            <li class="ai-explain-option" data-ai="gemini" data-action="text-explain">ÈóÆGemini</li>
            <li class="ai-explain-option" data-ai="deepseek" data-action="text-explain">DeepSeek</li>
            <li class="ai-explain-option" data-ai="gemini" data-action="image-describe">ÈóÆGemini (ÂõæÁâá)</li>
            <li id="copy-option">üìù Â§ç Âà∂</li>
            <li id="delete-option">‚ùå Âà† Èô§</li>
        </ul>
    </div>
    <div id="call-controls-container"></div>
    <div id="remote-audio-container"></div>
    <script type="module">
        // --- DOM Elements ---
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        const onlineDisplay = document.getElementById('online-users-display');
        const usersMenu = document.getElementById('users-menu');
        const attachmentBtn = document.getElementById('attachment-btn');
        const imageInput = document.getElementById('image-input');
        const imagePreview = document.getElementById('image-preview');
        const previewImage = document.getElementById('preview-image');
        const previewName = document.getElementById('preview-name');
        const previewSize = document.getElementById('preview-size');
        const previewRemove = document.getElementById('preview-remove');
        const uploadProgress = document.getElementById('upload-progress');
        const imageModal = document.getElementById('image-modal');
        const modalImage = document.getElementById('modal-image');
        const modalClose = document.getElementById('modal-close');
        const recordButton = document.getElementById('record-button');
        const messageInput = document.getElementById('message-input');
        const roomNameEl = document.getElementById('room-name');
        const statusEl = document.getElementById('status');
        const usernameDisplayEl = document.getElementById('username-display');
        const connectionDot = document.getElementById('connection-dot');
        const chatWindowEl = document.getElementById('chat-window');
        const messageForm = document.getElementById('message-form');
        const sendButton = document.getElementById('send-button');
        const contextMenu = document.getElementById('context-menu');
        const copyOption = document.getElementById('copy-option');
        const deleteOption = document.getElementById('delete-option');
        const userStatsListEl = document.getElementById('user-stats-list');
        const callControlsContainer = document.getElementById('call-controls-container');
        const remoteAudioContainer = document.getElementById('remote-audio-container');

        // --- State Variables ---
        let selectedFile = null;
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let currentMessageElement = null;
        let socket;
        let reconnectInterval = 1000;
        const maxReconnectInterval = 30000;
        let localStream = null;
        const peerConnections = {};
        const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

        // --- Initialization ---
        let username = localStorage.getItem('chat_username');
        if (!username) {
            username = prompt("ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÂßìÂêç:") || "ÔΩûËãëÂπøÂ±±";
            localStorage.setItem('chat_username', username);
        }
        const pathParts = window.location.pathname.split('/');
        const roomName = pathParts.find(p => p) || 'general';
        roomNameEl.textContent = roomName;
        document.getElementById('sidebar-room-name').textContent = roomName;

        usernameDisplayEl.textContent = username;
        usernameDisplayEl.addEventListener('click', () => {
            const newUsername = prompt("ËØ∑ËæìÂÖ•Êñ∞ÁöÑÁî®Êà∑Âêç:", username);
            if (newUsername && newUsername !== username) {
                username = newUsername;
                localStorage.setItem('chat_username', username);
                usernameDisplayEl.textContent = username;
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({ type: 'rename', payload: { newUsername: username } }));
                }
            }
        });

        // --- UI Event Listeners ---
        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
        });
        overlay.addEventListener('click', () => {
            sidebar.classList.remove('open');
            overlay.classList.remove('show');
        });
        onlineDisplay.addEventListener('click', (e) => {
            e.stopPropagation();
            usersMenu.classList.toggle('show');
        });
        document.addEventListener('click', () => {
            usersMenu.classList.remove('show');
            contextMenu.style.display = 'none';
        });
        usersMenu.addEventListener('click', e => e.stopPropagation());

        // --- Image & Media Functions ---
        attachmentBtn.addEventListener('click', () => imageInput.click());
        imageInput.addEventListener('change', handleImageSelection);
        previewRemove.addEventListener('click', removeImagePreview);
        modalClose.addEventListener('click', () => imageModal.classList.remove('show'));
        imageModal.addEventListener('click', (e) => {
            if (e.target === imageModal) imageModal.classList.remove('show');
        });
        recordButton.addEventListener('click', handleRecordButtonClick);
        const showImageModal = (src) => {
            modalImage.src = src;
            imageModal.classList.add('show');
        };

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(2))} ${sizes[i]}`;
        }

        async function handleImageSelection(e) {
            const file = e.target.files[0];
            if (!file || !file.type.startsWith('image/')) return;
            try {
                uploadProgress.style.display = 'block';
                imagePreview.classList.add('show', 'uploading');
                const compressedBlob = await compressImage(file);
                selectedFile = new File([compressedBlob], file.name, { type: 'image/jpeg', lastModified: Date.now() });
                showImagePreview(selectedFile);
                checkSendButtonState();
            } catch (error) {
                console.error('ÂõæÁâáÂ§ÑÁêÜÂ§±Ë¥•:', error);
                alert('ÂõæÁâáÂ§ÑÁêÜÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            } finally {
                uploadProgress.style.display = 'none';
                imagePreview.classList.remove('uploading');
            }
        }

        function compressImage(file, maxWidth = 800, maxHeight = 600, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    let { width, height } = img;
                    if (width > height) {
                        if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                    } else {
                        if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; }
                    }
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    canvas.toBlob(resolve, 'image/jpeg', quality);
                };
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }
        
        function showImagePreview(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImage.src = e.target.result;
                previewName.textContent = file.name;
                previewSize.textContent = formatFileSize(file.size);
                imagePreview.classList.add('show');
            };
            reader.readAsDataURL(file);
        }

        function removeImagePreview() {
            selectedFile = null;
            imagePreview.classList.remove('show');
            imageInput.value = '';
            checkSendButtonState();
        }

        async function handleRecordButtonClick() {
            if (isRecording) {
                mediaRecorder.stop();
                recordButton.textContent = 'üé§';
                isRecording = false;
                checkSendButtonState();
                return;
            }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const mimeType = ['audio/mp4', 'audio/webm;codecs=opus', 'audio/webm'].find(t => MediaRecorder.isTypeSupported(t));
                if (!mimeType) {
                    alert('ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅÂΩïÈü≥ÂäüËÉΩ„ÄÇ');
                    return;
                }
                mediaRecorder = new MediaRecorder(stream, { mimeType });
                audioChunks = [];
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: mimeType });
                    sendAudioMessage(audioBlob, mimeType);
                    stream.getTracks().forEach(track => track.stop());
                    checkSendButtonState();
                };
                mediaRecorder.start();
                recordButton.textContent = 'üõë';
                isRecording = true;
                checkSendButtonState();
            } catch (error) {
                console.error('Êó†Ê≥ïËÆøÈóÆÈ∫¶ÂÖãÈ£é:', error);
                alert('Êó†Ê≥ïËÆøÈóÆÈ∫¶ÂÖãÈ£éÔºåËØ∑Ê£ÄÊü•ÊùÉÈôê„ÄÇ');
            }
        }
        
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = `${Math.min(this.scrollHeight, 100)}px`;
            checkSendButtonState();
        });
        
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                messageForm.dispatchEvent(new Event('submit'));
            }
        });
        
        function checkSendButtonState() {
            sendButton.disabled = (messageInput.value.trim() === '' && selectedFile === null) || isRecording;
        }

        // --- WebSocket & Chat Logic ---
        function connectWebSocket() {
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            socket = new WebSocket(`${wsProtocol}//${window.location.host}/${roomName}?username=${encodeURIComponent(username)}`);
            socket.onopen = onSocketOpen;
            socket.onmessage = onSocketMessage;
            socket.onclose = onSocketClose;
            socket.onerror = onSocketError;
        }
        
        function onSocketOpen() {
            console.log("WebSocket connection established.");
            statusEl.textContent = 'Â∑≤ËøûÊé•';
            connectionDot.classList.remove('disconnected');
            reconnectInterval = 1000;
            checkSendButtonState();
            // **FIX**: ÂΩìËøûÊé•ÊàêÂäüÂêéÔºåÁ´ãÂç≥Ëé∑Âèñ‰∏ÄÊ¨°Áî®Êà∑ÁªüËÆ°Êï∞ÊçÆ
            fetchUserStats();
        }
    
        async function onSocketMessage(event) {
            const data = JSON.parse(event.data);
            switch (data.type) {
                case 'history':
                    console.log("Received history with", data.payload.length, "messages.");
                    chatWindowEl.innerHTML = ''; // Ê∏ÖÁ©∫ÊóßÊ∂àÊÅØ
                    data.payload.forEach(msg => appendChatMessage(msg));
                    // Á°Æ‰øùÊªöÂä®Âà∞Â∫ïÈÉ®
                    chatWindowEl.scrollTop = chatWindowEl.scrollHeight;
                    break;
                case 'chat':
                    appendChatMessage(data.payload);
                    break;
                case 'system_state':
                    updateUserList(data.payload.users);
                    // **FIX**: ÂΩìÁî®Êà∑ÂàóË°®ÂèòÂåñÊó∂ÔºåÂà∑Êñ∞ÁªüËÆ°Êï∞ÊçÆ
                    fetchUserStats();
                    break;
                case 'error':
                    alert(data.payload.message);
                    sendButton.disabled = false;
                    break;
                case 'delete':
                    deleteChatMessage(data.payload.id);
                    break;
                case 'offer': await handleOffer(data.payload); break;
                case 'answer': await handleAnswer(data.payload); break;
                case 'candidate': await handleCandidate(data.payload); break;
                case 'call_end': handleCallEnd(data.payload); break;
            }
        }
        
        function onSocketClose() {
            console.log("WebSocket connection closed. Reconnecting...");
            statusEl.textContent = "ËøûÊé•Â∑≤Êñ≠ÂºÄ";
            connectionDot.classList.add('disconnected');
            setTimeout(connectWebSocket, reconnectInterval);
            reconnectInterval = Math.min(reconnectInterval * 2, maxReconnectInterval);
        }

        function onSocketError(error) {
            console.error("WebSocket Error:", error);
            statusEl.textContent = "ËøûÊé•ÈîôËØØ";
            // onSocketClose will be called, so it will handle the reconnection logic.
            socket.close();
        }

        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if ((!text && !selectedFile) || socket.readyState !== WebSocket.OPEN) return;
            sendButton.disabled = true;
            try {
                if (selectedFile) await sendImageMessage(selectedFile, text);
                else if (text) socket.send(JSON.stringify({ type: 'chat', payload: { text } }));
                messageInput.value = '';
                messageInput.style.height = 'auto';
            } catch (error) {
                console.error('ÂèëÈÄÅÊ∂àÊÅØÂ§±Ë¥•:', error);
                alert('ÂèëÈÄÅÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            } finally {
                sendButton.disabled = false;
                checkSendButtonState();
            }
        });
        
        async function sendImageMessage(file, caption = '') {
            const reader = new FileReader();
            reader.onload = (e) => {
                const message = { type: 'chat', payload: { type: 'image', image: e.target.result, filename: file.name, size: file.size, caption: caption } };
                socket.send(JSON.stringify(message));
            };
            reader.readAsDataURL(file);
        }
        
        async function sendAudioMessage(blob, mimeType) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const fileExtension = mimeType.split('/')[1].split(';')[0];
                const message = { type: 'chat', payload: { type: 'audio', audio: e.target.result, filename: `voice-${Date.now()}.${fileExtension}`, size: blob.size, mimeType: mimeType } };
                socket.send(JSON.stringify(message));
            };
            reader.readAsDataURL(blob);
        }

        // --- UI Rendering ---
        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/[&<>\"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'})[m]);
        }
        
        function updateUserList(users) {
            const userNamesEl = document.getElementById('user-names');
            const onlineCountEl = document.getElementById('online-count');
            const menuListEl = document.getElementById('users-menu-list');
            userNamesEl.innerHTML = '';
            menuListEl.innerHTML = '';
            onlineCountEl.textContent = users.length;
            onlineDisplay.textContent = `Âú®Á∫ø: ${users.length}`;
            users.forEach(user => {
                const safeName = escapeHTML(user);
                userNamesEl.insertAdjacentHTML('beforeend', `<div class="user-item">${safeName}</div>`);
                if (user === username) {
                    menuListEl.insertAdjacentHTML('beforeend', `<li>${safeName} (‰Ω†)</li>`);
                } else {
                    menuListEl.insertAdjacentHTML('beforeend', `<li class="user-menu-item-with-call"><span>${safeName}</span><button class="call-btn" data-username="${safeName}">üìû</button></li>`);
                }
            });
            document.querySelectorAll('.call-btn').forEach(btn => {
                btn.onclick = (e) => {
                    e.stopPropagation();
                    startCall(btn.dataset.username);
                    usersMenu.classList.remove('show');
                };
            });
        }
        
        function appendChatMessage(msg) {
            const msgEl = document.createElement('div');
            msgEl.className = 'message';
            msgEl.dataset.id = msg.id;
            msgEl.dataset.messageText = msg.text || (msg.caption || '');
            if (msg.username === username) msgEl.classList.add('self');
            msgEl.dataset.messageType = msg.type || 'text'; // Default to 'text' if not specified
            const messageDate = new Date(msg.timestamp);
            const now = new Date();
            const diffMinutes = Math.floor((now - messageDate) / (1000 * 60));
            let displayTime;
            if (diffMinutes < 1) {
                displayTime = 'ÂàöÂàö';
            } else if (diffMinutes < 60) {
                displayTime = `${diffMinutes}ÂàÜÈíüÂâç`;
            } else if (diffMinutes < 24 * 60) {
                displayTime = `${Math.floor(diffMinutes / 60)}Â∞èÊó∂Ââç`;
            } else {
                displayTime = messageDate.toLocaleString([], { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            }
            let contentHTML = `<div class="info"><span class="username">${escapeHTML(msg.username)}</span> <span class="timestamp">${displayTime}</span></div>`;
            if (msg.type === 'image') {
                contentHTML += `<div class="message-image" onclick="showImageModal('${msg.imageUrl}')"><img src="${msg.imageUrl}" alt="${escapeHTML(msg.filename || 'Image')}" loading="lazy"></div>`;
                if (msg.caption) contentHTML += `<div class="text">${marked.parse(msg.caption)}</div>`;
                msgEl.dataset.imageUrl = msg.imageUrl;
            } else if (msg.type === 'audio') {
                contentHTML += `<div class="message-audio"><audio controls src="${msg.audioUrl}"></audio></div>`;
            } else {
                contentHTML += `<div class="text">${marked.parse(msg.text)}</div>`;
            }
            msgEl.innerHTML = contentHTML;
            msgEl.addEventListener('contextmenu', e => { e.preventDefault(); showContextMenu(msgEl, e.pageX, e.pageY); });
            let longPressTimer;
            msgEl.addEventListener('touchstart', e => {
                longPressTimer = setTimeout(() => showContextMenu(msgEl, e.touches[0].pageX, e.touches[0].pageY), 500);
            }, { passive: true });
            msgEl.addEventListener('touchend', () => clearTimeout(longPressTimer));
            msgEl.addEventListener('touchmove', () => clearTimeout(longPressTimer));
            chatWindowEl.appendChild(msgEl);
            chatWindowEl.scrollTop = chatWindowEl.scrollHeight;
        }
        
        function showContextMenu(element, x, y) {
            currentMessageElement = element;
            contextMenu.style.top = `${y}px`;
            contextMenu.style.left = `${x}px`;
            contextMenu.style.display = 'block';
            const messageType = element.dataset.messageType;
            const geminiTextOption = contextMenu.querySelector('[data-ai="gemini"][data-action="text-explain"]');
            const deepseekTextOption = contextMenu.querySelector('[data-ai="deepseek"][data-action="text-explain"]');
            const geminiImageOption = contextMenu.querySelector('[data-ai="gemini"][data-action="image-describe"]');
            if (messageType === 'image') {
                geminiTextOption.style.display = 'none';
                deepseekTextOption.style.display = 'none';
                geminiImageOption.style.display = 'flex';
                copyOption.style.display = 'none';
            } else {
                geminiTextOption.style.display = 'flex';
                deepseekTextOption.style.display = 'flex';
                geminiImageOption.style.display = 'none';
                copyOption.style.display = 'flex';
            }
            if (navigator.vibrate) navigator.vibrate(50);
        }

        // --- Context Menu Actions ---
        copyOption.addEventListener('click', () => {
            if (currentMessageElement?.dataset.messageText) {
                navigator.clipboard.writeText(currentMessageElement.dataset.messageText);
            }
            contextMenu.style.display = 'none';
        });

        deleteOption.addEventListener('click', () => {
            if (currentMessageElement?.dataset.id) {
                deleteMessage(currentMessageElement.dataset.id);
            }
            contextMenu.style.display = 'none';
        });
        
        function deleteMessage(id) {
            if (socket?.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ type: 'delete', payload: { id } }));
            }
        }
        
        function deleteChatMessage(id) {
            const msgEl = chatWindowEl.querySelector(`[data-id="${id}"]`);
            if (msgEl) msgEl.remove();
        }

        contextMenu.addEventListener('click', async (e) => {
            // ... (‰øùÊåÅ‰∏çÂèò) ...
        });

        // --- User Stats Functions ---
        async function fetchUserStats() {
            try {
                console.log("Fetching user stats...");
                const response = await fetch(`/room-user-stats?roomName=${encodeURIComponent(roomName)}`);
                if (!response.ok) {
                    throw new Error(`Failed to fetch user stats: ${response.status} ${response.statusText}`);
                }
                const stats = await response.json();
                console.log("Received user stats:", stats);
                renderUserStats(stats);
            } catch (error) {
                console.error('Error fetching user stats:', error);
                userStatsListEl.innerHTML = '<p style="color: rgba(255,255,255,0.7); font-size: 0.8em;">Âä†ËΩΩÁªüËÆ°Â§±Ë¥•„ÄÇ</p>';
            }
        }

        function renderUserStats(stats) {
            userStatsListEl.innerHTML = '';
            if (!stats || stats.length === 0) {
                userStatsListEl.innerHTML = '<p style="color: rgba(255,255,255,0.7); font-size: 0.8em;">ÊöÇÊó†Áî®Êà∑ÁªüËÆ°Êï∞ÊçÆ„ÄÇ</p>';
                return;
            }
            stats.sort((a, b) => b.isOnline - a.isOnline || b.messageCount - a.messageCount);
            stats.forEach(userStat => {
                const item = document.createElement('div');
                item.className = 'user-stats-item';
                const lastSeenDate = new Date(userStat.lastSeen);
                const lastSeenString = lastSeenDate.toLocaleString([], { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                let onlineDurationString = '-';
                if(userStat.totalOnlineDuration > 0) {
                    const durationMs = userStat.totalOnlineDuration;
                    const hours = Math.floor(durationMs / 3600000);
                    const minutes = Math.floor((durationMs % 3600000) / 60000);
                    const seconds = Math.floor((durationMs % 60000) / 1000);
                    onlineDurationString = `${hours}h ${minutes}m ${seconds}s`;
                }
                
                item.innerHTML = `
                    <div class="stat-row">
                        <strong>${escapeHTML(userStat.username)}</strong>
                        <span class="${userStat.isOnline ? 'online-status' : 'offline-status'}">
                            ${userStat.isOnline ? 'Âú®Á∫ø' : 'Á¶ªÁ∫ø'}
                        </span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">ÂèëË®Ä:</span>
                        <span class="stat-value">${userStat.messageCount}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Âú®Á∫øÊó∂Èïø:</span>
                        <span class="stat-value">${onlineDurationString}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">ÊúÄËøëÊ¥ªÂä®:</span>
                        <span class="stat-value">${lastSeenString}</span>
                    </div>
                `;
                userStatsListEl.appendChild(item);
            });
        }

        // --- WebRTC Functions ---
        async function initLocalMedia() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
            } catch (err) {
                console.error('Êó†Ê≥ïËé∑ÂèñÈ∫¶ÂÖãÈ£éÔºåÈÄöËØùÂäüËÉΩ‰∏çÂèØÁî®„ÄÇ', err);
            }
        }
        function showCallUI(targetUsername) { /* ... (‰øùÊåÅ‰∏çÂèò) ... */ }
        function hideCallUI(targetUsername) { /* ... (‰øùÊåÅ‰∏çÂèò) ... */ }
        async function startCall(target) { /* ... (‰øùÊåÅ‰∏çÂèò) ... */ }
        async function handleOffer({ from, sdp }) { /* ... (‰øùÊåÅ‰∏çÂèò) ... */ }
        async function handleAnswer({ from, sdp }) { /* ... (‰øùÊåÅ‰∏çÂèò) ... */ }
        async function handleCandidate({ from, candidate }) { /* ... (‰øùÊåÅ‰∏çÂèò) --*/ }
        function handleCallEnd({ from }) { /* ... (‰øùÊåÅ‰∏çÂèò) ... */ }
        function endCall(target) { /* ... (‰øùÊåÅ‰∏çÂèò) ... */ }
        function playRemoteStream(username, stream) { /* ... (‰øùÊåÅ‰∏çÂèò) ... */ }

        // --- Initial Connection ---
        console.log("Initializing chat application...");
        initLocalMedia();
        connectWebSocket();
    </script>
</body>
</html>