<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>用户组管理</title>
    <style>
        body { font-family: sans-serif; background-color: #f4f7f6; padding: 20px; }
        .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; }
        #user-list { list-style: none; padding: 0; }
        #user-list li { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        #user-list button { background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .form-group { margin-top: 20px; display: flex; gap: 10px; }
        .form-group input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        .form-group button { background: #3498db; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>用户组管理</h1>
        <div class="controls">
            <input type="text" id="room-name-input" placeholder="输入房间名 (e.g., test)">
            <button id="load-users-btn">加载用户列表</button>
        </div>
        <ul id="user-list"></ul>
        <div class="form-group">
            <input type="text" id="new-user-input" placeholder="输入新用户名">
            <button id="add-user-btn">添加用户</button>
        </div>
    </div>

    <script>
        const roomNameInput = document.getElementById('room-name-input');
        const userList = document.getElementById('user-list');
        const newUserInput = document.getElementById('new-user-input');
        const addUserBtn = document.getElementById('add-user-btn');
        const loadUsersBtn = document.getElementById('load-users-btn');

        let currentRoom = '';

async function fetchUsers() {
    if (!currentRoom) {
        alert('请输入房间名');
        return;
    }
    try {
        const response = await fetch(`/api/users/list?roomName=${currentRoom}`);
        if (!response.ok) {
            // 尝试读取错误信息
            const errorText = await response.text();
            throw new Error(`获取用户列表失败: ${response.status} - ${errorText}`);
        }
        const data = await response.json();

        // 【核心修改】: 从返回的对象中提取 users 数组
        // 同时增加一个健壮性检查，确保它是一个数组
        if (data && Array.isArray(data.users)) {
            renderUsers(data.users);
        } else {
            throw new Error('从服务器返回的数据格式不正确。');
        }

    } catch (error) {
        console.error('Error:', error);
        alert(error.message);
    }
}
        function renderUsers(users) {
            userList.innerHTML = '';
            users.forEach(user => {
                const li = document.createElement('li');
                li.textContent = user;
                const removeBtn = document.createElement('button');
                removeBtn.textContent = '移除';
                removeBtn.onclick = () => removeUser(user);
                li.appendChild(removeBtn);
                userList.appendChild(li);
            });
        }

        async function addUser() {
            const username = newUserInput.value.trim();
            if (!username || !currentRoom) {
                alert('请输入房间名和用户名');
                return;
            }
            try {
                const response = await fetch(`/api/users/add?roomName=${currentRoom}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                if (!response.ok) throw new Error('添加用户失败');
                newUserInput.value = '';
                await fetchUsers(); // 重新加载列表
            } catch (error) {
                console.error('Error:', error);
                alert(error.message);
            }
        }

        async function removeUser(username) {
            if (!currentRoom) return;
            try {
                const response = await fetch(`/api/users/remove?roomName=${currentRoom}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                if (!response.ok) throw new Error('移除用户失败');
                await fetchUsers(); // 重新加载列表
            } catch (error) {
                console.error('Error:', error);
                alert(error.message);
            }
        }

        loadUsersBtn.addEventListener('click', () => {
            currentRoom = roomNameInput.value.trim();
            if(currentRoom) {
                fetchUsers();
            } else {
                alert("请输入房间名！");
            }
        });
        
        addUserBtn.addEventListener('click', addUser);
    </script>
</body>
</html>