<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>å®æ—¶èŠå¤©å®¤</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
;(function(){
  /* 1. passive-patch ä¿æŒåŸæ · */
  const PASSIVE_EVENTS = new Set([
      'scroll',
      'wheel',
      'mousewheel',  // for older browsers
      'touchstart',
      'touchmove',
      'touchenter',
      'touchend',
      'touchleave',
      'touchcancel'
    ]);
  const _orig = EventTarget.prototype.addEventListener;
  EventTarget.prototype.addEventListener = function(type, fn, opts){
    if (PASSIVE_EVENTS.has(type)){
      if (opts===undefined) opts={passive:true};
      else if (typeof opts==='boolean') opts={capture:opts, passive:true};
      else if (typeof opts==='object' && opts.passive===undefined) opts.passive=true;
    }
    return _orig.call(this, type, fn, opts);
  };
  /* 2. ç­‰ DOM å®Œå…¨å°±ç»ªåå†è§£é” AudioContext */
  document.addEventListener('DOMContentLoaded', ()=>{
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    function unlockAudioContext(e){
      if (e.type==='touchend') e.preventDefault();
      const ac = new AudioCtx();
      if (ac.state==='suspended') ac.resume();
      new Audio("data:audio/mp3;base64,SUQzâ€¦").play().catch(()=>{});
      document.body.removeEventListener('click', unlockAudioContext);
      document.body.removeEventListener('touchend', unlockAudioContext);
    }
    document.body.addEventListener('click', unlockAudioContext, { once: true });
    document.body.addEventListener('touchend', unlockAudioContext, { once: true, passive: false });
  });
})();
</script>
    <style>
        /* --- BASE STYLES --- */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            overscroll-behavior: none; /* é˜²æ­¢æ•´é¡µæ©¡çš®ç­‹æ•ˆæœ */
        }
        
        .chat-container {
            width: 90%;
            max-width: 800px;
            height: 100%;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 0;
            border-right: none;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        .sidebar-header {
            padding: 20px;
            background: rgba(0,0,0,0.1);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .sidebar h2 {
            margin: 0;
            font-size: 1.2em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .online-indicator {
            width: 8px;
            height: 8px;
            background: #2ecc71;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .user-list-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .user-list-title {
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 12px;
            color: rgba(255, 255, 255, 0.9);
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .user-row {
            display: flex;
            align-items: flex-start;
            margin-bottom: 16px;
            gap: 16px;
        }
        
        .user-names {
            flex: 1;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: flex-start;
        }
        
        .user-item {
            padding: 6px 10px;
            font-size: 0.8em;
            background: rgba(255,255,255,0.15);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }
        
        .user-item::before { content: 'ğŸ‘¤'; font-size: 10px; }
        .user-item:hover { background: rgba(255,255,255,0.25); transform: scale(1.05); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .user-info { flex: 1; display: flex; flex-direction: column; gap: 8px; font-size: 0.75em; }
        .info-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: rgba(255,255,255,0.08); border-radius: 8px; transition: all 0.3s ease; border: 1px solid rgba(255,255,255,0.05); }
        .info-row:hover { background: rgba(255,255,255,0.15); box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .info-label { color: rgba(255,255,255,0.8); font-weight: 500; }
        .info-value { color: white; font-weight: 600; text-align: right; }
        .online-count { color: #2ecc71; font-size: 1.1em; }
        .room-name-sidebar { color: #f39c12; font-size: 0.9em; }

        .user-stats-container {
            padding: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            margin-top: auto; /* Push to bottom */
            max-height: 50vh; /* è®¾ç½®ä¸€ä¸ªæœ€å¤§é«˜åº¦ï¼Œä¾‹å¦‚ 250px */
            overflow-y: auto;  /* å½“å†…å®¹è¶…å‡ºæœ€å¤§é«˜åº¦æ—¶ï¼Œå‚ç›´æ–¹å‘æ˜¾ç¤ºæ»šåŠ¨æ¡ */
        }
        .user-stats-item {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            color: white;
            font-size: 0.85em;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .user-stats-item:last-child { margin-bottom: 0; }
        .user-stats-item strong { color: #f39c12; }
        .user-stats-item .stat-label { opacity: 0.8; font-size: 0.9em; }
        .user-stats-item .stat-value { font-weight: 600; }
        .user-stats-item .stat-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .user-stats-item .stat-row:last-child { margin-bottom: 0; }
        .user-stats-item .online-status { color: #2ecc71; font-weight: 600; }
        .user-stats-item .offline-status { color: #e74c3c; font-weight: 600; }
        
        /* --- MAIN CHAT AREA --- */
        .main-chat { flex: 1; display: flex; flex-direction: column; min-width: 0; height: 100%; }
        .chat-header { padding: 12px 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; box-shadow: 0 2px 15px rgba(102, 126, 234, 0.2); position: relative; }
        .sidebar-toggle { display: none; align-items: center; justify-content: center; width: 36px; height: 36px; background: rgba(255, 255, 255, 0.2); border: none; border-radius: 8px; font-size: 16px; color: white; cursor: pointer; transition: all 0.3s ease; flex-shrink: 0; }
        .sidebar-toggle:hover { background: rgba(255, 255, 255, 0.3); }
        .chat-info { display: flex; align-items: center; gap: 12px; flex: 0 0 auto; }
        .room-icon { width: 32px; height: 32px; background: rgba(255, 255, 255, 0 ); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; }
        .chat-details { display: flex; flex-direction: column; min-width: 0; }
        .room-name { font-size: 1.1em; font-weight: 700; margin: 0; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .user-status { font-size: 0.8em; opacity: 0.9; margin: 2px 0 0 0; display: flex; align-items: center; gap: 6px; }
        #username-display {
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
            text-underline-offset: 3px;
            transition: color 0.3s;
        }
        #username-display:hover {
            color: #f39c12;
        }
        .connection-dot { width: 6px; height: 6px; background: #2ecc71; border-radius: 50%; animation: pulse 2s infinite; }
        .connection-dot.disconnected { background: #e74c3c; animation: none; }
        .online-users-display { cursor: pointer; user-select: none; font-size: 0.8em; font-weight: 500; color: rgba(255, 255, 255, 0.9); background: rgba(255,255,255,0.15); padding: 6px 10px; border-radius: 12px; backdrop-filter: blur(10px); flex-shrink: 0; white-space: nowrap; transition: all 0.3s ease; }
        .online-users-display:hover { background: rgba(255,255,255,0.25); }
        .users-menu { display: none; position: absolute; top: 100%; right: 25px; background: white; border: 1px solid #ddd; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 8px; max-height: 200px; overflow-y: auto; z-index: 200; margin-top: 8px; min-width: 160px; }
        .users-menu.show { display: block; }
        .users-menu ul { list-style: none; margin: 0; padding: 8px 0; }
        .users-menu li { padding: 8px 12px; font-size: 0.9em; color: #333; white-space: nowrap; display: flex; align-items: center; gap: 6px; }
        .users-menu li::before { content: 'ğŸ‘¤'; font-size: 12px; }
        .users-menu li:hover { background: #f5f5f5; }

        /* --- CHAT WINDOW --- */
        #chat-window { 
            flex: 1; 
            padding: 20px 25px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom, 0px)); 
            overflow-y: auto; 
            min-height: 0; 
            background: #f8f9fa; 
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch; /* å…³é”®: ä½¿iOSè®¾å¤‡ä¸Šçš„æ»šåŠ¨æ›´æµç•… */
            overscroll-behavior: contain; /* ç¡®ä¿æ»šåŠ¨è¡Œä¸ºè¢«åŒ…å« */
            touch-action: pan-y; /* æ˜ç¡®å¯ç”¨å‚ç›´å¹³ç§» */
            position: relative; /* ç¡®ä¿æ­£ç¡®å®šä½ */
        }
        #chat-window::-webkit-scrollbar { width: 4px; }
        #chat-window::-webkit-scrollbar-track { background: transparent; }
        #chat-window::-webkit-scrollbar-thumb { background: #ccc; border-radius: 2px; }
        #chat-window::-webkit-scrollbar-thumb:hover { background: #999; }

        /* --- MESSAGE STYLES --- */
        .message { margin-bottom: 16px; display: flex; flex-direction: column; animation: fadeInUp 0.3s ease; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .message .info { margin-bottom: 5px; }
        .message .info .username { font-size: 0.85em; font-weight: 700; color: #495057; }
        .message .info .timestamp { font-size: 0.65em; color: #999; }
        .message .text { padding: 10px 10px; background: white; border-radius: 16px; max-width: 75%; line-height: 1.4; word-wrap: break-word; box-shadow: 0 1px 6px rgba(0,0,0,0.08); border: 1px solid #e9ecef; position: relative; }
        .message.self { align-items: flex-end; }
        .message.self .text { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; }
        .message.self .info { text-align: right; }

        /* --- MARKDOWN STYLES --- */
        .message .text { line-height: 1.6; }
        .message .text h1, .message .text h2, .message .text h3 { margin-top: 0.5em; margin-bottom: 0.5em; border-bottom: 1px solid #eee; padding-bottom: 0.3em; }
        .message.self .text h1, .message.self .text h2, .message.self .text h3 { border-bottom-color: rgba(255, 255, 255, 0.3); }
        .message .text p { margin-top: 0; margin-bottom: 0; }
        .message .text ul, .message .text ol { padding-left: 1.5em; margin-bottom: 1em; }
        .message .text li { margin-bottom: 0.25em; }
        .message .text pre { background-color: #2d2d2d; color: #f8f8f2; padding: 1em; border-radius: 8px; overflow-x: auto; font-family: 'Courier New', Courier, monospace; font-size: 0.9em; margin: 1em 0; }
        .message.self .text pre { background-color: rgba(0, 0, 0, 0.2); }
        .message .text code { background-color: rgba(0,0,0,0.05); padding: 0.2em 0.4em; border-radius: 4px; font-family: 'Courier New', Courier, monospace; }
        .message.self .text code { background-color: rgba(255, 255, 255, 0.2); }
        .message .text pre > code { background-color: transparent; padding: 0; }
        .message .text blockquote { border-left: 4px solid #ccc; padding-left: 1em; margin: 1em 0; color: #666; }
        .message.self .text blockquote { border-left-color: rgba(255, 255, 255, 0.5); color: rgba(255, 255, 255, 0.8); }
        .message .text table { border-collapse: collapse; width: 100%; margin: 1em 0; }
        .message .text th, .message .text td { border: 1px solid #ddd; padding: 0.5em; }
        .message.self .text th, .message.self .text td { border-color: rgba(255, 255, 255, 0.3); }
        .message .text th { background-color: #f2f2f2; }
        .message.self .text th { background-color: rgba(0, 0, 0, 0.1); }
        .message .text a { color: #007bff; text-decoration: none; }
        .message .text a:hover { text-decoration: underline; }
        .message.self .text a { color: #a0c8ff; }

        /* --- MEDIA MESSAGE STYLES --- */
        .message-image { padding: 4px; background: white; border-radius: 16px; max-width: 300px; box-shadow: 0 1px 6px rgba(0,0,0,0.08); border: 1px solid #e9ecef; overflow: hidden; cursor: pointer; transition: all 0.3s ease; position: relative; }
        .message-image:hover { transform: scale(1.02); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .message-image img { width: 100%; height: auto; border-radius: 12px; display: block; }
        .message.self .message-image { background: rgba(255,255,255,0.1); border: none; }
        .message-audio { display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: #f1f3f5; border-radius: 16px; border: 1px solid #e9ecef; }
        .message.self .message-audio { background: #7783EA; border: none; }
        .message-audio audio { outline: none; }
        
        /* --- IMAGE MODAL & PREVIEW --- */
        .image-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; animation: fadeIn 0.3s ease; }
        .image-modal.show { display: flex; }
        .image-modal img { max-width: 90%; max-height: 90%; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .image-modal-close { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
        .image-modal-close:hover { background: rgba(255,255,255,0.3); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- INPUT AREA --- */
        #message-form { position: sticky; bottom: env(safe-area-inset-bottom, 0); display: flex; padding: 12px 15px; gap: 8px; align-items: center; border-top: 1px solid #e9ecef; background: white; box-shadow: 0 -2px 15px rgba(0,0,0,0.08); z-index: 100; }
        .icon-btn {
            background: none;
            border: none;
            color: #6c757d;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
            width: 44px;
            height: 44px;
        }
        .icon-btn:hover {
            background: #f1f3f5;
            color: #667eea;
        }
        .input-wrapper { flex: 1; position: relative; }
        #message-input { width: 100%; padding: 12px 18px; border: 2px solid #e9ecef; border-radius: 22px; outline: none; font-size: 0.95em; font-family: inherit; resize: none; min-height: 20px; max-height: 100px; line-height: 1.4; transition: all 0.3s ease; box-sizing: border-box; }
        #message-input:focus { border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        #image-input { display: none; }
        .image-preview { position: absolute; bottom: 100%; left: 0; right: 0; background: white; border: 2px solid #667eea; border-radius: 12px; padding: 12px; margin-bottom: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); display: none; }
        .image-preview.show { display: block; }
        .preview-content { display: flex; align-items: center; gap: 12px; }
        .preview-image { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; border: 1px solid #e9ecef; }
        .preview-info { flex: 1; min-width: 0; }
        .preview-name { font-size: 0.9em; font-weight: 600; color: #333; margin-bottom: 4px; word-break: break-all; }
        .preview-size { font-size: 0.8em; color: #6c757d; }
        .preview-remove { background: #e74c3c; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; transition: all 0.3s ease; }
        .preview-remove:hover { background: #c0392b; }
        .uploading { opacity: 0.6; pointer-events: none; }
        .upload-progress { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(102, 126, 234, 0.9); color: white; padding: 8px 12px; border-radius: 8px; font-size: 0.8em; font-weight: 500; }
        #send-button { padding: 10px 20px; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 22px; cursor: pointer; font-size: 0.9em; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 3px 12px rgba(102, 126, 234, 0.3); min-width: 70px; }
        #send-button:hover { transform: translateY(-1px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        #send-button:active { transform: translateY(0); }
        #send-button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        
        /* --- CONTEXT MENU & AI EXPLANATION STYLES --- */
        .context-menu { display: none; position: absolute; background-color: #f1f1f1; border: 1px solid #ccc; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.15); z-index: 1000; }
        .context-menu ul { list-style: none; padding: 5px 0; margin: 0; }
        .context-menu ul li { padding: 8px 15px; cursor: pointer; }
        .context-menu ul li:hover { background-color: #ddd; }

        /* Call Controls */
        #call-controls-container {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 1001;
        }
        .call-control-panel {
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .hang-up-btn {
            background: #e74c3c;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
        }
        .user-menu-item-with-call {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .call-btn {
            background: #2ecc71;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            margin-left: 10px;
        }
        .unmute-notice {
            background: #f39c12;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
        }

        /* (å¯é€‰) ä¸ºAIèœå•é¡¹æ·»åŠ å›¾æ ‡ */
        .context-menu .ai-explain-option {
            display: flex;
            align-items: center;
            gap: 8px; /* å›¾æ ‡å’Œæ–‡å­—çš„é—´è· */
        }

        .context-menu .ai-explain-option::before {
            content: 'ğŸ¤–'; /* AIå°æœºå™¨äººå›¾æ ‡ */
            font-size: 14px;
        }   
        .ai-explanation { position: relative; background-color: #f0f4f8; border: 1px solid #d1d9e6; border-radius: 12px; padding: 12px 16px; margin-top: 8px; font-size: 0.85em; color: #334; line-height: 1.5; animation: fadeInUp 0.4s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.05); max-width: 75%; box-sizing: border-box; align-self: flex-start; }
        .message.self .ai-explanation { align-self: flex-end; }
        .ai-explanation::before { content: 'ğŸ¤– AI è§£é‡Š:'; font-weight: 600; color: #556; display: block; margin-bottom: 6px; font-size: 0.9em; }
        .ai-explanation p { margin: 0; }
        .ai-explanation-close { background: none; border: none; color: #889; font-size: 16px; cursor: pointer; width: 24px; height: 24px; line-height: 24px; text-align: center; border-radius: 50%; transition: all 0.2s ease; }
        .ai-explanation-close:hover { background-color: #e1e5e9; color: #333; }
        .ai-explanation-copy { background: none; border: none; color: #889; font-size: 16px; cursor: pointer; width: 24px; height: 24px; line-height: 24px; text-align: center; border-radius: 50%; transition: all 0.2s ease; margin-right: 5px; }
        .ai-explanation-copy:hover { background-color: #e1e5e9; color: #333; }
        .ai-explanation-buttons { position: absolute; top: 6px; right: 6px; display: flex; gap: 5px; }
        
        .ai-explanation .markdown-content { font-size: 0.9em; line-height: 1.6; text-align: left; }
        .ai-explanation .markdown-content p { margin-bottom: 12px; }
        .ai-explanation .markdown-content p:last-child { margin-bottom: 0; }
        .ai-explanation .markdown-content h1, .ai-explanation .markdown-content h2, .ai-explanation .markdown-content h3 { margin-top: 16px; margin-bottom: 8px; border-bottom: 1px solid #d1d9e6; padding-bottom: 4px; }
        .ai-explanation .markdown-content pre { background-color: #2d2d2d; color: #f8f8f2; padding: 12px; border-radius: 8px; overflow-x: auto; font-family: 'Courier New', Courier, monospace; font-size: 0.85em; }
        .ai-explanation .markdown-content code { background-color: #e8e8e8; padding: 2px 5px; border-radius: 4px; font-family: 'Courier New', Courier, monospace; }
        .ai-explanation .markdown-content pre code { background-color: transparent; padding: 0; }
        .ai-explanation .markdown-content ul, .ai-explanation .markdown-content ol { padding-left: 20px; margin-top: 8px; margin-bottom: 12px; }
        .ai-explanation .markdown-content blockquote { border-left: 4px solid #b0c4de; padding-left: 12px; margin: 12px 0; color: #556; background-color: #f9f9f9; }
        .ai-explanation .markdown-content a { color: #007bff; text-decoration: none; }
        .ai-explanation .markdown-content a:hover { text-decoration: underline; }

        .loading-dots {
            display: inline-block;
            width: 1.5em;
            text-align: left;
        }
        .loading-dots::after {
            content: '.';
            animation: dots 1s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { color: rgba(0,0,0,0); text-shadow:
                .25em 0 0 rgba(0,0,0,0),
                .5em 0 0 rgba(0,0,0,0); }
            40% { color: black; text-shadow:
                .25em 0 0 rgba(0,0,0,0),
                .5em 0 0 rgba(0,0,0,0); }
            60% { text-shadow:
                .25em 0 0 black,
                .5em 0 0 rgba(0,0,0,0); }
            80%, 100% { text-shadow:
                .25em 0 0 black,
                .5em 0 0 black; }
        }

        /* --- RESPONSIVE --- */
        @media (max-width: 768px) {
            html, body { 
                height: 100%; /* ä½¿ç”¨å›ºå®šé«˜åº¦ */
                overflow: hidden; /* é˜²æ­¢æ•´é¡µæ»šåŠ¨ */
                position: fixed; /* å›ºå®šæ•´ä¸ªé¡µé¢ */
                width: 100%; /* ç¡®ä¿å®½åº¦100% */
                top: 0;
                left: 0;
            }
            .chat-container { 
                width: 100%; 
                height: 100%; 
                max-width: 100%; /* è¦†ç›–æ¡Œé¢ç«¯çš„ max-width */
                border-radius: 0;
                box-shadow: none;
                position: absolute; /* å›ºå®šèŠå¤©å®¹å™¨ */
                top: 0;
                left: 0;
                display: flex;
                flex-direction: column; /* ç§»åŠ¨ç«¯æ”¹ä¸ºåˆ—å¸ƒå±€ */
            }
            .main-chat {
                flex: 1;
                width: 100%;
                position: relative;
                overflow: hidden; /* é˜²æ­¢å®¹å™¨å¤–æº¢å‡º */
                display: flex;
                flex-direction: column;
            }
            #chat-window {
                flex: 1;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch; /* å…³é”®å±æ€§ */
                position: relative;
                z-index: 1; /* ç¡®ä¿æ»šåŠ¨åŒºåŸŸåœ¨é¡¶éƒ¨ */
            }
            .sidebar { 
                position: fixed; 
                left: -280px; 
                top: 0; 
                height: 100%; 
                z-index: 1000; 
                transition: left 0.3s ease; 
            }
            .sidebar.open { left: 0; }
            .sidebar-toggle { display: flex; }
            .chat-header { padding: 10px 15px; }
            .chat-info { gap: 10px; }
            .room-icon { width: 28px; height: 28px; font-size: 14px; }
            .room-name { font-size: 1em; }
            .user-status { font-size: 0.75em; }
            .online-users-display { margin-left: auto; font-size: 0.75em; padding: 4px 8px; }
            #message-form { 
                padding: 12px 15px; 
                padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
                position: relative;
                z-index: 2; /* ç¡®ä¿è¾“å…¥åŒºåŸŸåœ¨é¡¶éƒ¨ */
            }
            #message-input { padding: 10px 40px 10px 15px; font-size: 16px; }
            .users-menu { right: 15px; }
            .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; }
            .overlay.show { display: block; }
            .user-row { flex-direction: column; align-items: stretch; gap: 12px; }
            .user-names, .user-info { flex: none; width: 100%; }
            .message-image { max-width: 250px; }
        }
            .header-users {
                display: none;
            }

        /* è°ƒè¯•æ—¥å¿—æ ·å¼ */
        .debug-log-container {
            padding: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.2);
            max-height: 950px;
            overflow-y: auto;
        }

        .debug-log-content {
            font-family: 'Courier New', monospace;
            font-size: 0.75em;
            color: #e0e0e0;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 920px;
            overflow-y: auto;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 10px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .debug-log-content:empty::before {
            content: "æš‚æ— æ—¥å¿—æ•°æ®";
            color: rgba(255,255,255,0.5);
            font-style: italic;
        }

        .debug-log-entry {
            margin-bottom: 5px;
            padding: 2px 5px;
            border-radius: 3px;
            animation: fadeIn 0.3s ease;
        }

        .debug-log-entry.info { color: #90caf9; border-left: 3px solid #90caf9; }
        .debug-log-entry.success { color: #a5d6a7; border-left: 3px solid #a5d6a7; }
        .debug-log-entry.warning { color: #ffcc80; border-left: 3px solid #ffcc80; }
        .debug-log-entry.error { color: #ef9a9a; border-left: 3px solid #ef9a9a; }

        .debug-controls {
            display: inline-flex;
            gap: 5px;
            float: right;
        }

        .debug-controls button {
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 4px;
            margin-right: 8px; 
            color: white;
            width: 24px;
            height: 24px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .debug-controls button:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.05);
        }

        .copy-feedback {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(102, 126, 234, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9em;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .copy-feedback.show {
            opacity: 1;
        }

        .log-timestamp {
            color: rgba(255,255,255,0.5);
            margin-right: 5px;
            font-size: 0.85em;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="overlay" id="overlay"></div>
        
        <div class="image-modal" id="image-modal">
            <button class="image-modal-close" id="modal-close">Ã—</button>
            <img id="modal-image" src="" alt="Preview">
        </div>
        
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2><span class="online-indicator"></span> æ´»è·ƒç”¨æˆ·</h2>
            </div>
            <div class="user-list-container">
                <div class="user-list-title">ç”¨æˆ· & æˆ¿é—´ä¿¡æ¯</div>
                <div class="user-row">
                    <div class="user-names" id="user-names"></div>
                    <div class="user-info">
                        <div class="info-row">
                            <span class="info-label">æ´»è·ƒ</span>
                            <span class="info-value online-count" id="online-count">0</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æˆ¿é—´</span>
                            <span class="info-value room-name-sidebar" id="sidebar-room-name">--</span>
                        </div>
                    </div>
                </div>
                <ul id="user-list" style="display: none;"></ul>
            </div>
            <div class="user-stats-container">
                <div class="user-list-title">ç”¨æˆ·æ´»åŠ¨ç»Ÿè®¡</div>
                <div id="user-stats-list"></div>
            </div>
            <div class="debug-log-container">
                <div class="user-list-title">è°ƒè¯•æ—¥å¿—
                    <div class="debug-controls">
                        <button id="clear-logs-btn" title="æ¸…ç©ºæ—¥å¿—">ğŸ—‘ï¸</button>
                        <button id="copy-logs-btn" title="å¤åˆ¶å…¨éƒ¨æ—¥å¿—">ğŸ“‹</button>
                        <button id="toggle-logs-btn" title="æ˜¾ç¤º/éšè—æ—¥å¿—">ğŸ‘ï¸</button>
                    </div>
                </div>
                <div id="debug-log-content" class="debug-log-content"></div>
            </div>
        </aside>

        <main class="main-chat">
            <header class="chat-header">
                <button class="sidebar-toggle" id="sidebar-toggle">â˜°</button>
                <div class="chat-info">
                    <div class="room-icon">ğŸ’¬</div>
                    <div class="chat-details">
                        <h1 class="room-name" id="room-name">Room: test</h1>
                        <p class="user-status">
                            <span class="connection-dot" id="connection-dot"></span>
                            <span id="status">æ­£åœ¨è¿æ¥...</span>
                            <span id="username-display" title="ç‚¹å‡»ä¿®æ”¹ç”¨æˆ·å"></span>
                        </p>
                    </div>
                </div>
                <div class="online-users-display" id="online-users-display">æ´»è·ƒ: 0</div>
                <div class="users-menu" id="users-menu">
                    <ul id="users-menu-list"></ul>
                </div>
            </header>

            <div id="chat-window"></div>

            <form id="message-form">
                <button type="button" class="icon-btn" id="attachment-btn">ğŸ“</button>
                <input type="file" id="image-input" accept="image/*">
                <div class="input-wrapper">
                    <div class="image-preview" id="image-preview">
                        <div class="upload-progress" id="upload-progress" style="display: none;"></div>
                        <div class="preview-content">
                            <img class="preview-image" id="preview-image" src="" alt="Preview">
                            <div class="preview-info">
                                <div class="preview-name" id="preview-name"></div>
                                <div class="preview-size" id="preview-size"></div>
                            </div>
                            <button type="button" class="preview-remove" id="preview-remove">Ã—</button>
                        </div>
                    </div>
                    <textarea id="message-input" placeholder="è¯·è¾“å…¥..." rows="1"></textarea>
                </div>
                <button type="button" class="icon-btn" id="record-button">ğŸ¤</button>
                <button id="send-button" type="submit" disabled>å‘é€</button>
            </form>
        </main>
    </div>

<div id="context-menu" class="context-menu">
    <ul>
        <li class="ai-explain-option" data-ai="gemini" data-action="text-explain">é—®Gemini</li>
        <li class="ai-explain-option" data-ai="deepseek" data-action="text-explain">DeepSeek</li>
        <li class="ai-explain-option" data-ai="gemini" data-action="image-describe">é—®Gemini (å›¾ç‰‡)</li>
        <li id="copy-option">ğŸ“ å¤ åˆ¶</li>
        <li id="delete-option">âŒ åˆ  é™¤</li>
    </ul>
</div>
<div id="call-controls-container"></div>
<div id="remote-audio-container"></div>

<script type="module">
    // --- DOM Elements ---
const sidebarToggle = document.getElementById('sidebar-toggle');
const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('overlay');
const onlineDisplay = document.getElementById('online-users-display');
const usersMenu = document.getElementById('users-menu');
const attachmentBtn = document.getElementById('attachment-btn');
const imageInput = document.getElementById('image-input');
const imagePreview = document.getElementById('image-preview');
const previewImage = document.getElementById('preview-image');
const previewName = document.getElementById('preview-name');
const previewSize = document.getElementById('preview-size');
const previewRemove = document.getElementById('preview-remove');
const uploadProgress = document.getElementById('upload-progress');
const imageModal = document.getElementById('image-modal');
const modalImage = document.getElementById('modal-image');
const modalClose = document.getElementById('modal-close');
const recordButton = document.getElementById('record-button');
const messageInput = document.getElementById('message-input');
const roomNameEl = document.getElementById('room-name');
const statusEl = document.getElementById('status');
const usernameDisplayEl = document.getElementById('username-display');
const connectionDot = document.getElementById('connection-dot');
const chatWindowEl = document.getElementById('chat-window');
const messageForm = document.getElementById('message-form');
const sendButton = document.getElementById('send-button');
const contextMenu = document.getElementById('context-menu');
const copyOption = document.getElementById('copy-option');
const deleteOption = document.getElementById('delete-option');
const callControlsContainer = document.getElementById('call-controls-container');
const remoteAudioContainer = document.getElementById('remote-audio-container');
const debugLogContent = document.getElementById('debug-log-content');
const clearLogsBtn = document.getElementById('clear-logs-btn');
const copyLogsBtn = document.getElementById('copy-logs-btn');
const toggleLogsBtn = document.getElementById('toggle-logs-btn');


// --- å…¨å±€çŠ¶æ€å˜é‡ ---
let allMessages = [];
let selectedFile = null;
let mediaRecorder;
let audioChunks = [];
let isRecording = false;
let currentMessageElement = null; // ç”¨äºå­˜å‚¨å½“å‰å³é”®ç‚¹å‡»çš„æ¶ˆæ¯å…ƒç´ 
let socket;
let reconnectInterval = 1000;
const maxReconnectInterval = 30000;
let localStream = null;
const peerConnections = {};
const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

// --- æ—¥å¿—åŠŸèƒ½å˜é‡ ---
const LOG_LEVELS = { INFO: 'info', SUCCESS: 'success', WARNING: 'warning', ERROR: 'error' };
const MAX_LOG_ENTRIES = 100;
let isDebugEnabled = true; // æ§åˆ¶æ˜¯å¦åœ¨DOMä¸­æ˜¾ç¤ºè°ƒè¯•æ—¥å¿—


// --- åˆå§‹åŒ–ç”¨æˆ·å’Œæˆ¿é—´ä¿¡æ¯ ---
let username = localStorage.getItem('chat_username');
if (!username) {
    username = prompt("è¯·è¾“å…¥æ‚¨çš„å§“å:") || "åŒ¿åç”¨æˆ·";
    localStorage.setItem('chat_username', username);
}
const pathParts = window.location.pathname.split('/');
const roomName = pathParts.find(p => p.trim()) || 'general';


// --- å·¥å…·å‡½æ•° ---
function escapeHTML(str) {
    if (typeof str !== 'string') return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
    };
    return str.replace(/[&<>"']/g, m => map[m]);
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return `${parseFloat((bytes / Math.pow(k, i)).toFixed(2))} ${sizes[i]}`;
}

// èŠ‚æµå‡½æ•°
function throttle(func, delay) {
    let timeoutId;
    let lastArgs;
    let lastThis;

    return function(...args) {
        lastArgs = args;
        lastThis = this;

        if (!timeoutId) {
            timeoutId = setTimeout(() => {
                func.apply(lastThis, lastArgs);
                timeoutId = null;
                lastArgs = null;
                lastThis = null;
            }, delay);
        }
    };
}


// --- è°ƒè¯•æ—¥å¿—ç³»ç»Ÿ (ä¼˜åŒ–ç‰ˆ) ---
function logDebug(message, level = LOG_LEVELS.INFO, data = null) {
    // æ€»æ˜¯è®°å½•åˆ°æ§åˆ¶å°ï¼Œè¿™å¯¹è°ƒè¯•å¾ˆé‡è¦
    const consoleMethod = level === LOG_LEVELS.ERROR ? 'error' : 
                          level === LOG_LEVELS.WARNING ? 'warn' : 'log';
    
    if (data) {
        console[consoleMethod](`[${level.toUpperCase()}] ${message}`, data);
    } else {
        console[consoleMethod](`[${level.toUpperCase()}] ${message}`);
    }
    
    // å¦‚æœè°ƒè¯•æ—¥å¿—è¢«ç¦ç”¨æˆ–å®¹å™¨ä¸å­˜åœ¨ï¼Œå°±ä¸è¿›è¡ŒDOMæ“ä½œ
    if (!isDebugEnabled || !debugLogContent) return;
    
    // ä½¿ç”¨DocumentFragmentå‡å°‘DOMæ“ä½œ
    const fragment = document.createDocumentFragment();
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = document.createElement('div');
    logEntry.className = `debug-log-entry ${level}`;
    
    let messageHTML = `<span class="log-timestamp">[${timestamp}]</span> <span>${message}</span>`;
    
    if (data) {
        // å¯¹äºå¤§å‹æ•°æ®ï¼Œé™åˆ¶æ˜¾ç¤ºé•¿åº¦
        let dataString;
        try {
            if (typeof data === 'object' && data !== null) {
                // é™åˆ¶æ•°æ®å¤§å°ï¼Œé¿å…JSON.stringifyå ç”¨è¿‡å¤šèµ„æº
                const limitedData = JSON.parse(JSON.stringify(data, (k, v) => {
                    if (typeof v === 'string' && v.length > 500) {
                        return v.substring(0, 500) + '... [æˆªæ–­]';
                    }
                    return v;
                }));
                dataString = JSON.stringify(limitedData, null, 2);
            } else {
                dataString = String(data);
            }
        } catch (e) {
            dataString = `[æ— æ³•åºåˆ—åŒ–çš„æ•°æ®: ${e.message}]`;
        }
        
        if (dataString.length > 1000) {
            dataString = dataString.substring(0, 1000) + '... [æ•°æ®è¿‡å¤§ï¼Œå·²æˆªæ–­]';
        }
        
        messageHTML += `<pre style="white-space: pre-wrap; word-break: break-all; margin-top: 5px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 4px;">${escapeHTML(dataString)}</pre>`;
    }
    
    logEntry.innerHTML = messageHTML;
    fragment.appendChild(logEntry);
    debugLogContent.appendChild(fragment);
    
    // ä¿æŒæ—¥å¿—æ¡ç›®æ•°é‡åœ¨é™åˆ¶èŒƒå›´å†…
    while (debugLogContent.children.length > MAX_LOG_ENTRIES) {
        debugLogContent.removeChild(debugLogContent.firstChild);
    }
    
    // ä½¿ç”¨requestAnimationFrameä¼˜åŒ–æ»šåŠ¨æ“ä½œ
    requestAnimationFrame(() => {
        debugLogContent.scrollTop = debugLogContent.scrollHeight;
    });
}

function initDebugLog() {
    if (clearLogsBtn) clearLogsBtn.addEventListener('click', clearLogs);
    if (copyLogsBtn) copyLogsBtn.addEventListener('click', copyLogs);
    if (toggleLogsBtn) toggleLogsBtn.addEventListener('click', toggleLogsDisplay); // ç»‘å®šåˆ°æ–°çš„åˆ‡æ¢å‡½æ•°
    logDebug('è°ƒè¯•æ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ', LOG_LEVELS.SUCCESS);
    logDebug(`å½“å‰ç”¨æˆ·: ${username}`, LOG_LEVELS.INFO);
    logDebug(`å½“å‰æˆ¿é—´: ${roomName}`, LOG_LEVELS.INFO);
}

function clearLogs() {
    debugLogContent.innerHTML = '';
    logDebug('æ—¥å¿—å·²æ¸…ç©º', LOG_LEVELS.INFO);
}

function copyLogs() {
    const logText = Array.from(debugLogContent.children).map(entry => entry.textContent).join('\n');
    navigator.clipboard.writeText(logText).then(() => {
        showCopyFeedback('æ—¥å¿—å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        logDebug('æ—¥å¿—å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', LOG_LEVELS.SUCCESS);
    }).catch(err => logDebug(`å¤åˆ¶å¤±è´¥: ${err}`, LOG_LEVELS.ERROR));
}

// æ–°å¢ï¼šåˆ‡æ¢è°ƒè¯•æ—¥å¿—åœ¨DOMä¸­çš„æ˜¾ç¤ºçŠ¶æ€
function toggleLogsDisplay() {
    isDebugEnabled = !isDebugEnabled; // åˆ‡æ¢å…¨å±€æ ‡å¿—
    if (debugLogContent) {
        debugLogContent.style.display = isDebugEnabled ? '' : 'none';
    }
    logDebug(`è°ƒè¯•æ—¥å¿—æ˜¾ç¤ºå·²${isDebugEnabled ? 'å¼€å¯' : 'éšè—'}`, LOG_LEVELS.INFO);
}

function showCopyFeedback(message) {
    let feedback = document.querySelector('.copy-feedback');
    if (!feedback) {
        feedback = document.createElement('div');
        feedback.className = 'copy-feedback';
        document.body.appendChild(feedback);
    }
    feedback.textContent = message;
    feedback.classList.add('show');
    setTimeout(() => feedback.classList.remove('show'), 2000);
}


// --- UI æ¸²æŸ“å’Œæ›´æ–°é€»è¾‘ ---
// åˆ›å»ºä¸€ä¸ªèŠ‚æµç‰ˆæœ¬çš„updateUIFromMessageså‡½æ•°ï¼Œé™åˆ¶æ›´æ–°é¢‘ç‡
const throttledUpdateUI = throttle(updateUIFromMessages, 1000); // 1ç§’å†…æœ€å¤šæ›´æ–°ä¸€æ¬¡UI

// åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æ´»è·ƒçš„è¾…åŠ©å‡½æ•°
function isUserActive(lastSeenTimestamp) {
    if (!lastSeenTimestamp) return false;
    const fiveMinutesInMs = 5 * 60 * 1000;
    const fiveMinutesAgo = Date.now() - fiveMinutesInMs;
    return new Date(lastSeenTimestamp).getTime() > fiveMinutesAgo;
}

// ä¼˜åŒ– updateUIFromMessages å‡½æ•°ï¼Œä½¿å…¶ä¸å†é¢‘ç¹åœ°é‡ç½® innerHTML
function updateUIFromMessages() {
    // logDebug('æ­£åœ¨ä» allMessages æ•°ç»„æ›´æ–°UIç•Œé¢ (ä¼˜åŒ–ç‰ˆ)...', LOG_LEVELS.INFO); // é¿å…è¿‡äºé¢‘ç¹çš„æ—¥å¿—

    const currentUserStates = new Map(); // { username: { lastSeen, messageCount, isActive } }
    const activeUsersSet = new Set();

    // åªå¤„ç†æœ€è¿‘çš„500æ¡æ¶ˆæ¯æ¥æé«˜æ€§èƒ½ (ä¸åç«¯åŒæ­¥)
    const recentMessages = allMessages.slice(-500); 
    
    recentMessages.forEach(msg => {
        const { username, timestamp } = msg;
        if (!username) return; // è·³è¿‡æ— æ•ˆç”¨æˆ·

        const currentState = currentUserStates.get(username) || { lastSeen: 0, messageCount: 0 };
        currentState.lastSeen = Math.max(currentState.lastSeen, timestamp);
        currentState.messageCount++;
        currentUserStates.set(username, currentState);
    });

    // ç¡®å®šæ´»è·ƒç”¨æˆ·å’Œæ›´æ–°æ´»è·ƒçŠ¶æ€
    currentUserStates.forEach((state, username) => {
        state.isActive = isUserActive(state.lastSeen);
        if (state.isActive) {
            activeUsersSet.add(username);
        }
    });

    const sortedActiveUsernames = Array.from(activeUsersSet).sort((a, b) => a.localeCompare(b));

    // --- æ›´æ–°ç”¨æˆ·æ˜µç§°åˆ—è¡¨ (`#user-names`) å’Œèœå• (`#users-menu-list`) ---
    const userNamesEl = document.getElementById('user-names');
    const menuListEl = document.getElementById('users-menu-list');

    // ç§»é™¤å·²ç¦»å¼€çš„ç”¨æˆ·ï¼šéå†å½“å‰DOMä¸­çš„ç”¨æˆ·ï¼Œå¦‚æœä¸åœ¨æ´»è·ƒåˆ—è¡¨ä¸­ï¼Œå°±ç§»é™¤
    Array.from(userNamesEl.children).forEach(el => {
        const name = el.dataset.username; // è·å–å­˜å‚¨åœ¨ dataset ä¸­çš„ç”¨æˆ·å
        if (name && !activeUsersSet.has(name)) {
            el.remove();
            menuListEl.querySelector(`li[data-username="${escapeHTML(name)}"]`)?.remove();
        }
    });

    // æ·»åŠ æ–°ç”¨æˆ·å’Œæ›´æ–°ç°æœ‰ç”¨æˆ·ï¼šéå†æ´»è·ƒåˆ—è¡¨
    sortedActiveUsernames.forEach(name => {
        const safeName = escapeHTML(name);
        // å¦‚æœDOMä¸­ä¸å­˜åœ¨è¯¥ç”¨æˆ·ï¼Œåˆ™åˆ›å»ºå¹¶æ·»åŠ 
        if (!userNamesEl.querySelector(`.user-item[data-username="${safeName}"]`)) {
            // æ·»åŠ åˆ°ä¾§è¾¹æ ç”¨æˆ·åˆ—è¡¨
            const userItem = document.createElement('div');
            userItem.className = 'user-item';
            userItem.textContent = safeName;
            userItem.dataset.username = safeName; // å­˜å‚¨ç”¨æˆ·åä¾¿äºæŸ¥æ‰¾å’Œåˆ é™¤
            userNamesEl.appendChild(userItem); // ç›´æ¥appendï¼Œæµè§ˆå™¨ä¼šä¼˜åŒ–å°‘é‡DOMæ“ä½œ

            // æ·»åŠ åˆ°å¤´éƒ¨èœå•åˆ—è¡¨
            const menuItem = document.createElement('li');
            menuItem.dataset.username = safeName; // å­˜å‚¨ç”¨æˆ·å
            if (name === username) {
                menuItem.textContent = `${safeName} (ä½ )`;
            } else {
                menuItem.className = 'user-menu-item-with-call';
                const nameSpan = document.createElement('span');
                nameSpan.textContent = safeName;
                menuItem.appendChild(nameSpan);
                const callBtn = document.createElement('button');
                callBtn.className = 'call-btn';
                callBtn.textContent = 'ğŸ“';
                callBtn.dataset.username = safeName;
                // æ³¨æ„ï¼šè¿™é‡ŒcallBtnçš„ç‚¹å‡»äº‹ä»¶æ— éœ€å§”æ‰˜ï¼Œå› ä¸ºå®ƒæ˜¯éšèœå•é¡¹åˆ›å»ºå¹¶æ·»åŠ åˆ°DOMçš„
                callBtn.onclick = (e) => {
                    e.stopPropagation();
                    startCall(callBtn.dataset.username);
                    usersMenu.classList.remove('show');
                };
                menuItem.appendChild(callBtn);
            }
            menuListEl.appendChild(menuItem);
        }
        // å¯¹äºå·²å­˜åœ¨çš„ç”¨æˆ·ï¼Œå¦‚æœéœ€è¦ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ›´æ–°ä»–ä»¬çš„çŠ¶æ€æˆ–æ ·å¼
    });

    // --- æ›´æ–°æ´»è·ƒç”¨æˆ·è®¡æ•° ---
    document.getElementById('online-count').textContent = sortedActiveUsernames.length;
    onlineDisplay.textContent = `æ´»è·ƒ: ${sortedActiveUsernames.length}`;
    document.getElementById('sidebar-room-name').textContent = roomName; // ç¡®ä¿æˆ¿é—´åå§‹ç»ˆæ˜¾ç¤º

    // --- æ›´æ–°ç”¨æˆ·æ´»åŠ¨ç»Ÿè®¡ (`#user-stats-list`) ---
    const userStatsListEl = document.getElementById('user-stats-list');
    const allUsersSorted = Array.from(currentUserStates.keys()).sort((a, b) => {
        const aState = currentUserStates.get(a);
        const bState = currentUserStates.get(b);
        if (aState.isActive !== bState.isActive) return bState.isActive - aState.isActive; // æ´»è·ƒçš„åœ¨å‰
        return (bState.messageCount || 0) - (aState.messageCount || 0); // æ¶ˆæ¯å¤šçš„åœ¨å‰
    });

    // è¿™é‡Œå¯ä»¥é‡‡ç”¨æ›´ç»†è‡´çš„æ›´æ–°ç­–ç•¥ï¼Œä½†å¦‚æœç”¨æˆ·ç»Ÿè®¡æ•°é‡æœ‰é™ï¼ŒinnerHTMLæ¸…ç©ºé‡ç»˜å¼€é”€å¯æ¥å—
    // æš‚æ—¶ä¿æŒæ¸…ç©ºé‡ç»˜ï¼Œå› ä¸ºå®ƒåœ¨ä¾§è¾¹æ åº•éƒ¨ï¼Œä¸”æ›´æ–°é¢‘ç‡é™ä½
    const statsFragment = document.createDocumentFragment();
    if (allUsersSorted.length === 0) {
        const emptyMsg = document.createElement('p');
        emptyMsg.style.color = 'rgba(255,255,255,0.7)';
        emptyMsg.style.fontSize = '0.8em';
        emptyMsg.textContent = 'æš‚æ— ç”¨æˆ·æ´»åŠ¨ã€‚';
        statsFragment.appendChild(emptyMsg);
    } else {
        allUsersSorted.forEach(name => {
            const state = currentUserStates.get(name);
            if (!state) return; // Should not happen

            const item = document.createElement('div');
            item.className = 'user-stats-item';
            const isActive = state.isActive;
            const lastSeenString = state.lastSeen ? new Date(state.lastSeen).toLocaleString() : 'æœªçŸ¥';
            
            item.innerHTML = `
                <div class="stat-row">
                    <strong>${escapeHTML(name)}</strong>
                    <span class="${isActive ? 'online-status' : 'offline-status'}">${isActive ? 'æ´»è·ƒ' : 'ç¦»çº¿'}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">å‘è¨€:</span>
                    <span class="stat-value">${state.messageCount}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">æœ€è¿‘å‘è¨€:</span>
                    <span class="stat-value">${lastSeenString}</span>
                </div>`;
            statsFragment.appendChild(item);
        });
    }
    userStatsListEl.innerHTML = ''; // æ¸…ç©ºæ—§å†…å®¹
    userStatsListEl.appendChild(statsFragment); // æ‰¹é‡æ·»åŠ æ–°å†…å®¹
}


// --- æ¶ˆæ¯æ¸²æŸ“å‡½æ•° (ä¼˜åŒ–ç‰ˆ) ---
function appendChatMessage(msg) {
    try {
        if (!chatWindowEl) {
            logDebug("è‡´å‘½é”™è¯¯ï¼šchatWindowEl å˜é‡æ˜¯ null æˆ– undefinedï¼", 'error');
            return;
        }
        if (!msg || !msg.id) {
            logDebug("è‡´å‘½é”™è¯¯ï¼šä¼ å…¥çš„ msg å¯¹è±¡æ— æ•ˆæˆ–ç¼ºå°‘IDï¼", 'error', msg);
            return;
        }
        
        // ä½¿ç”¨æ–‡æ¡£ç‰‡æ®µæé«˜æ€§èƒ½
        const fragment = document.createDocumentFragment();
        const msgEl = document.createElement('div');
        msgEl.className = 'message';
        
        // ç¡®ä¿æ‰€æœ‰ç›¸å…³æ•°æ®éƒ½å­˜å…¥dataset
        msgEl.dataset.id = msg.id;
        // ä¼˜å…ˆä½¿ç”¨ caption ä½œä¸º messageTextï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ text
        msgEl.dataset.messageText = msg.caption || msg.text || ''; 
        msgEl.dataset.timestamp = msg.timestamp;
        msgEl.dataset.messageType = msg.type;
        if (msg.type === 'image') {
            msgEl.dataset.imageUrl = msg.imageUrl; // å›¾ç‰‡æ¶ˆæ¯éœ€è¦å­˜å‚¨URL
        }

        if (msg.username === username) msgEl.classList.add('self');
        
        const messageDate = new Date(msg.timestamp);
        const now = new Date();
        const diffSeconds = Math.floor((now - messageDate) / 1000);
        let displayTime;
        if (diffSeconds < 60) displayTime = 'åˆšåˆš';
        else if (diffSeconds < 3600) displayTime = `${Math.floor(diffSeconds / 60)}åˆ†é’Ÿå‰`;
        else if (diffSeconds < 86400) displayTime = `${Math.floor(diffSeconds / 3600)}å°æ—¶å‰`;
        else displayTime = messageDate.toLocaleString([], { year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        
        let contentHTML = `<div class="info"><span class="username">${escapeHTML(msg.username)}</span> <span class="timestamp">${displayTime}</span></div>`;
            
        // æ¶ˆæ¯å†…å®¹æ¸²æŸ“
        if (msg.type === 'image') {
            contentHTML += `<div class="message-image" onclick="showImageModal('${msg.imageUrl}')"><img src="${msg.imageUrl}" alt="${escapeHTML(msg.filename || 'Image')}" loading="lazy"></div>`;
            // æ— è®º caption æ˜¯å¦ä¸ºç©ºï¼Œéƒ½æ·»åŠ ä¸€ä¸ª .text div
            // marked.parse('') ä¼šè¿”å›ç©ºå­—ç¬¦ä¸²ï¼Œä¸ä¼šé€ æˆé—®é¢˜
            contentHTML += `<div class="text">${marked.parse(msg.caption || '')}</div>`; 
        } else if (msg.type === 'audio') {
            contentHTML += `<div class="message-audio"><audio controls src="${msg.audioUrl}"></audio></div>`;
            // æ— è®º text æ˜¯å¦ä¸ºç©ºï¼Œéƒ½æ·»åŠ ä¸€ä¸ª .text div
            contentHTML += `<div class="text">${marked.parse(msg.text || '')}</div>`; 
        } else { // text (åŠå…¶ä»–æœªå®šä¹‰çš„ç±»å‹ï¼Œä¼š fallbackåˆ°textå¤„ç†)
            // ç¡®ä¿ text å­—æ®µå§‹ç»ˆè¢«å¤„ç†ï¼Œå³ä½¿ä¸ºç©ºå­—ç¬¦ä¸²
            contentHTML += `<div class="text">${marked.parse(msg.text || '')}</div>`;
        }
            
        msgEl.innerHTML = contentHTML;
        fragment.appendChild(msgEl);
        
        // åªæœ‰å½“æ¥è¿‘åº•éƒ¨æ—¶æ‰è‡ªåŠ¨æ»šåŠ¨
        const isNearBottom = chatWindowEl.scrollHeight - chatWindowEl.clientHeight <= chatWindowEl.scrollTop + 50; // 50pxç¼“å†²
        chatWindowEl.appendChild(fragment); // æ‰¹é‡æ·»åŠ DOM
        
        if (isNearBottom) {
            // ä½¿ç”¨requestAnimationFrameç¡®ä¿æ»šåŠ¨å‘ç”Ÿåœ¨ä¸‹ä¸€æ¬¡é‡ç»˜ï¼Œé¿å…å¼ºåˆ¶åŒæ­¥å¸ƒå±€
            requestAnimationFrame(() => {
                chatWindowEl.scrollTop = chatWindowEl.scrollHeight;
            });
        }
    } catch (e) {
        logDebug(`appendChatMessage å‡½æ•°å‡ºç°é¡¶çº§é”™è¯¯: ${e.message}`, 'error', { error: e.toString(), stack: e.stack, originalMessage: msg });
    }
}


// --- ä¸Šä¸‹æ–‡èœå•å’Œ AI è§£é‡Šé€»è¾‘ ---
function showContextMenu(element, x, y) {
    currentMessageElement = element; // å°†å½“å‰å³é”®ç‚¹å‡»çš„æ¶ˆæ¯å…ƒç´ å­˜ä¸ºå…¨å±€å˜é‡
    
    // å®šä½èœå•
    contextMenu.style.top = `${y}px`;
    contextMenu.style.left = `${x}px`;
    contextMenu.style.display = 'block';

    const messageType = element.dataset.messageType;
    const isSelf = element.classList.contains('self'); // åˆ¤æ–­æ˜¯å¦æ˜¯è‡ªå·±å‘çš„æ¶ˆæ¯

    // è·å–æ‰€æœ‰èœå•é¡¹
    const geminiTextOption = contextMenu.querySelector('[data-ai="gemini"][data-action="text-explain"]');
    const deepseekTextOption = contextMenu.querySelector('[data-ai="deepseek"][data-action="text-explain"]');
    const geminiImageOption = contextMenu.querySelector('[data-ai="gemini"][data-action="image-describe"]');
    const copyOption = document.getElementById('copy-option');
    const deleteOption = document.getElementById('delete-option');

    // --- æ ¹æ®æ¶ˆæ¯ç±»å‹åŠ¨æ€æ˜¾ç¤º/éšè—èœå•é¡¹ ---

    // é»˜è®¤å…ˆéšè—æ‰€æœ‰ç‰¹å®šåŠŸèƒ½çš„èœå•é¡¹
    geminiTextOption.style.display = 'none';
    deepseekTextOption.style.display = 'none';
    geminiImageOption.style.display = 'none';
    copyOption.style.display = 'none';
    
    // æ ¹æ®ç±»å‹å†³å®šæ˜¾ç¤ºå“ªäº›
    if (messageType === 'image') {
        geminiImageOption.style.display = 'flex'; // æ˜¾ç¤ºå›¾ç‰‡è§£é‡Š
    } else if (messageType === 'text') {
        geminiTextOption.style.display = 'flex'; // æ˜¾ç¤ºæ–‡æœ¬è§£é‡Š
        deepseekTextOption.style.display = 'flex';
        copyOption.style.display = 'flex';       // æ˜¾ç¤ºå¤åˆ¶
    }
    // å¯¹äºéŸ³é¢‘ç­‰å…¶ä»–ç±»å‹ï¼Œæ‰€æœ‰AIå’Œå¤åˆ¶åŠŸèƒ½éƒ½ä¿æŒéšè—

    // --- æ ¹æ®æ˜¯å¦ä¸ºè‡ªå·±çš„æ¶ˆæ¯ï¼Œå†³å®šæ˜¯å¦æ˜¾ç¤ºåˆ é™¤æŒ‰é’® ---
    deleteOption.style.display = isSelf ? 'flex' : 'none';
    
    if (navigator.vibrate) navigator.vibrate(50); // ç§»åŠ¨ç«¯éœ‡åŠ¨åé¦ˆ
}

contextMenu.addEventListener('click', async (e) => {
    const clickedOption = e.target;
    // ç¡®ä¿ç‚¹å‡»çš„æ˜¯èœå•é¡¹ï¼Œè€Œä¸æ˜¯èœå•èƒŒæ™¯æˆ–å…¶ä»–åœ°æ–¹
    if (!clickedOption.closest('li')) return; 

    const action = clickedOption.dataset.action;
    const model = clickedOption.dataset.ai;
    
    // è·å–åŸå§‹æ¶ˆæ¯å†…å®¹
    const originalMessageText = currentMessageElement?.dataset.messageText;
    const originalImageUrl = currentMessageElement?.dataset.imageUrl;
    const messageType = currentMessageElement?.dataset.messageType;

    // æ¸…é™¤å½“å‰çš„å³é”®èœå•
    contextMenu.style.display = 'none';

    // å¤„ç†å¤åˆ¶é€‰é¡¹
    if (clickedOption.id === 'copy-option') {
        if (originalMessageText) {
            navigator.clipboard.writeText(originalMessageText)
                .then(() => showCopyFeedback('æ–‡æœ¬å·²å¤åˆ¶!'))
                .catch(err => logDebug(`å¤åˆ¶å¤±è´¥: ${err}`, LOG_LEVELS.ERROR));
        }
        return; // å¤„ç†å®Œå¤åˆ¶å°±è¿”å›
    }

    // å¤„ç†åˆ é™¤é€‰é¡¹
    if (clickedOption.id === 'delete-option') {
        if (currentMessageElement?.dataset.id) {
            // å¯ä»¥åœ¨è¿™é‡ŒåŠ ä¸€ä¸ªç¡®è®¤å¼¹çª—
            if (confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ")) {
                socket.send(JSON.stringify({ type: 'delete', payload: { id: currentMessageElement.dataset.id } }));
                logDebug(`å‘é€åˆ é™¤æ¶ˆæ¯æŒ‡ä»¤: ${currentMessageElement.dataset.id}`, LOG_LEVELS.INFO);
            }
        }
        return; // å¤„ç†å®Œåˆ é™¤å°±è¿”å›
    }

    // å¤„ç†AIè§£é‡Š/æè¿°é€‰é¡¹
    let explanationText = "";
    let requestBody = {};
    let apiUrl = '';

    if (action === 'image-describe' && messageType === 'image') {
        if (!originalImageUrl) {
            logDebug("å›¾ç‰‡æè¿°ï¼šç¼ºå°‘å›¾ç‰‡URL", LOG_LEVELS.WARNING);
            return;
        }
        apiUrl = '/ai-describe-image';
        requestBody = { imageUrl: originalImageUrl };
        explanationText = "æ­£åœ¨é€šè¿‡AIæ¨¡å‹è§£è¯»å›¾ç‰‡...";
    } else if (action === 'text-explain' && messageType === 'text') {
        if (!originalMessageText) {
            logDebug("æ–‡æœ¬è§£é‡Šï¼šç¼ºå°‘æ–‡æœ¬å†…å®¹", LOG_LEVELS.WARNING);
            return;
        }
        apiUrl = '/ai-explain';
        requestBody = { text: originalMessageText, model: model };
        explanationText = `æ­£åœ¨é€šè¿‡ ${model} æ¨¡å‹æ€è€ƒä¸­...`;
    } else if (action === 'custom-prompt' && messageType === 'text') { // å¦‚æœéœ€è¦è‡ªå®šä¹‰æç¤ºè¯åŠŸèƒ½
        const customPrompt = prompt("è¯·è¾“å…¥æ‚¨çš„æç¤ºè¯:");
        if (!customPrompt || !originalMessageText) {
            logDebug("è‡ªå®šä¹‰æç¤ºè¯ï¼šç”¨æˆ·å–æ¶ˆæˆ–ç¼ºå°‘æ–‡æœ¬å†…å®¹", LOG_LEVELS.INFO);
            return;
        }
        apiUrl = '/ai-explain';
        requestBody = { text: `${originalMessageText}\n\n${customPrompt}`, model: 'gemini' }; // é»˜è®¤ä½¿ç”¨Geminiå¤„ç†è‡ªå®šä¹‰æç¤º
        explanationText = `æ­£åœ¨ä½¿ç”¨æ‚¨çš„è‡ªå®šä¹‰æç¤ºè¯é€šè¿‡ Gemini æ¨¡å‹æ€è€ƒä¸­...`;
    } else {
        // æœªçŸ¥æˆ–ä¸åŒ¹é…çš„ AI åŠ¨ä½œï¼Œæˆ–ç±»å‹ä¸ç¬¦ï¼Œç›´æ¥è¿”å›
        logDebug(`AIæ“ä½œå¤±è´¥ï¼šæœªçŸ¥åŠ¨ä½œæˆ–æ¶ˆæ¯ç±»å‹ä¸åŒ¹é…ã€‚Action: ${action}, Type: ${messageType}`, LOG_LEVELS.WARNING);
        return;
    }

    // åœ¨æ¶ˆæ¯ä¸‹æ–¹æ˜¾ç¤º AI è§£é‡Šå®¹å™¨
    const existingExplanation = currentMessageElement.querySelector('.ai-explanation');
    if (existingExplanation) {
        existingExplanation.remove();
    }
    
    const explanationEl = document.createElement('div');
    explanationEl.className = 'ai-explanation';
    explanationEl.innerHTML = `<p>ğŸ¤– ${explanationText}<span class="loading-dots"></span></p>`;
    currentMessageElement.appendChild(explanationEl);

    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(errorText); // æŠ›å‡ºåç«¯è¿”å›çš„é”™è¯¯ä¿¡æ¯
        }
        
        const data = await response.json();
        const explanationContent = data.explanation || data.description; // å…¼å®¹ä¸¤ç§ AI å“åº”
        
        explanationEl.innerHTML = ''; // æ¸…ç©ºåŠ è½½æç¤º
        const buttonContainer = document.createElement('div');
        buttonContainer.className = 'ai-explanation-buttons';

        const closeBtn = document.createElement('button');
        closeBtn.className = 'ai-explanation-close';
        closeBtn.innerHTML = 'Ã—';
        closeBtn.onclick = () => {
            explanationEl.remove();
            logDebug('AIè§£é‡Šå·²å…³é—­ã€‚', LOG_LEVELS.INFO);
        };

        const copyBtn = document.createElement('button');
        copyBtn.className = 'ai-explanation-copy';
        copyBtn.innerHTML = 'ğŸ“‹';
        copyBtn.title = 'å¤åˆ¶å†…å®¹';
        copyBtn.onclick = () => {
            navigator.clipboard.writeText(explanationContent)
                .then(() => showCopyFeedback('AIè§£é‡Šå·²å¤åˆ¶!'))
                .catch(err => logDebug(`AIè§£é‡Šå¤åˆ¶å¤±è´¥: ${err}`, LOG_LEVELS.ERROR));
        };

        buttonContainer.appendChild(copyBtn);
        buttonContainer.appendChild(closeBtn);

        const markdownContainer = document.createElement('div');
        markdownContainer.className = 'markdown-content';
        markdownContainer.innerHTML = marked.parse(explanationContent, { gfm: true, breaks: true, sanitize: true });
        
        explanationEl.appendChild(buttonContainer);
        explanationEl.appendChild(markdownContainer);
        logDebug(`AIè§£é‡ŠæˆåŠŸï¼Œæ¨¡å‹: ${model || 'å›¾ç‰‡æè¿°'}.`, LOG_LEVELS.SUCCESS);

    } catch (error) {
        logDebug(`è¯·æ±‚AIè§£é‡Šå¤±è´¥: ${error.message}`, LOG_LEVELS.ERROR, error);
        const errorModelName = (action === 'image-describe') ? 'AIå›¾ç‰‡æè¿°' : (model || 'æœªçŸ¥AIæ¨¡å‹');
        explanationEl.innerHTML = `<p>ğŸ˜ æŠ±æ­‰ï¼Œæ— æ³•ä» ${errorModelName} è·å–è§£é‡Š: ${escapeHTML(error.message)}</p>`;
        setTimeout(() => { if (explanationEl.parentNode) explanationEl.remove(); }, 6000); // é”™è¯¯ä¿¡æ¯æ˜¾ç¤º6ç§’åè‡ªåŠ¨æ¶ˆå¤±
    }
});


// --- å›¾ç‰‡å’Œåª’ä½“å¤„ç†å‡½æ•° ---
async function handleImageSelection(e) {
    const file = e.target.files[0];
    if (!file || !file.type.startsWith('image/')) return;
    try {
        uploadProgress.style.display = 'block';
        imagePreview.classList.add('show', 'uploading');
        const compressedBlob = await compressImage(file);
        selectedFile = new File([compressedBlob], file.name, { type: 'image/jpeg', lastModified: Date.now() });
        showImagePreview(selectedFile);
    } catch (error) {
        logDebug('å›¾ç‰‡å¤„ç†å¤±è´¥: ' + error, LOG_LEVELS.ERROR);
        alert('å›¾ç‰‡å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•');
    } finally {
        uploadProgress.style.display = 'none';
        imagePreview.classList.remove('uploading');
        checkSendButtonState();
    }
}

function compressImage(file, maxWidth = 800, maxHeight = 600, quality = 0.8) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
            let { width, height } = img;
            if (width > height) {
                if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
            } else {
                if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; }
            }
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            canvas.toBlob(resolve, 'image/jpeg', quality);
        };
        img.onerror = reject;
        img.src = URL.createObjectURL(file);
    });
}

function showImagePreview(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
        previewImage.src = e.target.result;
        previewName.textContent = file.name;
        previewSize.textContent = formatFileSize(file.size);
        imagePreview.classList.add('show');
    };
    reader.readAsDataURL(file);
}

function removeImagePreview() {
    selectedFile = null;
    imagePreview.classList.remove('show');
    imageInput.value = '';
    checkSendButtonState();
}

async function handleRecordButtonClick() {
    if (isRecording) {
        mediaRecorder.stop();
        return;
    }
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const mimeType = ['audio/mp4', 'audio/webm;codecs=opus', 'audio/webm'].find(t => MediaRecorder.isTypeSupported(t));
        if (!mimeType) {
            alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒå½•éŸ³åŠŸèƒ½ã€‚');
            return;
        }
        mediaRecorder = new MediaRecorder(stream, { mimeType });
        audioChunks = [];
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstart = () => {
            recordButton.textContent = 'ğŸ›‘';
            isRecording = true;
            checkSendButtonState();
        };
        mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: mimeType });
            sendAudioMessage(audioBlob, mimeType);
            stream.getTracks().forEach(track => track.stop());
            recordButton.textContent = 'ğŸ¤';
            isRecording = false;
            checkSendButtonState();
        };
        mediaRecorder.start();
    } catch (error) {
        logDebug('æ— æ³•è®¿é—®éº¦å…‹é£: ' + error, LOG_LEVELS.ERROR);
        alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™ã€‚');
    }
}

function checkSendButtonState() {
    sendButton.disabled = (messageInput.value.trim() === '' && selectedFile === null && !isRecording);
}


// --- æ¶ˆæ¯å‘é€å‡½æ•° (ç®€åŒ–ç‰ˆ) ---
messageForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const text = messageInput.value.trim();
    const isSocketReady = socket && socket.readyState === WebSocket.OPEN;

    if ((!text && !selectedFile && !isRecording) || !isSocketReady) {
        checkSendButtonState();
        return;
    }
    
    // ç¦ç”¨å‘é€æŒ‰é’®é˜²æ­¢é‡å¤æäº¤
    sendButton.disabled = true;
    
    try {
        if (selectedFile) {
            // å‘é€å›¾ç‰‡æ¶ˆæ¯
            await sendImageMessage(selectedFile, text);
        } else if (text) {
            // ç®€åŒ–ç‰ˆæœ¬ - ç›´æ¥å‘é€æ–‡æœ¬æ¶ˆæ¯ï¼Œä¸è¿›è¡Œä¹è§‚æ›´æ–°
            socket.send(JSON.stringify({ 
                type: 'chat', 
                payload: { 
                    type: 'text',
                    text: text 
                } 
            }));
            
            // æ¸…ç†è¾“å…¥æ¡†
            messageInput.value = '';
            messageInput.style.height = 'auto';
        }
    } catch (error) {
        logDebug('å‘é€æ¶ˆæ¯è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: ' + error, 'error', error);
        alert('å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
    } finally {
        // æ¢å¤UIçŠ¶æ€
        removeImagePreview();
        checkSendButtonState();
    }
});

// --- å›¾ç‰‡æ–‡ä»¶ä¸Šä¼ å‡½æ•° (ç®€åŒ–ç‰ˆ) ---
async function sendImageMessage(file, caption = '') {
    try {
        logDebug(`å¼€å§‹ä¸Šä¼ å›¾ç‰‡: ${file.name}`, LOG_LEVELS.INFO);
        
        // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦UI
        uploadProgress.style.display = 'block';
        uploadProgress.textContent = 'ä¸Šä¼ ä¸­...';
        imagePreview.classList.add('uploading');
        
        // åˆ›å»ºFormDataå¹¶æ·»åŠ æ­£ç¡®æ–‡ä»¶åçš„æ–‡ä»¶
        const safeFileName = encodeURIComponent(file.name);
        
        // ä¸Šä¼ æ–‡ä»¶åˆ°R2å­˜å‚¨
        const response = await fetch('/upload', {
            method: 'POST',
            body: file,
            headers: {
                'X-Filename': safeFileName,
                'Content-Type': file.type
            }
        });
        
        if (!response.ok) {
            throw new Error(`ä¸Šä¼ å¤±è´¥: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!data.url) {
            throw new Error('æœåŠ¡å™¨æ²¡æœ‰è¿”å›æœ‰æ•ˆçš„æ–‡ä»¶URL');
        }
        
        logDebug(`å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼Œè·å–URL: ${data.url}`, LOG_LEVELS.SUCCESS);
        
        // å‘é€å›¾ç‰‡æ¶ˆæ¯é€šè¿‡WebSocket
        const payload = {
            type: 'image',
            text: caption, // text å­—æ®µå¯ä»¥ä¸ºç©ºï¼Œä½†å­˜åœ¨ (åç«¯ä½¿ç”¨ caption)
            caption: caption,
            imageUrl: data.url, // å‘é€æœåŠ¡å™¨è¿”å›çš„URL
            filename: file.name,
            size: file.size
        };
        
        socket.send(JSON.stringify({
            type: 'chat',
            payload: payload
        }));
        
        logDebug("å›¾ç‰‡æ¶ˆæ¯å·²é€šè¿‡WebSocketå‘é€", LOG_LEVELS.SUCCESS);
        
        // æ¸…ç†UI
        messageInput.value = '';
        messageInput.style.height = 'auto';
        removeImagePreview();
        
        return true;
    } catch (error) {
        logDebug(`å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ${error.message}`, LOG_LEVELS.ERROR, error);
        alert(`å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ${error.message}`);
        throw error;
    } finally {
        // éšè—ä¸Šä¼ è¿›åº¦UI
        uploadProgress.style.display = 'none';
        imagePreview.classList.remove('uploading');
    }
}

// --- éŸ³é¢‘æ–‡ä»¶ä¸Šä¼ å‡½æ•° (ç®€åŒ–ç‰ˆ) ---
async function sendAudioMessage(audioBlob, mimeType) {
    try {
        logDebug(`å¼€å§‹ä¸Šä¼ éŸ³é¢‘`, LOG_LEVELS.INFO, { size: audioBlob.size, type: mimeType });
        
        // ç”ŸæˆéŸ³é¢‘æ–‡ä»¶å
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        const filename = `audio-${timestamp}.${mimeType.includes('mp4') ? 'mp4' : 'webm'}`;
        const safeFileName = encodeURIComponent(filename);
        
        // ä¸Šä¼ éŸ³é¢‘åˆ°R2å­˜å‚¨
        const response = await fetch('/upload', {
            method: 'POST',
            body: audioBlob,
            headers: {
                'X-Filename': safeFileName,
                'Content-Type': mimeType
            }
        });
        
        if (!response.ok) {
            throw new Error(`ä¸Šä¼ å¤±è´¥: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!data.url) {
            throw new Error('æœåŠ¡å™¨æ²¡æœ‰è¿”å›æœ‰æ•ˆçš„æ–‡ä»¶URL');
        }
        
        logDebug(`éŸ³é¢‘ä¸Šä¼ æˆåŠŸï¼Œè·å–URL: ${data.url}`, LOG_LEVELS.SUCCESS);
        
        // å‘é€éŸ³é¢‘æ¶ˆæ¯é€šè¿‡WebSocket
        const payload = {
            type: 'audio',
            text: '', // æ ¸å¿ƒä¿®æ­£ï¼šä¸ºéŸ³é¢‘æ¶ˆæ¯æ·»åŠ ç©ºçš„ text å­—æ®µ
            audioUrl: data.url, // å‘é€æœåŠ¡å™¨è¿”å›çš„URL
            filename: filename,
            size: audioBlob.size
        };
        
        socket.send(JSON.stringify({
            type: 'chat',
            payload: payload
        }));
        
        logDebug("éŸ³é¢‘æ¶ˆæ¯å·²é€šè¿‡WebSocketå‘é€", LOG_LEVELS.SUCCESS);
        
        return true;
    } catch (error) {
        logDebug(`éŸ³é¢‘ä¸Šä¼ å¤±è´¥: ${error.message}`, LOG_LEVELS.ERROR, error);
        alert(`éŸ³é¢‘ä¸Šä¼ å¤±è´¥: ${error.message}`);
        throw error;
    }
}
// ä¼˜åŒ–çš„å†å²æ¶ˆæ¯å¤„ç†å‡½æ•° - å®Œæ•´ç‰ˆæœ¬
async function processHistoryMessages(history) {
    if (!Array.isArray(history) || history.length === 0) {
        logDebug("å†å²è®°å½•ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®", LOG_LEVELS.WARNING);
        updateUIFromMessages();
        return;
    }
    
    logDebug(`å¼€å§‹å¤„ç† ${history.length} æ¡å†å²è®°å½•ï¼Œä½¿ç”¨ä¼˜åŒ–çš„æ‰¹å¤„ç†æ–¹å¼`);
    
    // æ¸…ç©ºç°æœ‰æ¶ˆæ¯å’ŒDOM
    chatWindowEl.innerHTML = '';
    allMessages = [];
    
    // è¿‡æ»¤æ— æ•ˆæ¶ˆæ¯
    const validHistory = history.filter(msg => msg && msg.id);
    if (validHistory.length < history.length) {
        logDebug(`æ•°æ®æ¸…æ´—ï¼šè¿‡æ»¤æ‰äº† ${history.length - validHistory.length} æ¡æ— æ•ˆçš„å†å²è®°å½•ã€‚`, LOG_LEVELS.WARNING);
    }
    
    // è®¾ç½®æ‰¹é‡å¤§å°å’Œå¤„ç†çŠ¶æ€
    const batchSize = 15;
    let processedCount = 0;
    const totalMessages = validHistory.length;
    
    // é¢„å…ˆåœ¨å†…å­˜ä¸­å‡†å¤‡æ‰¹æ¬¡ç´¢å¼•
    const batchIndices = [];
    for (let i = 0; i < totalMessages; i += batchSize) {
        batchIndices.push(i);
    }
    
    // ä½¿ç”¨requestAnimationFrameçš„é€’å½’å¤„ç†å‡½æ•°
    function processNextBatch(batchIndex) {
        if (batchIndex >= batchIndices.length) {
            // æ‰€æœ‰æ‰¹æ¬¡å¤„ç†å®Œæˆ
            finalizeBatchProcessing();
            return;
        }
        
        const startIndex = batchIndices[batchIndex];
        const endIndex = Math.min(startIndex + batchSize, totalMessages);
        const currentBatch = validHistory.slice(startIndex, endIndex);
        
        // ä½¿ç”¨DocumentFragmentå‡å°‘DOMæ“ä½œ
        const fragment = document.createDocumentFragment();
        
        // å¤„ç†å½“å‰æ‰¹æ¬¡çš„æ‰€æœ‰æ¶ˆæ¯
        currentBatch.forEach(msg => {
            // æ£€æŸ¥æ˜¯å¦æœ‰ä¹è§‚æ›´æ–°çš„ä¸´æ—¶æ¶ˆæ¯ï¼Œå¦‚æœæœ‰åˆ™æ›¿æ¢
            const existingTempMsgIndex = allMessages.findIndex(m => 
                m.id === msg.id || 
                (m.id.startsWith('temp-') && 
                 m.text === msg.text && 
                 m.username === msg.username && 
                 m.timestamp + 5000 > msg.timestamp)
            );
            
            if (existingTempMsgIndex > -1) {
                // æ›¿æ¢å†…å­˜ä¸­çš„ä¸´æ—¶æ¶ˆæ¯
                allMessages[existingTempMsgIndex] = msg;
                // å¦‚æœDOMä¸­å·²æœ‰æ­¤å…ƒç´ ï¼Œéœ€è¦åˆ é™¤å®ƒ
                const tempEl = chatWindowEl.querySelector(`[data-id="${allMessages[existingTempMsgIndex].id}"]`);
                if (tempEl) tempEl.remove();
            } else {
                // æ·»åŠ æ–°æ¶ˆæ¯åˆ°å†…å­˜æ•°ç»„
                allMessages.push(msg);
            }
            
            // åˆ›å»ºæ¶ˆæ¯DOMå…ƒç´ å¹¶æ·»åŠ åˆ°æ–‡æ¡£ç‰‡æ®µ
            const msgEl = createMessageElement(msg);
            if (msgEl) {
                fragment.appendChild(msgEl);
            }
        });
        
        // ä¸€æ¬¡æ€§å°†æ•´ä¸ªæ‰¹æ¬¡æ·»åŠ åˆ°DOM
        chatWindowEl.appendChild(fragment);
        
        // æ›´æ–°è¿›åº¦è®¡æ•°
        processedCount += currentBatch.length;
        
        // å¯é€‰ï¼šæ˜¾ç¤ºåŠ è½½è¿›åº¦
        if (totalMessages > 100) {
            const progress = Math.round((processedCount / totalMessages) * 100);
            logDebug(`å†å²è®°å½•åŠ è½½è¿›åº¦: ${progress}%`);
        }
        
        // ä½¿ç”¨requestAnimationFrameå®‰æ’ä¸‹ä¸€æ‰¹å¤„ç†
        // å¦‚æœæµè§ˆå™¨ç¹å¿™ï¼Œå¯ä»¥å»¶è¿Ÿå¤„ç†ä¸‹ä¸€æ‰¹
        if (batchIndex < 5 || processedCount % 50 === 0) {
            // å‰å‡ æ‰¹å’Œæ¯50æ¡æ¶ˆæ¯åç«‹å³å¤„ç†ä¸‹ä¸€æ‰¹ï¼Œç¡®ä¿å¿«é€Ÿæ˜¾ç¤ºéƒ¨åˆ†å†…å®¹
            requestAnimationFrame(() => processNextBatch(batchIndex + 1));
        } else {
            // å…¶ä»–æ‰¹æ¬¡ä½¿ç”¨setTimeoutå¢åŠ é—´éš™ï¼Œå‡è½»ä¸»çº¿ç¨‹è´Ÿæ‹…
            setTimeout(() => {
                requestAnimationFrame(() => processNextBatch(batchIndex + 1));
            }, 20);
        }
    }
    
    // å¤„ç†å®Œæ‰€æœ‰æ‰¹æ¬¡åçš„æœ€ç»ˆæ­¥éª¤
    function finalizeBatchProcessing() {
        // æ›´æ–°ç”¨æˆ·åˆ—è¡¨UI
        updateUIFromMessages();
        
        // æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œä½¿ç”¨requestAnimationFrameç¡®ä¿åœ¨DOMæ›´æ–°åæ‰§è¡Œ
        requestAnimationFrame(() => {
            chatWindowEl.scrollTop = chatWindowEl.scrollHeight;
            logDebug(`å†å²è®°å½•åŠ è½½å®Œæˆï¼Œå…± ${processedCount} æ¡æ¶ˆæ¯`, LOG_LEVELS.SUCCESS);
        });
    }
    
    // åˆ›å»ºå•ä¸ªæ¶ˆæ¯å…ƒç´ çš„è¾…åŠ©å‡½æ•°
    function createMessageElement(msg) {
        try {
            if (!msg || !msg.id) {
                logDebug("æ— æ•ˆçš„æ¶ˆæ¯å¯¹è±¡", LOG_LEVELS.ERROR, msg);
                return null;
            }
            
            const msgEl = document.createElement('div');
            msgEl.className = 'message';
            
            // è®¾ç½®æ¶ˆæ¯æ•°æ®å±æ€§
            msgEl.dataset.id = msg.id;
            msgEl.dataset.messageText = msg.caption || msg.text || '';
            msgEl.dataset.timestamp = msg.timestamp;
            msgEl.dataset.messageType = msg.type;
            
            if (msg.type === 'image') {
                msgEl.dataset.imageUrl = msg.imageUrl;
            }
            
            if (msg.username === username) msgEl.classList.add('self');
            
            // æ ¼å¼åŒ–æ¶ˆæ¯æ—¶é—´æˆ³
            const messageDate = new Date(msg.timestamp);
            const now = new Date();
            const diffSeconds = Math.floor((now - messageDate) / 1000);
            let displayTime;
            
            if (diffSeconds < 60) displayTime = 'åˆšåˆš';
            else if (diffSeconds < 3600) displayTime = `${Math.floor(diffSeconds / 60)}åˆ†é’Ÿå‰`;
            else if (diffSeconds < 86400) displayTime = `${Math.floor(diffSeconds / 3600)}å°æ—¶å‰`;
            else displayTime = messageDate.toLocaleString([], { 
                year: 'numeric', month: 'numeric', day: 'numeric', 
                hour: '2-digit', minute: '2-digit' 
            });
            
            // æ„å»ºæ¶ˆæ¯å†…å®¹HTML
            let contentHTML = `<div class="info">
                <span class="username">${escapeHTML(msg.username)}</span> 
                <span class="timestamp">${displayTime}</span>
            </div>`;
            
            // æ ¹æ®æ¶ˆæ¯ç±»å‹æ¸²æŸ“ä¸åŒå†…å®¹
            if (msg.type === 'image') {
                contentHTML += `<div class="message-image" onclick="showImageModal('${msg.imageUrl}')">
                    <img src="${msg.imageUrl}" alt="${escapeHTML(msg.filename || 'Image')}" loading="lazy">
                </div>`;
                contentHTML += `<div class="text">${marked.parse(msg.caption || '')}</div>`;
            } else if (msg.type === 'audio') {
                contentHTML += `<div class="message-audio">
                    <audio controls src="${msg.audioUrl}"></audio>
                </div>`;
                contentHTML += `<div class="text">${marked.parse(msg.text || '')}</div>`;
            } else { // æ–‡æœ¬æ¶ˆæ¯
                contentHTML += `<div class="text">${marked.parse(msg.text || '')}</div>`;
            }
            
            msgEl.innerHTML = contentHTML;
            return msgEl;
            
        } catch (e) {
            logDebug(`åˆ›å»ºæ¶ˆæ¯å…ƒç´ å‡ºé”™: ${e.message}`, LOG_LEVELS.ERROR, { 
                error: e.toString(), stack: e.stack, originalMessage: msg 
            });
            return null;
        }
    }
    
    // å¼€å§‹å¤„ç†ç¬¬ä¸€æ‰¹
    processNextBatch(0);
}

// --- WebSocket äº‹ä»¶å¤„ç†å™¨ (ä¼˜åŒ–ç‰ˆ) ---
function connectWebSocket() {
    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${wsProtocol}//${window.location.host}/${roomName}?username=${encodeURIComponent(username)}`;
    logDebug(`å¼€å§‹è¿æ¥WebSocket: ${wsUrl}`, LOG_LEVELS.INFO);
    socket = new WebSocket(wsUrl);
    socket.onopen = onSocketOpen;
    socket.onmessage = onSocketMessage;
    socket.onclose = onSocketClose;
    socket.onerror = onSocketError;
}

function onSocketOpen() {
    statusEl.textContent = 'å·²è¿æ¥';
    connectionDot.classList.remove('disconnected');
    reconnectInterval = 1000; // é‡ç½®é‡è¿é—´éš”
    checkSendButtonState();
    logDebug('WebSocketè¿æ¥å·²å»ºç«‹', LOG_LEVELS.SUCCESS);
    // å¯åŠ¨ç”¨æˆ·åˆ—è¡¨å®šæ—¶æ›´æ–°ï¼ˆå¦‚æœä¹‹å‰æ²¡æœ‰ï¼‰
    if (!window.userListInterval) {
        window.userListInterval = setInterval(updateUIFromMessages, 600000); // 10åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡ç”¨æˆ·åˆ—è¡¨
    }
}

// onSocketMessage (ä¼˜åŒ–ç‰ˆ)
async function onSocketMessage(event) {
    let data;
    try {
        data = JSON.parse(event.data);
        if (data.type === 'welcome' && Array.isArray(data.payload?.history)) {
            logDebug(`æ”¶åˆ°æ¬¢è¿æ¶ˆæ¯ï¼ŒåŒ…å« ${data.payload.history.length} æ¡å†å²è®°å½•`);
        } else {
            logDebug(`æ”¶åˆ° WebSocket æ•°æ®åŒ… (${data.type})`, 'info');
        }
    } catch (parseError) {
        const rawMessageSnippet = String(event.data).substring(0, 500);
        logDebug(`âŒ æ”¶åˆ°æ ¼å¼é”™è¯¯çš„ WebSocket æ•°æ®åŒ…`, LOG_LEVELS.ERROR, {
            error: parseError.message,
            raw: rawMessageSnippet
        });
        alert("å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨å‘æ¥çš„æ ¼å¼é”™è¯¯æ¶ˆæ¯ï¼Œè¯·åˆ·æ–°é¡µé¢ã€‚");
        return;
    }

    switch (data.type) {
           case 'welcome': {
                const history = data.payload?.history;
                if (Array.isArray(history)) {
                    // ä½¿ç”¨ä¼˜åŒ–çš„å‡½æ•°å¤„ç†å†å²è®°å½•
                    processHistoryMessages(history);
                } else {
                    logDebug("æ”¶åˆ°çš„æ¬¢è¿æ¶ˆæ¯ä¸­ history æ ¼å¼ä¸æ­£ç¡®æˆ–ä¸å­˜åœ¨ã€‚", LOG_LEVELS.ERROR, data.payload);
                }
                break;
            }
        Generated javascript
// onSocketMessage ä¸­ case 'chat' çš„ç®€åŒ–ç‰ˆ
case 'chat': {
    const newMessage = data.payload;
    if (newMessage && newMessage.id) {
        // å¦‚æœä¸ä½¿ç”¨ä¹è§‚æ›´æ–°ï¼Œåªéœ€ç¡®ä¿ä¸é‡å¤æ·»åŠ å³å¯
        if (!allMessages.some(m => m.id === newMessage.id)) {
            allMessages.push(newMessage);
            appendChatMessage(newMessage);
            throttledUpdateUI();
        }
    }
    break;
        }
        case 'user_join':
        case 'user_leave':
            logDebug(`ç³»ç»Ÿæ¶ˆæ¯: ${data.payload.username} ${data.type === 'user_join' ? 'åŠ å…¥äº†' : 'ç¦»å¼€äº†'}`, LOG_LEVELS.INFO, data.payload);
            // å»¶è¿Ÿæ›´æ–°UIä»¥é¿å…é¢‘ç¹æ›´æ–°ï¼Œä½¿ç”¨èŠ‚æµå‡½æ•°
            throttledUpdateUI(); 
            break;
        case 'delete': {
            const { messageId } = data.payload;
            if (messageId) {
                logDebug(`æ”¶åˆ°åˆ é™¤æŒ‡ä»¤ï¼Œå‡†å¤‡ç§»é™¤æ¶ˆæ¯: ${messageId}`, LOG_LEVELS.WARNING);
                const msgEl = chatWindowEl.querySelector(`[data-id="${messageId}"]`);
                if (msgEl) {
                    msgEl.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                    msgEl.style.opacity = '0';
                    msgEl.style.transform = 'scale(0.9)';
                    setTimeout(() => {
                        msgEl.remove();
                        allMessages = allMessages.filter(m => m.id !== messageId);
                        throttledUpdateUI(); // åˆ é™¤åä¹Ÿæ›´æ–°ç”¨æˆ·åˆ—è¡¨ç»Ÿè®¡
                    }, 300);
                }
            }
            break;
        }
        case 'error': // <-- è¿™æ˜¯åç«¯ Durable Object å‘é€çš„é”™è¯¯é€šçŸ¥
            logDebug(`æ”¶åˆ°åç«¯é”™è¯¯é€šçŸ¥: ${data.payload?.message}`, LOG_LEVELS.ERROR, data.payload);
            alert(data.payload?.message);
            sendButton.disabled = false;
            break;
        case 'offer':
            await handleOffer(data.payload);
            break;
        case 'answer':
            await handleAnswer(data.payload);
            break;
        case 'candidate':
            await handleCandidate(data.payload);
            break;
        case 'call_end':
            handleCallEnd(data.payload);
            break;
        case 'debug_log': // å®¢æˆ·ç«¯æ”¶åˆ°åç«¯DOçš„è°ƒè¯•æ—¥å¿—
            // æ­¤æ—¶ payload å°±æ˜¯åç«¯ logEntry å¯¹è±¡
            logDebug(`[åç«¯æ—¥å¿—] ${data.payload.message}`, data.payload.level.toLowerCase(), data.payload.data);
            break;
        case 'heartbeat': // å®¢æˆ·ç«¯æ”¶åˆ°åç«¯DOçš„å¿ƒè·³
            // å¿ƒè·³æ¶ˆæ¯ä¸éœ€è¦åœ¨DOMæ—¥å¿—ä¸­æ˜¾ç¤ºï¼Œæ§åˆ¶å°å·²å¤„ç†
            break;
        default:
            logDebug(`æ”¶åˆ°æœªçŸ¥ WebSocket æ¶ˆæ¯ç±»å‹: ${data.type}`, LOG_LEVELS.WARNING, data);
    }
}

function onSocketClose(event) {
    statusEl.textContent = "è¿æ¥å·²æ–­å¼€";
    connectionDot.classList.add('disconnected');
    let reason = `Code: ${event.code}, Reason: ${event.reason || 'æ— '}, Was Clean: ${event.wasClean}`;
    logDebug(`WebSocketè¿æ¥å·²æ–­å¼€ã€‚${reason}`, LOG_LEVELS.WARNING);
    logDebug(`å°†åœ¨${reconnectInterval/1000}ç§’åé‡è¿`, LOG_LEVELS.WARNING);
    setTimeout(connectWebSocket, reconnectInterval);
    reconnectInterval = Math.min(reconnectInterval * 2, maxReconnectInterval); // æŒ‡æ•°é€€é¿
}

function onSocketError(error) {
    let errorMessage = `WebSocketå‘ç”ŸæœªçŸ¥é”™è¯¯ã€‚Type: ${error.type}`;
    logDebug(errorMessage, LOG_LEVELS.ERROR);
    statusEl.textContent = "è¿æ¥é”™è¯¯";
    socket.close(); // å¼ºåˆ¶å…³é—­ï¼Œè§¦å‘onSocketCloseè¿›è¡Œé‡è¿
}


// --- WebRTC ç›¸å…³å‡½æ•° ---
// (æ‰€æœ‰ WebRTC å‡½æ•°ä¿æŒä¸å˜ï¼ŒåªåŒ…å«åœ¨è¿™é‡Œä¾¿äºæŸ¥çœ‹å®Œæ•´æ€§)
async function initLocalMedia() {
    try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
        logDebug('éº¦å…‹é£è®¿é—®æƒé™å·²è·å–', LOG_LEVELS.SUCCESS);
        return localStream;
    } catch (err) {
        logDebug('æ— æ³•è·å–éº¦å…‹é£æƒé™: ' + err, LOG_LEVELS.ERROR);
        alert('æ— æ³•è·å–éº¦å…‹é£ï¼Œé€šè¯åŠŸèƒ½ä¸å¯ç”¨ã€‚è¯·æ£€æŸ¥æƒé™ã€‚');
        return null; // ä¸æŠ›å‡ºé”™è¯¯ï¼Œè®©åº”ç”¨ç»§ç»­è¿è¡Œ
    }
}

function showCallUI(targetUsername) {
    if (document.getElementById(`call-control-${targetUsername}`)) return;
    const panel = document.createElement('div');
    panel.id = `call-control-${targetUsername}`;
    panel.className = 'call-control-panel';
    panel.innerHTML = `<span>ä¸ ${escapeHTML(targetUsername)} é€šè¯ä¸­...</span><button class="hang-up-btn" data-username="${targetUsername}">ğŸ“</button>`;
    callControlsContainer.appendChild(panel);
    panel.querySelector('.hang-up-btn').onclick = () => endCall(targetUsername);
}

function hideCallUI(targetUsername) {
    document.getElementById(`call-control-${targetUsername}`)?.remove();
    document.getElementById(`audio-${targetUsername}`)?.remove();
}

async function startCall(target) {
    if (!localStream) return alert('æœ¬åœ°éŸ³é¢‘æœªå°±ç»ªï¼Œè¯·æ£€æŸ¥éº¦å…‹é£æƒé™ã€‚');
    if (peerConnections[target]) return;
    showCallUI(target);
    const pc = new RTCPeerConnection(rtcConfig);
    peerConnections[target] = pc;
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
    pc.ontrack = event => playRemoteStream(target, event.streams[0]);
    pc.onicecandidate = event => { if (event.candidate) socket.send(JSON.stringify({ type: 'candidate', payload: { target, candidate: event.candidate } })); };
    pc.onconnectionstatechange = () => { if (['disconnected', 'closed', 'failed'].includes(pc.connectionState)) endCall(target); };
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    socket.send(JSON.stringify({ type: 'offer', payload: { target, sdp: pc.localDescription } }));
}

async function handleOffer({ from, sdp }) {
    if (!localStream) return;
    if (peerConnections[from]) return;
    if (!window.confirm(`${from} æ­£åœ¨å‘¼å«æ‚¨ï¼Œæ˜¯å¦æ¥å¬ï¼Ÿ`)) return;
    showCallUI(from);
    const pc = new RTCPeerConnection(rtcConfig);
    peerConnections[from] = pc;
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
    pc.ontrack = event => playRemoteStream(from, event.streams[0]);
    pc.onicecandidate = event => { if (event.candidate) socket.send(JSON.stringify({ type: 'candidate', payload: { target: from, candidate: event.candidate } })); };
    pc.onconnectionstatechange = () => { if (['disconnected', 'closed', 'failed'].includes(pc.connectionState)) endCall(from); };
    await pc.setRemoteDescription(new RTCSessionDescription(sdp));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    socket.send(JSON.stringify({ type: 'answer', payload: { target: from, sdp: pc.localDescription } }));
}

async function handleAnswer({ from, sdp }) {
    const pc = peerConnections[from];
    if (!pc) return;
    await pc.setRemoteDescription(new RTCSessionDescription(sdp));
}

async function handleCandidate({ from, candidate }) {
    const pc = peerConnections[from];
    if (!pc || !candidate) return;
    await pc.addIceCandidate(new RTCIceCandidate(candidate)).catch(e => logDebug('Add ICE candidate failed: ' + e, LOG_LEVELS.ERROR));
}

function handleCallEnd({ from }) {
    const pc = peerConnections[from];
    if (pc) { pc.close(); delete peerConnections[from]; }
    hideCallUI(from);
}

function endCall(target) {
    if (socket?.readyState === WebSocket.OPEN) socket.send(JSON.stringify({ type: 'call_end', payload: { target } }));
    handleCallEnd({ from: target });
}

function playRemoteStream(username, stream) {
    let audioEl = document.getElementById(`audio-${username}`);
    if (!audioEl) {
        audioEl = document.createElement('audio');
        audioEl.id = `audio-${username}`;
        audioEl.autoplay = true;
        audioEl.playsInline = true;
        remoteAudioContainer.appendChild(audioEl);
    }
    audioEl.srcObject = stream;
    audioEl.muted = true; // é»˜è®¤é™éŸ³ä»¥é¿å…æµè§ˆå™¨è‡ªåŠ¨æ’­æ”¾ç­–ç•¥é—®é¢˜
    audioEl.play().then(() => {
        audioEl.muted = false; // æ’­æ”¾æˆåŠŸåå–æ¶ˆé™éŸ³
    }).catch(error => {
        logDebug(`Autoplay for ${username} failed: ${error}`, LOG_LEVELS.WARNING);
        // å¦‚æœè‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œæç¤ºç”¨æˆ·æ‰‹åŠ¨å¼€å¯å£°éŸ³
        const panel = document.getElementById(`call-control-${username}`);
        if (panel && !panel.querySelector('.unmute-notice')) {
            const unmuteNotice = document.createElement('button');
            unmuteNotice.className = 'unmute-notice';
            unmuteNotice.textContent = 'ğŸ”‡ ç‚¹æ­¤å¼€å¯å£°éŸ³';
            unmuteNotice.onclick = () => {
                audioEl.muted = false;
                audioEl.play().then(() => unmuteNotice.remove()).catch(err => alert('è¿˜æ˜¯æ— æ³•æ’­æ”¾å£°éŸ³: ' + err));
            };
            panel.appendChild(unmuteNotice);
        }
    });
}


// --- é¡µé¢åˆå§‹åŒ–å’Œäº‹ä»¶ç›‘å¬å™¨è®¾ç½® ---
// å®šä¹‰å…¨å±€å˜é‡æ¥ç®¡ç†è§¦æ‘¸äº‹ä»¶çš„çŠ¶æ€ (äº‹ä»¶å§”æ‰˜ç”¨)
let touchStartTime;
let touchLongPressTimer; 
let currentTouchMsgEl = null;

// åˆå§‹åŒ–å‡½æ•°ï¼Œåœ¨DOMContentLoadedåè°ƒç”¨
function initializeChat() {
    // è®¾ç½®DOMå…ƒç´ æ–‡æœ¬
    roomNameEl.textContent = roomName;
    document.getElementById('sidebar-room-name').textContent = roomName;
    usernameDisplayEl.textContent = username;

    // å…ˆåˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ
    initDebugLog();
    
    // å¼‚æ­¥åˆå§‹åŒ–åª’ä½“
    initLocalMedia().catch(err => {
        logDebug('åˆå§‹åŒ–åª’ä½“å¤±è´¥: ' + err, LOG_LEVELS.WARNING);
    });
    
    // å°è¯•è¿æ¥WebSocket
    connectWebSocket();
    
    // æ·»åŠ é¡µé¢å¯è§æ€§ç›‘å¬ï¼Œåœ¨é¡µé¢é‡æ–°å¯è§æ—¶åˆ·æ–°è¿æ¥
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
            if (socket?.readyState !== WebSocket.OPEN) {
                logDebug('é¡µé¢é‡æ–°å¯è§ï¼Œå°è¯•é‡æ–°è¿æ¥WebSocket', LOG_LEVELS.INFO);
                connectWebSocket();
            }
        }
    });
    
    // å®šæœŸæ£€æŸ¥è¿æ¥çŠ¶æ€
    setInterval(() => {
        if (socket?.readyState !== WebSocket.OPEN) {
            logDebug('æ£€æµ‹åˆ°WebSocketè¿æ¥å·²æ–­å¼€ï¼Œå°è¯•é‡æ–°è¿æ¥', LOG_LEVELS.WARNING);
            connectWebSocket();
        }
    }, 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
    
    // æ·»åŠ çª—å£å…³é—­äº‹ä»¶ç›‘å¬ï¼Œç”¨äºå‘é€ä¼˜é›…é€€å‡ºæ¶ˆæ¯
    window.addEventListener('beforeunload', () => {
        if (socket?.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({ type: 'user_leave' }));
        }
    });

    // --- æ ¸å¿ƒUIäº‹ä»¶ç›‘å¬å™¨ (åªç»‘å®šä¸€æ¬¡) ---
    sidebarToggle.addEventListener('click', () => {
        sidebar.classList.toggle('open');
        overlay.classList.toggle('show');
    });
    overlay.addEventListener('click', () => {
        sidebar.classList.remove('open');
        overlay.classList.remove('show');
    });
    onlineDisplay.addEventListener('click', (e) => {
        e.stopPropagation();
        usersMenu.classList.toggle('show');
    });

    usernameDisplayEl.addEventListener('click', () => {
        const newUsername = prompt("è¯·è¾“å…¥æ–°çš„ç”¨æˆ·å:", username);
        if (newUsername && newUsername.trim() && newUsername !== username) {
            username = newUsername.trim();
            localStorage.setItem('chat_username', username);
            usernameDisplayEl.textContent = username;
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ type: 'rename', payload: { newUsername: username } }));
            }
        }
    });

    attachmentBtn.addEventListener('click', () => imageInput.click());
    imageInput.addEventListener('change', handleImageSelection);
    previewRemove.addEventListener('click', removeImagePreview);
    modalClose.addEventListener('click', () => imageModal.classList.remove('show'));
    imageModal.addEventListener('click', (e) => {
        if (e.target === imageModal) imageModal.classList.remove('show');
    });
    recordButton.addEventListener('click', handleRecordButtonClick);

    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = `${Math.min(this.scrollHeight, 100)}px`;
        checkSendButtonState();
    });

    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            messageForm.dispatchEvent(new Event('submit'));
        }
    });

    // --- äº‹ä»¶å§”æ‰˜è®¾ç½® (åªç»‘å®šä¸€æ¬¡åˆ°çˆ¶å…ƒç´ ) ---
    // ä¸º chatWindowEl ç»‘å®šå³é”®èœå•äº‹ä»¶
    chatWindowEl.addEventListener('contextmenu', e => {
        const msgEl = e.target.closest('.message'); // æŸ¥æ‰¾æœ€è¿‘çš„ .message ç¥–å…ˆå…ƒç´ 
        if (msgEl) {
            e.preventDefault(); // é˜»æ­¢æµè§ˆå™¨é»˜è®¤çš„å³é”®èœå•
            showContextMenu(msgEl, e.pageX, e.pageY);
        } else {
            // å¦‚æœåœ¨æ¶ˆæ¯åŒºåŸŸå¤–å³å‡»ï¼Œéšè—ä¸Šä¸‹æ–‡èœå•
            contextMenu.style.display = 'none';
        }
    });

    // ä¸º chatWindowEl ç»‘å®šè§¦æ‘¸å¼€å§‹äº‹ä»¶ (ç”¨äºé•¿æŒ‰)
    chatWindowEl.addEventListener('touchstart', e => {
        const msgEl = e.target.closest('.message');
        if (msgEl) {
            // ä¸å†é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œå…è®¸æ»šåŠ¨
            currentTouchMsgEl = msgEl; // è®°å½•å½“å‰è§¦æ‘¸çš„æ¶ˆæ¯å…ƒç´ 
            touchStartTime = Date.now(); // è®°å½•è§¦æ‘¸å¼€å§‹æ—¶é—´

            // è®¾ç½®ä¸€ä¸ªçŸ­æ—¶é—´å®šæ—¶å™¨ï¼Œå¦‚æœæ‰‹æŒ‡åœ¨è¿™ä¸ªæ—¶é—´å†…æ²¡æœ‰ç§»åŠ¨ä¸”æœªæŠ¬èµ·ï¼Œåˆ™è§†ä¸ºé•¿æŒ‰
            touchLongPressTimer = setTimeout(() => {
                // å†æ¬¡æ£€æŸ¥ç¡®ä¿æ˜¯åŒä¸€ä¸ªå…ƒç´ ä¸”æ—¶é—´è¶³å¤Ÿé•¿
                if (currentTouchMsgEl === msgEl && (Date.now() - touchStartTime) >= 500) {
                    // åªæœ‰åœ¨é•¿æŒ‰æ—¶æ‰é˜»æ­¢é»˜è®¤è¡Œä¸º
                    e.preventDefault();
                    showContextMenu(msgEl, e.touches[0].pageX, e.touches[0].pageY);
                    if (navigator.vibrate) navigator.vibrate(50); // ç§»åŠ¨ç«¯éœ‡åŠ¨åé¦ˆ
                }
            }, 500); // é•¿æŒ‰é˜ˆå€¼ï¼š500æ¯«ç§’
        } else {
            // å¦‚æœè§¦æ‘¸å¼€å§‹åœ¨æ¶ˆæ¯åŒºåŸŸå¤–ï¼Œéšè—ä¸Šä¸‹æ–‡èœå•
            contextMenu.style.display = 'none';
        }
    }, { passive: true }); // ä½¿ç”¨ passive: true æé«˜æ»šåŠ¨æ€§èƒ½

    // ä¸º chatWindowEl ç»‘å®šè§¦æ‘¸ç»“æŸäº‹ä»¶
    chatWindowEl.addEventListener('touchend', () => {
        clearTimeout(touchLongPressTimer); // æ¸…é™¤ä»»ä½•æ­£åœ¨è¿›è¡Œçš„è®¡æ—¶å™¨
        currentTouchMsgEl = null; // é‡ç½®å½“å‰è§¦æ‘¸çš„å…ƒç´ 
    });

    // ä¸º chatWindowEl ç»‘å®šè§¦æ‘¸ç§»åŠ¨äº‹ä»¶
    chatWindowEl.addEventListener('touchmove', () => {
        clearTimeout(touchLongPressTimer); // å¦‚æœæ‰‹æŒ‡ç§»åŠ¨ï¼Œåˆ™ä¸æ˜¯é•¿æŒ‰ï¼Œæ¸…é™¤è®¡æ—¶å™¨
        currentTouchMsgEl = null; // é‡ç½®å½“å‰è§¦æ‘¸çš„å…ƒç´ 
    }, { passive: true }); // ä½¿ç”¨ passive: true æé«˜æ»šåŠ¨æ€§èƒ½

    // å…¨å±€ç‚¹å‡»ç›‘å¬å™¨ï¼Œç”¨äºåœ¨ç‚¹å‡»å…¶ä»–åœ°æ–¹æ—¶å…³é—­èœå•
    document.addEventListener('click', () => {
        usersMenu.classList.remove('show');
        contextMenu.style.display = 'none';
    });
    
    // æ·»åŠ å…¨å±€çš„å›¾ç‰‡æ¨¡æ€æ¡†åŠŸèƒ½
    window.showImageModal = function(imageUrl) {
        if (!imageModal || !modalImage) return;
        modalImage.src = imageUrl;
        imageModal.classList.add('show');
    };
}

// é¡µé¢åŠ è½½å®Œæˆåè°ƒç”¨åˆå§‹åŒ–å‡½æ•°
document.addEventListener('DOMContentLoaded', initializeChat);

</script>
</body>
</html>