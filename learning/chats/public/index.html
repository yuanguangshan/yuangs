<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>ÂÆûÊó∂ËÅäÂ§©ÂÆ§</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { --main-bg: #f8f9fa; --bubble-bg: white; --bubble-self-bg: #667eea; --text-color: #212529; --text-self-color: white; --header-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%); --sidebar-bg: linear-gradient(180deg, #2c3e50 0%, #3498db 100%); --border-color: #e9ecef; }
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: #e0e5ec; display: flex; justify-content: center; align-items: center; }
        .chat-container { width: 95%; max-width: 800px; height: 95vh; background: var(--main-bg); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: flex; overflow: hidden; border: 1px solid #d1d9e6; }
        .sidebar { width: 280px; background: var(--sidebar-bg); color: white; padding: 0; display: flex; flex-direction: column; flex-shrink: 0; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .sidebar-header { padding: 20px; background: rgba(0,0,0,0.1); border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sidebar h2 { margin: 0; font-size: 1.2em; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .online-indicator { width: 8px; height: 8px; background: #2ecc71; border-radius: 50%; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.2); opacity: 0.7; } }
        .user-list-container { flex-grow: 1; padding: 20px; overflow-y: auto; }
        .user-list-title { font-size: 0.9em; font-weight: 600; margin-bottom: 12px; color: rgba(255, 255, 255, 0.9); padding-bottom: 6px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .user-names { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
        .user-item { padding: 6px 12px; font-size: 0.85em; background: rgba(255,255,255,0.15); border-radius: 16px; display: flex; align-items: center; gap: 6px; white-space: nowrap; border: 1px solid rgba(255,255,255,0.1); }
        .user-item::before { content: 'üë§'; font-size: 12px; }
        .user-stats-container { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); max-height: 40%; overflow-y: auto; }
        .user-stats-item { background: rgba(255,255,255,0.08); border-radius: 8px; padding: 12px; margin-bottom: 10px; font-size: 0.85em; border: 1px solid rgba(255,255,255,0.05); }
        .user-stats-item strong { color: #f1c40f; }
        .stat-row { display: flex; justify-content: space-between; margin-top: 6px; }
        .stat-label { opacity: 0.8; }
        .online-status { color: #2ecc71; font-weight: 600; }
        .offline-status { color: #e74c3c; opacity: 0.8; }
        .main-chat { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        .chat-header { padding: 12px 25px; background: var(--header-bg); color: white; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 10;}
        .sidebar-toggle { display: none; background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 5px; }
        .chat-info { display: flex; align-items: center; gap: 12px; }
        .room-name { font-size: 1.1em; font-weight: 700; }
        .user-status { font-size: 0.8em; opacity: 0.9; margin-top: 2px; }
        #username-display { cursor: pointer; text-decoration: underline; text-decoration-style: dotted; }
        .connection-dot { display: inline-block; width: 8px; height: 8px; background: #e74c3c; border-radius: 50%; transition: background-color 0.5s; }
        .connection-dot.connected { background: #2ecc71; animation: pulse 1.5s infinite; }
        .online-users-display { font-size: 0.9em; }
        #chat-window { flex: 1; padding: 20px; overflow-y: auto; }
        .message { margin-bottom: 16px; display: flex; flex-direction: column; max-width: 80%; }
        .message.self { align-self: flex-end; align-items: flex-end; }
        .message .info { font-size: 0.8em; color: #6c757d; margin-bottom: 4px; }
        .message .text { padding: 10px 14px; border-radius: 18px; line-height: 1.5; word-wrap: break-word; background: var(--bubble-bg); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .message.self .text { background: var(--bubble-self-bg); color: var(--text-self-color); }
        #message-form { display: flex; padding: 15px; border-top: 1px solid var(--border-color); background: #fff; }
        #message-input { flex-grow: 1; padding: 10px 15px; border: 1px solid var(--border-color); border-radius: 20px; outline: none; font-size: 1em; resize: none; }
        #send-button { padding: 10px 20px; margin-left: 10px; border: none; background: #667eea; color: white; border-radius: 20px; cursor: pointer; font-weight: 600; }
        #send-button:disabled { background: #aaa; cursor: not-allowed; }
        @media (max-width: 768px) {
            .chat-container { width: 100%; height: 100%; border-radius: 0; }
            .sidebar { position: fixed; left: -100%; top: 0; height: 100%; z-index: 1000; transition: left 0.3s ease-in-out; }
            .sidebar.open { left: 0; }
            .sidebar-toggle { display: block; }
            #message-form { padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px)); }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header"><h2><span class="online-indicator"></span> ËÅäÂ§©ÂÆ§‰ø°ÊÅØ</h2></div>
            <div class="user-list-container">
                <div class="user-list-title">Âú®Á∫øÁî®Êà∑</div>
                <div class="user-names" id="user-names"></div>
            </div>
            <div class="user-stats-container">
                <div class="user-list-title">Áî®Êà∑ÁªüËÆ°</div>
                <div id="user-stats-list"></div>
            </div>
        </aside>
        <main class="main-chat">
            <header class="chat-header">
                <button class="sidebar-toggle" id="sidebar-toggle">‚ò∞</button>
                <div class="chat-info">
                    <div>
                        <h1 class="room-name" id="room-name">...</h1>
                        <p class="user-status"><span class="connection-dot" id="connection-dot"></span> <span id="status">...</span> by <span id="username-display" title="ÁÇπÂáª‰øÆÊîπÁî®Êà∑Âêç"></span></p>
                    </div>
                </div>
                <div class="online-users-display" id="online-users-display">Âú®Á∫ø: 0</div>
            </header>
            <div id="chat-window"></div>
            <form id="message-form">
                <textarea id="message-input" placeholder="ËØ∑ËæìÂÖ•Ê∂àÊÅØ..." rows="1"></textarea>
                <button id="send-button" type="submit" disabled>ÂèëÈÄÅ</button>
            </form>
        </main>
    </div>

    <script type="module">
    document.addEventListener("DOMContentLoaded", () => {
        const ui = {
            chatWindow: document.getElementById('chat-window'),
            messageForm: document.getElementById('message-form'),
            messageInput: document.getElementById('message-input'),
            sendButton: document.getElementById('send-button'),
            roomName: document.getElementById('room-name'),
            sidebarRoomName: document.getElementById('sidebar-room-name'),
            usernameDisplay: document.getElementById('username-display'),
            status: document.getElementById('status'),
            connectionDot: document.getElementById('connection-dot'),
            userStatsList: document.getElementById('user-stats-list'),
            onlineDisplay: document.getElementById('online-users-display'),
            userNames: document.getElementById('user-names'),
            sidebarToggle: document.getElementById('sidebar-toggle'),
            sidebar: document.getElementById('sidebar'),
        };

        let state = { socket: null, username: '', roomName: '' };

        function main() {
            console.log("[Client] App starting...");
            setupIdentity();
            setupEventListeners();
            connect();
        }

        function setupIdentity() {
            state.username = localStorage.getItem('chat_username');
            if (!state.username) {
                state.username = prompt("ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÂßìÂêç:", "") || "Anonymous";
                localStorage.setItem('chat_username', state.username);
            }
            
            const pathParts = window.location.pathname.split('/');
            state.roomName = pathParts.find(p => p) || 'general';

            ui.roomName.textContent = state.roomName;
            if(ui.sidebarRoomName) ui.sidebarRoomName.textContent = state.roomName;
            ui.usernameDisplay.textContent = state.username;
        }

        function connect() {
            if (state.socket && state.socket.readyState < 2) return;

            console.log(`[Client] Connecting to room: ${state.roomName} as ${state.username}`);
            ui.status.textContent = 'Ê≠£Âú®ËøûÊé•...';
            ui.connectionDot.classList.remove('connected');
            ui.sendButton.disabled = true;

            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            state.socket = new WebSocket(`${wsProtocol}//${window.location.host}/${state.roomName}?username=${encodeURIComponent(state.username)}`);

            state.socket.onopen = () => {
                console.log("[Client] Connection successful!");
                ui.status.textContent = 'Â∑≤ËøûÊé•';
                ui.connectionDot.classList.add('connected');
                ui.sendButton.disabled = false;
                fetchUserStats();
            };

            state.socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log("[Client] Received:", data.type);

                switch (data.type) {
                    case 'history':
                        ui.chatWindow.innerHTML = '';
                        if (data.payload && Array.isArray(data.payload)) {
                            data.payload.forEach(appendChatMessage);
                        }
                        scrollToBottom();
                        break;
                    case 'chat':
                        appendChatMessage(data.payload);
                        break;
                    case 'system_state':
                        updateUserList(data.payload.users);
                        fetchUserStats();
                        break;
                    case 'delete':
                        const msgEl = ui.chatWindow.querySelector(`[data-id="${data.payload.id}"]`);
                        if (msgEl) msgEl.remove();
                        break;
                }
            };

            state.socket.onclose = () => {
                console.log("[Client] Connection closed. Reconnecting in 3 seconds.");
                ui.status.textContent = 'Â∑≤Êñ≠ÂºÄ';
                ui.connectionDot.classList.remove('connected');
                ui.sendButton.disabled = true;
                setTimeout(connect, 3000);
            };

            state.socket.onerror = (error) => {
                console.error("[Client] WebSocket error:", error);
                ui.status.textContent = 'ËøûÊé•ÈîôËØØ';
            };
        }

        function setupEventListeners() {
            ui.usernameDisplay.addEventListener('click', () => {
                const newUsername = prompt("ËØ∑ËæìÂÖ•Êñ∞ÁöÑÁî®Êà∑Âêç:", state.username);
                if (newUsername && newUsername.trim() && newUsername !== state.username) {
                    state.username = newUsername.trim();
                    localStorage.setItem('chat_username', state.username);
                    if (state.socket) {
                        state.socket.onclose = null;
                        state.socket.close();
                    }
                    main();
                }
            });

            ui.messageForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const text = ui.messageInput.value.trim();
                if (!text || !state.socket || state.socket.readyState !== WebSocket.OPEN) return;
                state.socket.send(JSON.stringify({ type: 'chat', payload: { text } }));
                ui.messageInput.value = '';
                ui.messageInput.style.height = 'auto';
            });
            
            ui.messageInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); ui.messageForm.requestSubmit(); }});
            ui.sidebarToggle.addEventListener('click', () => { ui.sidebar.classList.toggle('open'); });
        }
        
        function escapeHTML(str) { return str ? String(str).replace(/[&<>"']/g, m => ({'&':'&','<':'<','>':'>','"':'"',"'":'''})[m]) : ''; }
        
        function scrollToBottom() { ui.chatWindow.scrollTop = ui.chatWindow.scrollHeight; }

        function appendChatMessage(msg) {
            const isScrolledToBottom = ui.chatWindow.scrollHeight - ui.chatWindow.clientHeight <= ui.chatWindow.scrollTop + 100;
            const msgEl = document.createElement('div');
            msgEl.className = `message ${msg.username === state.username ? 'self' : ''}`;
            msgEl.dataset.id = msg.id;
            const messageDate = new Date(msg.timestamp);
            const displayTime = new Intl.DateTimeFormat('zh-CN', { hour: '2-digit', minute: '2-digit' }).format(messageDate);
            let contentHTML = `<div class="info"><span class="username">${escapeHTML(msg.username)}</span> <span class="timestamp">${displayTime}</span></div>`;
            contentHTML += `<div class="text">${marked.parse(msg.text || '')}</div>`;
            msgEl.innerHTML = contentHTML;
            ui.chatWindow.appendChild(msgEl);
            if (isScrolledToBottom) { scrollToBottom(); }
        }

        function updateUserList(users) {
            ui.userNames.innerHTML = '';
            document.getElementById('online-count').textContent = users.length;
            ui.onlineDisplay.textContent = `Âú®Á∫ø: ${users.length}`;
            users.forEach(user => {
                const safeName = escapeHTML(user);
                ui.userNames.insertAdjacentHTML('beforeend', `<div class="user-item">${safeName}</div>`);
            });
        }

        async function fetchUserStats() {
            try {
                const response = await fetch(`/room-user-stats?roomName=${encodeURIComponent(state.roomName)}`);
                if (!response.ok) throw new Error("Failed to fetch user stats");
                const stats = await response.json();
                renderUserStats(stats);
            } catch (error) {
                console.error(error);
                ui.userStatsList.innerHTML = '<p style="color: rgba(255,255,255,0.7);">Ëé∑ÂèñÁªüËÆ°Êï∞ÊçÆÂ§±Ë¥•„ÄÇ</p>';
            }
        }

        function renderUserStats(stats) {
            ui.userStatsList.innerHTML = '';
            if (!stats || stats.length === 0) {
                ui.userStatsList.innerHTML = '<p style="color: rgba(255,255,255,0.7);">ÊöÇÊó†Áî®Êà∑ÁªüËÆ°Êï∞ÊçÆ„ÄÇ</p>';
                return;
            }
            stats.sort((a, b) => b.isOnline - a.isOnline || b.messageCount - a.messageCount);
            stats.forEach(userStat => {
                const item = document.createElement('div');
                item.className = 'user-stats-item';
                const lastSeenString = new Date(userStat.lastSeen).toLocaleString('zh-CN', {dateStyle: 'short', timeStyle: 'short'});
                let onlineDurationString = '0m 0s';
                if (userStat.totalOnlineDuration > 0) {
                    const s = Math.floor(userStat.totalOnlineDuration / 1000);
                    onlineDurationString = `${Math.floor(s/3600)}h ${Math.floor(s%3600/60)}m ${s%60}s`;
                }
                item.innerHTML = `
                    <div class="stat-row"><strong>${escapeHTML(userStat.username)}</strong><span class="${userStat.isOnline ? 'online-status' : 'offline-status'}">${userStat.isOnline ? 'Âú®Á∫ø' : 'Á¶ªÁ∫ø'}</span></div>
                    <div class="stat-row"><span class="stat-label">ÂèëË®Ä:</span><span class="stat-value">${userStat.messageCount}</span></div>
                    <div class="stat-row"><span class="stat-label">Âú®Á∫øÊó∂Èïø:</span><span class="stat-value">${onlineDurationString}</span></div>
                    <div class="stat-row"><span class="stat-label">ÊúÄËøëÊ¥ªÂä®:</span><span class="stat-value">${lastSeenString}</span></div>
                `;
                ui.userStatsList.appendChild(item);
            });
        }
        
        main();
    });
    </script>
</body>
</html>