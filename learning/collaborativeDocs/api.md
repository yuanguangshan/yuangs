# 协同编辑器 API 文档

本文档详细说明了如何通过 WebSocket API 与协同编辑器后端进行通信，以实现文档和用户状态的实时同步。

## 概述

本 API 完全基于 WebSocket 协议，并使用 [Yjs](https://github.com/yjs/yjs) 的二进制协议进行数据交换。客户端通过一个 WebSocket 连接加入一个特定的文档房间，之后所有的数据交换都在此连接上进行。

API 的核心功能分为两部分：
1.  **文档同步 (Sync)**: 实时同步所有协作者对文档内容的修改。
2.  **状态感知 (Awareness)**: 实时同步非文档数据，主要是用户的光标位置、选区和基本信息（如姓名、光标颜色等）。

---

## 连接端点

客户端必须通过 WebSocket 连接到服务。连接的 URL 结构决定了用户将要加入哪个文档。

### URL 结构

```
wss://<your-worker-url>/<document-id>
```

-   **`wss://`**: 生产环境中应使用安全的 WebSocket 协议。本地开发时可能使用 `ws://`。
-   **`<your-worker-url>`**: 你的 Cloudflare Worker 的部署地址。
-   **`<document-id>`**: 文档的唯一标识符。任何字符串都可以作为文档 ID。所有使用相同 `document-id` 的客户端将连接到同一个协作会话中。

### 示例

```
wss://my-collaborative-doc.example.workers.dev/my-first-document
```

---

## 通信协议

通信使用 Yjs 定义的高效二进制格式。所有消息都被编码成 `Uint8Array`。

消息主要分为两种类型，由消息的第一个字节（一个可变长度的无符号整数）来标识：

-   **`MESSAGE_SYNC = 0`**: 用于文档内容的同步。
-   **`MESSAGE_AWARENESS = 1`**: 用于用户状态（光标、选区等）的同步。

### 1. 文档同步 (MESSAGE_SYNC)

这部分遵循 `y-protocols/sync` 协议，用于同步文档的 CRDT 数据。

#### 客户端到服务器

-   **Sync Step 1 (初始同步请求)**: 客户端连接后，会向服务器发送一个包含其本地 Yjs 文档状态向量（State Vector）的消息。服务器根据这个向量计算出客户端需要哪些数据才能同步到最新状态。
-   **Update (更新)**: 当用户在本地修改文档时，客户端会生成一个包含增量更新数据的消息，并发送给服务器。

#### 服务器到客户端

-   **Sync Step 2 (初始同步响应)**: 服务器在收到客户端的 Sync Step 1 后，会返回一个包含客户端缺失的所有文档更新的消息。
-   **Update (更新广播)**: 当服务器从任意一个客户端收到更新时，它会将这个更新广播给所有其他连接的客户端。

### 2. 状态感知 (MESSAGE_AWARENESS)

这部分遵循 `y-protocols/awareness` 协议，用于广播和接收临时性的用户状态。

#### 客户端到服务器

-   当客户端的用户状态发生变化时（例如光标移动、选中文本、用户信息更新），客户端会发送一个包含这些变化的状态更新消息。

#### 服务器到客户端

-   **初始状态**: 当一个新客户端连接时，服务器会将在该会话中的所有其他用户的当前状态一次性发送给这个新客户端。
-   **状态更新广播**: 当服务器从任意一个客户端收到状态更新时，它会将这个更新广播给所有其他连接的客户端。

---

## 工作流程示例

1.  **客户端初始化**:
    -   客户端根据 `document-id` 构建 WebSocket URL。
    -   创建一个 Yjs 文档实例 (`Y.Doc`) 和一个 `WebsocketProvider`。
    -   `WebsocketProvider` 尝试连接到服务器。

2.  **建立连接**:
    -   WebSocket 连接成功建立。
    -   服务器 (`DocumentDurableObject`) 接收连接，并将其加入到会话中。

3.  **初始同步**:
    -   客户端自动发送 **Sync Step 1** 消息。
    -   服务器响应 **Sync Step 2**，将文档的当前内容发送给客户端。
    -   服务器将当前所有其他用户的 **Awareness** 状态发送给客户端。
    -   客户端应用这些更新，编辑器内容和远程光标都渲染出来。

4.  **实时协作**:
    -   **用户 A** 在其编辑器中输入文字。
    -   用户 A 的客户端向服务器发送一个包含文本增量的 **Update** 消息。
    -   服务器收到后，将此 **Update** 消息广播给所有其他用户（如用户 B）。
    -   用户 B 的客户端收到 **Update** 消息，并将其应用到本地 Yjs 文档，其编辑器内容自动更新。
    -   同时，如果用户 A 的光标移动，其客户端会发送 **Awareness** 更新，用户 B 的界面上会实时看到用户 A 的光标在移动。

5.  **断开连接**:
    -   客户端断开 WebSocket 连接。
    -   服务器的 `handleClose` 方法被触发，从会话中移除该客户端，并广播一个 **Awareness** 更新，通知所有其他客户端该用户已离线（其光标消失）。
