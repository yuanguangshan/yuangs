<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Document</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        .container { display: flex; flex-direction: row; }
        .editor, .preview { width: 100%; margin: 1%; }
        textarea { width: 95%; height: 250px; padding: 10px; font-size: 16px; border: 1px solid #ccc; }
        #previewContent { border: 1px solid #ccc; padding: 10px; height: 250px; overflow-y: auto; }
        #status { margin-top: 10px; color: green; }
        .user-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .user-message.show {
            opacity: 1;
        }
        .user-message.hide {
            opacity: 0;
        }
        .editor-header, .preview-header {
            display: flex;
            align-items: center;
            gap: 10px; /* 按钮之间的间距 */
            margin-bottom: 10px;
        }
        .control-button {
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #f0f0f0;
            transition: background-color 0.3s ease;
        }
        .control-button:hover {
            background-color: #e0e0e0;
        }
        @media (max-width: 768px) {
            .container { flex-direction: column; }
            .editor, .preview { width: 98%; }
        }
    </style>
</head>
<body>
    <div id="status">Connecting...</div>
    <h1>全球文档同步！</h1>
    <p>Open this page in multiple tabs/browsers to see real-time collaboration.</p>
    <p>Document ID: <span id="docIdDisplay"></span></p>
    
    <div class="container">
        <div class="editor">
            <div class="editor-header">
                <h2>Editor</h2>
                <button id="selectAllBtn" class="control-button">全选</button>
                <button id="pasteBtn" class="control-button">粘贴</button>
            </div>
            <textarea id="documentContent" class="editor-textarea" placeholder="开始输入..."></textarea>
        </div>

        <div class="preview">
            <div class="preview-header">
                <h2>Preview</h2>
                <button id="copyBtn" class="control-button">复制内容</button>
            </div>
            <div id="previewContent" class="preview-content">等待输入...</div>
        </div>
    </div>
    


    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // 消息提示函数
        function showUserMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.textContent = message;
            messageDiv.className = `user-message ${type}`;
            document.body.appendChild(messageDiv);

            // 动画效果
            setTimeout(() => {
                messageDiv.classList.add('show');
            }, 10);

            setTimeout(() => {
                messageDiv.classList.remove('show');
                messageDiv.classList.add('hide');
                messageDiv.addEventListener('transitionend', () => {
                    messageDiv.remove();
                }, { once: true });
            }, 1000); // 将3000毫秒改为1000毫秒
        }

        const docIdDisplay = document.getElementById('docIdDisplay');
        const documentContent = document.getElementById('documentContent');
        const previewContent = document.getElementById('previewContent');
        const statusDiv = document.getElementById('status');

        // 从浏览器地址栏的路径中提取文档 ID
        const pathParts = window.location.pathname.split('/');
        const documentId = pathParts[1] || 'default-doc'; // 如果 URL 中没有，则使用默认 ID
        docIdDisplay.textContent = documentId;

        // 根据当前页面的协议 (http/https) 构建 WebSocket URL (ws/wss)
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${window.location.host}/${documentId}/websocket`;

        let ws;
        let debounceTimeout;

        function connectWebSocket() {
            statusDiv.textContent = 'Connecting...';
            ws = new WebSocket(wsUrl);

            // --- WebSocket 事件处理 ---
            // 当连接成功建立时调用
            // 在WebSocket连接成功后添加初始渲染
            ws.onopen = () => {
                statusDiv.textContent = 'Connected!';
                // 初始化时立即请求当前文档内容
                ws.send('暂无内容');
            };
            
            ws.onmessage = (event) => {
                const receivedContent = event.data;
                
                // 处理服务器返回的初始内容
                if (receivedContent.startsWith('content:')) {
                    const content = receivedContent.substring(8);
                    documentContent.value = content;
                    previewContent.innerHTML = marked.parse(content || '等待输入...');
                    return;
                }
                
                // 只有当内容确实发生变化时才更新
                if (documentContent.value !== receivedContent) {
                    documentContent.value = receivedContent;
                    previewContent.innerHTML = marked.parse(receivedContent);
                }
            };

            // 当连接关闭时调用
            ws.onclose = (event) => {
                statusDiv.textContent = `Disconnected. Reconnecting in 3s...`;
                // 实现简单的自动重连机制
                setTimeout(connectWebSocket, 3000);
            };

            // 当发生错误时调用
            ws.onerror = (error) => {
                statusDiv.textContent = 'WebSocket error. Reconnecting...';
                ws.close(); // 触发 onclose 事件，从而启动重连逻辑
            };
        }

        // --- 用户输入处理 ---
        // 添加Markdown预览功能
        documentContent.addEventListener('input', () => {
            // 更新Markdown预览
            previewContent.innerHTML = marked.parse(documentContent.value);
            
            // 保留原有的防抖逻辑
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(() => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(documentContent.value);
                }
            }, 200);
        });

        // 页面加载时，立即开始连接 WebSocket
        connectWebSocket();
        // 在script标签末尾添加
        const selectAllBtn = document.getElementById('selectAllBtn');
        const pasteBtn = document.getElementById('pasteBtn');
        const copyBtn = document.getElementById('copyBtn');
        
        selectAllBtn.addEventListener('click', () => {
            documentContent.select();
            documentContent.focus();
            showUserMessage('已全选编辑器内容！', 'success');
        });

        pasteBtn.addEventListener('click', async () => {
            try {
                // 尝试请求剪贴板读取权限
                const permissionStatus = await navigator.permissions.query({ name: 'clipboard-read' });
                if (permissionStatus.state === 'granted' || permissionStatus.state === 'prompt') {
                    const text = await navigator.clipboard.readText();
                    documentContent.value = text;
                    // 触发输入事件，以便WebSocket同步
                    documentContent.dispatchEvent(new Event('input'));
                    showUserMessage('已粘贴内容！', 'success');
                } else {
                    showUserMessage('粘贴失败：无权限，请手动粘贴。', 'error');
                }
            } catch (err) {
                console.error('粘贴失败:', err);
                showUserMessage('粘贴失败，请手动粘贴。', 'error');
            }
        });

        copyBtn.addEventListener('click', async () => {
            try {
                const textToCopy = previewContent.innerText;
                await navigator.clipboard.writeText(textToCopy);
                showUserMessage('已复制预览内容到剪贴板！', 'success');
            } catch (err) {
                console.error('复制失败:', err);
                // 降级方案：如果navigator.clipboard.writeText失败，尝试execCommand
                const textarea = document.createElement('textarea');
                textarea.value = previewContent.innerText;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    showUserMessage('已复制预览内容到剪贴板！', 'success');
                } catch (execErr) {
                    console.error('execCommand 复制失败:', execErr);
                    showUserMessage('复制失败，请手动复制。', 'error');
                }
                document.body.removeChild(textarea);
            }
        });
    </script>
</body>
</html>