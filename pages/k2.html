<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>期货品种监控</title>
    <!-- 引入 ECharts 脚本 -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        /* CSS Reset and Basic Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            /* 现代化背景色 */
            background: linear-gradient(135deg, #e0f7fa 0%, #bbdefb 100%); /* 淡蓝到浅蓝 */
            min-height: 100vh;
            overflow-x: hidden;
            color: #333; /* 默认文字颜色 */
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 30px;
            color: #2c3e50; /* 深色文字 */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            background: rgba(255,255,255,0.7); /* 浅色半透明背景 */
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.4);
            box-shadow: 0 4px 20px rgba(0,0,0,0.08); /* 柔和阴影 */
        }

        /* Status Panel */
        .status-panel {
            background: rgba(255,255,255,0.95);
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            position: relative;
            z-index: 5; /* 确保状态面板高于图表 */
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .status-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-right {
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            z-index: 10;
        }

        .status-text {
            font-size: 1.1rem;
            font-weight: 500;
            color: #2c3e50;
        }

        .trading-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .trading-status.active {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .trading-status.inactive {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Menu Styles */
        .menu-container {
            position: relative; /* 为下拉菜单提供定位上下文 */
            z-index: 100; /* 确保菜单容器层级很高 */
        }

        .menu-btn {
            padding: 8px 16px;
            /* 现代化按钮背景 */
            background: linear-gradient(45deg, #4a69bd, #3c4f7b); /* 深蓝渐变 */
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(74, 105, 189, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .menu-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(74, 105, 189, 0.4);
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 10px); /* 稍微远离按钮，增加空间感 */
            right: 0;
            background: rgba(255,255,255,0.95); /* 半透明背景 */
            border: 1px solid rgba(255,255,255,0.4);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15); /* 柔和但明显的阴影 */
            z-index: 10001; /* 确保菜单在所有内容之上 */
            min-width: 300px;
            display: none;
            backdrop-filter: blur(10px);
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .dropdown-menu.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .menu-section {
            margin-bottom: 20px;
        }

        .menu-section:last-child {
            margin-bottom: 0;
        }

        .menu-section-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #e1e5e9;
        }

        .metric-selector {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .metric-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .metric-row label {
            font-weight: 500;
            color: #444;
            min-width: 70px; /* 适当增加宽度 */
            font-size: 0.9rem;
        }

        .metric-row select {
            flex: 1;
            padding: 8px 12px; /* 增加内边距 */
            border: 1px solid #ccd6e1; /* 柔和边框 */
            border-radius: 8px;
            outline: none;
            background: white;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            font-size: 0.9rem;
            color: #333;
            appearance: none; /* 移除默认箭头 */
            background-image: url('data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http://www.w3.org/2000/svg%22%20viewBox%3D%220%200%2020%2020%22%3E%3Cpath%20d%3D%22M9.293%2012.95l.707.707L15.657%208l-1.414-1.414L10%2010.828%206.05%206.879%204.636%208.293z%22%20fill%3D%22%23666%22/%3E%3C/svg%3E');
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 14px;
        }

        .metric-row select:focus {
            border-color: #4a69bd; /* 聚焦颜色 */
            box-shadow: 0 0 0 3px rgba(74, 105, 189, 0.2);
        }

        .menu-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .control-btn {
            padding: 8px 18px; /* 增加内边距 */
            /* 现代化按钮背景 */
            background: linear-gradient(45deg, #4a69bd, #3c4f7b); /* 深蓝渐变 */
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(74, 105, 189, 0.3);
        }

        .control-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(74, 105, 189, 0.4);
        }

        .control-btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 5px rgba(74, 105, 189, 0.2);
        }

        .control-btn.secondary {
            /* 现代化次要按钮背景 */
            background: linear-gradient(45deg, #28a745, #218838); /* 绿色渐变 */
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }

        .control-btn.secondary:hover {
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

        /* Chart Grid & Containers */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
            z-index: 1; /* 保持图表容器层级较低，避免遮挡菜单 */
        }

        .chart-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }

        .chart {
            width: 100%;
            height: 400px;
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #e1e5e9;
        }

        .download-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 6px 12px;
            background: linear-gradient(45deg, #28a745, #218838); /* 绿色下载按钮 */
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            z-index: 10;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }

        .download-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

        /* Loading & Error States */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 1.2rem;
            color: #666;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4a69bd; /* 匹配主色 */
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            border: 1px solid #f5c6cb;
        }

        .no-data {
            text-align: center;
            color: #666;
            font-size: 1.1rem;
            padding: 40px;
        }

        /* Menu Overlay for click outside to close */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10000; /* 确保遮罩层在菜单之下，但高于其他内容 */
            display: none;
            background: rgba(0, 0, 0, 0.1); /* 柔和的半透明背景 */
        }

        .menu-overlay.show {
            display: block;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            h1 {
                font-size: 1.8rem;
                padding: 15px;
            }

            .status-panel {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }

            .status-left, .status-right {
                justify-content: center;
            }

            .dropdown-menu {
                right: 0;
                left: 0; /* 居中显示或占满宽度 */
                min-width: auto;
                max-width: calc(100vw - 40px);
                transform-origin: top center; /* 调整动画原点 */
            }

            .chart-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .chart {
                height: 300px;
            }

            .metric-row {
                flex-direction: column;
                align-items: stretch;
            }

            .metric-row label {
                min-width: auto;
                text-align: left;
            }
        }

        /* Styles for the new Treemap legend */
        .treemap-top-list {
            display: flex;
            justify-content: center;
            gap: 11px;
            margin-bottom: 10px;
            font-size: 0.65rem;
            flex-wrap: wrap;
        }

        .treemap-top-list .item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .treemap-top-list .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .treemap-top-list .dot.red { background-color: #ef4444; } /* Red for positive */
        .treemap-top-list .dot.green { background-color: #22c55e; } /* Green for negative */
        .treemap-top-list .value.red { color: #ef4444; font-weight: 500; }
        .treemap-top-list .value.green { color: #22c55e; font-weight: 500; }
        .treemap-top-list .label { color: #555; }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="current-time">🎗期货品种实时监控🎗</h1>
        
        <div class="status-panel">
            <div class="status-left">
                <div class="status-text">
                     <span id="current-time-display"></span>
                </div>
                <span id="trading-status" class="trading-status"></span>
            </div>
            
            <div class="status-right">
                <button id="refresh-btn" class="control-btn secondary">🔄 刷新</button>
                <button id="auto-refresh-btn" class="control-btn">⏱️ 自动刷新</button>
                
                <div class="menu-container" id="menu-container">
                    <button id="menu-btn" class="menu-btn">
                        ⚙️ 设置
                        <span id="menu-arrow">▼</span>
                    </button>
                    
                    <div class="menu-overlay" id="menu-overlay"></div>
                    
                    <div class="dropdown-menu" id="dropdown-menu">
                        <div class="menu-section">
                            <div class="menu-section-title">📊 自定义指标设置</div>
                            <div class="metric-selector">
                                <div class="metric-row">
                                    <label for="metric1-select">指标1:</label>
                                    <select id="metric1-select">
                                        <option value="cje">成交额</option>
                                        <option value="vol">成交量</option>
                                        <option value="tjd">投机度</option>
                                        <option value="ccl">持仓量</option>
                                        <option value="cdzj">沉淀资金</option>
                                        <option value="zf">振幅</option>
                                        <option value="lb">量比</option>
                                        <option value="zdf">涨跌幅</option>
                                    </select>
                                </div>
                                <div class="metric-row">
                                    <label for="metric2-select">指标2:</label>
                                    <select id="metric2-select">
                                        <option value="zdf" selected>涨跌幅</option>
                                        <option value="zdf3">3日涨幅</option>
                                        <option value="zdf5">5日涨幅</option>
                                        <option value="zdf20">20日涨幅</option>
                                        <option value="zdfly">今年涨幅</option>
                                        <option value="zdf250">250日涨幅</option>
                                        <option value="zdflm">本月涨幅</option>
                                        <option value="tjd">投机度</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="menu-section">
                            <div class="menu-actions">
                                <button id="apply-metrics-btn" class="control-btn">📊 应用指标</button>
                                <button id="close-menu-btn" class="control-btn secondary">✖️ 关闭</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <span>别着急，数据马上就更新...</span>
        </div>

        <div id="error-container"></div>

        <div class="chart-grid" id="charts-container">
            <!-- 第一个图表：期货品种走势对比 -->
            <div class="chart-container">
                <div class="chart-title">期货品种走势对比</div>
                <div id="main1" class="chart"></div>
                <button class="download-btn" onclick="downloadChart(chart1, '期货品种走势对比.png')">📥 下载</button>
            </div>

            <!-- 第二个图表：投机度 vs 涨跌幅 -->
            <div class="chart-container">
                <div class="chart-title">投机度与涨跌幅对比</div>
                <div id="main2" class="chart"></div>
                <button class="download-btn" onclick="downloadChart(chart2, '投机度与涨跌幅对比.png')">📥 下载</button>
            </div>

            <!-- 第三个图表：增仓率 vs 涨跌幅 -->
            <div class="chart-container">
                <div class="chart-title">增仓率与涨跌幅对比</div>
                <div id="main3" class="chart"></div>
                <button class="download-btn" onclick="downloadChart(chart3, '增仓率与涨跌幅对比.png')">📥 下载</button>
            </div>

            <!-- 第四个图表：各周期指标对比 -->
            <div class="chart-container">
                <div class="chart-title">各周期涨跌幅对比</div>
                <div id="main4" class="chart"></div>
                <button class="download-btn" onclick="downloadChart(chart4, '各周期涨跌幅对比.png')">📥 下载</button>
            </div>

            <!-- 第五个图表：自定义指标对比 -->
            <div class="chart-container">
                <div class="chart-title" id="chart5-title">自定义指标对比</div>
                <div id="main5" class="chart"></div>
                <button class="download-btn" onclick="downloadChart(chart5, '自定义指标对比.png')">📥 下载</button>
            </div>

            <!-- 第六个图表：品种涨跌图 (Treemap) -->
            <div class="chart-container">
                <div class="chart-title">品种涨跌图</div>
                <div id="main6-treemap-legend" class="treemap-top-list"></div> <!-- Custom legend for Treemap -->
                <div id="main6" class="chart"></div>
                <button class="download-btn" onclick="downloadChart(chart6, '品种涨跌图.png')">📥 下载</button>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let chart1, chart2, chart3, chart4, chart5, chart6; // Added chart6
        let autoRefresh = true;
        let refreshInterval;
        let currentData = [];

        // 指标字段映射
        const fieldMapping = {
            qrspj: '昨收盘价', zdf5: '5日涨幅', zdf6: '6日涨幅', zjlx: '资金流向', dm: '代码',
            zsjd: '展示精度', lx: '品种类型代号', zdf0: '近一年涨幅', avg2: '计算均价', ccl: '持仓量',
            ly: '计算来源', zdf250: '250日涨幅', zdf3: '3日涨幅', dt: '跌停', bpgs: '档位数',
            mcj: '卖出价', mcl: '卖出量', zdflm: '本月涨幅', jjsj: '今结算价', zf: '振幅',
            mmpl: '量档位', tjd: '投机度', xsfx: '现手方向', name: '合约名称', zt: '涨停',
            spgs: '档位', mmpjg: '价格档位', zjsj: '昨结算价', spsj: '收盘时间', np: '内盘',
            rz: '日增仓', kpsj: '开盘时间', sc: '市场代码', uid: '唯一id', vol: '成交量',
            jysj: '交易时间', cjbs: '成交笔数', wp: '外盘', zdf20: '20日涨幅', cje: '成交额',
            mrj: '买入价', utime: '更新时间', mrl: '买入量', h: '最高价', j: '均价',
            zccl: '昨持仓量', l: '最低价', o: '开盘价', zdfly: '今年涨幅', p: '最新价',
            cclbh: '持仓变量', lb: '量比', zde: '涨跌额', jyzt: '交易状态', xs: '现手',
            zdf: '涨跌幅', cdzj: '沉淀资金'
        };

        // ECharts 通用轴线配置
        const commonAxisOptions = {
            axisLabel: {
                fontSize: 11,
                color: '#444', /* 更深的颜色，提高对比度 */
                interval: 0, /* 强制显示所有标签 */
                rotate: 45 /* 旋转标签以防重叠 */
            },
            axisLine: {
                lineStyle: {
                    color: '#ccc' /* 轴线颜色 */
                }
            },
            splitLine: {
                lineStyle: {
                    color: '#f0f0f0', /* 网格线颜色 */
                    type: 'dashed' /* 虚线 */
                }
            }
        };

        // 辅助函数：去除品种名称中的数字部分
        function getSimplifiedName(fullName) {
            // 匹配所有非数字字符，直到遇到第一个数字
            const match = fullName.match(/^([^\d]+)/);
            if (match && match[1]) {
                return match[1]; // 返回非数字部分
            }
            return fullName; // 如果没有匹配到，则返回原名称
        }
        
        // 辅助函数：格式化金额为亿
        function formatCjeToBillion(value) {
            if (value === null || value === undefined) return '-';
            return (value / 1e8).toFixed(2) + '亿';
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            initializeControls();
            initializeMenu();
            fetchData();
            startAutoRefresh();
            updateTimeDisplay();
            setInterval(updateTimeDisplay, 1000);
        });

        // 初始化菜单
        function initializeMenu() {
            const menuBtn = document.getElementById('menu-btn');
            const menuOverlay = document.getElementById('menu-overlay');
            const dropdownMenu = document.getElementById('dropdown-menu');
            const closeMenuBtn = document.getElementById('close-menu-btn');
            const menuArrow = document.getElementById('menu-arrow');

            menuBtn.addEventListener('click', function(e) {
                e.stopPropagation(); // 阻止事件冒泡到document，避免立即关闭
                toggleMenu();
            });

            menuOverlay.addEventListener('click', function() {
                closeMenu();
            });

            closeMenuBtn.addEventListener('click', function() {
                closeMenu();
            });

            dropdownMenu.addEventListener('click', function(e) {
                e.stopPropagation(); // 阻止菜单内部点击关闭菜单
            });

            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeMenu();
                }
            });

            function toggleMenu() {
                const isOpen = dropdownMenu.classList.contains('show');
                if (isOpen) {
                    closeMenu();
                } else {
                    openMenu();
                }
            }

            function openMenu() {
                dropdownMenu.classList.add('show');
                menuOverlay.classList.add('show');
                menuArrow.textContent = '▲';
            }

            function closeMenu() {
                dropdownMenu.classList.remove('show');
                menuOverlay.classList.remove('show');
                menuArrow.textContent = '▼';
            }

            document.getElementById('apply-metrics-btn').addEventListener('click', function() {
                applyCustomMetrics();
                closeMenu();
            });
        }

        // 初始化图表
        function initializeCharts() {
            chart1 = echarts.init(document.getElementById('main1'));
            chart2 = echarts.init(document.getElementById('main2'));
            chart3 = echarts.init(document.getElementById('main3'));
            chart4 = echarts.init(document.getElementById('main4'));
            chart5 = echarts.init(document.getElementById('main5'));
            chart6 = echarts.init(document.getElementById('main6')); // Initialize chart6

            window.addEventListener('resize', () => {
                chart1.resize();
                chart2.resize();
                chart3.resize();
                chart4.resize();
                chart5.resize();
                chart6.resize(); // Resize chart6
            });
        }

        // 初始化控件
        function initializeControls() {
            document.getElementById('refresh-btn').addEventListener('click', fetchData);
            document.getElementById('auto-refresh-btn').addEventListener('click', toggleAutoRefresh);
            
            // Set initial auto-refresh button text based on autoRefresh state
            const autoRefreshBtn = document.getElementById('auto-refresh-btn');
            if (autoRefresh) {
                autoRefreshBtn.textContent = '⏱️ 自动刷新: 开启';
                autoRefreshBtn.classList.remove('secondary');
            } else {
                autoRefreshBtn.textContent = '⏱️ 自动刷新: 关闭';
                autoRefreshBtn.classList.add('secondary');
            }
        }

        // 更新时间显示
        function updateTimeDisplay() {
            const now = new Date();
            const timeString = now.toLocaleString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            document.getElementById('current-time-display').textContent = timeString;
            
            const isTradingTime = checkTradingTime(now);
            const statusElement = document.getElementById('trading-status');
            
            if (isTradingTime) {
                statusElement.textContent = '● 交易中';
                statusElement.className = 'trading-status active';
            } else {
                statusElement.textContent = '● 非交易时段';
                statusElement.className = 'trading-status inactive';
            }
        }

        // 检查交易时间
        function checkTradingTime(now) {
            const hour = now.getHours();
            const minute = now.getMinutes();
            
            // 日盘：09:00-10:15, 10:30-11:30, 13:30-15:00
            if ((hour === 9 && minute >= 0) || (hour === 10 && minute < 15) || 
                (hour === 10 && minute >= 30) || (hour === 11 && minute < 30) ||
                (hour === 13 && minute >= 30) || (hour === 14 && minute >= 0 && minute < 60) || (hour === 15 && minute === 0)) {
                return true;
            }
            
            // 夜盘：21:00-次日02:30
            if ((hour >= 21) || (hour >= 0 && hour < 2) || (hour === 2 && minute <= 30)) {
                return true;
            }
            
            return false;
        }

        // 获取API URL
        function getApiUrl() {
            return checkTradingTime(new Date()) ? 'https://q.want.biz' : 'https://q.want.biz/night';
        }

        // 显示加载状态
        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('charts-container').style.opacity = '0.5';
        }

        // 隐藏加载状态
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('charts-container').style.opacity = '1';
        }

        // 显示错误信息
        function showError(message) {
            const errorContainer = document.getElementById('error-container');
            errorContainer.innerHTML = `<div class="error-message">❌ ${message}</div>`;
        }

        // 清除错误信息
        function clearError() {
            document.getElementById('error-container').innerHTML = '';
        }

        // 获取数据
        async function fetchData() {
            showLoading();
            clearError();
            
            try {
                const response = await fetch(getApiUrl());
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const apiData = await response.json();
                
                if (!apiData || !apiData.list || !Array.isArray(apiData.list)) {
                    throw new Error('数据格式错误');
                }

                // 过滤数据 (使用主页面一致的过滤条件: 沉淀资金大于15亿)
                let filteredData = apiData.list.filter(item => item.cdzj > 15 * 1e8); 
                
                if (filteredData.length === 0) {
                    throw new Error('没有符合条件的数据');
                }

                // 优先显示未收盘品种
                const hasOpenMarkets = filteredData.some(item => item.jyzt === 0);
                if (hasOpenMarkets) {
                    filteredData = filteredData.filter(item => item.jyzt === 0);
                }

                currentData = filteredData;
                renderAllCharts(filteredData);
                
                // 更新标题显示数据更新时间
                document.getElementById('current-time').textContent = 
                    `🎗期货品种实时监控🎗 (${new Date().toLocaleTimeString()})`;
                
            } catch (error) {
                console.error('数据获取失败:', error);
                showError(`数据获取失败: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // 渲染所有图表
        function renderAllCharts(data) {
            try {
                renderChart1([...data]);
                renderChart2([...data]);
                renderChart3([...data]);
                renderChart4([...data]);
                
                // 获取自定义指标设置
                const metric1 = document.getElementById('metric1-select').value;
                const metric2 = document.getElementById('metric2-select').value;
                renderChart5([...data], metric1, metric2);

                renderChart6([...data]); // Render the new Treemap chart
            } catch (error) {
                console.error('图表渲染失败:', error);
                showError(`图表渲染失败: ${error.message}`);
            }
        }

        // Chart 1: 期货品种走势对比 (Candlestick)
        function renderChart1(dataList) {
            const processedData = dataList.map(item => {
                const openChange = parseFloat(((item.o - item.zjsj) / item.zjsj * 100).toFixed(2));
                const closeChange = parseFloat(((item.p - item.zjsj) / item.zjsj * 100).toFixed(2));
                const lowChange = parseFloat(((item.l - item.zjsj) / item.zjsj * 100).toFixed(2));
                const highChange = parseFloat(((item.h - item.zjsj) / item.zjsj * 100).toFixed(2));
                return {
                    name: getSimplifiedName(item.name),
                    fullName: item.name,
                    dm: item.dm,
                    value: [openChange, closeChange, lowChange, highChange],
                    closeChange
                };
            });

            const sortedData = processedData.sort((a, b) => b.closeChange - a.closeChange);
            const categories = sortedData.map(item => item.name);
            
            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    borderColor: '#777',
                    textStyle: { color: '#fff' },
                    formatter: function (params) {
                        const data = params[0].data.value;
                        const originalName = params[0].data.fullName;
                        if (data && data.length === 4) {
                            return `${originalName}<br/>` +
                                   `开盘涨幅: ${data[0]}%<br/>` +
                                   `收盘涨幅: ${data[1]}%<br/>` +
                                   `最低涨幅: ${data[2]}%<br/>` +
                                   `最高涨幅: ${data[3]}%`;
                        }
                        return originalName;
                    }
                },
                xAxis: {
                    type: 'category',
                    data: categories,
                    axisLabel: commonAxisOptions.axisLabel,
                    axisLine: commonAxisOptions.axisLine
                },
                yAxis: {
                    type: 'value',
                    axisLabel: {
                        formatter: '{value}%',
                        fontSize: commonAxisOptions.axisLabel.fontSize,
                        color: commonAxisOptions.axisLabel.color
                    },
                    axisLine: commonAxisOptions.axisLine,
                    splitLine: commonAxisOptions.splitLine
                },
                dataZoom: [
                    { type: 'inside', start: 0, end: 100 },
                    { start: 0, end: 100, height: 20 }
                ],
                series: [{
                    type: 'candlestick',
                    data: sortedData.map(item => ({
                        value: item.value,
                        dm: item.dm,
                        name: item.name,
                        fullName: item.fullName
                    })),
                    itemStyle: {
                        color: '#ef4444', /* Red */
                        color0: '#22c55e', /* Green */
                        borderColor: '#ef4444',
                        borderColor0: '#22c55e'
                    }
                }]
            };

            chart1.setOption(option);
            bindChartClick(chart1);
        }

        // Chart 2: 投机度 vs 涨跌幅 (Bar + Line)
        function renderChart2(dataList) {
            dataList.sort((a, b) => b.zdf - a.zdf);
            const categories = dataList.map(item => getSimplifiedName(item.name));
            
            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    textStyle: { color: '#fff' },
                    formatter: function(params) {
                        const originalName = params[0].data.fullName;
                        let tooltipContent = originalName + '<br/>';
                        params.forEach(function(item) {
                            tooltipContent += `${item.marker}${item.seriesName}: ${item.value}<br/>`;
                        });
                        return tooltipContent;
                    }
                },
                legend: {
                    data: ['投机度', '涨跌幅'],
                    top: 10,
                    textStyle: { color: '#333' }
                },
                xAxis: {
                    type: 'category',
                    data: categories,
                    axisLabel: commonAxisOptions.axisLabel,
                    axisLine: commonAxisOptions.axisLine
                },
                yAxis: [
                    {
                        type: 'value',
                        name: '投机度',
                        position: 'left',
                        axisLabel: commonAxisOptions.axisLabel,
                        axisLine: commonAxisOptions.axisLine,
                        splitLine: commonAxisOptions.splitLine
                    },
                    {
                        type: 'value',
                        name: '涨跌幅(%)',
                        position: 'right',
                        axisLabel: {
                            formatter: '{value}%',
                            fontSize: commonAxisOptions.axisLabel.fontSize,
                            color: commonAxisOptions.axisLabel.color
                        },
                        axisLine: commonAxisOptions.axisLine,
                        splitLine: { show: false }
                    }
                ],
                dataZoom: [
                    { type: 'inside', start: 0, end: 100 },
                    { start: 0, end: 100, height: 20 }
                ],
                series: [
                    {
                        name: '投机度',
                        type: 'bar',
                        yAxisIndex: 0,
                        itemStyle: { color: '#3b82f6' },
                        data: dataList.map(item => ({
                            value: item.tjd,
                            dm: item.dm,
                            name: getSimplifiedName(item.name),
                            fullName: item.name
                        }))
                    },
                    {
                        name: '涨跌幅',
                        type: 'line',
                        yAxisIndex: 1,
                        itemStyle: { color: '#ef4444' },
                        data: dataList.map(item => ({
                            value: item.zdf,
                            dm: item.dm,
                            name: getSimplifiedName(item.name),
                            fullName: item.name
                        }))
                    }
                ]
            };

            chart2.setOption(option);
            bindChartClick(chart2);
        }

        // Chart 3: 增仓率 vs 涨跌幅 (Bar + Line)
        function renderChart3(dataList) {
            dataList.sort((a, b) => b.zdf - a.zdf);
            
            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    textStyle: { color: '#fff' },
                    formatter: function(params) {
                        const originalName = params[0].data.fullName;
                        let tooltipContent = originalName + '<br/>';
                        params.forEach(function(item) {
                            tooltipContent += `${item.marker}${item.seriesName}: ${item.value}%<br/>`;
                        });
                        return tooltipContent;
                    }
                },
                legend: {
                    data: ['增仓率', '涨跌幅'],
                    top: 10,
                    textStyle: { color: '#333' }
                },
                xAxis: {
                    type: 'category',
                    data: dataList.map(item => getSimplifiedName(item.name)),
                    axisLabel: commonAxisOptions.axisLabel,
                    axisLine: commonAxisOptions.axisLine
                },
                yAxis: [
                    {
                        type: 'value',
                        name: '增仓率(%)',
                        position: 'left',
                        axisLabel: {
                            formatter: '{value}%',
                            fontSize: commonAxisOptions.axisLabel.fontSize,
                            color: commonAxisOptions.axisLabel.color
                        },
                        axisLine: commonAxisOptions.axisLine,
                        splitLine: commonAxisOptions.splitLine
                    },
                    {
                        type: 'value',
                        name: '涨跌幅(%)',
                        position: 'right',
                        axisLabel: {
                            formatter: '{value}%',
                            fontSize: commonAxisOptions.axisLabel.fontSize,
                            color: commonAxisOptions.axisLabel.color
                        },
                        axisLine: commonAxisOptions.axisLine,
                        splitLine: { show: false }
                    }
                ],
                dataZoom: [
                    { type: 'inside', start: 0, end: 100 },
                    { start: 0, end: 100, height: 20 }
                ],
                series: [
                    {
                        name: '增仓率',
                        type: 'bar',
                        yAxisIndex: 0,
                        itemStyle: { color: '#06b6d4' },
                        data: dataList.map(item => {
                            const divisor = item.ccl - item.rz;
                            const rate = divisor === 0 ? 0 : parseFloat(((item.rz / divisor) * 100).toFixed(2));
                            return {
                                value: rate,
                                dm: item.dm,
                                name: getSimplifiedName(item.name),
                                fullName: item.name
                            };
                        })
                    },
                    {
                        name: '涨跌幅',
                        type: 'line',
                        yAxisIndex: 1,
                        itemStyle: { color: '#ef4444' },
                        data: dataList.map(item => ({
                            value: item.zdf,
                            dm: item.dm,
                            name: getSimplifiedName(item.name),
                            fullName: item.name
                        }))
                    }
                ]
            };

            chart3.setOption(option);
            bindChartClick(chart3);
        }

        // Chart 4: 各周期涨跌幅对比 (Line Chart)
        function renderChart4(dataList) {
            dataList.sort((a, b) => b.zdf - a.zdf);
            
            const seriesConfig = [
                { name: '当日涨幅', field: 'zdf', color: '#ef4444' },
                { name: '3日涨幅', field: 'zdf3', color: '#22c55e' },
                { name: '5日涨幅', field: 'zdf5', color: '#3b82f6' },
                { name: '20日涨幅', field: 'zdf20', color: '#a855f7' },
                { name: '今年涨幅', field: 'zdfly', color: '#f59e0b' },
                { name: '250日涨幅', field: 'zdf250', color: '#14b8a6' }
            ];

            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    textStyle: { color: '#fff' },
                    formatter: function(params) {
                        const originalName = params[0].data.fullName;
                        let tooltipContent = originalName + '<br/>';
                        params.forEach(function(item) {
                            tooltipContent += `${item.marker}${item.seriesName}: ${item.value}%<br/>`;
                        });
                        return tooltipContent;
                    }
                },
                legend: {
                    data: seriesConfig.map(s => s.name),
                    top: 10,
                    type: 'scroll',
                    textStyle: { color: '#333' }
                },
                xAxis: {
                    type: 'category',
                    data: dataList.map(item => getSimplifiedName(item.name)),
                    axisLabel: commonAxisOptions.axisLabel,
                    axisLine: commonAxisOptions.axisLine
                },
                yAxis: {
                    type: 'value',
                    name: '涨跌幅(%)',
                    axisLabel: {
                        formatter: '{value}%',
                        fontSize: commonAxisOptions.axisLabel.fontSize,
                        color: commonAxisOptions.axisLabel.color
                    },
                    axisLine: commonAxisOptions.axisLine,
                    splitLine: commonAxisOptions.splitLine
                },
                dataZoom: [
                    { type: 'inside', start: 0, end: 100 },
                    { start: 0, end: 100, height: 20 }
                ],
                series: seriesConfig.map(s => ({
                    name: s.name,
                    type: 'line',
                    itemStyle: { color: s.color },
                    data: dataList.map(item => ({
                        value: item[s.field],
                        dm: item.dm,
                        name: getSimplifiedName(item.name),
                        fullName: item.name
                    })),
                    smooth: true
                }))
            };

            chart4.setOption(option);
            bindChartClick(chart4);
        }

        // Chart 5: 自定义指标对比 (Bar + Line, using menu selections)
        function renderChart5(dataList, metric1, metric2) {
            if (dataList.length === 0) {
                chart5.clear();
                document.getElementById('main5').innerHTML = '<div class="no-data">暂无符合条件的数据</div>';
                return;
            } else {
                const main5Element = document.getElementById('main5');
                if (main5Element.innerHTML.includes('no-data') || main5Element.innerHTML.includes('error-message')) {
                    main5Element.innerHTML = '';
                }
            }
            
            dataList.sort((a, b) => b[metric1] - a[metric1]);

            const categories = dataList.map(item => getSimplifiedName(item.name));
            const metric1Data = dataList.map(item => item[metric1]);
            const metric2Data = dataList.map(item => item[metric2]);

            if (metric1Data.some(val => val === undefined) || metric2Data.some(val => val === undefined)) {
                console.error(`指定的指标 ${metric1} 或 ${metric2} 在数据中不存在`);
                chart5.clear();
                document.getElementById('main5').innerHTML = `<div class="error-message">指定的指标 (${fieldMapping[metric1]} 或 ${fieldMapping[metric2]}) 在数据中不存在</div>`;
                return;
            }
            
            const title = `${fieldMapping[metric1]}与${fieldMapping[metric2]}对比`;
            document.getElementById('chart5-title').textContent = title;
            
            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    textStyle: { color: '#fff' },
                     formatter: function(params) {
                        const originalName = params[0].data.fullName;
                        let tooltipContent = originalName + '<br/>';
                        params.forEach(function(item) {
                            let value = item.value;
                            if (item.seriesName.includes('涨幅') || item.seriesName.includes('率')) {
                                value = value.toFixed(2) + '%';
                            } else if (item.seriesName.includes('成交额') || item.seriesName.includes('沉淀资金')) {
                                value = formatCjeToBillion(value);
                            } else if (typeof value === 'number') {
                                value = value.toFixed(2);
                            }
                            tooltipContent += `${item.marker}${item.seriesName}: ${value}<br/>`;
                        });
                        return tooltipContent;
                    }
                },
                legend: {
                    data: [fieldMapping[metric1], fieldMapping[metric2]],
                    top: 10,
                    textStyle: { color: '#333' }
                },
                xAxis: {
                    type: 'category',
                    data: categories,
                    axisLabel: commonAxisOptions.axisLabel,
                    axisLine: commonAxisOptions.axisLine
                },
                yAxis: [
                    {
                        type: 'value',
                        name: fieldMapping[metric1],
                        position: 'left',
                        axisLabel: {
                            formatter: function (value) {
                                return value.toFixed(2);
                            },
                            fontSize: commonAxisOptions.axisLabel.fontSize,
                            color: commonAxisOptions.axisLabel.color
                        },
                        axisLine: commonAxisOptions.axisLine,
                        splitLine: commonAxisOptions.splitLine
                    },
                    {
                        type: 'value',
                        name: fieldMapping[metric2],
                        position: 'right',
                        axisLabel: {
                            formatter: function (value) {
                                return value.toFixed(2);
                            },
                            fontSize: commonAxisOptions.axisLabel.fontSize,
                            color: commonAxisOptions.axisLabel.color
                        },
                        axisLine: commonAxisOptions.axisLine,
                        splitLine: { show: false }
                    }
                ],
                dataZoom: [
                    { type: 'inside', start: 0, end: 100 },
                    { start: 0, end: 100, height: 20 }
                ],
                series: [
                    {
                        name: fieldMapping[metric1],
                        type: 'bar',
                        yAxisIndex: 0,
                        itemStyle: { color: '#8b5cf6' },
                        data: dataList.map(item => ({
                            value: item[metric1],
                            dm: item.dm,
                            name: getSimplifiedName(item.name),
                            fullName: item.name
                        }))
                    },
                    {
                        name: fieldMapping[metric2],
                        type: 'line',
                        yAxisIndex: 1,
                        itemStyle: { color: '#f59e0b' },
                        lineStyle: { width: 2 },
                        data: dataList.map(item => ({
                            value: item[metric2],
                            dm: item.dm,
                            name: getSimplifiedName(item.name),
                            fullName: item.name
                        }))
                    }
                ]
            };

            chart5.setOption(option);
            bindChartClick(chart5);
        }

        // Chart 6: 品种涨跌图 (Treemap) - NEW CHART
        function renderChart6(dataList) {
            // Filter data for Treemap specifically:成交额 (cje) > 10亿，并只显示未收盘的品种
            let treemapData = dataList.filter(item => item.cje > 10 * 1e8); // Changed to 10亿 as per original image.
            
            if (treemapData.length === 0) {
                chart6.clear();
                document.getElementById('main6').innerHTML = '<div class="no-data">暂无符合条件的品种涨跌数据</div>';
                document.getElementById('main6-treemap-legend').innerHTML = ''; // Clear legend
                return;
            } else {
                const main6Element = document.getElementById('main6');
                if (main6Element.innerHTML.includes('no-data') || main6Element.innerHTML.includes('error-message')) {
                    main6Element.innerHTML = '';
                }
            }

            // Sort data by cje for better treemap layout
            treemapData.sort((a, b) => b.cje - a.cje);

            const treemapSeriesData = treemapData.map(item => {
                let color;
                if (item.zdf > 0) {
                    color = '#ef4444'; // Red for positive gain
                } else if (item.zdf < 0) {
                    color = '#22c55e'; // Green for negative gain
                } else {
                    color = '#cccccc'; // Gray for flat
                }

                return {
                    name: getSimplifiedName(item.name), // Simplified name for the block itself
                    value: item.cje, // Size determined by成交额
                    dm: item.dm,
                    fullName: item.name, // Full name for tooltip
                    zdf: item.zdf, //涨跌幅 for label and color
                    cje: item.cje, //成交额 for label
                    itemStyle: {
                        color: color,
                        borderColor: '#fff', // White border between blocks
                        borderWidth: 1
                    },
                    label: {
                        show: true,
                        position: 'inside',
                        color: '#fff', // White text color inside blocks
                        fontSize: 12,
                        formatter: function(params) {
                            // Ensure label is shown only if block is large enough
                            // ECharts usually handles this, but custom logic can refine
                            const cjeFormatted = formatCjeToBillion(params.data.cje);
                            const zdfFormatted = params.data.zdf ? params.data.zdf.toFixed(2) + '%' : '0.00%';
                            return `${params.name}\n${cjeFormatted}\n${zdfFormatted}`;
                        },
                        rich: { // For custom rich text styles, if needed
                            name: { fontSize: 13, fontWeight: 'bold' },
                            value: { fontSize: 11 },
                            zdf: { fontSize: 11 }
                        },
                        overflow: 'truncate', // Truncate text if too long
                        width: '90%', // Limit label width to block width
                        height: '90%', // Limit label height to block height
                        lineHeight: 14 // Adjust line height
                    }
                };
            });

            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'item',
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    textStyle: { color: '#fff' },
                    formatter: function(params) {
                        if (params.data) {
                            return `${params.data.fullName}<br/>` +
                                   `成交额: ${formatCjeToBillion(params.data.cje)}<br/>` +
                                   `涨跌幅: ${params.data.zdf.toFixed(2)}%`;
                        }
                        return '';
                    }
                },
                series: [{
                    type: 'treemap',
                    width: '100%',
                    height: '100%',
                    roam: false, // Disable zooming and panning
                    nodeClick: false, // Disable clicking on nodes (unless you want drill-down)
                    breadcrumb: { show: false }, // Hide breadcrumb navigation
                    data: treemapSeriesData,
                    levels: [
                        { // First level (for all root nodes)
                            itemStyle: {
                                borderWidth: 1,
                                borderColor: '#fff'
                            },
                            upperLabel: {
                                show: false // Don't show labels for parent groups in a flat treemap
                            }
                        }
                    ]
                }]
            };

            chart6.setOption(option);
            bindChartClick(chart6);

            // Generate and update the custom legend for top gainers/losers
            updateTreemapLegend(treemapData);
        }

        // Update the custom Treemap legend HTML
        function updateTreemapLegend(data) {
            const legendContainer = document.getElementById('main6-treemap-legend');
            let html = '';

            // Get top 3 gainers
            const topGainers = [...data].sort((a, b) => b.zdf - a.zdf).filter(item => item.zdf > 0).slice(0, 3);
            // Get top 3 losers
            const topLosers = [...data].sort((a, b) => a.zdf - b.zdf).filter(item => item.zdf < 0).slice(0, 3);

            topGainers.forEach(item => {
                html += `
                    <div class="item">
                        <span class="dot red"></span>
                        <span class="label">${getSimplifiedName(item.name)}:</span>
                        <span class="value red">${item.zdf.toFixed(2)}%</span>
                    </div>
                `;
            });

            if (topGainers.length > 0 && topLosers.length > 0) {
                html += `<div> </div>`; // Small separator
            }

            topLosers.forEach(item => {
                html += `
                    <div class="item">
                        <span class="dot green"></span>
                        <span class="label">${getSimplifiedName(item.name)}:</span>
                        <span class="value green">${item.zdf.toFixed(2)}%</span>
                    </div>
                `;
            });
            
            legendContainer.innerHTML = html;
        }


        // 绑定图表点击事件 (统一处理)
        function bindChartClick(chart) {
            chart.off('click');
            chart.on('click', function(params) {
                // For Treemap, click on leaf node should open link
                if (params.seriesType === 'treemap' && params.data && params.data.dm) {
                    const dm = params.data.dm;
                    const codeWithoutNumbers = dm.replace(/\d+/g, '');
                    const url = `https://wealth.want.biz/v1/longshort.html?variety=${codeWithoutNumbers}`;
                    window.open(url, '_blank');
                } 
                // For other charts (bar, line, candlestick), click on data item
                else if (params.data && params.data.dm) {
                    const dm = params.data.dm;
                    const codeWithoutNumbers = dm.replace(/\d+/g, '');
                    const url = `https://wealth.want.biz/v1/longshort.html?variety=${codeWithoutNumbers}`;
                    window.open(url, '_blank');
                }
            });
        }

        // 下载图表
        function downloadChart(chartInstance, fileName) {
            const url = chartInstance.getDataURL({
                backgroundColor: '#fff', // 下载图片背景色为白色
                pixelRatio: 2 // 高清下载
            });
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            link.click();
        }

        // 切换自动刷新
        function toggleAutoRefresh() {
            autoRefresh = !autoRefresh;
            const btn = document.getElementById('auto-refresh-btn');
            
            if (autoRefresh) {
                btn.textContent = '⏱️ 自动刷新: 开启';
                btn.classList.remove('secondary');
                startAutoRefresh();
            } else {
                btn.textContent = '⏱️ 自动刷新: 关闭';
                btn.classList.add('secondary'); // 使用 secondary 样式表示关闭状态
                stopAutoRefresh();
            }
        }

        // 开始自动刷新
        function startAutoRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
            
            refreshInterval = setInterval(() => {
                // 只有在交易时段才自动刷新
                if (autoRefresh && checkTradingTime(new Date())) {
                    fetchData();
                }
            }, 15000); // 每15秒刷新一次
        }

        // 停止自动刷新
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        // 应用自定义指标
        function applyCustomMetrics() {
            if (currentData.length > 0) {
                const metric1 = document.getElementById('metric1-select').value;
                const metric2 = document.getElementById('metric2-select').value;
                renderChart5([...currentData], metric1, metric2);
            }
        }
    </script>
</body>
</html>