<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>AI Proxy 指挥中心</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #0d0d0d;
            --card-bg: rgba(255, 255, 255, 0.05);
            --text-color: #e0e0e0;
            --accent-color: #00d1b2;
            --accent-purple: #9b51e0;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Noto Serif SC', serif;
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 900px;
        }

        h1 {
            text-align: center;
            font-weight: 700;
            letter-spacing: 2px;
            margin: 10px 0 20px 0;
            color: var(--text-color);
            font-size: 1.5rem;
        }

        /* 顶部数据卡片 - 始终并排显示 */
        .grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 始终三列并排 */
            gap: 12px;
            margin-bottom: 20px;
            width: 100%;
        }

        .card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 15px 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            transition: transform 0.3s;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 0; /* 允许卡片在小空间内收缩 */
        }

        .card:hover { transform: translateY(-3px); }

        .card h3 {
            font-size: 0.7rem;
            opacity: 0.7;
            margin: 0 0 5px 0;
            line-height: 1.2;
        }
        .card p {
            font-size: 1.3rem;
            margin: 0;
            font-weight: bold;
            color: var(--accent-color);
            word-break: break-all;
        }

        /* 图表区域 */
        .chart-container {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 100%;
        }

        /* 列表区域 - 移动端优化 */
        .stats-container {
            width: 100%;
            background: var(--card-bg);
            border-radius: 15px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.85rem;
        }

        th {
            background: rgba(255, 255, 255, 0.1);
            font-size: 0.75rem;
        }

        .app-tag {
            background: var(--accent-purple);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            display: inline-block;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .refresh-btn {
            background: none;
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            margin-left: auto;
            margin-bottom: 10px;
            transition: 0.3s;
            font-size: 0.8rem;
        }

        .refresh-btn:hover { background: var(--accent-color); color: #000; }

        /* 移动端适配 */
        @media (max-width: 768px) {
            body {
                padding: 8px;
            }

            h1 {
                font-size: 1.3rem;
                margin: 8px 0 15px 0;
            }

            .grid {
                grid-template-columns: repeat(3, 1fr); /* 在中等屏幕上仍保持三列 */
                gap: 10px;
            }

            .card {
                padding: 12px 8px;
                min-height: 70px;
            }

            .card h3 {
                font-size: 0.6rem;
            }
            .card p {
                font-size: 1rem;
            }

            .chart-container {
                padding: 12px;
                margin-bottom: 15px;
            }

            canvas {
                height: 200px !important; /* 减小图表高度 */
            }

            .refresh-btn {
                padding: 5px 10px;
                font-size: 0.75rem;
                margin-bottom: 8px;
            }

            th, td {
                padding: 8px 6px;
                font-size: 0.75rem;
            }

            .app-tag {
                font-size: 0.65rem;
                max-width: 80px;
            }
        }

        @media (max-width: 480px) {
            .grid {
                grid-template-columns: repeat(3, 1fr); /* 在超小屏幕上也保持三列，但使用更小的字体 */
                gap: 8px;
            }

            .card {
                padding: 10px 5px;
                min-height: 60px;
            }

            .card h3 {
                font-size: 0.5rem;
                margin: 0 0 3px 0;
            }
            .card p {
                font-size: 0.85rem;
            }
        }

        @media (max-width: 350px) {
            .grid {
                grid-template-columns: 1fr; /* 在极窄屏幕上改为单列显示 */
            }

            .card {
                padding: 12px 8px;
                min-height: 70px;
            }

            .card h3 {
                font-size: 0.65rem;
            }
            .card p {
                font-size: 1rem;
            }

            h1 {
                font-size: 1.2rem;
            }

            .chart-container {
                padding: 10px;
            }

            canvas {
                height: 180px !important;
            }

            /* 表格在极小屏幕上变为卡片式布局 */
            .mobile-row {
                display: block;
                background: var(--card-bg);
                border-radius: 8px;
                margin-bottom: 10px;
                padding: 10px;
            }

            .mobile-cell {
                display: flex;
                justify-content: space-between;
                padding: 5px 0;
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            }

            .mobile-cell:last-child {
                border-bottom: none;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>指挥中心 · 运行看板</h1>

    <div class="grid">
        <div class="card">
            <h3>今日请求总数</h3>
            <p id="total-req">-</p>
        </div>
        <div class="card">
            <h3>今日消耗 Tokens</h3>
            <p id="total-tokens">-</p>
        </div>
        <div class="card">
            <h3>活跃应用数</h3>
            <p id="active-apps">-</p>
        </div>
    </div>

    <div class="chart-container">
        <canvas id="usageChart"></canvas>
    </div>

    <button class="refresh-btn" onclick="fetchStats()">手动刷新</button>
    <h2 style="margin-top: 0; margin-bottom: 10px; font-size: 1.1rem;">应用明细</h2>
    <div class="stats-container">
        <table id="stats-table" style="display: table;">
            <thead>
                <tr>
                    <th>应用 ID</th>
                    <th>调用次数</th>
                    <th>Token 消耗</th>
                    <th>最后活跃</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>
</div>

<script>
    let myChart = null;

    // 1. 获取数据
    async function fetchStats() {
        try {
            // 请求 API
            const response = await fetch('/api/stats');
            
            // 错误处理
            if (!response.ok) {
                console.error("API Error:", response.status);
                return;
            }

            const data = await response.json();
            console.log("API 返回数据:", data); // 在浏览器控制台查看数据

            updateUI(data);
        } catch (error) {
            console.error("获取统计数据失败:", error);
        }
    }

    // 2. 更新界面
    function updateUI(data) {
        // --- 更新顶部卡片 ---
        // 确保 data 是数组，防止报错
        const safeData = Array.isArray(data) ? data : [];

        const totalReq = safeData.reduce((sum, item) => sum + item.count, 0);
        const totalTokens = safeData.reduce((sum, item) => sum + (item.total_tokens || 0), 0);

        document.getElementById('total-req').innerText = totalReq;
        document.getElementById('total-tokens').innerText = totalTokens.toLocaleString();
        document.getElementById('active-apps').innerText = safeData.length;

        // --- 更新表格 ---
        const tbody = document.querySelector('#stats-table tbody');
        tbody.innerHTML = '';

        if (safeData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color: #888;">暂无应用调用数据（请先发起请求）</td></tr>';
        } else {
            safeData.forEach(item => {
                // 处理可能的 null 值
                const appName = item.app_name || '未知应用';
                const count = item.count || 0;
                const tokens = (item.total_tokens || 0).toLocaleString();
                const lastActive = item.last_active ? item.last_active.replace('T', ' ').split('.')[0] : '刚刚';

                const row = `
                    <tr>
                        <td><span class="app-tag">${appName}</span></td>
                        <td>${count} 次</td>
                        <td>${tokens}</td>
                        <td>${lastActive}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // --- 更新图表 ---
        renderChart(safeData);

        // --- 强制刷新移动端布局 ---
        // 先移除旧的移动端视图，重新生成，避免更新逻辑各种 Bug
        const oldMobile = document.querySelector('.mobile-stats-container');
        if (oldMobile) oldMobile.remove();
        
        handleTableLayout(); 
    }

    // 3. 渲染图表
    function renderChart(data) {
        const ctx = document.getElementById('usageChart').getContext('2d');
        
        // 如果没数据，显示空图表
        const labels = data.length > 0 ? data.map(item => item.app_name) : ['暂无数据'];
        const values = data.length > 0 ? data.map(item => item.total_tokens || 0) : [0];

        if (myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Token 消耗',
                    data: values,
                    backgroundColor: 'rgba(0, 209, 178, 0.4)',
                    borderColor: 'rgba(0, 209, 178, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(255,255,255,0.05)' },
                        ticks: { color: '#888', font: { size: 10 } }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: '#ccc', font: { size: 10 } }
                    }
                }
            }
        });
    }

    // 4. 响应式布局处理（重写版：更稳定）
    function handleTableLayout() {
        const table = document.getElementById('stats-table');
        const isMobile = window.innerWidth <= 480;

        if (isMobile) {
            table.style.display = 'none';

            // 重新构建移动端视图
            let mobileContainer = document.querySelector('.mobile-stats-container');
            if (!mobileContainer) {
                mobileContainer = document.createElement('div');
                mobileContainer.className = 'mobile-stats-container';
                document.querySelector('.stats-container').appendChild(mobileContainer);
            }
            
            // 清空容器，完全根据当前表格内容重建
            mobileContainer.innerHTML = ''; 

            const rows = table.querySelectorAll('tbody tr');
            const headings = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent);

            rows.forEach(row => {
                // 如果是“暂无数据”行，特殊处理
                if (row.cells.length === 1) {
                    mobileContainer.innerHTML = `<div style="padding:15px; text-align:center; color:#888;">暂无数据</div>`;
                    return;
                }

                const mobileRow = document.createElement('div');
                mobileRow.className = 'mobile-row';
                
                Array.from(row.cells).forEach((cell, index) => {
                    const mobileCell = document.createElement('div');
                    mobileCell.className = 'mobile-cell';
                    mobileCell.innerHTML = `<span>${headings[index]}</span><span>${cell.innerHTML}</span>`;
                    mobileRow.appendChild(mobileCell);
                });
                mobileContainer.appendChild(mobileRow);
            });

        } else {
            table.style.display = 'table';
            const mobileContainer = document.querySelector('.mobile-stats-container');
            if (mobileContainer) mobileContainer.remove(); // 宽屏时直接移除移动端DOM
        }
    }

    // 初始化
    fetchStats();
    setInterval(fetchStats, 60000);
    window.addEventListener('resize', handleTableLayout);
</script>

</body>
</html>
