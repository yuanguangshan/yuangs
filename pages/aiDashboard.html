<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>AI Proxy 指挥中心</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #0d0d0d;
            --card-bg: rgba(255, 255, 255, 0.05);
            --text-color: #e0e0e0;
            --accent-color: #00d1b2;
            --accent-purple: #9b51e0;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Noto Serif SC', serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 900px;
        }

        h1 {
            text-align: center;
            font-weight: 700;
            letter-spacing: 2px;
            margin-bottom: 30px;
            color: var(--text-color);
            font-size: 1.5rem;
        }

        /* 顶部数据卡片 */
        .grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 两列布局 */
            gap: 15px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            transition: transform 0.3s;
        }

        .card:hover { transform: translateY(-3px); }

        .card h3 { font-size: 0.85rem; opacity: 0.7; margin: 0; }
        .card p { font-size: 1.5rem; margin: 10px 0 0 0; font-weight: bold; color: var(--accent-color); }

        /* 图表区域 */
        .chart-container {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            height: 300px; /* 固定高度防止抖动 */
        }

        /* 列表区域 */
        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            border-radius: 15px;
            overflow: hidden;
            table-layout: fixed; /* 固定布局 */
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            word-wrap: break-word;
        }

        th { background: rgba(255, 255, 255, 0.1); font-size: 0.85rem; }
        
        .app-tag {
            background: var(--accent-purple);
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.75rem;
            display: inline-block;
        }

        .refresh-btn {
            background: none;
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            padding: 6px 14px;
            border-radius: 20px;
            cursor: pointer;
            float: right;
            transition: 0.3s;
            font-size: 0.85rem;
            margin-top: -10px;
        }

        .refresh-btn:hover { background: var(--accent-color); color: #000; }

        /* === 移动端适配 (核心修改) === */
        @media (max-width: 768px) {
            body { padding: 10px; }

            /* 顶部卡片在较宽的移动端横向显示 */
            .grid {
                grid-template-columns: 1fr 1fr; /* 两列布局 */
                gap: 10px;
            }

            .card {
                padding: 12px;
                min-width: 0; /* 允许卡片在空间不足时收缩 */
            }
            .card p {
                font-size: 1.1rem;
                word-break: break-word; /* 防止文本溢出 */
            }

            /* 图表高度减小 */
            .chart-container { height: 220px; padding: 10px; }

            /* 表格变卡片模式 (CSS魔法) */
            thead { display: none; } /* 隐藏表头 */

            table, tbody, tr, td { display: block; width: 100%; box-sizing: border-box; }

            tr {
                margin-bottom: 15px;
                background: rgba(255,255,255,0.02);
                border-radius: 10px;
                border: 1px solid rgba(255,255,255,0.05);
            }

            td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                text-align: right;
                padding: 10px 15px;
                border-bottom: 1px solid rgba(255,255,255,0.05);
                font-size: 0.9rem;
            }

            td:last-child { border-bottom: none; }

            /* 利用 data-label 属性显示标题 */
            td::before {
                content: attr(data-label);
                font-weight: bold;
                opacity: 0.6;
                font-size: 0.8rem;
                margin-right: 10px;
                text-align: left;
            }
        }

        /* 非常窄的设备（如旧款手机）上恢复单列布局 */
        @media (max-width: 350px) {
            .grid {
                grid-template-columns: 1fr; /* 单列布局 */
                gap: 10px;
            }

            .card {
                padding: 10px;
            }
            .card p {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>苑广山的AI监控屏</h1>

    <div class="grid">
        <div class="card">
            <h3>今日请求总数</h3>
            <p id="total-req">-</p>
        </div>
        <div class="card">
            <h3>今日消耗 Tokens</h3>
            <p id="total-tokens">-</p>
        </div>
    </div>

    <div class="chart-container">
        <canvas id="usageChart"></canvas>
    </div>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h2 style="margin: 0; font-size: 1.2rem;">明细</h2>
        <div style="display: flex; align-items: center; gap: 15px;">
            <p style="margin: 0; font-size: 1.2rem; color: var(--accent-color);">今日消耗: <span id="total-tokens-inline">-</span>, 活跃: <span id="active-apps">-</span></p>
            <button class="refresh-btn" onclick="fetchStats()">刷新</button>
        </div>
    </div>

    <table id="stats-table">
        <thead>
            <tr>
                <th>应用名称</th> <!-- 标题改了 -->
                <th>调用次数</th>
                <th>Token 消耗</th>
                <th>平均/请求</th>
                <th>最后活跃</th>
            </tr>
        </thead>
        <tbody>
            <tr><td colspan="5" style="text-align:center; opacity:0.5;">正在加载数据...</td></tr>
        </tbody>
    </table>
</div>

<script>
    let myChart = null;

    // 【新增】应用名称对照表
    const APP_MAPPING = {
        'shici': '诗词雅苑',
        'music': '广山音乐',
        'poe-app': 'POE',
        'unknown-app': 'ChatBox'
    };

    // 【新增】获取显示名称的辅助函数
    function getAppName(rawName) {
        // 如果 rawName 存在于对照表中，返回对应的中文，否则返回原始英文 ID
        return APP_MAPPING[rawName] || rawName || '未知应用';
    }

    async function fetchStats() {
        try {
            const response = await fetch('/api/stats');
            
            if (!response.ok) {
                console.error("API Error", response.status);
                return;
            }

            const rawData = await response.json();
            const data = Array.isArray(rawData) ? rawData : [];

            updateUI(data);
        } catch (error) {
            console.error("获取统计数据失败:", error);
            document.querySelector('#stats-table tbody').innerHTML = 
                `<tr><td colspan="4" style="text-align:center; color:#ff4444;">数据加载失败，请检查网络</td></tr>`;
        }
    }

    function updateUI(data) {
        // 1. 更新顶部卡片
        const totalReq = data.reduce((sum, item) => sum + item.count, 0);
        const totalTokens = data.reduce((sum, item) => sum + (item.total_tokens || 0), 0);
        
        document.getElementById('total-req').innerText = totalReq;
        document.getElementById('total-tokens').innerText = totalTokens.toLocaleString();
        document.getElementById('total-tokens-inline').innerText = totalTokens.toLocaleString();
        document.getElementById('active-apps').innerText = data.length;

        // 2. 更新表格
        const tbody = document.querySelector('#stats-table tbody');
        tbody.innerHTML = '';

        if (data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; opacity:0.5; padding: 30px;">
                暂无数据<br><span style="font-size:0.8rem">请先调用 API 产生日志</span>
            </td></tr>`;
        } else {
            data.forEach(item => {
                // 【修改】使用 getAppName 函数转换名称
                const displayAppName = getAppName(item.app_name);
                
                const count = item.count;
                const tokens = (item.total_tokens || 0).toLocaleString();
                const avgTokens = count > 0 ? Math.round((item.total_tokens || 0) / count) : 0;
                
                // 处理时间
                const timeStr = item.last_active ? `${formatRelativeTime(item.last_active)}` : '-';

                const row = `
                    <tr>
                        <td data-label="应用名称"><span class="app-tag">${displayAppName}</span></td>
                        <td data-label="调用次数">${count} 次</td>
                        <td data-label="Token 消耗">${tokens}</td>
                        <td data-label="平均/请求">${avgTokens}</td>
                        <td data-label="最后活跃">${timeStr}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // 3. 更新图表
        renderChart(data);
    }

    function renderChart(data) {
        const ctx = document.getElementById('usageChart').getContext('2d');
        
        // 【修改】图表标签也使用中文名称
        const labels = data.length ? data.map(item => getAppName(item.app_name)) : ['暂无数据'];
        const values = data.length ? data.map(item => item.total_tokens || 0) : [0];

        if (myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Token 消耗',
                    data: values,
                    backgroundColor: 'rgba(0, 209, 178, 0.5)',
                    borderColor: 'rgba(0, 209, 178, 1)',
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, 
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        grid: { color: 'rgba(255,255,255,0.05)' },
                        ticks: { color: '#888', font: {size: 10} }
                    },
                    x: { 
                        grid: { display: false },
                        ticks: { color: '#ccc', font: {size: 10} }
                    }
                }
            }
        });
    }

    function formatRelativeTime(dateString) {
        const now = new Date();
        const date = new Date(dateString);
        const diffInSeconds = Math.floor((now - date) / 1000);

        if (diffInSeconds < 60) return `${diffInSeconds} 秒前`;
        if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} 分钟前`;
        if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} 小时前`;
        return `${Math.floor(diffInSeconds / 86400)} 天前`;
    }

    // 初始化加载
    fetchStats();
    // 每 60 秒自动刷新
    setInterval(fetchStats, 60000);
</script>

</body>
</html>