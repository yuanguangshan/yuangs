<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ÂïÜÂìÅÂ∏≠‰ΩçÁõà‰∫èÂàÜÂ∏É</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    :root {
      --header-bg: #614385;
      /* Header Gradient Start */
      --header-bg-end: #516395;
      /* Header Gradient End */
      --bg-color: #121212;
      /* Body Background */
      --text-color: #e0e0e0;
      /* Main Text */
      --positive-color: #ff7675;
      /* Profit */
      --negative-color: #4ced69;
      /* Loss */
      --border-color: #333;
      --control-bg: #2a2a2a;
      /* Input/Select */
      --card-bg: #1e1e1e;
      /* Card Background */
      --secondary-text: #bbb;
      /* Secondary Text */
      --button-bg: #614385;
      /* Button Background */
      --button-hover: #7654a8;
      /* Button Hover */
      --company-name-color: #a18cd1;
      /* Company Name Color */
      --loading-border: #333;
      /* Loading Spinner Border */
      --cache-warning-bg: rgba(255, 167, 38, 0.1);
      /* Cache Warning Background */
      --cache-warning-text: #ffa726;
      /* Cache Warning Text */
      --border-bottom: rgba(255, 255, 255, 0.05);
      /* Item Border Bottom */
      --shadow-color: rgba(0, 0, 0, 0.2);
      /* Shadow Color */
      --shadow-hover-color: rgba(0, 0, 0, 0.3);
      /* Shadow Hover Color */
    }

    html.light-theme {
      --header-bg: #7e57c2;
      /* Header Gradient Start */
      --header-bg-end: #6982c2;
      /* Header Gradient End */
      --bg-color: #f5f5f5;
      /* Body Background */
      --text-color: #333;
      /* Main Text */
      --positive-color: #e74c3c;
      /* Profit */
      --negative-color: #27ae60;
      /* Loss */
      --border-color: #e0e0e0;
      --control-bg: #f0f0f0;
      /* Input/Select */
      --card-bg: #ffffff;
      /* Card Background */
      --secondary-text: #777;
      /* Secondary Text */
      --button-bg: #7e57c2;
      /* Button Background */
      --button-hover: #9575cd;
      /* Button Hover */
      --company-name-color: #7e57c2;
      /* Company Name Color */
      --loading-border: #ddd;
      /* Loading Spinner Border */
      --cache-warning-bg: rgba(255, 167, 38, 0.1);
      /* Cache Warning Background */
      --cache-warning-text: #e67e22;
      /* Cache Warning Text */
      --border-bottom: rgba(0, 0, 0, 0.05);
      /* Item Border Bottom */
      --shadow-color: rgba(0, 0, 0, 0.1);
      /* Shadow Color */
      --shadow-hover-color: rgba(0, 0, 0, 0.15);
      /* Shadow Hover Color */
    }

    body {
      font-family: 'PingFang SC', 'Microsoft YaHei', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      width: 380px;
      margin: 0;
      padding: 0;
      background-color: var(--bg-color);
      color: var(--text-color);
      box-sizing: border-box;
      overflow-x: hidden;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    #app {
      width: 100%;
      margin: 0 auto;
      padding: 10px;
      box-sizing: border-box;
    }

    .header {
      background: linear-gradient(135deg, var(--header-bg), var(--header-bg-end));
      color: white;
      padding: 15px;
      text-align: center;
      margin-bottom: 15px;
      border-radius: 4px;
      box-shadow: 0 2px 10px var(--shadow-color);
      position: relative;
      transition: background 0.3s ease, box-shadow 0.3s ease;
    }
    
    .title {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .form-group {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
    }

    .date-group {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
    }

    .preset-group {
      display: flex;
      justify-content: center;
      margin-bottom: 10px;
    }

    .preset-group button {
      background-color: var(--button-bg);
      color: white;
      border: none;
      padding: 8px 12px;
      margin: 0 5px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 12px;
      transition: all 0.3s ease;
    }

    .preset-group button:hover {
      background-color: var(--button-hover);
      box-shadow: 0 2px 5px var(--shadow-color);
    }

    label {
      margin: 1px 2px;
      font-size: 14px;
      text-align: center;
      color: var(--text-color);
      transition: color 0.3s ease;
    }

    select {
      padding: 8px 12px;
      font-size: 16px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: var(--control-bg);
      color: var(--text-color);
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23bbb' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      padding-right: 30px;
      transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
    }

    input[type='date'] {
      padding: 8px;
      font-size: 14px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      margin-left: 8px;
      background-color: var(--control-bg);
      color: var(--text-color);
      transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
    }

    .company-list {
      background-color: var(--card-bg);
      border-radius: 8px;
      padding: 8px;
      box-shadow: 0 2px 8px var(--shadow-color);
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }

    .company-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      position: relative;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border-bottom);
      transition: border-bottom-color 0.3s ease;
    }

    .company-item:last-child {
      border-bottom: none;
    }

    .company-name {
      font-size: 16px;
      flex: 1;
      color: var(--company-name-color);
      transition: color 0.3s ease;
    }

    .company-value {
      font-size: 16px;
      font-weight: bold;
      width: 120px;
      text-align: right;
    }

    .profit {
      color: var(--positive-color);
      transition: color 0.3s ease;
    }

    .loss {
      color: var(--negative-color);
      transition: color 0.3s ease;
    }

    .bar {
      position: absolute;
      height: 8px;
      bottom: 0;
      left: 0;
      border-radius: 4px;
      transition: background-color 0.3s ease;
    }
    
    /* ÁºìÂ≠òÊï∞ÊçÆË≠¶ÂëäÊ†∑Âºè */
    .cache-warning {
      color: var(--cache-warning-text);
      text-align: center;
      padding: 10px;
      background-color: var(--cache-warning-bg);
      border-radius: 8px;
      margin: 5px 0;
      font-size: 12px;
      transition: color 0.3s ease, background-color 0.3s ease;
    }

    /* Âä†ËΩΩÊåáÁ§∫Âô®Ê†∑Âºè */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      color: var(--secondary-text);
      transition: color 0.3s ease;
    }

    .loading-spinner {
      border: 3px solid var(--loading-border);
      border-top: 3px solid var(--button-bg);
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
      transition: border-color 0.3s ease;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Ê∑ªÂä†‰∏ªÈ¢òÂàáÊç¢ÊåâÈíÆ */
    .theme-toggle {
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .theme-toggle:hover {
      background: rgba(255, 255, 255, 0.3);
    }
  </style>
</head>

<body>
  <div id="app">
    <div class="header">
      <h2 class="title">ÂïÜÂìÅÂ∏≠‰ΩçÁõà‰∫èÂàÜÂ∏É</h2>
      <button class="theme-toggle" id="theme-toggle" title="ÂàáÊç¢‰∏ªÈ¢ò">
        <span id="theme-icon">‚òÄÔ∏è</span>
      </button>
    </div>

    <div class="form-group">
      <label for="variety">ÂìÅÁßç:</label>
      <select id="variety"></select>
    </div>

    <div class="date-group">
      <label for="startDate">Êó∂ÊÆµ:</label>
      <input type="date" id="startDate" />
      <label for="endDate">Ëá≥</label>
      <input type="date" id="endDate" />
    </div>

    <div class="preset-group">
      <button onclick="setPresetTime('today')">‰ªäÊó•</button>
      <button onclick="setPresetTime('1w')">1Âë®</button>
      <button onclick="setPresetTime('1m')">1Êúà</button>
      <button onclick="setPresetTime('3m')">3Êúà</button>
      <button onclick="setPresetTime('6m')">6Êúà</button>
      <button onclick="setPresetTime('1y')">1Âπ¥</button>
    </div>

    <div id="cache-warning" class="cache-warning" style="display: none;">‰ΩøÁî®ÁºìÂ≠òÊï∞ÊçÆ</div>
    
    <div id="loading" class="loading" style="display: none;">
      <div class="loading-spinner"></div>
      <div>Âä†ËΩΩÊï∞ÊçÆ‰∏≠...</div>
    </div>

    <div class="company-list" id="companyList">
      <!-- Company items will be inserted here -->
    </div>
  </div>

  <script>
    const varietyList = [];
    let selectedVariety = '';
    let companyPals = [];
    let startDate = '';
    let endDate = '';
    let isDarkMode = true; // ÈªòËÆ§‰∏∫ÊöóËâ≤Ê®°ÂºèÔºå‰ΩÜ‰ºöÊ†πÊçÆÁ≥ªÁªüËÆæÁΩÆËá™Âä®Ë∞ÉÊï¥
    let userThemePreference = null; // Áî®Êà∑‰∏ªÈ¢òÈ¶ñÈÄâÈ°πÔºånullË°®Á§∫Ë∑üÈöèÁ≥ªÁªü
    
    // ÁºìÂ≠òÁõ∏ÂÖ≥ÂèòÈáè
    let cachedData = {}; // Áî®‰∫éÂ≠òÂÇ®ÁºìÂ≠òÁöÑÊï∞ÊçÆ
    const CACHE_EXPIRY_DAYS = 1; // ÁºìÂ≠òËøáÊúüÊó∂Èó¥ÔºàÂ§©Ôºâ
    let isUsingCache = false; // ÊòØÂê¶Ê≠£Âú®‰ΩøÁî®ÁºìÂ≠òÊï∞ÊçÆ
    
    // ‰ªélocalStorageÂä†ËΩΩÁºìÂ≠ò
    loadCacheFromStorage();

    //ÁºìÂ≠òÂÆûÁé∞Ê∑ªÂä†‰∫Ü‰ª•‰∏ãÁºìÂ≠òÂäüËÉΩÔºö‰∏§ÁßçÊï∞ÊçÆÁºìÂ≠òÔºöÂìÅÁßçÂàóË°®ÁºìÂ≠òÔºö
    //ÈÅøÂÖçÊØèÊ¨°ÊâìÂºÄÈ°µÈù¢ÈÉΩËØ∑Ê±ÇÂìÅÁßçÂàóË°®Áõà‰∫èÊï∞ÊçÆÁºìÂ≠òÔºöÊåâÂìÅÁßç„ÄÅÂ∏ÇÂú∫ÂíåÊó•ÊúüËåÉÂõ¥ÁºìÂ≠òÁºìÂ≠òÁÆ°ÁêÜÊú∫Âà∂Ôºö
    //7Â§©Ëá™Âä®ËøáÊúü‰ΩøÁî®localStorageÊåÅ‰πÖÂåñÂ≠òÂÇ®Ëá™Âä®Ê∏ÖÁêÜËøáÊúüÁºìÂ≠òÈ°πÊô∫ËÉΩÁºìÂ≠òÁ≠ñÁï•Ôºö
    //Âú®‰∫§ÊòìÊâÄÊï∞ÊçÆÊõ¥Êñ∞Êó∂Èó¥ÊÆµÔºà15:30-17:00ÔºâÂº∫Âà∂Ëé∑ÂèñÊúÄÊñ∞Êï∞ÊçÆÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•Êó∂Ëá™Âä®‰ΩøÁî®ÁºìÂ≠òÊï∞ÊçÆÊòæÁ§∫ÁºìÂ≠òË≠¶ÂëäÊèêÁ§∫Ôºå
    //ÂåÖÊã¨ÁºìÂ≠òÊó∂Èó¥‰ø°ÊÅØUI‰ºòÂåñÔºöÊ∑ªÂä†Âä†ËΩΩÊåáÁ§∫Âô®ÔºåÊèêÂçáÁî®Êà∑‰ΩìÈ™åÊ∑ªÂä†ÁºìÂ≠òÊèêÁ§∫Âå∫ÂüüÔºå
    //Âú®‰ΩøÁî®ÁºìÂ≠òÊï∞ÊçÆÊó∂ÁªôÁî®Êà∑ÊòéÁ°ÆÊèêÁ§∫ÁºìÂ≠òÊèêÁ§∫ÂåÖÊã¨Êï∞ÊçÆÁöÑÁºìÂ≠òÊó∂Èó¥Êà≥ÈîôËØØÂ§ÑÁêÜÔºö
    //Âú®ÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•Êó∂ÂÖàÂ∞ùËØï‰ªéÁºìÂ≠òËé∑ÂèñÊï∞ÊçÆÊîπËøõURLÂèÇÊï∞Â§ÑÁêÜÈÄªËæëÔºåÊõ¥Â•ΩÂú∞ÊîØÊåÅÂ§ñÈÉ®ÈìæÊé•Ë∑≥ËΩ¨
    
    // ÂàùÂßãÂåñÈ°µÈù¢
    document.addEventListener('DOMContentLoaded', () => {
      // Ê£ÄÊµãÁ≥ªÁªüÈ¢úËâ≤ÊñπÊ°à
      detectColorScheme();
      
      // ÂàùÂßãÂåñ‰∏ªÈ¢òÂõæÊ†á
      updateThemeToggleIcon();
      
      // Â∫îÁî®ÂΩìÂâç‰∏ªÈ¢ò
      applyTheme();
      
      // ÁªëÂÆö‰∏ªÈ¢òÂàáÊç¢ÊåâÈíÆ
      document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
      
      setPresetTime('1m');
      fetchVarietyList();

      document.getElementById('variety').addEventListener('change', (event) => {
        selectedVariety = event.target.value;
        fetchData();
      });

      document.getElementById('startDate').addEventListener('change', (event) => {
        startDate = event.target.value;
        fetchData();
      });

      document.getElementById('endDate').addEventListener('change', (event) => {
        endDate = event.target.value;
        fetchData();
      });
    });
    
    // Ê£ÄÊµãÁ≥ªÁªüÈ¢úËâ≤ÊñπÊ°à
    function detectColorScheme() {
      // Ê£ÄÊü•ÊòØÂê¶ÊúâÁî®Êà∑Ëá™ÂÆö‰πâËÆæÁΩÆ
      const savedUserPreference = localStorage.getItem('theme-preference');
      if (savedUserPreference) {
        userThemePreference = savedUserPreference;
        isDarkMode = savedUserPreference === 'dark';
        return;
      }

      // Ê£ÄÊü•Á≥ªÁªüÈ¢úËâ≤ÊñπÊ°à
      const prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
      isDarkMode = prefersDarkMode;
      
      // ÁõëÂê¨Á≥ªÁªü‰∏ªÈ¢òÂèòÂåñ
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
        // Âè™ÊúâÂú®Áî®Êà∑Ê≤°ÊúâÊòéÁ°ÆÈÄâÊã©‰∏ªÈ¢òÊó∂ÊâçË∑üÈöèÁ≥ªÁªü
        if (userThemePreference === null) {
          isDarkMode = e.matches;
          updateThemeToggleIcon();
          applyTheme();
        }
      });
    }

    // Êõ¥Êñ∞‰∏ªÈ¢òÂàáÊç¢ÊåâÈíÆÂõæÊ†á
    function updateThemeToggleIcon() {
      const themeIcon = document.getElementById('theme-icon');
      themeIcon.textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
      document.getElementById('theme-toggle').title = isDarkMode ? 'ÂàáÊç¢Âà∞ÊµÖËâ≤Ê®°Âºè' : 'ÂàáÊç¢Âà∞Ê∑±Ëâ≤Ê®°Âºè';
    }

    // Â∫îÁî®‰∏ªÈ¢òÂà∞HTMLÂÖÉÁ¥†
    function applyTheme() {
      if (isDarkMode) {
        document.documentElement.classList.remove('light-theme');
      } else {
        document.documentElement.classList.add('light-theme');
      }
    }

    // ÊâãÂä®ÂàáÊç¢‰∏ªÈ¢ò
    function toggleTheme() {
      isDarkMode = !isDarkMode;
      
      // ‰øùÂ≠òÁî®Êà∑ÈÄâÊã©
      userThemePreference = isDarkMode ? 'dark' : 'light';
      localStorage.setItem('theme-preference', userThemePreference);
      
      // Êõ¥Êñ∞‰∏ªÈ¢òÂõæÊ†á
      updateThemeToggleIcon();
      
      // Â∫îÁî®‰∏ªÈ¢ò
      applyTheme();
    }
    
    // Ê†ºÂºèÂåñÊú∫ÊûÑÂêçÁß∞ÔºåÂéªÊéâ(‰ª£ÂÆ¢)Â≠óÊ†∑
    const formatInstitutionName = (name) => {
      if (!name) return '';
      return name.replace(/\(‰ª£ÂÆ¢\)$/, '');
    };

    const setPresetTime = (preset) => {
      const now = new Date();
      let newStartDate = new Date();

      switch (preset) {
        case 'today':
          newStartDate = new Date(now);
          break;
        case '1w':
          newStartDate.setDate(now.getDate() - 7);
          break;
        case '1m':
          newStartDate.setMonth(now.getMonth() - 1);
          break;
        case '3m':
          newStartDate.setMonth(now.getMonth() - 3);
          break;
        case '6m':
          newStartDate.setMonth(now.getMonth() - 6);
          break;
        case '1y':
          newStartDate.setFullYear(now.getFullYear() - 1);
          break;
        default:
          newStartDate = new Date(now);
      }

      startDate = newStartDate.toISOString().slice(0, 10);
      endDate = now.toISOString().slice(0, 10);

      document.getElementById('startDate').value = startDate;
      document.getElementById('endDate').value = endDate;

      fetchData();
    };

    const fetchVarietyList = async () => {
      showLoading(true);
      
      try {
        // Ê£ÄÊü•ÊòØÂê¶ÊúâÁºìÂ≠òÁöÑÂìÅÁßçÂàóË°®
        const cacheKey = 'variety_list';
        if (cachedData[cacheKey]) {
          console.log('‰ΩøÁî®ÁºìÂ≠òÁöÑÂìÅÁßçÂàóË°®');
          varietyList.length = 0;
          varietyList.push(...cachedData[cacheKey].data);
          
          if (varietyList.length > 0) {
            selectedVariety = varietyList[0].dm;
            updateVarietyOptions(varietyList);
            
            // Â§ÑÁêÜURLÂèÇÊï∞
            handleUrlParams();
            
            showLoading(false);
            return;
          }
        }
        
        const response = await axios.get('https://q.889.ink');
        let jsonpData;

        if (typeof response.data === 'string') {
          jsonpData = response.data.replace(/^aaa_callback\(/, '').replace(/\);$/, '');
          jsonpData = JSON.parse(jsonpData);
        } else {
          jsonpData = response.data;
        }

        if (jsonpData && jsonpData.list) {
          varietyList.length = 0; // Clear existing list
          varietyList.push(...jsonpData.list);
          
          // ‰øùÂ≠òÂà∞ÁºìÂ≠ò
          cachedData[cacheKey] = {
            data: varietyList,
            timestamp: new Date().toISOString()
          };
          saveCacheToStorage();

          if (varietyList.length > 0) {
            selectedVariety = varietyList[0].dm;
            updateVarietyOptions(varietyList);
            
            // Â§ÑÁêÜURLÂèÇÊï∞
            handleUrlParams();
          }
        }
        
        showLoading(false);
      } catch (error) {
        console.error('Ëé∑ÂèñÂìÅÁßçÂàóË°®Â§±Ë¥•:', error);
        showLoading(false);
        
        // Â∞ùËØï‰ªéÁºìÂ≠òËé∑ÂèñÂìÅÁßçÂàóË°®
        const cacheKey = 'variety_list';
        if (cachedData[cacheKey]) {
          console.log('Ëé∑ÂèñÂìÅÁßçÂàóË°®Â§±Ë¥•Ôºå‰ΩøÁî®ÁºìÂ≠òÊï∞ÊçÆ');
          varietyList.length = 0;
          varietyList.push(...cachedData[cacheKey].data);
          
          if (varietyList.length > 0) {
            selectedVariety = varietyList[0].dm;
            updateVarietyOptions(varietyList);
            
            // Â§ÑÁêÜURLÂèÇÊï∞
            handleUrlParams();
          }
        }
      }
    };
    
    // Â§ÑÁêÜURLÂèÇÊï∞
    const handleUrlParams = () => {
      const urlParams = new URLSearchParams(window.location.search);
      const varietyParam = urlParams.get('variety');
      
      if (varietyParam && varietyList.length > 0) {
        // Êü•ÊâæÂåπÈÖçÁöÑÂìÅÁßç
        const matchedVariety = varietyList.find(item => 
          item.dm.replace(/\d+$/, '').toLowerCase() === varietyParam.toLowerCase());
        if (matchedVariety) {
          selectedVariety = matchedVariety.dm;
          document.getElementById('variety').value = selectedVariety;
          fetchData();
        } else {
          fetchData(); // Â¶ÇÊûúÊ≤°ÊúâÂåπÈÖçÁöÑÂìÅÁßçÔºå‰ΩøÁî®ÈªòËÆ§ÈÄâ‰∏≠ÁöÑÂìÅÁßç
        }
      } else {
        fetchData(); // Â¶ÇÊûúÊ≤°ÊúâÂìÅÁßçÂèÇÊï∞Ôºå‰ΩøÁî®ÈªòËÆ§ÈÄâ‰∏≠ÁöÑÂìÅÁßç
      }
    };

    const fetchData = async () => {
      if (!selectedVariety) return;
      
      showLoading(true);
      showCacheWarning(false);
      isUsingCache = false;
      
      try {
        const market = varietyList.find(item => item.dm === selectedVariety)?.sc;
        const variety = selectedVariety.replace(/\d+$/, '');
        
        // ÊûÑÂª∫ÁºìÂ≠òÈîÆ
        const cacheKey = `${variety}_${market}_${startDate.replace(/-/g, '')}_${endDate.replace(/-/g, '')}`;
        
        // Ê£ÄÊü•ÂΩìÂâçÊó∂Èó¥ÊòØÂê¶Âú®Êï∞ÊçÆÊõ¥Êñ∞Êó∂Èó¥ÊÆµÂÜÖÔºà15:30-17:00Ôºâ
        const now = new Date();
        const hours = now.getHours();
        const minutes = now.getMinutes();
        const isUpdateTime = (hours === 15 && minutes >= 30) || (hours === 16);
        
        // Ê£ÄÊü•ÊòØÂê¶ÊúâÁºìÂ≠òÊï∞ÊçÆ‰∏î‰∏çÂú®Êõ¥Êñ∞Êó∂Èó¥ÊÆµÂÜÖ
        if (cachedData[cacheKey] && !isUpdateTime) {
          console.log(`‰ΩøÁî®ÁºìÂ≠òÊï∞ÊçÆ: ${cacheKey}`);
          companyPals = cachedData[cacheKey].data;
          isUsingCache = true;
          
          // ÊòæÁ§∫ÁºìÂ≠òË≠¶Âëä
          showCacheWarning(true, `‰ΩøÁî®ÁºìÂ≠òÊï∞ÊçÆ (${new Date(cachedData[cacheKey].timestamp).toLocaleString()})`);
          renderCompanyList();
          showLoading(false);
          return;
        }
        
        const response = await axios.get(
          'https://q.889.ink/commodity_profit', {
            params: {
              startDate: startDate.replace(/-/g, ''),
              endDate: endDate.replace(/-/g, ''),
              variety: variety,
              market: market,
              initFlag: 0
            }
          }
        );
        
        if (response.data.code === 10000) {
          companyPals = response.data.data.companyPals;
          
          // ‰øùÂ≠òÂà∞ÁºìÂ≠ò
          cachedData[cacheKey] = {
            data: companyPals,
            timestamp: new Date().toISOString()
          };
          saveCacheToStorage();
          
          renderCompanyList();
        }
        
        showLoading(false);
      } catch (error) {
        console.error('Ëé∑ÂèñÊï∞ÊçÆÂ§±Ë¥•:', error);
        
        // Â∞ùËØï‰ªéÁºìÂ≠òËé∑ÂèñÊï∞ÊçÆ
        const market = varietyList.find(item => item.dm === selectedVariety)?.sc;
        const variety = selectedVariety.replace(/\d+$/, '');
        const cacheKey = `${variety}_${market}_${startDate.replace(/-/g, '')}_${endDate.replace(/-/g, '')}`;
        
        if (cachedData[cacheKey]) {
          console.log(`Ëé∑ÂèñÊï∞ÊçÆÂ§±Ë¥•Ôºå‰ΩøÁî®ÁºìÂ≠òÊï∞ÊçÆ: ${cacheKey}`);
          companyPals = cachedData[cacheKey].data;
          isUsingCache = true;
          
          // ÊòæÁ§∫ÁºìÂ≠òË≠¶Âëä
          showCacheWarning(true, `Ëé∑ÂèñÊï∞ÊçÆÂ§±Ë¥•Ôºå‰ΩøÁî®ÁºìÂ≠òÊï∞ÊçÆ (${new Date(cachedData[cacheKey].timestamp).toLocaleString()})`);
          renderCompanyList();
        }
        
        showLoading(false);
      }
    };

    const updateVarietyOptions = (varietyList) => {
      const selectElement = document.getElementById('variety');
      selectElement.innerHTML = ''; // Clear existing options

      varietyList.forEach(item => {
        const option = document.createElement('option');
        option.value = item.dm;
        option.textContent = removeTrailingDigits(item.name);
        selectElement.appendChild(option);
      });

      selectElement.value = selectedVariety; // Set selected value
    };

    const removeTrailingDigits = (str) => {
      return str.replace(/\d+$/, '');
    };

    const formatValue = (value) => {
      return (value / 10000).toFixed(2) + '‰∏á';
    };

    const getBarWidth = (value) => {
      const maxValue = Math.max(...companyPals.map(c => Math.abs(c.fluctuatePal)), 1);
      return `${(Math.abs(value) / maxValue) * 80}%`;
    };

    const renderCompanyList = () => {
      const companyListElement = document.getElementById('companyList');
      companyListElement.innerHTML = ''; // Clear existing list

      const sortedCompanyPals = [...companyPals].sort((a, b) => b.fluctuatePal - a.fluctuatePal);
      const visibleCompanies = [...sortedCompanyPals.slice(0, 5), ...sortedCompanyPals.slice(-5)];

      visibleCompanies.forEach(company => {
        const companyItem = document.createElement('div');
        companyItem.className = 'company-item';

        const companyName = document.createElement('span');
        companyName.className = 'company-name';
        companyName.textContent = formatInstitutionName(company.companyName);
        companyName.style.cursor = 'pointer';
        companyName.title = 'ÁÇπÂáªÊü•ÁúãÂÖ¨Âè∏ÊåÅ‰ªì';
        companyName.addEventListener('click', function() {
          window.location.href = `companyholding.html?company=${encodeURIComponent(company.companyName)}`;
        });

        const companyValue = document.createElement('span');
        companyValue.className = 'company-value';
        if (company.fluctuatePal > 0) {
          companyValue.classList.add('profit');
        } else if (company.fluctuatePal < 0) {
          companyValue.classList.add('loss');
        }
        companyValue.textContent = formatValue(company.fluctuatePal);

        const bar = document.createElement('div');
        bar.className = 'bar';
        bar.style.width = getBarWidth(company.fluctuatePal);
        bar.style.backgroundColor = company.fluctuatePal > 0 ? 'var(--positive-color)' : 'var(--negative-color)';

        companyItem.appendChild(companyName);
        companyItem.appendChild(companyValue);
        companyItem.appendChild(bar);

        companyListElement.appendChild(companyItem);
      });
    };
    
    // ÊòæÁ§∫/ÈöêËóèÂä†ËΩΩÊåáÁ§∫Âô®
    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'flex' : 'none';
    }
    
    // ÊòæÁ§∫/ÈöêËóèÁºìÂ≠òË≠¶Âëä
    function showCacheWarning(show, message = '‰ΩøÁî®ÁºìÂ≠òÊï∞ÊçÆ') {
      const warningElement = document.getElementById('cache-warning');
      if (warningElement) {
        warningElement.style.display = show ? 'block' : 'none';
        if (message) {
          warningElement.textContent = message;
        }
      }
    }
    
    // ‰øùÂ≠òÁºìÂ≠òÂà∞localStorage
    function saveCacheToStorage() {
      try {
        // Ê∏ÖÁêÜËøáÊúüÁºìÂ≠ò
        cleanExpiredCache();
        
        // ‰øùÂ≠òÂΩìÂâçÁºìÂ≠ò
        localStorage.setItem('commodity_profit_cache', JSON.stringify(cachedData));
        console.log('ÁºìÂ≠òÂ∑≤‰øùÂ≠òÂà∞localStorage');
      } catch (error) {
        console.error('‰øùÂ≠òÁºìÂ≠òÂ§±Ë¥•:', error);
      }
    }
    
    // ‰ªélocalStorageÂä†ËΩΩÁºìÂ≠ò
    function loadCacheFromStorage() {
      try {
        const cachedString = localStorage.getItem('commodity_profit_cache');
        if (cachedString) {
          cachedData = JSON.parse(cachedString);
          console.log('‰ªélocalStorageÂä†ËΩΩÁºìÂ≠òÊàêÂäü');
          
          // Ê∏ÖÁêÜËøáÊúüÁºìÂ≠ò
          cleanExpiredCache();
        }
      } catch (error) {
        console.error('Âä†ËΩΩÁºìÂ≠òÂ§±Ë¥•:', error);
        cachedData = {};
      }
    }
    
    // Ê∏ÖÁêÜËøáÊúüÁºìÂ≠ò
    function cleanExpiredCache() {
      const now = new Date();
      const expiryTime = CACHE_EXPIRY_DAYS * 24 * 60 * 60 * 1000; // ËΩ¨Êç¢‰∏∫ÊØ´Áßí
      
      for (const key in cachedData) {
        const cacheTime = new Date(cachedData[key].timestamp).getTime();
        if (now.getTime() - cacheTime > expiryTime) {
          console.log(`Âà†Èô§ËøáÊúüÁºìÂ≠ò: ${key}`);
          delete cachedData[key];
        }
      }
    }
  </script>
</body>

</html>