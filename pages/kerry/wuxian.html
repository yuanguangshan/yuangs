<!DOCTYPE html><html lang="zh"><head><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Êó†ÈôêÂú∞ÂõæÊäΩÂç°Ê∏∏Êàè</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        /* Èü≥ÊïàÊéßÂà∂ÊåâÈíÆÊ†∑Âºè */
        #soundToggle {
            position: absolute;
            top: 20px;
            right: 290px; /* Adjusted position to align with other buttons */
            width: 80px; /* Unified size */
            height: 80px; /* Unified size */
            background: linear-gradient(145deg, #FF6347, #CD5C5C); /* Tomato gradient */
            border-radius: 15px; /* Unified style */
            border: 2px solid #B22222;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px; /* Unified font size */
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            z-index: 10;
            cursor: pointer;
            box-shadow: 0 6px 12px rgba(0,0,0,0.3), inset 0 2px 4px rgba(255,255,255,0.2);
            transition: all 0.3s ease;
        }
        #soundToggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255,255,255,0.3);
        }
        #soundToggle:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2), inset 0 1px 2px rgba(0,0,0,0.1);
        }
        #soundToggle.muted {
            background: linear-gradient(145deg, #808080, #696969); /* Grey gradient when muted */
            border: 2px solid #505050;
        }
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
            touch-action: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            background-color: #f0f0f0;
            overflow: hidden;
        }
        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            background-color: #e0e0e0;
        }
        .ui-button {
            position: absolute;
            width: 80px;
            height: 80px;
            background: linear-gradient(145deg, #4CAF50, #388E3C); /* Green gradient */
            border-radius: 15px; /* Slightly more rounded corners */
            border: 2px solid #2E7D32; /* Darker green border */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 36px;
            font-weight: bold;
            color: white; /* White text for contrast */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5); /* Text shadow for readability */
            user-select: none;
            z-index: 10;
            box-shadow: 0 6px 12px rgba(0,0,0,0.3), inset 0 2px 4px rgba(255,255,255,0.2); /* Enhanced shadow */
            cursor: pointer; /* Indicate interactivity */
            transition: all 0.2s ease; /* Smooth transitions */
            touch-action: manipulation;
        }
        .ui-button:hover {
            transform: translateY(-2px); /* Lift effect on hover */
            box-shadow: 0 8px 16px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255,255,255,0.3); /* Stronger shadow on hover */
        }
        .ui-button:active {
            transform: translateY(0); /* Press effect */
            box-shadow: 0 2px 4px rgba(0,0,0,0.2), inset 0 1px 2px rgba(0,0,0,0.1); /* Subtler shadow on active */
        }
        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 100; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.7); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 10px;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation-name: animatetop;
            animation-duration: 0.4s
        }
        /* Add Animation */
        @keyframes animatetop {
            from {top: -300px; opacity: 0}
            to {top: 0; opacity: 1}
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-content h2 {
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }
        .modal-content p {
            color: #555;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        .modal-content ul {
            list-style-type: disc;
            margin-left: 20px;
            margin-bottom: 10px;
        }
        .modal-content ul li {
            margin-bottom: 5px;
        }
        .modal-content h3 {
            color: #444;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        /* Ë∞ÉÊï¥ÊåâÈíÆ‰ΩçÁΩÆÔºåÁ°Æ‰øùÂÆÉ‰ª¨Âú®iPad‰∏äÂèØËßÅ */
        @media (min-width: 768px) { /* Apply original styles for iPad and desktop */
            .ui-button {
                width: 80px;
                height: 80px;
                font-size: 36px;
            }
            #upButton {
                bottom: 220px;
                left: 100px;
            }
            #leftButton {
                bottom: 140px;
                left: 20px;
            }
            #downButton {
                bottom: 60px;
                left: 100px;
            }
            #rightButton {
                bottom: 140px;
                left: 180px;
            }
            #attackButton {
                bottom: 140px;
                right: 60px; /* ÁßªÂä®Âà∞Âè≥Ëæπ */
                width: 120px;
                height: 120px;
                font-size: 28px;
                background: linear-gradient(145deg, #FF4500, #DC143C); /* OrangeRed gradient */
                border-radius: 50%; /* Keep it circular */
                border: 2px solid #8B0000;
                color: white;
                text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
                box-shadow: 0 6px 12px rgba(0,0,0,0.3), inset 0 2px 4px rgba(255,255,255,0.2);
                transition: all 0.2s ease;
            }
            #attackButton:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 16px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255,255,255,0.3);
            }
            #attackButton:active {
                transform: translateY(0);
                box-shadow: 0 2px 4px rgba(0,0,0,0.2), inset 0 1px 2px rgba(0,0,0,0.1);
            }
            #joystickContainer {
                position: absolute;
                width: 200px;
                height: 200px;
                bottom: 60px;
                right: 200px;
                transform: none;
                z-index: 20;
            }
            #outerCircle {
                width: 180px;
                height: 180px;
                left: 10px;
                top: 10px;
            }
            #middleCircle {
                width: 120px;
                height: 120px;
                left: 40px;
                top: 40px;
            }
            #innerCircle {
                width: 60px;
                height: 60px;
                left: 70px;
                top: 70px;
            }
            #shopButton, #cardSlotButton, #helpButton, #soundToggle {
                width: 80px;
                height: 80px;
                font-size: 24px;
                border-radius: 10px; /* Unified style */
            }
            #shopButton {
                top: 20px;
                right: 20px;
            }
            #cardSlotButton {
                top: 20px;
                right: 110px;
            }
            #helpButton {
                top: 20px;
                right: 200px;
            }
            #soundToggle {
                top: 20px;
                right: 290px;
            }
            #statsContainer {
                top: 20px;
                left: 20px;
                font-size: 24px;
                padding: 15px;
            }
        }

        /* Mobile-specific styles */
        @media (max-width: 767px) {
            .ui-button {
                width: 60px;
                height: 60px;
                font-size: 24px;
            }
            #upButton {
                bottom: 140px;
                left: 70px;
            }
            #leftButton {
                bottom: 80px;
                left: 10px;
            }
            #downButton {
                bottom: 20px;
                left: 70px;
            }
            #rightButton {
                bottom: 80px;
                left: 130px;
            }
            #attackButton {
                bottom: 60px;
                right: 20px; /* ÁßªÂä®Âà∞Âè≥Ëæπ */
                width: 90px;
                height: 90px;
                font-size: 20px;
                background: linear-gradient(145deg, #FF4500, #DC143C); /* OrangeRed gradient */
                border-radius: 50%; /* Keep it circular */
                border: 2px solid #8B0000;
                color: white;
                text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
                box-shadow: 0 6px 12px rgba(0,0,0,0.3), inset 0 2px 4px rgba(255,255,255,0.2);
                transition: all 0.2s ease;
            }
            #attackButton:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 16px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255,255,255,0.3);
            }
            #attackButton:active {
                transform: translateY(0);
                box-shadow: 0 2px 4px rgba(0,0,0,0.2), inset 0 1px 2px rgba(0,0,0,0.1);
            }
            #joystickContainer {
                position: absolute;
                width: 150px;
                height: 150px;
                bottom: 20px;
                right: 130px; 
                transform: none;
                z-index: 20;
            }
            #outerCircle {
                width: 140px;
                height: 140px;
                left: 5px;
                top: 5px;
            }
            #middleCircle {
                width: 90px;
                height: 90px;
                left: 30px;
                top: 30px;
            }
            #innerCircle {
                width: 40px;
                height: 40px;
                left: 55px;
                top: 55px;
            }
            #shopButton, #cardSlotButton, #helpButton, #soundToggle {
                width: 60px;
                height: 60px;
                font-size: 20px;
                border-radius: 10px; /* Unified style */
            }
            #shopButton {
                top: 10px;
                right: 10px;
            }
            #cardSlotButton {
                top: 10px;
                right: 80px;
            }
            #helpButton {
                top: 10px;
                right: 150px;
            }
            #soundToggle {
                top: 10px;
                right: 220px;
            }
            #statsContainer {
                font-size: 20px;
                padding: 12px;
                top: 10px;
                left: 10px;
            }
        }
        .circle {
            position: absolute;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.5);
        }
        #outerCircle {
            width: 180px;
            height: 180px;
            left: 10px;
            top: 10px;
            border: 2px solid rgba(100, 100, 100, 0.5);
        }
        #middleCircle {
            width: 120px;
            height: 120px;
            left: 40px;
            top: 40px;
            background-color: rgba(100, 100, 255, 0.5);
            cursor: pointer;
        }
        #innerCircle {
            width: 60px;
            height: 60px;
            left: 70px;
            top: 70px;
            background-color: rgba(200, 200, 255, 0.8);
        }
        #shopButton {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 80px;
            height: 80px;
            background: linear-gradient(145deg, #FFD700, #FFA500); /* Gold gradient */
            border-radius: 15px;
            border: 2px solid #CC8400;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: #333; /* Dark text for contrast */
            text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
            z-index: 10;
            cursor: pointer;
            box-shadow: 0 6px 12px rgba(0,0,0,0.3), inset 0 2px 4px rgba(255,255,255,0.2);
            transition: all 0.2s ease;
        }
        #shopButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255,255,255,0.3);
        }
        #shopButton:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2), inset 0 1px 2px rgba(0,0,0,0.1);
        }
        #cardSlotButton {
            position: absolute;
            top: 20px;
            right: 110px;
            width: 80px;
            height: 80px;
            background: linear-gradient(145deg, #6A5ACD, #483D8B); /* SlateBlue gradient */
            border-radius: 15px;
            border: 2px solid #3A306B;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            z-index: 10;
            cursor: pointer;
            box-shadow: 0 6px 12px rgba(0,0,0,0.3), inset 0 2px 4px rgba(255,255,255,0.2);
            transition: all 0.2s ease;
        }
        #cardSlotButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255,255,255,0.3);
        }
        #cardSlotButton:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2), inset 0 1px 2px rgba(0,0,0,0.1);
        }
        /* Ê∑ªÂä†ÈóÆÂè∑ÊåâÈíÆÊ†∑Âºè */
        #helpButton {
            position: absolute;
            top: 20px;
            right: 200px;
            width: 80px;
            height: 80px;
            background: linear-gradient(145deg, #1E90FF, #0000CD); /* DodgerBlue gradient */
            border-radius: 15px;
            border: 2px solid #00008B;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            z-index: 10;
            cursor: pointer;
            box-shadow: 0 6px 12px rgba(0,0,0,0.3), inset 0 2px 4px rgba(255,255,255,0.2);
            transition: all 0.2s ease;
        }
        #helpButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255,255,255,0.3);
        }
        #helpButton:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2), inset 0 1px 2px rgba(0,0,0,0.1);
        }
        #statsContainer {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
            font-size: 24px;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            font-family: 'Press Start 2P', cursive;
            color: #ffd700; /* Gold color */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        #cardRevealModal {
            background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
            overflow: hidden;
        }

        .star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            animation: twinkle 2s infinite ease-in-out;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.2; transform: scale(0.8); }
        }
        .modal-content {
            background-color: white;
            width: 90%;
            max-width: 800px;
            border-radius: 15px;
            padding: 30px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .modal-header h2 {
            font-size: 32px;
            margin: 0;
        }
        .close-button {
            font-size: 36px;
            cursor: pointer;
            padding: 10px;
        }
        .card {
            width: 160px;
            height: 240px;
            background-color: #f0f0f0;
            border-radius: 15px;
            border: 3px solid #aaa;
            margin: 15px;
            display: inline-flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            box-sizing: border-box;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        .card-title {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
        }
        .card-image {
            width: 100px;
            height: 100px;
            background-color: #ddd;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
        }
        .card-description {
            font-size: 12px;
            text-align: center;
        }
        .card-slot-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 30px;
        }
        .card-slot {
            width: 200px;
            height: 300px;
            background-color: #e0e0e0;
            border-radius: 12px;
            border: 3px dashed #aaa;
            margin: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            color: #999;
        }
        .card-slot.filled {
            border: 3px solid #5a5;
            background-color: #efe;
        }
        .card-preview {
            width: 190px;
            height: 280px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            box-sizing: border-box;
            background-color: white;
        }
        .card-preview-title {
            font-size: 20px;
            font-weight: bold;
            text-align: center;
        }
        .card-preview-image {
            width: 170px;
            height: 170px;
            background-color: #ddd;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
        }
        .shop-section {
            text-align: center;
            margin-bottom: 30px;
        }
        .shop-section #shopCoinsDisplay {
            font-size: 28px;
            margin-bottom: 20px;
        }
        .buy-button {
            background-color: #5a5;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 15px 30px;
            font-size: 24px;
            cursor: pointer;
            margin-top: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .buy-button:hover {
            background-color: #494;
        }
        .shop-card-price {
            margin-top: 15px;
            font-weight: bold;
            font-size: 24px;
        }
        .slot-section-title {
            text-align: center;
            font-weight: bold;
            margin: 20px 0;
            padding: 10px;
            background-color: #eee;
            border-radius: 10px;
            font-size: 24px;
        }
        /* Ê∏∏ÊàèËØ¥ÊòéÊ†∑Âºè */
        .help-section {
            margin-bottom: 20px;
        }
        .help-section h3 {
            margin-top: 25px;
            margin-bottom: 10px;
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }
        .help-section p {
            margin: 10px 0;
            line-height: 1.5;
            font-size: 18px;
        }
        .help-section ul {
            margin: 10px 0;
            padding-left: 25px;
        }
        .help-section li {
            margin: 8px 0;
            line-height: 1.4;
            font-size: 16px;
        }
        .help-section .card-types {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            margin: 15px 0;
        }
        .help-section .card-type {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 8px;
            margin: 5px;
            width: 30%;
            min-width: 200px;
        }
        /* Ë°ÄÊù°Ê†∑Âºè */
        .health-bar {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 20px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
            z-index: 15;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff4444, #ff6666);
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        
        .health-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        
        /* BossË°ÄÊù°Ê†∑Âºè */
        .boss-health-bar {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 25px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 12px;
            overflow: hidden;
            z-index: 15;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            display: none;
        }
        
        .boss-health-fill {
            height: 100%;
            background: linear-gradient(90deg, #8B0000, #DC143C);
            border-radius: 12px;
            transition: width 0.3s ease;
        }
        
        .boss-health-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        
        .boss-health-label {
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            color: #ff4444;
            font-size: 16px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            display: none;
            z-index: 15;
        }
        
        /* BuffÂõæÊ†áÊ†∑Âºè */
        .buff-icons {
            position: absolute;
            top: 100px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 15;
        }
        
        .buff-icon {
            width: 50px;
            height: 50px;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .buff-icon::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        
        .buff-icon:hover::after {
            opacity: 1;
        }
        
        /* ‰∏∫iPadÊ∑ªÂä†ÁöÑÈ¢ùÂ§ñÊ†∑Âºè */
        @media (min-width: 768px) and (max-width: 1024px) {
            .ui-button {
                width: 100px;
                height: 100px;
                font-size: 48px;
            }
            #upButton {
                bottom: 280px;
                left: 120px;
            }
            #leftButton {
                bottom: 180px;
                left: 20px;
            }
            #downButton {
                bottom: 80px;
                left: 120px;
            }
            #rightButton {
                bottom: 180px;
                left: 220px;
            }
            #attackButton {
                bottom: 180px;
                right: 80px; /* ÁßªÂä®Âà∞Âè≥Ëæπ */
                width: 150px;
                height: 150px;
                font-size: 36px;
            }
            #joystickContainer {
                position: absolute;
                width: 250px;
                height: 250px;
                bottom: 100px;
                right: 250px;
                z-index: 20;
            }
            #outerCircle {
                width: 230px;
                height: 230px;
            }
            #middleCircle {
                width: 160px;
                height: 160px;
                left: 45px;
                top: 45px;
            }
            #innerCircle {
                width: 80px;
                height: 80px;
                left: 85px;
                top: 85px;
            }
            #statsContainer {
                font-size: 28px;
                padding: 20px;
            }
            #helpButton {
                width: 100px;
                height: 100px;
                font-size: 50px;
                right: 220px;
            }
        }

        #cardRevealModal .modal-content {
            display: flex;
            flex-direction: column; /* Changed to column for centering title */
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow: hidden; /* ÈöêËóèÊªöÂä®Êù° */
            width: 70%; /* Adjusted width */
            max-width: 1050px; /* Adjusted max-width */
            max-height: 90vh;
            padding: 40px;
        }

        #revealedCardContainer {
            display: flex;
            width: 100%;
            align-items: center;
        }

        .revealed-card-image {
            flex: 1;
            text-align: center;
            animation: slide-in-left 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        .revealed-card-details {
            flex: 1;
            padding: 20px;
            color: white;
            animation: slide-in-right 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.3s forwards;
            opacity: 0;
        }

        .revealed-card-details h2 {
            font-size: 3em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .reveal-title {
            font-size: 2.5em;
            color: #ffd700;
            text-shadow: 0 0 5px #ffd700, 0 0 10px #ffd700, 0 0 20px #ffc400, 0 0 30px #ffc400, 0 0 40px #ff8c00, 2px 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 20px; /* Adjusted margin */
            animation: fade-in-down 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.2s forwards;
            opacity: 0;
            text-align: center; /* Centered the title */
        }

        @keyframes fade-in-down {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .revealed-card-details p {
            font-size: 1.5em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .author-credit {
            font-size: 1em;
            color: rgba(255, 255, 255, 0.7);
            text-align: right;
            margin-top: 30px;
            font-style: italic;
            animation: fade-in-up 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.8s forwards;
            opacity: 0;
        }

        @keyframes fade-in-up {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slide-in-left {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slide-in-right {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Âç°ÁâåÊè≠Á§∫ÊïàÊûú */
        .reveal-content {
            animation: reveal-scale 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes reveal-scale {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #f00;
            opacity: 0;
            animation: confetti-burst 1.5s ease-out forwards;
        }

        @keyframes confetti-burst {
            0% {
                transform: translate(0, 0) rotateZ(0);
                opacity: 1;
            }
            100% {
                transform: translate(var(--end-x), var(--end-y)) rotateZ(var(--end-rot));
                opacity: 0;
            }
        }

        /* Shop Beautification */
        #shopModal .modal-content {
            background: #2c1e12;
            background-image: radial-gradient(circle at center, #4a321f 0%, #2c1e12 70%);
            border: 2px solid #a88562;
            color: #f5eeda;
            box-shadow: 0 10px 30px rgba(0,0,0,0.7), inset 0 0 20px rgba(0,0,0,0.5);
        }

        #shopModal .modal-header {
            border-bottom: 1px solid rgba(168, 133, 98, 0.5);
            padding-bottom: 15px;
        }

        #shopModal .modal-header h2 {
            color: #ffd700;
            font-family: 'serif';
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            font-size: 40px;
        }

        #shopModal .close-button {
            color: #f5eeda;
            transition: color 0.3s;
        }

        #shopModal .close-button:hover {
            color: #ffd700;
        }

        #shopModal .card {
            background: transparent;
            border: none;
            box-shadow: none;
            height: auto;
        }
        
        #shopModal .card-title, #shopModal .card-description {
            color: #f5eeda;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.6);
        }

        #shopModal .shop-card-price {
            color: #ffd700;
            font-size: 28px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
            margin-top: 0;
        }

        #shopModal .buy-button {
            background: linear-gradient(180deg, #f0c14b, #d8a10e);
            border: 1px solid #a88562;
            border-radius: 10px;
            color: #111;
            font-weight: bold;
            text-shadow: 1px 1px 1px rgba(255,255,255,0.3);
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
            transition: all 0.2s ease;
            padding: 20px 40px;
            font-size: 28px;
        }

        #shopModal .buy-button:hover {
            background: linear-gradient(180deg, #f5d07a, #e2b12e);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        
        <div id="statsContainer">
            <div id="healthDisplay">Ë°ÄÈáè: 100</div>
            <div id="coinsDisplay">ÈìúÊùø: 0</div>
        </div>
        
        <div id="shopButton"><i class="fas fa-store"></i></div>
        <div id="cardSlotButton"><i class="fas fa-id-card"></i></div> <!-- Changed icon for better representation -->
        <div id="helpButton"><i class="fas fa-question"></i></div>
        <div id="helpModal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="closeHelp">&times;</span>
                <h2>Ê∏∏ÊàèÂ∏ÆÂä©</h2>
                <p>Ê¨¢ËøéÊù•Âà∞‰øÆ‰ªô‰∏ñÁïåÔºÅ</p>
                <p>‰Ω†ÁöÑÁõÆÊ†áÊòØÊèêÂçá‰øÆ‰∏∫ÔºåÂáªË¥•Â¶ñÈ≠îÔºåÊúÄÁªàÈ£ûÂçáÊàê‰ªô„ÄÇ</p>
                <h3>Êìç‰ΩúÊåáÂçóÔºö</h3>
                <ul>
                    <li>‰ΩøÁî®ÊñπÂêëÈîÆÊàñWASDÁßªÂä®ËßíËâ≤„ÄÇ</li>
                    <li>ÁÇπÂáªÊäÄËÉΩÂõæÊ†áÊàñ‰ΩøÁî®Âø´Êç∑ÈîÆÈáäÊîæÊäÄËÉΩ„ÄÇ</li>
                    <li>Êî∂ÈõÜÊéâËêΩÁöÑÁâ©ÂìÅÂíåÁªèÈ™å„ÄÇ</li>
                    <li>Âú®ÂïÜÂ∫óË¥≠‰π∞Ë£ÖÂ§áÂíåÈÅìÂÖ∑„ÄÇ</li>
                    <li>ÈÄöËøáÂç°ÊßΩË£ÖÂ§áÂøÉÊ≥ïÂíåÊ≥ïÂÆù„ÄÇ</li>
                </ul>
                <h3>Ê∏∏ÊàèÊèêÁ§∫Ôºö</h3>
                <ul>
                    <li>ÂêàÁêÜÊê≠ÈÖçÊäÄËÉΩÂíåË£ÖÂ§áÔºåÂ∫îÂØπ‰∏çÂêåÊïå‰∫∫„ÄÇ</li>
                    <li>Ê≥®ÊÑèË°ÄÈáèÂíåÊ≥ïÂäõÔºåÂèäÊó∂Ë°•ÂÖÖ„ÄÇ</li>
                    <li>Êé¢Á¥¢Âú∞ÂõæÔºåÂèëÁé∞ÈöêËóèÁöÑÂÆùËóèÂíå‰ªªÂä°„ÄÇ</li>
                    <li>‰∏çÊñ≠ÊåëÊàòÊõ¥Âº∫Â§ßÁöÑÊïå‰∫∫ÔºåËé∑ÂèñÁ®ÄÊúâÊùêÊñô„ÄÇ</li>
                </ul>
            </div>
        </div>
        <div id="soundToggle">üîä</div>
        
        <!-- Controls are re-arranged: Movement on left, Actions on right -->
        <div class="ui-button" id="upButton">‚Üë</div>
        <div class="ui-button" id="leftButton">‚Üê</div>
        <div class="ui-button" id="downButton">‚Üì</div>
        <div class="ui-button" id="rightButton">‚Üí</div>
        <div class="ui-button" id="attackButton">ÊîªÂáª</div>
        
        <div id="joystickContainer">
            <div class="circle" id="outerCircle"></div>
            <div class="circle" id="middleCircle"></div>
            <div class="circle" id="innerCircle"></div>
        </div>
    </div>
    
    <div class="modal" id="shopModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ÂïÜÂ∫ó</h2>
                <span class="close-button" id="closeShop">√ó</span>
            </div>
            <div class="shop-section">
                <div id="shopCoinsDisplay">ÂΩìÂâçÈìúÊùø: 0</div>
                <div class="card">
                    <div class="card-title">Âç°ÂåÖ</div>
                    <div class="card-image">
                        <svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <radialGradient id="glow" cx="50%" cy="50%" r="50%" fx="50%" fy="50%">
                                    <stop offset="0%" style="stop-color:gold;stop-opacity:0.8" />
                                    <stop offset="100%" style="stop-color:gold;stop-opacity:0" />
                                </radialGradient>
                                <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
                                    <feDropShadow dx="0" dy="5" stdDeviation="5" flood-color="rgba(0,0,0,0.5)"/>
                                </filter>
                            </defs>
                            <g filter="url(#shadow)">
                                <path d="M20,80 Q50,90 80,80 L85,50 Q50,60 15,50 Z" fill="#6B4226"/>
                                <path d="M15,50 L85,50 L80,30 Q50,20 20,30 Z" fill="#8A5A2E"/>
                                <rect x="10" y="25" width="80" height="10" fill="#A0522D" rx="3"/>
                                <rect x="45" y="40" width="10" height="15" fill="#4F4F4F"/>
                                <circle cx="50" cy="30" r="5" fill="gold"/>
                            </g>
                            <circle cx="50" cy="50" r="40" fill="url(#glow)">
                                <animate attributeName="r" from="30" to="45" dur="2s" begin="0s" repeatCount="indefinite" />
                                <animate attributeName="opacity" from="0.8" to="0.4" dur="2s" begin="0s" repeatCount="indefinite" />
                            </circle>
                        </svg>
                    </div>
                    <div class="card-description">ÈöèÊú∫Ëé∑Âæó‰∏ÄÂº†Âç°Áâå</div>
                </div>
                <div class="shop-card-price">‰ª∑Ê†º: 50 ÈìúÊùø</div>
                <button class="buy-button" id="buyCardButton">Ë¥≠‰π∞</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="cardSlotModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Âç°ÊßΩ</h2>
                <span class="close-button" id="closeCardSlot">√ó</span>
            </div>
            
            <div class="slot-section-title">Êû™Ê¢∞Âç°ÊßΩ</div>
            <div class="card-slot-container" id="gunCardSlots">
                <div class="card-slot" data-slot="0" data-type="gun">Á©∫ÊßΩ</div>
                <div class="card-slot" data-slot="1" data-type="gun">Á©∫ÊßΩ</div>
                <div class="card-slot" data-slot="2" data-type="gun">Á©∫ÊßΩ</div>
            </div>
            
            <div class="slot-section-title">ÊäÄËÉΩÂç°ÊßΩ</div>
            <div class="card-slot-container" id="skillCardSlots">
                <div class="card-slot" data-slot="0" data-type="skill">Á©∫ÊßΩ</div>
                <div class="card-slot" data-slot="1" data-type="skill">Á©∫ÊßΩ</div>
                <div class="card-slot" data-slot="2" data-type="skill">Á©∫ÊßΩ</div>
                <div class="card-slot" data-slot="3" data-type="skill">Á©∫ÊßΩ</div>
                <div class="card-slot" data-slot="4" data-type="skill">Á©∫ÊßΩ</div>
                <div class="card-slot" data-slot="5" data-type="skill">Á©∫ÊßΩ</div>
                <div class="card-slot" data-slot="6" data-type="skill">Á©∫ÊßΩ</div>
                <div class="card-slot" data-slot="7" data-type="skill">Á©∫ÊßΩ</div>
            </div>
            
            <div class="slot-section-title">ÈÅìÂÖ∑Âç°ÊßΩ</div>
            <div class="card-slot-container" id="itemCardSlots">
                <div class="card-slot" data-slot="0" data-type="item">Á©∫ÊßΩ</div>
                <div class="card-slot" data-slot="1" data-type="item">Á©∫ÊßΩ</div>
                <div class="card-slot" data-slot="2" data-type="item">Á©∫ÊßΩ</div>
                <div class="card-slot" data-slot="3" data-type="item">Á©∫ÊßΩ</div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="cardSlotModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Âç°ÊßΩ</h2>
                <span class="close-button" id="closeCardSlot">√ó</span>
            </div>
            
            <div class="slot-section-title">Êû™Ê¢∞Âç°ÊßΩ</div>
            <div class="card-slot-container" id="gunCardSlots">
                <div class="card-slot" data-slot="0" data-type="gun">Á©∫ÊßΩ</div>
                <div class="card-slot" data-slot="1" data-type="gun">Á©∫ÊßΩ</div>
                <div class="card-slot" data-slot="2" data-type="gun">Á©∫ÊßΩ</div>
            </div>
            
            <div class="slot-section-title">ÊäÄËÉΩÂç°ÊßΩ</div>
            <div class="card-slot-container" id="skillCardSlots">
                <div class="card-slot" data-slot="0" data-type="skill">Á©∫ÊßΩ</div>
                <div class="card-slot" data-slot="1" data-type="skill">Á©∫ÊßΩ</div>
                <div class="card-slot" data-slot="2" data-type="skill">Á©∫ÊßΩ</div>
                <div class="card-slot" data-slot="3" data-type="skill">Á©∫ÊßΩ</div>
                <div class="card-slot" data-slot="4" data-type="skill">Á©∫ÊßΩ</div>
                <div class="card-slot" data-slot="5" data-type="skill">Á©∫ÊßΩ</div>
                <div class="card-slot" data-slot="6" data-type="skill">Á©∫ÊßΩ</div>
                <div class="card-slot" data-slot="7" data-type="skill">Á©∫ÊßΩ</div>
            </div>
            
            <div class="slot-section-title">ÈÅìÂÖ∑Âç°ÊßΩ</div>
            <div class="card-slot-container" id="itemCardSlots">
                <div class="card-slot" data-slot="0" data-type="item">Á©∫ÊßΩ</div>
                <div class="card-slot" data-slot="1" data-type="item">Á©∫ÊßΩ</div>
                <div class="card-slot" data-slot="2" data-type="item">Á©∫ÊßΩ</div>
                <div class="card-slot" data-slot="3" data-type="item">Á©∫ÊßΩ</div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="cardSlotModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Âç°ÊßΩ</h2>
                <span class="close-button" id="closeCardSlot">√ó</span>
            </div>
            
            <div class="slot-section-title">Êû™Ê¢∞Âç°ÊßΩ</div>
            <div class="card-slot-container" id="gunCardSlots">
                <div class="card-slot" data-slot="0" data-type="gun">Á©∫ÊßΩ</div>
                <div class="card-slot" data-slot="1" data-type="gun">Á©∫ÊßΩ</div>
                <div class="card-slot" data-slot="2" data-type="gun">Á©∫ÊßΩ</div>
            </div>
            
            <div class="slot-section-title">ÊäÄËÉΩÂç°ÊßΩ</div>
            <div class="card-slot-container" id="skillCardSlots">
                <div class="card-slot" data-slot="0" data-type="skill">Á©∫ÊßΩ</div>
                <div class="card-slot" data-slot="1" data-type="skill">Á©∫ÊßΩ</div>
                <div class="card-slot" data-slot="2" data-type="skill">Á©∫ÊßΩ</div>
                <div class="card-slot" data-slot="3" data-type="skill">Á©∫ÊßΩ</div>
                <div class="card-slot" data-slot="4" data-type="skill">Á©∫ÊßΩ</div>
                <div class="card-slot" data-slot="5" data-type="skill">Á©∫ÊßΩ</div>
                <div class="card-slot" data-slot="6" data-type="skill">Á©∫ÊßΩ</div>
                <div class="card-slot" data-slot="7" data-type="skill">Á©∫ÊßΩ</div>
            </div>
            
            <div class="slot-section-title">ÈÅìÂÖ∑Âç°ÊßΩ</div>
            <div class="card-slot-container" id="itemCardSlots">
                <div class="card-slot" data-slot="0" data-type="item">Á©∫ÊßΩ</div>
                <div class="card-slot" data-slot="1" data-type="item">Á©∫ÊßΩ</div>
                <div class="card-slot" data-slot="2" data-type="item">Á©∫ÊßΩ</div>
                <div class="card-slot" data-slot="3" data-type="item">Á©∫ÊßΩ</div>
            </div>
        </div>
    </div>

    <!-- Âç°ÁâåÊè≠Á§∫Ê®°ÊÄÅÊ°Ü -->
    <div class="modal" id="cardRevealModal">
        <div class="modal-content">
            <div id="revealedCardContainer"></div>
        </div>
    </div>

    <script>
        // Èü≥ÊïàÁÆ°ÁêÜÂô®
        const SoundManager = {
            context: null,
            sounds: {},
            muted: false,
            volume: 0.5,
            
            init() {
                try {
                    this.context = new (window.AudioContext || window.webkitAudioContext)();
                    this.createSounds();
                } catch (e) {
                    console.warn('Web Audio API not supported');
                }
            },
            
            createSounds() {
                // ÂàõÂª∫ÂêÑÁßçÈü≥Êïà
                this.sounds.background = this.createTone(440, 0.1, 0.3, 'sine');
                this.sounds.shoot = this.createTone(800, 0.05, 0.2, 'square');
                this.sounds.hit = this.createTone(600, 0.1, 0.3, 'sawtooth');
                this.sounds.enemyDeath = this.createTone(300, 0.2, 0.4, 'sawtooth');
                this.sounds.coin = this.createTone(1200, 0.05, 0.15, 'sine', 1500); // Ê∏ÖËÑÜÁöÑÈìúÊùøÂ£∞
                this.sounds.getCard = this.createTone(800, 0.1, 0.4, 'noise', 200); // Ëé∑ÂæóÈÅìÂÖ∑ÁöÑÂ£∞Èü≥
                this.sounds.levelUp = this.createTone(1200, 0.3, 0.5, 'sine');
                this.sounds.damage = this.createTone(200, 0.1, 0.3, 'square');
                this.sounds.shield = this.createTone(500, 0.2, 0.3, 'sine');
            },
            
            createTone(frequency, attack, decay, waveType, endFrequency = null) {
                return () => {
                    if (this.muted || !this.context) return;
                    
                    const oscillator = this.context.createOscillator();
                    const gainNode = this.context.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.context.destination);
                    
                    oscillator.type = waveType;
                    oscillator.frequency.setValueAtTime(frequency, this.context.currentTime);
                    if (endFrequency) {
                        oscillator.frequency.exponentialRampToValueAtTime(endFrequency, this.context.currentTime + attack + decay);
                    }
                    
                    gainNode.gain.setValueAtTime(0, this.context.currentTime);
                    gainNode.gain.linearRampToValueAtTime(this.volume, this.context.currentTime + attack);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, this.context.currentTime + attack + decay);
                    
                    oscillator.start(this.context.currentTime);
                    oscillator.stop(this.context.currentTime + attack + decay);
                };
            },
            
            play(soundName) {
                if (this.sounds[soundName]) {
                    this.sounds[soundName]();
                }
            },
            
            toggleMute() {
                this.muted = !this.muted;
                const soundToggle = document.getElementById('soundToggle');
                if (this.muted) {
                    soundToggle.textContent = 'üîá';
                    soundToggle.classList.add('muted');
                } else {
                    soundToggle.textContent = 'üîä';
                    soundToggle.classList.remove('muted');
                }
            }
        };
        
        // Ê∑ªÂä†Èü≥ÊïàÊéßÂà∂‰∫ã‰ª∂
        document.addEventListener('DOMContentLoaded', () => {
            const soundToggle = document.getElementById('soundToggle');
            soundToggle.addEventListener('click', () => {
                SoundManager.toggleMute();
            });
        });
    
        // Ê∏∏Êàè‰∏ªË¶ÅÂØπË±°
        // ËßÜËßâÁâπÊïàÁÆ°ÁêÜÂô®
        const EffectsManager = {
            particles: [],
            damageNumbers: [],
            screenEffects: [],
            
            // ÂàõÂª∫Á≤íÂ≠êÊïàÊûú
            createParticle(x, y, color, size, velocityX, velocityY, lifetime = 1000) {
                this.particles.push({
                    x, y, color, size,
                    velocityX, velocityY,
                    lifetime, maxLifetime: lifetime,
                    alpha: 1
                });
            },
            
            // ÂàõÂª∫ÂëΩ‰∏≠ÂèçÈ¶à
            createHitEffect(x, y, color = 'yellow') {
                // ÂàõÂª∫Èó™ÁÉÅÊïàÊûú
                for (let i = 0; i < 8; i++) {
                    const angle = (i / 8) * Math.PI * 2;
                    const speed = 2 + Math.random() * 2;
                    this.createParticle(
                        x, y,
                        color,
                        3 + Math.random() * 3,
                        Math.cos(angle) * speed,
                        Math.sin(angle) * speed,
                        500
                    );
                }
            },
            
            // ÂàõÂª∫Ê≠ª‰∫°ÁâπÊïà
            createDeathEffect(x, y, color = 'red') {
                // ÂàõÂª∫ÁàÜÁÇ∏ÊïàÊûú
                for (let i = 0; i < 12; i++) {
                    const angle = (i / 12) * Math.PI * 2;
                    const speed = 3 + Math.random() * 4;
                    this.createParticle(
                        x, y,
                        color,
                        4 + Math.random() * 4,
                        Math.cos(angle) * speed,
                        Math.sin(angle) * speed,
                        800
                    );
                }
                // Ê∑ªÂä†‰∏Ä‰∫õÈáëËâ≤Á≤íÂ≠êË°®Á§∫Â•ñÂä±
                for (let i = 0; i < 6; i++) {
                    const angle = (i / 6) * Math.PI * 2;
                    const speed = 2 + Math.random() * 2;
                    this.createParticle(
                        x, y,
                        'gold',
                        3 + Math.random() * 2,
                        Math.cos(angle) * speed,
                        Math.sin(angle) * speed,
                        1000
                    );
                }
            },
            
            // ÂàõÂª∫ÊãæÂèñÂä®Áîª
            createPickupEffect(x, y, text, color = 'gold') {
                this.damageNumbers.push({
                    x, y,
                    text: '+' + text,
                    color,
                    velocityY: -2,
                    alpha: 1,
                    lifetime: 1500,
                    size: 16
                });
            },
            
            // ÂàõÂª∫‰º§ÂÆ≥Êï∞Â≠ó
            createDamageNumber(x, y, damage, color = 'white') {
                this.damageNumbers.push({
                    x, y,
                    text: '-' + damage,
                    color,
                    velocityY: -1,
                    alpha: 1,
                    lifetime: 1000,
                    size: 14
                });
            },
            
            // ÂàõÂª∫Â±èÂπïÈó™ÁÉÅÊïàÊûú
            createScreenFlash(color = 'red', duration = 200) {
                this.screenEffects.push({
                    color,
                    alpha: 0.3,
                    duration,
                    maxDuration: duration
                });
            },
            
            // Êõ¥Êñ∞ÊâÄÊúâÁâπÊïà
            update(deltaTime) {
                // Êõ¥Êñ∞Á≤íÂ≠ê
                for (let i = this.particles.length - 1; i >= 0; i--) {
                    const particle = this.particles[i];
                    particle.x += particle.velocityX;
                    particle.y += particle.velocityY;
                    particle.lifetime -= deltaTime;
                    particle.alpha = particle.lifetime / particle.maxLifetime;
                    
                    if (particle.lifetime <= 0) {
                        this.particles.splice(i, 1);
                    }
                }
                
                // Êõ¥Êñ∞‰º§ÂÆ≥Êï∞Â≠ó
                for (let i = this.damageNumbers.length - 1; i >= 0; i--) {
                    const number = this.damageNumbers[i];
                    number.y += number.velocityY;
                    number.lifetime -= deltaTime;
                    number.alpha = number.lifetime / 1000;
                    
                    if (number.lifetime <= 0) {
                        this.damageNumbers.splice(i, 1);
                    }
                }
                
                // Êõ¥Êñ∞Â±èÂπïÊïàÊûú
                for (let i = this.screenEffects.length - 1; i >= 0; i--) {
                    const effect = this.screenEffects[i];
                    effect.duration -= deltaTime;
                    effect.alpha = (effect.duration / effect.maxDuration) * 0.3;
                    
                    if (effect.duration <= 0) {
                        this.screenEffects.splice(i, 1);
                    }
                }
            },
            
            // ÁªòÂà∂ÊâÄÊúâÁâπÊïà
            draw(ctx) {
                // ÁªòÂà∂Â±èÂπïÊïàÊûú
                for (const effect of this.screenEffects) {
                    ctx.fillStyle = effect.color;
                    ctx.globalAlpha = effect.alpha;
                    ctx.fillRect(0, 0, game.width, game.height);
                    ctx.globalAlpha = 1;
                }
                
                // ÁªòÂà∂Á≤íÂ≠ê
                for (const particle of this.particles) {
                    ctx.save();
                    ctx.globalAlpha = particle.alpha;
                    ctx.fillStyle = particle.color;
                    ctx.beginPath();
                    ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();
                }
                
                // ÁªòÂà∂‰º§ÂÆ≥Êï∞Â≠ó
                for (const number of this.damageNumbers) {
                    ctx.save();
                    ctx.globalAlpha = number.alpha;
                    ctx.fillStyle = number.color;
                    ctx.font = `bold ${number.size}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.fillText(number.text, number.x, number.y);
                    ctx.restore();
                }
            }
        };

        // Ê∏∏Êàè‰∏ªË¶ÅÂØπË±°
        const game = {
            images: {},
            canvas: null,
            ctx: null,
            width: 0,
            height: 0,
            gridSize: 50, // Increased from 40
            gridCols: 30,
            gridRows: 15,
            grid: [],
            removedCols: { left: [], right: [] },
            removedRows: { top: [], bottom: [] },
            // Áî®‰∫éË∑üË∏™ÁßªÂá∫Â±èÂπïÁöÑÊïå‰∫∫ÂíåBoss
            offscreenEnemies: [],
            offscreenBosses: [],
            player: {
                x: 0,
                y: 0,
                radius: 20,
                color: 'blue',
                health: 100, // Â¢ûÂä†ÈªòËÆ§Ë°ÄÈáèÂà∞30
                maxHealth: 1000, // Â¢ûÂä†ÊúÄÂ§ßË°ÄÈáèÂà∞30
                direction: 90, // ÊñπÂêëÔºàÂ∫¶Êï∞Ôºâ
                shield: {
                    active: false,
                    duration: 0
                },
                coins: 0,
                gun: {
                    type: 'normal',
                    color: 'grey',
                    damage: 1,
                    bulletCount: 1,
                    bulletSpeed: 7,
                    frozen: false,
                    poison: false
                }
            },
            enemies: [],
            bosses: [],
            bullets: [],
            skills: [],
            lastEnemySpawn: 0,
            lastBossSpawn: 0,
            enemySpawnRate: 500, // ÊØ´Áßí
            bossSpawnRate: 500000, // ÊØ´Áßí
            keys: {
                w: false,
                a: false,
                s: false,
                d: false,
                space: false,
                ArrowUp: false,
                ArrowDown: false,
                ArrowLeft: false,
                ArrowRight: false
            },
            joystick: {
                active: false,
                angle: 0
            },
            paused: false,
            gameTime: 0,
            cards: {
                guns: [
                    { id: 'fire', name: 'ÁÅ´ÁÑ∞Êû™', description: 'ÂèëÂ∞ÑÁÅ´ÁÑ∞Â≠êÂºπÔºå‰º§ÂÆ≥‰∏∫2', color: 'red', damage: 2, bulletCount: 1, frozen: false, poison: false, shape: 'flame' },
                    { id: 'bingdong', name: 'ÂØíÂÜ∞Êû™', description: 'ÂèëÂ∞ÑÂØíÂÜ∞Â≠êÂºπÔºåÂèØÂÜªÁªìÊïå‰∫∫10Áßí', color: 'blue', damage: 1, bulletCount: 1, frozen: true, poison: false, shape: 'snowflake' },
                    { id: 'doubleFire', name: 'ÂèåÂÄçÁÅ´ÁÑ∞Êû™', description: 'ÂèëÂ∞Ñ‰∏§‰∏™ÁÅ´ÁÑ∞Â≠êÂºπÔºåÊØè‰∏™‰º§ÂÆ≥‰∏∫2', color: 'red', damage: 2, bulletCount: 2, frozen: false, poison: false, shape: 'doubleFlame' },
                    { id: 'doubleIce', name: 'ÂèåÂÄçÂØíÂÜ∞Êû™', description: 'ÂèëÂ∞Ñ‰∏§‰∏™ÂØíÂÜ∞Â≠êÂºπÔºåÂèØÂÜªÁªìÊïå‰∫∫10Áßí', color: 'blue', damage: 1, bulletCount: 2, frozen: true, poison: false, shape: 'doubleSnowflake' },
                    { id: 'poison', name: 'ÊØíËçØÊû™', description: 'ÂèëÂ∞ÑÊØíËçØÂ≠êÂºπÔºå‰º§ÂÆ≥‰∏∫3', color: 'purple', damage: 3, bulletCount: 1, frozen: false, poison: true, shape: 'skull' }
                ],
                skills: [
                    { id: 'qiankun', name: '‰πæÂù§Âúà', description: 'ÁîüÊàêÂÖ≠‰∏™‰πæÂù§ÂúàÂú®Áé©ÂÆ∂ÂõõÂë®ËΩ¨Âä®', shape: 'ring' },
                    { id: 'huntian', name: 'Ê∑∑Â§©Âáå', description: 'Âú®Â±èÂπï‰∏≠È£ûÊù•È£ûÂéªÔºå‰º§ÂÆ≥‰∏∫3', shape: 'ribbon' },
                    { id: 'huojianqiang', name: 'ÁÅ´Â∞ñÊû™', description: 'Âú®Áé©ÂÆ∂ËÉåÂêéÔºåÊØèÈöî0.5ÁßíÂèëÂ∞ÑÔºå‰º§ÂÆ≥‰∏∫3', shape: 'spear' },
                    { id: 'fenghuolun', name: 'È£éÁÅ´ËΩÆ', description: 'Âú®Âú∞Èù¢‰∏äÁïô‰∏ãÁÅ´ÁÑ∞ÁóïËøπÔºå‰º§ÂÆ≥‰∏∫3', shape: 'wheel' },
                    { id: 'jiulong', name: '‰πùÈæôÁõñÁÅ´ÁΩ©', description: 'ÊØèÈöî50ÁßíÂá∫Áé∞‰∏ÄÊ¨°Ôºå‰º§ÂÆ≥‰∏∫40', shape: 'dragon' },
                    { id: 'bagua', name: 'ÂÖ´Âç¶ÈòµÂÆùÂâë', description: 'ÂêëÂõõÈù¢ÂÖ´ÊñπÂèëÂ∞ÑÂÖ´Âç¶ÈòµÔºå‰º§ÂÆ≥‰∏∫5', shape: 'sword' },
                    { id: 'jinzhuan', name: 'ÈáëÁ†ñ', description: 'ÈöèÊú∫ÊñπÂêëÂèëÂ∞ÑÈáëÁ†ñÔºå‰º§ÂÆ≥‰∏∫5', shape: 'brick' },
                    { id: 'jianyu', name: 'ÁÆ≠Èõ®', description: 'ÊúùÈöèÊú∫ÊñπÂêëÂèëÂ∞Ñ50ÊîØÁÆ≠Ôºå‰º§ÂÆ≥‰∏∫2', shape: 'arrow' }
                ],
                items: [
                    { id: 'lianshe', name: 'ËøûÂèë', description: 'ÈïøÊåâÊîªÂáªÊåâÈîÆÂèØ‰ª•ËøûÁª≠ÂèëÂ∞ÑÂ≠êÂºπ', color: 'orange', shape: 'lightning' },
                    { id: 'gongjili', name: 'ÊîªÂáªÂäõÊèêÂçá', description: 'ÊØè‰∏ÄÊ¨°ÂèëÂ∞ÑÂ≠êÂºπÁöÑÊîªÂáªÂäõÂ¢ûÂä†2', color: 'red', shape: 'sword' },
                    { id: 'heal', name: 'Â¢ûÂä†Ë°ÄÈáè', description: 'ÊØè3Áßí+1Ë°Ä', color: 'green', shape: 'heart' },
                    { id: 'bingdong', name: 'ÂÜ∞ÂÜªÊèêÂçá', description: 'ÁªôÂ≠êÂºπÂ¢ûÂä†ÂÜ∞ÂÜªÁâπÊïàÔºåÂèØÂÜ∞ÂÜª10Áßí', color: 'cyan', shape: 'snowflake' }
                ]
            },
            cardSlots: {
                guns: [null, null, null],
                skills: [null, null, null, null, null, null, null, null],
                items: [null, null, null, null]
            },
            activeEffects: {
                rapidFire: false,
                damageBoost: false,
                healing: false,
                freezeBoost: false
            },
            lastActiveSkillTimes: {},
            // Áî®‰∫éË∑üË∏™Âú∞ÂõæÁßªÂä®ÁöÑÊñπÂêëÂíåË∑ùÁ¶ª
            mapMovement: {
                dx: 0,
                dy: 0
            },
            // ÊòØÂê¶ÊòØiPad
            isIPad: false,
            // Ê∏∏ÊàèÈöæÂ∫¶Ë∞ÉÊï¥
            difficultySettings: {
                enemyDamage: 1,
                bossDamage: 2,
                bossHealth: 100, // Ê∑ªÂä†bossHealthÂ±ûÊÄß
                enemySpeed: 2,
                bossSpeed: 1
            }
        };

        // ÂàùÂßãÂåñÊ∏∏Êàè
        function initGame() {
            // È¢ÑÂä†ËΩΩÂõæÁâá
            const imageSources = {
                baoxiang: './tools/baoxiang.png',
                muxiang: './tools/muxiang.png'
            };
            let imagesLoaded = 0;
            const totalImages = Object.keys(imageSources).length;

            for (const key in imageSources) {
                game.images[key] = new Image();
                game.images[key].src = imageSources[key];
                game.images[key].onload = () => {
                    imagesLoaded++;
                    if (imagesLoaded === totalImages) {
                        // ÊâÄÊúâÂõæÁâáÂä†ËΩΩÂÆåÊàêÂêéÂÜçÂêØÂä®Ê∏∏Êàè
                        startGame();
                    }
                };
            }
        }

        function startGame() {
            game.canvas = document.getElementById('gameCanvas');
            game.ctx = game.canvas.getContext('2d');
            
            // Ê£ÄÊµãÊòØÂê¶‰∏∫iPad
            checkDeviceType();
            
            // ËÆæÁΩÆÁîªÂ∏ÉÂ∞∫ÂØ∏
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // ËÆæÁΩÆÁé©ÂÆ∂ÂàùÂßã‰ΩçÁΩÆ
            game.player.x = game.width / 2;
            game.player.y = game.height / 2;
            
            // ÂàùÂßãÂåñÁΩëÊ†º
            initGrid();
            
            // Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®
            setupEventListeners();
            
            // ËÆæÁΩÆÂïÜÂ∫óÂíåÂç°ÊßΩ
            setupShopAndCardSlots();
            
            // ËÆæÁΩÆÂ∏ÆÂä©ÊåâÈíÆ
            setupHelpButton();
            
            // ÁªôÁé©ÂÆ∂‰∏Ä‰∫õÂàùÂßãÈìúÊùøÔºåÊñπ‰æøÊµãËØï
            game.player.coins = 150;
            document.getElementById('coinsDisplay').textContent = `ÈìúÊùø: ${game.player.coins}`;
            
            // ÂêØÂä®Ê∏∏ÊàèÂæ™ÁéØ
            requestAnimationFrame(gameLoop);
            
            // ÂàùÂßãÂåñÈü≥ÊïàÁ≥ªÁªü
            SoundManager.init();
        }

        document.addEventListener('DOMContentLoaded', () => {
            SoundManager.init();
            initGame();
            setupEventListeners();
            setupShopAndCardSlots();
            setupHelpButton();
            const soundToggle = document.getElementById('soundToggle');
            if (soundToggle) {
                soundToggle.addEventListener('click', () => {
                    SoundManager.toggleMute();
                });
            }
        });
        
        // ËÆæÁΩÆÂ∏ÆÂä©ÊåâÈíÆ
        function setupHelpButton() {
            const helpButton = document.getElementById('helpButton');
            const helpModal = document.getElementById('helpModal');
            const closeHelp = document.getElementById('closeHelp');
            
            // ÊâìÂºÄÂ∏ÆÂä©
            helpButton.addEventListener('click', () => {
                game.paused = true;
                helpModal.style.display = 'flex';
            });
            
            // ÂÖ≥Èó≠Â∏ÆÂä©
            closeHelp.addEventListener('click', () => {
                game.paused = false;
                helpModal.style.display = 'none';
            });
        }
        
        // Ê£ÄÊµãËÆæÂ§áÁ±ªÂûã
        function checkDeviceType() {
            // Ê£ÄÊµãÊòØÂê¶‰∏∫iPad
            const userAgent = navigator.userAgent.toLowerCase();
            const isIPad = /ipad/.test(userAgent) || 
                          (/macintosh/.test(userAgent) && 'ontouchend' in document);
            
            game.isIPad = isIPad;
            
            // Â¶ÇÊûúÊòØiPadÔºåË∞ÉÊï¥UIÂ§ßÂ∞è
            if (isIPad) {
                document.documentElement.classList.add('ipad');
            }
        }
        
        // Ë∞ÉÊï¥ÁîªÂ∏ÉÂ§ßÂ∞è
        function resizeCanvas() {
            game.width = window.innerWidth;
            game.height = window.innerHeight;
            game.canvas.width = game.width;
            game.canvas.height = game.height;
            
            // Ë∞ÉÊï¥ÁΩëÊ†ºÂ§ßÂ∞è‰ª•ÈÄÇÂ∫îÂ±èÂπï
            game.gridCols = Math.ceil(game.width / game.gridSize) + 4; // Â¢ûÂä†È¢ùÂ§ñÁöÑÂàó‰ª•Á°Æ‰øùË¶ÜÁõñ
            game.gridRows = Math.ceil(game.height / game.gridSize) + 4; // Â¢ûÂä†È¢ùÂ§ñÁöÑË°å‰ª•Á°Æ‰øùË¶ÜÁõñ
        }
        
        // ÂàùÂßãÂåñÁΩëÊ†º
        function initGrid() {
            game.grid = [];
            
            for (let y = 0; y < game.gridRows; y++) {
                const row = [];
                for (let x = 0; x < game.gridCols; x++) {
                    // ÈöèÊú∫ÁîüÊàêÊ†ºÂ≠êÁ±ªÂûã
                    let cellType = 'normal';
                    const rand = Math.random();
                    if (rand < 0.003) { // 0.3% ÁöÑÊ¶ÇÁéáÊòØÂÆùÁÆ±
                        cellType = 'treasure';
                    } else if (rand < 0.004) { // 0.1% ÁöÑÊ¶ÇÁéáÊòØÊú®ÁÆ±
                        cellType = 'box';
                    }
                    
                    row.push({
                        type: cellType,
                        x: x * game.gridSize,
                        y: y * game.gridSize
                    });
                }
                game.grid.push(row);
            }
        }
        
        // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
        function setupEventListeners() {
            // ÈîÆÁõò‰∫ã‰ª∂
            window.addEventListener('keydown', (e) => {
                switch (e.key.toLowerCase()) {
                    case 'w': 
                        game.keys.w = true; 
                        game.player.direction = 270; // Up
                        break;
                    case 'a': 
                        game.keys.a = true; 
                        game.player.direction = 180; // Left
                        break;
                    case 's': 
                        game.keys.s = true; 
                        game.player.direction = 90; // Down
                        break;
                    case 'd': 
                        game.keys.d = true; 
                        game.player.direction = 0; // Right
                        break;
                    case ' ': 
                        game.keys.space = true; 
                        fireBullet(); 
                        if (game.activeEffects.rapidFire) {
                            game.attackInterval = setInterval(fireBullet, 200);
                        }
                        break;
                    case 'e': game.keys.e = true; break;
                    case 'r': game.keys.r = true; break;
                    case 'arrowup': 
                        e.preventDefault();
                        game.keys.ArrowUp = true; 
                        game.player.direction = 270; // Up
                        break;
                    case 'arrowdown': 
                        e.preventDefault();
                        game.keys.ArrowDown = true; 
                        game.player.direction = 90; // Down
                        break;
                    case 'arrowleft': 
                        e.preventDefault();
                        game.keys.ArrowLeft = true; 
                        game.player.direction = 180; // Left
                        break;
                    case 'arrowright': 
                        e.preventDefault();
                        game.keys.ArrowRight = true; 
                        game.player.direction = 0; // Right
                        break;
                }
            });
            
            window.addEventListener('keyup', (e) => {
                switch (e.key.toLowerCase()) {
                    case 'w': game.keys.w = false; break;
                    case 'a': game.keys.a = false; break;
                    case 's': game.keys.s = false; break;
                    case 'd': game.keys.d = false; break;
                    case ' ': 
                        game.keys.space = false; 
                        if (game.attackInterval) {
                            clearInterval(game.attackInterval);
                            game.attackInterval = null;
                        }
                        break;
                    case 'arrowup': game.keys.ArrowUp = false; break;
                    case 'arrowdown': game.keys.ArrowDown = false; break;
                    case 'arrowleft': game.keys.ArrowLeft = false; break;
                    case 'arrowright': game.keys.ArrowRight = false; break;
                    case 'e': game.keys.e = false; break;
                    case 'r': game.keys.r = false; break;
                }
            });
            
            // ÊñπÂêëÊåâÈíÆ‰∫ã‰ª∂ - Â¢ûÂº∫Ëß¶Êë∏ÊîØÊåÅ
            const directionButtons = ['upButton', 'leftButton', 'downButton', 'rightButton'];
            const directions = ['up', 'left', 'down', 'right']; // ‰øÆÊ≠£ÊñπÂêëÔºåÂÆûÁé∞Áé©ÂÆ∂ËßÜËßí
            
            directionButtons.forEach((buttonId, index) => {
                const button = document.getElementById(buttonId);
                
                // Ëß¶Êë∏‰∫ã‰ª∂
                button.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    moveGrid(directions[index]);
                });
                
                // Èº†Ê†á‰∫ã‰ª∂
                button.addEventListener('mousedown', () => {
                    moveGrid(directions[index]);
                });
                
                // ÈïøÊåâÊîØÊåÅ
                let pressTimer = null;
                
                button.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    moveGrid(directions[index]);
                    pressTimer = setInterval(() => {
                        moveGrid(directions[index]);
                    }, 150);
                });
                
                button.addEventListener('mousedown', () => {
                    moveGrid(directions[index]);
                    pressTimer = setInterval(() => {
                        moveGrid(directions[index]);
                    }, 150);
                });
                
                const clearTimer = () => {
                    if (pressTimer) {
                        clearInterval(pressTimer);
                        pressTimer = null;
                    }
                };
                
                button.addEventListener('touchend', clearTimer);
                button.addEventListener('touchcancel', clearTimer);
                button.addEventListener('mouseup', clearTimer);
                button.addEventListener('mouseleave', clearTimer);
            });
            
            // ÊîªÂáªÊåâÈíÆ‰∫ã‰ª∂
            const attackButton = document.getElementById('attackButton');
            
            attackButton.addEventListener('touchstart', (e) => {
                e.preventDefault();
                fireBullet();
                if (game.activeEffects.rapidFire) {
                    game.attackInterval = setInterval(fireBullet, 200);
                }
            });
            
            attackButton.addEventListener('mousedown', () => {
                fireBullet();
                if (game.activeEffects.rapidFire) {
                    game.attackInterval = setInterval(fireBullet, 200);
                }
            });
            
            const stopAttack = () => {
                if (game.attackInterval) {
                    clearInterval(game.attackInterval);
                    game.attackInterval = null;
                }
            };
            
            attackButton.addEventListener('touchend', stopAttack);
            attackButton.addEventListener('touchcancel', stopAttack);
            attackButton.addEventListener('mouseup', stopAttack);
            attackButton.addEventListener('mouseleave', stopAttack);
            
            // ÊëáÊùÜÊéßÂà∂
            const middleCircle = document.getElementById('middleCircle');
            
            middleCircle.addEventListener('touchstart', (e) => {
                e.preventDefault();
                game.joystick.active = true;
                updateJoystick(e.touches[0]);
            });
            
            middleCircle.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (game.joystick.active) {
                    updateJoystick(e.touches[0]);
                }
            });
            
            middleCircle.addEventListener('touchend', () => {
                game.joystick.active = false;
                resetJoystick();
            });
            
            middleCircle.addEventListener('mousedown', (e) => {
                game.joystick.active = true;
                updateJoystick(e);
            });
            
            window.addEventListener('mousemove', (e) => {
                if (game.joystick.active) {
                    updateJoystick(e);
                }
            });
            
            window.addEventListener('mouseup', () => {
                game.joystick.active = false;
                resetJoystick();
            });
            
            // ÈòªÊ≠¢iOS‰∏äÁöÑÂèåÂáªÁº©Êîæ
            document.addEventListener('touchend', (e) => {
                const now = Date.now();
                const lastTouch = game.lastTouch || now;
                const delta = now - lastTouch;
                if (delta < 500 && delta > 0) {
                    e.preventDefault();
                }
                game.lastTouch = now;
            }, false);
            
            // Èò≤Ê≠¢Âú®iOS Safari‰∏äÊãñÂä®ÂØºËá¥Êï¥‰∏™È°µÈù¢ÁßªÂä®
            document.addEventListener('touchmove', (e) => {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });
        }
        
        // ËÆæÁΩÆÂïÜÂ∫óÂíåÂç°ÊßΩ
        function setupShopAndCardSlots() {
            const shopButton = document.getElementById('shopButton');
            const cardSlotButton = document.getElementById('cardSlotButton');
            const shopModal = document.getElementById('shopModal');
            const cardSlotModal = document.getElementById('cardSlotModal');
            const closeShop = document.getElementById('closeShop');
            const closeCardSlot = document.getElementById('closeCardSlot');
            const buyCardButton = document.getElementById('buyCardButton');
            const shopCardPrice = document.querySelector('.shop-card-price');
            let currentCardPrice = 50;

            // ÊâìÂºÄÂïÜÂ∫ó
            shopButton.addEventListener('click', () => {
                currentCardPrice = Math.floor(Math.random() * (200 - 50 + 1)) + 50;
                shopCardPrice.textContent = `‰ª∑Ê†º: ${currentCardPrice} ÈìúÊùø`;
                document.getElementById('shopCoinsDisplay').textContent = `ÂΩìÂâçÈìúÊùø: ${game.player.coins}`;
                game.paused = true;
                shopModal.style.display = 'flex';
            });

            // ÂÖ≥Èó≠ÂïÜÂ∫ó
            closeShop.addEventListener('click', () => {
                game.paused = false;
                shopModal.style.display = 'none';
            });

            // ÊâìÂºÄÂç°ÊßΩ
            cardSlotButton.addEventListener('click', () => {
                game.paused = true;
                updateCardSlotDisplay();
                cardSlotModal.style.display = 'flex';
            });

            // ÂÖ≥Èó≠Âç°ÊßΩ
            closeCardSlot.addEventListener('click', () => {
                game.paused = false;
                cardSlotModal.style.display = 'none';
            });

            // Ë¥≠‰π∞Âç°Áâå
            buyCardButton.addEventListener('click', () => {
                if (game.player.coins >= currentCardPrice) {
                    game.player.coins -= currentCardPrice;
                    document.getElementById('shopCoinsDisplay').textContent = `ÂΩìÂâçÈìúÊùø: ${game.player.coins}`;
                    
                    const randomCard = getRandomCard();
                    
                    if (randomCard) {
                        addCardToSlot(randomCard);
                        document.getElementById('coinsDisplay').textContent = `ÈìúÊùø: ${game.player.coins}`;
                        showCardRevealEffect(randomCard);
                        SoundManager.play('getCard'); // Êí≠ÊîæËé∑ÂæóÂç°ÁâåÈü≥Êïà
                    } else {
                        game.player.coins += currentCardPrice;
                        document.getElementById('shopCoinsDisplay').textContent = `ÂΩìÂâçÈìúÊùø: ${game.player.coins}`;
                        alert('ÊâÄÊúâÂç°ÁâåÈÉΩÂ∑≤Ëé∑ÂæóÔºåÊó†Ê≥ïË¥≠‰π∞Êõ¥Â§öÂç°Áâå„ÄÇ');
                    }
                } else {
                    alert('ÈìúÊùø‰∏çË∂≥ÔºÅ');
                }
            });
            
            // Ê∑ªÂä†Âç°ÊßΩÁÇπÂáª‰∫ã‰ª∂
            const gunCardSlots = document.querySelectorAll('#gunCardSlots .card-slot');
            gunCardSlots.forEach(slot => {
                slot.addEventListener('click', () => {
                    const slotIndex = parseInt(slot.getAttribute('data-slot'));
                    const cardInfo = game.cardSlots.guns[slotIndex];
                    
                    if (cardInfo) {
                        // Êõ¥Êç¢ÂΩìÂâçÊû™ÊîØ
                        const currentGun = game.player.gun;
                        
                        // Â¶ÇÊûúÂΩìÂâçÊû™‰∏çÊòØÊôÆÈÄöÊû™Ôºå‰øùÂ≠òÂÆÉ
                        if (currentGun.type !== 'normal') {
                            // ÂØªÊâæÁ©∫ÁöÑÊû™ÊßΩ
                            const emptySlotIndex = game.cardSlots.guns.findIndex(slot => slot === null);
                            if (emptySlotIndex !== -1) {
                                const gunInfo = game.cards.guns.find(g => g.id === currentGun.type);
                                game.cardSlots.guns[emptySlotIndex] = gunInfo;
                            }
                        }
                        
                        // ËÆæÁΩÆÊñ∞Êû™
                        game.player.gun = {
                            type: cardInfo.id,
                            color: cardInfo.color,
                            damage: cardInfo.damage,
                            bulletCount: cardInfo.bulletCount,
                            bulletSpeed: 7,
                            frozen: cardInfo.frozen,
                            poison: cardInfo.poison
                        };
                        
                        // ÁßªÈô§ÈÄâ‰∏≠ÁöÑÂç°Áâå
                        game.cardSlots.guns[slotIndex] = null;
                        
                        // Êõ¥Êñ∞UI
                        updateCardSlotDisplay();
                    }
                });
            });
        }
        
        // ÊòæÁ§∫Âç°ÁâåÊè≠Á§∫ÊïàÊûú
        function showCardRevealEffect(cardInfo) {
            const revealModal = document.getElementById('cardRevealModal');
            const cardContainer = document.getElementById('revealedCardContainer');

            // Ê∏ÖÁêÜÊóßÂÜÖÂÆπÂíåÁâπÊïà
            cardContainer.innerHTML = '';
            const oldStars = revealModal.querySelectorAll('.star');
            oldStars.forEach(star => star.remove());
            const oldConfetti = revealModal.querySelectorAll('.confetti');
            oldConfetti.forEach(c => c.remove());

            cardContainer.innerHTML = `
                <h1 class="reveal-title">ÊÅ≠ÂñúÊÇ®Ëé∑Âæó</h1>
                <div style="display: flex; align-items: center; width: 100%;">
                    <div class="revealed-card-image">
                        <img src="./tools/${cardInfo.id}.png" alt="${cardInfo.name}" style="width: 80%; max-width: 300px; height: auto; object-fit: contain;">
                    </div>
                    <div class="revealed-card-details">
                        <h2>${cardInfo.name}</h2>
                        <p>${cardInfo.description}</p>
                        <p class="author-credit">Designed by ËãëÂáØÁëûÔºÅ</p>
                    </div>
                </div>
            `;

            // ÂàõÂª∫ÊòüÊòüËÉåÊôØ
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.width = `${Math.random() * 2}px`;
                star.style.height = star.style.width;
                star.style.top = `${Math.random() * 100}%`;
                star.style.left = `${Math.random() * 100}%`;
                star.style.animationDelay = `${Math.random() * 2}s`;
                revealModal.appendChild(star);
            }

            revealModal.style.display = 'flex';

            // ÂàõÂª∫Á§ºËä±ÊïàÊûú
            const modalContent = revealModal.querySelector('.modal-content');
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                const x = Math.random() * 100 - 50;
                const y = Math.random() * 100 - 50;
                const rot = Math.random() * 360;
                confetti.style.setProperty('--end-x', `${x}vw`);
                confetti.style.setProperty('--end-y', `${y}vh`);
                confetti.style.setProperty('--end-rot', `${rot}deg`);
                confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                modalContent.appendChild(confetti);
            }

            setTimeout(() => {
                revealModal.style.display = 'none';
                // Ê∏ÖÁêÜÊòüÊòüÂíåÁ§ºËä±
                const stars = revealModal.querySelectorAll('.star');
                stars.forEach(star => star.remove());
                const confettiElements = modalContent.querySelectorAll('.confetti');
                confettiElements.forEach(c => c.remove());
            }, 3000);
        }

        // Êõ¥Êñ∞Âç°ÊßΩÊòæÁ§∫
        function updateCardSlotDisplay() {
            // Êõ¥Êñ∞Êû™Ê¢∞Âç°ÊßΩ
            const gunCardSlots = document.querySelectorAll('#gunCardSlots .card-slot');
            gunCardSlots.forEach((slot, index) => {
                const cardInfo = game.cardSlots.guns[index];
                updateCardSlotUI(slot, cardInfo);
            });
            
            // Êõ¥Êñ∞ÊäÄËÉΩÂç°ÊßΩ
            const skillCardSlots = document.querySelectorAll('#skillCardSlots .card-slot');
            skillCardSlots.forEach((slot, index) => {
                const cardInfo = game.cardSlots.skills[index];
                updateCardSlotUI(slot, cardInfo);
            });
            
            // Êõ¥Êñ∞ÈÅìÂÖ∑Âç°ÊßΩ
            const itemCardSlots = document.querySelectorAll('#itemCardSlots .card-slot');
            itemCardSlots.forEach((slot, index) => {
                const cardInfo = game.cardSlots.items[index];
                updateCardSlotUI(slot, cardInfo);
            });
        }
        
        // ÁªòÂà∂Âç°ÁâåÂõæÊ†á
        function drawCardIcon(ctx, shape, x, y, size, color) {
            ctx.save();
            ctx.translate(x, y);
            
            switch(shape) {
                case 'flame':
                    // ÁÅ´ÁÑ∞
                    ctx.fillStyle = color || 'red';
                    ctx.beginPath();
                    ctx.moveTo(0, -size/2);
                    ctx.quadraticCurveTo(-size/3, -size/3, -size/4, 0);
                    ctx.quadraticCurveTo(-size/3, size/3, 0, size/2);
                    ctx.quadraticCurveTo(size/3, size/3, size/4, 0);
                    ctx.quadraticCurveTo(size/3, -size/3, 0, -size/2);
                    ctx.fill();
                    break;
                    
                case 'snowflake':
                    // Èõ™Ëä±
                    ctx.strokeStyle = color || 'cyan';
                    ctx.lineWidth = 2;
                    for (let i = 0; i < 6; i++) {
                        ctx.rotate(Math.PI / 3);
                        ctx.beginPath();
                        ctx.moveTo(0, 0);
                        ctx.lineTo(0, -size/2);
                        ctx.stroke();
                        ctx.beginPath();
                        ctx.moveTo(0, -size/3);
                        ctx.lineTo(-size/6, -size/4);
                        ctx.moveTo(0, -size/3);
                        ctx.lineTo(size/6, -size/4);
                        ctx.stroke();
                    }
                    break;
                    
                case 'skull':
                    // È™∑È´Ö
                    ctx.fillStyle = color || 'purple';
                    ctx.beginPath();
                    ctx.arc(0, -size/4, size/3, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillRect(-size/4, 0, size/2, size/3);
                    ctx.fillStyle = 'black';
                    ctx.beginPath();
                    ctx.arc(-size/6, -size/4, size/10, 0, Math.PI * 2);
                    ctx.arc(size/6, -size/4, size/10, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                    
                case 'ring':
                    // ÂúÜÁéØ
                    ctx.strokeStyle = color || 'gold';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.arc(0, 0, size/2, 0, Math.PI * 2);
                    ctx.stroke();
                    break;
                    
                case 'lightning':
                    // Èó™Áîµ
                    ctx.fillStyle = color || 'yellow';
                    ctx.beginPath();
                    ctx.moveTo(-size/4, -size/2);
                    ctx.lineTo(size/8, -size/6);
                    ctx.lineTo(-size/8, size/6);
                    ctx.lineTo(size/4, size/2);
                    ctx.lineTo(0, 0);
                    ctx.lineTo(size/8, -size/3);
                    ctx.closePath();
                    ctx.fill();
                    break;
                    
                case 'heart':
                    // ÂøÉÂΩ¢
                    ctx.fillStyle = color || 'red';
                    ctx.beginPath();
                    ctx.moveTo(0, -size/4);
                    ctx.bezierCurveTo(-size/2, -size/2, -size/2, 0, 0, size/2);
                    ctx.bezierCurveTo(size/2, 0, size/2, -size/2, 0, -size/4);
                    ctx.fill();
                    break;
                    
                case 'sword':
                    // Ââë
                    ctx.fillStyle = color || 'silver';
                    ctx.fillRect(-size/16, -size/2, size/8, size);
                    ctx.fillRect(-size/4, -size/6, size/2, size/8);
                    ctx.fillStyle = color || 'brown';
                    ctx.fillRect(-size/8, size/4, size/4, size/4);
                    break;
                    
                case 'arrow':
                    // ÁÆ≠
                    ctx.strokeStyle = color || 'brown';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(0, -size/2);
                    ctx.lineTo(0, size/2);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(0, -size/2);
                    ctx.lineTo(-size/4, -size/4);
                    ctx.moveTo(0, -size/2);
                    ctx.lineTo(size/4, -size/4);
                    ctx.stroke();
                    break;
                    
                default:
                    // ÈªòËÆ§ÂΩ¢Áä∂
                    ctx.fillStyle = color || '#ddd';
                    ctx.fillRect(-size/2, -size/2, size, size);
                    break;
            }
            
            ctx.restore();
        }
        
        // Êõ¥Êñ∞Âçï‰∏™Âç°ÊßΩUI
        function updateCardSlotUI(slotElement, cardInfo) {
            if (cardInfo) {
                slotElement.classList.add('filled');
                
                // ÂàõÂª∫canvasÊù•ÁªòÂà∂ÂõæÊ†á
                const iconCanvas = document.createElement('canvas');
                iconCanvas.width = 60;
                iconCanvas.height = 60;

                
                slotElement.innerHTML = `
                    <div class="card-preview">
                        <div class="card-preview-title">${cardInfo.name}</div>
                        <div class="card-preview-image" style="background-color: transparent; padding: 0;">
                            <img src="./tools/${cardInfo.id}.png" alt="${cardInfo.name}" style="width: 100%; height: 100%; object-fit: contain;">
                        </div>
                        <div class="card-preview-description" style="font-size: 12px">${cardInfo.description}</div>
                    </div>
                `;

            } else {
                slotElement.classList.remove('filled');
                slotElement.textContent = 'Á©∫ÊßΩ';
            }
        }
        
        // Ëé∑ÂèñÈöèÊú∫Âç°Áâå
        function getRandomCard() {
            // ÁªÑÂêàÊâÄÊúâÂèØËÉΩÁöÑÂç°Áâå
            const availableCards = [];
            
            // Ê£ÄÊü•Êû™Ê¢∞Âç°ÊßΩ
            game.cards.guns.forEach(gun => {
                // Ê£ÄÊü•Ëøô‰∏™Êû™ÊòØÂê¶Â∑≤ÁªèÂú®Âç°ÊßΩ‰∏≠
                if (!game.cardSlots.guns.some(g => g && g.id === gun.id) && 
                    game.player.gun.type !== gun.id) {
                    availableCards.push({...gun, type: 'gun'});
                }
            });
            
            // Ê£ÄÊü•ÊäÄËÉΩÂç°ÊßΩ
            game.cards.skills.forEach(skill => {
                // Ê£ÄÊü•Ëøô‰∏™ÊäÄËÉΩÊòØÂê¶Â∑≤ÁªèÂú®Âç°ÊßΩ‰∏≠
                if (!game.cardSlots.skills.some(s => s && s.id === skill.id)) {
                    availableCards.push({...skill, type: 'skill'});
                }
            });
            
            // Ê£ÄÊü•ÈÅìÂÖ∑Âç°ÊßΩ
            game.cards.items.forEach(item => {
                // Ê£ÄÊü•Ëøô‰∏™ÈÅìÂÖ∑ÊòØÂê¶Â∑≤ÁªèÂú®Âç°ÊßΩ‰∏≠
                if (!game.cardSlots.items.some(i => i && i.id === item.id)) {
                    availableCards.push({...item, type: 'item'});
                }
            });
            
            // Â¶ÇÊûúÊúâÂèØÁî®Âç°ÁâåÔºåÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™
            if (availableCards.length > 0) {
                return availableCards[Math.floor(Math.random() * availableCards.length)];
            }
            
            return null;
        }
        
        // Ê∑ªÂä†Âç°ÁâåÂà∞Âç°ÊßΩ
        function addCardToSlot(card) {
            switch (card.type) {
                case 'gun':
                    // ÊâæÂà∞Á©∫ÁöÑÊû™Ê¢∞Âç°ÊßΩ
                    const emptyGunSlot = game.cardSlots.guns.findIndex(slot => slot === null);
                    if (emptyGunSlot !== -1) {
                        game.cardSlots.guns[emptyGunSlot] = card;
                    }
                    break;
                    
                case 'skill':
                    // ÊâæÂà∞Á©∫ÁöÑÊäÄËÉΩÂç°ÊßΩ
                    const emptySkillSlot = game.cardSlots.skills.findIndex(slot => slot === null);
                    if (emptySkillSlot !== -1) {
                        game.cardSlots.skills[emptySkillSlot] = card;
                        // ÊäÄËÉΩËá™Âä®ÁîüÊïà
                        activateSkill(card.id);
                    }
                    break;
                    
                case 'item':
                    // ÊâæÂà∞Á©∫ÁöÑÈÅìÂÖ∑Âç°ÊßΩ
                    const emptyItemSlot = game.cardSlots.items.findIndex(slot => slot === null);
                    if (emptyItemSlot !== -1) {
                        game.cardSlots.items[emptyItemSlot] = card;
                        // ÈÅìÂÖ∑Ëá™Âä®ÁîüÊïà
                        activateItem(card.id);
                    }
                    break;
            }
        }
        
        // ÊøÄÊ¥ªÊäÄËÉΩ
        function activateSkill(skillId) {
            game.lastActiveSkillTimes[skillId] = 0;
        }
        
        // ÊøÄÊ¥ªÈÅìÂÖ∑
        function activateItem(itemId) {
            switch (itemId) {
                case 'lianshe':
                    game.activeEffects.rapidFire = true;
                    break;
                case 'gongjili':
                    game.activeEffects.damageBoost = true;
                    break;
                case 'heal':
                    game.activeEffects.healing = true;
                    break;
                case 'bingdong':
                    game.activeEffects.freezeBoost = true;
                    break;
            }
        }
        

        function updateJoystick(e) {
            const joystickContainer = document.getElementById('joystickContainer');
            const containerRect = joystickContainer.getBoundingClientRect();
            const middleCircle = document.getElementById('middleCircle');
            
            // ËÆ°ÁÆóÊëáÊùÜ‰∏≠ÂøÉ
            const centerX = containerRect.left + containerRect.width / 2;
            const centerY = containerRect.top + containerRect.height / 2;
            
            // ËÆ°ÁÆóËß¶Êë∏ÁÇπÁõ∏ÂØπ‰∫é‰∏≠ÂøÉÁöÑ‰ΩçÁΩÆ
            let deltaX = (e.clientX || e.pageX) - centerX;
            let deltaY = (e.clientY || e.pageY) - centerY;
            
            // ËÆ°ÁÆóË∑ùÁ¶ªÂíåËßíÂ∫¶
            const maxDistance = game.isIPad ? 80 : 50;
            const distance = Math.min(maxDistance, Math.sqrt(deltaX * deltaX + deltaY * deltaY));
            const angle = Math.atan2(deltaY, deltaX);
            
            // Êõ¥Êñ∞ÊëáÊùÜ‰ΩçÁΩÆ
            const x = distance * Math.cos(angle);
            const y = distance * Math.sin(angle);
            
            middleCircle.style.transform = `translate(${x}px, ${y}px)`;
            
            // Êõ¥Êñ∞Ê∏∏Êàè‰∏≠ÁöÑÊëáÊùÜÊï∞ÊçÆ
            game.joystick.angle = angle * 180 / Math.PI;
            game.player.direction = game.joystick.angle;
        }
        
        // ÈáçÁΩÆÊëáÊùÜ
        function resetJoystick() {
            const middleCircle = document.getElementById('middleCircle');
            middleCircle.style.transform = 'translate(0px, 0px)';
        }
        
        // ÁßªÂä®ÁΩëÊ†ºÔºà‰ª•Áé©ÂÆ∂ËßÜËßíÔºâ
        function moveGrid(direction) {
            // ÈáçÁΩÆÂú∞ÂõæÁßªÂä®ËÆ∞ÂΩï
            game.mapMovement = { dx: 0, dy: 0 };
            
            switch (direction) {
                case 'up':
                    moveGridDown(); // Âú∞ÂõæÂêë‰∏ãÁßªÂä®ÔºåËÆ©Áé©ÂÆ∂ÁúãËµ∑Êù•Âêë‰∏äÁßªÂä®
                    game.mapMovement.dy = -game.gridSize;
                    break;
                case 'down':
                    moveGridUp(); // Âú∞ÂõæÂêë‰∏äÁßªÂä®ÔºåËÆ©Áé©ÂÆ∂ÁúãËµ∑Êù•Âêë‰∏ãÁßªÂä®
                    game.mapMovement.dy = game.gridSize;
                    break;
                case 'left':
                    moveGridRight(); // Âú∞ÂõæÂêëÂè≥ÁßªÂä®ÔºåËÆ©Áé©ÂÆ∂ÁúãËµ∑Êù•ÂêëÂ∑¶ÁßªÂä®
                    game.mapMovement.dx = game.gridSize;
                    break;
                case 'right':
                    moveGridLeft(); // Âú∞ÂõæÂêëÂ∑¶ÁßªÂä®ÔºåËÆ©Áé©ÂÆ∂ÁúãËµ∑Êù•ÂêëÂè≥ÁßªÂä®
                    game.mapMovement.dx = -game.gridSize;
                    break;
            }
            
            // ÁßªÂä®Âú∫ÊôØ‰∏≠ÁöÑÊâÄÊúâÊïå‰∫∫ÂíåBoss
            moveEnemiesWithGrid(game.mapMovement.dx, game.mapMovement.dy);
            
            // Â§ÑÁêÜÁ¶ªÂ±èÊïå‰∫∫ÂíåBoss
            handleOffscreenEntities();
        }
        
        // ÁßªÂä®Êïå‰∫∫ÂíåBossË∑üÈöèÁΩëÊ†ºÁßªÂä®
        function moveEnemiesWithGrid(dx, dy) {
            // ÁßªÂä®ÊâÄÊúâÊïå‰∫∫
            for (let i = 0; i < game.enemies.length; i++) {
                game.enemies[i].x += dx;
                game.enemies[i].y += dy;
            }
            
            // ÁßªÂä®ÊâÄÊúâBoss
            for (let i = 0; i < game.bosses.length; i++) {
                game.bosses[i].x += dx;
                game.bosses[i].y += dy;
            }
            
            // ÁßªÂä®ÊâÄÊúâÊäÄËÉΩ
            for (let i = 0; i < game.skills.length; i++) {
                if (!game.skills[i].isPlayerBound) { // ‰∏çË∑üÈöèÁé©ÂÆ∂ÁöÑÊäÄËÉΩÈúÄË¶ÅÁßªÂä®
                    game.skills[i].x += dx;
                    game.skills[i].y += dy;
                }
            }
        }
        
        // Â§ÑÁêÜÁ¶ªÂ±èÊïå‰∫∫ÂíåBoss
        function handleOffscreenEntities() {
            // Ê£ÄÊü•Âπ∂Â§ÑÁêÜÁ¶ªÂ±èÊïå‰∫∫
            for (let i = game.enemies.length - 1; i >= 0; i--) {
                const enemy = game.enemies[i];
                if (isOffscreen(enemy)) {
                    // Â∞ÜÊïå‰∫∫ÁßªÂà∞Á¶ªÂ±èÂàóË°®
                    game.offscreenEnemies.push(enemy);
                    game.enemies.splice(i, 1);
                }
            }
            
            // Ê£ÄÊü•Âπ∂Â§ÑÁêÜÁ¶ªÂ±èBoss
            for (let i = game.bosses.length - 1; i >= 0; i--) {
                const boss = game.bosses[i];
                if (isOffscreen(boss)) {
                    // Â∞ÜBossÁßªÂà∞Á¶ªÂ±èÂàóË°®
                    game.offscreenBosses.push(boss);
                    game.bosses.splice(i, 1);
                }
            }
            
            // Â¶ÇÊûúÊúâÁ¶ªÂ±èÊïå‰∫∫ÔºåÈöèÊú∫ÈÄâÊã©‰∏Ä‰∫õÈáçÊñ∞ËøõÂÖ•Â±èÂπï
            if (game.offscreenEnemies.length > 0 && Math.random() < 0.3) {
                // ÊúÄÂ§öËøîÂõû3‰∏™Êïå‰∫∫
                const count = Math.min(3, game.offscreenEnemies.length);
                for (let i = 0; i < count; i++) {
                    if (game.offscreenEnemies.length > 0) {
                        const index = Math.floor(Math.random() * game.offscreenEnemies.length);
                        const enemy = game.offscreenEnemies[index];
                        
                        // ÈáçÊñ∞ÂÆö‰ΩçÊïå‰∫∫Âà∞Â±èÂπïËæπÁºò
                        repositionEntityToScreenEdge(enemy);
                        
                        // Â∞ÜÊïå‰∫∫Ê∑ªÂä†ÂõûÊ∏∏Êàè
                        game.enemies.push(enemy);
                        game.offscreenEnemies.splice(index, 1);
                    }
                }
            }
            
            // Â¶ÇÊûúÊúâÁ¶ªÂ±èBossÔºåËÆ©ÂÆÉ‰ª¨Êõ¥ÂÆπÊòìÂõûÂà∞Â±èÂπï
            if (game.offscreenBosses.length > 0 && Math.random() < 0.5) {
                const boss = game.offscreenBosses[0];
                
                // ÈáçÊñ∞ÂÆö‰ΩçBossÂà∞Â±èÂπïËæπÁºò
                repositionEntityToScreenEdge(boss);
                
                // Â∞ÜBossÊ∑ªÂä†ÂõûÊ∏∏Êàè
                game.bosses.push(boss);
                game.offscreenBosses.splice(0, 1);
            }
        }
        
        // Ê£ÄÊü•ÂÆû‰ΩìÊòØÂê¶Âú®Â±èÂπïÂ§ñ
        function isOffscreen(entity) {
            const margin = entity.radius * 2;
            return (entity.x < -margin || 
                    entity.x > game.width + margin || 
                    entity.y < -margin || 
                    entity.y > game.height + margin);
        }
        
        // Â∞ÜÂÆû‰ΩìÈáçÊñ∞ÂÆö‰ΩçÂà∞Â±èÂπïËæπÁºò
        function repositionEntityToScreenEdge(entity) {
            // ÈöèÊú∫ÈÄâÊã©ËæπÁºò
            const edge = Math.floor(Math.random() * 4);
            switch (edge) {
                case 0: // ‰∏äËæπÁºò
                    entity.x = Math.random() * game.width;
                    entity.y = -entity.radius;
                    break;
                case 1: // Âè≥ËæπÁºò
                    entity.x = game.width + entity.radius;
                    entity.y = Math.random() * game.height;
                    break;
                case 2: // ‰∏ãËæπÁºò
                    entity.x = Math.random() * game.width;
                    entity.y = game.height + entity.radius;
                    break;
                case 3: // Â∑¶ËæπÁºò
                    entity.x = -entity.radius;
                    entity.y = Math.random() * game.height;
                    break;
            }
        }
        
        // Âêë‰∏äÁßªÂä®ÁΩëÊ†º
        function moveGridUp() {
            const removedRow = game.grid.shift();
            game.removedRows.top.push(removedRow);
            
            // ‰ªéÂ∫ïÈÉ®Ê∑ªÂä†Êñ∞Ë°å
            let newRow;
            if (game.removedRows.bottom.length > 0) {
                newRow = game.removedRows.bottom.pop();
            } else {
                newRow = [];
                for (let x = 0; x < game.gridCols; x++) {
                    let cellType = 'normal';
                    const rand = Math.random();
                    if (rand < 0.03) {
                        cellType = 'treasure';
                    } else if (rand < 0.07) {
                        cellType = 'box';
                    }
                    
                    newRow.push({
                        type: cellType,
                        x: x * game.gridSize,
                        y: (game.gridRows - 1) * game.gridSize
                    });
                }
            }
            
            game.grid.push(newRow);
            
            // Êõ¥Êñ∞ÊâÄÊúâÊ†ºÂ≠êÁöÑYÂùêÊ†á
            for (let y = 0; y < game.grid.length; y++) {
                for (let x = 0; x < game.grid[y].length; x++) {
                    game.grid[y][x].y = y * game.gridSize;
                }
            }
        }
        
        // Âêë‰∏ãÁßªÂä®ÁΩëÊ†º
        function moveGridDown() {
            const removedRow = game.grid.pop();
            game.removedRows.bottom.push(removedRow);
            
            // ‰ªéÈ°∂ÈÉ®Ê∑ªÂä†Êñ∞Ë°å
            let newRow;
            if (game.removedRows.top.length > 0) {
                newRow = game.removedRows.top.pop();
            } else {
                newRow = [];
                for (let x = 0; x < game.gridCols; x++) {
                    let cellType = 'normal';
                    const rand = Math.random();
                    if (rand < 0.03) {
                        cellType = 'treasure';
                    } else if (rand < 0.07) {
                        cellType = 'box';
                    }
                    
                    newRow.push({
                        type: cellType,
                        x: x * game.gridSize,
                        y: 0
                    });
                }
            }
            
            game.grid.unshift(newRow);
            
            // Êõ¥Êñ∞ÊâÄÊúâÊ†ºÂ≠êÁöÑYÂùêÊ†á
            for (let y = 0; y < game.grid.length; y++) {
                for (let x = 0; x < game.grid[y].length; x++) {
                    game.grid[y][x].y = y * game.gridSize;
                }
            }
        }
        
        // ÂêëÂ∑¶ÁßªÂä®ÁΩëÊ†º
        function moveGridLeft() {
            // ‰ªéÊØè‰∏ÄË°åÁßªÈô§ÊúÄÂ∑¶ËæπÁöÑÊ†ºÂ≠ê
            const removedCol = [];
            for (let y = 0; y < game.grid.length; y++) {
                const cell = game.grid[y].shift();
                removedCol.push(cell);
            }
            game.removedCols.left.push(removedCol);
            
            // Âú®ÊØè‰∏ÄË°åÁöÑÂè≥ËæπÊ∑ªÂä†Êñ∞Ê†ºÂ≠ê
            let newCol;
            if (game.removedCols.right.length > 0) {
                newCol = game.removedCols.right.pop();
                for (let y = 0; y < game.grid.length; y++) {
                    game.grid[y].push(newCol[y]);
                }
            } else {
                for (let y = 0; y < game.grid.length; y++) {
                    let cellType = 'normal';
                    const rand = Math.random();
                    if (rand < 0.03) {
                        cellType = 'treasure';
                    } else if (rand < 0.07) {
                        cellType = 'box';
                    }
                    
                    game.grid[y].push({
                        type: cellType,
                        x: (game.gridCols - 1) * game.gridSize,
                        y: y * game.gridSize
                    });
                }
            }
            
            // Êõ¥Êñ∞ÊâÄÊúâÊ†ºÂ≠êÁöÑXÂùêÊ†á
            for (let y = 0; y < game.grid.length; y++) {
                for (let x = 0; x < game.grid[y].length; x++) {
                    game.grid[y][x].x = x * game.gridSize;
                }
            }
        }
        
        // ÂêëÂè≥ÁßªÂä®ÁΩëÊ†º
        function moveGridRight() {
            // ‰ªéÊØè‰∏ÄË°åÁßªÈô§ÊúÄÂè≥ËæπÁöÑÊ†ºÂ≠ê
            const removedCol = [];
            for (let y = 0; y < game.grid.length; y++) {
                const cell = game.grid[y].pop();
                removedCol.push(cell);
            }
            game.removedCols.right.push(removedCol);
            
            // Âú®ÊØè‰∏ÄË°åÁöÑÂ∑¶ËæπÊ∑ªÂä†Êñ∞Ê†ºÂ≠ê
            let newCol;
            if (game.removedCols.left.length > 0) {
                newCol = game.removedCols.left.pop();
                for (let y = 0; y < game.grid.length; y++) {
                    game.grid[y].unshift(newCol[y]);
                }
            } else {
                for (let y = 0; y < game.grid.length; y++) {
                    let cellType = 'normal';
                    const rand = Math.random();
                    if (rand < 0.1) {
                        cellType = 'treasure';
                    } else if (rand < 0.2) {
                        cellType = 'box';
                    }
                    
                    game.grid[y].unshift({
                        type: cellType,
                        x: 0,
                        y: y * game.gridSize
                    });
                }
            }
            
            // Êõ¥Êñ∞ÊâÄÊúâÊ†ºÂ≠êÁöÑXÂùêÊ†á
            for (let y = 0; y < game.grid.length; y++) {
                for (let x = 0; x < game.grid[y].length; x++) {
                    game.grid[y][x].x = x * game.gridSize;
                }
            }
        }
        
        // ÂèëÂ∞ÑÂ≠êÂºπ
        function fireBullet() {
            if (game.paused) return;
            
            const gunInfo = game.player.gun;
            const bulletCount = gunInfo.bulletCount;
            const bulletSpeed = gunInfo.bulletSpeed;
            let damage = gunInfo.damage;
            
            // Â∫îÁî®ÊîªÂáªÂäõÊèêÂçáÊïàÊûú
            if (game.activeEffects.damageBoost) {
                damage += 2;
            }
            
            // Â∫îÁî®ÂÜ∞ÂÜªÊèêÂçáÊïàÊûú
            let frozen = gunInfo.frozen;
            if (game.activeEffects.freezeBoost) {
                frozen = true;
            }
            
            for (let i = 0; i < bulletCount; i++) {
                // ËÆ°ÁÆóÊØè‰∏™Â≠êÂºπÁöÑËßíÂ∫¶ÂÅèÁßª
                let angleOffset = 0;
                if (bulletCount > 1) {
                    angleOffset = (i - Math.floor(bulletCount / 2)) * 10;
                }
                
                let angle = (game.player.direction + angleOffset) * Math.PI / 180;
                // Â¶ÇÊûúÁé©ÂÆ∂Ê≤°ÊúâÁßªÂä®Ôºå‰ΩÜÊëáÊùÜÊúâÊñπÂêëÔºåÂàô‰ΩøÁî®ÊëáÊùÜÊñπÂêë
                if (!game.keys.w && !game.keys.a && !game.keys.s && !game.keys.d &&
                    !game.keys.ArrowUp && !game.keys.ArrowDown && !game.keys.ArrowLeft && !game.keys.ArrowRight &&
                    game.joystick.active) {
                    angle = (game.joystick.angle + angleOffset) * Math.PI / 180;
                }
                
                // ËÆ°ÁÆóÂ≠êÂºπÂàùÂßã‰ΩçÁΩÆ
                const bulletX = game.player.x + Math.cos(angle) * (game.player.radius + 10);
                const bulletY = game.player.y + Math.sin(angle) * (game.player.radius + 10);
                
                // Ê∑ªÂä†Â≠êÂºπ
                game.bullets.push({
                    x: bulletX,
                    y: bulletY,
                    radius: 5,
                    color: gunInfo.color,
                    velocityX: Math.cos(angle) * bulletSpeed,
                    velocityY: Math.sin(angle) * bulletSpeed,
                    damage: damage,
                    frozen: frozen,
                    poison: gunInfo.poison
                });
                
                // Êí≠ÊîæÂ∞ÑÂáªÈü≥Êïà
                SoundManager.play('shoot');
            }
        }
        
        // ÁîüÊàêÊïå‰∫∫
        function spawnEnemy() {
            const now = Date.now();
            
            // ÁîüÊàêÂ∞èÊÄ™
            if (now - game.lastEnemySpawn > game.enemySpawnRate) {
                // Âú®ÈöèÊú∫‰ΩçÁΩÆÁîüÊàêÊïå‰∫∫
                const spawnX = Math.random() * game.width;
                const spawnY = Math.random() * game.height;
                
                game.enemies.push({
                    x: spawnX,
                    y: spawnY,
                    radius: 20, // Half of boss size (40 / 2)
                    color: 'red',
                    health: 3,
                    speed: game.difficultySettings.enemySpeed,
                    frozen: {
                        active: false,
                        duration: 0
                    }
                });
                
                game.lastEnemySpawn = now;
            }
            
            // ÁîüÊàêBoss
            if (now - game.lastBossSpawn > game.bossSpawnRate) {
                // Âú®ÈöèÊú∫‰ΩçÁΩÆÁîüÊàêBoss
                const spawnX = Math.random() * game.width;
                const spawnY = Math.random() * game.height;
                
                game.bosses.push({
                    x: spawnX,
                    y: spawnY,
                    radius: game.player.radius * 2,
                    color: 'darkred',
                    health: Math.min(game.difficultySettings.bossHealth * 2, 100), // Ë°ÄÈáèÁøªÂÄçÔºåÊúÄÈ´ò100
                    speed: game.difficultySettings.bossSpeed,
                    frozen: {
                        active: false,
                        duration: 0
                    }
                });
                
                game.lastBossSpawn = now;
            } else if (game.bosses.length === 0 && game.bossRespawnTime === 0) {
                // Â¶ÇÊûúÊ≤°ÊúâBoss‰∏îBossÈáçÁîüÊó∂Èó¥Êú™ËÆæÁΩÆÔºåÂàôËÆæÁΩÆÈáçÁîüÊó∂Èó¥
                game.bossRespawnTime = now + 3000; // 3ÁßíÂêéÈáçÁîü
            }

            // Ê£ÄÊü•BossÊòØÂê¶ÈúÄË¶ÅÈáçÁîü
            if (game.bossRespawnTime !== 0 && now >= game.bossRespawnTime) {
                // Âú®ÈöèÊú∫‰ΩçÁΩÆÁîüÊàêBoss
                const spawnX = Math.random() * game.width;
                const spawnY = Math.random() * game.height;

                game.bosses.push({
                    x: spawnX,
                    y: spawnY,
                    radius: game.player.radius * 2,
                    color: 'darkred',
                    health: 30,
                    speed: game.difficultySettings.bossSpeed,
                    frozen: {
                        active: false,
                        duration: 0
                    }
                });
                game.bossRespawnTime = 0; // ÈáçÁîüÂêéÈáçÁΩÆÊó∂Èó¥
            }
        }
        
        // Êõ¥Êñ∞Ê∏∏ÊàèÁä∂ÊÄÅ
        function update(deltaTime) {
            if (game.paused) return;
            
            game.gameTime += deltaTime;
            
            // Â§ÑÁêÜÊåâÈîÆËæìÂÖ•
            handleKeyInput();
            
            // ÁîüÊàêÊïå‰∫∫
            spawnEnemy();
            
            // Êõ¥Êñ∞Â≠êÂºπ
            updateBullets(deltaTime);
            
            // Êõ¥Êñ∞Êïå‰∫∫
            updateEnemies(deltaTime);
            
            // Êõ¥Êñ∞Boss
            updateBosses(deltaTime);
            
            // Êõ¥Êñ∞ÊäÄËÉΩ
            updateSkills(deltaTime);
            
            // Êõ¥Êñ∞ÁâπÊÆäÊïàÊûú
            updateEffects(deltaTime);
            
            // Ê£ÄÊü•Áé©ÂÆ∂ÊòØÂê¶Á´ôÂú®ÁâπÊÆäÊ†ºÂ≠ê‰∏ä
            checkPlayerOnSpecialCell();
            
            // Êõ¥Êñ∞Êä§Áõæ
            if (game.player.shield.active) {
                game.player.shield.duration -= deltaTime;
                if (game.player.shield.duration <= 0) {
                    game.player.shield.active = false;
                }
            }
            
            // Êõ¥Êñ∞ËßÜËßâÁâπÊïà
            EffectsManager.update(deltaTime);
        }
        
        // Â§ÑÁêÜÊåâÈîÆËæìÂÖ•
        function handleKeyInput() {
            if (game.keys.w || game.keys.ArrowUp) moveGrid('up');
            if (game.keys.a || game.keys.ArrowLeft) moveGrid('left');
            if (game.keys.s || game.keys.ArrowDown) moveGrid('down');
            if (game.keys.d || game.keys.ArrowRight) moveGrid('right');

            // Ë∞ÉÊï¥ÊîªÂáªËßíÂ∫¶
            if (game.keys.e) {
                game.player.direction = (game.player.direction - 15 + 360) % 360;
                game.keys.e = false; // ÊØèÊ¨°Êåâ‰∏ãÂè™Ë∞ÉÊï¥‰∏ÄÊ¨°
            }
            if (game.keys.r) {
                game.player.direction = (game.player.direction + 15) % 360;
                game.keys.r = false; // ÊØèÊ¨°Êåâ‰∏ãÂè™Ë∞ÉÊï¥‰∏ÄÊ¨°
            }
            
            // ËøûÂèë
            if (game.keys.space && game.activeEffects.rapidFire) {
                fireBullet();
            }
        }
        
        // Êõ¥Êñ∞Â≠êÂºπ
        function updateBullets(deltaTime) {
            for (let i = game.bullets.length - 1; i >= 0; i--) {
                const bullet = game.bullets[i];
                
                // ÁßªÂä®Â≠êÂºπ
                bullet.x += bullet.velocityX;
                bullet.y += bullet.velocityY;
                
                // Ê£ÄÊü•Â≠êÂºπÊòØÂê¶Ë∂ÖÂá∫Â±èÂπï
                if (bullet.x < 0 || bullet.x > game.width || bullet.y < 0 || bullet.y > game.height) {
                    game.bullets.splice(i, 1);
                    continue;
                }
                
                // Ê£ÄÊü•Â≠êÂºπÊòØÂê¶Âáª‰∏≠Êïå‰∫∫
                let hitEnemy = false;
                for (let j = game.enemies.length - 1; j >= 0; j--) {
                    const enemy = game.enemies[j];
                    const dx = bullet.x - enemy.x;
                    const dy = bullet.y - enemy.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < bullet.radius + enemy.radius) {
                        // ÈÄ†Êàê‰º§ÂÆ≥
                        enemy.health -= bullet.damage;
                        
                        // Êí≠ÊîæÂáª‰∏≠Èü≥ÊïàÂíåËßÜËßâÁâπÊïà
                        SoundManager.play('hit');
                        EffectsManager.createHitEffect(enemy.x, enemy.y, 'yellow');
                        EffectsManager.createDamageNumber(enemy.x, enemy.y, bullet.damage, 'white');
                        
                        // ÂÜ∞ÂÜªÊïàÊûú
                        if (bullet.frozen) {
                            enemy.frozen.active = true;
                            enemy.frozen.duration = 10000; // 10Áßí
                        }
                        
                        // ÊØíËçØÊïàÊûú
                        if (bullet.poison) {
                            enemy.health -= 3;
                        }
                        
                        // Â¶ÇÊûúÊïå‰∫∫Ê≠ª‰∫°
                        if (enemy.health <= 0) {
                            // Â•ñÂä±
                            game.player.coins += 10;
                            document.getElementById('coinsDisplay').textContent = `ÈìúÊùø: ${game.player.coins}`;
                            
                            // Êí≠ÊîæÊïå‰∫∫Ê≠ª‰∫°Èü≥ÊïàÂíåËßÜËßâÁâπÊïà
                            SoundManager.play('enemyDeath');
                            SoundManager.play('coin');
                            EffectsManager.createDeathEffect(enemy.x, enemy.y, 'red');
                            EffectsManager.createPickupEffect(enemy.x, enemy.y, '10', 'gold');
                            
                            // ÁßªÈô§Êïå‰∫∫
                            game.enemies.splice(j, 1);
                        }
                        
                        hitEnemy = true;
                        break;
                    }
                }
                
                // Ê£ÄÊü•Â≠êÂºπÊòØÂê¶Âáª‰∏≠Boss
                if (!hitEnemy) {
                    for (let j = game.bosses.length - 1; j >= 0; j--) {
                        const boss = game.bosses[j];
                        const dx = bullet.x - boss.x;
                        const dy = bullet.y - boss.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < bullet.radius + boss.radius) {
                            // ÈÄ†Êàê‰º§ÂÆ≥
                            boss.health -= bullet.damage;
                            
                            // Êí≠ÊîæÂáª‰∏≠Èü≥ÊïàÂíåËßÜËßâÁâπÊïà
                            SoundManager.play('hit');
                            EffectsManager.createHitEffect(boss.x, boss.y, 'orange');
                            EffectsManager.createDamageNumber(boss.x, boss.y, bullet.damage, 'white');
                            
                            // ÂÜ∞ÂÜªÊïàÊûú
                            if (bullet.frozen) {
                                boss.frozen.active = true;
                                boss.frozen.duration = 10000; // 10Áßí
                            }
                            
                            // ÊØíËçØÊïàÊûú
                            if (bullet.poison) {
                                boss.health -= 3;
                            }
                            
                            // Â•ñÂä±ÊØèÂáèÂ∞ë1Ë°ÄÁªô10ÈìúÊùø
                            game.player.coins += bullet.damage;
                            document.getElementById('coinsDisplay').textContent = `ÈìúÊùø: ${game.player.coins}`;
                            
                            // Â¶ÇÊûúBossÊ≠ª‰∫°
                            if (boss.health <= 0) {
                                // Êí≠ÊîæBossÊ≠ª‰∫°Èü≥ÊïàÂíåËßÜËßâÁâπÊïà
                                SoundManager.play('enemyDeath');
                                EffectsManager.createDeathEffect(boss.x, boss.y, 'darkred');
                                EffectsManager.createPickupEffect(boss.x, boss.y, '50', 'gold');
                                
                                // ÁßªÈô§Boss
                                game.bosses.splice(j, 1);
                                game.bossRespawnTime = Date.now() + 3000; // ËÆæÁΩÆ3ÁßíÂêéÈáçÁîü
                                // Áé©ÂÆ∂Ë°ÄÈáèÂ¢ûÂä†ÔºåÁøªÂÄçÂíå50ÂèñÊúÄÂ∞èÂÄº
                                game.player.health += Math.min(game.player.health, 50);
                                document.getElementById('healthDisplay').textContent = `Ë°ÄÈáè: ${game.player.health}`;
                            }
                            
                            hitEnemy = true;
                            break;
                        }
                    }
                }
                
                // Â¶ÇÊûúÂ≠êÂºπÂáª‰∏≠ÁõÆÊ†áÔºåÁßªÈô§Â≠êÂºπ
                if (hitEnemy) {
                    game.bullets.splice(i, 1);
                }
            }
        }
        
        // Êõ¥Êñ∞Êïå‰∫∫
        function updateEnemies(deltaTime) {
            for (let i = game.enemies.length - 1; i >= 0; i--) {
                const enemy = game.enemies[i];
                
                // Â¶ÇÊûúÊïå‰∫∫Ë¢´ÂÜªÁªìÔºåË∑≥ËøáÁßªÂä®
                if (enemy.frozen.active) {
                    enemy.frozen.duration -= deltaTime;
                    if (enemy.frozen.duration <= 0) {
                        enemy.frozen.active = false;
                    }
                    continue;
                }
                
                // ËÆ°ÁÆóÊïå‰∫∫Âà∞Áé©ÂÆ∂ÁöÑÊñπÂêë
                const dx = game.player.x - enemy.x;
                const dy = game.player.y - enemy.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                // ÁßªÂä®Êïå‰∫∫
                if (distance > 0) {
                    enemy.x += (dx / distance) * enemy.speed;
                    enemy.y += (dy / distance) * enemy.speed;
                }
                
                // Ê£ÄÊü•Êïå‰∫∫ÊòØÂê¶Á¢∞Âà∞Áé©ÂÆ∂
                if (distance < enemy.radius + game.player.radius) {
                    // Â¶ÇÊûúÁé©ÂÆ∂ÊúâÊä§ÁõæÔºå‰∏çÂèó‰º§ÂÆ≥
                    if (!game.player.shield.active) {
                        game.player.health -= game.difficultySettings.enemyDamage;
                        document.getElementById('healthDisplay').textContent = `Ë°ÄÈáè: ${game.player.health}`;
                        
                        // Ê£ÄÊü•Áé©ÂÆ∂ÊòØÂê¶Ê≠ª‰∫°
                        if (game.player.health <= 0) {
                            alert('Ê∏∏ÊàèÁªìÊùüÔºÅ');
                            location.reload(); // ÈáçÊñ∞Âä†ËΩΩÈ°µÈù¢‰ª•ÈáçÂêØÊ∏∏Êàè
                        }
                    }
                    
                    // ÁßªÈô§Êïå‰∫∫
                    game.enemies.splice(i, 1);
                }
            }
        }
        
        // Êõ¥Êñ∞Boss
        function updateBosses(deltaTime) {
            for (let i = game.bosses.length - 1; i >= 0; i--) {
                const boss = game.bosses[i];
                
                // Â¶ÇÊûúBossË¢´ÂÜªÁªìÔºåË∑≥ËøáÁßªÂä®
                if (boss.frozen.active) {
                    boss.frozen.duration -= deltaTime;
                    if (boss.frozen.duration <= 0) {
                        boss.frozen.active = false;
                    }
                    continue;
                }
                
                // ËÆ°ÁÆóBossÂà∞Áé©ÂÆ∂ÁöÑÊñπÂêë
                const dx = game.player.x - boss.x;
                const dy = game.player.y - boss.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                // ÁßªÂä®Boss
                if (distance > 0) {
                    boss.x += (dx / distance) * boss.speed;
                    boss.y += (dy / distance) * boss.speed;
                }
                
                // Ê£ÄÊü•BossÊòØÂê¶Á¢∞Âà∞Áé©ÂÆ∂
                if (distance < boss.radius + game.player.radius) {
                    // Â¶ÇÊûúÁé©ÂÆ∂ÊúâÊä§ÁõæÔºå‰∏çÂèó‰º§ÂÆ≥
                    if (!game.player.shield.active) {
                        game.player.health -= game.difficultySettings.bossDamage;
                        document.getElementById('healthDisplay').textContent = `Ë°ÄÈáè: ${game.player.health}`;
                        
                        // Ê£ÄÊü•Áé©ÂÆ∂ÊòØÂê¶Ê≠ª‰∫°
                        if (game.player.health <= 0) {
                            alert('Ê∏∏ÊàèÁªìÊùüÔºÅ');
                            location.reload(); // ÈáçÊñ∞Âä†ËΩΩÈ°µÈù¢‰ª•ÈáçÂêØÊ∏∏Êàè
                        }
                    }
                    
                    // Boss‰∏ç‰ºöÊ∂àÂ§±ÔºåÂè™‰ºöË¢´ÂáªÈÄÄ
                    const pushDistance = 50; // ÂáªÈÄÄË∑ùÁ¶ª
                    if (distance > 0) {
                        boss.x -= (dx / distance) * pushDistance;
                        boss.y -= (dy / distance) * pushDistance;
                    }
                }
            }
        }
        
        // Êõ¥Êñ∞ÊäÄËÉΩ
        function updateSkills(deltaTime) {
            // Ê£ÄÊü•ÊäÄËÉΩÂç°ÊßΩ‰∏≠ÁöÑÊäÄËÉΩ
            for (const skillCard of game.cardSlots.skills) {
                if (!skillCard) continue;
                
                const skillId = skillCard.id;
                const now = game.gameTime;
                
                // Á°Æ‰øùlastActiveSkillTimesÂ≠òÂú®
                if (!game.lastActiveSkillTimes[skillId]) {
                    game.lastActiveSkillTimes[skillId] = 0;
                }
                
                switch (skillId) {
                    case 'qiankun': // ‰πæÂù§Âúà
                        if (now - game.lastActiveSkillTimes[skillId] > 5000) { // ÊØè5Áßí
                            createQiankunCircles();
                            game.lastActiveSkillTimes[skillId] = now;
                        }
                        break;
                        
                    case 'huntian': // Ê∑∑Â§©Âáå
                        if (now - game.lastActiveSkillTimes[skillId] > 10000) { // ÊØè10Áßí
                            createHuntianLing();
                            game.lastActiveSkillTimes[skillId] = now;
                        }
                        break;
                        
                    case 'huojian': // ÁÅ´Â∞ñÊû™
                        if (now - game.lastActiveSkillTimes[skillId] > 500) { // ÊØè0.5Áßí
                            createHuojianSpear();
                            game.lastActiveSkillTimes[skillId] = now;
                        }
                        break;
                        
                    case 'fenghuolun': // È£éÁÅ´ËΩÆ
                        if (now - game.lastActiveSkillTimes[skillId] > 1000) { // ÊØè1Áßí
                            createFenghuoWheel();
                            game.lastActiveSkillTimes[skillId] = now;
                        }
                        break;
                        
                    case 'jiulong': // ‰πùÈæôÁõñÁÅ´ÁΩ©
                        if (now - game.lastActiveSkillTimes[skillId] > 50000) { // ÊØè50Áßí
                            createJiulongCover();
                            game.lastActiveSkillTimes[skillId] = now;
                        }
                        break;
                        
                    case 'bagua': // ÂÖ´Âç¶ÈòµÂÆùÂâë
                        if (now - game.lastActiveSkillTimes[skillId] > 3000) { // ÊØè3Áßí
                            createBaguaSwords();
                            game.lastActiveSkillTimes[skillId] = now;
                        }
                        break;
                        
                    case 'jinzhuan': // ÈáëÁ†ñ
                        if (now - game.lastActiveSkillTimes[skillId] > 1000) { // ÊØè1Áßí
                            createJinzhuanBricks();
                            game.lastActiveSkillTimes[skillId] = now;
                        }
                        break;
                        
                    case 'jianyu': // ÁÆ≠Èõ®
                        if (now - game.lastActiveSkillTimes[skillId] > 3000) { // ÊØè3Áßí
                            createJianyuArrows();
                            game.lastActiveSkillTimes[skillId] = now;
                        }
                        break;
                }
            }
            
            // Êõ¥Êñ∞Áé∞ÊúâÊäÄËÉΩÊïàÊûú
            for (let i = game.skills.length - 1; i >= 0; i--) {
                const skill = game.skills[i];
                
                // Êõ¥Êñ∞ÊäÄËÉΩ‰ΩçÁΩÆ
                if (skill.update) {
                    skill.update(deltaTime);
                }
                
                // Ê£ÄÊü•ÊäÄËÉΩÊòØÂê¶ËøáÊúü
                if (skill.duration !== undefined) {
                    skill.duration -= deltaTime;
                    if (skill.duration <= 0) {
                        game.skills.splice(i, 1);
                        continue;
                    }
                }
                
                // Ê£ÄÊü•ÊäÄËÉΩÊòØÂê¶Ë∂ÖÂá∫Â±èÂπï
                if (skill.x < -100 || skill.x > game.width + 100 || 
                    skill.y < -100 || skill.y > game.height + 100) {
                    if (!skill.isGlobal) {
                        game.skills.splice(i, 1);
                        continue;
                    }
                }
                
                // Ê£ÄÊü•ÊäÄËÉΩÊòØÂê¶Âáª‰∏≠Êïå‰∫∫
                for (let j = game.enemies.length - 1; j >= 0; j--) {
                    const enemy = game.enemies[j];
                    if (checkSkillHitEnemy(skill, enemy)) {
                        // Â∫îÁî®ÊäÄËÉΩÊïàÊûú
                        enemy.health -= skill.damage || 3;
                        
                        // Â¶ÇÊûúÊïå‰∫∫Ê≠ª‰∫°
                        if (enemy.health <= 0) {
                            // Â•ñÂä±
                            game.player.coins += 10;
                            document.getElementById('coinsDisplay').textContent = `ÈìúÊùø: ${game.player.coins}`;
                            
                            // ÁßªÈô§Êïå‰∫∫
                            game.enemies.splice(j, 1);
                        }
                        
                        // Â¶ÇÊûúÊäÄËÉΩÊòØ‰∏ÄÊ¨°ÊÄßÁöÑÔºåÁßªÈô§ÂÆÉ
                        if (skill.oneTime) {
                            game.skills.splice(i, 1);
                            break;
                        }
                    }
                }
                
                // Ê£ÄÊü•ÊäÄËÉΩÊòØÂê¶Âáª‰∏≠Boss
                for (let j = game.bosses.length - 1; j >= 0; j--) {
                    const boss = game.bosses[j];
                    if (checkSkillHitEnemy(skill, boss)) {
                        // Â∫îÁî®ÊäÄËÉΩÊïàÊûú
                        boss.health -= skill.damage || 3;
                        
                        // Â•ñÂä±ÊØèÂáèÂ∞ë1Ë°ÄÁªô10ÈìúÊùø
                        game.player.coins += skill.damage || 3;
                        document.getElementById('coinsDisplay').textContent = `ÈìúÊùø: ${game.player.coins}`;
                        
                        // Â¶ÇÊûúBossÊ≠ª‰∫°
                        if (boss.health <= 0) {
                            // ÁßªÈô§Boss
                            game.bosses.splice(j, 1);
                        }
                        
                        // Â¶ÇÊûúÊäÄËÉΩÊòØ‰∏ÄÊ¨°ÊÄßÁöÑÔºåÁßªÈô§ÂÆÉ
                        if (skill.oneTime) {
                            game.skills.splice(i, 1);
                            break;
                        }
                    }
                }
            }
        }
        
        // Ê£ÄÊü•ÊäÄËÉΩÊòØÂê¶Âáª‰∏≠Êïå‰∫∫
        function checkSkillHitEnemy(skill, enemy) {
            if (skill.type === 'circle') {
                const dx = skill.x - enemy.x;
                const dy = skill.y - enemy.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                return distance < skill.radius + enemy.radius;
            } else if (skill.type === 'rectangle') {
                // ÁÆÄÂçïÁöÑÁü©ÂΩ¢Á¢∞ÊíûÊ£ÄÊµã
                return (
                    skill.x < enemy.x + enemy.radius &&
                    skill.x + skill.width > enemy.x - enemy.radius &&
                    skill.y < enemy.y + enemy.radius &&
                    skill.y + skill.height > enemy.y - enemy.radius
                );
            }
            return false;
        }
        
        // ÂàõÂª∫‰πæÂù§Âúà
        function createQiankunCircles() {
            const circleCount = 6;
            for (let i = 0; i < circleCount; i++) {
                const angle = (i / circleCount) * Math.PI * 2;
                const distance = 80;
                
                game.skills.push({
                    type: 'circle',
                    x: game.player.x + Math.cos(angle) * distance,
                    y: game.player.y + Math.sin(angle) * distance,
                    radius: 15,
                    color: 'gold',
                    damage: 3,
                    duration: 5000,
                    angle: angle,
                    isPlayerBound: true, // Ë∑üÈöèÁé©ÂÆ∂
                    update: function(deltaTime) {
                        // ÊóãËΩ¨‰πæÂù§Âúà
                        this.angle += 0.005 * deltaTime;
                        this.x = game.player.x + Math.cos(this.angle) * distance;
                        this.y = game.player.y + Math.sin(this.angle) * distance;
                    }
                });
            }
        }
        
        // ÂàõÂª∫Ê∑∑Â§©Âáå
        function createHuntianLing() {
            const angle = Math.random() * Math.PI * 2;
            const speed = 5;
            
            game.skills.push({
                type: 'circle',
                x: game.player.x,
                y: game.player.y,
                radius: 20,
                color: 'purple',
                damage: 3,
                velocityX: Math.cos(angle) * speed,
                velocityY: Math.sin(angle) * speed,
                duration: 10000,
                update: function(deltaTime) {
                    // ÁßªÂä®Ê∑∑Â§©Âáå
                    this.x += this.velocityX;
                    this.y += this.velocityY;
                    
                    // Â¶ÇÊûúÁ¢∞Âà∞ËæπÁïåÔºåÂèçÂºπ
                    if (this.x < this.radius || this.x > game.width - this.radius) {
                        this.velocityX = -this.velocityX;
                    }
                    if (this.y < this.radius || this.y > game.height - this.radius) {
                        this.velocityY = -this.velocityY;
                    }
                }
            });
        }
        
        // ÂàõÂª∫ÁÅ´Â∞ñÊû™
        function createHuojianSpear() {
            // Ëé∑ÂèñÁé©ÂÆ∂ÁöÑÂèçÊñπÂêë
            const angle = (game.player.direction + 180) * Math.PI / 180;
            const distance = game.player.radius + 20;
            
            const spearX = game.player.x + Math.cos(angle) * distance;
            const spearY = game.player.y + Math.sin(angle) * distance;
            
            const spearLength = 30;
            const spearWidth = 8;
            
            game.skills.push({
                type: 'rectangle',
                x: spearX - (spearWidth / 2),
                y: spearY - (spearLength / 2),
                width: spearWidth,
                height: spearLength,
                angle: angle,
                color: 'orangered',
                damage: 3,
                duration: 500,
                isPlayerBound: true, // Ë∑üÈöèÁé©ÂÆ∂
                update: function(deltaTime) {
                    // ÁÅ´Â∞ñÊû™Ë∑üÈöèÁé©ÂÆ∂
                    this.angle = (game.player.direction + 180) * Math.PI / 180;
                    const spearX = game.player.x + Math.cos(this.angle) * distance;
                    const spearY = game.player.y + Math.sin(this.angle) * distance;
                    this.x = spearX - (spearWidth / 2);
                    this.y = spearY - (spearLength / 2);
                }
            });
        }
        
        // ÂàõÂª∫È£éÁÅ´ËΩÆ
        function createFenghuoWheel() {
            // Âú®Áé©ÂÆ∂ÂΩìÂâç‰ΩçÁΩÆÂàõÂª∫ÁÅ´ÁÑ∞ÁóïËøπ
            game.skills.push({
                type: 'circle',
                x: game.player.x,
                y: game.player.y,
                radius: 15,
                color: 'orange',
                damage: 3,
                duration: 5000,
                isGlobal: true
            });
        }
        
        // ÂàõÂª∫‰πùÈæôÁõñÁÅ´ÁΩ©ÔºàËåÉÂõ¥Â¢ûÂ§ß5ÂÄçÔºâ
        function createJiulongCover() {
            // Â¶ÇÊûúÊúâBossÔºå‰ºòÂÖàÁõñ‰ΩèBoss
            let targetX = game.player.x;
            let targetY = game.player.y;
            
            if (game.bosses.length > 0) {
                targetX = game.bosses[0].x;
                targetY = game.bosses[0].y;
            }
            
            game.skills.push({
                type: 'circle',
                x: targetX,
                y: targetY,
                radius: 500, // ËåÉÂõ¥Â¢ûÂ§ßÂà∞5ÂÄç
                color: 'rgba(255, 100, 0, 0.3)',
                damage: 40,
                duration: 3000,
                // oneTime: true // <-- BUG FIX: Removed this line
            });
        }
        
        // ÂàõÂª∫ÂÖ´Âç¶ÈòµÂÆùÂâë
        function createBaguaSwords() {
            const swordCount = 8;
            for (let i = 0; i < swordCount; i++) {
                const angle = (i / swordCount) * Math.PI * 2;
                const distance = 50;
                const speed = 5;
                
                game.skills.push({
                    type: 'rectangle',
                    x: game.player.x + Math.cos(angle) * distance,
                    y: game.player.y + Math.sin(angle) * distance,
                    width: 10,
                    height: 30,
                    angle: angle,
                    color: 'cyan',
                    damage: 5,
                    velocityX: Math.cos(angle) * speed,
                    velocityY: Math.sin(angle) * speed,
                    duration: 3000,
                    update: function(deltaTime) {
                        this.x += this.velocityX;
                        this.y += this.velocityY;
                    }
                });
            }
        }
        
        // ÂàõÂª∫ÈáëÁ†ñ
        function createJinzhuanBricks() {
            const brickCount = 10;
            for (let i = 0; i < brickCount; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = 3 + Math.random() * 2;
                
                game.skills.push({
                    type: 'rectangle',
                    x: game.player.x,
                    y: game.player.y,
                    width: 20,
                    height: 10,
                    angle: angle,
                    color: 'gold',
                    damage: 5,
                    velocityX: Math.cos(angle) * speed,
                    velocityY: Math.sin(angle) * speed,
                    duration: 5000,
                    update: function(deltaTime) {
                        this.x += this.velocityX;
                        this.y += this.velocityY;
                    }
                });
            }
        }
        
        // ÂàõÂª∫ÁÆ≠Èõ®
        function createJianyuArrows() {
            const arrowCount = 50;
            const baseAngle = Math.random() * Math.PI * 2;
            const angleSpread = Math.PI / 3; // 60Â∫¶ÊâáÂΩ¢
            
            for (let i = 0; i < arrowCount; i++) {
                const angle = baseAngle + (i / arrowCount - 0.5) * angleSpread;
                const speed = 5 + Math.random() * 2;
                
                game.skills.push({
                    type: 'rectangle',
                    x: game.player.x,
                    y: game.player.y,
                    width: 5,
                    height: 20,
                    angle: angle,
                    color: 'brown',
                    damage: 2,
                    velocityX: Math.cos(angle) * speed,
                    velocityY: Math.sin(angle) * speed,
                    duration: 5000,
                    update: function(deltaTime) {
                        this.x += this.velocityX;
                        this.y += this.velocityY;
                    }
                });
            }
        }
        
        // Êõ¥Êñ∞ÁâπÊÆäÊïàÊûú
        function updateEffects(deltaTime) {
            // Ê≤ªÁñóÊïàÊûú
            if (game.activeEffects.healing) {
                if (game.gameTime % 3000 < deltaTime) {
                    if (game.player.health < game.player.maxHealth) {
                        game.player.health += 1;
                        document.getElementById('healthDisplay').textContent = `Ë°ÄÈáè: ${game.player.health}`;
                    }
                }
            }
        }
        
        // Ê£ÄÊü•Áé©ÂÆ∂ÊòØÂê¶Á´ôÂú®ÁâπÊÆäÊ†ºÂ≠ê‰∏ä
        function checkPlayerOnSpecialCell() {
            const playerGridX = Math.floor(game.player.x / game.gridSize);
            const playerGridY = Math.floor(game.player.y / game.gridSize);
            
            // Á°Æ‰øùÊ†ºÂ≠êÁ¥¢ÂºïÂú®ÊúâÊïàËåÉÂõ¥ÂÜÖ
            if (playerGridY >= 0 && playerGridY < game.grid.length && 
                playerGridX >= 0 && playerGridX < game.grid[playerGridY].length) {
                
                const cell = game.grid[playerGridY][playerGridX];
                
                if (cell.type === 'treasure') {
                    // ÂÆùÁÆ±Ê†ºÂ≠êÔºöËé∑Âæó100ÈìúÊùø
                    game.player.coins += 100;
                    document.getElementById('coinsDisplay').textContent = `ÈìúÊùø: ${game.player.coins}`;
                    
                    // Êí≠ÊîæËé∑ÂæóÈìúÊùøÈü≥ÊïàÂíåËßÜËßâÁâπÊïà
                    SoundManager.play('coin');
                    EffectsManager.createPickupEffect(game.player.x, game.player.y - 30, '100', 'gold');
                    EffectsManager.createHitEffect(game.player.x, game.player.y, 'gold');
                    
                    cell.type = 'normal';
                } else if (cell.type === 'box') {
                    // ÁÆ±Â≠êÊ†ºÂ≠êÔºöËé∑Âæó‰øùÊä§ÁΩ©
                    game.player.shield.active = true;
                    game.player.shield.duration = 5000; // 5Áßí
                    
                    // Êí≠ÊîæËé∑ÂæóÊä§ÁõæÈü≥ÊïàÂíåËßÜËßâÁâπÊïà
                    SoundManager.play('shield');
                    EffectsManager.createHitEffect(game.player.x, game.player.y, 'cyan');
                    
                    cell.type = 'normal';
                }
            }
        }
        
        // ÁªòÂà∂Ê∏∏Êàè
        function draw() {
            // Ê∏ÖÁ©∫ÁîªÂ∏É
            game.ctx.clearRect(0, 0, game.width, game.height);
            
            // ÁªòÂà∂ÁΩëÊ†º
            drawGrid();
            
            // ÁªòÂà∂ÊäÄËÉΩ
            drawSkills();
            
            // ÁªòÂà∂Êïå‰∫∫
            drawEnemies();
            
            // ÁªòÂà∂Boss
            drawBosses();
            
            // ÁªòÂà∂Áé©ÂÆ∂
            drawPlayer();
            
            // ÁªòÂà∂Â≠êÂºπ
            drawBullets();
            
            // ÁªòÂà∂ËßÜËßâÁâπÊïà
            EffectsManager.draw(game.ctx);
        }
        
        // ÁªòÂà∂ÁΩëÊ†º
        function drawGrid() {
            for (let y = 0; y < game.grid.length; y++) {
                for (let x = 0; x < game.grid[y].length; x++) {
                    const cell = game.grid[y][x];
                    if (cell.type === 'treasure') {
                        game.ctx.drawImage(game.images.baoxiang, cell.x, cell.y, game.gridSize, game.gridSize);
                    } else if (cell.type === 'box') {
                        game.ctx.drawImage(game.images.muxiang, cell.x, cell.y, game.gridSize, game.gridSize);
                    } else {
                        game.ctx.fillStyle = '#d0d0d0';
                        game.ctx.fillRect(cell.x, cell.y, game.gridSize, game.gridSize);
                    }
                    game.ctx.strokeStyle = '#e0e0e0'; // Lighter grid lines
                    game.ctx.strokeRect(cell.x, cell.y, game.gridSize, game.gridSize);
                }
            }
        }
        
        // ÁªòÂà∂Áé©ÂÆ∂
        function drawPlayer() {
            // ÂàõÂª∫Áé©ÂÆ∂ÂõæÁâáÂÖÉÁ¥†ÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºâ
            if (!game.playerImage) {
                game.playerImage = new Image();
                game.playerImage.src = 'tools/player.png';
            }
            
            // ÁªòÂà∂Áé©ÂÆ∂ÂõæÁâá
            if (game.playerImage.complete) {
                game.ctx.save();
                game.ctx.translate(game.player.x, game.player.y);
                game.ctx.rotate((game.player.direction - 90) * Math.PI / 180);
                game.ctx.drawImage(
                    game.playerImage, 
                    -game.player.radius, 
                    -game.player.radius, 
                    game.player.radius * 2, 
                    game.player.radius * 2
                );
                game.ctx.restore();
            }
            
            // Â¶ÇÊûúÁé©ÂÆ∂ÊúâÊä§ÁõæÔºåÁªòÂà∂Êä§Áõæ
            if (game.player.shield.active) {
                game.ctx.beginPath();
                game.ctx.arc(game.player.x, game.player.y, game.player.radius + 5, 0, Math.PI * 2);
                game.ctx.strokeStyle = 'rgba(100, 200, 255, 0.7)';
                game.ctx.lineWidth = 3;
                game.ctx.stroke();
                game.ctx.closePath();
            }
        }
        
        // ÁªòÂà∂Êïå‰∫∫
        function drawEnemies() {
            // ÂàõÂª∫Êïå‰∫∫ÂõæÁâáÂÖÉÁ¥†ÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºâ
            if (!game.enemyImage) {
                game.enemyImage = new Image();
                game.enemyImage.src = 'tools/xiaoguai.png';
            }
            
            for (const enemy of game.enemies) {
                if (game.enemyImage.complete) {
                    game.ctx.drawImage(
                        game.enemyImage, 
                        enemy.x - enemy.radius, 
                        enemy.y - enemy.radius, 
                        enemy.radius * 2, 
                        enemy.radius * 2
                    );
                }
                
                // ÁªòÂà∂Ë°ÄÈáè
                game.ctx.fillStyle = 'white';
                game.ctx.font = '10px Arial';
                game.ctx.textAlign = 'center';
                game.ctx.fillText(enemy.health, enemy.x, enemy.y);
            }
        }
        
        // ÁªòÂà∂Boss
        function drawBosses() {
            // ÂàõÂª∫BossÂõæÁâáÂÖÉÁ¥†ÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºâ
            if (!game.bossImage) {
                game.bossImage = new Image();
                game.bossImage.src = 'tools/monster.png';
            }
            
            for (const boss of game.bosses) {
                if (game.bossImage.complete) {
                    game.ctx.drawImage(
                        game.bossImage, 
                        boss.x - boss.radius, 
                        boss.y - boss.radius, 
                        boss.radius * 2, 
                        boss.radius * 2
                    );
                }
                
                // ÁªòÂà∂Ë°ÄÈáè
                game.ctx.fillStyle = 'white';
                game.ctx.font = '16px Arial';
                game.ctx.textAlign = 'center';
                game.ctx.fillText(boss.health, boss.x, boss.y);
            }
        }
        
        // ÁªòÂà∂Â≠êÂºπ
        function drawBullets() {
            for (const bullet of game.bullets) {
                game.ctx.beginPath();
                game.ctx.arc(bullet.x, bullet.y, bullet.radius, 0, Math.PI * 2);
                game.ctx.fillStyle = bullet.color;
                game.ctx.fill();
                game.ctx.closePath();
            }
        }
        
        // ÁªòÂà∂ÊäÄËÉΩ
        function drawSkills() {
            for (const skill of game.skills) {
                if (skill.type === 'circle') {
                    game.ctx.beginPath();
                    game.ctx.arc(skill.x, skill.y, skill.radius, 0, Math.PI * 2);
                    game.ctx.fillStyle = skill.color;
                    game.ctx.fill();
                    game.ctx.closePath();
                } else if (skill.type === 'rectangle') {
                    // ‰øùÂ≠òÂΩìÂâçÁä∂ÊÄÅ
                    game.ctx.save();
                    
                    // Âπ≥ÁßªÂà∞Áü©ÂΩ¢‰∏≠ÂøÉ
                    game.ctx.translate(skill.x + skill.width / 2, skill.y + skill.height / 2);
                    
                    // ÊóãËΩ¨
                    if (skill.angle !== undefined) {
                        game.ctx.rotate(skill.angle);
                    }
                    
                    // ÁªòÂà∂Áü©ÂΩ¢
                    game.ctx.fillStyle = skill.color;
                    game.ctx.fillRect(-skill.width / 2, -skill.height / 2, skill.width, skill.height);
                    
                    // ÊÅ¢Â§çÁä∂ÊÄÅ
                    game.ctx.restore();
                }
            }
        }
        
        // Ê∏∏ÊàèÂæ™ÁéØ
        let lastTime = 0;
        function gameLoop(timestamp) {
            const deltaTime = timestamp - lastTime;
            lastTime = timestamp;
            
            update(deltaTime);
            draw();
            
            requestAnimationFrame(gameLoop);
        }
        
        // ÂêØÂä®Ê∏∏Êàè
        window.onload = initGame;
    </script>



</body></html>