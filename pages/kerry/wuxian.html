<!DOCTYPE html><html lang="zh"><head><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>无限地图抽卡游戏</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
            touch-action: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            background-color: #f0f0f0;
            overflow: hidden;
        }
        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            background-color: #e0e0e0;
        }
        .ui-button {
            position: absolute;
            width: 80px;
            height: 80px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 36px;
            font-weight: bold;
            user-select: none;
            z-index: 10;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            touch-action: manipulation;
        }
        /* 调整按钮位置，确保它们在iPad上可见 */
        #upButton {
            bottom: 220px;
            left: 100px;
        }
        #leftButton {
            bottom: 140px;
            left: 20px;
        }
        #downButton {
            bottom: 60px;
            left: 100px;
        }
        #rightButton {
            bottom: 140px;
            left: 180px;
        }
        #attackButton {
            bottom: 140px;
            right: 60px;
            width: 120px;
            height: 120px;
            font-size: 28px;
            background-color: rgba(255, 100, 100, 0.8);
        }
        #joystickContainer {
            position: absolute;
            width: 200px;
            height: 200px;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }
        .circle {
            position: absolute;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.5);
        }
        #outerCircle {
            width: 180px;
            height: 180px;
            left: 10px;
            top: 10px;
            border: 2px solid rgba(100, 100, 100, 0.5);
        }
        #middleCircle {
            width: 120px;
            height: 120px;
            left: 40px;
            top: 40px;
            background-color: rgba(100, 100, 255, 0.5);
            cursor: pointer;
        }
        #innerCircle {
            width: 60px;
            height: 60px;
            left: 70px;
            top: 70px;
            background-color: rgba(200, 200, 255, 0.8);
        }
        #shopButton {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 80px;
            height: 80px;
            background-color: rgba(255, 200, 100, 0.7);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            z-index: 10;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        #cardSlotButton {
            position: absolute;
            top: 20px;
            right: 110px;
            width: 80px;
            height: 80px;
            background-color: rgba(100, 200, 255, 0.7);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            z-index: 10;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        #statsContainer {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 15px;
            border-radius: 10px;
            font-size: 24px;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            width: 90%;
            max-width: 800px;
            border-radius: 15px;
            padding: 30px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .modal-header h2 {
            font-size: 32px;
            margin: 0;
        }
        .close-button {
            font-size: 36px;
            cursor: pointer;
            padding: 10px;
        }
        .card {
            width: 160px;
            height: 240px;
            background-color: #f0f0f0;
            border-radius: 15px;
            border: 3px solid #aaa;
            margin: 15px;
            display: inline-flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            box-sizing: border-box;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        .card-title {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
        }
        .card-image {
            width: 100px;
            height: 100px;
            background-color: #ddd;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
        }
        .card-description {
            font-size: 16px;
            text-align: center;
        }
        .card-slot-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 30px;
        }
        .card-slot {
            width: 120px;
            height: 180px;
            background-color: #e0e0e0;
            border-radius: 12px;
            border: 3px dashed #aaa;
            margin: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            color: #999;
        }
        .card-slot.filled {
            border: 3px solid #5a5;
            background-color: #efe;
        }
        .card-preview {
            width: 110px;
            height: 170px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            box-sizing: border-box;
            background-color: white;
        }
        .card-preview-title {
            font-size: 16px;
            font-weight: bold;
            text-align: center;
        }
        .card-preview-image {
            width: 60px;
            height: 60px;
            background-color: #ddd;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
        }
        .shop-section {
            text-align: center;
            margin-bottom: 30px;
        }
        .shop-section #shopCoinsDisplay {
            font-size: 28px;
            margin-bottom: 20px;
        }
        .buy-button {
            background-color: #5a5;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 15px 30px;
            font-size: 24px;
            cursor: pointer;
            margin-top: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .buy-button:hover {
            background-color: #494;
        }
        .shop-card-price {
            margin-top: 15px;
            font-weight: bold;
            font-size: 24px;
        }
        .slot-section-title {
            text-align: center;
            font-weight: bold;
            margin: 20px 0;
            padding: 10px;
            background-color: #eee;
            border-radius: 10px;
            font-size: 24px;
        }
        /* 为iPad添加的额外样式 */
        @media (min-width: 768px) and (max-width: 1024px) {
            .ui-button {
                width: 100px;
                height: 100px;
                font-size: 48px;
            }
            #upButton {
                bottom: 280px;
                left: 120px;
            }
            #leftButton {
                bottom: 180px;
                left: 20px;
            }
            #downButton {
                bottom: 80px;
                left: 120px;
            }
            #rightButton {
                bottom: 180px;
                left: 220px;
            }
            #attackButton {
                bottom: 180px;
                right: 80px;
                width: 150px;
                height: 150px;
                font-size: 36px;
            }
            #joystickContainer {
                width: 250px;
                height: 250px;
                bottom: 100px;
            }
            #outerCircle {
                width: 230px;
                height: 230px;
            }
            #middleCircle {
                width: 160px;
                height: 160px;
                left: 45px;
                top: 45px;
            }
            #innerCircle {
                width: 80px;
                height: 80px;
                left: 85px;
                top: 85px;
            }
            #statsContainer {
                font-size: 32px;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        
        <div id="statsContainer">
            <div id="healthDisplay">血量: 30</div>
            <div id="coinsDisplay">铜板: 0</div>
        </div>
        
        <div id="shopButton">商店</div>
        <div id="cardSlotButton">卡槽</div>
        
        <div class="ui-button" id="upButton">↑</div>
        <div class="ui-button" id="leftButton">←</div>
        <div class="ui-button" id="downButton">↓</div>
        <div class="ui-button" id="rightButton">→</div>
        <div class="ui-button" id="attackButton">攻击</div>
        
        <div id="joystickContainer">
            <div class="circle" id="outerCircle"></div>
            <div class="circle" id="middleCircle"></div>
            <div class="circle" id="innerCircle"></div>
        </div>
    </div>
    
    <div class="modal" id="shopModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>商店</h2>
                <span class="close-button" id="closeShop">×</span>
            </div>
            <div class="shop-section">
                <div id="shopCoinsDisplay">当前铜板: 0</div>
                <div class="card">
                    <div class="card-title">卡包</div>
                    <div class="card-image">卡包</div>
                    <div class="card-description">随机获得一张卡牌</div>
                </div>
                <div class="shop-card-price">价格: 50 铜板</div>
                <button class="buy-button" id="buyCardButton">购买</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="cardSlotModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>卡槽</h2>
                <span class="close-button" id="closeCardSlot">×</span>
            </div>
            
            <div class="slot-section-title">枪械卡槽</div>
            <div class="card-slot-container" id="gunCardSlots">
                <div class="card-slot" data-slot="0" data-type="gun">空槽</div>
                <div class="card-slot" data-slot="1" data-type="gun">空槽</div>
                <div class="card-slot" data-slot="2" data-type="gun">空槽</div>
            </div>
            
            <div class="slot-section-title">技能卡槽</div>
            <div class="card-slot-container" id="skillCardSlots">
                <div class="card-slot" data-slot="0" data-type="skill">空槽</div>
                <div class="card-slot" data-slot="1" data-type="skill">空槽</div>
                <div class="card-slot" data-slot="2" data-type="skill">空槽</div>
                <div class="card-slot" data-slot="3" data-type="skill">空槽</div>
                <div class="card-slot" data-slot="4" data-type="skill">空槽</div>
                <div class="card-slot" data-slot="5" data-type="skill">空槽</div>
                <div class="card-slot" data-slot="6" data-type="skill">空槽</div>
                <div class="card-slot" data-slot="7" data-type="skill">空槽</div>
            </div>
            
            <div class="slot-section-title">道具卡槽</div>
            <div class="card-slot-container" id="itemCardSlots">
                <div class="card-slot" data-slot="0" data-type="item">空槽</div>
                <div class="card-slot" data-slot="1" data-type="item">空槽</div>
                <div class="card-slot" data-slot="2" data-type="item">空槽</div>
                <div class="card-slot" data-slot="3" data-type="item">空槽</div>
            </div>
        </div>
    </div>

    <script>
        // 游戏主要对象
        const game = {
            canvas: null,
            ctx: null,
            width: 0,
            height: 0,
            gridSize: 40,
            gridCols: 30,
            gridRows: 15,
            grid: [],
            removedCols: { left: [], right: [] },
            removedRows: { top: [], bottom: [] },
            // 用于跟踪移出屏幕的敌人和Boss
            offscreenEnemies: [],
            offscreenBosses: [],
            player: {
                x: 0,
                y: 0,
                radius: 20,
                color: 'blue',
                health: 30, // 增加默认血量到30
                maxHealth: 30, // 增加最大血量到30
                direction: 90, // 方向（度数）
                shield: {
                    active: false,
                    duration: 0
                },
                coins: 0,
                gun: {
                    type: 'normal',
                    color: 'grey',
                    damage: 1,
                    bulletCount: 1,
                    bulletSpeed: 7,
                    frozen: false,
                    poison: false
                }
            },
            enemies: [],
            bosses: [],
            bullets: [],
            skills: [],
            lastEnemySpawn: 0,
            lastBossSpawn: 0,
            enemySpawnRate: 500, // 毫秒
            bossSpawnRate: 500000, // 毫秒
            keys: {
                w: false,
                a: false,
                s: false,
                d: false,
                space: false
            },
            joystick: {
                active: false,
                angle: 0
            },
            paused: false,
            gameTime: 0,
            cards: {
                guns: [
                    { id: 'fire', name: '火焰枪', description: '发射火焰子弹，伤害为2', color: 'red', damage: 2, bulletCount: 1, frozen: false, poison: false },
                    { id: 'ice', name: '寒冰枪', description: '发射寒冰子弹，可冻结敌人10秒', color: 'blue', damage: 1, bulletCount: 1, frozen: true, poison: false },
                    { id: 'doubleFire', name: '双倍火焰枪', description: '发射两个火焰子弹，每个伤害为2', color: 'red', damage: 2, bulletCount: 2, frozen: false, poison: false },
                    { id: 'doubleIce', name: '双倍寒冰枪', description: '发射两个寒冰子弹，可冻结敌人10秒', color: 'blue', damage: 1, bulletCount: 2, frozen: true, poison: false },
                    { id: 'poison', name: '毒药枪', description: '发射毒药子弹，伤害为3', color: 'purple', damage: 3, bulletCount: 1, frozen: false, poison: true }
                ],
                skills: [
                    { id: 'qiankun', name: '乾坤圈', description: '生成六个乾坤圈在玩家四周转动' },
                    { id: 'huntian', name: '混天凌', description: '在屏幕中飞来飞去，伤害为3' },
                    { id: 'huojian', name: '火尖枪', description: '在玩家背后，每隔0.5秒发射，伤害为3' },
                    { id: 'fenghuolun', name: '风火轮', description: '在地面上留下火焰痕迹，伤害为3' },
                    { id: 'jiulong', name: '九龙盖火罩', description: '每隔50秒出现一次，伤害为40' },
                    { id: 'bagua', name: '八卦阵宝剑', description: '向四面八方发射八卦阵，伤害为5' },
                    { id: 'jinzhuan', name: '金砖', description: '随机方向发射金砖，伤害为5' },
                    { id: 'jianyu', name: '箭雨', description: '朝随机方向发射50支箭，伤害为2' }
                ],
                items: [
                    { id: 'rapid', name: '连发', description: '长按攻击按键可以连续发射子弹' },
                    { id: 'damage', name: '攻击力提升', description: '每一次发射子弹的攻击力增加2' },
                    { id: 'heal', name: '增加血量', description: '每3秒+1血' },
                    { id: 'freeze', name: '冰冻提升', description: '给子弹增加冰冻特效，可冰冻10秒' }
                ]
            },
            cardSlots: {
                guns: [null, null, null],
                skills: [null, null, null, null, null, null, null, null],
                items: [null, null, null, null]
            },
            activeEffects: {
                rapidFire: false,
                damageBoost: false,
                healing: false,
                freezeBoost: false
            },
            lastActiveSkillTimes: {},
            // 用于跟踪地图移动的方向和距离
            mapMovement: {
                dx: 0,
                dy: 0
            },
            // 是否是iPad
            isIPad: false,
            // 游戏难度调整
            difficultySettings: {
                enemyDamage: 1,
                bossDamage: 2,
                enemySpeed: 2,
                bossSpeed: 1
            }
        };

        // 初始化游戏
        function initGame() {
            game.canvas = document.getElementById('gameCanvas');
            game.ctx = game.canvas.getContext('2d');
            
            // 检测是否为iPad
            checkDeviceType();
            
            // 设置画布尺寸
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // 设置玩家初始位置
            game.player.x = game.width / 2;
            game.player.y = game.height / 2;
            
            // 初始化网格
            initGrid();
            
            // 添加事件监听器
            setupEventListeners();
            
            // 设置商店和卡槽
            setupShopAndCardSlots();
            
            // 给玩家一些初始铜板，方便测试
            game.player.coins = 150;
            document.getElementById('coinsDisplay').textContent = `铜板: ${game.player.coins}`;
            
            // 启动游戏循环
            requestAnimationFrame(gameLoop);
        }
        
        // 检测设备类型
        function checkDeviceType() {
            // 检测是否为iPad
            const userAgent = navigator.userAgent.toLowerCase();
            const isIPad = /ipad/.test(userAgent) || 
                          (/macintosh/.test(userAgent) && 'ontouchend' in document);
            
            game.isIPad = isIPad;
            
            // 如果是iPad，调整UI大小
            if (isIPad) {
                document.documentElement.classList.add('ipad');
            }
        }
        
        // 调整画布大小
        function resizeCanvas() {
            game.width = window.innerWidth;
            game.height = window.innerHeight;
            game.canvas.width = game.width;
            game.canvas.height = game.height;
            
            // 更新摇杆位置
            const joystickContainer = document.getElementById('joystickContainer');
            joystickContainer.style.left = (game.width / 2) + 'px';
            
            // 如果是iPad，进一步调整UI尺寸
            if (game.isIPad) {
                adjustUIForIPad();
            }
        }
        
        // 为iPad调整UI
        function adjustUIForIPad() {
            // 调整操作按钮的大小和位置
            const buttons = document.querySelectorAll('.ui-button');
            buttons.forEach(button => {
                button.style.width = '120px';
                button.style.height = '120px';
                button.style.fontSize = '48px';
            });
            
            // 单独调整攻击按钮
            const attackButton = document.getElementById('attackButton');
            attackButton.style.width = '180px';
            attackButton.style.height = '180px';
            attackButton.style.fontSize = '40px';
            
            // 确保下方按钮在iPad上更清晰可见
            document.getElementById('downButton').style.bottom = '100px';
            
            // 调整摇杆大小
            const joystickContainer = document.getElementById('joystickContainer');
            joystickContainer.style.width = '300px';
            joystickContainer.style.height = '300px';
            joystickContainer.style.bottom = '120px';
            
            document.getElementById('outerCircle').style.width = '280px';
            document.getElementById('outerCircle').style.height = '280px';
            document.getElementById('middleCircle').style.width = '200px';
            document.getElementById('middleCircle').style.height = '200px';
            document.getElementById('middleCircle').style.left = '50px';
            document.getElementById('middleCircle').style.top = '50px';
            document.getElementById('innerCircle').style.width = '100px';
            document.getElementById('innerCircle').style.height = '100px';
            document.getElementById('innerCircle').style.left = '100px';
            document.getElementById('innerCircle').style.top = '100px';
        }
        
        // 初始化网格
        function initGrid() {
            game.grid = [];
            
            for (let y = 0; y < game.gridRows; y++) {
                const row = [];
                for (let x = 0; x < game.gridCols; x++) {
                    // 随机生成格子类型
                    let cellType = 'normal';
                    const rand = Math.random();
                    if (rand < 0.1) {
                        cellType = 'treasure';
                    } else if (rand < 0.2) {
                        cellType = 'box';
                    }
                    
                    row.push({
                        type: cellType,
                        x: x * game.gridSize,
                        y: y * game.gridSize
                    });
                }
                game.grid.push(row);
            }
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            // 键盘事件
            window.addEventListener('keydown', (e) => {
                switch (e.key.toLowerCase()) {
                    case 'w': game.keys.w = true; break;
                    case 'a': game.keys.a = true; break;
                    case 's': game.keys.s = true; break;
                    case 'd': game.keys.d = true; break;
                    case ' ': game.keys.space = true; fireBullet(); break;
                }
            });
            
            window.addEventListener('keyup', (e) => {
                switch (e.key.toLowerCase()) {
                    case 'w': game.keys.w = false; break;
                    case 'a': game.keys.a = false; break;
                    case 's': game.keys.s = false; break;
                    case 'd': game.keys.d = false; break;
                    case ' ': game.keys.space = false; break;
                }
            });
            
            // 方向按钮事件 - 增强触摸支持
            const directionButtons = ['upButton', 'leftButton', 'downButton', 'rightButton'];
            const directions = ['up', 'left', 'down', 'right'];
            
            directionButtons.forEach((buttonId, index) => {
                const button = document.getElementById(buttonId);
                
                // 触摸事件
                button.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    moveGrid(directions[index]);
                });
                
                // 鼠标事件
                button.addEventListener('mousedown', () => {
                    moveGrid(directions[index]);
                });
                
                // 长按支持
                let pressTimer = null;
                
                button.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    moveGrid(directions[index]);
                    pressTimer = setInterval(() => {
                        moveGrid(directions[index]);
                    }, 150);
                });
                
                button.addEventListener('mousedown', () => {
                    moveGrid(directions[index]);
                    pressTimer = setInterval(() => {
                        moveGrid(directions[index]);
                    }, 150);
                });
                
                const clearTimer = () => {
                    if (pressTimer) {
                        clearInterval(pressTimer);
                        pressTimer = null;
                    }
                };
                
                button.addEventListener('touchend', clearTimer);
                button.addEventListener('touchcancel', clearTimer);
                button.addEventListener('mouseup', clearTimer);
                button.addEventListener('mouseleave', clearTimer);
            });
            
            // 攻击按钮事件
            const attackButton = document.getElementById('attackButton');
            
            attackButton.addEventListener('touchstart', (e) => {
                e.preventDefault();
                fireBullet();
                if (game.activeEffects.rapidFire) {
                    game.attackInterval = setInterval(fireBullet, 200);
                }
            });
            
            attackButton.addEventListener('mousedown', () => {
                fireBullet();
                if (game.activeEffects.rapidFire) {
                    game.attackInterval = setInterval(fireBullet, 200);
                }
            });
            
            const stopAttack = () => {
                if (game.attackInterval) {
                    clearInterval(game.attackInterval);
                    game.attackInterval = null;
                }
            };
            
            attackButton.addEventListener('touchend', stopAttack);
            attackButton.addEventListener('touchcancel', stopAttack);
            attackButton.addEventListener('mouseup', stopAttack);
            attackButton.addEventListener('mouseleave', stopAttack);
            
            // 摇杆控制
            const middleCircle = document.getElementById('middleCircle');
            
            middleCircle.addEventListener('touchstart', (e) => {
                e.preventDefault();
                game.joystick.active = true;
                updateJoystick(e.touches[0]);
            });
            
            middleCircle.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (game.joystick.active) {
                    updateJoystick(e.touches[0]);
                }
            });
            
            middleCircle.addEventListener('touchend', () => {
                game.joystick.active = false;
                resetJoystick();
            });
            
            middleCircle.addEventListener('mousedown', (e) => {
                game.joystick.active = true;
                updateJoystick(e);
            });
            
            window.addEventListener('mousemove', (e) => {
                if (game.joystick.active) {
                    updateJoystick(e);
                }
            });
            
            window.addEventListener('mouseup', () => {
                game.joystick.active = false;
                resetJoystick();
            });
            
            // 阻止iOS上的双击缩放
            document.addEventListener('touchend', (e) => {
                const now = Date.now();
                const lastTouch = game.lastTouch || now;
                const delta = now - lastTouch;
                if (delta < 500 && delta > 0) {
                    e.preventDefault();
                }
                game.lastTouch = now;
            }, false);
            
            // 防止在iOS Safari上拖动导致整个页面移动
            document.addEventListener('touchmove', (e) => {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });
        }
        
        // 设置商店和卡槽
        function setupShopAndCardSlots() {
            const shopButton = document.getElementById('shopButton');
            const cardSlotButton = document.getElementById('cardSlotButton');
            const shopModal = document.getElementById('shopModal');
            const cardSlotModal = document.getElementById('cardSlotModal');
            const closeShop = document.getElementById('closeShop');
            const closeCardSlot = document.getElementById('closeCardSlot');
            const buyCardButton = document.getElementById('buyCardButton');
            
            // 打开商店
            shopButton.addEventListener('click', () => {
                document.getElementById('shopCoinsDisplay').textContent = `当前铜板: ${game.player.coins}`;
                game.paused = true;
                shopModal.style.display = 'flex';
            });
            
            // 关闭商店
            closeShop.addEventListener('click', () => {
                game.paused = false;
                shopModal.style.display = 'none';
            });
            
            // 打开卡槽
            cardSlotButton.addEventListener('click', () => {
                game.paused = true;
                updateCardSlotDisplay();
                cardSlotModal.style.display = 'flex';
            });
            
            // 关闭卡槽
            closeCardSlot.addEventListener('click', () => {
                game.paused = false;
                cardSlotModal.style.display = 'none';
            });
            
            // 购买卡牌
            buyCardButton.addEventListener('click', () => {
                if (game.player.coins >= 50) {
                    game.player.coins -= 50;
                    document.getElementById('shopCoinsDisplay').textContent = `当前铜板: ${game.player.coins}`;
                    
                    // 随机获取卡牌
                    const randomCard = getRandomCard();
                    
                    if (randomCard) {
                        // 添加卡牌到卡槽
                        addCardToSlot(randomCard);
                        
                        // 更新UI
                        document.getElementById('coinsDisplay').textContent = `铜板: ${game.player.coins}`;
                        alert(`获得了 ${randomCard.name}！`);
                    } else {
                        // 如果没有可用卡牌，返还铜板
                        game.player.coins += 50;
                        document.getElementById('shopCoinsDisplay').textContent = `当前铜板: ${game.player.coins}`;
                        alert('所有卡牌都已获得，无法购买更多卡牌。');
                    }
                } else {
                    alert('铜板不足！');
                }
            });
            
            // 添加卡槽点击事件
            const gunCardSlots = document.querySelectorAll('#gunCardSlots .card-slot');
            gunCardSlots.forEach(slot => {
                slot.addEventListener('click', () => {
                    const slotIndex = parseInt(slot.getAttribute('data-slot'));
                    const cardInfo = game.cardSlots.guns[slotIndex];
                    
                    if (cardInfo) {
                        // 更换当前枪支
                        const currentGun = game.player.gun;
                        
                        // 如果当前枪不是普通枪，保存它
                        if (currentGun.type !== 'normal') {
                            // 寻找空的枪槽
                            const emptySlotIndex = game.cardSlots.guns.findIndex(slot => slot === null);
                            if (emptySlotIndex !== -1) {
                                const gunInfo = game.cards.guns.find(g => g.id === currentGun.type);
                                game.cardSlots.guns[emptySlotIndex] = gunInfo;
                            }
                        }
                        
                        // 设置新枪
                        game.player.gun = {
                            type: cardInfo.id,
                            color: cardInfo.color,
                            damage: cardInfo.damage,
                            bulletCount: cardInfo.bulletCount,
                            bulletSpeed: 7,
                            frozen: cardInfo.frozen,
                            poison: cardInfo.poison
                        };
                        
                        // 移除选中的卡牌
                        game.cardSlots.guns[slotIndex] = null;
                        
                        // 更新UI
                        updateCardSlotDisplay();
                    }
                });
            });
        }
        
        // 更新卡槽显示
        function updateCardSlotDisplay() {
            // 更新枪械卡槽
            const gunCardSlots = document.querySelectorAll('#gunCardSlots .card-slot');
            gunCardSlots.forEach((slot, index) => {
                const cardInfo = game.cardSlots.guns[index];
                updateCardSlotUI(slot, cardInfo);
            });
            
            // 更新技能卡槽
            const skillCardSlots = document.querySelectorAll('#skillCardSlots .card-slot');
            skillCardSlots.forEach((slot, index) => {
                const cardInfo = game.cardSlots.skills[index];
                updateCardSlotUI(slot, cardInfo);
            });
            
            // 更新道具卡槽
            const itemCardSlots = document.querySelectorAll('#itemCardSlots .card-slot');
            itemCardSlots.forEach((slot, index) => {
                const cardInfo = game.cardSlots.items[index];
                updateCardSlotUI(slot, cardInfo);
            });
        }
        
        // 更新单个卡槽UI
        function updateCardSlotUI(slotElement, cardInfo) {
            if (cardInfo) {
                slotElement.classList.add('filled');
                slotElement.innerHTML = `
                    <div class="card-preview">
                        <div class="card-preview-title">${cardInfo.name}</div>
                        <div class="card-preview-image" style="background-color: ${cardInfo.color || '#ddd'}">${cardInfo.id}</div>
                        <div class="card-preview-description" style="font-size: 12px">${cardInfo.description}</div>
                    </div>
                `;
            } else {
                slotElement.classList.remove('filled');
                slotElement.textContent = '空槽';
            }
        }
        
        // 获取随机卡牌
        function getRandomCard() {
            // 组合所有可能的卡牌
            const availableCards = [];
            
            // 检查枪械卡槽
            game.cards.guns.forEach(gun => {
                // 检查这个枪是否已经在卡槽中
                if (!game.cardSlots.guns.some(g => g && g.id === gun.id) && 
                    game.player.gun.type !== gun.id) {
                    availableCards.push({...gun, type: 'gun'});
                }
            });
            
            // 检查技能卡槽
            game.cards.skills.forEach(skill => {
                // 检查这个技能是否已经在卡槽中
                if (!game.cardSlots.skills.some(s => s && s.id === skill.id)) {
                    availableCards.push({...skill, type: 'skill'});
                }
            });
            
            // 检查道具卡槽
            game.cards.items.forEach(item => {
                // 检查这个道具是否已经在卡槽中
                if (!game.cardSlots.items.some(i => i && i.id === item.id)) {
                    availableCards.push({...item, type: 'item'});
                }
            });
            
            // 如果有可用卡牌，随机选择一个
            if (availableCards.length > 0) {
                return availableCards[Math.floor(Math.random() * availableCards.length)];
            }
            
            return null;
        }
        
        // 添加卡牌到卡槽
        function addCardToSlot(card) {
            switch (card.type) {
                case 'gun':
                    // 找到空的枪械卡槽
                    const emptyGunSlot = game.cardSlots.guns.findIndex(slot => slot === null);
                    if (emptyGunSlot !== -1) {
                        game.cardSlots.guns[emptyGunSlot] = card;
                    }
                    break;
                    
                case 'skill':
                    // 找到空的技能卡槽
                    const emptySkillSlot = game.cardSlots.skills.findIndex(slot => slot === null);
                    if (emptySkillSlot !== -1) {
                        game.cardSlots.skills[emptySkillSlot] = card;
                        // 技能自动生效
                        activateSkill(card.id);
                    }
                    break;
                    
                case 'item':
                    // 找到空的道具卡槽
                    const emptyItemSlot = game.cardSlots.items.findIndex(slot => slot === null);
                    if (emptyItemSlot !== -1) {
                        game.cardSlots.items[emptyItemSlot] = card;
                        // 道具自动生效
                        activateItem(card.id);
                    }
                    break;
            }
        }
        
        // 激活技能
        function activateSkill(skillId) {
            game.lastActiveSkillTimes[skillId] = 0;
        }
        
        // 激活道具
        function activateItem(itemId) {
            switch (itemId) {
                case 'rapid':
                    game.activeEffects.rapidFire = true;
                    break;
                case 'damage':
                    game.activeEffects.damageBoost = true;
                    break;
                case 'heal':
                    game.activeEffects.healing = true;
                    break;
                case 'freeze':
                    game.activeEffects.freezeBoost = true;
                    break;
            }
        }
        
        // 更新摇杆
        function updateJoystick(e) {
            const joystickContainer = document.getElementById('joystickContainer');
            const containerRect = joystickContainer.getBoundingClientRect();
            const middleCircle = document.getElementById('middleCircle');
            
            // 计算摇杆中心
            const centerX = containerRect.left + containerRect.width / 2;
            const centerY = containerRect.top + containerRect.height / 2;
            
            // 计算触摸点相对于中心的位置
            let deltaX = (e.clientX || e.pageX) - centerX;
            let deltaY = (e.clientY || e.pageY) - centerY;
            
            // 计算距离和角度
            const maxDistance = game.isIPad ? 80 : 50;
            const distance = Math.min(maxDistance, Math.sqrt(deltaX * deltaX + deltaY * deltaY));
            const angle = Math.atan2(deltaY, deltaX);
            
            // 更新摇杆位置
            const x = distance * Math.cos(angle);
            const y = distance * Math.sin(angle);
            
            middleCircle.style.transform = `translate(${x}px, ${y}px)`;
            
            // 更新游戏中的摇杆数据
            game.joystick.angle = angle * 180 / Math.PI;
            game.player.direction = game.joystick.angle;
        }
        
        // 重置摇杆
        function resetJoystick() {
            const middleCircle = document.getElementById('middleCircle');
            middleCircle.style.transform = 'translate(0px, 0px)';
        }
        
        // 移动网格
        function moveGrid(direction) {
            // 重置地图移动记录
            game.mapMovement = { dx: 0, dy: 0 };
            
            switch (direction) {
                case 'up':
                    moveGridUp();
                    // 记录地图向下移动
                    game.mapMovement.dy = game.gridSize;
                    break;
                case 'down':
                    moveGridDown();
                    // 记录地图向上移动
                    game.mapMovement.dy = -game.gridSize;
                    break;
                case 'left':
                    moveGridLeft();
                    // 记录地图向右移动
                    game.mapMovement.dx = game.gridSize;
                    break;
                case 'right':
                    moveGridRight();
                    // 记录地图向左移动
                    game.mapMovement.dx = -game.gridSize;
                    break;
            }
            
            // 移动场景中的所有敌人和Boss
            moveEnemiesWithGrid(game.mapMovement.dx, game.mapMovement.dy);
            
            // 处理离屏敌人和Boss
            handleOffscreenEntities();
        }
        
        // 移动敌人和Boss跟随网格移动
        function moveEnemiesWithGrid(dx, dy) {
            // 移动所有敌人
            for (let i = 0; i < game.enemies.length; i++) {
                game.enemies[i].x += dx;
                game.enemies[i].y += dy;
            }
            
            // 移动所有Boss
            for (let i = 0; i < game.bosses.length; i++) {
                game.bosses[i].x += dx;
                game.bosses[i].y += dy;
            }
            
            // 移动所有技能
            for (let i = 0; i < game.skills.length; i++) {
                if (!game.skills[i].isPlayerBound) { // 不跟随玩家的技能需要移动
                    game.skills[i].x += dx;
                    game.skills[i].y += dy;
                }
            }
        }
        
        // 处理离屏敌人和Boss
        function handleOffscreenEntities() {
            // 检查并处理离屏敌人
            for (let i = game.enemies.length - 1; i >= 0; i--) {
                const enemy = game.enemies[i];
                if (isOffscreen(enemy)) {
                    // 将敌人移到离屏列表
                    game.offscreenEnemies.push(enemy);
                    game.enemies.splice(i, 1);
                }
            }
            
            // 检查并处理离屏Boss
            for (let i = game.bosses.length - 1; i >= 0; i--) {
                const boss = game.bosses[i];
                if (isOffscreen(boss)) {
                    // 将Boss移到离屏列表
                    game.offscreenBosses.push(boss);
                    game.bosses.splice(i, 1);
                }
            }
            
            // 如果有离屏敌人，随机选择一些重新进入屏幕
            if (game.offscreenEnemies.length > 0 && Math.random() < 0.3) {
                // 最多返回3个敌人
                const count = Math.min(3, game.offscreenEnemies.length);
                for (let i = 0; i < count; i++) {
                    if (game.offscreenEnemies.length > 0) {
                        const index = Math.floor(Math.random() * game.offscreenEnemies.length);
                        const enemy = game.offscreenEnemies[index];
                        
                        // 重新定位敌人到屏幕边缘
                        repositionEntityToScreenEdge(enemy);
                        
                        // 将敌人添加回游戏
                        game.enemies.push(enemy);
                        game.offscreenEnemies.splice(index, 1);
                    }
                }
            }
            
            // 如果有离屏Boss，让它们更容易回到屏幕
            if (game.offscreenBosses.length > 0 && Math.random() < 0.5) {
                const boss = game.offscreenBosses[0];
                
                // 重新定位Boss到屏幕边缘
                repositionEntityToScreenEdge(boss);
                
                // 将Boss添加回游戏
                game.bosses.push(boss);
                game.offscreenBosses.splice(0, 1);
            }
        }
        
        // 检查实体是否在屏幕外
        function isOffscreen(entity) {
            const margin = entity.radius * 2;
            return (entity.x < -margin || 
                    entity.x > game.width + margin || 
                    entity.y < -margin || 
                    entity.y > game.height + margin);
        }
        
        // 将实体重新定位到屏幕边缘
        function repositionEntityToScreenEdge(entity) {
            // 随机选择边缘
            const edge = Math.floor(Math.random() * 4);
            switch (edge) {
                case 0: // 上边缘
                    entity.x = Math.random() * game.width;
                    entity.y = -entity.radius;
                    break;
                case 1: // 右边缘
                    entity.x = game.width + entity.radius;
                    entity.y = Math.random() * game.height;
                    break;
                case 2: // 下边缘
                    entity.x = Math.random() * game.width;
                    entity.y = game.height + entity.radius;
                    break;
                case 3: // 左边缘
                    entity.x = -entity.radius;
                    entity.y = Math.random() * game.height;
                    break;
            }
        }
        
        // 向上移动网格
        function moveGridUp() {
            const removedRow = game.grid.shift();
            game.removedRows.top.push(removedRow);
            
            // 从底部添加新行
            let newRow;
            if (game.removedRows.bottom.length > 0) {
                newRow = game.removedRows.bottom.pop();
            } else {
                newRow = [];
                for (let x = 0; x < game.gridCols; x++) {
                    let cellType = 'normal';
                    const rand = Math.random();
                    if (rand < 0.1) {
                        cellType = 'treasure';
                    } else if (rand < 0.2) {
                        cellType = 'box';
                    }
                    
                    newRow.push({
                        type: cellType,
                        x: x * game.gridSize,
                        y: (game.gridRows - 1) * game.gridSize
                    });
                }
            }
            
            game.grid.push(newRow);
            
            // 更新所有格子的Y坐标
            for (let y = 0; y < game.grid.length; y++) {
                for (let x = 0; x < game.grid[y].length; x++) {
                    game.grid[y][x].y = y * game.gridSize;
                }
            }
        }
        
        // 向下移动网格
        function moveGridDown() {
            const removedRow = game.grid.pop();
            game.removedRows.bottom.push(removedRow);
            
            // 从顶部添加新行
            let newRow;
            if (game.removedRows.top.length > 0) {
                newRow = game.removedRows.top.pop();
            } else {
                newRow = [];
                for (let x = 0; x < game.gridCols; x++) {
                    let cellType = 'normal';
                    const rand = Math.random();
                    if (rand < 0.1) {
                        cellType = 'treasure';
                    } else if (rand < 0.2) {
                        cellType = 'box';
                    }
                    
                    newRow.push({
                        type: cellType,
                        x: x * game.gridSize,
                        y: 0
                    });
                }
            }
            
            game.grid.unshift(newRow);
            
            // 更新所有格子的Y坐标
            for (let y = 0; y < game.grid.length; y++) {
                for (let x = 0; x < game.grid[y].length; x++) {
                    game.grid[y][x].y = y * game.gridSize;
                }
            }
        }
        
        // 向左移动网格
        function moveGridLeft() {
            // 从每一行移除最左边的格子
            const removedCol = [];
            for (let y = 0; y < game.grid.length; y++) {
                const cell = game.grid[y].shift();
                removedCol.push(cell);
            }
            game.removedCols.left.push(removedCol);
            
            // 在每一行的右边添加新格子
            let newCol;
            if (game.removedCols.right.length > 0) {
                newCol = game.removedCols.right.pop();
                for (let y = 0; y < game.grid.length; y++) {
                    game.grid[y].push(newCol[y]);
                }
            } else {
                for (let y = 0; y < game.grid.length; y++) {
                    let cellType = 'normal';
                    const rand = Math.random();
                    if (rand < 0.1) {
                        cellType = 'treasure';
                    } else if (rand < 0.2) {
                        cellType = 'box';
                    }
                    
                    game.grid[y].push({
                        type: cellType,
                        x: (game.gridCols - 1) * game.gridSize,
                        y: y * game.gridSize
                    });
                }
            }
            
            // 更新所有格子的X坐标
            for (let y = 0; y < game.grid.length; y++) {
                for (let x = 0; x < game.grid[y].length; x++) {
                    game.grid[y][x].x = x * game.gridSize;
                }
            }
        }
        
        // 向右移动网格
        function moveGridRight() {
            // 从每一行移除最右边的格子
            const removedCol = [];
            for (let y = 0; y < game.grid.length; y++) {
                const cell = game.grid[y].pop();
                removedCol.push(cell);
            }
            game.removedCols.right.push(removedCol);
            
            // 在每一行的左边添加新格子
            let newCol;
            if (game.removedCols.left.length > 0) {
                newCol = game.removedCols.left.pop();
                for (let y = 0; y < game.grid.length; y++) {
                    game.grid[y].unshift(newCol[y]);
                }
            } else {
                for (let y = 0; y < game.grid.length; y++) {
                    let cellType = 'normal';
                    const rand = Math.random();
                    if (rand < 0.1) {
                        cellType = 'treasure';
                    } else if (rand < 0.2) {
                        cellType = 'box';
                    }
                    
                    game.grid[y].unshift({
                        type: cellType,
                        x: 0,
                        y: y * game.gridSize
                    });
                }
            }
            
            // 更新所有格子的X坐标
            for (let y = 0; y < game.grid.length; y++) {
                for (let x = 0; x < game.grid[y].length; x++) {
                    game.grid[y][x].x = x * game.gridSize;
                }
            }
        }
        
        // 发射子弹
        function fireBullet() {
            if (game.paused) return;
            
            const gunInfo = game.player.gun;
            const bulletCount = gunInfo.bulletCount;
            const bulletSpeed = gunInfo.bulletSpeed;
            let damage = gunInfo.damage;
            
            // 应用攻击力提升效果
            if (game.activeEffects.damageBoost) {
                damage += 2;
            }
            
            // 应用冰冻提升效果
            let frozen = gunInfo.frozen;
            if (game.activeEffects.freezeBoost) {
                frozen = true;
            }
            
            for (let i = 0; i < bulletCount; i++) {
                // 计算每个子弹的角度偏移
                let angleOffset = 0;
                if (bulletCount > 1) {
                    angleOffset = (i - Math.floor(bulletCount / 2)) * 10;
                }
                
                const angle = (game.player.direction + angleOffset) * Math.PI / 180;
                
                // 计算子弹初始位置
                const bulletX = game.player.x + Math.cos(angle) * (game.player.radius + 10);
                const bulletY = game.player.y + Math.sin(angle) * (game.player.radius + 10);
                
                // 添加子弹
                game.bullets.push({
                    x: bulletX,
                    y: bulletY,
                    radius: 5,
                    color: gunInfo.color,
                    velocityX: Math.cos(angle) * bulletSpeed,
                    velocityY: Math.sin(angle) * bulletSpeed,
                    damage: damage,
                    frozen: frozen,
                    poison: gunInfo.poison
                });
            }
        }
        
        // 生成敌人
        function spawnEnemy() {
            const now = Date.now();
            
            // 生成小怪
            if (now - game.lastEnemySpawn > game.enemySpawnRate) {
                // 在随机位置生成敌人
                const spawnX = Math.random() * game.width;
                const spawnY = Math.random() * game.height;
                
                game.enemies.push({
                    x: spawnX,
                    y: spawnY,
                    radius: game.player.radius / 2,
                    color: 'red',
                    health: 3,
                    speed: game.difficultySettings.enemySpeed,
                    frozen: {
                        active: false,
                        duration: 0
                    }
                });
                
                game.lastEnemySpawn = now;
            }
            
            // 生成Boss
            if (now - game.lastBossSpawn > game.bossSpawnRate) {
                // 在随机位置生成Boss
                const spawnX = Math.random() * game.width;
                const spawnY = Math.random() * game.height;
                
                game.bosses.push({
                    x: spawnX,
                    y: spawnY,
                    radius: game.player.radius * 2,
                    color: 'darkred',
                    health: 30,
                    speed: game.difficultySettings.bossSpeed,
                    frozen: {
                        active: false,
                        duration: 0
                    }
                });
                
                game.lastBossSpawn = now;
            }
        }
        
        // 更新游戏状态
        function update(deltaTime) {
            if (game.paused) return;
            
            game.gameTime += deltaTime;
            
            // 处理按键输入
            handleKeyInput();
            
            // 生成敌人
            spawnEnemy();
            
            // 更新子弹
            updateBullets(deltaTime);
            
            // 更新敌人
            updateEnemies(deltaTime);
            
            // 更新Boss
            updateBosses(deltaTime);
            
            // 更新技能
            updateSkills(deltaTime);
            
            // 更新特殊效果
            updateEffects(deltaTime);
            
            // 检查玩家是否站在特殊格子上
            checkPlayerOnSpecialCell();
            
            // 更新护盾
            if (game.player.shield.active) {
                game.player.shield.duration -= deltaTime;
                if (game.player.shield.duration <= 0) {
                    game.player.shield.active = false;
                }
            }
        }
        
        // 处理按键输入
        function handleKeyInput() {
            if (game.keys.w) moveGrid('up');
            if (game.keys.a) moveGrid('left');
            if (game.keys.s) moveGrid('down');
            if (game.keys.d) moveGrid('right');
            
            // 连发
            if (game.keys.space && game.activeEffects.rapidFire) {
                fireBullet();
            }
        }
        
        // 更新子弹
        function updateBullets(deltaTime) {
            for (let i = game.bullets.length - 1; i >= 0; i--) {
                const bullet = game.bullets[i];
                
                // 移动子弹
                bullet.x += bullet.velocityX;
                bullet.y += bullet.velocityY;
                
                // 检查子弹是否超出屏幕
                if (bullet.x < 0 || bullet.x > game.width || bullet.y < 0 || bullet.y > game.height) {
                    game.bullets.splice(i, 1);
                    continue;
                }
                
                // 检查子弹是否击中敌人
                let hitEnemy = false;
                for (let j = game.enemies.length - 1; j >= 0; j--) {
                    const enemy = game.enemies[j];
                    const dx = bullet.x - enemy.x;
                    const dy = bullet.y - enemy.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < bullet.radius + enemy.radius) {
                        // 造成伤害
                        enemy.health -= bullet.damage;
                        
                        // 冰冻效果
                        if (bullet.frozen) {
                            enemy.frozen.active = true;
                            enemy.frozen.duration = 10000; // 10秒
                        }
                        
                        // 毒药效果
                        if (bullet.poison) {
                            enemy.health -= 3;
                        }
                        
                        // 如果敌人死亡
                        if (enemy.health <= 0) {
                            // 奖励
                            game.player.coins += 10;
                            document.getElementById('coinsDisplay').textContent = `铜板: ${game.player.coins}`;
                            
                            // 移除敌人
                            game.enemies.splice(j, 1);
                        }
                        
                        hitEnemy = true;
                        break;
                    }
                }
                
                // 检查子弹是否击中Boss
                if (!hitEnemy) {
                    for (let j = game.bosses.length - 1; j >= 0; j--) {
                        const boss = game.bosses[j];
                        const dx = bullet.x - boss.x;
                        const dy = bullet.y - boss.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < bullet.radius + boss.radius) {
                            // 造成伤害
                            boss.health -= bullet.damage;
                            
                            // 冰冻效果
                            if (bullet.frozen) {
                                boss.frozen.active = true;
                                boss.frozen.duration = 10000; // 10秒
                            }
                            
                            // 毒药效果
                            if (bullet.poison) {
                                boss.health -= 3;
                            }
                            
                            // 奖励每减少1血给10铜板
                            game.player.coins += bullet.damage;
                            document.getElementById('coinsDisplay').textContent = `铜板: ${game.player.coins}`;
                            
                            // 如果Boss死亡
                            if (boss.health <= 0) {
                                // 移除Boss
                                game.bosses.splice(j, 1);
                            }
                            
                            hitEnemy = true;
                            break;
                        }
                    }
                }
                
                // 如果子弹击中目标，移除子弹
                if (hitEnemy) {
                    game.bullets.splice(i, 1);
                }
            }
        }
        
        // 更新敌人
        function updateEnemies(deltaTime) {
            for (let i = game.enemies.length - 1; i >= 0; i--) {
                const enemy = game.enemies[i];
                
                // 如果敌人被冻结，跳过移动
                if (enemy.frozen.active) {
                    enemy.frozen.duration -= deltaTime;
                    if (enemy.frozen.duration <= 0) {
                        enemy.frozen.active = false;
                    }
                    continue;
                }
                
                // 计算敌人到玩家的方向
                const dx = game.player.x - enemy.x;
                const dy = game.player.y - enemy.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                // 移动敌人
                if (distance > 0) {
                    enemy.x += (dx / distance) * enemy.speed;
                    enemy.y += (dy / distance) * enemy.speed;
                }
                
                // 检查敌人是否碰到玩家
                if (distance < enemy.radius + game.player.radius) {
                    // 如果玩家有护盾，不受伤害
                    if (!game.player.shield.active) {
                        game.player.health -= game.difficultySettings.enemyDamage;
                        document.getElementById('healthDisplay').textContent = `血量: ${game.player.health}`;
                        
                        // 检查玩家是否死亡
                        if (game.player.health <= 0) {
                            alert('游戏结束！');
                            location.reload(); // 重新加载页面以重启游戏
                        }
                    }
                    
                    // 移除敌人
                    game.enemies.splice(i, 1);
                }
            }
        }
        
        // 更新Boss
        function updateBosses(deltaTime) {
            for (let i = game.bosses.length - 1; i >= 0; i--) {
                const boss = game.bosses[i];
                
                // 如果Boss被冻结，跳过移动
                if (boss.frozen.active) {
                    boss.frozen.duration -= deltaTime;
                    if (boss.frozen.duration <= 0) {
                        boss.frozen.active = false;
                    }
                    continue;
                }
                
                // 计算Boss到玩家的方向
                const dx = game.player.x - boss.x;
                const dy = game.player.y - boss.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                // 移动Boss
                if (distance > 0) {
                    boss.x += (dx / distance) * boss.speed;
                    boss.y += (dy / distance) * boss.speed;
                }
                
                // 检查Boss是否碰到玩家
                if (distance < boss.radius + game.player.radius) {
                    // 如果玩家有护盾，不受伤害
                    if (!game.player.shield.active) {
                        game.player.health -= game.difficultySettings.bossDamage;
                        document.getElementById('healthDisplay').textContent = `血量: ${game.player.health}`;
                        
                        // 检查玩家是否死亡
                        if (game.player.health <= 0) {
                            alert('游戏结束！');
                            location.reload(); // 重新加载页面以重启游戏
                        }
                    }
                    
                    // Boss不会消失，只会被击退
                    const pushDistance = (boss.radius + game.player.radius) - distance;
                    if (distance > 0) {
                        boss.x -= (dx / distance) * pushDistance;
                        boss.y -= (dy / distance) * pushDistance;
                    }
                }
            }
        }
        
        // 更新技能
        function updateSkills(deltaTime) {
            // 检查技能卡槽中的技能
            for (const skillCard of game.cardSlots.skills) {
                if (!skillCard) continue;
                
                const skillId = skillCard.id;
                const now = game.gameTime;
                
                // 确保lastActiveSkillTimes存在
                if (!game.lastActiveSkillTimes[skillId]) {
                    game.lastActiveSkillTimes[skillId] = 0;
                }
                
                switch (skillId) {
                    case 'qiankun': // 乾坤圈
                        if (now - game.lastActiveSkillTimes[skillId] > 5000) { // 每5秒
                            createQiankunCircles();
                            game.lastActiveSkillTimes[skillId] = now;
                        }
                        break;
                        
                    case 'huntian': // 混天凌
                        if (now - game.lastActiveSkillTimes[skillId] > 10000) { // 每10秒
                            createHuntianLing();
                            game.lastActiveSkillTimes[skillId] = now;
                        }
                        break;
                        
                    case 'huojian': // 火尖枪
                        if (now - game.lastActiveSkillTimes[skillId] > 500) { // 每0.5秒
                            createHuojianSpear();
                            game.lastActiveSkillTimes[skillId] = now;
                        }
                        break;
                        
                    case 'fenghuolun': // 风火轮
                        if (now - game.lastActiveSkillTimes[skillId] > 1000) { // 每1秒
                            createFenghuoWheel();
                            game.lastActiveSkillTimes[skillId] = now;
                        }
                        break;
                        
                    case 'jiulong': // 九龙盖火罩
                        if (now - game.lastActiveSkillTimes[skillId] > 50000) { // 每50秒
                            createJiulongCover();
                            game.lastActiveSkillTimes[skillId] = now;
                        }
                        break;
                        
                    case 'bagua': // 八卦阵宝剑
                        if (now - game.lastActiveSkillTimes[skillId] > 3000) { // 每3秒
                            createBaguaSwords();
                            game.lastActiveSkillTimes[skillId] = now;
                        }
                        break;
                        
                    case 'jinzhuan': // 金砖
                        if (now - game.lastActiveSkillTimes[skillId] > 1000) { // 每1秒
                            createJinzhuanBricks();
                            game.lastActiveSkillTimes[skillId] = now;
                        }
                        break;
                        
                    case 'jianyu': // 箭雨
                        if (now - game.lastActiveSkillTimes[skillId] > 3000) { // 每3秒
                            createJianyuArrows();
                            game.lastActiveSkillTimes[skillId] = now;
                        }
                        break;
                }
            }
            
            // 更新现有技能效果
            for (let i = game.skills.length - 1; i >= 0; i--) {
                const skill = game.skills[i];
                
                // 更新技能位置
                if (skill.update) {
                    skill.update(deltaTime);
                }
                
                // 检查技能是否过期
                if (skill.duration !== undefined) {
                    skill.duration -= deltaTime;
                    if (skill.duration <= 0) {
                        game.skills.splice(i, 1);
                        continue;
                    }
                }
                
                // 检查技能是否超出屏幕
                if (skill.x < -100 || skill.x > game.width + 100 || 
                    skill.y < -100 || skill.y > game.height + 100) {
                    if (!skill.isGlobal) {
                        game.skills.splice(i, 1);
                        continue;
                    }
                }
                
                // 检查技能是否击中敌人
                for (let j = game.enemies.length - 1; j >= 0; j--) {
                    const enemy = game.enemies[j];
                    if (checkSkillHitEnemy(skill, enemy)) {
                        // 应用技能效果
                        enemy.health -= skill.damage || 3;
                        
                        // 如果敌人死亡
                        if (enemy.health <= 0) {
                            // 奖励
                            game.player.coins += 10;
                            document.getElementById('coinsDisplay').textContent = `铜板: ${game.player.coins}`;
                            
                            // 移除敌人
                            game.enemies.splice(j, 1);
                        }
                        
                        // 如果技能是一次性的，移除它
                        if (skill.oneTime) {
                            game.skills.splice(i, 1);
                            break;
                        }
                    }
                }
                
                // 检查技能是否击中Boss
                for (let j = game.bosses.length - 1; j >= 0; j--) {
                    const boss = game.bosses[j];
                    if (checkSkillHitEnemy(skill, boss)) {
                        // 应用技能效果
                        boss.health -= skill.damage || 3;
                        
                        // 奖励每减少1血给10铜板
                        game.player.coins += skill.damage || 3;
                        document.getElementById('coinsDisplay').textContent = `铜板: ${game.player.coins}`;
                        
                        // 如果Boss死亡
                        if (boss.health <= 0) {
                            // 移除Boss
                            game.bosses.splice(j, 1);
                        }
                        
                        // 如果技能是一次性的，移除它
                        if (skill.oneTime) {
                            game.skills.splice(i, 1);
                            break;
                        }
                    }
                }
            }
        }
        
        // 检查技能是否击中敌人
        function checkSkillHitEnemy(skill, enemy) {
            if (skill.type === 'circle') {
                const dx = skill.x - enemy.x;
                const dy = skill.y - enemy.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                return distance < skill.radius + enemy.radius;
            } else if (skill.type === 'rectangle') {
                // 简单的矩形碰撞检测
                return (
                    skill.x < enemy.x + enemy.radius &&
                    skill.x + skill.width > enemy.x - enemy.radius &&
                    skill.y < enemy.y + enemy.radius &&
                    skill.y + skill.height > enemy.y - enemy.radius
                );
            }
            return false;
        }
        
        // 创建乾坤圈
        function createQiankunCircles() {
            const circleCount = 6;
            for (let i = 0; i < circleCount; i++) {
                const angle = (i / circleCount) * Math.PI * 2;
                const distance = 80;
                
                game.skills.push({
                    type: 'circle',
                    x: game.player.x + Math.cos(angle) * distance,
                    y: game.player.y + Math.sin(angle) * distance,
                    radius: 15,
                    color: 'gold',
                    damage: 3,
                    duration: 5000,
                    angle: angle,
                    isPlayerBound: true, // 跟随玩家
                    update: function(deltaTime) {
                        // 旋转乾坤圈
                        this.angle += 0.005 * deltaTime;
                        this.x = game.player.x + Math.cos(this.angle) * distance;
                        this.y = game.player.y + Math.sin(this.angle) * distance;
                    }
                });
            }
        }
        
        // 创建混天凌
        function createHuntianLing() {
            const angle = Math.random() * Math.PI * 2;
            const speed = 5;
            
            game.skills.push({
                type: 'circle',
                x: game.player.x,
                y: game.player.y,
                radius: 20,
                color: 'purple',
                damage: 3,
                velocityX: Math.cos(angle) * speed,
                velocityY: Math.sin(angle) * speed,
                duration: 10000,
                update: function(deltaTime) {
                    // 移动混天凌
                    this.x += this.velocityX;
                    this.y += this.velocityY;
                    
                    // 如果碰到边界，反弹
                    if (this.x < this.radius || this.x > game.width - this.radius) {
                        this.velocityX = -this.velocityX;
                    }
                    if (this.y < this.radius || this.y > game.height - this.radius) {
                        this.velocityY = -this.velocityY;
                    }
                }
            });
        }
        
        // 创建火尖枪
        function createHuojianSpear() {
            // 获取玩家的反方向
            const angle = (game.player.direction + 180) * Math.PI / 180;
            const distance = game.player.radius + 20;
            
            const spearX = game.player.x + Math.cos(angle) * distance;
            const spearY = game.player.y + Math.sin(angle) * distance;
            
            const spearLength = 30;
            const spearWidth = 8;
            
            game.skills.push({
                type: 'rectangle',
                x: spearX - (spearWidth / 2),
                y: spearY - (spearLength / 2),
                width: spearWidth,
                height: spearLength,
                angle: angle,
                color: 'orangered',
                damage: 3,
                duration: 500,
                isPlayerBound: true, // 跟随玩家
                update: function(deltaTime) {
                    // 火尖枪跟随玩家
                    this.angle = (game.player.direction + 180) * Math.PI / 180;
                    const spearX = game.player.x + Math.cos(this.angle) * distance;
                    const spearY = game.player.y + Math.sin(this.angle) * distance;
                    this.x = spearX - (spearWidth / 2);
                    this.y = spearY - (spearLength / 2);
                }
            });
        }
        
        // 创建风火轮
        function createFenghuoWheel() {
            // 在玩家当前位置创建火焰痕迹
            game.skills.push({
                type: 'circle',
                x: game.player.x,
                y: game.player.y,
                radius: 15,
                color: 'orange',
                damage: 3,
                duration: 5000,
                isGlobal: true
            });
        }
        
        // 创建九龙盖火罩
        function createJiulongCover() {
            // 如果有Boss，优先盖住Boss
            let targetX = game.player.x;
            let targetY = game.player.y;
            
            if (game.bosses.length > 0) {
                targetX = game.bosses[0].x;
                targetY = game.bosses[0].y;
            }
            
            game.skills.push({
                type: 'circle',
                x: targetX,
                y: targetY,
                radius: 100,
                color: 'rgba(255, 100, 0, 0.5)',
                damage: 40,
                duration: 3000,
                oneTime: true
            });
        }
        
        // 创建八卦阵宝剑
        function createBaguaSwords() {
            const swordCount = 8;
            for (let i = 0; i < swordCount; i++) {
                const angle = (i / swordCount) * Math.PI * 2;
                const distance = 50;
                const speed = 5;
                
                game.skills.push({
                    type: 'rectangle',
                    x: game.player.x + Math.cos(angle) * distance,
                    y: game.player.y + Math.sin(angle) * distance,
                    width: 10,
                    height: 30,
                    angle: angle,
                    color: 'cyan',
                    damage: 5,
                    velocityX: Math.cos(angle) * speed,
                    velocityY: Math.sin(angle) * speed,
                    duration: 3000,
                    update: function(deltaTime) {
                        this.x += this.velocityX;
                        this.y += this.velocityY;
                    }
                });
            }
        }
        
        // 创建金砖
        function createJinzhuanBricks() {
            const brickCount = 10;
            for (let i = 0; i < brickCount; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = 3 + Math.random() * 2;
                
                game.skills.push({
                    type: 'rectangle',
                    x: game.player.x,
                    y: game.player.y,
                    width: 20,
                    height: 10,
                    angle: angle,
                    color: 'gold',
                    damage: 5,
                    velocityX: Math.cos(angle) * speed,
                    velocityY: Math.sin(angle) * speed,
                    duration: 5000,
                    update: function(deltaTime) {
                        this.x += this.velocityX;
                        this.y += this.velocityY;
                    }
                });
            }
        }
        
        // 创建箭雨
        function createJianyuArrows() {
            const arrowCount = 50;
            const baseAngle = Math.random() * Math.PI * 2;
            const angleSpread = Math.PI / 3; // 60度扇形
            
            for (let i = 0; i < arrowCount; i++) {
                const angle = baseAngle + (i / arrowCount - 0.5) * angleSpread;
                const speed = 5 + Math.random() * 2;
                
                game.skills.push({
                    type: 'rectangle',
                    x: game.player.x,
                    y: game.player.y,
                    width: 5,
                    height: 20,
                    angle: angle,
                    color: 'brown',
                    damage: 2,
                    velocityX: Math.cos(angle) * speed,
                    velocityY: Math.sin(angle) * speed,
                    duration: 5000,
                    update: function(deltaTime) {
                        this.x += this.velocityX;
                        this.y += this.velocityY;
                    }
                });
            }
        }
        
        // 更新特殊效果
        function updateEffects(deltaTime) {
            // 治疗效果
            if (game.activeEffects.healing) {
                if (game.gameTime % 3000 < deltaTime) {
                    if (game.player.health < game.player.maxHealth) {
                        game.player.health += 1;
                        document.getElementById('healthDisplay').textContent = `血量: ${game.player.health}`;
                    }
                }
            }
        }
        
        // 检查玩家是否站在特殊格子上
        function checkPlayerOnSpecialCell() {
            const playerGridX = Math.floor(game.player.x / game.gridSize);
            const playerGridY = Math.floor(game.player.y / game.gridSize);
            
            // 确保格子索引在有效范围内
            if (playerGridY >= 0 && playerGridY < game.grid.length && 
                playerGridX >= 0 && playerGridX < game.grid[playerGridY].length) {
                
                const cell = game.grid[playerGridY][playerGridX];
                
                if (cell.type === 'treasure') {
                    // 宝箱格子：获得100铜板
                    game.player.coins += 100;
                    document.getElementById('coinsDisplay').textContent = `铜板: ${game.player.coins}`;
                    cell.type = 'normal';
                } else if (cell.type === 'box') {
                    // 箱子格子：获得保护罩
                    game.player.shield.active = true;
                    game.player.shield.duration = 5000; // 5秒
                    cell.type = 'normal';
                }
            }
        }
        
        // 绘制游戏
        function draw() {
            // 清空画布
            game.ctx.clearRect(0, 0, game.width, game.height);
            
            // 绘制网格
            drawGrid();
            
            // 绘制技能
            drawSkills();
            
            // 绘制敌人
            drawEnemies();
            
            // 绘制Boss
            drawBosses();
            
            // 绘制玩家
            drawPlayer();
            
            // 绘制子弹
            drawBullets();
        }
        
        // 绘制网格
        function drawGrid() {
            for (let y = 0; y < game.grid.length; y++) {
                for (let x = 0; x < game.grid[y].length; x++) {
                    const cell = game.grid[y][x];
                    
                    // 设置格子颜色
                    let cellColor;
                    switch (cell.type) {
                        case 'treasure':
                            cellColor = 'gold';
                            break;
                        case 'box':
                            cellColor = 'brown';
                            break;
                        default:
                            cellColor = '#ccc';
                            break;
                    }
                    
                    // 绘制格子
                    game.ctx.fillStyle = cellColor;
                    game.ctx.fillRect(cell.x, cell.y, game.gridSize, game.gridSize);
                    
                    // 绘制格子边框
                    game.ctx.strokeStyle = '#aaa';
                    game.ctx.strokeRect(cell.x, cell.y, game.gridSize, game.gridSize);
                }
            }
        }
        
        // 绘制玩家
        function drawPlayer() {
            // 绘制玩家圆形
            game.ctx.beginPath();
            game.ctx.arc(game.player.x, game.player.y, game.player.radius, 0, Math.PI * 2);
            game.ctx.fillStyle = game.player.color;
            game.ctx.fill();
            game.ctx.closePath();
            
            // 如果玩家有护盾，绘制护盾
            if (game.player.shield.active) {
                game.ctx.beginPath();
                game.ctx.arc(game.player.x, game.player.y, game.player.radius + 5, 0, Math.PI * 2);
                game.ctx.strokeStyle = 'rgba(100, 200, 255, 0.7)';
                game.ctx.lineWidth = 3;
                game.ctx.stroke();
                game.ctx.closePath();
            }
            
            // 绘制枪
            const gunLength = 30;
            const gunWidth = 8;
            const angle = game.player.direction * Math.PI / 180;
            
            // 保存当前状态
            game.ctx.save();
            
            // 平移到玩家位置
            game.ctx.translate(game.player.x, game.player.y);
            
            // 旋转到玩家方向
            game.ctx.rotate(angle);
            
            // 绘制枪
            game.ctx.fillStyle = game.player.gun.color;
            game.ctx.fillRect(game.player.radius, -gunWidth/2, gunLength, gunWidth);
            
            // 恢复状态
            game.ctx.restore();
        }
        
        // 绘制敌人
        function drawEnemies() {
            for (const enemy of game.enemies) {
                game.ctx.beginPath();
                game.ctx.arc(enemy.x, enemy.y, enemy.radius, 0, Math.PI * 2);
                
                // 如果敌人被冻结，使用蓝色
                if (enemy.frozen.active) {
                    game.ctx.fillStyle = 'lightblue';
                } else {
                    game.ctx.fillStyle = enemy.color;
                }
                
                game.ctx.fill();
                game.ctx.closePath();
                
                // 绘制血量
                game.ctx.fillStyle = 'white';
                game.ctx.font = '10px Arial';
                game.ctx.textAlign = 'center';
                game.ctx.fillText(enemy.health, enemy.x, enemy.y);
            }
        }
        
        // 绘制Boss
        function drawBosses() {
            for (const boss of game.bosses) {
                game.ctx.beginPath();
                game.ctx.arc(boss.x, boss.y, boss.radius, 0, Math.PI * 2);
                
                // 如果Boss被冻结，使用蓝色
                if (boss.frozen.active) {
                    game.ctx.fillStyle = 'lightblue';
                } else {
                    game.ctx.fillStyle = boss.color;
                }
                
                game.ctx.fill();
                game.ctx.closePath();
                
                // 绘制血量
                game.ctx.fillStyle = 'white';
                game.ctx.font = '16px Arial';
                game.ctx.textAlign = 'center';
                game.ctx.fillText(boss.health, boss.x, boss.y);
            }
        }
        
        // 绘制子弹
        function drawBullets() {
            for (const bullet of game.bullets) {
                game.ctx.beginPath();
                game.ctx.arc(bullet.x, bullet.y, bullet.radius, 0, Math.PI * 2);
                game.ctx.fillStyle = bullet.color;
                game.ctx.fill();
                game.ctx.closePath();
            }
        }
        
        // 绘制技能
        function drawSkills() {
            for (const skill of game.skills) {
                if (skill.type === 'circle') {
                    game.ctx.beginPath();
                    game.ctx.arc(skill.x, skill.y, skill.radius, 0, Math.PI * 2);
                    game.ctx.fillStyle = skill.color;
                    game.ctx.fill();
                    game.ctx.closePath();
                } else if (skill.type === 'rectangle') {
                    // 保存当前状态
                    game.ctx.save();
                    
                    // 平移到矩形中心
                    game.ctx.translate(skill.x + skill.width / 2, skill.y + skill.height / 2);
                    
                    // 旋转
                    if (skill.angle !== undefined) {
                        game.ctx.rotate(skill.angle);
                    }
                    
                    // 绘制矩形
                    game.ctx.fillStyle = skill.color;
                    game.ctx.fillRect(-skill.width / 2, -skill.height / 2, skill.width, skill.height);
                    
                    // 恢复状态
                    game.ctx.restore();
                }
            }
        }
        
        // 游戏循环
        let lastTime = 0;
        function gameLoop(timestamp) {
            const deltaTime = timestamp - lastTime;
            lastTime = timestamp;
            
            update(deltaTime);
            draw();
            
            requestAnimationFrame(gameLoop);
        }
        
        // 启动游戏
        window.onload = initGame;
    </script>


</body></html>
