<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Buckshot Roulette å®Œæ•´é“å…·ç‰ˆ</title>
<style>
  body{background:#111;color:#eee;font-family:Arial;text-align:center;margin-top:20px}
  #gun{display:inline-block;background:#333;border:4px solid #555;border-radius:50%;width:120px;height:120px;line-height:120px;font-size:40px;margin:10px}
  #log{width:400px;height:180px;margin:10px auto;text-align:left;background:#222;border:1px solid #444;padding:8px;overflow-y:auto;font-size:14px}
  button{margin:4px;padding:6px 12px;font-size:14px;cursor:pointer}
  .item{display:inline-block;margin:4px;padding:4px 8px;background:#444;border:1px solid #666;border-radius:4px;cursor:pointer;font-size:18px}
  .disabled{opacity:.4;cursor:not-allowed}
  .red{color:#ff4d4d}.cyan{color:#4dffff}.yellow{color:#ffcc00}
</style>
</head>
<body>

<h2>æ¶é­”è½®èµŒ Â· å®Œæ•´é“å…·ç‰ˆ</h2>

<div id="gun">ğŸ”«</div>
<br>

<div id="items"></div>
<br>
<button onclick="endItemPhase()">ç»“æŸé“å…·é˜¶æ®µ</button>
<button onclick="shoot('player')">å¯¹è‡ªå·±å¼€æª</button>
<button onclick="shoot('enemy')">å¯¹æ¶é­”å¼€æª</button>
<button onclick="newRound()">ä¸‹ä¸€å±€</button>

<div id="log"></div>

<script>
/* ************  å…¨å±€çŠ¶æ€  ************ */
const TOTAL = 10;
const BLANK_PROB = 0.7;

let chamber = [];
let current = 0;
let hpPlayer = 2, hpEnemy = 2;
let gameOver = false;
let playerExtraTurn = false;
let skipNextEnemy = false;   // æ‰‹é“æ•ˆæœ
let nextShotDmg = 1;         // æ‰‹é”¯+1

// é“å…·æŒæœ‰
let itemsPlayer = { magnifier:0, saw:0, inverter:0, cig:0, beer:0, cuffs:0 };
let itemsEnemy  = { magnifier:0, saw:0, inverter:0, cig:0, beer:0, cuffs:0 };

const ITEM_ICONS = {
  magnifier:'ğŸ”', saw:'ğŸª“', inverter:'ğŸ”„', cig:'ğŸš¬', beer:'ğŸ¥¤', cuffs:'ğŸ”—'
};

/* ************  å·¥å…·å‡½æ•°  ************ */
function rand(n){ return Math.floor(Math.random()*n) }
function log(msg){
  const box = document.getElementById('log');
  box.innerHTML += msg + '<br>';
  box.scrollTop = box.scrollHeight;
}
function updateGun(){
  document.getElementById('gun').textContent = (chamber[current]?'ğŸ”´':'âšª') + '  ğŸ”«';
}
function remainReport(){
  const rest = chamber.slice(current);
  const live = rest.filter(Boolean).length;
  const blank= rest.length - live;
  log(`å‰©ä½™ï¼šå®å¼¹ ${live} å‘ï¼Œç©ºåŒ…å¼¹ ${blank} å‘`);
}
function hpReport(){
  log(`ã€è¡€é‡ã€‘ä½ ï¼š${hpPlayer}  æ¶é­”ï¼š${hpEnemy}`);
}

/* ************  é“å…·å‘æ”¾  ************ */
function giveItems(){
  // æ¸…ç©º
  Object.keys(itemsPlayer).forEach(k=> itemsPlayer[k]=0);
  Object.keys(itemsEnemy ).forEach(k=> itemsEnemy[k]=0);
  // åŸç‰ˆåˆ†å¸ƒï¼šæ¯å›åˆåŒæ–¹å„éšæœºæ‹¿ 2~4 ä¸ªé“å…·
  const pool = ['magnifier','saw','inverter','cig','beer','cuffs'];
  const pick = ()=> pool[rand(pool.length)];
  for(let i=0;i<rand(3)+2;i++) itemsPlayer[pick()]++;
  for(let i=0;i<rand(3)+2;i++) itemsEnemy [pick()]++;
  renderItems();
}
function renderItems(){
  const div = document.getElementById('items');
  div.innerHTML = '';
  Object.entries(itemsPlayer).forEach(([name,n])=>{
    if(n<=0) return;
    const btn = document.createElement('span');
    btn.className = 'item';
    btn.textContent = ITEM_ICONS[name] + 'Ã—' + n;
    btn.onclick = ()=> useItem(name);
    div.appendChild(btn);
  });
}

/* ************  ä½¿ç”¨é“å…·  ************ */
function useItem(name){
  if(gameOver) return;
  if(itemsPlayer[name]<=0) return;
  itemsPlayer[name]--;
  log('<span class="yellow">ä½¿ç”¨é“å…·ï¼š'+ITEM_ICONS[name]+' '+name+'</span>');
  switch(name){
    case 'magnifier':
      if(current<chamber.length) log('ä¸‹ä¸€å‘æ˜¯ï¼š'+(chamber[current]?'ğŸ”´å®å¼¹':'âšªç©ºåŒ…å¼¹'));
      else log('å¼¹å·¢å·²ç©º');
      break;
    case 'saw':
      nextShotDmg = 2;
      log('æ‰‹é”¯å¯åŠ¨ï¼šä¸‹ä¸€å‘å®å¼¹ä¼¤å®³+1ï¼ˆä»…ä¸€æ¬¡ï¼‰');
      break;
    case 'inverter':
      if(current<chamber.length){
        chamber[current] = !chamber[current];
        log('é€†è½¬å™¨ï¼šä¸‹ä¸€å‘å·²ç¿»è½¬');
      }else log('å¼¹å·¢å·²ç©º');
      break;
    case 'cig':
      if(hpPlayer<2){ hpPlayer++; log('é¦™çƒŸï¼šå›å¤1è¡€'); hpReport();}
      else log('é¦™çƒŸï¼šè¡€é‡å·²æ»¡');
      break;
    case 'beer':
      if(current<chamber.length){
        const popped = chamber[current];
        current++;
        log('å•¤é…’ï¼šé€€å¼¹â€”â€”å¼¹å‡º'+ (popped?'ğŸ”´å®å¼¹':'âšªç©ºåŒ…å¼¹'));
        updateGun(); remainReport();
      }else log('å¼¹å·¢å·²ç©º');
      break;
    case 'cuffs':
      skipNextEnemy = true;
      log('æ‰‹é“ï¼šæ¶é­”ä¸‹å›åˆè¢«è·³è¿‡');
      break;
  }
  renderItems();
}

/* ************  ç»“æŸé“å…·é˜¶æ®µ  ************ */
function endItemPhase(){
  if(gameOver) return;
  log('<span class="yellow">é“å…·é˜¶æ®µç»“æŸï¼Œè¿›å…¥å¼€æªç¯èŠ‚</span>');
  // æ¶é­”ç®€å•AIï¼šä¼˜å…ˆç”¨èƒ½ç›´æ¥å—ç›Šçš„é“å…·
  aiUseItems();
}

function aiUseItems(){
  // ç®€å•ç­–ç•¥ï¼šéšæœºç”¨æ‰æ‰‹é‡Œé“å…·
  const pool = Object.keys(itemsEnemy).filter(k=> itemsEnemy[k]>0);
  while(pool.length){
    const name = pool.splice(rand(pool.length),1)[0];
    itemsEnemy[name]--;
    // æ”¾å¤§é•œã€é€†è½¬å™¨ã€å•¤é…’ï¼šåªå¯¹ä¸‹ä¸€å‘æœ‰æ•ˆ
    if(name==='magnifier' && current<chamber.length) log('æ¶é­”ç”¨ğŸ”æŸ¥çœ‹ä¸‹ä¸€å‘');
    if(name==='inverter' && current<chamber.length){ chamber[current]=!chamber[current]; log('æ¶é­”ç”¨ğŸ”„ç¿»è½¬ä¸‹ä¸€å‘');}
    if(name==='beer' && current<chamber.length){ const p=chamber[current++]; log('æ¶é­”ç”¨ğŸ¥¤é€€æ‰'+ (p?'ğŸ”´å®å¼¹':'âšªç©ºåŒ…å¼¹')); updateGun(); remainReport();}
    if(name==='cig'){ if(hpEnemy<2){hpEnemy++; log('æ¶é­”ç”¨ğŸš¬å›å¤1è¡€'); hpReport();}}
    if(name==='saw'){ nextShotDmg=2; log('æ¶é­”ç”¨ğŸª“ç»™ä¸‹ä¸€å‘+1ä¼¤å®³');}
    if(name==='cuffs'){ skipNextEnemy=true; log('æ¶é­”ç”¨ğŸ”—è¯•å›¾é“ä½ ï¼ˆä½†åªå½±å“ç©å®¶å›åˆï¼Œæ— æ•ˆæœï¼‰');}
  }
}

/* ************  å¼€æªé€»è¾‘  ************ */
function shoot(target){
  if(gameOver) return;
  if(current>=chamber.length){ log('å¼¹å·¢å·²ç©ºï¼Œè¯·è¿›å…¥ä¸‹ä¸€å±€'); return; }

  const live = chamber[current++];
  const hitSelf = target==='player';
  log(`ä½ æ‰£åŠ¨æ‰³æœºï¼ŒæŒ‡å‘${hitSelf?'è‡ªå·±':'æ¶é­”'}â€¦`);

  if(live){
    const dmg = nextShotDmg;
    log('<span class="red">ç °ï¼å®å¼¹ï¼ä¼¤å®³ '+dmg+'</span>');
    if(hitSelf){ hpPlayer-=dmg; log('ä½ å—åˆ° '+dmg+' ç‚¹ä¼¤å®³'); }
    else       { hpEnemy-=dmg;  log('æ¶é­”å—åˆ° '+dmg+' ç‚¹ä¼¤å®³'); }
    nextShotDmg=1; playerExtraTurn=false;
  }else{
    log('<span class="cyan">å’”â€¦ç©ºåŒ…å¼¹</span>');
    if(hitSelf){
      log('ç©ºåŒ…å¼¹ï¼ä½ è·å¾—é¢å¤–ä¸€æªï¼');
      playerExtraTurn=true;
    }else{
      playerExtraTurn=false;
    }
  }

  updateGun(); remainReport(); hpReport(); checkWin();
  if(!gameOver && current>=chamber.length) playerExtraTurn=false;

  // æ˜¯å¦è¿›å…¥æ¶é­”å›åˆ
  if(!gameOver){
    if(playerExtraTurn && current<chamber.length){
      playerExtraTurn=false;
    }else{
      if(hpPlayer>0 && hpEnemy>0 && current<chamber.length){
        if(skipNextEnemy){
          skipNextEnemy=false;
          log('<span class="yellow">æ¶é­”è¢«æ‰‹é“æŸç¼šï¼Œå›åˆè·³è¿‡</span>');
        }else{
          setTimeout(()=>{
            const aiTarget = chamber[current] ? 'player' : 'enemy';
            aiShoot(aiTarget);
          },600);
        }
      }
    }
  }
}

function aiShoot(target){
  const live = chamber[current++];
  const hitSelf = target==='enemy';
  log(`æ¶é­”å¼€æªï¼ŒæŒ‡å‘${hitSelf?'è‡ªå·±':'ä½ '}â€¦`);
  if(live){
    const dmg = nextShotDmg;
    log('<span class="red">ç °ï¼å®å¼¹ï¼ä¼¤å®³ '+dmg+'</span>');
    if(hitSelf) hpEnemy-=dmg; else hpPlayer-=dmg;
    nextShotDmg=1;
  }else{
    log('<span class="cyan">å’”â€¦ç©ºåŒ…å¼¹</span>');
  }
  updateGun(); remainReport(); hpReport(); checkWin();
}

/* ************  èƒœè´Ÿåˆ¤å®š  ************ */
function checkWin(){
  if(hpPlayer<=0){ log('<span class="red">ä½ è¾“äº†ï¼</span>'); gameOver=true; }
  if(hpEnemy <=0){ log('<span class="cyan">ä½ èµ¢äº†ï¼</span>'); gameOver=true; }
}

/* ************  æ–°å±€  ************ */
function newRound(){
  if(!gameOver && (hpPlayer<=0 || hpEnemy<=0)) return;
  hpPlayer=2; hpEnemy=2;
  chamber = Array.from({length:TOTAL},()=> Math.random()<BLANK_PROB ? false : true);
  for(let i=chamber.length-1;i>0;i--){ const j=rand(i+1); [chamber[i],chamber[j]]=[chamber[j],chamber[i]]; }
  current=0; gameOver=false; nextShotDmg=1; skipNextEnemy=false; playerExtraTurn=false;
  log('<span class="yellow">=== æ–°å±€å¼€å§‹ ===</span>');
  const live = chamber.filter(Boolean).length;
  log(`æœ¬å±€ ${TOTAL} å‘ï¼šå®å¼¹ ${live} å‘ï¼Œç©ºåŒ…å¼¹ ${TOTAL-live} å‘`);
  hpReport(); updateGun(); giveItems();
}

/* ************  å¯åŠ¨  ************ */
newRound();
</script>
</body>
</html>

