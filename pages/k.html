<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœŸè´§å“ç§ç›‘æ§</title>
    <!-- å¼•å…¥ ECharts è„šæœ¬ -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #e0f7fa 0%, #bbdefb 100%);
            min-height: 100vh;
            overflow-x: hidden;
            color: #333;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #2c3e50;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            background: rgba(255,255,255,0.7);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.4);
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        .status-panel {
            background: rgba(255,255,255,0.95);
            padding: 5px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            position: relative;
            z-index: 5;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        .status-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .status-right {
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            z-index: 10;
        }
        .status-text {
            font-size: 1.1rem;
            font-weight: 500;
            color: #2c3e50;
        }
        .trading-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }
        .trading-status.active {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .trading-status.inactive {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .menu-container {
            position: relative;
            z-index: 100;
        }
        .menu-btn {
            padding: 5px 10px;
            background: linear-gradient(45deg, #4a69bd, #3c4f7b);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(74, 105, 189, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .menu-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(74, 105, 189, 0.4);
        }
        .dropdown-menu {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            background: rgba(255,255,255,0.95);
            border: 1px solid rgba(255,255,255,0.4);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            z-index: 10001;
            min-width: 300px;
            display: none;
            backdrop-filter: blur(10px);
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .dropdown-menu.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        .menu-section {
            margin-bottom: 20px;
        }
        .menu-section:last-child {
            margin-bottom: 0;
        }
        .menu-section-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #e1e5e9;
        }
        .metric-selector {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .metric-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .metric-row label {
            font-weight: 500;
            color: #444;
            min-width: 70px;
            font-size: 0.9rem;
        }
        .metric-row select {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ccd6e1;
            border-radius: 8px;
            outline: none;
            background: white;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            font-size: 0.9rem;
            color: #333;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http://www.w3.org/2000/svg%22%20viewBox%3D%220%200%2020%2020%22%3E%3Cpath%20d%3D%22M9.293%2012.95l.707.707L15.657%208l-1.414-1.414L10%2010.828%206.05%206.879%204.636%208.293z%22%20fill%3D%22%23666%22/%3E%3C/svg%3E');
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 14px;
        }
        .metric-row select:focus {
            border-color: #4a69bd;
            box-shadow: 0 0 0 3px rgba(74, 105, 189, 0.2);
        }
        .menu-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .control-btn {
            padding: 8px 18px;
            background: linear-gradient(45deg, #4a69bd, #3c4f7b);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(74, 105, 189, 0.3);
        }
        .control-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(74, 105, 189, 0.4);
        }
        .control-btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 5px rgba(74, 105, 189, 0.2);
        }
        .control-btn.secondary {
            background: linear-gradient(45deg, #28a745, #218838);
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }
        .control-btn.secondary:hover {
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        .chart-container {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        .chart-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }
        .chart {
            width: 100%;
            height: 400px;
        }
        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #e1e5e9;
        }
        .download-btn, .fullscreen-btn {
            position: absolute;
            top: 15px;
            padding: 6px 12px;
            background: linear-gradient(45deg, #28a745, #218838);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            z-index: 10;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .download-btn { right: 15px; }
        .fullscreen-btn {
            right: 85px;
            background: linear-gradient(45deg, #007bff, #0056b3);
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }
        .fullscreen-btn:hover {
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
            transform: scale(1.05);
        }
        .download-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }
        .chart-container:fullscreen {
            width: 100vw !important;
            height: 100vh !important;
            max-width: 100vw !important;
            max-height: 100vh !important;
            margin: 0 !important;
            padding: 20px !important;
            border-radius: 0 !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            z-index: 99999 !important;
            background: rgba(255,255,255,1);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: stretch;
            box-shadow: none;
            overflow: auto;
        }
        .chart-container:fullscreen .chart {
            width: 100% !important;
            height: calc(100vh - 120px) !important;
            margin-top: 20px;
            flex: 1;
        }
        .chart-container:fullscreen .chart-title {
            margin-bottom: 10px;
            flex-shrink: 0;
        }
        .chart-container:fullscreen .treemap-top-list {
            margin-bottom: 15px;
            flex-shrink: 0;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 1.2rem;
            color: #666;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4a69bd;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            border: 1px solid #f5c6cb;
        }
        .no-data {
            text-align: center;
            color: #666;
            font-size: 1.1rem;
            padding: 40px;
        }
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10000;
            display: none;
            background: rgba(0, 0, 0, 0.1);
        }
        .menu-overlay.show { display: block; }
        @media (max-width: 768px) {
            .container { padding: 10px; }
            h1 { font-size: 1.8rem; padding: 15px; }
            .status-panel { flex-direction: column; align-items: stretch; text-align: center; }
            .status-left, .status-right { justify-content: center; }
            .dropdown-menu {
                right: 0;
                left: 0;
                min-width: auto;
                max-width: calc(100vw - 40px);
                transform-origin: top center;
            }
            .chart-grid { grid-template-columns: 1fr; gap: 20px; }
            .chart { height: 300px; }
            .metric-row { flex-direction: column; align-items: stretch; }
            .metric-row label { min-width: auto; text-align: left; }
            .download-btn { right: 10px; top: 10px; padding: 4px 8px; font-size: 10px; }
            .fullscreen-btn { right: 70px; top: 10px; padding: 4px 8px; font-size: 10px; }
        }
        .treemap-top-list {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
            font-size: 0.75rem;
            flex-wrap: wrap;
        }
        .treemap-top-list .item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .treemap-top-list .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .treemap-top-list .dot.red { background-color: #ef4444; }
        .treemap-top-list .dot.green { background-color: #22c55e; }
        .treemap-top-list .value.red { color: #ef4444; font-weight: 500; }
        .treemap-top-list .value.green { color: #22c55e; font-weight: 500; }
        .treemap-top-list .label { color: #555; }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="current-time">ğŸ—æœŸè´§å“ç§å®æ—¶ç›‘æ§ğŸ—</h1>
        <div class="status-panel">
            <div class="status-left">
                <span id="trading-status" class="trading-status"></span>
                <div class="status-text">
                     <span id="current-time-display"></span>
                </div>
             
            </div>
            <div class="status-right">
                <button id="refresh-btn" class="control-btn secondary">ğŸ”„ åˆ·æ–°</button>
                <button id="auto-refresh-btn" class="control-btn">â±ï¸ è‡ªåŠ¨åˆ·æ–°</button>
                <div class="menu-container" id="menu-container">
                    <button id="menu-btn" class="menu-btn">
                        âš™ï¸ è®¾ç½®
                        <span id="menu-arrow">â–¼</span>
                    </button>
                    <div class="menu-overlay" id="menu-overlay"></div>
                    <div class="dropdown-menu" id="dropdown-menu">
                        <div class="menu-section">
                            <div class="menu-section-title">ğŸ“Š è‡ªå®šä¹‰æŒ‡æ ‡è®¾ç½®</div>
                            <div class="metric-selector">
                                <div class="metric-row">
                                    <label for="metric1-select">æŒ‡æ ‡1:</label>
                                    <select id="metric1-select">
                                        <option value="cje">æˆäº¤é¢</option>
                                        <option value="vol">æˆäº¤é‡</option>
                                        <option value="tjd">æŠ•æœºåº¦</option>
                                        <option value="ccl">æŒä»“é‡</option>
                                        <option value="cdzj">æ²‰æ·€èµ„é‡‘</option>
                                        <option value="zf">æŒ¯å¹…</option>
                                        <option value="lb">é‡æ¯”</option>
                                        <option value="zdf" selected>æ¶¨è·Œå¹…</option>
                                    </select>
                                </div>
                                <div class="metric-row">
                                    <label for="metric2-select">æŒ‡æ ‡2:</label>
                                    <select id="metric2-select">
                                        <option value="zdf">æ¶¨è·Œå¹…</option>
                                        <option value="zdf3">3æ—¥æ¶¨å¹…</option>
                                        <option value="zdf5">5æ—¥æ¶¨å¹…</option>
                                        <option value="zdf20">20æ—¥æ¶¨å¹…</option>
                                        <option value="zdfly">ä»Šå¹´æ¶¨å¹…</option>
                                        <option value="zdf250">250æ—¥æ¶¨å¹…</option>
                                        <option value="zdflm">æœ¬æœˆæ¶¨å¹…</option>
                                        <option value="tjd" selected>æŠ•æœºåº¦</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="menu-section">
                            <div class="menu-actions">
                                <button id="apply-metrics-btn" class="control-btn">ğŸ“Š åº”ç”¨æŒ‡æ ‡</button>
                                <button id="close-menu-btn" class="control-btn secondary">âœ–ï¸ å…³é—­</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <span>åˆ«ç€æ€¥ï¼Œæ•°æ®é©¬ä¸Šå°±æ›´æ–°...</span>
        </div>
        <div id="error-container"></div>
        <div class="chart-grid" id="charts-container">
            <div class="chart-container" data-chart-var="chart6">
                <div class="chart-title">å“ç§æ¶¨è·Œå›¾</div>
                <div id="main6-treemap-legend" class="treemap-top-list"></div>
                <div id="main6" class="chart"></div>
                <button class="download-btn" onclick="downloadChart(chart6, 'å“ç§æ¶¨è·Œå›¾.png')">ğŸ“¥ ä¸‹è½½</button>
                <button class="fullscreen-btn">å…¨å±</button>
            </div>
            <div class="chart-container" data-chart-var="chart1">
                <div class="chart-title">æœŸè´§å“ç§èµ°åŠ¿å¯¹æ¯”</div>
                <div id="main1" class="chart"></div>
                <button class="download-btn" onclick="downloadChart(chart1, 'æœŸè´§å“ç§èµ°åŠ¿å¯¹æ¯”.png')">ğŸ“¥ ä¸‹è½½</button>
                <button class="fullscreen-btn">å…¨å±</button>
            </div>
            <div class="chart-container" data-chart-var="chart2">
                <div class="chart-title">æŠ•æœºåº¦ä¸æ¶¨è·Œå¹…å¯¹æ¯”</div>
                <div id="main2" class="chart"></div>
                <button class="download-btn" onclick="downloadChart(chart2, 'æŠ•æœºåº¦ä¸æ¶¨è·Œå¹…å¯¹æ¯”.png')">ğŸ“¥ ä¸‹è½½</button>
                <button class="fullscreen-btn">å…¨å±</button>
            </div>
            <div class="chart-container" data-chart-var="chart3">
                <div class="chart-title">å¢ä»“ç‡ä¸æ¶¨è·Œå¹…å¯¹æ¯”</div>
                <div id="main3" class="chart"></div>
                <button class="download-btn" onclick="downloadChart(chart3, 'å¢ä»“ç‡ä¸æ¶¨è·Œå¹…å¯¹æ¯”.png')">ğŸ“¥ ä¸‹è½½</button>
                <button class="fullscreen-btn">å…¨å±</button>
            </div>
            <div class="chart-container" data-chart-var="chart4">
                <div class="chart-title">å„å‘¨æœŸæ¶¨è·Œå¹…å¯¹æ¯”</div>
                <div id="main4" class="chart"></div>
                <button class="download-btn" onclick="downloadChart(chart4, 'å„å‘¨æœŸæ¶¨è·Œå¹…å¯¹æ¯”.png')">ğŸ“¥ ä¸‹è½½</button>
                <button class="fullscreen-btn">å…¨å±</button>
            </div>
            <div class="chart-container" data-chart-var="chart5">
                <div class="chart-title" id="chart5-title">è‡ªå®šä¹‰æŒ‡æ ‡å¯¹æ¯”</div>
                <div id="main5" class="chart"></div>
                <button class="download-btn" onclick="downloadChart(chart5, 'è‡ªå®šä¹‰æŒ‡æ ‡å¯¹æ¯”.png')">ğŸ“¥ ä¸‹è½½</button>
                <button class="fullscreen-btn">å…¨å±</button>
            </div>

        </div>
    </div>
<script>
let chart1, chart2, chart3, chart4, chart5, chart6;
let autoRefresh = true;
let refreshInterval;
let currentData = [];
let chartOptions = {};

const fieldMapping = {
    qrspj: 'æ˜¨æ”¶ç›˜ä»·', zdf5: '5æ—¥æ¶¨å¹…', zdf6: '6æ—¥æ¶¨å¹…', zjlx: 'èµ„é‡‘æµå‘', dm: 'ä»£ç ',
    zsjd: 'å±•ç¤ºç²¾åº¦', lx: 'å“ç§ç±»å‹ä»£å·', zdf0: 'è¿‘ä¸€å¹´æ¶¨å¹…', avg2: 'è®¡ç®—å‡ä»·', ccl: 'æŒä»“é‡',
    ly: 'è®¡ç®—æ¥æº', zdf250: '250æ—¥æ¶¨å¹…', zdf3: '3æ—¥æ¶¨å¹…', dt: 'è·Œåœ', bpgs: 'æ¡£ä½æ•°',
    mcj: 'å–å‡ºä»·', mcl: 'å–å‡ºé‡', zdflm: 'æœ¬æœˆæ¶¨å¹…', jjsj: 'ä»Šç»“ç®—ä»·', zf: 'æŒ¯å¹…',
    mmpl: 'é‡æ¡£ä½', tjd: 'æŠ•æœºåº¦', xsfx: 'ç°æ‰‹æ–¹å‘', name: 'åˆçº¦åç§°', zt: 'æ¶¨åœ',
    spgs: 'æ¡£ä½', mmpjg: 'ä»·æ ¼æ¡£ä½', zjsj: 'æ˜¨ç»“ç®—ä»·', spsj: 'æ”¶ç›˜æ—¶é—´', np: 'å†…ç›˜',
    rz: 'æ—¥å¢ä»“', kpsj: 'å¼€ç›˜æ—¶é—´', sc: 'å¸‚åœºä»£ç ', uid: 'å”¯ä¸€id', vol: 'æˆäº¤é‡',
    jysj: 'äº¤æ˜“æ—¶é—´', cjbs: 'æˆäº¤ç¬”æ•°', wp: 'å¤–ç›˜', zdf20: '20æ—¥æ¶¨å¹…', cje: 'æˆäº¤é¢',
    mrj: 'ä¹°å…¥ä»·', utime: 'æ›´æ–°æ—¶é—´', mrl: 'ä¹°å…¥é‡', h: 'æœ€é«˜ä»·', j: 'å‡ä»·',
    zccl: 'æ˜¨æŒä»“é‡', l: 'æœ€ä½ä»·', o: 'å¼€ç›˜ä»·', zdfly: 'ä»Šå¹´æ¶¨å¹…', p: 'æœ€æ–°ä»·',
    cclbh: 'æŒä»“å˜é‡', lb: 'é‡æ¯”', zde: 'æ¶¨è·Œé¢', jyzt: 'äº¤æ˜“çŠ¶æ€', xs: 'ç°æ‰‹',
    zdf: 'æ¶¨è·Œå¹…', cdzj: 'æ²‰æ·€èµ„é‡‘'
};

const commonAxisOptions = {
    axisLabel: {
        fontSize: 11,
        color: '#444',
        interval: 0,
        rotate: 45
    },
    axisLine: { lineStyle: { color: '#ccc' } },
    splitLine: { lineStyle: { color: '#f0f0f0', type: 'dashed' } }
};

function getSimplifiedName(fullName) {
    const match = fullName.match(/^([^\d]+)/);
    if (match && match[1]) return match[1];
    return fullName;
}
function formatCjeToBillion(value) {
    if (value === null || value === undefined) return '-';
    return (value / 1e8).toFixed(2) + 'äº¿';
}

document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    initializeControls();
    initializeMenu();
    fetchData();
    startAutoRefresh();
    updateTimeDisplay();
    setInterval(updateTimeDisplay, 1000);
    addFullscreenListeners();
});

function initializeMenu() {
    const menuBtn = document.getElementById('menu-btn');
    const menuOverlay = document.getElementById('menu-overlay');
    const dropdownMenu = document.getElementById('dropdown-menu');
    const closeMenuBtn = document.getElementById('close-menu-btn');
    const menuArrow = document.getElementById('menu-arrow');
    menuBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        toggleMenu();
    });
    menuOverlay.addEventListener('click', function() { closeMenu(); });
    closeMenuBtn.addEventListener('click', function() { closeMenu(); });
    dropdownMenu.addEventListener('click', function(e) { e.stopPropagation(); });
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeMenu();
    });
    function toggleMenu() {
        const isOpen = dropdownMenu.classList.contains('show');
        if (isOpen) closeMenu(); else openMenu();
    }
    function openMenu() {
        dropdownMenu.classList.add('show');
        menuOverlay.classList.add('show');
        menuArrow.textContent = 'â–²';
    }
    function closeMenu() {
        dropdownMenu.classList.remove('show');
        menuOverlay.classList.remove('show');
        menuArrow.textContent = 'â–¼';
    }
    document.getElementById('apply-metrics-btn').addEventListener('click', function() {
        applyCustomMetrics();
        closeMenu();
    });
}

function initializeCharts() {
    chart1 = echarts.init(document.getElementById('main1'));
    chart2 = echarts.init(document.getElementById('main2'));
    chart3 = echarts.init(document.getElementById('main3'));
    chart4 = echarts.init(document.getElementById('main4'));
    chart5 = echarts.init(document.getElementById('main5'));
    chart6 = echarts.init(document.getElementById('main6'));
    window.addEventListener('resize', () => {
        chart1.resize(); chart2.resize(); chart3.resize(); chart4.resize(); chart5.resize(); chart6.resize();
    });
    // è®¾ç½®è‡ªå®šä¹‰æŒ‡æ ‡å¯¹æ¯”å›¾çš„é»˜è®¤æŒ‡æ ‡
    document.getElementById('metric1-select').value = 'cdzj';
    document.getElementById('metric2-select').value = 'tjd';
}

function initializeControls() {
    document.getElementById('refresh-btn').addEventListener('click', fetchData);
    document.getElementById('auto-refresh-btn').addEventListener('click', toggleAutoRefresh);
    const autoRefreshBtn = document.getElementById('auto-refresh-btn');
    if (autoRefresh) {
        autoRefreshBtn.textContent = 'â±ï¸ è‡ªåŠ¨åˆ·æ–°: å¼€å¯';
        autoRefreshBtn.classList.remove('secondary');
    } else {
        autoRefreshBtn.textContent = 'â±ï¸ è‡ªåŠ¨åˆ·æ–°: å…³é—­';
        autoRefreshBtn.classList.add('secondary');
    }
}

function updateTimeDisplay() {
    const now = new Date();
    const timeString = now.toLocaleString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    document.getElementById('current-time-display').textContent = timeString;
    const isTradingTime = checkTradingTime(now);
    const statusElement = document.getElementById('trading-status');
    if (isTradingTime) {
        statusElement.textContent = 'â— äº¤æ˜“ä¸­';
        statusElement.className = 'trading-status active';
    } else {
        statusElement.textContent = 'â— éäº¤æ˜“æ—¶æ®µ';
        statusElement.className = 'trading-status inactive';
    }
}

function checkTradingTime(now) {
    const hour = now.getHours();
    const minute = now.getMinutes();
    if ((hour === 9 && minute >= 0) || (hour === 10 && minute < 15) || 
        (hour === 10 && minute >= 30) || (hour === 11 && minute < 30) ||
        (hour === 13 && minute >= 30) || (hour === 14) || (hour === 15 && minute === 0)) {
        return true;
    }
    if ((hour >= 21) || (hour >= 0 && hour < 2) || (hour === 2 && minute <= 30)) {
        return true;
    }
    return false;
}

function getApiUrl() {
    return checkTradingTime(new Date()) ? 'https://q.want.biz' : 'https://q.want.biz/night';
}

function showLoading() {
    // ä¸å†æ˜¾ç¤ºloadingå…ƒç´ ï¼Œä½†ä»ç„¶é™ä½charts-containerçš„é€æ˜åº¦
    // document.getElementById('loading').style.display = 'flex';
    document.getElementById('charts-container').style.opacity = '0.5';
}
function hideLoading() {
    // ä¸å†éšè—loadingå…ƒç´ ï¼Œä½†ä»ç„¶æ¢å¤charts-containerçš„é€æ˜åº¦
    // document.getElementById('loading').style.display = 'none';
    document.getElementById('charts-container').style.opacity = '1';
}
function showError(message) {
    const errorContainer = document.getElementById('error-container');
    errorContainer.innerHTML = `<div class="error-message">âŒ ${message}</div>`;
}
function clearError() {
    document.getElementById('error-container').innerHTML = '';
}

async function fetchData() {
    showLoading();
    clearError();
    try {
        const response = await fetch(getApiUrl());
        if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        const apiData = await response.json();
        if (!apiData || !apiData.list || !Array.isArray(apiData.list)) throw new Error('æ•°æ®æ ¼å¼é”™è¯¯');
        let filteredData = apiData.list.filter(item => item.cdzj > 15 * 1e8); 
        if (filteredData.length === 0) throw new Error('æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ•°æ®');
        const hasOpenMarkets = filteredData.some(item => item.jyzt === 0);
        if (hasOpenMarkets) filteredData = filteredData.filter(item => item.jyzt === 0);
        currentData = filteredData;
        renderAllCharts(filteredData);
        document.getElementById('current-time').textContent = 
            `ğŸ—æœŸè´§å“ç§å®æ—¶ç›‘æ§ğŸ— (${new Date().toLocaleTimeString()})`;
    } catch (error) {
        console.error('æ•°æ®è·å–å¤±è´¥:', error);
        showError(`æ•°æ®è·å–å¤±è´¥: ${error.message}`);
    } finally {
        hideLoading();
    }
}

function renderAllCharts(data) {
    try {
        renderChart1([...data]);
        renderChart2([...data]);
        renderChart3([...data]);
        renderChart4([...data]);
        const metric1 = document.getElementById('metric1-select').value || 'cdzj';
        const metric2 = document.getElementById('metric2-select').value || 'tjd';
        renderChart5([...data], metric1, metric2);
        renderChart6([...data]);
    } catch (error) {
        console.error('å›¾è¡¨æ¸²æŸ“å¤±è´¥:', error);
        showError(`å›¾è¡¨æ¸²æŸ“å¤±è´¥: ${error.message}`);
    }
}

function renderChart1(dataList) {
    const processedData = dataList.map(item => {
        const openChange = parseFloat(((item.o - item.zjsj) / item.zjsj * 100).toFixed(2));
        const closeChange = parseFloat(((item.p - item.zjsj) / item.zjsj * 100).toFixed(2));
        const lowChange = parseFloat(((item.l - item.zjsj) / item.zjsj * 100).toFixed(2));
        const highChange = parseFloat(((item.h - item.zjsj) / item.zjsj * 100).toFixed(2));
        
        return {
            name: getSimplifiedName(item.name),
            fullName: item.name,
            dm: item.dm,
            value: [openChange, closeChange, lowChange, highChange],
            closeChange,
            openChange,
            highChange,
            lowChange,
            rawValues: {
                open: item.o,
                high: item.h,
                low: item.l,
                close: item.p,
                prevClose: item.zjsj,
                volume: item.vol,
                turnover: item.cje,
                openInterest: item.ccl,
                depositFunds: item.cdzj,
                amplitude: item.zf,
                volumeRatio: item.lb
            }
        };
    });

    const sortedData = processedData.sort((a, b) => b.closeChange - a.closeChange);
    const categories = sortedData.map(item => item.name);

    const markPointData = [];
    if (sortedData.length > 0) {
        const highestGainer = sortedData[0];
        if (highestGainer.closeChange > 0) {
            markPointData.push({
                name: 'æ¶¨å¹…æœ€é«˜',
                value: highestGainer.closeChange,
                coord: [0, highestGainer.value[1]],
                itemStyle: { color: '#ef4444' }
            });
        }
    }
    if (sortedData.length > 1) { 
        const biggestLoser = sortedData[sortedData.length - 1];
        if (biggestLoser.closeChange < 0) {
            markPointData.push({
                name: 'è·Œå¹…æœ€å¤§',
                value: biggestLoser.closeChange,
                coord: [sortedData.length - 1, biggestLoser.value[1]],
                itemStyle: { color: '#22c55e' }
            });
        }
    }

    const option = {
        backgroundColor: 'transparent',
        tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(0,0,0,0.8)',
            borderColor: '#777',
            textStyle: { color: '#fff' },
            formatter: function (params) {
                const dataPoint = params[0];
                const data = dataPoint.data;
                const raw = data.rawValues; 
                
                if (raw) {
                    const changeValue = (raw.close - raw.prevClose).toFixed(2);
                    const changePercent = data.closeChange.toFixed(2);
                    const openChangePercent = data.openChange.toFixed(2);
                    const highChangePercent = data.highChange.toFixed(2);
                    const lowChangePercent = data.lowChange.toFixed(2);
                    
                    const color = data.closeChange >= 0 ? '#ef4444' : '#22c55e';
                    const color2 = data.highChange >= 0 ? '#ef4444' : '#22c55e';
                    const color3 = data.lowChange >= 0 ? '#ef4444' : '#22c55e';
                    const color4 = data.openChange >= 0 ? '#ef4444' : '#22c55e';
                    
                    return `<strong style="font-size: 16px; font-weight: bold;">${data.fullName}</strong><br/>` +
                    `æœ€æ–°ä»·: <strong style="color:${color};">${changePercent}% (${raw.close}, ${changeValue})</strong><br/>` +
                    `å¼€ç›˜ä»·: <strong style="color:${color4};">${openChangePercent}% (${raw.open}, ${(raw.open - raw.prevClose).toFixed(2)})</strong><br/>` +
                    `æœ€é«˜ä»·: <strong style="color:${color2};">${highChangePercent}% (${raw.high}, ${(raw.high - raw.prevClose).toFixed(2)})</strong><br/>` +
                    `æœ€ä½ä»·: <strong style="color:${color3};">${lowChangePercent}% (${raw.low}, ${(raw.low - raw.prevClose).toFixed(2)})</strong><br/>` ;
         }
                return data.fullName;
            }
        },
        xAxis: {
            type: 'category',
            data: categories,
            axisLabel: commonAxisOptions.axisLabel,
            axisLine: commonAxisOptions.axisLine
        },
        yAxis: {
            type: 'value',
            axisLabel: {
                formatter: '{value}%',
                fontSize: commonAxisOptions.axisLabel.fontSize,
                color: commonAxisOptions.axisLabel.color
            },
            axisLine: commonAxisOptions.axisLine,
            splitLine: commonAxisOptions.splitLine
        },
        dataZoom: [
            { type: 'inside', start: 0, end: 100 },
            { start: 0, end: 100, height: 20 }
        ],
        series: [{
            type: 'candlestick',
            data: sortedData, 
            itemStyle: {
                color: '#ef4444',
                color0: '#22c55e',
                borderColor: '#ef4444',
                borderColor0: '#22c55e'
            },
            markPoint: {
                symbol: 'pin',
                symbolSize: 40,
                tooltip: { show: false },
                label: {
                    fontSize: 10,
                    formatter: function(params) {
                        if (typeof params.value === 'number') {
                            return params.value.toFixed(2) + '%';
                        }
                        return '';
                    }
                },
                data: markPointData
            }
        }]
    };
    chartOptions.chart1 = option;
    chart1.setOption(option);
    bindChartClick(chart1);
}

function renderChart2(dataList) {
    dataList.sort((a, b) => b.zdf - a.zdf);
    const categories = dataList.map(item => getSimplifiedName(item.name));
    const option = {
        backgroundColor: 'transparent',
        tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(0,0,0,0.8)',
            textStyle: { color: '#fff' },
            formatter: function(params) {
                const originalName = params[0].data.fullName;
                let tooltipContent = originalName + '<br/>';
                params.forEach(function(item) {
                    tooltipContent += `${item.marker}${item.seriesName}: ${item.value}<br/>`;
                });
                return tooltipContent;
            }
        },
        legend: {
            data: ['æŠ•æœºåº¦', 'æ¶¨è·Œå¹…'],
            top: 10,
            textStyle: { color: '#333' }
        },
        xAxis: {
            type: 'category',
            data: categories,
            axisLabel: commonAxisOptions.axisLabel,
            axisLine: commonAxisOptions.axisLine
        },
        yAxis: [
            {
                type: 'value',
                name: 'æŠ•æœºåº¦',
                position: 'left',
                axisLabel: commonAxisOptions.axisLabel,
                axisLine: commonAxisOptions.axisLine,
                splitLine: commonAxisOptions.splitLine
            },
            {
                type: 'value',
                name: 'æ¶¨è·Œå¹…(%)',
                position: 'right',
                axisLabel: {
                    formatter: '{value}%',
                    fontSize: commonAxisOptions.axisLabel.fontSize,
                    color: commonAxisOptions.axisLabel.color
                },
                axisLine: commonAxisOptions.axisLine,
                splitLine: { show: false }
            }
        ],
        dataZoom: [
            { type: 'inside', start: 0, end: 100 },
            { start: 0, end: 100, height: 20 }
        ],
        series: [
            {
                name: 'æŠ•æœºåº¦',
                type: 'bar',
                yAxisIndex: 0,
                itemStyle: { color: '#3b82f6' },
                data: dataList.map(item => ({
                    value: item.tjd,
                    dm: item.dm,
                    name: getSimplifiedName(item.name),
                    fullName: item.name
                }))
            },
            {
                name: 'æ¶¨è·Œå¹…',
                type: 'line',
                yAxisIndex: 1,
                itemStyle: { color: '#ef4444' },
                data: dataList.map(item => ({
                    value: item.zdf,
                    dm: item.dm,
                    name: getSimplifiedName(item.name),
                    fullName: item.name
                }))
            }
        ]
    };
    chartOptions.chart2 = option;
    chart2.setOption(option);
    bindChartClick(chart2);
}

function renderChart3(dataList) {
    dataList.sort((a, b) => b.zdf - a.zdf);
    const option = {
        backgroundColor: 'transparent',
        tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(0,0,0,0.8)',
            textStyle: { color: '#fff' },
            formatter: function(params) {
                const originalName = params[0].data.fullName;
                let tooltipContent = originalName + '<br/>';
                params.forEach(function(item) {
                    tooltipContent += `${item.marker}${item.seriesName}: ${item.value}%<br/>`;
                });
                return tooltipContent;
            }
        },
        legend: {
            data: ['å¢ä»“ç‡', 'æ¶¨è·Œå¹…'],
            top: 10,
            textStyle: { color: '#333' }
        },
        xAxis: {
            type: 'category',
            data: dataList.map(item => getSimplifiedName(item.name)),
            axisLabel: commonAxisOptions.axisLabel,
            axisLine: commonAxisOptions.axisLine
        },
        yAxis: [
            {
                type: 'value',
                name: 'å¢ä»“ç‡(%)',
                position: 'left',
                axisLabel: {
                    formatter: '{value}%',
                    fontSize: commonAxisOptions.axisLabel.fontSize,
                    color: commonAxisOptions.axisLabel.color
                },
                axisLine: commonAxisOptions.axisLine,
                splitLine: commonAxisOptions.splitLine
            },
            {
                type: 'value',
                name: 'æ¶¨è·Œå¹…(%)',
                position: 'right',
                axisLabel: {
                    formatter: '{value}%',
                    fontSize: commonAxisOptions.axisLabel.fontSize,
                    color: commonAxisOptions.axisLabel.color
                },
                axisLine: commonAxisOptions.axisLine,
                splitLine: { show: false }
            }
        ],
        dataZoom: [
            { type: 'inside', start: 0, end: 100 },
            { start: 0, end: 100, height: 20 }
        ],
        series: [
            {
                name: 'å¢ä»“ç‡',
                type: 'bar',
                yAxisIndex: 0,
                itemStyle: { color: '#06b6d4' },
                data: dataList.map(item => {
                    const divisor = item.ccl - item.rz;
                    const rate = divisor === 0 ? 0 : parseFloat(((item.rz / divisor) * 100).toFixed(2));
                    return {
                        value: rate,
                        dm: item.dm,
                        name: getSimplifiedName(item.name),
                        fullName: item.name
                    };
                })
            },
            {
                name: 'æ¶¨è·Œå¹…',
                type: 'line',
                yAxisIndex: 1,
                itemStyle: { color: '#ef4444' },
                data: dataList.map(item => ({
                    value: item.zdf,
                    dm: item.dm,
                    name: getSimplifiedName(item.name),
                    fullName: item.name
                }))
            }
        ]
    };
    chartOptions.chart3 = option;
    chart3.setOption(option);
    bindChartClick(chart3);
}
function renderChart4(dataList) {
    dataList.sort((a, b) => b.zdf - a.zdf);
    const seriesConfig = [
        { name: 'å½“æ—¥æ¶¨å¹…', field: 'zdf', color: '#ef4444' },
        { name: '3æ—¥æ¶¨å¹…', field: 'zdf3', color: '#22c55e' },
        { name: '5æ—¥æ¶¨å¹…', field: 'zdf5', color: '#3b82f6' },
        { name: '20æ—¥æ¶¨å¹…', field: 'zdf20', color: '#a855f7' },
        { name: 'ä»Šå¹´æ¶¨å¹…', field: 'zdfly', color: '#f59e0b' },
        { name: '250æ—¥æ¶¨å¹…', field: 'zdf250', color: '#14b8a6' }
    ];
    const option = {
        backgroundColor: 'transparent',
        tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(0,0,0,0.8)',
            textStyle: { color: '#fff' },
            formatter: function(params) {
                const originalName = params[0].data.fullName;
                let tooltipContent = originalName + '<br/>';
                params.forEach(function(item) {
                    tooltipContent += `${item.marker}${item.seriesName}: ${item.value}%<br/>`;
                });
                return tooltipContent;
            }
        },
        legend: {
            data: seriesConfig.map(s => s.name),
            top: 10,
            type: 'scroll',
            textStyle: { color: '#333' }
        },
        xAxis: {
            type: 'category',
            data: dataList.map(item => getSimplifiedName(item.name)),
            axisLabel: commonAxisOptions.axisLabel,
            axisLine: commonAxisOptions.axisLine
        },
        yAxis: {
            type: 'value',
            name: 'æ¶¨è·Œå¹…(%)',
            axisLabel: {
                formatter: '{value}%',
                fontSize: commonAxisOptions.axisLabel.fontSize,
                color: commonAxisOptions.axisLabel.color
            },
            axisLine: commonAxisOptions.axisLine,
            splitLine: commonAxisOptions.splitLine
        },
        dataZoom: [
            { type: 'inside', start: 0, end: 100 },
            { start: 0, end: 100, height: 20 }
        ],
        series: seriesConfig.map(s => ({
            name: s.name,
            type: 'line',
            itemStyle: { color: s.color },
            data: dataList.map(item => ({
                value: item[s.field],
                dm: item.dm,
                name: getSimplifiedName(item.name),
                fullName: item.name
            })),
            smooth: true
        }))
    };
    chartOptions.chart4 = option;
    chart4.setOption(option);
    bindChartClick(chart4);
}
function renderChart5(dataList, metric1, metric2) {
    if (dataList.length === 0) {
        chart5.clear();
        document.getElementById('main5').innerHTML = '<div class="no-data">æš‚æ— ç¬¦åˆæ¡ä»¶çš„æ•°æ®</div>';
        return;
    } else {
        const main5Element = document.getElementById('main5');
        if (main5Element.innerHTML.includes('no-data') || main5Element.innerHTML.includes('error-message')) {
            main5Element.innerHTML = '';
        }
    }
    dataList.sort((a, b) => b[metric1] - a[metric1]);
    const categories = dataList.map(item => getSimplifiedName(item.name));
    const metric1Data = dataList.map(item => item[metric1]);
    const metric2Data = dataList.map(item => item[metric2]);
    if (metric1Data.some(val => val === undefined) || metric2Data.some(val => val === undefined)) {
        chart5.clear();
        document.getElementById('main5').innerHTML = `<div class="error-message">æŒ‡å®šçš„æŒ‡æ ‡ (${fieldMapping[metric1]} æˆ– ${fieldMapping[metric2]}) åœ¨æ•°æ®ä¸­ä¸å­˜åœ¨</div>`;
        return;
    }
    const title = `${fieldMapping[metric1]}ä¸${fieldMapping[metric2]}å¯¹æ¯”`;
    document.getElementById('chart5-title').textContent = title;
    const option = {
        backgroundColor: 'transparent',
        tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(0,0,0,0.8)',
            textStyle: { color: '#fff' },
             formatter: function(params) {
                const originalName = params[0].data.fullName;
                let tooltipContent = originalName + '<br/>';
                params.forEach(function(item) {
                    let value = item.value;
                    if (item.seriesName.includes('æ¶¨å¹…') || item.seriesName.includes('ç‡')) {
                        value = value.toFixed(2) + '%';
                    } else if (item.seriesName.includes('æˆäº¤é¢') || item.seriesName.includes('æ²‰æ·€èµ„é‡‘')) {
                        value = formatCjeToBillion(value);
                    } else if (typeof value === 'number') {
                        value = value.toFixed(2);
                    }
                    tooltipContent += `${item.marker}${item.seriesName}: ${value}<br/>`;
                });
                return tooltipContent;
            }
        },
        legend: {
            data: [fieldMapping[metric1], fieldMapping[metric2]],
            top: 10,
            textStyle: { color: '#333' }
        },
        xAxis: {
            type: 'category',
            data: categories,
            axisLabel: commonAxisOptions.axisLabel,
            axisLine: commonAxisOptions.axisLine
        },
        yAxis: [
            {
                type: 'value',
                name: fieldMapping[metric1],
                position: 'left',
                axisLabel: {
                    formatter: function (value) { return value.toFixed(2); },
                    fontSize: commonAxisOptions.axisLabel.fontSize,
                    color: commonAxisOptions.axisLabel.color
                },
                axisLine: commonAxisOptions.axisLine,
                splitLine: commonAxisOptions.splitLine
            },
            {
                type: 'value',
                name: fieldMapping[metric2],
                position: 'right',
                axisLabel: {
                    formatter: function (value) { return value.toFixed(2); },
                    fontSize: commonAxisOptions.axisLabel.fontSize,
                    color: commonAxisOptions.axisLabel.color
                },
                axisLine: commonAxisOptions.axisLine,
                splitLine: { show: false }
            }
        ],
        dataZoom: [
            { type: 'inside', start: 0, end: 100 },
            { start: 0, end: 100, height: 20 }
        ],
        series: [
            {
                name: fieldMapping[metric1],
                type: 'bar',
                yAxisIndex: 0,
                itemStyle: { color: '#8b5cf6' },
                data: dataList.map(item => ({
                    value: item[metric1],
                    dm: item.dm,
                    name: getSimplifiedName(item.name),
                    fullName: item.name
                }))
            },
            {
                name: fieldMapping[metric2],
                type: 'line',
                yAxisIndex: 1,
                itemStyle: { color: '#f59e0b' },
                lineStyle: { width: 2 },
                data: dataList.map(item => ({
                    value: item[metric2],
                    dm: item.dm,
                    name: getSimplifiedName(item.name),
                    fullName: item.name
                }))
            }
        ]
    };
    chartOptions.chart5 = option;
    chart5.setOption(option);
    bindChartClick(chart5);
}
function renderChart6(dataList) {
    let treemapData = dataList.filter(item => item.cje > 10 * 1e8);
    if (treemapData.length === 0) {
        chart6.clear();
        document.getElementById('main6').innerHTML = '<div class="no-data">æš‚æ— ç¬¦åˆæ¡ä»¶çš„å“ç§æ¶¨è·Œæ•°æ®</div>';
        document.getElementById('main6-treemap-legend').innerHTML = '';
        return;
    } else {
        const main6Element = document.getElementById('main6');
        if (main6Element.innerHTML.includes('no-data') || main6Element.innerHTML.includes('error-message')) {
            main6Element.innerHTML = '';
        }
    }
    treemapData.sort((a, b) => b.cje - a.cje);
    // è‡ªå®šä¹‰é¢œè‰²åˆ†æ¡£å‡½æ•°
    function getTreemapColor(zdf) {
        const abs = Math.abs(zdf);
        if (zdf <= 0) {
            // è·Œå¹…ä¸ºè´Ÿ (ç»¿è‰²ä»£è¡¨ä¸‹è·Œ)
            if (abs >= 5) return '#006400';      // æ·±ç»¿ (Deep Green)
            if (abs >= 2) return '#22c55e';      // ä¸€èˆ¬ç»¿ (Emerald Green)
            if (abs >= 1) return '#66bb6a';      // ä¸­ç­‰åæµ…ç»¿ (Medium Light Green) - ç¡®ä¿ä¸ç™½è‰²æ–‡å­—æœ‰è‰¯å¥½å¯¹æ¯”
            return '#86efac';                    // äº®ç»¿ (Light Green) - ç¡®ä¿ä¸ç™½è‰²æ–‡å­—æœ‰æœ€ä½é™åº¦å¯¹æ¯” (WCAG AAçº§åˆ«)
        } else {
            // æ¶¨å¹…ä¸ºæ­£ (çº¢è‰²ä»£è¡¨ä¸Šæ¶¨)
            if (abs >= 5) return '#8b0000';      // æ·±çº¢ (Deep Red)
            if (abs >= 2) return '#ef4444';      // ä¸€èˆ¬çº¢ (Tomato Red)
            if (abs >= 1) return '#ff8888';      // ä¸­ç­‰åæµ…çº¢ (Medium Light Red) - ç¡®ä¿ä¸ç™½è‰²æ–‡å­—æœ‰è‰¯å¥½å¯¹æ¯”
            return '#fca5a5';                    // äº®çº¢ (Light Red) - ç¡®ä¿ä¸ç™½è‰²æ–‡å­—æœ‰æœ€ä½é™åº¦å¯¹æ¯” (WCAG AAçº§åˆ«)
        }
    }
    
    
    
    const treemapSeriesData = treemapData.map(item => {
        return {
            name: getSimplifiedName(item.name),
            value: item.cje,
            dm: item.dm,
            fullName: item.name,
            zdf: item.zdf,
            cje: item.cje,
            itemStyle: {
                color: getTreemapColor(item.zdf),
                borderColor: '#fff',
                borderWidth: 1
            },
            label: {
                show: true,
                position: 'inside',
                color: '#fff',
                fontSize: 12,
                formatter: function(params) {
                    const cjeFormatted = formatCjeToBillion(params.data.cje);
                    const zdfFormatted = params.data.zdf ? params.data.zdf.toFixed(2) + '%' : '0.00%';
                    return `${params.name}\n${cjeFormatted}\n${zdfFormatted}`;
                },
                rich: {
                    name: { fontSize: 13, fontWeight: 'bold' },
                    value: { fontSize: 11 },
                    zdf: { fontSize: 11 }
                },
                overflow: 'truncate',
                width: '90%',
                height: '90%',
                lineHeight: 14
            }
        };
    });
    const option = {
        backgroundColor: 'transparent',
        tooltip: {
            trigger: 'item',
            backgroundColor: 'rgba(0,0,0,0.8)',
            textStyle: { color: '#fff' },
            formatter: function(params) {
                if (params.data) {
                    return `${params.data.fullName}<br/>` +
                           `æˆäº¤é¢: ${formatCjeToBillion(params.data.cje)}<br/>` +
                           `æ¶¨è·Œå¹…: ${params.data.zdf.toFixed(2)}%`;
                }
                return '';
            }
        },
        series: [{
            type: 'treemap',
            width: '100%',
            height: '100%',
            roam: false,
            nodeClick: false,
            breadcrumb: { show: false },
            data: treemapSeriesData,
            levels: [
                {
                    itemStyle: { borderWidth: 1, borderColor: '#fff' },
                    upperLabel: { show: false }
                }
            ]
        }]
    };
    chartOptions.chart6 = option;
    chart6.setOption(option);
    bindChartClick(chart6);
    updateTreemapLegend(treemapData);
}
function updateTreemapLegend(data) {
    const legendContainer = document.getElementById('main6-treemap-legend');
    let html = '';
    const topGainers = [...data].sort((a, b) => b.zdf - a.zdf).filter(item => item.zdf > 0).slice(0, 3);
    const topLosers = [...data].sort((a, b) => a.zdf - b.zdf).filter(item => item.zdf < 0).slice(0, 3);
    topGainers.forEach(item => {
        html += `
            <div class="item">
                <span class="dot red"></span>
                <span class="label">${getSimplifiedName(item.name)}:</span>
                <span class="value red">${item.zdf.toFixed(2)}%</span>
            </div>`;
    });
    if (topGainers.length > 0 && topLosers.length > 0) html += `<div> </div>`;
    topLosers.forEach(item => {
        html += `
            <div class="item">
                <span class="dot green"></span>
                <span class="label">${getSimplifiedName(item.name)}:</span>
                <span class="value green">${item.zdf.toFixed(2)}%</span>
            </div>`;
    });
    legendContainer.innerHTML = html;
}

function bindChartClick(chart) {
    chart.off('click');
    chart.on('click', function(params) {
        if (params.data && params.data.dm) {
            const dm = params.data.dm;
            const codeWithoutNumbers = dm.replace(/\d+/g, '');
            const url = `https://wealth.want.biz/v1/longshort.html?variety=${codeWithoutNumbers}`;
            window.open(url, '_blank');
        }
    });
}

function downloadChart(chartInstance, fileName) {
    const url = chartInstance.getDataURL({ backgroundColor: '#fff', pixelRatio: 2 });
    const link = document.createElement('a');
    link.href = url;
    link.download = fileName;
    link.click();
}

function toggleAutoRefresh() {
    autoRefresh = !autoRefresh;
    const btn = document.getElementById('auto-refresh-btn');
    if (autoRefresh) {
        btn.textContent = 'â±ï¸ è‡ªåŠ¨åˆ·æ–°: å¼€å¯';
        btn.classList.remove('secondary');
        startAutoRefresh();
    } else {
        btn.textContent = 'â±ï¸ è‡ªåŠ¨åˆ·æ–°: å…³é—­';
        btn.classList.add('secondary');
        stopAutoRefresh();
    }
}
function startAutoRefresh() {
    if (refreshInterval) clearInterval(refreshInterval);
    refreshInterval = setInterval(() => {
        if (autoRefresh && checkTradingTime(new Date())) {
            fetchData();
        }
    }, 15000);
}
function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
}
function applyCustomMetrics() {
    if (currentData.length > 0) {
        const metric1 = document.getElementById('metric1-select').value || 'cdzj';
        const metric2 = document.getElementById('metric2-select').value || 'tjd';
        renderChart5([...currentData], metric1, metric2);
    }
}

// ----------- å…¨å±åŠŸèƒ½ä¿®æ­£ START -----------
function addFullscreenListeners() {
    // ç‚¹å‡»æŒ‰é’®è¯·æ±‚å…¨å±æˆ–é€€å‡ºå…¨å±
    document.querySelectorAll('.fullscreen-btn').forEach(button => {
        button.addEventListener('click', () => {
            const chartContainer = button.closest('.chart-container');
            if (!document.fullscreenElement) {
                if (chartContainer.requestFullscreen) {
                    chartContainer.requestFullscreen();
                } else if (chartContainer.webkitRequestFullscreen) {
                    chartContainer.webkitRequestFullscreen();
                } else if (chartContainer.msRequestFullscreen) {
                    chartContainer.msRequestFullscreen();
                }
            } else if (document.fullscreenElement === chartContainer) {
                document.exitFullscreen();
            }
        });
    });
    // æµè§ˆå™¨å…¨å±å˜åŒ–æ—¶è‡ªåŠ¨resize
    document.addEventListener('fullscreenchange', () => {
        if (document.fullscreenElement) {
            const chartContainer = document.fullscreenElement;
            const chartVarName = chartContainer.dataset.chartVar;
            const chartInstance = window[chartVarName];
            setTimeout(() => {
                if (chartInstance) chartInstance.resize();
            }, 150);
            const btn = chartContainer.querySelector('.fullscreen-btn');
            if (btn) btn.textContent = 'é€€å‡ºå…¨å±';
        } else {
            setTimeout(() => {
                ['chart1','chart2','chart3','chart4','chart5','chart6'].forEach(chartVar => {
                    const chartInstance = window[chartVar];
                    if (chartInstance) chartInstance.resize();
                });
                document.querySelectorAll('.fullscreen-btn').forEach(btn => btn.textContent = 'å…¨å±');
            }, 150);
        }
    });
    // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.fullscreen-btn').forEach(button => {
        button.textContent = 'å…¨å±';
    });
}
// ----------- å…¨å±åŠŸèƒ½ä¿®æ­£ END -----------

</script>
</body>
</html>