<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>期货品种对比与指标对比</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        .chart-container {
            position: relative;
            width: 100%;
            height: 450px;
            margin-bottom: 40px;
        }

        .chart {
            width: 100%;
            height: 100%;
        }

        .download-btn {
            position: absolute;
            top: 0px;
            right: 5px;
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            z-index: 10;
            border-radius: 5px;
        }

        .download-btn:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>

<!-- 第一个图表容器：期货品种走势对比 -->
<div class="chart-container">
    <div id="main1" class="chart"></div>
    <button id="download-btn1" class="download-btn">下载</button>
</div>

<!-- 第二个图表容器：增仓率 vs 涨跌幅 -->
<div class="chart-container">
    <div id="main3" class="chart"></div>
    <button id="download-btn3" class="download-btn">下载</button>
</div>

<!-- 第三个图表容器：投机度 vs 涨幅 -->
<div class="chart-container">
    <div id="main2" class="chart"></div>
    <button id="download-btn2" class="download-btn">下载</button>
</div>


<!-- 新增的图表容器：期货品种各周期指标对比 -->
<div class="chart-container" style="height: 400px;">
    <div id="main4" class="chart"></div>
    <button id="download-btn4" class="download-btn">下载</button>
</div>

<!-- 新增的图表容器：期货品种指标对比 -->
<div class="chart-container" style="height: 400px;">
    <div id="main5" class="chart"></div>
</div>

<script>
    const apiUrl = 'https://q.want.biz';

    // 声明五个图表实例
    const chart1 = echarts.init(document.getElementById('main1'));
    const chart2 = echarts.init(document.getElementById('main2'));
    const chart3 = echarts.init(document.getElementById('main3'));
    const chart4 = echarts.init(document.getElementById('main4'));
    const chart5 = echarts.init(document.getElementById('main5'));
    
    const fieldMapping = {
        qrspj: '昨收盘价',
        zdf5: '5日涨幅',
        zdf6: '6日涨幅',
        zjlx: '资金流向',
        dm: '代码',
        zsjd: '展示精度',
        lx: '品种类型代号',
        zdf0: '近一年涨幅',
        avg2: '计算均价',
        ccl: '持仓量',
        ly: '计算来源',
        zdf250: '250日涨幅',
        zdf3: '3日涨幅',
        dt: '跌停',
        bpgs: '档位数',
        mcj: '卖出价',
        mcl: '卖出量',
        zdflm: '本月涨幅',
        jjsj: '今结算价',
        zf: '振幅',
        mmpl: '量档位',
        tjd: '投机度',
        xsfx: '现手方向',
        name: '合约名称',
        zt: '涨停',
        spgs: '档位',
        mmpjg: '价格档位',
        zjsj: '昨结算价',
        spsj: '收盘时间',
        np: '内盘',
        rz: '日增仓',
        kpsj: '开盘时间',
        sc: '市场代码',
        uid: '唯一id',
        vol: '成交量',
        jysj: '交易时间',
        cjbs: '成交笔数',
        wp: '外盘',
        zdf20: '20日涨幅',
        cje: '成交额',
        mrj: '买入价',
        utime: '更新时间',
        mrl: '买入量',
        h: '最高价',
        j: '均价',
        zccl: '昨持仓量',
        l: '最低价',
        o: '开盘价',
        zdfly: '今年涨幅',
        p: '最新价',
        cclbh: '持仓变量',
        lb: '量比',
        zde: '涨跌额',
        jyzt: '交易状态',
        xs: '现手',
        zdf: '涨跌幅',
        cdzj: '沉淀资金'
    };
    // 获取 URL 参数中的指标值
    const urlParams = new URLSearchParams(window.location.search);
    const metric1 = urlParams.get('i') || 'cje'; // 默认第一个指标为涨跌幅 zdf
    const metric2 = urlParams.get('j') || 'zdf'; // 默认第二个指标为投机度 tjd

    // 获取数据并调用绘图函数
    async function fetchData() {
        try {
            const response = await fetch(apiUrl);
            const apiData = await response.json(); // 假设返回的数据结构与之前的相似

            // 过滤成交额大于 10 亿的品种
            let filteredData = apiData.list.filter(item => item.cje > 10e9);
            console.log('过滤后成交额大于 10 亿的品种:', filteredData); // 调试输出

            // 检查是否有未收盘的品种 (jyzt === 0)
            const hasOpenMarkets = filteredData.some(item => item.jyzt === 0);
            console.log('是否有未收盘的品种:', hasOpenMarkets); // 调试输出

            // 如果有未收盘的品种，则只显示未收盘的品种
            if (hasOpenMarkets) {
                filteredData = filteredData.filter(item => item.jyzt === 0);
                console.log('过滤后未收盘的品种:', filteredData); // 调试输出
            }


            // 调用五个图表的绘制函数
            renderChart1(filteredData);  // 期货品种走势对比
            renderChart2(filteredData);  // 投机度 vs 涨幅图表
            renderChart3(filteredData);  // 增仓率 vs 涨跌幅图表
            renderChart4(filteredData);  // 各周期涨跌幅对比
            renderChart5(filteredData, metric1, metric2);  // 期货品种指标对比
        } catch (error) {
            console.error('数据获取失败:', error);
        }
    }

    // 绘制第一个图表: 期货品种走势对比
    function renderChart1(dataList) {
        const processedData = dataList.map(item => {
            const openChange = parseFloat(((item.o - item.zjsj) / item.zjsj * 100).toFixed(2));  // 开盘涨幅
            const closeChange = parseFloat(((item.p - item.zjsj) / item.zjsj * 100).toFixed(2)); // 收盘涨幅
            const lowChange = parseFloat(((item.l - item.zjsj) / item.zjsj * 100).toFixed(2));   // 最低涨幅
            const highChange = parseFloat(((item.h - item.zjsj) / item.zjsj * 100).toFixed(2));  // 最高涨幅
            return {
                name: item.name,
                data: [openChange, closeChange, lowChange, highChange], // 保存涨跌幅数据
                closeChange // 保存收盘涨幅用来排序
            };
        });

        const sortedData = processedData.sort((a, b) => b.closeChange - a.closeChange);
        const categories = sortedData.map(item => item.name);
        const sortedProcessedData = sortedData.map(item => item.data);

        const option = {
            title: {
                text: '期货品种走势对比',
                left: 'center',
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross'
                }
            },
            xAxis: {
                type: 'category',
                data: categories,
                axisLabel: {
                    interval: 0,
                    rotate: 270
                }
            },
            yAxis: {
                type: 'value',
                axisLabel: {
                    formatter: value => value.toFixed(2) + ' %'
                }
            },
            series: [{
                name: '涨跌幅',
                type: 'candlestick',
                data: sortedProcessedData,
                itemStyle: {
                    color: '#ff4d4f',
                    color0: '#52c41a',
                    borderColor: '#ff4d4f',
                    borderColor0: '#52c41a'
                }
            }]
        };

        chart1.setOption(option);
    }

    // 绘制第二个图表: 投机度 vs 涨幅
    function renderChart2(dataList) {
        dataList.sort((a, b) => b.zdf - a.zdf);
        const categories = dataList.map(item => item.name);
        const tjdData = dataList.map(item => item.tjd);
        const zdfData = dataList.map(item => item.zdf);

        const option = {
            title: {
                text: '期货品种投机度与涨幅对比',
                left: 'center',
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross'
                }
            },
            xAxis: {
                type: 'category',
                data: categories,
                axisLabel: {
                    interval: 0,
                    rotate: 270
                }
            },
            yAxis: [
                {
                    type: 'value',
                    name: '投机度/100',
                    position: 'left'
                },
                {
                    type: 'value',
                    name: '涨幅 (%)',
                    position: 'right',
                    axisLabel: {
                        formatter: '{value} %'
                    }
                }
            ],
            series: [
                {
                    name: '投机度',
                    type: 'bar',
                    data: tjdData,
                    yAxisIndex: 0,
                    itemStyle: {
                        color: '#4CAF50'
                    }
                },
                {
                    name: '涨幅',
                    type: 'line',
                    data: zdfData,
                    yAxisIndex: 1,
                    itemStyle: {
                        color: '#FF5733'
                    },
                    lineStyle: {
                        width: 2
                    }
                }
            ]
        };

        chart2.setOption(option);
    }

    // 绘制第三个图表: 增仓率 vs 涨跌幅
    function renderChart3(dataList) {
        dataList.sort((a, b) => b.zdf - a.zdf);
        const categories = dataList.map(item => item.name);
        const zdfData = dataList.map(item => item.zdf);
        const zclData = dataList.map(item => ((item.rz / (item.ccl - item.rz)) * 100).toFixed(2));

        const option = {
            title: {
                text: '期货品种增仓率与涨幅对比',
                left: 'center',
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross'
                }
            },
            xAxis: {
                type: 'category',
                data: categories,
                axisLabel: {
                    interval: 0,
                    rotate: 270
                }
            },
            yAxis: [
                {
                    type: 'value',
                    name: '增仓率 (%)',
                    position: 'left',
                    axisLabel: {
                        formatter: value => value.toFixed(2) + ' %'
                    }
                },
                {
                    type: 'value',
                    name: '涨跌幅 (%)',
                    position: 'right',
                    axisLabel: {
                        formatter: '{value} %'
                    }
                }
            ],
            series: [
                {
                    name: '增仓率',
                    type: 'bar',
                    data: zclData,
                    yAxisIndex: 0,
                    itemStyle: {
                        color: '#3498DB'
                    }
                },
                {
                    name: '涨跌幅',
                    type: 'line',
                    data: zdfData,
                    yAxisIndex: 1,
                    itemStyle: {
                        color: '#E74C3C'
                    },
                    lineStyle: {
                        width: 2
                    }
                }
            ]
        };

        chart3.setOption(option);
    }

    // 绘制第四个图表: 各周期涨跌幅对比
    function renderChart4(dataList) {
        const categories = dataList.map(item => item.name);
        const zdfData = dataList.map(item => item.zdf);
        const zdf3Data = dataList.map(item => item.zdf3);
        const zdf5Data = dataList.map(item => item.zdf5);
        const zdf20Data = dataList.map(item => item.zdf20);
        const zdflyData = dataList.map(item => item.zdfly);
        const zdf0Data = dataList.map(item => item.zdf0);
        const zdf250Data = dataList.map(item => item.zdf250);

        const option = {
            title: {
                text: '期货品种各周期涨跌幅度对比',
                left: 'center',
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross'
                }
            },
            legend: {
                data: ['当日涨幅', '3日涨幅', '5日涨幅', '20日涨幅', '今年涨幅', '近一年涨幅', '250日涨幅'],
                top: '10%'
            },
            xAxis: {
                type: 'category',
                data: categories,
                axisLabel: {
                    interval: 0,
                    rotate: 270
                }
            },
            yAxis: {
                type: 'value',
                name: '涨跌幅 (%)',
                axisLabel: {
                    formatter: '{value} %'
                }
            },
            series: [
                {
                    name: '当日涨幅',
                    type: 'line',
                    data: zdfData,
                    lineStyle: { width: 2 }
                },
                {
                    name: '3日涨幅', 
                    type: 'line',
                    data: zdf3Data,
                    lineStyle: { width: 2 }
                },
                {
                    name: '5日涨幅',
                    type: 'line', 
                    data: zdf5Data,
                    lineStyle: { width: 2 }
                },
                {
                    name: '20日涨幅',
                    type: 'line',
                    data: zdf20Data,
                    lineStyle: { width: 2 }
                },
                {
                    name: '今年涨幅',
                    type: 'line',
                    data: zdflyData,
                    lineStyle: { width: 2 }
                },
                {
                    name: '近一年涨幅',  
                    type: 'line',
                    data: zdf0Data,
                    lineStyle: { width: 2 }
                },
                {  
                    name: '250日涨幅',
                    type: 'line',
                    data: zdf250Data,
                    lineStyle: { width: 2 }
                }
            ]
        };

        chart4.setOption(option);
    }

    // 绘制第五个图表: 期货品种指标对比
    function renderChart5(dataList, metric1, metric2) {
        dataList.sort((a, b) => b[metric1] - a[metric1]);
        const categories = dataList.map(item => item.name);
        const metric1Data = dataList.map(item => item[metric1]);
        const metric2Data = dataList.map(item => item[metric2]);

        console.log('指标1数据:', metric1Data);  // 调试输出
        console.log('指标2数据:', metric2Data);  // 调试输出
        
        const option = {
            title: {
                text: `期货品种${fieldMapping[metric1]}与${fieldMapping[metric2]}对比`,
                left: 'center',
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross'
                }
            },
            xAxis: {
                type: 'category',
                data: categories,
                axisLabel: {
                    interval: 0,
                    rotate: 270
                }
            },
            yAxis: [
                {
                    type: 'value',
                    name: fieldMapping[metric1]+'(亿)',
                    position: 'left'
                },
                {
                    type: 'value',
                    name: fieldMapping[metric2]+'(%)',
                    position: 'right'
                }
            ],
            series: [
                {
                    name: fieldMapping[metric1],
                    type: 'bar',
                    data: metric1Data.map(value => (value / 10e8).toFixed(2)),yAxisIndex: 0,
                    itemStyle: {
                        color: '#4CAF50'
                    }
                },
                {
                    name: fieldMapping[metric2],
                    type: 'line',
                    data: metric2Data,
                    yAxisIndex: 1,
                    itemStyle: {
                        color: '#FF5733'
                    },
                    lineStyle: {
                        width: 2
                    }
                }
            ]
        };

        chart5.setOption(option);
    }

    // 为每个图表添加下载功能的事件监听器
    document.getElementById('download-btn1').addEventListener('click', () => {
        chart1.getConnectedDataURL({backgroundColor: '#FFFFFF', type: 'png', pixelRatio: 2})
            .then(url => {
                const link = document.createElement('a');
                link.href = url;
                link.download = 'futures_trend_comparison.png';
                link.click();
            });
    });
    
    document.getElementById('download-btn2').addEventListener('click', () => {
        chart2.getConnectedDataURL({backgroundColor: '#FFFFFF', type: 'png', pixelRatio: 2})
            .then(url => {
                const link = document.createElement('a');
                link.href = url;
                link.download = 'speculation_vs_change.png';
                link.click();
            });
    });
        
    document.getElementById('download-btn3').addEventListener('click', () => {
        chart3.getConnectedDataURL({backgroundColor: '#FFFFFF', type: 'png', pixelRatio: 2}) 
            .then(url => {
                const link = document.createElement('a');
                link.href = url;
                link.download = 'increase_rate_vs_change.png';
                link.click();
            });
    });
    
    document.getElementById('download-btn4').addEventListener('click', () => {
        chart4.getConnectedDataURL({backgroundColor: '#FFFFFF', type: 'png', pixelRatio: 2})
            .then(url => {
                const link = document.createElement('a');
                link.href = url;
                link.download = 'period_change_comparison.png'; 
                link.click();
            });
    });

    fetchData(); // 获取数据并绘制图表
        
    window.addEventListener('resize', () => {
        chart1.resize();
        chart2.resize();
        chart3.resize();
        chart4.resize();
        chart5.resize();
    });
</script>
</body>
</html>