<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœŸè´§å“ç§ç›‘æ§</title>
    <!-- å¼•å…¥ ECharts è„šæœ¬ -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        /* å›¾è¡¨å®¹å™¨æ ·å¼ */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 1200px; /* é™åˆ¶æœ€å¤§å®½åº¦ï¼Œæé«˜å¯è¯»æ€§ */
            height: 450px;
            margin: 0 auto 60px auto; /* å±…ä¸­å¹¶è®¾ç½®ä¸‹è¾¹è· */
            border: 1px solid #e0e0e0; /* æ·»åŠ è¾¹æ¡† */
            box-shadow: 0 2px 10px rgba(0,0,0,0.08); /* æ·»åŠ é˜´å½± */
            border-radius: 8px; /* åœ†è§’ */
            overflow: hidden; /* éšè—è¶…å‡ºéƒ¨åˆ† */
            background-color: #fff; /* å›¾è¡¨å®¹å™¨èƒŒæ™¯è‰² */
        }

        .chart {
            width: 100%;
            height: 100%;
        }

        /* ä¸‹è½½æŒ‰é’®æ ·å¼ */
        .download-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            padding: 8px 15px;
            background-color: #007ACC;
            color: white;
            border: none;
            cursor: pointer;
            z-index: 10;
            border-radius: 5px;
            font-size: 14px;
            opacity: 0.8;
            transition: background-color 0.3s ease, opacity 0.3s ease; /* æ·»åŠ è¿‡æ¸¡æ•ˆæœ */
        }

        .download-btn:hover {
            background-color: #005A9E;
            opacity: 1;
        }

        /* é¡µé¢æ•´ä½“èƒŒæ™¯å’Œå­—ä½“ */
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
            box-sizing: border-box; /* åŒ…å«å†…è¾¹è·å’Œè¾¹æ¡†åœ¨æ€»å®½åº¦å†… */
        }

        /* æ ‡é¢˜æ ·å¼ */
        h1 {
            text-align: center;
            font-size: 28px; /* ç¨å¾®å¢å¤§æ ‡é¢˜å­—å· */
            margin-bottom: 30px;
            color: #2c3e50; /* æ·±è‰²æ ‡é¢˜ */
        }

        /* å›¾è¡¨æ ‡é¢˜æ ·å¼ (å¦‚æœå›¾è¡¨å®¹å™¨å†…éœ€è¦é¢å¤–æ ‡é¢˜) */
        /* .chart-title {
            text-align: center;
            font-size: 20px;
            margin-bottom: 10px;
            color: #333;
        } */
    </style>
</head>
<body>

<h1 id="current-time">ğŸ—æœŸè´§å“ç§å®æ—¶ç›‘æ§ğŸ—</h1>


<!-- ç¬¬ä¸€ä¸ªå›¾è¡¨å®¹å™¨ï¼šæœŸè´§å“ç§èµ°åŠ¿å¯¹æ¯” -->
<div class="chart-container">
    <div id="main1" class="chart"></div>
    <button id="download-btn1" class="download-btn">ä¸‹è½½</button>
</div>

<!-- ç¬¬äºŒä¸ªå›¾è¡¨å®¹å™¨ï¼šæŠ•æœºåº¦ vs æ¶¨è·Œå¹… -->
<div class="chart-container">
    <div id="main2" class="chart"></div>
    <button id="download-btn2" class="download-btn">ä¸‹è½½</button>
</div>

<!-- ç¬¬ä¸‰ä¸ªå›¾è¡¨å®¹å™¨ï¼šå¢ä»“ç‡ vs æ¶¨è·Œå¹… -->
<div class="chart-container">
    <div id="main3" class="chart"></div>
    <button id="download-btn3" class="download-btn">ä¸‹è½½</button>
</div>

<!-- ç¬¬å››ä¸ªå›¾è¡¨å®¹å™¨ï¼šæœŸè´§å“ç§å„å‘¨æœŸæŒ‡æ ‡å¯¹æ¯” -->
<div class="chart-container">
    <div id="main4" class="chart"></div>
    <button id="download-btn4" class="download-btn">ä¸‹è½½</button>
</div>

<!-- ç¬¬äº”ä¸ªå›¾è¡¨å®¹å™¨ï¼šæœŸè´§å“ç§æŒ‡æ ‡å¯¹æ¯” -->
<div class="chart-container">
    <div id="main5" class="chart"></div>
    <!-- æœ€åä¸€ä¸ªå›¾è¡¨æ²¡æœ‰ä¸‹è½½æŒ‰é’®ï¼Œå¦‚æœéœ€è¦å¯ä»¥è‡ªè¡Œæ·»åŠ  -->
</div>

<script>
    // è·å–å½“å‰æ—¶é—´å¹¶åˆ¤æ–­æ˜¯å¦ä¸ºæ—¥ç›˜æ—¶æ®µ
    function isDaySession() {
        const now = new Date();
        const hours = now.getHours();
        const minutes = now.getMinutes();
        
        // åˆ¤æ–­æ˜¯å¦åœ¨æ—¥ç›˜æ—¶æ®µï¼ˆ8:30 - 15:30ï¼‰
        const startOfDaySession = 8 * 60 + 30;  // 8:30 è½¬æ¢ä¸ºåˆ†é’Ÿ
        const endOfDaySession = 15 * 60 + 30;   // 15:30 è½¬æ¢ä¸ºåˆ†é’Ÿ
        const currentTimeInMinutes = hours * 60 + minutes;

        return currentTimeInMinutes >= startOfDaySession && currentTimeInMinutes <= endOfDaySession;
    }


    // æ£€æŸ¥å½“å‰æ—¶é—´æ˜¯å¦ä¸ºæ—¥ç›˜æ—¶æ®µï¼Œé€‰æ‹©å¯¹åº”çš„ API åœ°å€
    const apiUrl = isDaySession() ? 'https://q.want.biz' : 'https://q.want.biz/night'; // ç¤ºä¾‹ API URL
    console.log(`Fetching data from: ${apiUrl}`); // è°ƒè¯•è¾“å‡º
    

    // å£°æ˜äº”ä¸ªå›¾è¡¨å®ä¾‹ã€‚
    const chart1 = echarts.init(document.getElementById('main1'));
    const chart2 = echarts.init(document.getElementById('main2'));
    const chart3 = echarts.init(document.getElementById('main3'));
    const chart4 = echarts.init(document.getElementById('main4'));
    const chart5 = echarts.init(document.getElementById('main5'));

    // æŒ‡æ ‡å­—æ®µæ˜ å°„
    const fieldMapping = {
        qrspj: 'æ˜¨æ”¶ç›˜ä»·',
        zdf5: '5æ—¥æ¶¨å¹…',
        zdf6: '6æ—¥æ¶¨å¹…',
        zjlx: 'èµ„é‡‘æµå‘',
        dm: 'ä»£ç ',
        zsjd: 'å±•ç¤ºç²¾åº¦',
        lx: 'å“ç§ç±»å‹ä»£å·',
        zdf0: 'è¿‘ä¸€å¹´æ¶¨å¹…',
        avg2: 'è®¡ç®—å‡ä»·',
        ccl: 'æŒä»“é‡',
        ly: 'è®¡ç®—æ¥æº',
        zdf250: '250æ—¥æ¶¨å¹…',
        zdf3: '3æ—¥æ¶¨å¹…',
        dt: 'è·Œåœ',
        bpgs: 'æ¡£ä½æ•°',
        mcj: 'å–å‡ºä»·',
        mcl: 'å–å‡ºé‡',
        zdflm: 'æœ¬æœˆæ¶¨å¹…',
        jjsj: 'ä»Šç»“ç®—ä»·',
        zf: 'æŒ¯å¹…',
        mmpl: 'é‡æ¡£ä½',
        tjd: 'æŠ•æœºåº¦',
        xsfx: 'ç°æ‰‹æ–¹å‘',
        name: 'åˆçº¦åç§°',
        zt: 'æ¶¨åœ',
        spgs: 'æ¡£ä½',
        mmpjg: 'ä»·æ ¼æ¡£ä½',
        zjsj: 'æ˜¨ç»“ç®—ä»·',
        spsj: 'æ”¶ç›˜æ—¶é—´',
        np: 'å†…ç›˜',
        rz: 'æ—¥å¢ä»“',
        kpsj: 'å¼€ç›˜æ—¶é—´',
        sc: 'å¸‚åœºä»£ç ',
        uid: 'å”¯ä¸€id',
        vol: 'æˆäº¤é‡',
        jysj: 'äº¤æ˜“æ—¶é—´',
        cjbs: 'æˆäº¤ç¬”æ•°',
        wp: 'å¤–ç›˜',
        zdf20: '20æ—¥æ¶¨å¹…',
        cje: 'æˆäº¤é¢',
        mrj: 'ä¹°å…¥ä»·',
        utime: 'æ›´æ–°æ—¶é—´',
        mrl: 'ä¹°å…¥é‡',
        h: 'æœ€é«˜ä»·',
        j: 'å‡ä»·',
        zccl: 'æ˜¨æŒä»“é‡',
        l: 'æœ€ä½ä»·',
        o: 'å¼€ç›˜ä»·',
        zdfly: 'ä»Šå¹´æ¶¨å¹…',
        p: 'æœ€æ–°ä»·',
        cclbh: 'æŒä»“å˜é‡',
        lb: 'é‡æ¯”',
        zde: 'æ¶¨è·Œé¢',
        jyzt: 'äº¤æ˜“çŠ¶æ€',
        xs: 'ç°æ‰‹',
        zdf: 'æ¶¨è·Œå¹…',
        cdzj: 'æ²‰æ·€èµ„é‡‘'
    };

    // è·å– URL å‚æ•°ä¸­çš„æŒ‡æ ‡å€¼
    const urlParams = new URLSearchParams(window.location.search);
    const metric1 = urlParams.get('i') || 'cje'; // é»˜è®¤ç¬¬ä¸€ä¸ªæŒ‡æ ‡ä¸ºæˆäº¤é¢ cje
    const metric2 = urlParams.get('j') || 'zdf'; // é»˜è®¤ç¬¬äºŒä¸ªæŒ‡æ ‡ä¸ºæ¶¨è·Œå¹… zdf

    // è·å–æ•°æ®å¹¶è°ƒç”¨ç»˜å›¾å‡½æ•°
    async function fetchData() {
        try {
            const response = await fetch(apiUrl);
            const apiData = await response.json(); // å‡è®¾è¿”å›çš„æ•°æ®ç»“æ„ä¸ä¹‹å‰çš„ç›¸ä¼¼

            // è¿‡æ»¤æ²‰æ·€èµ„é‡‘å¤§äº 15 äº¿çš„å“ç§
            let filteredData = apiData.list.filter(item => item.cdzj > 15 * 1e8);

            // æ£€æŸ¥æ˜¯å¦æœ‰æœªæ”¶ç›˜çš„å“ç§ (jyzt === 0)
            const hasOpenMarkets = filteredData.some(item => item.jyzt === 0);

            // å¦‚æœæœ‰æœªæ”¶ç›˜çš„å“ç§ï¼Œåˆ™åªæ˜¾ç¤ºæœªæ”¶ç›˜çš„å“ç§
            if (hasOpenMarkets) {
                filteredData = filteredData.filter(item => item.jyzt === 0);
            }

            // è°ƒç”¨äº”ä¸ªå›¾è¡¨çš„ç»˜åˆ¶å‡½æ•°
            // æ³¨æ„ï¼šå› ä¸º renderChart2 å’Œ renderChart4 ä¼šå¯¹ä¼ å…¥çš„ dataList è¿›è¡Œæ’åº
            // å¦‚æœå…¶ä»–å›¾è¡¨ä¹Ÿéœ€è¦åŸå§‹æœªæ’åºçš„æ•°æ®ï¼Œæˆ–æŒ‰ä¸åŒæ ‡å‡†æ’åºï¼Œ
            // åˆ™éœ€è¦åœ¨è¿™é‡Œå¯¹ dataList è¿›è¡Œæ·±æ‹·è´ [...dataList]
            renderChart1(filteredData);
            renderChart2([...filteredData]); // å…‹éš†ä¸€ä»½ï¼Œé¿å…æ’åºå½±å“chart3/4/5çš„è¾“å…¥
            renderChart3([...filteredData]); // å…‹éš†ä¸€ä»½
            renderChart4([...filteredData]); // å…‹éš†ä¸€ä»½
            renderChart5([...filteredData], metric1, metric2); // å…‹éš†ä¸€ä»½
        } catch (error) {
            console.error('æ•°æ®è·å–å¤±è´¥:', error);
        }
    }

    // ç»˜åˆ¶ç¬¬ä¸€ä¸ªå›¾è¡¨: æœŸè´§å“ç§èµ°åŠ¿å¯¹æ¯”
    function renderChart1(dataList) {
        // æ·±æ‹·è´dataListä»¥é¿å…åç»­æ’åºå½±å“å…¶ä»–å›¾è¡¨
        const currentDataList = [...dataList];
        
        const processedData = currentDataList.map(item => {
            const openChange = parseFloat(((item.o - item.zjsj) / item.zjsj * 100).toFixed(2));  // å¼€ç›˜æ¶¨å¹…
            const closeChange = parseFloat(((item.p - item.zjsj) / item.zjsj * 100).toFixed(2)); // æ”¶ç›˜æ¶¨å¹…
            const lowChange = parseFloat(((item.l - item.zjsj) / item.zjsj * 100).toFixed(2));   // æœ€ä½æ¶¨å¹…
            const highChange = parseFloat(((item.h - item.zjsj) / item.zjsj * 100).toFixed(2));  // æœ€é«˜æ¶¨å¹…
            return {
                name: item.name,
                dm: item.dm,
                value: [openChange, closeChange, lowChange, highChange], // ECharts Kçº¿å›¾æ•°æ®æœŸæœ›value
                closeChange // ä¿å­˜æ”¶ç›˜æ¶¨å¹…ç”¨æ¥æ’åº
            };
        });

        // èµ°åŠ¿å›¾éœ€è¦æ ¹æ®æ”¶ç›˜æ¶¨è·Œå¹…æ’åºï¼Œä»¥ä¾¿ç›´è§‚å±•ç¤º
        const sortedData = processedData.sort((a, b) => b.closeChange - a.closeChange);
        const categories = sortedData.map(item => item.name);
        
        const option = {
            title: {
                text: 'æœŸè´§å“ç§èµ°åŠ¿å¯¹æ¯”',
                left: 'center',
                textStyle: {
                    fontSize: 18,
                    color: '#333'
                }
            },
            backgroundColor: '#EAECEDFF', // èƒŒæ™¯é¢œè‰²
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'shadow'
                },
                // è‡ªå®šä¹‰tooltipï¼Œæ˜¾ç¤ºå¼€ç›˜ã€æ”¶ç›˜ã€æœ€ä½ã€æœ€é«˜æ¶¨è·Œå¹…
                formatter: function (params) {
                    const data = params[0].data.value; // è·å–Kçº¿å›¾çš„valueæ•°ç»„
                    if (data && data.length === 4) {
                        return `${params[0].name}<br/>` +
                               `å¼€ç›˜æ¶¨å¹…: ${data[0]} %<br/>` +
                               `æ”¶ç›˜æ¶¨å¹…: ${data[1]} %<br/>` +
                               `æœ€ä½æ¶¨å¹…: ${data[2]} %<br/>` +
                               `æœ€é«˜æ¶¨å¹…: ${data[3]} %`;
                    }
                    return params[0].name;
                }
            },
            xAxis: {
                type: 'category',
                data: categories,
                axisLabel: {
                    interval: 0,
                    rotate: 45, // è°ƒæ•´ä¸º45åº¦è§’ï¼Œé¿å…è¿‡é•¿æ—¶é‡å 
                    fontSize: 12,
                    color: '#333'
                },
                axisLine: {
                    lineStyle: {
                        color: '#aaa'
                    }
                }
            },
            yAxis: {
                type: 'value',
                axisLabel: {
                    formatter: value => value.toFixed(2) + ' %',
                    fontSize: 12,
                    color: '#333'
                },
                splitLine: {
                    lineStyle: {
                        color: '#eee'
                    }
                },
                axisLine: {
                    lineStyle: {
                        color: '#aaa'
                    }
                }
            },
            dataZoom: [
                {
                    type: 'inside',
                    start: 0,
                    end: 100
                },
                {
                    start: 0,
                    end: 100
                }
            ],
            series: [{
                name: 'æ¶¨è·Œå¹…',
                type: 'candlestick',
                data: sortedData.map(item => ({
                    value: item.value, // Kçº¿å›¾æ•°æ®é¡¹çš„value
                    dm: item.dm, // ç¡®ä¿ dm å­—æ®µå­˜å‚¨åœ¨æ•°æ®é¡¹ä¸­
                    name: item.name // ç¡®ä¿ name å­—æ®µå­˜å‚¨åœ¨æ•°æ®é¡¹ä¸­
                })),
                itemStyle: {
                    color: '#EF5350',    // é˜³çº¿é¢œè‰²
                    color0: '#53A626FF',   // é˜´çº¿é¢œè‰²
                    borderColor: '#EF5350',
                    borderColor0: '#26A69A'
                },
                markPoint: {
                    label: {
                        formatter: '{c}%',
                        color: '#fff'
                    },
                    data: [
                        {
                            type: 'max',
                            name: 'max',
                            valueDim: 'close'
                        },
                        {
                            type: 'min',
                            name: 'min',
                            valueDim: 'close'
                        }
                    ],
                    symbolSize: 66,
                    itemStyle: {
                        color: '#A722EFFF'
                    }
                }
            }]
        };

        chart1.setOption(option);

        // æ·»åŠ ç‚¹å‡»äº‹ä»¶
        chart1.off('click'); // å…ˆç§»é™¤ä¹‹å‰çš„ç‚¹å‡»äº‹ä»¶ï¼Œé¿å…å¤šæ¬¡ç»‘å®š
        chart1.on('click', function (params) {
            // å¯¹äº k çº¿å›¾ï¼Œparams.data å°±æ˜¯æˆ‘ä»¬ä¼ å…¥çš„åŒ…å« dm çš„å¯¹è±¡
            if (params.seriesType === 'candlestick' && params.data && params.data.dm) {
                const dataItem = params.data;
                const dm = dataItem.dm;
                const codeWithoutNumbers = stripNumbers(dm);

                const date = getCorrectDate();
                const formattedDate = formatDate(date); // æ ¼å¼åŒ–æ—¥æœŸä¸º 'YYYY-MM-DD'

                // æ„å»ºURL
                const baseUrl = 'https://data.want.biz/ranking/' + codeWithoutNumbers + '/all/' + formattedDate;
                const queryString = '?variety=' + codeWithoutNumbers + '&sort_by=%E5%87%80%E6%8C%81%E4%BB%93%E6%95%B0%E5%80%BC&order=desc#profits';

                const url = baseUrl + queryString;

                // åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€é“¾æ¥
                window.open(url, '_blank');
            }
        });
    }

    // å»é™¤å­—ç¬¦ä¸²ä¸­çš„æ•°å­—
    function stripNumbers(str) {
        return str.replace(/\d+/g, '');
    }

    // è·å–æ­£ç¡®çš„æ—¥æœŸ
    function getCorrectDate() {
        const now = new Date();
        const hour = now.getHours();
        let date;

        // æ ¹æ®äº¤æ˜“æ—¶é—´é€‰æ‹©æ—¥æœŸ
        // å‡è®¾æ—¥ç›˜æ”¶ç›˜åå’Œå¤œç›˜å¼€ç›˜å‰ï¼Œä½¿ç”¨ä¸Šä¸€ä¸ªäº¤æ˜“æ—¥çš„æ•°æ®
        // æ™šä¸Šäº¤æ˜“æ—¶æ®µå’Œæ¬¡æ—¥å‡Œæ™¨ç›˜ä½¿ç”¨å½“å¤©æ—¥æœŸ
        // å…·ä½“çš„äº¤æ˜“æ—¶é—´åˆ’åˆ†å¯èƒ½éœ€è¦æ›´ç²¾ç¡®çš„åˆ¤æ–­
        if (hour >= 0 && hour < 3) { // å‡Œæ™¨0ç‚¹åˆ°2ç‚¹åŠï¼Œå±äºå¤œç›˜äº¤æ˜“æ—¶æ®µçš„ååŠæ®µ
             date = now; // ä½¿ç”¨å½“å‰æ—¥æœŸ
        } else if (hour >= 3 && hour < 9) { // å‡Œæ™¨3ç‚¹åˆ°ä¸Šåˆ9ç‚¹ï¼Œéäº¤æ˜“æ—¶æ®µï¼Œä½¿ç”¨ä¸Šä¸€ä¸ªäº¤æ˜“æ—¥
            date = getLastTradingDay();
        } else if (hour >= 9 && hour < 15) { // ä¸Šåˆ9ç‚¹åˆ°ä¸‹åˆ3ç‚¹ï¼Œæ—¥ç›˜äº¤æ˜“æ—¶æ®µ
            date = now; // ä½¿ç”¨å½“å‰æ—¥æœŸ
        } else if (hour >= 15 && hour < 21) { // ä¸‹åˆ3ç‚¹åˆ°æ™šä¸Š9ç‚¹ï¼Œéäº¤æ˜“æ—¶æ®µï¼Œä½¿ç”¨ä¸Šä¸€ä¸ªäº¤æ˜“æ—¥
            date = getLastTradingDay();
        } else { // æ™šä¸Š21ç‚¹åˆ°24ç‚¹ï¼Œå¤œç›˜äº¤æ˜“æ—¶æ®µ
            date = now; // ä½¿ç”¨å½“å‰æ—¥æœŸ
        }
        return date;
    }

    // è·å–ä¸Šä¸€ä¸ªäº¤æ˜“æ—¥ï¼ˆä¸åŒ…æ‹¬å‘¨æœ«ï¼‰
    function getLastTradingDay() {
        const today = new Date();
        let lastTradingDay = new Date(today);
        const dayOfWeek = today.getDay(); // 0ï¼ˆå‘¨æ—¥ï¼‰ åˆ° 6ï¼ˆå‘¨å…­ï¼‰

        if (dayOfWeek === 0) { // å‘¨æ—¥
            lastTradingDay.setDate(today.getDate() - 2); // å›åˆ°å‘¨äº”
        } else if (dayOfWeek === 1) { // å‘¨ä¸€
            lastTradingDay.setDate(today.getDate() - 3); // å›åˆ°å‘¨äº”
        } else {
            lastTradingDay.setDate(today.getDate() - 1); // å›åˆ°æ˜¨å¤©
        }
        return lastTradingDay;
    }

    // æ ¼å¼åŒ–æ—¥æœŸä¸º 'YYYY-MM-DD'
    function formatDate(date) {
        const year = date.getFullYear();
        const month = date.getMonth() + 1; // æœˆä»½ä»0å¼€å§‹
        const day = date.getDate();

        const monthStr = month < 10 ? '0' + month : month;
        const dayStr = day < 10 ? '0' + day : day;

        return year + '-' + monthStr + '-' + dayStr;
    }

    // ç»˜åˆ¶ç¬¬äºŒä¸ªå›¾è¡¨: æŠ•æœºåº¦ vs æ¶¨å¹…
    function renderChart2(dataList) {
        // å¯¹ä¼ å…¥çš„ dataList è¿›è¡Œæ’åº
        dataList.sort((a, b) => b.zdf - a.zdf); 
        const categories = dataList.map(item => item.name);
        
        const option = {
            title: {
                text: 'æŠ•æœºåº¦ä¸æ¶¨è·Œå¹…',
                left: 'center',
                textStyle: {
                    fontSize: 18,
                    color: '#333'
                }
            },
            backgroundColor: '#EAECEDFF',
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'shadow'
                }
            },
            legend: {
                data: ['æŠ•æœºåº¦', 'æ¶¨å¹…'],
                top: '8%',
                textStyle: {
                    fontSize: 12
                }
            },
            xAxis: {
                type: 'category',
                data: categories,
                axisLabel: {
                    interval: 0,
                    rotate: 45, // è°ƒæ•´ä¸º45åº¦è§’
                    fontSize: 12,
                    color: '#333'
                },
                axisLine: {
                    lineStyle: {
                        color: '#aaa'
                    }
                }
            },
            yAxis: [
                {
                    type: 'value',
                    name: 'æŠ•æœºåº¦/100',
                    position: 'left',
                    axisLabel: {
                        fontSize: 12,
                        color: '#333'
                    },
                    splitLine: {
                        lineStyle: {
                            color: '#eee'
                        }
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#aaa'
                        }
                    }
                },
                {
                    type: 'value',
                    name: 'æ¶¨å¹… (%)',
                    position: 'right',
                    axisLabel: {
                        formatter: '{value} %',
                        fontSize: 12,
                        color: '#333'
                    },
                    splitLine: {
                        show: false
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#aaa'
                        }
                    }
                }
            ],
            dataZoom: [
                {
                    type: 'inside',
                    start: 0,
                    end: 100
                },
                {
                    start: 0,
                    end: 100
                }
            ],
            series: [
                {
                    name: 'æŠ•æœºåº¦',
                    type: 'bar',
                    yAxisIndex: 0,
                    itemStyle: {
                        color: '#42A5F5'
                    },
                    barWidth: '45%',
                    // å…³é”®ï¼šå°†åŸå§‹çš„ dm å’Œ name å­˜å‚¨åœ¨æ¯ä¸ªæ•°æ®é¡¹ä¸­
                    data: dataList.map(item => ({
                        value: item.tjd,
                        dm: item.dm, // å­˜å‚¨å“ç§ä»£ç 
                        name: item.name // å­˜å‚¨å“ç§åç§°
                    }))
                },
                {
                    name: 'æ¶¨å¹…',
                    type: 'line',
                    yAxisIndex: 1,
                    itemStyle: {
                        color: '#FF7043'
                    },
                    lineStyle: {
                        width: 2
                    },
                    smooth: true,
                    // åŒæ ·ï¼Œçº¿å›¾æ•°æ®ä¹Ÿå­˜å‚¨ dmï¼Œå°½ç®¡ç‚¹å‡»é€šå¸¸å‘ç”Ÿåœ¨æŸ±çŠ¶å›¾ä¸Š
                    data: dataList.map(item => ({
                        value: item.zdf,
                        dm: item.dm,
                        name: item.name
                    }))
                }
            ]
        };

        chart2.setOption(option);

        // ç»‘å®š chart2 çš„ç‚¹å‡»äº‹ä»¶
        chart2.off('click'); // å…ˆç§»é™¤ä¹‹å‰çš„ç‚¹å‡»äº‹ä»¶ï¼Œé¿å…å¤šæ¬¡ç»‘å®š
        chart2.on('click', function (params) {
            // ç¡®ä¿ç‚¹å‡»çš„æ˜¯æœ‰æ•ˆçš„æ•°æ®ç‚¹ï¼Œå¹¶ä¸”æˆ‘ä»¬å…³å¿ƒçš„æ˜¯æŸ±çŠ¶å›¾æˆ–çº¿å›¾çš„ç‚¹å‡»
            // params.data åŒ…å«äº†æˆ‘ä»¬ä¸ºæ•°æ®é¡¹è®¾ç½®çš„ dm å’Œ name
            if (params.data && params.data.dm) {
                const dm = params.data.dm; 
                const codeWithoutNumbers = stripNumbers(dm);
                
                // æ„å»ºURL
                const url = 'https://wealth.want.biz/pages/longshort.html?variety=' + codeWithoutNumbers;
                
                // åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€é“¾æ¥
                window.open(url, '_blank');
            }
        });
    }

    // ç»˜åˆ¶ç¬¬ä¸‰ä¸ªå›¾è¡¨: å¢ä»“ç‡ vs æ¶¨è·Œå¹…
    function renderChart3(dataList) {
        // å¯¹ä¼ å…¥çš„ dataList è¿›è¡Œæ’åº
        dataList.sort((a, b) => b.zdf - a.zdf);
        const categories = dataList.map(item => item.name);
        const zdfData = dataList.map(item => item.zdf);
        const zclData = dataList.map(item => {
            // é¿å…é™¤ä»¥é›¶æˆ–è´Ÿæ•°æŒä»“é‡
            const divisor = item.ccl - item.rz;
            if (divisor === 0 || divisor < 0) { // å¦‚æœåˆ†æ¯ä¸º0æˆ–è´Ÿæ•°
                return 0; // æˆ–è€…NaNï¼Œæ ¹æ®ä½ çš„ä¸šåŠ¡é€»è¾‘å†³å®š
            }
            return parseFloat(((item.rz / divisor) * 100).toFixed(2));
        });

        const option = {
            title: {
                text: 'æœŸè´§å“ç§å¢ä»“ç‡ä¸æ¶¨è·Œå¹…å¯¹æ¯”',
                left: 'center',
                textStyle: {
                    fontSize: 18,
                    color: '#333'
                }
            },
            backgroundColor: '#EAECEDFF',
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'shadow'
                }
            },
            legend: {
                data: ['å¢ä»“ç‡', 'æ¶¨è·Œå¹…'],
                top: '8%',
                textStyle: {
                    fontSize: 12
                }
            },
            xAxis: {
                type: 'category',
                data: categories,
                axisLabel: {
                    interval: 0,
                    rotate: 45, // è°ƒæ•´ä¸º45åº¦è§’
                    fontSize: 12,
                    color: '#333'
                },
                axisLine: {
                    lineStyle: {
                        color: '#aaa'
                    }
                }
            },
            yAxis: [
                {
                    type: 'value',
                    name: 'å¢ä»“ç‡ (%)',
                    position: 'left',
                    axisLabel: {
                        formatter: '{value} %',
                        fontSize: 12,
                        color: '#333'
                    },
                    splitLine: {
                        lineStyle: {
                            color: '#eee'
                        }
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#aaa'
                        }
                    }
                },
                {
                    type: 'value',
                    name: 'æ¶¨è·Œå¹… (%)',
                    position: 'right',
                    axisLabel: {
                        formatter: '{value} %',
                        fontSize: 12,
                        color: '#333'
                    },
                    splitLine: {
                        show: false
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#aaa'
                        }
                    }
                }
            ],
            dataZoom: [
                {
                    type: 'inside',
                    start: 0,
                    end: 100
                },
                {
                    start: 0,
                    end: 100
                }
            ],
            series: [
                {
                    name: 'å¢ä»“ç‡',
                    type: 'bar',
                    yAxisIndex: 0,
                    itemStyle: {
                        color: '#42A5F5'
                    },
                    barWidth: '45%',
                    // å…³é”®ï¼šå°†åŸå§‹çš„ dm å’Œ name å­˜å‚¨åœ¨æ¯ä¸ªæ•°æ®é¡¹ä¸­
                    data: dataList.map(item => ({
                        value: (item.ccl - item.rz === 0 || item.ccl - item.rz < 0) ? 0 : parseFloat(((item.rz / (item.ccl - item.rz)) * 100).toFixed(2)),
                        dm: item.dm, // å­˜å‚¨å“ç§ä»£ç 
                        name: item.name // å­˜å‚¨å“ç§åç§°
                    }))
                },
                {
                    name: 'æ¶¨è·Œå¹…',
                    type: 'line',
                    yAxisIndex: 1,
                    itemStyle: {
                        color: '#EF5350'
                    },
                    lineStyle: {
                        width: 2
                    },
                    smooth: true,
                    // åŒæ ·ï¼Œçº¿å›¾æ•°æ®ä¹Ÿå­˜å‚¨ dm
                    data: dataList.map(item => ({
                        value: item.zdf,
                        dm: item.dm,
                        name: item.name
                    }))
                }
            ]
        };

        chart3.setOption(option);

        // æ·»åŠ ç‚¹å‡»äº‹ä»¶
        chart3.off('click'); // å…ˆç§»é™¤ä¹‹å‰çš„ç‚¹å‡»äº‹ä»¶ï¼Œé¿å…å¤šæ¬¡ç»‘å®š
        chart3.on('click', function (params) {
            // ç¡®ä¿ç‚¹å‡»çš„æ˜¯æœ‰æ•ˆçš„æ•°æ®ç‚¹
            if (params.data && params.data.dm) {
                const dm = params.data.dm; // ç›´æ¥ä»params.dataè·å–dm
                const codeWithoutNumbers = stripNumbers(dm);
                
                // æ„å»ºURL
                const url = 'https://wealth.want.biz/pages/longshort.html?variety=' + codeWithoutNumbers;
                
                // åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€é“¾æ¥
                window.open(url, '_blank');
            }
        });
    }

    // ç»˜åˆ¶ç¬¬å››ä¸ªå›¾è¡¨: å„å‘¨æœŸæ¶¨è·Œå¹…å¯¹æ¯”
    function renderChart4(dataList) {
        // å¯¹ä¼ å…¥çš„ dataList è¿›è¡Œæ’åº
        dataList.sort((a, b) => b.zdf - a.zdf); // ä¿æŒæ’åºï¼Œä½†éœ€æ³¨æ„å…¶å‰¯ä½œç”¨

        const categories = dataList.map(item => item.name);
        // æ•°æ®ç³»åˆ—é…ç½®ï¼Œæ–¹ä¾¿å¾ªç¯ç”Ÿæˆ ECharts series
        const seriesConfig = [
            { name: 'å½“æ—¥æ¶¨å¹…', field: 'zdf', color: '#FF5722' },
            { name: '3æ—¥æ¶¨å¹…', field: 'zdf3', color: '#8BC34A' },
            { name: '5æ—¥æ¶¨å¹…', field: 'zdf5', color: '#42A5F5' },
            { name: '20æ—¥æ¶¨å¹…', field: 'zdf20', color: '#AB47BC' },
            { name: 'ä»Šå¹´æ¶¨å¹…', field: 'zdfly', color: '#FFA726' },
            { name: 'è¿‘ä¸€å¹´æ¶¨å¹…', field: 'zdf0', color: '#26A69A' },
            { name: '250æ—¥æ¶¨å¹…', field: 'zdf250', color: '#EC407A' }
        ];

        const option = {
            title: {
                text: 'æœŸè´§å“ç§å„å‘¨æœŸæ¶¨è·Œå¹…å¯¹æ¯”',
                left: 'center',
                textStyle: {
                    fontSize: 18,
                    color: '#333'
                }
            },
            backgroundColor: '#EAECEDFF',
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'line'
                }
            },
            legend: {
                data: seriesConfig.map(s => s.name), // ä»é…ç½®ä¸­è·å– legend data
                top: '8%',
                textStyle: {
                    fontSize: 12
                },
                type: 'scroll',
                orient: 'horizontal',
                width: '80%'
            },
            xAxis: {
                type: 'category',
                data: categories,
                boundaryGap: false,
                axisLabel: {
                    interval: 0,
                    rotate: 45, // è°ƒæ•´ä¸º45åº¦è§’
                    fontSize: 12,
                    color: '#333'
                },
                axisLine: {
                    lineStyle: {
                        color: '#aaa'
                    }
                }
            },
            yAxis: {
                type: 'value',
                name: 'æ¶¨è·Œå¹… (%)',
                axisLabel: {
                    formatter: '{value} %',
                    fontSize: 12,
                    color: '#333'
                },
                splitLine: {
                    lineStyle: {
                        color: '#eee'
                    }
                },
                axisLine: {
                    lineStyle: {
                        color: '#aaa'
                    }
                }
            },
            dataZoom: [
                {
                    type: 'inside',
                    start: 0,
                    end: 100
                },
                {
                    start: 0,
                    end: 100
                }
            ],
            series: seriesConfig.map(s => ({ // å¾ªç¯ç”Ÿæˆ series
                name: s.name,
                type: 'line',
                // å…³é”®ï¼šå°†åŸå§‹çš„ dm å’Œ name å­˜å‚¨åœ¨æ¯ä¸ªæ•°æ®é¡¹ä¸­
                data: dataList.map(item => ({
                    value: item[s.field],
                    dm: item.dm, // å­˜å‚¨å“ç§ä»£ç 
                    name: item.name // å­˜å‚¨å“ç§åç§°
                })),
                itemStyle: {
                    color: s.color
                },
                lineStyle: { width: 2 },
                smooth: true
            }))
        };

        chart4.setOption(option);
        
        // ä¸º chart4 æ·»åŠ ç‚¹å‡»äº‹ä»¶
        chart4.off('click'); // å…ˆç§»é™¤ä¹‹å‰çš„ç‚¹å‡»äº‹ä»¶ï¼Œé¿å…å¤šæ¬¡ç»‘å®š
        chart4.on('click', function (params) {
            // ç¡®ä¿ç‚¹å‡»çš„æ˜¯æœ‰æ•ˆçš„æ•°æ®ç‚¹
            if (params.data && params.data.dm) {
                const dm = params.data.dm; 
                const codeWithoutNumbers = stripNumbers(dm);
                
                // æ„å»ºURL
                const url = 'https://wealth.want.biz/pages/longshort.html?variety=' + codeWithoutNumbers;
                
                // åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€é“¾æ¥
                window.open(url, '_blank');
            }
        });
    }

    // ç»˜åˆ¶ç¬¬äº”ä¸ªå›¾è¡¨: æœŸè´§å“ç§æŒ‡æ ‡å¯¹æ¯”
    function renderChart5(dataList, metric1, metric2) {
        // å¯¹ä¼ å…¥çš„ dataList è¿›è¡Œæ’åº
        dataList.sort((a, b) => b[metric1] - a[metric1]);
        const categories = dataList.map(item => item.name);
        
        const option = {
            title: {
                text: `æœŸè´§å“ç§${fieldMapping[metric1]}ä¸${fieldMapping[metric2]}å¯¹æ¯”`,
                left: 'center',
                textStyle: {
                    fontSize: 18,
                    color: '#333'
                }
            },
            backgroundColor: '#EAECEDFF',
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'shadow'
                },
                formatter: function (params) {
                    let tooltipText = params[0].name;
                    params.forEach(param => {
                        tooltipText += `<br/>${param.marker}${param.seriesName}: ${param.value.toFixed(2)}`; // æ ¼å¼åŒ– tooltip ä¸­çš„æ•°å€¼
                    });
                    return tooltipText;
                }
            },
            legend: {
                data: [fieldMapping[metric1], fieldMapping[metric2]],
                top: '8%',
                textStyle: {
                    fontSize: 12
                }
            },
            xAxis: {
                type: 'category',
                data: categories,
                axisLabel: {
                    interval: 0,
                    rotate: 45, // è°ƒæ•´ä¸º45åº¦è§’
                    fontSize: 12,
                    color: '#333'
                },
                axisLine: {
                    lineStyle: {
                        color: '#aaa'
                    }
                }
            },
            yAxis: [
                {
                    type: 'value',
                    name: fieldMapping[metric1],
                    position: 'left',
                    axisLabel: {
                        fontSize: 12,
                        color: '#333'
                    },
                    splitLine: {
                        lineStyle: {
                            color: '#eee'
                        }
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#aaa'
                        }
                    }
                },
                {
                    type: 'value',
                    name: fieldMapping[metric2],
                    position: 'right',
                    axisLabel: {
                        formatter: '{value} %', // å‡è®¾ metric2 éƒ½æ˜¯æ¶¨è·Œå¹…ç›¸å…³çš„ç™¾åˆ†æ¯”
                        fontSize: 12,
                        color: '#333'
                    },
                    splitLine: {
                        show: false
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#aaa'
                        }
                    }
                }
            ],
            dataZoom: [
                {
                    type: 'inside',
                    start: 0,
                    end: 100
                },
                {
                    start: 0,
                    end: 100
                }
            ],
            series: [
                {
                    name: fieldMapping[metric1],
                    type: 'bar',
                    yAxisIndex: 0,
                    itemStyle: {
                        color: '#42A5F5'
                    },
                    barWidth: '45%',
                    // å…³é”®ï¼šå°†åŸå§‹çš„ dm å’Œ name å­˜å‚¨åœ¨æ¯ä¸ªæ•°æ®é¡¹ä¸­
                    data: dataList.map(item => ({
                        value: item[metric1], // å€¼ä¿æŒä¸ºåŸå§‹æ•°å­—ç±»å‹ï¼Œtooltipä¸­æ ¼å¼åŒ–
                        dm: item.dm,
                        name: item.name
                    }))
                },
                {
                    name: fieldMapping[metric2],
                    type: 'line',
                    yAxisIndex: 1,
                    itemStyle: {
                        color: '#FF7043'
                    },
                    lineStyle: {
                        width: 2
                    },
                    smooth: true,
                    // åŒæ ·ï¼Œçº¿å›¾æ•°æ®ä¹Ÿå­˜å‚¨ dm
                    data: dataList.map(item => ({
                        value: item[metric2],
                        dm: item.dm,
                        name: item.name
                    }))
                }
            ]
        };

        chart5.setOption(option);

        // ä¸º chart5 æ·»åŠ ç‚¹å‡»äº‹ä»¶
        chart5.off('click'); // å…ˆç§»é™¤ä¹‹å‰çš„ç‚¹å‡»äº‹ä»¶ï¼Œé¿å…å¤šæ¬¡ç»‘å®š
        chart5.on('click', function (params) {
            // ç¡®ä¿ç‚¹å‡»çš„æ˜¯æœ‰æ•ˆçš„æ•°æ®ç‚¹
            if (params.data && params.data.dm) {
                const dm = params.data.dm; 
                const codeWithoutNumbers = stripNumbers(dm);
                
                // æ„å»ºURL
                const url = 'https://wealth.want.biz/pages/longshort.html?variety=' + codeWithoutNumbers;
                
                // åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€é“¾æ¥
                window.open(url, '_blank');
            }
        });
    }

    // ä¸ºæ¯ä¸ªå›¾è¡¨æ·»åŠ ä¸‹è½½åŠŸèƒ½çš„äº‹ä»¶ç›‘å¬å™¨
    document.getElementById('download-btn1').addEventListener('click', () => {
        downloadChart(chart1, 'æœŸè´§å“ç§èµ°åŠ¿å¯¹æ¯”.png');
    });

    document.getElementById('download-btn2').addEventListener('click', () => {
        downloadChart(chart2, 'æŠ•æœºåº¦ä¸æ¶¨å¹…å¯¹æ¯”.png');
    });

    document.getElementById('download-btn3').addEventListener('click', () => {
        downloadChart(chart3, 'å¢ä»“ç‡ä¸æ¶¨è·Œå¹…å¯¹æ¯”.png');
    });

    document.getElementById('download-btn4').addEventListener('click', () => {
        downloadChart(chart4, 'å„å‘¨æœŸæ¶¨è·Œå¹…åº¦å¯¹æ¯”.png');
    });

    // ä¸‹è½½å›¾è¡¨å‡½æ•°
    function downloadChart(chartInstance, fileName) {
        const url = chartInstance.getDataURL({
            backgroundColor: '#EAECEDFF', // è®¾ç½®èƒŒæ™¯é¢œè‰²ï¼Œç¡®ä¿ä¸‹è½½çš„å›¾ç‰‡èƒŒæ™¯æ˜¯ç™½è‰²
            pixelRatio: 2 // æé«˜åˆ†è¾¨ç‡ï¼Œè®©å›¾ç‰‡æ›´æ¸…æ™°
        });
        const link = document.createElement('a');
        link.href = url;
        link.download = fileName;
        link.click();
    }

    // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®å¹¶ç»˜åˆ¶å›¾è¡¨
    fetchData();

    // çª—å£å¤§å°æ”¹å˜æ—¶ï¼Œé‡ç½®å›¾è¡¨å¤§å°
    window.addEventListener('resize', () => {
        chart1.resize();
        chart2.resize();
        chart3.resize();
        chart4.resize();
        chart5.resize();
    });


    // åœ¨éäº¤æ˜“æ—¶æ®µï¼Œä¸æ›´æ–°ï¼Œåœ¨äº¤æ˜“æ—¶æ®µï¼Œæ¯15ç§’æ›´æ–°ä¸€æ¬¡æ•°æ®
    setInterval(() => {
        const now = new Date();
        const hour = now.getHours();
        const minute = now.getMinutes();
        
        // å®Œå–„çš„æœŸè´§äº¤æ˜“æ—¶æ®µåˆ¤æ–­ (ç¤ºä¾‹ï¼Œè¯·æ ¹æ®å®é™…äº¤æ˜“æ‰€è§„åˆ™è°ƒæ•´)
        let isTradingTime = false;
        // æ—¥ç›˜ï¼š09:00 - 10:15 (ç¬¬ä¸€èŠ‚)
        if ((hour === 9 && minute >= 0) || (hour === 10 && minute < 15)) {
            isTradingTime = true;
        }
        // æ—¥ç›˜ï¼š10:30 - 11:30 (ç¬¬äºŒèŠ‚)
        if ((hour === 10 && minute >= 30) || (hour === 11 && minute < 30)) {
            isTradingTime = true;
        }
        // æ—¥ç›˜ï¼š13:30 - 15:00 (ç¬¬ä¸‰èŠ‚)
        if ((hour === 13 && minute >= 30) || (hour === 14 && minute < 60)) { // 14ç‚¹59åˆ†59ç§’ä¹Ÿç®—åœ¨å†…
            isTradingTime = true;
        }
        // å¤œç›˜ï¼š21:00 - æ¬¡æ—¥02:30 (éƒ¨åˆ†å“ç§)
        // éœ€æ ¹æ®å…·ä½“å“ç§çš„å¤œç›˜æ—¶é—´è°ƒæ•´ï¼Œè¿™é‡Œæ˜¯æ™®éçš„å¤œç›˜å¼€å§‹å’Œç»“æŸæ—¶é—´
        if ((hour >= 21 && hour <= 23) || (hour >= 0 && hour < 2) || (hour === 2 && minute <= 30)) {
             isTradingTime = true;
        }

        if (isTradingTime) {
            fetchData();
            // è·å–å½“å‰æ—¶é—´
            const currentTime = new Date().toLocaleTimeString();

            // åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºå½“å‰æ—¶é—´
            document.getElementById('current-time').textContent = `ğŸ—æœŸè´§å“ç§å®æ—¶ç›‘æ§ğŸ—(${currentTime})`;
        } else {
            document.getElementById('current-time').textContent = `ğŸ—æœŸè´§å“ç§å®æ—¶ç›‘æ§ğŸ—(å½“å‰éäº¤æ˜“æ—¶æ®µï¼Œä¸åˆ·æ–°)`;
        }
    }, 15000); // 15ç§’åˆ·æ–°ä¸€æ¬¡
</script>
</body>
</html>