<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶ç›‘æ§</title>
    
    <!-- å¼•å…¥ ECharts è„šæœ¬åº“ï¼Œç”¨äºå›¾è¡¨ç»˜åˆ¶ -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    
    <style>
        /* ==============================================
           CSSå˜é‡å®šä¹‰ - ç»Ÿä¸€çš„é¢œè‰²è°ƒè‰²æ¿
           ä½¿ç”¨CSSè‡ªå®šä¹‰å±æ€§ï¼Œä¾¿äºå…¨å±€ç®¡ç†å’Œä¸»é¢˜åˆ‡æ¢
           ============================================== */
        :root {
          /* èƒŒæ™¯è‰²ç³» - ç”¨äºé¡µé¢å’Œå¡ç‰‡çš„èƒŒæ™¯æ¸å˜ */
          --bg-start:       #f0f4f8;    /* æ¸å˜èµ·å§‹è‰² - æµ…ç°è“ */
          --bg-end:         #e3eefc;    /* æ¸å˜ç»“æŸè‰² - æ›´æµ…çš„è“è‰² */
          --card-bg:        rgba(255, 255, 255, 0.9); /* å¡ç‰‡èƒŒæ™¯ - åŠé€æ˜ç™½è‰² */
          --border-light:   rgba(255, 255, 255, 0.5); /* è¾¹æ¡†é¢œè‰² - åŠé€æ˜ç™½è¾¹æ¡† */
      
          /* ä¸»è‰²è°ƒ (è“è‰²ç³») - ç”¨äºä¸»è¦çš„äº¤äº’å…ƒç´  */
          --primary:        #1976D2;    /* ä¸»è“è‰² */
          --primary-dark:   #1565C0;    /* æ·±è“è‰² - ç”¨äºhoverçŠ¶æ€ */
          --primary-light:  #bbdefb;    /* æµ…è“è‰² - ç”¨äºèƒŒæ™¯ */
          --primary-shadow: rgba(25, 118, 210, 0.3); /* è“è‰²é˜´å½± */
      
          /* æ¬¡è¦è‰²è°ƒ (ç¥ç€è‰²ç³») - ç”¨äºè­¦å‘Šå’Œæ¬¡è¦æŒ‰é’® */
          --secondary:        #FFC107;  /* ç¥ç€è‰² */
          --secondary-dark:   #FFA000;  /* æ·±ç¥ç€è‰² */
          --secondary-shadow: rgba(255, 193, 7, 0.3); /* ç¥ç€è‰²é˜´å½± */
      
          /* æˆåŠŸè‰²è°ƒ (ç»¿è‰²ç³») - ç”¨äºæˆåŠŸçŠ¶æ€å’Œä¸‹è·Œæ•°æ® */
          --success:        #388E3C;    /* æˆåŠŸç»¿ */
          --success-light:  #C8E6C9;    /* æµ…æˆåŠŸç»¿ */
          --success-shadow: rgba(56, 142, 60, 0.3); /* ç»¿è‰²é˜´å½± */
      
          /* å±é™©è‰²è°ƒ (çº¢è‰²ç³») - ç”¨äºé”™è¯¯çŠ¶æ€å’Œä¸Šæ¶¨æ•°æ® */
          --danger:         #D32F2F;    /* å±é™©çº¢ */
          --danger-light:   #FFCDD2;    /* æµ…å±é™©çº¢ */
          --danger-shadow:  rgba(211, 47, 47, 0.3); /* çº¢è‰²é˜´å½± */
      
          /* ä¿¡æ¯è‰²è°ƒ (é’è‰²ç³») - ç”¨äºä¿¡æ¯æç¤º */
          --info:           #0288D1;    /* ä¿¡æ¯é’ */
          --info-dark:      #0277BD;    /* æ·±ä¿¡æ¯é’ */
          --info-shadow:    rgba(2, 136, 209, 0.3); /* é’è‰²é˜´å½± */
      
          /* æ–‡å­—å’Œé˜´å½± */
          --text:           #333;       /* ä¸»è¦æ–‡å­—é¢œè‰² */
          --text-dark:      #2c3e50;    /* æ·±è‰²æ–‡å­— */
          --shadow:         rgba(0, 0, 0, 0.1); /* ç»Ÿä¸€é˜´å½± */
        }
      
        /* ==============================================
           Toastæç¤ºæ ·å¼
           ============================================== */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text-dark);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--border-light);
            backdrop-filter: blur(10px);
            z-index: 9999;
            transform: translateX(120%);
            transition: transform 0.3s ease-in-out;
            max-width: 300px;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            background: var(--success-light);
            border-color: var(--success);
            color: var(--success);
        }
        
        .toast.error {
            background: var(--danger-light);
            border-color: var(--danger);
            color: var(--danger);
        }
      
        /* ==============================================
           ä¸€è¨€ç»„ä»¶æ ·å¼
           ============================================== */
        .yiyan-container {
          background: var(--card-bg);
          border: 1px solid var(--border-light);
          border-radius: 15px;
          box-shadow: 0 4px 20px var(--shadow);
          backdrop-filter: blur(10px);
          padding: 20px;
          margin-bottom: 20px;
          text-align: center;
          position: relative;
          overflow: hidden;
        }
        
        .yiyan-content {
          font-size: 1.1rem;
          line-height: 1.6;
          color: var(--text-dark);
          margin-bottom: 10px;
          position: relative;
          z-index: 2;
        }
        
        .yiyan-source {
          font-size: 0.9rem;
          color: #666;
          font-style: italic;
          position: relative;
          z-index: 2;
        }
        
        .yiyan-actions {
          display: flex;
          justify-content: center;
          gap: 15px;
          margin-top: 15px;
          position: relative;
          z-index: 2;
        }
        
        .yiyan-btn {
          padding: 5px 15px;
          background: linear-gradient(45deg, var(--primary), var(--primary-dark));
          color: white;
          border: none;
          border-radius: 15px;
          cursor: pointer;
          font-size: 0.9rem;
          transition: all 0.3s ease;
          box-shadow: 0 2px 5px var(--primary-shadow);
        }
        
        .yiyan-btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 10px var(--primary-shadow);
        }
        
        .yiyan-btn.secondary {
          background: linear-gradient(45deg, var(--secondary), var(--secondary-dark));
          box-shadow: 0 2px 5px var(--secondary-shadow);
        }
        
        .yiyan-btn.secondary:hover {
          box-shadow: 0 4px 10px var(--secondary-shadow);
        }
        
        .yiyan-loading {
          display: none;
          justify-content: center;
          align-items: center;
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(255, 255, 255, 0.7);
          z-index: 10;
          border-radius: 15px;
        }
        
        .yiyan-spinner {
          width: 30px;
          height: 30px;
          border: 3px solid #f3f3f3;
          border-top: 3px solid var(--primary);
          border-radius: 50%;
          animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        
        .yiyan-decoration {
          position: absolute;
          bottom: -20px;
          right: -20px;
          width: 100px;
          height: 100px;
          border-radius: 50%;
          background: linear-gradient(135deg, var(--primary-light), var(--primary));
          opacity: 0.1;
          z-index: 1;
        }
      
        /* ==============================================
           å…¨å±€é‡ç½®å’ŒåŸºç¡€æ ·å¼
           ç¡®ä¿æ‰€æœ‰å…ƒç´ ä½¿ç”¨border-boxï¼Œç»Ÿä¸€å¤–è¾¹è·å†…è¾¹è·
           ============================================== */
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box; /* è®©paddingå’ŒborderåŒ…å«åœ¨å…ƒç´ å®½é«˜å†… */
        }
        
        /* é¡µé¢ä¸»ä½“æ ·å¼ - è®¾ç½®æ¸å˜èƒŒæ™¯å’ŒåŸºç¡€å­—ä½“ */
        body {
          font-family: 'Microsoft YaHei', Arial, sans-serif; /* ä¼˜å…ˆä½¿ç”¨å¾®è½¯é›…é»‘ */
          background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%); /* å¯¹è§’çº¿æ¸å˜èƒŒæ™¯ */
          color: var(--text);
          min-height: 100vh; /* æœ€å°é«˜åº¦ä¸ºè§†çª—é«˜åº¦ */
          overflow-x: hidden; /* éšè—æ°´å¹³æ»šåŠ¨æ¡ */
        }
        
        /* ä¸»å®¹å™¨ - é™åˆ¶æœ€å¤§å®½åº¦å¹¶å±…ä¸­ */
        .container {
          max-width: 1400px; /* æœ€å¤§å®½åº¦1400px */
          margin: 0 auto;    /* æ°´å¹³å±…ä¸­ */
          padding: 20px;     /* å†…è¾¹è· */
        }
      
        /* ==============================================
           é¡µé¢æ ‡é¢˜æ ·å¼
           å¸¦æœ‰ç»ç’ƒæ€æ•ˆæœçš„æ ‡é¢˜æ 
           ============================================== */
        h1 {
          text-align: center;
          font-size: 1.5rem;
          color: var(--text-dark);
          margin-bottom: 10px;
          padding: 20px;
          background: var(--card-bg);               /* åŠé€æ˜èƒŒæ™¯ */
          border: 1px solid var(--border-light);   /* åŠé€æ˜è¾¹æ¡† */
          border-radius: 15px;                     /* åœ†è§’ */
          box-shadow: 0 4px 20px var(--shadow);    /* é˜´å½±æ•ˆæœ */
          text-shadow: 1px 1px 2px rgba(0,0,0,0.05); /* æ–‡å­—é˜´å½± */
          backdrop-filter: blur(10px);             /* èƒŒæ™¯æ¨¡ç³Šï¼Œç»ç’ƒæ€æ•ˆæœ */
        }
      
        /* ==============================================
           çŠ¶æ€é¢æ¿ - æ˜¾ç¤ºäº¤æ˜“çŠ¶æ€å’Œæ§åˆ¶æŒ‰é’®
           ä½¿ç”¨flexboxå¸ƒå±€ï¼Œæ”¯æŒå“åº”å¼æ¢è¡Œ
           ============================================== */
        .status-panel {
          display: flex;
          flex-wrap: wrap;           /* å…è®¸æ¢è¡Œ */
          justify-content: space-between; /* ä¸¤ç«¯å¯¹é½ */
          align-items: center;       /* å‚ç›´å±…ä¸­ */
          gap: 15px;                /* å…ƒç´ é—´è· */
          background: var(--card-bg);
          padding: 5px 20px;
          border: 1px solid var(--border-light);
          border-radius: 15px;
          box-shadow: 0 4px 20px var(--shadow);
          backdrop-filter: blur(10px); /* ç»ç’ƒæ€æ•ˆæœ */
          margin-bottom: 20px;
          position: relative;
          z-index: 5;               /* ç¡®ä¿åœ¨å…¶ä»–å…ƒç´ ä¹‹ä¸Š */
        }
        
        /* çŠ¶æ€é¢æ¿å·¦å³ä¸¤ä¾§çš„å®¹å™¨ */
        .status-left,
        .status-right {
          display: flex;
          align-items: center;
          gap: 10px;
        }
        
        /* çŠ¶æ€æ–‡æœ¬æ ·å¼ */
        .status-text {
          font-size: 1.1rem;
          font-weight: 500;
          color: var(--text-dark);
        }
        
        /* äº¤æ˜“çŠ¶æ€æŒ‡ç¤ºå™¨ - æ˜¾ç¤ºå½“å‰æ˜¯å¦åœ¨äº¤æ˜“æ—¶é—´ */
        .trading-status {
          display: inline-flex;
          align-items: center;
          gap: 8px;
          padding: 5px 15px;
          border-radius: 20px;      /* èƒ¶å›Šå½¢çŠ¶ */
          font-size: 0.9rem;
          font-weight: 500;
        }
        
        /* äº¤æ˜“æ´»è·ƒçŠ¶æ€ - ç»¿è‰²èƒŒæ™¯ */
        .trading-status.active {
          background: var(--success-light);
          color: var(--success);
          border: 1px solid var(--success);
        }
        
        /* äº¤æ˜“éæ´»è·ƒçŠ¶æ€ - çº¢è‰²èƒŒæ™¯ */
        .trading-status.inactive {
          background: var(--danger-light);
          color: var(--danger);
          border: 1px solid var(--danger-light);
        }
      
        /* ==============================================
           èœå•ç³»ç»Ÿ - ä¸‹æ‹‰èœå•å®¹å™¨å’ŒæŒ‰é’®
           åŒ…å«å¤æ‚çš„å®šä½å’ŒåŠ¨ç”»æ•ˆæœ
           ============================================== */
        .menu-container {
          position: relative;
          z-index: 100;            /* é«˜å±‚çº§ï¼Œç¡®ä¿èœå•åœ¨æœ€ä¸Šå±‚ */
        }
        
        /* èœå•è§¦å‘æŒ‰é’® */
        .menu-btn {
          display: inline-flex;
          align-items: center;
          gap: 8px;
          padding: 5px 10px;
          background: linear-gradient(45deg, var(--primary), var(--primary-dark)); /* æ¸å˜èƒŒæ™¯ */
          color: #fff;
          font-size: 14px;
          font-weight: 500;
          border: none;
          border-radius: 20px;
          cursor: pointer;
          box-shadow: 0 2px 10px var(--primary-shadow);
          transition: transform 0.3s ease, box-shadow 0.3s ease; /* å¹³æ»‘è¿‡æ¸¡åŠ¨ç”» */
        }
        
        /* èœå•æŒ‰é’®æ‚¬åœæ•ˆæœ */
        .menu-btn:hover {
          transform: translateY(-1px);              /* è½»å¾®ä¸Šç§» */
          box-shadow: 0 4px 15px var(--primary-shadow); /* å¢å¼ºé˜´å½± */
        }
        
        /* ä¸‹æ‹‰èœå•ä¸»ä½“ */
        .dropdown-menu {
          position: absolute;
          top: calc(100% + 10px);   /* ä½äºæŒ‰é’®ä¸‹æ–¹10px */
          right: 0;                 /* å³å¯¹é½ */
          min-width: 300px;
          background: var(--card-bg);
          border: 1px solid var(--border-light);
          border-radius: 10px;
          padding: 20px;
          box-shadow: 0 10px 40px var(--shadow); /* æ·±åº¦é˜´å½± */
          backdrop-filter: blur(10px);           /* èƒŒæ™¯æ¨¡ç³Š */
          opacity: 0;                            /* åˆå§‹é€æ˜ */
          transform: translateY(-10px);          /* åˆå§‹ä½ç½®ä¸Šç§» */
          transition: opacity 0.3s ease, transform 0.3s ease; /* æ˜¾ç¤ºåŠ¨ç”» */
          display: none;
          z-index: 1001;            /* ç¡®ä¿åœ¨é®ç½©å±‚ä¹‹ä¸Š */
        }
        
        /* èœå•æ˜¾ç¤ºçŠ¶æ€ */
        .dropdown-menu.show {
          display: block;
          opacity: 1;               /* å®Œå…¨ä¸é€æ˜ */
          transform: translateY(0); /* ç§»åŠ¨åˆ°æ­£ç¡®ä½ç½® */
        }
        
        /* èœå•åŒºå—å®¹å™¨ */
        .menu-section {
          margin-bottom: 20px;
        }
        .menu-section:last-child {
          margin-bottom: 0;
        }
        
        /* èœå•åŒºå—æ ‡é¢˜ */
        .menu-section-title {
          font-size: 0.95rem;
          font-weight: 600;
          color: var(--text-dark);
          margin-bottom: 10px;
          padding-bottom: 5px;
          border-bottom: 1px solid #e1e5e9; /* ä¸‹æ–¹åˆ†å‰²çº¿ */
        }
      
        /* ==============================================
           æŒ‡æ ‡é€‰æ‹©å™¨ - ç”¨äºè‡ªå®šä¹‰å›¾è¡¨æŒ‡æ ‡
           å‚ç›´æ’åˆ—çš„è¡¨å•å…ƒç´ ç»„åˆ
           ============================================== */
        .metric-selector {
          display: flex;
          flex-direction: column;
          gap: 10px;
        }
        
        /* æŒ‡æ ‡é€‰æ‹©è¡Œ - åŒ…å«æ ‡ç­¾å’Œä¸‹æ‹‰æ¡† */
        .metric-row {
          display: flex;
          align-items: center;
          gap: 10px;
        }
        
        /* æŒ‡æ ‡æ ‡ç­¾ */
        .metric-row label {
          font-weight: 500;
          color: #444;
          min-width: 70px;         /* å›ºå®šæœ€å°å®½åº¦å¯¹é½ */
          font-size: 0.9rem;
        }
        
        /* æŒ‡æ ‡ä¸‹æ‹‰é€‰æ‹©æ¡† */
        .metric-row select {
          flex: 1;                 /* å æ®å‰©ä½™ç©ºé—´ */
          padding: 8px 12px;
          border: 1px solid #ccd6e1;
          border-radius: 8px;
          background: #fff;
          font-size: 0.9rem;
          color: #333;
          appearance: none;        /* ç§»é™¤é»˜è®¤æ ·å¼ */
          /* è‡ªå®šä¹‰ä¸‹æ‹‰ç®­å¤´ */
          background-image: url('data:image/svg+xml;utf8,<svg fill="%23666" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 6.05 6.879 4.636 8.293z"/></svg>');
          background-repeat: no-repeat;
          background-position: right 10px center;
          background-size: 14px;
          transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        /* ä¸‹æ‹‰æ¡†èšç„¦çŠ¶æ€ */
        .metric-row select:focus {
          border-color: var(--primary);
          box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.2); /* èšç„¦å‘å…‰æ•ˆæœ */
          outline: none;
        }
      
        /* ==============================================
           èœå•æ“ä½œæŒ‰é’®å’Œé€šç”¨æ§åˆ¶æŒ‰é’®
           ç»Ÿä¸€çš„æŒ‰é’®æ ·å¼ï¼Œæ”¯æŒä¸åŒçš„ä¸»é¢˜è‰²
           ============================================== */
        .menu-actions {
          display: flex;
          gap: 10px;
          justify-content: flex-end; /* å³å¯¹é½ */
        }
        
        /* æ§åˆ¶æŒ‰é’®åŸºç¡€æ ·å¼ */
        .control-btn {
          padding: 8px 18px;
          font-size: 13px;
          font-weight: 500;
          color: #fff;
          background: linear-gradient(45deg, var(--primary), var(--primary-dark));
          border: none;
          border-radius: 15px;
          box-shadow: 0 2px 8px var(--primary-shadow);
          cursor: pointer;
          transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        /* æŒ‰é’®æ‚¬åœæ•ˆæœ */
        .control-btn:hover {
          transform: translateY(-1px);
          box-shadow: 0 4px 12px var(--primary-shadow);
        }
        
        /* æŒ‰é’®æŒ‰ä¸‹æ•ˆæœ */
        .control-btn:active {
          transform: translateY(0);
          box-shadow: 0 1px 5px var(--primary-shadow);
        }
        
        /* æ¬¡è¦æŒ‰é’®æ ·å¼ï¼ˆä¸åŒé¢œè‰²ä¸»é¢˜ï¼‰ */
        .control-btn.secondary {
          background: linear-gradient(45deg, var(--secondary), var(--secondary-dark));
          box-shadow: 0 2px 8px var(--secondary-shadow);
        }
        .control-btn.secondary:hover {
          box-shadow: 0 4px 12px var(--secondary-shadow);
        }
      
        /* ==============================================
           å›¾è¡¨ç½‘æ ¼å¸ƒå±€å’Œå®¹å™¨
           å“åº”å¼ç½‘æ ¼ï¼Œè‡ªåŠ¨é€‚åº”å±å¹•å¤§å°
           ============================================== */
        .chart-grid {
          display: grid;
          /* è‡ªé€‚åº”ç½‘æ ¼ï¼šæ¯åˆ—æœ€å°600pxï¼Œæœ€å¤§1frï¼ˆç­‰åˆ†å‰©ä½™ç©ºé—´ï¼‰ */
          grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
          gap: 30px;               /* ç½‘æ ¼é—´è· */
          margin-bottom: 30px;
        }
        
        /* å›¾è¡¨å®¹å™¨ - æ¯ä¸ªå›¾è¡¨çš„åŒ…è£…å™¨ */
        .chart-container {
          position: relative;
          overflow: hidden;        /* é˜²æ­¢å†…å®¹æº¢å‡º */
          background: var(--card-bg);
          border: 1px solid var(--border-light);
          border-radius: 15px;
          padding: 20px;
          box-shadow: 0 8px 32px var(--shadow);
          backdrop-filter: blur(10px); /* ç»ç’ƒæ€æ•ˆæœ */
          transition: transform 0.3s ease, box-shadow 0.3s ease;
          z-index: 1;
        }
        
        /* å›¾è¡¨å®¹å™¨æ‚¬åœæ•ˆæœ */
        .chart-container:hover {
          transform: translateY(-5px);              /* ä¸Šç§» */
          box-shadow: 0 12px 40px var(--shadow);    /* å¢å¼ºé˜´å½± */
        }
        
        /* å›¾è¡¨ä¸»ä½“åŒºåŸŸ */
        .chart {
          width: 100%;
          height: 400px;          /* å›ºå®šé«˜åº¦ */
        }
        
        /* å›¾è¡¨æ ‡é¢˜ */
        .chart-title {
          text-align: center;
          font-size: 1.3rem;
          font-weight: 600;
          color: var(--text-dark);
          margin-bottom: 15px;
          padding-bottom: 10px;
          border-bottom: 2px solid #e1e5e9; /* ä¸‹è¾¹æ¡†åˆ†å‰²çº¿ */
        }
      
        /* ==============================================
           å›¾è¡¨åŠŸèƒ½æŒ‰é’® - ä¸‹è½½å’Œå…¨å±
           æ‚¬æµ®åœ¨å›¾è¡¨å³ä¸Šè§’çš„åŠŸèƒ½æŒ‰é’®
           ============================================== */
        .download-btn,
        .fullscreen-btn {
          position: absolute;
          top: 15px;
          padding: 6px 12px;
          font-size: 12px;
          color: #fff;
          border: none;
          border-radius: 15px;
          display: flex;
          align-items: center;
          gap: 4px;
          cursor: pointer;
          transition: transform 0.3s ease, box-shadow 0.3s ease;
          z-index: 10;            /* ç¡®ä¿åœ¨å›¾è¡¨ä¹‹ä¸Š */
        }
        
        /* ä¸‹è½½æŒ‰é’®ä½ç½®å’Œæ ·å¼ */
        .download-btn {
          right: 15px;
          background: linear-gradient(45deg, var(--success), var(--success-light));
          box-shadow: 0 2px 8px var(--success-shadow);
        }
        .download-btn:hover {
          transform: scale(1.05);  /* è½»å¾®æ”¾å¤§ */
          box-shadow: 0 4px 12px var(--success-shadow);
        }
        
        /* å…¨å±æŒ‰é’®ä½ç½®å’Œæ ·å¼ */
        .fullscreen-btn {
          right: 85px;             /* ä½äºä¸‹è½½æŒ‰é’®å·¦ä¾§ */
          background: linear-gradient(45deg, var(--info), var(--info-dark));
          box-shadow: 0 2px 8px var(--info-shadow);
        }
        .fullscreen-btn:hover {
          transform: scale(1.05);
          box-shadow: 0 4px 12px var(--info-shadow);
        }
      
        /* ==============================================
           å…¨å±æ¨¡å¼æ ·å¼
           å½“å›¾è¡¨è¿›å…¥å…¨å±æ¨¡å¼æ—¶çš„ç‰¹æ®Šæ ·å¼
           ============================================== */
        .chart-container:fullscreen {
          position: fixed !important;
          top: 0; left: 0;
          width: 100vw !important;  /* å æ»¡æ•´ä¸ªè§†çª—å®½åº¦ */
          height: 100vh !important; /* å æ»¡æ•´ä¸ªè§†çª—é«˜åº¦ */
          max-width: none !important;
          max-height: none !important;
          margin: 0 !important;
          padding: 20px !important;
          border-radius: 0 !important; /* å…¨å±æ—¶æ— åœ†è§’ */
          background: #fff;
          box-shadow: none !important;
          display: flex;
          flex-direction: column;
          overflow: auto;
          z-index: 99999;          /* æœ€é«˜å±‚çº§ */
        }
        
        /* å…¨å±æ¨¡å¼ä¸‹çš„å›¾è¡¨åŒºåŸŸ */
        .chart-container:fullscreen .chart {
          height: calc(100vh - 120px) !important; /* å‡å»æ ‡é¢˜å’Œè¾¹è·çš„é«˜åº¦ */
          margin-top: 20px;
          flex: 1;                 /* å æ®å‰©ä½™ç©ºé—´ */
          width: 100% !important;
        }
        
        /* å…¨å±æ¨¡å¼ä¸‹çš„æ ‡é¢˜ */
        .chart-container:fullscreen .chart-title {
          margin-bottom: 10px;
          flex-shrink: 0;          /* ä¸æ”¶ç¼© */
        }
        
        /* å…¨å±æ¨¡å¼ä¸‹çš„æ ‘çŠ¶å›¾å›¾ä¾‹ */
        .chart-container:fullscreen .treemap-top-list {
          margin-bottom: 15px;
          flex-shrink: 0;
        }
      
        /* ==============================================
           åŠ è½½å’Œé”™è¯¯çŠ¶æ€æ ·å¼
           ç”¨äºæ˜¾ç¤ºæ•°æ®åŠ è½½å’Œé”™è¯¯ä¿¡æ¯
           ============================================== */
        .loading {
          display: none;           /* é»˜è®¤éšè— */
          justify-content: center;
          align-items: center;
          height: 200px;
          font-size: 1.2rem;
          color: #666;
        }
        
        /* åŠ è½½åŠ¨ç”»æ—‹è½¬å™¨ */
        .spinner {
          width: 40px;
          height: 40px;
          border: 4px solid #f3f3f3;        /* ç°è‰²èƒŒæ™¯ */
          border-top: 4px solid var(--primary); /* è“è‰²é¡¶éƒ¨ */
          border-radius: 50%;               /* åœ†å½¢ */
          animation: spin 1s linear infinite; /* æ—‹è½¬åŠ¨ç”» */
          margin-right: 15px;
        }
        
        /* å®šä¹‰æ—‹è½¬åŠ¨ç”» */
        @keyframes spin {
          0%   { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        
        /* é”™è¯¯æ¶ˆæ¯æ ·å¼ */
        .error-message {
          background: var(--danger-light);
          color: var(--danger);
          padding: 15px;
          border-radius: 10px;
          margin: 20px 0;
          text-align: center;
          border: 1px solid #f5c6cb;
        }
        
        /* æ— æ•°æ®æç¤ºæ ·å¼ */
        .no-data {
          text-align: center;
          color: #666;
          font-size: 1.1rem;
          padding: 40px;
        }
      
        /* ==============================================
           èœå•é®ç½©å±‚
           ç‚¹å‡»ç©ºç™½å¤„å…³é—­èœå•çš„åŠé€æ˜é®ç½©
           ============================================== */
        .menu-overlay {
          position: fixed;
          top: 0; left: 0; right: 0; bottom: 0; /* è¦†ç›–æ•´ä¸ªå±å¹• */
          background: rgba(0, 0, 0, 0.1);      /* åŠé€æ˜é»‘è‰² */
          display: none;
          z-index: 10000;         /* åœ¨èœå•æŒ‰é’®ä¹‹ä¸Šï¼Œåœ¨èœå•å†…å®¹ä¹‹ä¸‹ */
        }
        .menu-overlay.show {
          display: block;
        }
      
        /* ==============================================
           æ ‘çŠ¶å›¾é¡¶éƒ¨å›¾ä¾‹
           æ˜¾ç¤ºæ¶¨è·Œå¹…æ’è¡Œæ¦œçš„å°æ ‡ç­¾
           ============================================== */
        .treemap-top-list {
          display: flex;
          justify-content: center;
          gap: 8px;
          margin-bottom: 10px;
          font-size: 0.75rem;
          flex-wrap: wrap;         /* å…è®¸æ¢è¡Œ */
        }
        
        /* å›¾ä¾‹é¡¹ç›® */
        .treemap-top-list .item {
          display: flex;
          align-items: center;
          gap: 5px;
        }
        
        /* é¢œè‰²æŒ‡ç¤ºç‚¹ */
        .treemap-top-list .dot {
          width: 8px;
          height: 8px;
          border-radius: 50%;
        }
        .treemap-top-list .dot.red   { background-color: var(--danger); }
        .treemap-top-list .dot.green { background-color: var(--success); }
        
        /* æ•°å€¼é¢œè‰² */
        .treemap-top-list .value.red   { color: var(--danger);   font-weight: 500; }
        .treemap-top-list .value.green { color: var(--success); font-weight: 500; }
        .treemap-top-list .label       { color: #555; }
      
        /* ==============================================
           å›¾è¡¨6å’Œå›¾è¡¨7çš„æŒ‡æ ‡é€‰æ‹©å™¨
           å†…åµŒåœ¨å›¾è¡¨å†…çš„å•é€‰æŒ‰é’®ç»„
           ============================================== */
        .chart-metric-selector {
          display: flex;
          justify-content: center;
          flex-wrap: wrap;
          gap: 15px;
          margin: 10px 0;
          font-size: 0.9rem;
          color: #444;
          text-align: center;
        }
        
        /* é€‰æ‹©å™¨æ ‡ç­¾ */
        .chart-metric-selector label {
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 5px;
          font-weight: 500;
        }
        
        /* å•é€‰æŒ‰é’® */
        .chart-metric-selector input[type="radio"] {
          margin-right: 3px;
        }
        
        /* å›¾è¡¨7çš„å¤§å°å›¾ä¾‹è¯´æ˜ */
        #chart7-size-legend {
          margin-left: 20px;
          background: rgba(255,255,255,0.8);
          padding: 5px 10px;
          border-radius: 8px;
          font-size: 0.85rem;
          color: #333;
          box-shadow: 0 2px 8px var(--shadow);
          white-space: nowrap;     /* é˜²æ­¢æ¢è¡Œ */
          z-index: 9;
        }
      
        /* ==============================================
           å“åº”å¼è®¾è®¡ - ç§»åŠ¨ç«¯é€‚é… (â‰¤768px)
           é’ˆå¯¹å°å±å¹•è®¾å¤‡çš„æ ·å¼è°ƒæ•´
           ============================================== */
        @media (max-width: 768px) {
          /* å®¹å™¨é—´è·è°ƒæ•´ */
          .container { padding: 10px; }
          
          /* æ ‡é¢˜å­—ä½“ç¼©å° */
          h1 {
            font-size: 1.8rem;
            padding: 15px;
          }
          
          /* çŠ¶æ€é¢æ¿æ”¹ä¸ºå‚ç›´å¸ƒå±€ */
          .status-panel {
            flex-direction: column;
            align-items: stretch;    /* æ‹‰ä¼¸å­å…ƒç´  */
            text-align: center;
          }
          
          /* çŠ¶æ€é¢æ¿å­å…ƒç´ å±…ä¸­ */
          .status-left,
          .status-right {
            justify-content: center;
          }
          
          /* ä¸‹æ‹‰èœå•é€‚é…ç§»åŠ¨ç«¯ */
          .dropdown-menu {
            left: 0;
            right: 0;
            max-width: calc(100vw - 40px); /* ç•™å‡ºè¾¹è· */
            transform-origin: top center;
          }
          
          /* å›¾è¡¨ç½‘æ ¼æ”¹ä¸ºå•åˆ— */
          .chart-grid {
            grid-template-columns: 1fr;
            gap: 20px;
          }
          
          /* å›¾è¡¨é«˜åº¦è°ƒæ•´ */
          .chart { height: 300px; }
          
          /* æŒ‡æ ‡é€‰æ‹©å™¨æ”¹ä¸ºå‚ç›´å¸ƒå±€ */
          .metric-row {
            flex-direction: column;
            align-items: stretch;
          }
          .metric-row label {
            min-width: auto;
            text-align: left;
          }
          
          /* åŠŸèƒ½æŒ‰é’®å¤§å°è°ƒæ•´ */
          .download-btn {
            right: 10px;
            top: 10px;
            padding: 4px 8px;
            font-size: 10px;
          }
          .fullscreen-btn {
            right: 70px;
            top: 10px;
            padding: 4px 8px;
            font-size: 10px;
          }
          
          /* å›¾è¡¨æŒ‡æ ‡é€‰æ‹©å™¨ç§»åŠ¨ç«¯å¸ƒå±€ */
          .chart-metric-selector {
            flex-direction: column;
            align-items: flex-start;
            padding-left: 10px;
          }
          
          /* å›¾è¡¨7å›¾ä¾‹é€‚é… */
          #chart7-size-legend {
            margin-left: 0;
            width: 100%;
            text-align: center;
          }
        }
      </style>
</head>

<body>
    <div class="container">
        <!-- é¡µé¢ä¸»æ ‡é¢˜ï¼Œæ˜¾ç¤ºå½“å‰æ—¶é—´ -->
        <h1 id="current-time">ğŸ—æœŸè´§å“ç§å®æ—¶ç›‘æ§ğŸ—</h1>
        
        <!-- ä¸€è¨€ç»„ä»¶ -->
        <div class="yiyan-container">
            <div class="yiyan-decoration"></div>
            <div class="yiyan-loading" id="yiyan-loading">
                <div class="yiyan-spinner"></div>
            </div>
            <div class="yiyan-content" id="yiyan-content">æ­£åœ¨è·å–ä»Šæ—¥ä¸€è¨€...</div>
            <div class="yiyan-source" id="yiyan-source"></div>
            <div class="yiyan-actions">
                <button class="yiyan-btn secondary" id="yiyan-copy">å¤åˆ¶</button>
                <button class="yiyan-btn" id="yiyan-refresh">æ¢ä¸€å¥</button>
            </div>
        </div>
        
        <!-- çŠ¶æ€é¢æ¿ï¼šæ˜¾ç¤ºäº¤æ˜“çŠ¶æ€ã€æ—¶é—´å’Œæ§åˆ¶æŒ‰é’® -->
        <div class="status-panel">
            <!-- å·¦ä¾§ï¼šäº¤æ˜“çŠ¶æ€å’Œæ—¶é—´æ˜¾ç¤º -->
            <div class="status-left">
                <!-- äº¤æ˜“çŠ¶æ€æŒ‡ç¤ºå™¨ï¼Œé€šè¿‡JavaScriptåŠ¨æ€æ›´æ–° -->
                <span id="trading-status" class="trading-status"></span>
                <div class="status-text">
                     <!-- å®æ—¶æ—¶é—´æ˜¾ç¤º -->
                     <span id="current-time-display"></span>
                </div>
            </div>
            
            <!-- å³ä¾§ï¼šæ§åˆ¶æŒ‰é’®ç»„ -->
            <div class="status-right">
                <!-- æ‰‹åŠ¨åˆ·æ–°æŒ‰é’® -->
                <button id="refresh-btn" class="control-btn secondary">ğŸ”„ åˆ·æ–°</button>
                <!-- è‡ªåŠ¨åˆ·æ–°å¼€å…³æŒ‰é’® -->
                <button id="auto-refresh-btn" class="control-btn">â±ï¸ è‡ªåŠ¨åˆ·æ–°</button>
                
                <!-- è®¾ç½®èœå•å®¹å™¨ -->
                <div class="menu-container" id="menu-container">
                    <!-- è®¾ç½®èœå•è§¦å‘æŒ‰é’® -->
                    <button id="menu-btn" class="menu-btn">
                        âš™ï¸ è®¾ç½®
                        <span id="menu-arrow">â–¼</span>
                    </button>
                    
                    <!-- èœå•é®ç½©å±‚ï¼Œç‚¹å‡»å…³é—­èœå• -->
                    <div class="menu-overlay" id="menu-overlay"></div>
                    
                    <!-- ä¸‹æ‹‰èœå•ä¸»ä½“ -->
                    <div class="dropdown-menu" id="dropdown-menu">
                        <!-- è‡ªå®šä¹‰æŒ‡æ ‡è®¾ç½®åŒºå— -->
                        <div class="menu-section">
                            <div class="menu-section-title">ğŸ“Š è‡ªå®šä¹‰æŒ‡æ ‡è®¾ç½®</div>
                            <div class="metric-selector">
                                <!-- ç¬¬ä¸€ä¸ªæŒ‡æ ‡é€‰æ‹© -->
                                <div class="metric-row">
                                    <label for="metric1-select">æŒ‡æ ‡1:</label>
                                    <select id="metric1-select">
                                        <option value="cje">æˆäº¤é¢</option>
                                        <option value="vol">æˆäº¤é‡</option>
                                        <option value="tjd">æŠ•æœºåº¦</option>
                                        <option value="ccl">æŒä»“é‡</option>
                                        <option value="cdzj">æ²‰æ·€èµ„é‡‘</option>
                                        <option value="zf">æŒ¯å¹…</option>
                                        <option value="lb">é‡æ¯”</option>
                                        <option value="zdf" selected>æ¶¨è·Œå¹…</option>
                                    </select>
                                </div>
                                <!-- ç¬¬äºŒä¸ªæŒ‡æ ‡é€‰æ‹© -->
                                <div class="metric-row">
                                    <label for="metric2-select">æŒ‡æ ‡2:</label>
                                    <select id="metric2-select">
                                        <option value="zdf">æ¶¨è·Œå¹…</option>
                                        <option value="zdf3">3æ—¥æ¶¨å¹…</option>
                                        <option value="zdf5">5æ—¥æ¶¨å¹…</option>
                                        <option value="zdf20">20æ—¥æ¶¨å¹…</option>
                                        <option value="zdfly">ä»Šå¹´æ¶¨å¹…</option>
                                        <option value="zdf250">250æ—¥æ¶¨å¹…</option>
                                        <option value="zdflm">æœ¬æœˆæ¶¨å¹…</option>
                                        <option value="tjd" selected>æŠ•æœºåº¦</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- èœå•æ“ä½œæŒ‰é’® -->
                        <div class="menu-section">
                            <div class="menu-actions">
                                <!-- åº”ç”¨è®¾ç½®æŒ‰é’® -->
                                <button id="apply-metrics-btn" class="control-btn">ğŸ“Š åº”ç”¨æŒ‡æ ‡</button>
                                <!-- å…³é—­èœå•æŒ‰é’® -->
                                <button id="close-menu-btn" class="control-btn secondary">âœ–ï¸ å…³é—­</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- åŠ è½½çŠ¶æ€æç¤º -->
        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <span>åˆ«ç€æ€¥ï¼Œæ•°æ®é©¬ä¸Šå°±æ›´æ–°...</span>
        </div>
        
        <!-- é”™è¯¯ä¿¡æ¯å®¹å™¨ -->
        <div id="error-container"></div>
        
        <!-- å›¾è¡¨ç½‘æ ¼å®¹å™¨ - åŒ…å«æ‰€æœ‰8ä¸ªå›¾è¡¨ -->
        <div class="chart-grid" id="charts-container">
            
            <!-- å›¾è¡¨6ï¼šå“ç§æ¶¨è·Œå›¾ï¼ˆæ ‘çŠ¶å›¾ï¼‰ -->
            <div class="chart-container" data-chart-var="chart6">
                <div class="chart-title">å“ç§æ¶¨è·Œå›¾</div>
                <!-- å›¾è¡¨6çš„æŒ‡æ ‡é€‰æ‹©å™¨ - é€‰æ‹©æ ‘çŠ¶å›¾é¢ç§¯ä»£è¡¨çš„æŒ‡æ ‡ -->
                <div class="chart-metric-selector" id="chart6-metric-selector">
                    <label>é¢ç§¯ä»£è¡¨: </label>
                    <label>
                        <input type="radio" name="chart6-metric" value="cje" checked> æˆäº¤é¢
                    </label>
                    <label>
                        <input type="radio" name="chart6-metric" value="cdzj"> æ²‰æ·€èµ„é‡‘
                    </label>
                    <label>
                        <input type="radio" name="chart6-metric" value="oiAnalysis"> æŒä»“é‡
                    </label>
                    <label>
                        <input type="radio" name="chart6-metric" value="volumeAnalysis"> æˆäº¤é‡
                    </label>
                </div>
                <!-- æ ‘çŠ¶å›¾é¡¶éƒ¨å›¾ä¾‹ - æ˜¾ç¤ºæ¶¨è·Œå¹…æ’è¡Œ -->
                <div id="main6-treemap-legend" class="treemap-top-list"></div>
                <!-- å›¾è¡¨ä¸»ä½“åŒºåŸŸ -->
                <div id="main6" class="chart"></div>
                <!-- åŠŸèƒ½æŒ‰é’® -->
                <button class="download-btn" onclick="downloadChart(chart6, 'å“ç§æ¶¨è·Œå›¾.png')">ğŸ“¥ ä¸‹è½½</button>
                <button class="fullscreen-btn">å…¨å±</button>
            </div>
            
            <!-- å›¾è¡¨1ï¼šæœŸè´§å“ç§èµ°åŠ¿å¯¹æ¯”ï¼ˆKçº¿å›¾ï¼‰ -->
            <div class="chart-container" data-chart-var="chart1">
                <div class="chart-title">æœŸè´§å“ç§èµ°åŠ¿å¯¹æ¯”</div>
                <div id="main1" class="chart"></div>
                <button class="download-btn" onclick="downloadChart(chart1, 'æœŸè´§å“ç§èµ°åŠ¿å¯¹æ¯”.png')">ğŸ“¥ ä¸‹è½½</button>
                <button class="fullscreen-btn">å…¨å±</button>
            </div>
            
            <!-- å›¾è¡¨7ï¼šæ¶¨è·Œå¹…ä¸å¢ä»“æ¯”å…³ç³»å›¾ï¼ˆæ•£ç‚¹å›¾ï¼‰ -->
            <div class="chart-container" data-chart-var="chart7">
                <div class="chart-title">æ¶¨è·Œå¹…ä¸å¢ä»“æ¯”å…³ç³»å›¾</div>
                <!-- å›¾è¡¨7çš„æŒ‡æ ‡é€‰æ‹©å™¨ - é€‰æ‹©æ°”æ³¡å¤§å°ä»£è¡¨çš„æŒ‡æ ‡ -->
                <div class="chart-metric-selector" id="chart7-metric-selector">
                    <label>æ°”æ³¡å¤§å°ä»£è¡¨: </label>
                    <label>
                        <input type="radio" name="chart7-size-metric" value="cdzj" checked> æ²‰æ·€èµ„é‡‘
                    </label>
                    <label>
                        <input type="radio" name="chart7-size-metric" value="cje"> æˆäº¤é¢
                    </label>
                    <label>
                        <input type="radio" name="chart7-size-metric" value="vol"> æˆäº¤é‡
                    </label>
                    <label>
                        <input type="radio" name="chart7-size-metric" value="ccl"> æŒä»“é‡
                    </label>
                </div>
                <div id="main7" class="chart"></div>
                <button class="download-btn" onclick="downloadChart(chart7, 'æ¶¨è·Œå¹…ä¸å¢ä»“æ¯”å…³ç³»å›¾.png')">ğŸ“¥ ä¸‹è½½</button>
                <button class="fullscreen-btn">å…¨å±</button>
            </div>
            
            <!-- å›¾è¡¨8ï¼šå“ç§æ¶¨è·Œå¹…åŒºé—´ç»Ÿè®¡ï¼ˆé¥¼å›¾ï¼‰ -->
            <div class="chart-container" data-chart-var="chart8">
                <div class="chart-title">å“ç§æ¶¨è·Œå¹…åŒºé—´ç»Ÿè®¡</div>
                <div id="main8" class="chart"></div>
                <button class="download-btn" onclick="downloadChart(chart8, 'å“ç§æ¶¨è·Œå¹…åŒºé—´ç»Ÿè®¡.png')">ğŸ“¥ ä¸‹è½½</button>
                <button class="fullscreen-btn">å…¨å±</button>
            </div>
            
            <!-- å›¾è¡¨2ï¼šæŠ•æœºåº¦ä¸æ¶¨è·Œå¹…å¯¹æ¯”ï¼ˆæŸ±çŠ¶å›¾+æŠ˜çº¿å›¾ï¼‰ -->
            <div class="chart-container" data-chart-var="chart2">
                <div class="chart-title">æŠ•æœºåº¦ä¸æ¶¨è·Œå¹…å¯¹æ¯”</div>
                <div id="main2" class="chart"></div>
                <button class="download-btn" onclick="downloadChart(chart2, 'æŠ•æœºåº¦ä¸æ¶¨è·Œå¹…å¯¹æ¯”.png')">ğŸ“¥ ä¸‹è½½</button>
                <button class="fullscreen-btn">å…¨å±</button>
            </div>
            
            <!-- å›¾è¡¨3ï¼šå¢ä»“ç‡ä¸æ¶¨è·Œå¹…å¯¹æ¯”ï¼ˆæŸ±çŠ¶å›¾+æŠ˜çº¿å›¾ï¼‰ -->
            <div class="chart-container" data-chart-var="chart3">
                <div class="chart-title">å¢ä»“ç‡ä¸æ¶¨è·Œå¹…å¯¹æ¯”</div>
                <div id="main3" class="chart"></div>
                <button class="download-btn" onclick="downloadChart(chart3, 'å¢ä»“ç‡ä¸æ¶¨è·Œå¹…å¯¹æ¯”.png')">ğŸ“¥ ä¸‹è½½</button>
                <button class="fullscreen-btn">å…¨å±</button>
            </div>
            
            <!-- å›¾è¡¨4ï¼šå„å‘¨æœŸæ¶¨è·Œå¹…å¯¹æ¯”ï¼ˆå¤šæ¡æŠ˜çº¿å›¾ï¼‰ -->
            <div class="chart-container" data-chart-var="chart4">
                <div class="chart-title">å„å‘¨æœŸæ¶¨è·Œå¹…å¯¹æ¯”</div>
                <div id="main4" class="chart"></div>
                <button class="download-btn" onclick="downloadChart(chart4, 'å„å‘¨æœŸæ¶¨è·Œå¹…å¯¹æ¯”.png')">ğŸ“¥ ä¸‹è½½</button>
                <button class="fullscreen-btn">å…¨å±</button>
            </div>
            
            <!-- å›¾è¡¨5ï¼šè‡ªå®šä¹‰æŒ‡æ ‡å¯¹æ¯”ï¼ˆæŸ±çŠ¶å›¾+æŠ˜çº¿å›¾ï¼‰ -->
            <div class="chart-container" data-chart-var="chart5">
                <div class="chart-title" id="chart5-title">è‡ªå®šä¹‰æŒ‡æ ‡å¯¹æ¯”</div>
                <div id="main5" class="chart"></div>
                <button class="download-btn" onclick="downloadChart(chart5, 'è‡ªå®šä¹‰æŒ‡æ ‡å¯¹æ¯”.png')">ğŸ“¥ ä¸‹è½½</button>
                <button class="fullscreen-btn">å…¨å±</button>
            </div>
        </div>
    </div>

<script>
// ==============================================
// å…¨å±€å˜é‡å®šä¹‰åŒº
// å­˜å‚¨å›¾è¡¨å®ä¾‹ã€çŠ¶æ€æ ‡å¿—å’Œæ•°æ®
// ==============================================

// EChartså›¾è¡¨å®ä¾‹å˜é‡ - ç®¡ç†8ä¸ªä¸åŒçš„å›¾è¡¨
let chart1,  // Kçº¿å›¾ï¼šå“ç§èµ°åŠ¿å¯¹æ¯”
    chart2,  // æŸ±çŠ¶å›¾+æŠ˜çº¿å›¾ï¼šæŠ•æœºåº¦ä¸æ¶¨è·Œå¹…å¯¹æ¯”  
    chart3,  // æŸ±çŠ¶å›¾+æŠ˜çº¿å›¾ï¼šå¢ä»“ç‡ä¸æ¶¨è·Œå¹…å¯¹æ¯”
    chart4,  // å¤šæŠ˜çº¿å›¾ï¼šå„å‘¨æœŸæ¶¨è·Œå¹…å¯¹æ¯”
    chart5,  // è‡ªå®šä¹‰å›¾ï¼šç”¨æˆ·é€‰æ‹©çš„ä¸¤ä¸ªæŒ‡æ ‡å¯¹æ¯”
    chart6,  // æ ‘çŠ¶å›¾ï¼šå“ç§æ¶¨è·Œåˆ†å¸ƒ
    chart7,  // æ•£ç‚¹å›¾ï¼šæ¶¨è·Œå¹…ä¸å¢ä»“æ¯”å…³ç³»
    chart8;  // é¥¼å›¾ï¼šæ¶¨è·Œå¹…åŒºé—´ç»Ÿè®¡

// åº”ç”¨çŠ¶æ€ç®¡ç†å˜é‡
let autoRefresh = true;        // è‡ªåŠ¨åˆ·æ–°å¼€å…³ï¼Œé»˜è®¤å¼€å¯
let refreshInterval;           // å®šæ—¶å™¨IDï¼Œç”¨äºç®¡ç†è‡ªåŠ¨åˆ·æ–°
let currentData = [];          // å½“å‰è·å–çš„åŸå§‹æ•°æ®
let chartOptions = {};         // å­˜å‚¨æ‰€æœ‰å›¾è¡¨çš„é…ç½®é€‰é¡¹

// å›¾è¡¨é…ç½®å˜é‡
let chart6Metric = 'cje';      // å›¾è¡¨6ï¼ˆæ ‘çŠ¶å›¾ï¼‰å½“å‰é€‰æ‹©çš„æŒ‡æ ‡ï¼Œé»˜è®¤ä¸ºæˆäº¤é¢
let chart7SizeMetric = 'cdzj'; // å›¾è¡¨7ï¼ˆæ•£ç‚¹å›¾ï¼‰æ°”æ³¡å¤§å°æŒ‡æ ‡ï¼Œé»˜è®¤ä¸ºæ²‰æ·€èµ„é‡‘

// ==============================================
// æ•°æ®å­—æ®µæ˜ å°„è¡¨
// å°†APIè¿”å›çš„å­—æ®µåæ˜ å°„ä¸ºä¸­æ–‡æ˜¾ç¤ºåç§°
// ==============================================
const fieldMapping = {
    // åŸºç¡€ä»·æ ¼æ•°æ®
    qrspj: 'æ˜¨æ”¶ç›˜ä»·',    zjsj: 'æ˜¨ç»“ç®—ä»·',    o: 'å¼€ç›˜ä»·',       h: 'æœ€é«˜ä»·',
    l: 'æœ€ä½ä»·',         p: 'æœ€æ–°ä»·',        j: 'å‡ä»·',         mrj: 'ä¹°å…¥ä»·',
    mcj: 'å–å‡ºä»·',       zt: 'æ¶¨åœ',         dt: 'è·Œåœ',        
    
    // æ¶¨è·Œå¹…ç›¸å…³
    zdf: 'æ¶¨è·Œå¹…',       zde: 'æ¶¨è·Œé¢',       zdf3: '3æ—¥æ¶¨å¹…',    zdf5: '5æ—¥æ¶¨å¹…',
    zdf6: '6æ—¥æ¶¨å¹…',     zdf20: '20æ—¥æ¶¨å¹…',   zdf250: '250æ—¥æ¶¨å¹…', zdfly: 'ä»Šå¹´æ¶¨å¹…',
    zdf0: 'è¿‘ä¸€å¹´æ¶¨å¹…',   zdflm: 'æœ¬æœˆæ¶¨å¹…',   
    
    // äº¤æ˜“æ•°æ®  
    vol: 'æˆäº¤é‡',       cje: 'æˆäº¤é¢',       ccl: 'æŒä»“é‡',      zccl: 'æ˜¨æŒä»“é‡',
    rz: 'æ—¥å¢ä»“',        np: 'å†…ç›˜',         wp: 'å¤–ç›˜',        cjbs: 'æˆäº¤ç¬”æ•°',
    
    // æŠ€æœ¯æŒ‡æ ‡
    tjd: 'æŠ•æœºåº¦',       zf: 'æŒ¯å¹…',         lb: 'é‡æ¯”',        cdzj: 'æ²‰æ·€èµ„é‡‘',
    
    // å…¶ä»–å­—æ®µ
    dm: 'ä»£ç ',          name: 'åˆçº¦åç§°',    ly: 'è®¡ç®—æ¥æº',     sc: 'å¸‚åœºä»£ç ',
    jyzt: 'äº¤æ˜“çŠ¶æ€',    xs: 'ç°æ‰‹',         xsfx: 'ç°æ‰‹æ–¹å‘',   
    utime: 'æ›´æ–°æ—¶é—´',   kpsj: 'å¼€ç›˜æ—¶é—´',    spsj: 'æ”¶ç›˜æ—¶é—´',   jysj: 'äº¤æ˜“æ—¶é—´'
};

// ==============================================
// é€šç”¨å›¾è¡¨æ ·å¼é…ç½®
// å®šä¹‰å›¾è¡¨åæ ‡è½´çš„ç»Ÿä¸€æ ·å¼ï¼Œç¡®ä¿è§†è§‰ä¸€è‡´æ€§
// ==============================================
const commonAxisOptions = {
    // åæ ‡è½´æ ‡ç­¾æ ·å¼
    axisLabel: {
        fontSize: 11,           // å­—ä½“å¤§å°
        color: '#444',          // å­—ä½“é¢œè‰²
        interval: 0,            // å¼ºåˆ¶æ˜¾ç¤ºæ‰€æœ‰æ ‡ç­¾
        rotate: 45              // æ ‡ç­¾æ—‹è½¬45åº¦ï¼Œé˜²æ­¢é‡å 
    },
    // åæ ‡è½´çº¿æ ·å¼
    axisLine: { 
        lineStyle: { color: '#ccc' } 
    },
    // ç½‘æ ¼çº¿æ ·å¼
    splitLine: { 
        lineStyle: { 
            color: '#f0f0f0',   // æµ…ç°è‰²
            type: 'dashed'      // è™šçº¿
        } 
    }
};

// ==============================================
// å·¥å…·å‡½æ•°åŒº
// æä¾›æ•°æ®å¤„ç†å’Œæ ¼å¼åŒ–çš„é€šç”¨åŠŸèƒ½
// ==============================================

/**
 * ä»å®Œæ•´åˆçº¦åç§°ä¸­æå–ç®€åŒ–çš„å“ç§åç§°
 * ä¾‹å¦‚ï¼š'æ²ªæ·±300è‚¡æŒ‡2506' -> 'æ²ªæ·±300è‚¡æŒ‡'
 * @param {string} fullName - å®Œæ•´çš„åˆçº¦åç§°
 * @returns {string} ç®€åŒ–åçš„å“ç§åç§°
 */
function getSimplifiedName(fullName) {
    // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…å¼€å¤´çš„éæ•°å­—å­—ç¬¦
    const match = fullName.match(/^([^\d]+)/);
    if (match && match[1]) return match[1];
    return fullName; // å¦‚æœåŒ¹é…å¤±è´¥ï¼Œè¿”å›åŸåç§°
}

/**
 * å°†æ•°å€¼æ ¼å¼åŒ–ä¸ºä»¥äº¿ä¸ºå•ä½çš„å­—ç¬¦ä¸²
 * ä¸»è¦ç”¨äºæˆäº¤é¢å’Œæ²‰æ·€èµ„é‡‘çš„æ˜¾ç¤º
 * @param {number} value - è¦æ ¼å¼åŒ–çš„æ•°å€¼
 * @returns {string} æ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²ï¼Œå¦‚'123.45äº¿'
 */
function formatCjeToBillion(value) {
    if (value === null || value === undefined) return '-';
    return (value / 1e8).toFixed(2) + 'äº¿';
}

/**
 * æ ¼å¼åŒ–æˆäº¤é‡æˆ–æŒä»“é‡ä¸ºæ˜“è¯»çš„å•ä½
 * æ”¯æŒä¸‡æ‰‹ã€äº¿æ‰‹ç­‰å•ä½è‡ªåŠ¨è½¬æ¢
 * @param {number} value - è¦æ ¼å¼åŒ–çš„æ•°å€¼
 * @returns {string} æ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²
 */
function formatVolumeOrCCL(value) {
    if (value === null || value === undefined) return '-';
    if (value >= 100000000) return (value / 100000000).toFixed(2) + 'äº¿æ‰‹';
    if (value >= 10000) return (value / 10000).toFixed(2) + 'ä¸‡æ‰‹';
    return value.toLocaleString() + 'æ‰‹';
}

// ==============================================
// ä¸€è¨€åŠŸèƒ½ç›¸å…³å‡½æ•°
// ==============================================

// å…¨å±€å˜é‡å­˜å‚¨ä¸€è¨€æ•°æ®
let currentHitokoto = "";
let currentSource = "";

// æ˜¾ç¤ºä¸€è¨€åŠ è½½çŠ¶æ€
function showYiyanLoading() {
    const loadingElement = document.getElementById('yiyan-loading');
    if (loadingElement) {
        loadingElement.style.display = 'flex';
    }
}

// éšè—ä¸€è¨€åŠ è½½çŠ¶æ€
function hideYiyanLoading() {
    const loadingElement = document.getElementById('yiyan-loading');
    if (loadingElement) {
        loadingElement.style.display = 'none';
    }
}

// è·å–ä¸€è¨€æ•°æ®
async function fetchHitokoto() {
    showYiyanLoading();
    
    try {
        const response = await fetch('https://v1.hitokoto.cn/?c=a&c=b&c=c&c=d&c=e&c=f&c=g&c=h&c=i&c=j&c=k');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data && data.hitokoto) {
            // ä¿å­˜æ•°æ®
            currentHitokoto = data.hitokoto;
            currentSource = data.from_who ? 
                `${data.from_who}ã€Š${data.from}ã€‹` : 
                data.from;
            
            // æ›´æ–°UI
            const contentElement = document.getElementById('yiyan-content');
            const sourceElement = document.getElementById('yiyan-source');
            
            if (contentElement && sourceElement) {
                contentElement.textContent = currentHitokoto;
                sourceElement.textContent = currentSource;
            }
            
            // å‘é€åˆ°å¾®ä¿¡æ¥å£
            sendToWeChat(currentHitokoto, currentSource);
        }
    } catch (error) {
        console.error('è·å–ä¸€è¨€å¤±è´¥:', error);
        const contentElement = document.getElementById('yiyan-content');
        if (contentElement) {
            contentElement.textContent = 'è·å–ä¸€è¨€å¤±è´¥ï¼Œè¯·ç‚¹å‡»åˆ·æ–°é‡è¯•';
        }
    } finally {
        hideYiyanLoading();
    }
}

// å‘é€ä¸€è¨€åˆ°å¾®ä¿¡æ¥å£
async function sendToWeChat(content, title) {
    try {
        // å°†æ¥æºä¿¡æ¯ä¹ŸåŒ…å«åœ¨å†…å®¹ä¸­
        const fullContent = `${content}\n\nâ€”â€” ${title}\n\n`;
        
        const response = await fetch('https://api.yuangs.cc/weixinpush', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                msgtype: "text",
                title: "ä¸€è¨€",
                content: fullContent,
                to_user: "@all"
            })
        });
        
        if (!response.ok) {
            console.error('å‘é€åˆ°å¾®ä¿¡æ¥å£å¤±è´¥:', response.status);
        }
    } catch (error) {
        console.error('å‘é€åˆ°å¾®ä¿¡æ¥å£é”™è¯¯:', error);
    }
}

// å¤åˆ¶ä¸€è¨€åˆ°å‰ªè´´æ¿
function copyYiyan() {
    const textToCopy = `${currentHitokoto}\n${currentSource}`;
    
    navigator.clipboard.writeText(textToCopy)
        .then(() => {
            // å¯ä»¥æ·»åŠ å¤åˆ¶æˆåŠŸçš„æç¤º
            alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        })
        .catch(err => {
            console.error('å¤åˆ¶å¤±è´¥:', err);
            alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•');
        });
}

// åˆå§‹åŒ–ä¸€è¨€åŠŸèƒ½
function initializeYiyan() {
    // è·å–DOMå…ƒç´ 
    const copyButton = document.getElementById('yiyan-copy');
    const refreshButton = document.getElementById('yiyan-refresh');
    
    // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
    if (copyButton) {
        copyButton.addEventListener('click', copyYiyan);
    }
    
    if (refreshButton) {
        refreshButton.addEventListener('click', fetchHitokoto);
    }
    
    // é¦–æ¬¡è·å–ä¸€è¨€
    fetchHitokoto();
}

// ==============================================
// é¡µé¢åˆå§‹åŒ–
// DOMåŠ è½½å®Œæˆåæ‰§è¡Œçš„åˆå§‹åŒ–æµç¨‹
// ==============================================
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();        // åˆå§‹åŒ–æ‰€æœ‰å›¾è¡¨å®ä¾‹
    initializeControls();      // åˆå§‹åŒ–æ§åˆ¶æŒ‰é’®å’Œäº‹ä»¶ç›‘å¬
    initializeMenu();          // åˆå§‹åŒ–è®¾ç½®èœå•åŠŸèƒ½
    initializeYiyan();         // åˆå§‹åŒ–ä¸€è¨€åŠŸèƒ½
    fetchData();               // é¦–æ¬¡è·å–æ•°æ®
    startAutoRefresh();        // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
    updateTimeDisplay();       // æ›´æ–°æ—¶é—´æ˜¾ç¤º
    addFullscreenListeners();  // æ·»åŠ å…¨å±åŠŸèƒ½ç›‘å¬
    
    // å¯åŠ¨æ—¶é’Ÿæ›´æ–°å®šæ—¶å™¨ï¼Œæ¯ç§’æ›´æ–°ä¸€æ¬¡æ—¶é—´æ˜¾ç¤º
    setInterval(updateTimeDisplay, 1000);
});

// ==============================================
// èœå•ç³»ç»Ÿåˆå§‹åŒ–
// è®¾ç½®ä¸‹æ‹‰èœå•çš„æ˜¾ç¤º/éšè—é€»è¾‘å’Œäº‹ä»¶å¤„ç†
// ==============================================
function initializeMenu() {
    // è·å–èœå•ç›¸å…³çš„DOMå…ƒç´ 
    const menuBtn = document.getElementById('menu-btn');           // èœå•è§¦å‘æŒ‰é’®
    const menuOverlay = document.getElementById('menu-overlay');   // èƒŒæ™¯é®ç½©å±‚
    const dropdownMenu = document.getElementById('dropdown-menu'); // ä¸‹æ‹‰èœå•å†…å®¹
    const closeMenuBtn = document.getElementById('close-menu-btn'); // å…³é—­æŒ‰é’®
    const menuArrow = document.getElementById('menu-arrow');       // ç®­å¤´æŒ‡ç¤ºå™¨

    // ç»‘å®šèœå•è§¦å‘æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    menuBtn.addEventListener('click', function(e) {
        e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢ç«‹å³è§¦å‘æ–‡æ¡£ç‚¹å‡»å…³é—­
        toggleMenu();
    });

    // ç‚¹å‡»é®ç½©å±‚å…³é—­èœå•
    menuOverlay.addEventListener('click', function() { 
        closeMenu(); 
    });

    // ç‚¹å‡»å…³é—­æŒ‰é’®å…³é—­èœå•  
    closeMenuBtn.addEventListener('click', function() { 
        closeMenu(); 
    });

    // é˜»æ­¢èœå•å†…å®¹åŒºåŸŸçš„ç‚¹å‡»äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è¯¯å…³é—­
    dropdownMenu.addEventListener('click', function(e) { 
        e.stopPropagation(); 
    });

    // æŒ‰ESCé”®å…³é—­èœå•
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeMenu();
    });

    /**
     * åˆ‡æ¢èœå•æ˜¾ç¤ºçŠ¶æ€
     * æ ¹æ®å½“å‰çŠ¶æ€å†³å®šæ˜¯æ‰“å¼€è¿˜æ˜¯å…³é—­èœå•
     */
    function toggleMenu() {
        const isOpen = dropdownMenu.classList.contains('show');
        if (isOpen) closeMenu(); 
        else openMenu();
    }

    /**
     * æ‰“å¼€èœå•
     * æ˜¾ç¤ºèœå•å†…å®¹å’ŒèƒŒæ™¯é®ç½©ï¼Œæ”¹å˜ç®­å¤´æ–¹å‘
     */
    function openMenu() {
        dropdownMenu.classList.add('show');
        menuOverlay.classList.add('show');
        menuArrow.textContent = 'â–²'; // ç®­å¤´å‘ä¸Š
    }

    /**
     * å…³é—­èœå•  
     * éšè—èœå•å†…å®¹å’ŒèƒŒæ™¯é®ç½©ï¼Œæ¢å¤ç®­å¤´æ–¹å‘
     */
    function closeMenu() {
        dropdownMenu.classList.remove('show');
        menuOverlay.classList.remove('show');
        menuArrow.textContent = 'â–¼'; // ç®­å¤´å‘ä¸‹
    }

    // ç»‘å®š"åº”ç”¨æŒ‡æ ‡"æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.getElementById('apply-metrics-btn').addEventListener('click', function() {
        applyCustomMetrics(); // åº”ç”¨è‡ªå®šä¹‰æŒ‡æ ‡è®¾ç½®
        closeMenu();          // å…³é—­èœå•
    });
}

// ==============================================
// å›¾è¡¨åˆå§‹åŒ–
// åˆ›å»ºæ‰€æœ‰EChartså®ä¾‹å¹¶è®¾ç½®å“åº”å¼è°ƒæ•´
// ==============================================
function initializeCharts() {
    // åˆå§‹åŒ–8ä¸ªå›¾è¡¨å®ä¾‹ï¼Œç»‘å®šåˆ°å¯¹åº”çš„DOMå…ƒç´ 
    chart1 = echarts.init(document.getElementById('main1')); // Kçº¿å›¾
    chart2 = echarts.init(document.getElementById('main2')); // æŠ•æœºåº¦å¯¹æ¯”å›¾  
    chart3 = echarts.init(document.getElementById('main3')); // å¢ä»“ç‡å¯¹æ¯”å›¾
    chart4 = echarts.init(document.getElementById('main4')); // å¤šå‘¨æœŸå¯¹æ¯”å›¾
    chart5 = echarts.init(document.getElementById('main5')); // è‡ªå®šä¹‰æŒ‡æ ‡å›¾
    chart6 = echarts.init(document.getElementById('main6')); // æ ‘çŠ¶å›¾
    chart7 = echarts.init(document.getElementById('main7')); // æ•£ç‚¹å›¾
    chart8 = echarts.init(document.getElementById('main8')); // é¥¼å›¾
    
    // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œè‡ªåŠ¨è°ƒæ•´æ‰€æœ‰å›¾è¡¨å°ºå¯¸
    window.addEventListener('resize', () => {
        chart1.resize(); chart2.resize(); chart3.resize(); chart4.resize(); 
        chart5.resize(); chart6.resize(); chart7.resize(); chart8.resize();
    });
    
    // è®¾ç½®è‡ªå®šä¹‰æŒ‡æ ‡çš„é»˜è®¤å€¼
    document.getElementById('metric1-select').value = 'cdzj'; // é»˜è®¤æŒ‡æ ‡1ï¼šæ²‰æ·€èµ„é‡‘
    document.getElementById('metric2-select').value = 'tjd';  // é»˜è®¤æŒ‡æ ‡2ï¼šæŠ•æœºåº¦
}

// ==============================================
// æ§åˆ¶æŒ‰é’®åˆå§‹åŒ–
// è®¾ç½®åˆ·æ–°æŒ‰é’®ã€è‡ªåŠ¨åˆ·æ–°å¼€å…³å’Œå›¾è¡¨é€‰é¡¹çš„äº‹ä»¶ç›‘å¬
// ==============================================
function initializeControls() {
    // æ‰‹åŠ¨åˆ·æ–°æŒ‰é’®
    document.getElementById('refresh-btn').addEventListener('click', fetchData);
    
    // è‡ªåŠ¨åˆ·æ–°å¼€å…³æŒ‰é’®
    document.getElementById('auto-refresh-btn').addEventListener('click', toggleAutoRefresh);
    
    // è®¾ç½®è‡ªåŠ¨åˆ·æ–°æŒ‰é’®çš„åˆå§‹çŠ¶æ€æ˜¾ç¤º
    const autoRefreshBtn = document.getElementById('auto-refresh-btn');
    if (autoRefresh) {
        autoRefreshBtn.textContent = 'â±ï¸ è‡ªåŠ¨åˆ·æ–°: å¼€å¯';
        autoRefreshBtn.classList.remove('secondary');
    } else {
        autoRefreshBtn.textContent = 'â±ï¸ è‡ªåŠ¨åˆ·æ–°: å…³é—­';
        autoRefreshBtn.classList.add('secondary');
    }

    // å›¾è¡¨6ï¼ˆæ ‘çŠ¶å›¾ï¼‰æŒ‡æ ‡é€‰æ‹©å™¨äº‹ä»¶ç›‘å¬
    const metricRadios6 = document.querySelectorAll('input[name="chart6-metric"]');
    metricRadios6.forEach(radio => {
        radio.addEventListener('change', function() {
            chart6Metric = this.value; // æ›´æ–°é€‰ä¸­çš„æŒ‡æ ‡
            if (currentData.length > 0) {
                renderChart6(currentData); // é‡æ–°æ¸²æŸ“å›¾è¡¨6
            }
        });
    });

    // å›¾è¡¨7ï¼ˆæ•£ç‚¹å›¾ï¼‰æ°”æ³¡å¤§å°æŒ‡æ ‡é€‰æ‹©å™¨äº‹ä»¶ç›‘å¬
    const metricRadios7 = document.querySelectorAll('input[name="chart7-size-metric"]');
    metricRadios7.forEach(radio => {
        radio.addEventListener('change', function() {
            chart7SizeMetric = this.value; // æ›´æ–°é€‰ä¸­çš„æŒ‡æ ‡
            if (currentData.length > 0) {
                renderChart7(currentData); // é‡æ–°æ¸²æŸ“å›¾è¡¨7
            }
        });
    });

    // è·å–å½“å‰é€‰ä¸­çš„é»˜è®¤å€¼
    const checkedRadio6 = document.querySelector('input[name="chart6-metric"]:checked');
    if (checkedRadio6) {
        chart6Metric = checkedRadio6.value;
    }
    const checkedRadio7 = document.querySelector('input[name="chart7-size-metric"]:checked');
    if (checkedRadio7) {
        chart7SizeMetric = checkedRadio7.value;
    }
}

// ==============================================
// äº¤æ˜“æ—¶æ®µåˆ¤æ–­
// æ ¹æ®å½“å‰æ—¶é—´åˆ¤æ–­æ˜¯æ—¥ç›˜ã€å¤œç›˜è¿˜æ˜¯éäº¤æ˜“æ—¶æ®µ
// ==============================================
function getSessionType(now = new Date()) {
    const hour = now.getHours();
    const minute = now.getMinutes();

    // å¤œç›˜æ—¶é—´ï¼š21:00 - æ¬¡æ—¥02:30
    if (hour >= 21 || (hour >= 0 && hour < 2) || (hour === 2 && minute <= 30)) {
        return 'night';
    }
    
    // æ—¥ç›˜æ—¶é—´ï¼š09:00 - 11:30 å’Œ 13:30 - 15:00
    if ((hour >= 9 && (hour < 11 || (hour === 11 && minute < 30))) || 
        (hour >= 13 && (hour < 15 || (hour === 15 && minute === 0)))) {
        return 'day';
    }
    
    // å…¶ä»–æ—¶é—´ä¸ºéäº¤æ˜“æ—¶æ®µ
    return 'closed';
}

// ==============================================
// æ—¶é—´æ˜¾ç¤ºæ›´æ–°
// æ›´æ–°é¡µé¢ä¸Šçš„æ—¶é—´æ˜¾ç¤ºå’Œäº¤æ˜“çŠ¶æ€æŒ‡ç¤ºå™¨
// ==============================================
function updateTimeDisplay() {
    const now = new Date();
    // æ ¼å¼åŒ–å½“å‰æ—¶é—´ä¸º HH:MM:SS æ ¼å¼
    const timeString = now.toLocaleTimeString('zh-CN', { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit' 
    });
    document.getElementById('current-time-display').textContent = timeString;

    // æ ¹æ®å½“å‰æ—¶é—´åˆ¤æ–­äº¤æ˜“çŠ¶æ€å¹¶æ›´æ–°æ˜¾ç¤º
    const sessionType = getSessionType(now);
    const statusElement = document.getElementById('trading-status');

    if (sessionType === 'day') {
        statusElement.textContent = 'â— æ—¥ç›˜äº¤æ˜“ä¸­';
        statusElement.className = 'trading-status active';   // ç»¿è‰²æ´»è·ƒçŠ¶æ€
    } else if (sessionType === 'night') {
        statusElement.textContent = 'â— å¤œç›˜äº¤æ˜“ä¸­';
        statusElement.className = 'trading-status active';   // ç»¿è‰²æ´»è·ƒçŠ¶æ€
    } else {
        statusElement.textContent = 'â— éäº¤æ˜“æ—¶æ®µ';
        statusElement.className = 'trading-status inactive'; // çº¢è‰²éæ´»è·ƒçŠ¶æ€
    }
}

// ==============================================
// APIæ¥å£é€‰æ‹©
// æ ¹æ®å½“å‰äº¤æ˜“æ—¶æ®µé€‰æ‹©ç›¸åº”çš„æ•°æ®æ¥å£
// ==============================================
function getApiUrl() {
    const sessionType = getSessionType();
    // å¤œç›˜ä½¿ç”¨ä¸“é—¨çš„å¤œç›˜æ¥å£ï¼Œå…¶ä»–æ—¶é—´ä½¿ç”¨é»˜è®¤æ¥å£
    if (sessionType === 'night') {
        return 'https://q.want.biz/night';
    }
    return 'https://q.want.biz';
}

// ==============================================
// åŠ è½½çŠ¶æ€å’Œé”™è¯¯å¤„ç†
// ç®¡ç†é¡µé¢çš„åŠ è½½æç¤ºå’Œé”™è¯¯ä¿¡æ¯æ˜¾ç¤º
// ==============================================

/**
 * æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼ˆå½“å‰å®ç°ä¸ºéšè—ï¼Œæ ¹æ®éœ€è¦å¯ä»¥ä¿®æ”¹ï¼‰
 */
function showLoading() {
    document.getElementById('loading').style.display = 'none';
}

/**
 * éšè—åŠ è½½çŠ¶æ€
 */
function hideLoading() {
    document.getElementById('loading').style.display = 'none';
}

/**
 * æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
 * @param {string} message - é”™è¯¯ä¿¡æ¯æ–‡æœ¬
 */
function showError(message) {
    const errorContainer = document.getElementById('error-container');
    errorContainer.innerHTML = `<div class="error-message">âŒ ${message}</div>`;
}

/**
 * æ¸…é™¤é”™è¯¯ä¿¡æ¯æ˜¾ç¤º
 */
function clearError() {
    document.getElementById('error-container').innerHTML = '';
}

// ==============================================
// æ•°æ®è·å–ä¸»å‡½æ•°
// ä»APIè·å–æœŸè´§æ•°æ®å¹¶è¿›è¡Œå¤„ç†å’Œæ¸²æŸ“
// ==============================================
async function fetchData() {
    showLoading();  // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    clearError();   // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯ä¿¡æ¯
    
    try {
        // è·å–æ•°æ®æ¥å£URLå¹¶å‘èµ·è¯·æ±‚
        const apiUrl = getApiUrl();
        const response = await fetch(apiUrl);
        
        // æ£€æŸ¥HTTPå“åº”çŠ¶æ€
        if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        
        // è§£æJSONæ•°æ®
        const apiData = await response.json();
        
        // éªŒè¯æ•°æ®æ ¼å¼
        if (!apiData || !apiData.list || !Array.isArray(apiData.list)) {
            throw new Error('æ•°æ®æ ¼å¼é”™è¯¯');
        }
        
        // æ•°æ®è¿‡æ»¤ï¼šåªä¿ç•™æ²‰æ·€èµ„é‡‘å¤§äº15äº¿çš„å“ç§
        let filteredData = apiData.list.filter(item => item.cdzj > 15 * 1e8); 
        if (filteredData.length === 0) {
            throw new Error('æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ•°æ® (æ²‰æ·€èµ„é‡‘ > 15äº¿)');
        }

        // äº¤æ˜“æ—¶æ®µå†…è¿›ä¸€æ­¥è¿‡æ»¤æ´»è·ƒå“ç§
        const sessionType = getSessionType();
        if (sessionType !== 'closed') {
            const hasOpenMarkets = filteredData.some(item => item.jyzt === 0);
            if (hasOpenMarkets) {
                // åªæœ‰å­˜åœ¨æ´»è·ƒå¸‚åœºæ—¶æ‰è¿‡æ»¤ï¼Œå¦åˆ™æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨æ•°æ®
                filteredData = filteredData.filter(item => item.jyzt === 0);
            }
        }
        
        // æœ€ç»ˆæ•°æ®éªŒè¯
        if (filteredData.length === 0) {
            throw new Error('å½“å‰äº¤æ˜“æ—¶æ®µå†…ï¼Œæ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ´»è·ƒå“ç§ã€‚');
        }

        // ä¿å­˜æ•°æ®å¹¶æ¸²æŸ“æ‰€æœ‰å›¾è¡¨
        currentData = filteredData;
        renderAllCharts(filteredData);
        
        // æ›´æ–°é¡µé¢æ ‡é¢˜æ˜¾ç¤ºå½“å‰æ—¶é—´
        document.getElementById('current-time').textContent = 
            `ğŸ—æœŸè´§å“ç§å®æ—¶ç›‘æ§ğŸ— (${new Date().toLocaleTimeString()})`;
            
    } catch (error) {
        console.error('æ•°æ®è·å–å¤±è´¥:', error);
        showError(`æ•°æ®è·å–å¤±è´¥: ${error.message}`);
    } finally {
        hideLoading(); // æ— è®ºæˆåŠŸå¤±è´¥éƒ½éšè—åŠ è½½çŠ¶æ€
    }
}

// ==============================================
// å›¾è¡¨æ¸²æŸ“è°ƒåº¦
// ç»Ÿä¸€è°ƒç”¨æ‰€æœ‰å›¾è¡¨çš„æ¸²æŸ“å‡½æ•°
// ==============================================
function renderAllCharts(data) {
    try {
        // æ¸²æŸ“æ‰€æœ‰å›¾è¡¨ï¼Œä¼ å…¥æ•°æ®å‰¯æœ¬ä»¥é¿å…æ„å¤–ä¿®æ”¹
        renderChart1([...data]);  // Kçº¿å›¾
        renderChart2([...data]);  // æŠ•æœºåº¦å¯¹æ¯”å›¾
        renderChart3([...data]);  // å¢ä»“ç‡å¯¹æ¯”å›¾  
        renderChart4([...data]);  // å¤šå‘¨æœŸå¯¹æ¯”å›¾
        
        // è‡ªå®šä¹‰æŒ‡æ ‡å›¾è¡¨ï¼Œä½¿ç”¨èœå•ä¸­é€‰æ‹©çš„æŒ‡æ ‡
        const metric1 = document.getElementById('metric1-select').value || 'cdzj';
        const metric2 = document.getElementById('metric2-select').value || 'tjd';
        renderChart5([...data], metric1, metric2);
        
        renderChart6([...data]);  // æ ‘çŠ¶å›¾
        renderChart7([...data]);  // æ•£ç‚¹å›¾
        renderChart8([...data]);  // é¥¼å›¾
        
    } catch (error) {
        console.error('å›¾è¡¨æ¸²æŸ“å¤±è´¥:', error);
        showError(`å›¾è¡¨æ¸²æŸ“å¤±è´¥: ${error.message}`);
    }
}

// ==============================================
// å›¾è¡¨1ï¼šæœŸè´§å“ç§èµ°åŠ¿å¯¹æ¯”ï¼ˆKçº¿å›¾ï¼‰
// å°†æ¶¨è·Œå¹…è½¬æ¢ä¸ºç›¸å¯¹æ˜¨ç»“ç®—ä»·çš„ç™¾åˆ†æ¯”å˜åŒ–ï¼Œä»¥Kçº¿å½¢å¼å±•ç¤º
// ==============================================
function renderChart1(dataList) {
    // æ•°æ®é¢„å¤„ç†ï¼šè®¡ç®—ç›¸å¯¹æ˜¨ç»“ç®—ä»·çš„ç™¾åˆ†æ¯”å˜åŒ–
    const processedData = dataList.map(item => {
        // è®¡ç®—å¼€ç›˜ä»·ã€æ”¶ç›˜ä»·ã€æœ€ä½ä»·ã€æœ€é«˜ä»·ç›¸å¯¹æ˜¨ç»“ç®—ä»·çš„æ¶¨è·Œå¹…
        const openChange = parseFloat(((item.o - item.zjsj) / item.zjsj * 100).toFixed(2));
        const closeChange = parseFloat(((item.p - item.zjsj) / item.zjsj * 100).toFixed(2));
        const lowChange = parseFloat(((item.l - item.zjsj) / item.zjsj * 100).toFixed(2));
        const highChange = parseFloat(((item.h - item.zjsj) / item.zjsj * 100).toFixed(2));
        
        return {
            name: getSimplifiedName(item.name),  // ç®€åŒ–å“ç§åç§°
            fullName: item.name,                 // å®Œæ•´å“ç§åç§°
            dm: item.dm,                         // å“ç§ä»£ç 
            value: [openChange, closeChange, lowChange, highChange], // Kçº¿æ•°æ®
            closeChange,    // æ”¶ç›˜æ¶¨è·Œå¹…
            openChange,     // å¼€ç›˜æ¶¨è·Œå¹…
            highChange,     // æœ€é«˜æ¶¨è·Œå¹…
            lowChange,      // æœ€ä½æ¶¨è·Œå¹…
            // ä¿å­˜åŸå§‹æ•°æ®ç”¨äºtooltipæ˜¾ç¤º
            rawValues: {
                open: item.o,           // å¼€ç›˜ä»·
                high: item.h,           // æœ€é«˜ä»·
                low: item.l,            // æœ€ä½ä»·
                close: item.p,          // æ”¶ç›˜ä»·
                prevClose: item.zjsj,   // æ˜¨ç»“ç®—ä»·
                volume: item.vol,       // æˆäº¤é‡
                turnover: item.cje,     // æˆäº¤é¢
                openInterest: item.ccl, // æŒä»“é‡
                depositFunds: item.cdzj,// æ²‰æ·€èµ„é‡‘
                amplitude: item.zf,     // æŒ¯å¹…
                volumeRatio: item.lb    // é‡æ¯”
            }
        };
    });

    // æŒ‰æ”¶ç›˜æ¶¨è·Œå¹…é™åºæ’åº
    const sortedData = processedData.sort((a, b) => b.closeChange - a.closeChange);
    const categories = sortedData.map(item => item.name);

    // åˆ›å»ºæ ‡è®°ç‚¹ï¼šæ ‡æ³¨æ¶¨å¹…æœ€é«˜å’Œè·Œå¹…æœ€å¤§çš„å“ç§
    const markPointData = [];
    
    // æ·»åŠ æ¶¨å¹…æœ€é«˜æ ‡è®°
    if (sortedData.length > 0) {
        const highestGainer = sortedData[0];
        if (highestGainer.closeChange > 0) {
            markPointData.push({
                name: 'æ¶¨å¹…æœ€é«˜',
                value: highestGainer.closeChange,
                coord: [0, highestGainer.value[1]], // [xè½´ç´¢å¼•, yè½´æ•°å€¼]
                itemStyle: { color: '#ef4444' }     // çº¢è‰²æ ‡è®°
            });
        }
    }
    
    // æ·»åŠ è·Œå¹…æœ€å¤§æ ‡è®°
    if (sortedData.length > 1) { 
        const biggestLoser = sortedData[sortedData.length - 1];
        if (biggestLoser.closeChange < 0) {
            markPointData.push({
                name: 'è·Œå¹…æœ€å¤§',
                value: biggestLoser.closeChange,
                coord: [sortedData.length - 1, biggestLoser.value[1]],
                itemStyle: { color: '#22c553' }     // ç»¿è‰²æ ‡è®°
            });
        }
    }

    // EChartsé…ç½®é€‰é¡¹
    const option = {
        backgroundColor: 'transparent',
        tooltip: {
            trigger: 'axis',        // åæ ‡è½´è§¦å‘
            backgroundColor: 'rgba(0,0,0,0.8)',
            borderColor: '#777',
            textStyle: { color: '#fff' },
            // è‡ªå®šä¹‰tooltipå†…å®¹æ ¼å¼
            formatter: function (params) {
                const dataPoint = params[0];
                const data = dataPoint.data;
                const raw = data.rawValues; 
                
                if (raw) {
                    // è®¡ç®—æ¶¨è·Œé¢å’Œæ¶¨è·Œå¹…
                    const changeValue = (raw.close - raw.prevClose).toFixed(2);
                    const changePercent = data.closeChange.toFixed(2);
                    const openChangePercent = data.openChange.toFixed(2);
                    const highChangePercent = data.highChange.toFixed(2);
                    const lowChangePercent = data.lowChange.toFixed(2);
                    
                    // æ ¹æ®æ¶¨è·Œè®¾ç½®é¢œè‰²
                    const color = data.closeChange >= 0 ? '#ef4444' : '#22c55e';
                    const color2 = data.highChange >= 0 ? '#ef4444' : '#22c55e';
                    const color3 = data.lowChange >= 0 ? '#ef4444' : '#22c55e';
                    const color4 = data.openChange >= 0 ? '#ef4444' : '#22c55e';
                    
                    // æ„å»ºtooltipå†…å®¹
                    return `<strong style="font-size: 16px; font-weight: bold;">${data.fullName}</strong><br/>` +
                    `æœ€æ–°ä»·: <strong style="color:${color};">${changePercent}% (${raw.close}, ${changeValue})</strong><br/>` +
                    `å¼€ç›˜ä»·: <strong style="color:${color4};">${openChangePercent}% (${raw.open}, ${(raw.open - raw.prevClose).toFixed(2)})</strong><br/>` +
                    `æœ€é«˜ä»·: <strong style="color:${color2};">${highChangePercent}% (${raw.high}, ${(raw.high - raw.prevClose).toFixed(2)})</strong><br/>` +
                    `æœ€ä½ä»·: <strong style="color:${color3};">${lowChangePercent}% (${raw.low}, ${(raw.low - raw.prevClose).toFixed(2)})</strong><br/>` ;
         }
                return data.fullName;
            }
        },
        xAxis: {
            type: 'category',
            data: categories,
            axisLabel: commonAxisOptions.axisLabel,
            axisLine: commonAxisOptions.axisLine
        },
        yAxis: {
            type: 'value',
            axisLabel: {
                formatter: '{value}%',  // æ˜¾ç¤ºç™¾åˆ†æ¯”ç¬¦å·
                fontSize: commonAxisOptions.axisLabel.fontSize,
                color: commonAxisOptions.axisLabel.color
            },
            axisLine: commonAxisOptions.axisLine,
            splitLine: commonAxisOptions.splitLine
        },
        // æ•°æ®ç¼©æ”¾ç»„ä»¶
        dataZoom: [
            { type: 'inside', start: 0, end: 100 },    // å†…ç½®ç¼©æ”¾
            { start: 0, end: 100, height: 20 }         // æ»‘å—ç¼©æ”¾
        ],
        series: [{
            type: 'candlestick',  // Kçº¿å›¾ç±»å‹
            data: sortedData, 
            itemStyle: {
                color: '#ef4444',        // é˜³çº¿é¢œè‰²ï¼ˆçº¢ï¼‰
                color0: '#22c55e',       // é˜´çº¿é¢œè‰²ï¼ˆç»¿ï¼‰
                borderColor: '#ef4444',  // é˜³çº¿è¾¹æ¡†
                borderColor0: '#22c55e'  // é˜´çº¿è¾¹æ¡†
            },
            // æ ‡è®°ç‚¹é…ç½®
            markPoint: {
                symbol: 'pin',           // å›¾é’‰æ ·å¼
                symbolSize: 40,
                tooltip: { show: false },
                label: {
                    fontSize: 10,
                    formatter: function(params) {
                        if (typeof params.value === 'number') {
                            return params.value.toFixed(2) + '%';
                        }
                        return '';
                    }
                },
                data: markPointData
            }
        }]
    };
    
    // ä¿å­˜é…ç½®å¹¶è®¾ç½®å›¾è¡¨
    chartOptions.chart1 = option;
    chart1.setOption(option);
    bindChartClick(chart1);  // ç»‘å®šç‚¹å‡»äº‹ä»¶
}

// ==============================================
// å›¾è¡¨2ï¼šæŠ•æœºåº¦ä¸æ¶¨è·Œå¹…å¯¹æ¯”
// ä½¿ç”¨æŸ±çŠ¶å›¾å±•ç¤ºæŠ•æœºåº¦ï¼ŒæŠ˜çº¿å›¾å±•ç¤ºæ¶¨è·Œå¹…
// ==============================================
function renderChart2(dataList) {
    // æŒ‰æ¶¨è·Œå¹…é™åºæ’åº
    dataList.sort((a, b) => b.zdf - a.zdf);
    const categories = dataList.map(item => getSimplifiedName(item.name));
    
    const option = {
        backgroundColor: 'transparent',
        tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(0,0,0,0.8)',
            textStyle: { color: '#fff' },
            formatter: function(params) {
                const originalName = params[0].data.fullName;
                let tooltipContent = originalName + '<br/>';
                params.forEach(function(item) {
                    tooltipContent += `${item.marker}${item.seriesName}: ${item.value}<br/>`;
                });
                return tooltipContent;
            }
        },
        legend: {
            data: ['æŠ•æœºåº¦', 'æ¶¨è·Œå¹…'],
            top: 10,
            textStyle: { color: '#333' }
        },
        xAxis: {
            type: 'category',
            data: categories,
            axisLabel: commonAxisOptions.axisLabel,
            axisLine: commonAxisOptions.axisLine
        },
        // åŒYè½´é…ç½®
        yAxis: [
            {
                type: 'value',
                name: 'æŠ•æœºåº¦',
                position: 'left',
                axisLabel: commonAxisOptions.axisLabel,
                axisLine: commonAxisOptions.axisLine,
                splitLine: commonAxisOptions.splitLine
            },
            {
                type: 'value',
                name: 'æ¶¨è·Œå¹…(%)',
                position: 'right',
                axisLabel: {
                    formatter: '{value}%',
                    fontSize: commonAxisOptions.axisLabel.fontSize,
                    color: commonAxisOptions.axisLabel.color
                },
                axisLine: commonAxisOptions.axisLine,
                splitLine: { show: false }  // å³è½´ä¸æ˜¾ç¤ºç½‘æ ¼çº¿
            }
        ],
        dataZoom: [
            { type: 'inside', start: 0, end: 100 },
            { start: 0, end: 100, height: 20 }
        ],
        series: [
            {
                name: 'æŠ•æœºåº¦',
                type: 'bar',
                yAxisIndex: 0,    // ä½¿ç”¨å·¦Yè½´
                itemStyle: { color: '#3b82f6' },
                data: dataList.map(item => ({
                    value: item.tjd,
                    dm: item.dm,
                    name: getSimplifiedName(item.name),
                    fullName: item.name
                }))
            },
            {
                name: 'æ¶¨è·Œå¹…',
                type: 'line',
                yAxisIndex: 1,    // ä½¿ç”¨å³Yè½´
                itemStyle: { color: '#ef4444' },
                data: dataList.map(item => ({
                    value: item.zdf,
                    dm: item.dm,
                    name: getSimplifiedName(item.name),
                    fullName: item.name
                }))
            }
        ]
    };
    
    chartOptions.chart2 = option;
    chart2.setOption(option);
    bindChartClick(chart2);
}

// ==============================================
// å›¾è¡¨3ï¼šå¢ä»“ç‡ä¸æ¶¨è·Œå¹…å¯¹æ¯”
// è®¡ç®—å¢ä»“ç‡å¹¶ä¸æ¶¨è·Œå¹…è¿›è¡Œå¯¹æ¯”æ˜¾ç¤º
// ==============================================
function renderChart3(dataList) {
    dataList.sort((a, b) => b.zdf - a.zdf);
    
    const option = {
        backgroundColor: 'transparent',
        tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(0,0,0,0.8)',
            textStyle: { color: '#fff' },
            formatter: function(params) {
                const originalName = params[0].data.fullName;
                let tooltipContent = originalName + '<br/>';
                params.forEach(function(item) {
                    tooltipContent += `${item.marker}${item.seriesName}: ${item.value}%<br/>`;
                });
                return tooltipContent;
            }
        },
        legend: {
            data: ['å¢ä»“ç‡', 'æ¶¨è·Œå¹…'],
            top: 10,
            textStyle: { color: '#333' }
        },
        xAxis: {
            type: 'category',
            data: dataList.map(item => getSimplifiedName(item.name)),
            axisLabel: commonAxisOptions.axisLabel,
            axisLine: commonAxisOptions.axisLine
        },
        yAxis: [
            {
                type: 'value',
                name: 'å¢ä»“ç‡(%)',
                position: 'left',
                axisLabel: {
                    formatter: '{value}%',
                    fontSize: commonAxisOptions.axisLabel.fontSize,
                    color: commonAxisOptions.axisLabel.color
                },
                axisLine: commonAxisOptions.axisLine,
                splitLine: commonAxisOptions.splitLine
            },
            {
                type: 'value',
                name: 'æ¶¨è·Œå¹…(%)',
                position: 'right',
                axisLabel: {
                    formatter: '{value}%',
                    fontSize: commonAxisOptions.axisLabel.fontSize,
                    color: commonAxisOptions.axisLabel.color
                },
                axisLine: commonAxisOptions.axisLine,
                splitLine: { show: false }
            }
        ],
        dataZoom: [
            { type: 'inside', start: 0, end: 100 },
            { start: 0, end: 100, height: 20 }
        ],
        series: [
            {
                name: 'å¢ä»“ç‡',
                type: 'bar',
                yAxisIndex: 0,
                itemStyle: { color: '#06b6d4' },
                data: dataList.map(item => {
                    // è®¡ç®—å¢ä»“ç‡ï¼šæ—¥å¢ä»“ / æ˜¨æŒä»“é‡ * 100%
                    const divisor = item.ccl - item.rz;  // æ˜¨æ—¥æŒä»“é‡
                    const rate = divisor === 0 ? 0 : parseFloat(((item.rz / divisor) * 100).toFixed(2));
                    return {
                        value: rate,
                        dm: item.dm,
                        name: getSimplifiedName(item.name),
                        fullName: item.name
                    };
                })
            },
            {
                name: 'æ¶¨è·Œå¹…',
                type: 'line',
                yAxisIndex: 1,
                itemStyle: { color: '#ef4444' },
                data: dataList.map(item => ({
                    value: item.zdf,
                    dm: item.dm,
                    name: getSimplifiedName(item.name),
                    fullName: item.name
                }))
            }
        ]
    };
    
    chartOptions.chart3 = option;
    chart3.setOption(option);
    bindChartClick(chart3);
}

// ==============================================
// å›¾è¡¨4ï¼šå„å‘¨æœŸæ¶¨è·Œå¹…å¯¹æ¯”
// æ˜¾ç¤ºä¸åŒæ—¶é—´å‘¨æœŸçš„æ¶¨è·Œå¹…å˜åŒ–è¶‹åŠ¿
// ==============================================
function renderChart4(dataList) {
    dataList.sort((a, b) => b.zdf - a.zdf);
    
    // å®šä¹‰å„ä¸ªå‘¨æœŸçš„é…ç½®
    const seriesConfig = [
        { name: 'å½“æ—¥æ¶¨å¹…', field: 'zdf', color: '#ef4444' },
        { name: '3æ—¥æ¶¨å¹…', field: 'zdf3', color: '#22c55e' },
        { name: '5æ—¥æ¶¨å¹…', field: 'zdf5', color: '#3b82f6' },
        { name: '20æ—¥æ¶¨å¹…', field: 'zdf20', color: '#a855f7' },
        { name: 'ä»Šå¹´æ¶¨å¹…', field: 'zdfly', color: '#f59e0b' },
        { name: '250æ—¥æ¶¨å¹…', field: 'zdf250', color: '#14b8a6' }
    ];
    
    const option = {
        backgroundColor: 'transparent',
        tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(0,0,0,0.8)',
            textStyle: { color: '#fff' },
            formatter: function(params) {
                const originalName = params[0].data.fullName;
                let tooltipContent = originalName + '<br/>';
                params.forEach(function(item) {
                    tooltipContent += `${item.marker}${item.seriesName}: ${item.value}%<br/>`;
                });
                return tooltipContent;
            }
        },
        legend: {
            data: seriesConfig.map(s => s.name),
            top: 10,
            type: 'scroll',      // å›¾ä¾‹è¿‡å¤šæ—¶å¯æ»šåŠ¨
            textStyle: { color: '#333' }
        },
        xAxis: {
            type: 'category',
            data: dataList.map(item => getSimplifiedName(item.name)),
            axisLabel: commonAxisOptions.axisLabel,
            axisLine: commonAxisOptions.axisLine
        },
        yAxis: {
            type: 'value',
            name: 'æ¶¨è·Œå¹…(%)',
            axisLabel: {
                formatter: '{value}%',
                fontSize: commonAxisOptions.axisLabel.fontSize,
                color: commonAxisOptions.axisLabel.color
            },
            axisLine: commonAxisOptions.axisLine,
            splitLine: commonAxisOptions.splitLine
        },
        dataZoom: [
            { type: 'inside', start: 0, end: 100 },
            { start: 0, end: 100, height: 20 }
        ],
        // æ ¹æ®é…ç½®åŠ¨æ€åˆ›å»ºå¤šæ¡æŠ˜çº¿
        series: seriesConfig.map(s => ({
            name: s.name,
            type: 'line',
            itemStyle: { color: s.color },
            data: dataList.map(item => ({
                value: item[s.field],
                dm: item.dm,
                name: getSimplifiedName(item.name),
                fullName: item.name
            })),
            smooth: true         // å¹³æ»‘æ›²çº¿
        }))
    };
    
    chartOptions.chart4 = option;
    chart4.setOption(option);
    bindChartClick(chart4);
}

// ==============================================
// å›¾è¡¨5ï¼šè‡ªå®šä¹‰æŒ‡æ ‡å¯¹æ¯”
// æ ¹æ®ç”¨æˆ·é€‰æ‹©çš„ä¸¤ä¸ªæŒ‡æ ‡è¿›è¡Œå¯¹æ¯”å±•ç¤º
// ==============================================
function renderChart5(dataList, metric1, metric2) {
    // æ•°æ®éªŒè¯
    if (dataList.length === 0) {
        chart5.clear();
        document.getElementById('main5').innerHTML = '<div class="no-data">æš‚æ— ç¬¦åˆæ¡ä»¶çš„æ•°æ®</div>';
        return;
    } else {
        const main5Element = document.getElementById('main5');
        if (main5Element.innerHTML.includes('no-data') || main5Element.innerHTML.includes('error-message')) {
            main5Element.innerHTML = '';
        }
    }
    
    // æŒ‰ç¬¬ä¸€ä¸ªæŒ‡æ ‡æ’åº
    dataList.sort((a, b) => b[metric1] - a[metric1]);
    const categories = dataList.map(item => getSimplifiedName(item.name));
    const metric1Data = dataList.map(item => item[metric1]);
    const metric2Data = dataList.map(item => item[metric2]);
    
    // æ£€æŸ¥æŒ‡æ ‡æ•°æ®æ˜¯å¦å­˜åœ¨
    if (metric1Data.some(val => val === undefined) || metric2Data.some(val => val === undefined)) {
        chart5.clear();
        document.getElementById('main5').innerHTML = 
            `<div class="error-message">æŒ‡å®šçš„æŒ‡æ ‡ (${fieldMapping[metric1]} æˆ– ${fieldMapping[metric2]}) åœ¨æ•°æ®ä¸­ä¸å­˜åœ¨</div>`;
        return;
    }
    
    // æ›´æ–°å›¾è¡¨æ ‡é¢˜
    const title = `${fieldMapping[metric1]}ä¸${fieldMapping[metric2]}å¯¹æ¯”`;
    document.getElementById('chart5-title').textContent = title;
    
    const option = {
        backgroundColor: 'transparent',
        tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(0,0,0,0.8)',
            textStyle: { color: '#fff' },
            formatter: function(params) {
                const originalName = params[0].data.fullName;
                let tooltipContent = originalName + '<br/>';
                params.forEach(function(item) {
                    let value = item.value;
                    // æ ¹æ®æŒ‡æ ‡ç±»å‹æ ¼å¼åŒ–æ•°å€¼
                    if (item.seriesName.includes('æ¶¨å¹…') || item.seriesName.includes('ç‡')) {
                        value = value.toFixed(2) + '%';
                    } else if (item.seriesName.includes('æˆäº¤é¢') || item.seriesName.includes('æ²‰æ·€èµ„é‡‘')) {
                        value = formatCjeToBillion(value);
                    } else if (typeof value === 'number') {
                        value = value.toFixed(2);
                    }
                    tooltipContent += `${item.marker}${item.seriesName}: ${value}<br/>`;
                });
                return tooltipContent;
            }
        },
        legend: {
            data: [fieldMapping[metric1], fieldMapping[metric2]],
            top: 10,
            textStyle: { color: '#333' }
        },
        xAxis: {
            type: 'category',
            data: categories,
            axisLabel: commonAxisOptions.axisLabel,
            axisLine: commonAxisOptions.axisLine
        },
        yAxis: [
            {
                type: 'value',
                name: fieldMapping[metric1],
                position: 'left',
                axisLabel: {
                    formatter: function (value) { return value.toFixed(2); },
                    fontSize: commonAxisOptions.axisLabel.fontSize,
                    color: commonAxisOptions.axisLabel.color
                },
                axisLine: commonAxisOptions.axisLine,
                splitLine: commonAxisOptions.splitLine
            },
            {
                type: 'value',
                name: fieldMapping[metric2],
                position: 'right',
                axisLabel: {
                    formatter: function (value) { return value.toFixed(2); },
                    fontSize: commonAxisOptions.axisLabel.fontSize,
                    color: commonAxisOptions.axisLabel.color
                },
                axisLine: commonAxisOptions.axisLine,
                splitLine: { show: false }
            }
        ],
        dataZoom: [
            { type: 'inside', start: 0, end: 100 },
            { start: 0, end: 100, height: 20 }
        ],
        series: [
            {
                name: fieldMapping[metric1],
                type: 'bar',
                yAxisIndex: 0,
                itemStyle: { color: '#8b5cf6' },
                data: dataList.map(item => ({
                    value: item[metric1],
                    dm: item.dm,
                    name: getSimplifiedName(item.name),
                    fullName: item.name
                }))
            },
            {
                name: fieldMapping[metric2],
                type: 'line',
                yAxisIndex: 1,
                itemStyle: { color: '#f59e0b' },
                lineStyle: { width: 2 },
                data: dataList.map(item => ({
                    value: item[metric2],
                    dm: item.dm,
                    name: getSimplifiedName(item.name),
                    fullName: item.name
                }))
            }
        ]
    };
    
    chartOptions.chart5 = option;
    chart5.setOption(option);
    bindChartClick(chart5);
}

// ==============================================
// é¢œè‰²å·¥å…·å‡½æ•°
// æ ¹æ®æ•°æ®å€¼è¿”å›ç›¸åº”çš„é¢œè‰²
// ==============================================

/**
 * æ ¹æ®æ¶¨è·Œå¹…è¿”å›ç›¸åº”é¢œè‰²
 * @param {number} zdf - æ¶¨è·Œå¹…ç™¾åˆ†æ¯”
 * @returns {string} é¢œè‰²ä»£ç 
 */
function getZdfTreemapColor(zdf) {
    const abs = Math.abs(zdf);
    if (zdf <= 0) {
        // ä¸‹è·Œé¢œè‰²ï¼ˆç»¿è‰²ç³»ï¼‰
        if (abs >= 5) return '#006400'; // æ·±ç»¿
        if (abs >= 2) return '#22c55e'; // ç»¿è‰²
        if (abs >= 1) return '#66bb6a'; // æµ…ç»¿
        return '#86efac';               // å¾ˆæµ…çš„ç»¿
    } else {
        // ä¸Šæ¶¨é¢œè‰²ï¼ˆçº¢è‰²ç³»ï¼‰
        if (abs >= 5) return '#8b0000'; // æ·±çº¢
        if (abs >= 2) return '#ef4444'; // çº¢è‰²
        if (abs >= 1) return '#ff8888'; // æµ…çº¢
        return '#fca5a5';               // å¾ˆæµ…çš„çº¢
    }
}

/**
 * æ ¹æ®å¢ä»“æƒ…å†µè¿”å›ç›¸åº”é¢œè‰²
 * @param {number} rz - æ—¥å¢ä»“é‡
 * @returns {string} é¢œè‰²ä»£ç 
 */
function getOpenInterestChangeColor(rz) {
    if (rz > 0) return '#ef4444';   // å¢ä»“ï¼šçº¢è‰²
    if (rz < 0) return '#22c55e';   // å‡ä»“ï¼šç»¿è‰²
    return '#9ca3af';               // æ— å˜åŒ–ï¼šç°è‰²
}

// ==============================================
// å›¾è¡¨6ï¼šå“ç§æ¶¨è·Œå›¾ï¼ˆæ ‘çŠ¶å›¾ï¼‰
// æ ¹æ®é€‰æ‹©çš„æŒ‡æ ‡ä»¥æ ‘çŠ¶å›¾å½¢å¼å±•ç¤ºå“ç§åˆ†å¸ƒ
// ==============================================
function renderChart6(dataList) {
    let treemapData;
    let legendDataFunction = updateTreemapLegendZdf; // é»˜è®¤å›¾ä¾‹å‡½æ•°

    // æ ¹æ®å½“å‰é€‰æ‹©çš„æŒ‡æ ‡è¿›è¡Œæ•°æ®å¤„ç†
    if (chart6Metric === 'volumeAnalysis') {
        // æˆäº¤é‡åˆ†ææ¨¡å¼
        treemapData = dataList.filter(item => 
            typeof item.vol === 'number' && item.vol > 0 && typeof item.rz === 'number'
        );
        if (treemapData.length > 0) {
            treemapData.sort((a, b) => b.vol - a.vol); // æŒ‰æˆäº¤é‡æ’åº
        }
        legendDataFunction = updateTreemapLegendVolume;
        
    } else if (chart6Metric === 'oiAnalysis') {
        // æŒä»“é‡åˆ†ææ¨¡å¼
        treemapData = dataList.filter(item => 
            typeof item.ccl === 'number' && typeof item.rz === 'number'
        );
        if (treemapData.length > 0) {
            treemapData.sort((a, b) => b.ccl - a.ccl); // æŒ‰æŒä»“é‡æ’åº
        }
        legendDataFunction = updateTreemapLegendOi;
        
    } else { 
        // é»˜è®¤æ¨¡å¼ï¼šæˆäº¤é¢æˆ–æ²‰æ·€èµ„é‡‘
        treemapData = dataList.filter(item => 
            item.cje > 10 * 1e8 && item.hasOwnProperty('cdzj') && typeof item.zdf === 'number'
        );
        if (treemapData.length > 0) {
            treemapData.sort((a, b) => b[chart6Metric] - a[chart6Metric]);
        }
    }

    // æ•°æ®éªŒè¯
    if (treemapData.length === 0) {
        chart6.clear();
        document.getElementById('main6').innerHTML = '<div class="no-data">æš‚æ— ç¬¦åˆæ¡ä»¶çš„å“ç§æ•°æ®</div>';
        document.getElementById('main6-treemap-legend').innerHTML = '';
        return;
    } else {
        const main6Element = document.getElementById('main6');
        if (main6Element.innerHTML.includes('no-data') || main6Element.innerHTML.includes('error-message')) {
            main6Element.innerHTML = '';
        }
    }

    // æ„å»ºæ ‘çŠ¶å›¾æ•°æ®
    const treemapSeriesData = treemapData.map(item => {
        let value, color, labelFormatter, tooltipFormatterParams;

        if (chart6Metric === 'oiAnalysis') {
            // æŒä»“é‡åˆ†ææ¨¡å¼
            value = Math.abs(item.ccl);
            color = getOpenInterestChangeColor(item.rz);
            const prevCcl = item.ccl - item.rz;
            let rzRatio = 0;
            if (prevCcl !== 0) {
                rzRatio = (item.rz / prevCcl) * 100;
            }
            
            tooltipFormatterParams = {
                fullName: item.name,
                ccl: item.ccl ? item.ccl.toLocaleString() : '-',
                rz: item.rz ? item.rz.toLocaleString() : '-',
                rzRatio: rzRatio.toFixed(2) + '%',
                metricType: 'oiAnalysis'
            };

            labelFormatter = function(params) {
                const cclFormatted = params.data.ccl ? (params.data.ccl / 10000).toFixed(2) + 'ä¸‡æ‰‹' : '-';
                const rz = params.data.rz;
                const ccl = params.data.ccl;
                let rzText = '';
                if (typeof rz === 'number' && typeof ccl === 'number') {
                    const prevCcl = ccl - rz;
                    let rzRatio = 0;
                    if (prevCcl !== 0) {
                        rzRatio = (rz / prevCcl) * 100;
                    }
                    rzText = `\nå¢ä»“: ${rz.toLocaleString()} (${rzRatio.toFixed(1)}%)`;
                }
                return `${params.name}\n${cclFormatted}${rzText}`;
            };

        } else if (chart6Metric === 'volumeAnalysis') {
            // æˆäº¤é‡åˆ†ææ¨¡å¼
            value = Math.abs(item.vol);
            color = getOpenInterestChangeColor(item.rz);
            
            tooltipFormatterParams = {
                fullName: item.name,
                vol: item.vol ? item.vol.toLocaleString() + 'æ‰‹' : '-',
                rz: item.rz ? item.rz.toLocaleString() : '-',
                metricType: 'volumeAnalysis'
            };

            labelFormatter = function(params) {
                const volFormatted = params.data.vol ? (params.data.vol / 10000).toFixed(2) + 'ä¸‡æ‰‹' : '-';
                const rz = params.data.rz;
                const ccl = params.data.ccl;
                let rzText = '';
                if (typeof rz === 'number' && typeof ccl === 'number') {
                    const prevCcl = ccl - rz;
                    let rzRatio = 0;
                    if (prevCcl !== 0) {
                        rzRatio = (rz / prevCcl) * 100;
                    }
                    rzText = `\nå¢ä»“: ${rz.toLocaleString()} (${rzRatio.toFixed(1)}%)`;
                }
                return `${params.name}\n${volFormatted}${rzText}`;
            };

        } else { 
            // é»˜è®¤æ¨¡å¼ï¼šæˆäº¤é¢æˆ–æ²‰æ·€èµ„é‡‘
            value = item[chart6Metric];
            color = getZdfTreemapColor(item.zdf);
            tooltipFormatterParams = {
                fullName: item.name,
                cje: formatCjeToBillion(item.cje),
                cdzj: formatCjeToBillion(item.cdzj),
                zdf: item.zdf ? item.zdf.toFixed(2) + '%' : '0.00%',
                metricType: chart6Metric
            };
            labelFormatter = function(params) {
                const metricValueFormatted = formatCjeToBillion(params.data.value);
                const zdfFormatted = params.data.zdf ? params.data.zdf.toFixed(2) + '%' : '0.00%';
                return `${params.name}\n${metricValueFormatted}\n${zdfFormatted}`;
            };
        }

        return {
            name: getSimplifiedName(item.name),
            value: value,
            dm: item.dm,
            fullName: item.name,
            // å­˜å‚¨ç›¸å…³æ•°æ®ç”¨äºtooltip/æ ‡ç­¾
            zdf: item.zdf,
            cje: item.cje,
            cdzj: item.cdzj,
            ccl: item.ccl,
            rz: item.rz,
            vol: item.vol,
            rzRatio: chart6Metric === 'oiAnalysis' ? tooltipFormatterParams.rzRatio : undefined,
            itemStyle: {
                color: color,
                borderColor: '#fff',
                borderWidth: 1
            },
            label: {
                show: true,
                position: 'inside',
                color: '#fff',
                fontSize: 12,
                formatter: labelFormatter,
                rich: {
                    name: { fontSize: 13, fontWeight: 'bold' },
                    value: { fontSize: 11 },
                    metric: { fontSize: 11 }
                },
                overflow: 'truncate',
                width: '90%',
                height: '90%',
                lineHeight: 14
            }
        };
    });

    const option = {
        backgroundColor: 'transparent',
        tooltip: {
            trigger: 'item',
            backgroundColor: 'rgba(0,0,0,0.8)',
            textStyle: { color: '#fff' },
            formatter: function(params) {
                if (!params.data) return '';
                const data = params.data;
                
                if (data.metricType === 'oiAnalysis') {
                     return `${data.fullName}<br/>` +
                            `æŒä»“é‡: ${data.ccl ? data.ccl.toLocaleString() : '-'}<br/>` +
                            `æ—¥å¢ä»“: ${data.rz ? data.rz.toLocaleString() : '-'}<br/>` +
                            `å¢ä»“æ¯”: ${data.rzRatio || '0.00%'}`;
                } else if (data.metricType === 'volumeAnalysis') {
                    return `${data.fullName}<br/>` +
                           `æˆäº¤é‡: ${data.vol ? data.vol.toLocaleString() + 'æ‰‹' : '-'}<br/>` +
                           `æ—¥å¢ä»“: ${data.rz ? data.rz.toLocaleString() : '-'}`;
                } else {
                    return `${data.fullName}<br/>` +
                           `æˆäº¤é¢: ${formatCjeToBillion(data.cje)}<br/>` +
                           `æ²‰æ·€èµ„é‡‘: ${formatCjeToBillion(data.cdzj)}<br/>` +
                           `æ¶¨è·Œå¹…: ${data.zdf ? data.zdf.toFixed(2) + '%' : '0.00%'}`;
                }
            }
        },
        series: [{
            type: 'treemap',
            width: '100%',
            height: '100%',
            roam: false,         // ç¦ç”¨æ¼«æ¸¸
            nodeClick: false,    // ç¦ç”¨èŠ‚ç‚¹ç‚¹å‡»
            breadcrumb: { show: false },
            data: treemapSeriesData,
            levels: [
                {
                    itemStyle: { borderWidth: 1, borderColor: '#fff' },
                    upperLabel: { show: false }
                }
            ]
        }]
    };
    
    chartOptions.chart6 = option;
    chart6.setOption(option, true);
    bindChartClick(chart6);
    legendDataFunction(treemapData); // è°ƒç”¨ç›¸åº”çš„å›¾ä¾‹å‡½æ•°
}

// ==============================================
// å›¾è¡¨7ï¼šæ¶¨è·Œå¹…ä¸å¢ä»“æ¯”å…³ç³»å›¾ï¼ˆæ•£ç‚¹å›¾ï¼‰
// å±•ç¤ºå“ç§æ¶¨è·Œå¹…å’Œå¢ä»“æ¯”çš„å…³ç³»ï¼Œæ°”æ³¡å¤§å°è¡¨ç¤ºå…¶ä»–æŒ‡æ ‡
// ==============================================
function renderChart7(dataList) {
    // æŒ‡æ ‡ç»´åº¦æ˜ å°„ï¼šç”¨äºä»æ•°æ®æ•°ç»„ä¸­å–å€¼
    const metricDimensionMap = {
        'cdzj': 2,  // æ²‰æ·€èµ„é‡‘åœ¨valueæ•°ç»„çš„ç´¢å¼•
        'cje': 3,   // æˆäº¤é¢åœ¨valueæ•°ç»„çš„ç´¢å¼•
        'vol': 4,   // æˆäº¤é‡åœ¨valueæ•°ç»„çš„ç´¢å¼•
        'ccl': 5    // æŒä»“é‡åœ¨valueæ•°ç»„çš„ç´¢å¼•
    };

    // æŒ‡æ ‡æ ¼å¼åŒ–å‡½æ•°æ˜ å°„
    const metricFormatterMap = {
        'cdzj': formatCjeToBillion,
        'cje': formatCjeToBillion,
        'vol': formatVolumeOrCCL,
        'ccl': formatVolumeOrCCL
    };

    let minSizeMetric = Infinity;
    let maxSizeMetric = -Infinity;

    // æ•°æ®é¢„å¤„ç†
    const scatterData = dataList.map(item => {
        // è®¡ç®—å¢ä»“æ¯”
        const prevCcl = item.ccl - item.rz;
        const rzRatio = prevCcl === 0 ? 0 : parseFloat(((item.rz / prevCcl) * 100).toFixed(2));
        
        // è·å–å„é¡¹æŒ‡æ ‡æ•°å€¼
        const cdzjVal = item.cdzj || 0;
        const cjeVal = item.cje || 0;
        const volVal = item.vol || 0;
        const cclVal = item.ccl || 0;

        // è®¡ç®—å½“å‰é€‰æ‹©æŒ‡æ ‡çš„æœ€å€¼ï¼Œç”¨äºæ°”æ³¡å¤§å°æ˜ å°„
        const currentSizeMetricValue = item[chart7SizeMetric] || 0;
        if (currentSizeMetricValue < minSizeMetric) minSizeMetric = currentSizeMetricValue;
        if (currentSizeMetricValue > maxSizeMetric) maxSizeMetric = currentSizeMetricValue;

        return {
            name: getSimplifiedName(item.name),
            fullName: item.name,
            dm: item.dm,
            cdzj: cdzjVal,
            cje: cjeVal,
            vol: volVal,
            ccl: cclVal,
            // valueæ•°ç»„ï¼š[æ¶¨è·Œå¹…, å¢ä»“æ¯”, æ²‰æ·€èµ„é‡‘, æˆäº¤é¢, æˆäº¤é‡, æŒä»“é‡]
            value: [item.zdf, rzRatio, cdzjVal, cjeVal, volVal, cclVal] 
        };
    }).filter(item => item.value[0] !== undefined && item.value[1] !== undefined);

    // æ•°æ®éªŒè¯
    if (scatterData.length === 0) {
        chart7.clear();
        document.getElementById('main7').innerHTML = '<div class="no-data">æš‚æ— ç¬¦åˆæ¡ä»¶çš„æ•°æ®</div>';
        return;
    }
    
    const option = {
        backgroundColor: 'transparent',
        tooltip: {
            trigger: 'item',
            backgroundColor: 'rgba(0,0,0,0.8)',
            textStyle: { color: '#fff' },
            formatter: function(params) {
                const data = params.data;
                const zdf = data.value[0];
                const rzRatio = data.value[1];
                const color = zdf >= 0 ? '#ef4444' : '#22c55e';
                const rzColor = rzRatio >= 0 ? '#ef4444' : '#22c55e';
                
                let tooltipContent = `<strong style="font-size: 16px; font-weight: bold;">${data.fullName}</strong><br/>` +
                       `æ¶¨è·Œå¹…: <strong style="color:${color};">${zdf.toFixed(2)}%</strong><br/>` +
                       `å¢ä»“æ¯”: <strong style="color:${rzColor};">${rzRatio.toFixed(2)}%</strong><br/>`;

                // æ·»åŠ å½“å‰é€‰æ‹©çš„æŒ‡æ ‡ä¿¡æ¯
                const currentSizeMetricDisplayName = fieldMapping[chart7SizeMetric];
                const currentSizeMetricRawValue = data[chart7SizeMetric];
                const formatterFn = metricFormatterMap[chart7SizeMetric];
                const formattedValue = formatterFn ? formatterFn(currentSizeMetricRawValue) : currentSizeMetricRawValue;

                tooltipContent += `${currentSizeMetricDisplayName}: ${formattedValue}`;
                return tooltipContent;
            }
        },
        grid: {
            left: '10%',
            right: '10%',
            bottom: '15%',
            top: '10%'
        },
        xAxis: {
            type: 'value',
            name: 'æ¶¨è·Œå¹… (%)',
            nameLocation: 'middle',
            nameGap: 25,
            splitLine: { lineStyle: { type: 'dashed' } },
            axisLabel: { formatter: '{value}%' }
        },
        yAxis: {
            type: 'value',
            name: 'å¢ä»“æ¯” (%)',
            nameLocation: 'middle',
            nameGap: 45,
            splitLine: { lineStyle: { type: 'dashed' } },
            axisLabel: { formatter: '{value}%' }
        },
        dataZoom: [
            { type: 'inside', xAxisIndex: 0, yAxisIndex: 0 },
            { type: 'slider', xAxisIndex: 0, yAxisIndex: 0, height: 20 }
        ],
        // è§†è§‰æ˜ å°„ï¼šæ ¹æ®é€‰æ‹©çš„æŒ‡æ ‡æ§åˆ¶æ°”æ³¡å¤§å°
        visualMap: {
            type: 'continuous',
            dimension: metricDimensionMap[chart7SizeMetric], // ä½¿ç”¨å¯¹åº”ç»´åº¦
            min: minSizeMetric,
            max: maxSizeMetric,
            show: false,          // ä¸æ˜¾ç¤ºè§†è§‰æ˜ å°„ç»„ä»¶
            inRange: {
                symbolSize: [30, 100] // æ°”æ³¡å¤§å°èŒƒå›´
            }
        },
        series: [{
            type: 'scatter',
            data: scatterData,
            itemStyle: {
                // æ ¹æ®æ¶¨è·Œå¹…å’Œå¢ä»“æ¯”ç»„åˆç¡®å®šé¢œè‰²
                color: function(params) {
                    const zdf = params.data.value[0];
                    const rzRatio = params.data.value[1];
                    if (zdf > 0 && rzRatio > 0) return '#d92420'; // å¼ºçº¢ï¼šå¢ä»“ä¸Šæ¶¨ï¼ˆæœ€å¼ºï¼‰
                    if (zdf < 0 && rzRatio < 0) return '#00a65a'; // å¼ºç»¿ï¼šå‡ä»“ä¸‹è·Œï¼ˆæœ€å¼±ï¼‰
                    if (zdf > 0 && rzRatio < 0) return '#f39c12'; // æ©™é»„ï¼šå‡ä»“ä¸Šæ¶¨ï¼ˆå¤šå¤´ç¦»åœºï¼‰
                    if (zdf < 0 && rzRatio > 0) return '#0073b7'; // äº®è“ï¼šå¢ä»“ä¸‹è·Œï¼ˆç©ºå¤´åŠ ä»“ï¼‰
                    return '#95a5a6';                             // ä¸­æ€§ç°
                },
                opacity: 0.8,
                borderColor: 'rgba(255, 255, 255, 0.5)',
                borderWidth: 2
            },
            label: {
                show: true, 
                position: 'inside', 
                formatter: '{b}',     // æ˜¾ç¤ºå“ç§ç®€ç§°
                fontSize: 11,
                color: '#fff',
                fontWeight: 'bold'
            },
            emphasis: {
                focus: 'series', 
                label: {
                    show: true, 
                    position: 'top', 
                    formatter: '{b}',
                    fontSize: 12,
                    fontWeight: 'bold',
                    color: '#000' 
                }
            },
            labelLayout: { 
                hideOverlap: true    // éšè—é‡å æ ‡ç­¾
            }
        }]
    };

    chartOptions.chart7 = option;
    chart7.setOption(option, true);
    bindChartClick(chart7);
}

// ==============================================
// å›¾è¡¨8ï¼šå“ç§æ¶¨è·Œå¹…åŒºé—´ç»Ÿè®¡ï¼ˆé¥¼å›¾ï¼‰
// ç»Ÿè®¡å¹¶å±•ç¤ºä¸åŒæ¶¨è·Œå¹…åŒºé—´çš„å“ç§åˆ†å¸ƒ
// ==============================================
function renderChart8(dataList) {
    // åˆå§‹åŒ–å„ä¸ªæ¶¨è·Œå¹…åŒºé—´çš„è®¡æ•°å™¨
    const counts = {
        'zt': { count: 0, color: '#FF4500', label: 'æ¶¨åœ' },          // æ©™çº¢è‰²
        'zdf_gt_5': { count: 0, color: '#DC143C', label: 'ä¸Šæ¶¨ > 5%' }, // æ·±çº¢è‰²
        'zdf_2_5': { count: 0, color: '#FF6347', label: 'ä¸Šæ¶¨ 2-5%' },  // ç•ªèŒ„è‰²
        'zdf_0_2': { count: 0, color: '#FFA07A', label: 'ä¸Šæ¶¨ 0-2%' },  // æµ…é²‘é±¼è‰²
        'flat': { count: 0, color: '#808080', label: 'å¹³ç›˜' },         // ç°è‰²
        'zdf_neg_0_2': { count: 0, color: '#98FB98', label: 'ä¸‹è·Œ 0-2%' }, // æµ…ç»¿è‰²
        'zdf_neg_2_5': { count: 0, color: '#32CD32', label: 'ä¸‹è·Œ 2-5%' }, // é…¸æ©™ç»¿
        'zdf_neg_gt_5': { count: 0, color: '#008000', label: 'ä¸‹è·Œ > 5%' }, // ç»¿è‰²
        'dt': { count: 0, color: '#006400', label: 'è·Œåœ' }           // æ·±ç»¿è‰²
    };

    // ç»Ÿè®¡ä¸Šæ¶¨å’Œä¸‹è·Œå“ç§çš„æ•°é‡åŠæ¶¨è·Œå¹…æ€»å’Œï¼ˆç”¨äºè®¡ç®—å¹³å‡å€¼ï¼‰
    let totalRiseCount = 0;
    let sumRiseZdf = 0;
    let totalFallCount = 0;
    let sumFallZdf = 0;

    // éå†æ•°æ®è¿›è¡Œåˆ†ç±»ç»Ÿè®¡
    dataList.forEach(item => {
        const zdf = item.zdf;
        const isZT = item.zt === 1;  // æ˜¯å¦æ¶¨åœ
        const isDT = item.dt === 1;  // æ˜¯å¦è·Œåœ

        // æŒ‰æ¶¨è·Œå¹…åŒºé—´åˆ†ç±»
        if (isZT) {
            counts['zt'].count++;
        } else if (isDT) {
            counts['dt'].count++;
        } else if (zdf > 5) {
            counts['zdf_gt_5'].count++;
        } else if (zdf > 2 && zdf <= 5) {
            counts['zdf_2_5'].count++;
        } else if (zdf > 0 && zdf <= 2) {
            counts['zdf_0_2'].count++;
        } else if (zdf === 0) {
             counts['flat'].count++;
        } else if (zdf < 0 && zdf >= -2) {
            counts['zdf_neg_0_2'].count++;
        } else if (zdf < -2 && zdf >= -5) {
            counts['zdf_neg_2_5'].count++;
        } else if (zdf < -5) {
            counts['zdf_neg_gt_5'].count++;
        }

        // ç»Ÿè®¡æ€»ä½“ä¸Šæ¶¨/ä¸‹è·Œæƒ…å†µ
        if (typeof zdf === 'number') {
            if (zdf > 0) {
                totalRiseCount++;
                sumRiseZdf += zdf;
            } else if (zdf < 0) {
                totalFallCount++;
                sumFallZdf += zdf; // ç´¯åŠ è´Ÿå€¼
            }
        }
    });

    // è®¡ç®—å¹³å‡æ¶¨è·Œå¹…
    const avgRiseZdf = totalRiseCount > 0 ? (sumRiseZdf / totalRiseCount).toFixed(2) : '0.00';
    const displayAvgFallZdf = totalFallCount > 0 ? (Math.abs(sumFallZdf) / totalFallCount).toFixed(2) : '0.00';

    // è¿‡æ»¤æ‰è®¡æ•°ä¸º0çš„åˆ†ç±»ï¼ˆå¹³ç›˜é™¤å¤–ï¼Œå§‹ç»ˆæ˜¾ç¤ºï¼‰
    const chartData = Object.keys(counts)
        .filter(key => counts[key].count > 0 || key === 'flat')
        .map(key => ({
            name: counts[key].label,
            value: counts[key].count,
            itemStyle: { color: counts[key].color }
        }));

    // æŒ‰é¢„å®šä¹‰é¡ºåºæ’åº
    const order = [
        'æ¶¨åœ', 'ä¸Šæ¶¨ > 5%', 'ä¸Šæ¶¨ 2-5%', 'ä¸Šæ¶¨ 0-2%', 
        'å¹³ç›˜', 
        'ä¸‹è·Œ 0-2%', 'ä¸‹è·Œ 2-5%', 'ä¸‹è·Œ > 5%', 'è·Œåœ'
    ];
    chartData.sort((a, b) => order.indexOf(a.name) - order.indexOf(b.name));

    // æ•°æ®éªŒè¯
    if (chartData.length === 0) {
        chart8.clear();
        document.getElementById('main8').innerHTML = '<div class="no-data">æš‚æ— ç¬¦åˆæ¡ä»¶çš„å“ç§æ•°æ®</div>';
        return;
    } else {
        const main8Element = document.getElementById('main8');
        if (main8Element.innerHTML.includes('no-data') || main8Element.innerHTML.includes('error-message')) {
            main8Element.innerHTML = '';
        }
    }

    const option = {
        backgroundColor: 'transparent',
        tooltip: {
            trigger: 'item',
            formatter: '{b}: {c} ä¸ª ({d}%)' // æ˜¾ç¤ºåç§°ã€æ•°é‡å’Œç™¾åˆ†æ¯”
        },
        legend: {
            orient: 'vertical',   // å‚ç›´æ’åˆ—
            left: 'left',        // é å·¦æ˜¾ç¤º
            data: chartData.map(item => item.name),
            textStyle: { color: '#333' }
        },
        // åœ¨å›¾è¡¨ä¸­å¿ƒæ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
        graphic: [
            {
                type: 'text',
                left: '50%',
                top: '40%',
                style: {
                    text: `ä¸Šæ¶¨ï¼š${totalRiseCount}ä¸ª`,
                    fill: '#ef4444',
                    fontSize: 13,
                    fontWeight: 'bold',
                    textAlign: 'center'
                },
                onclick: function() {
                    window.open('https://wealth.want.biz/pages/ygs.html', '_blank');
                },
                cursor: 'pointer' 
            },
            {
                type: 'text',
                left: '50%',
                top: '45%',
                style: {
                    text: `å‡æ¶¨ï¼š${avgRiseZdf}%`,
                    fill: '#ef4444',
                    fontSize: 13,
                    textAlign: 'center'
                }
            },
            {
                type: 'text',
                left: '50%',
                top: '52%',
                style: {
                    text: `ä¸‹è·Œï¼š${totalFallCount}ä¸ª`,
                    fill: '#22c55e',
                    fontSize: 13,
                    fontWeight: 'bold',
                    textAlign: 'center'
                },
                onclick: function() {
                    window.open('https://wealth.want.biz/pages/ygs.html', '_blank');
                },
                cursor: 'pointer' 
            },
            {
                type: 'text',
                left: '50%',
                top: '57%',
                style: {
                    text: `å‡è·Œï¼š${displayAvgFallZdf}%`,
                    fill: '#22c55e',
                    fontSize: 13,
                    textAlign: 'center'
                }
            }
        ],
        series: [
            {
                name: 'å“ç§æ•°é‡',
                type: 'pie',
                radius: ['40%', '70%'],  // ç”œç”œåœˆå›¾
                center: ['55%', '50%'],  // è°ƒæ•´ä¸­å¿ƒä½ç½®ï¼Œä¸ºå›¾ä¾‹å’Œä¸­å¿ƒæ–‡å­—ç•™ç©ºé—´
                avoidLabelOverlap: false,
                label: {
                    show: true,
                    position: 'outer',   // æ ‡ç­¾æ˜¾ç¤ºåœ¨å¤–éƒ¨
                    formatter: '{b}\n{c} ({d}%)', // æ˜¾ç¤ºåç§°ã€æ•°é‡å’Œç™¾åˆ†æ¯”
                    color: '#333',
                    fontSize: 12,
                    fontWeight: 'bold', 
                    overflow: 'breakAll', 
                    minMargin: 5 
                },
                labelLine: {
                    show: true,
                    length: 10,  
                    length2: 15, 
                    smooth: true 
                },
                data: chartData,
                emphasis: {
                    itemStyle: {
                        shadowBlur: 10,
                        shadowOffsetX: 0,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                }
            }
        ]
    };
    
    chartOptions.chart8 = option;
    chart8.setOption(option, true);
}

// ==============================================
// æ ‘çŠ¶å›¾å›¾ä¾‹æ›´æ–°å‡½æ•°
// ä¸ºä¸åŒæ¨¡å¼çš„æ ‘çŠ¶å›¾ç”Ÿæˆç›¸åº”çš„å›¾ä¾‹
// ==============================================

/**
 * æ›´æ–°æ¶¨è·Œå¹…æ¨¡å¼çš„æ ‘çŠ¶å›¾å›¾ä¾‹
 * æ˜¾ç¤ºæ¶¨å¹…å‰ä¸‰å’Œè·Œå¹…å‰ä¸‰çš„å“ç§
 */
function updateTreemapLegendZdf(data) {
    const legendContainer = document.getElementById('main6-treemap-legend');
    let html = '';
    
    // è·å–æ¶¨å¹…å‰ä¸‰çš„å“ç§
    const topGainers = [...data].sort((a, b) => b.zdf - a.zdf).filter(item => item.zdf > 0).slice(0, 3);
    // è·å–è·Œå¹…å‰ä¸‰çš„å“ç§
    const topLosers = [...data].sort((a, b) => a.zdf - b.zdf).filter(item => item.zdf < 0).slice(0, 3);
    
    // ç”Ÿæˆæ¶¨å¹…å›¾ä¾‹
    topGainers.forEach(item => {
        html += `
            <div class="item">
                <span class="dot red"></span>
                <span class="label">${getSimplifiedName(item.name)}:</span>
                <span class="value red">${item.zdf.toFixed(2)}%</span>
            </div>`;
    });
    
    // æ·»åŠ åˆ†éš”ç¬¦
    if (topGainers.length > 0 && topLosers.length > 0) html += `<div> </div>`;
    
    // ç”Ÿæˆè·Œå¹…å›¾ä¾‹
    topLosers.forEach(item => {
        html += `
            <div class="item">
                <span class="dot green"></span>
                <span class="label">${getSimplifiedName(item.name)}:</span>
                <span class="value green">${item.zdf.toFixed(2)}%</span>
            </div>`;
    });
    
    legendContainer.innerHTML = html;
}

/**
 * æ›´æ–°æˆäº¤é‡æ¨¡å¼çš„æ ‘çŠ¶å›¾å›¾ä¾‹
 * æ˜¾ç¤ºå¢ä»“å’Œå‡ä»“çš„æˆäº¤é‡å‰ä¸‰å“ç§
 */
function updateTreemapLegendVolume(data) {
    const legendContainer = document.getElementById('main6-treemap-legend');
    let html = '';
    
    // è·å–å¢ä»“å‰ä¸‰çš„å“ç§ï¼ˆæŒ‰æˆäº¤é‡ï¼‰
    const topVolumeIncrease = [...data].sort((a, b) => b.rz - a.rz).filter(item => item.rz > 0).slice(0, 3);
    // è·å–å‡ä»“å‰ä¸‰çš„å“ç§ï¼ˆæŒ‰æˆäº¤é‡ï¼‰
    const topVolumeDecrease = [...data].sort((a, b) => a.rz - b.rz).filter(item => item.rz < 0).slice(0, 3);

    topVolumeIncrease.forEach(item => {
        html += `
            <div class="item">
                <span class="dot red"></span>
                <span class="label">${getSimplifiedName(item.name)} (å¢ä»“):</span>
                <span class="value red">${item.vol.toLocaleString()}æ‰‹ (rz ${item.rz.toLocaleString()})</span>
            </div>`;
    });

    if (topVolumeIncrease.length > 0 && topVolumeDecrease.length > 0) html += `<div style="margin: 2px 0;"> </div>`;

    topVolumeDecrease.forEach(item => {
        html += `
            <div class="item">
                <span class="dot green"></span>
                <span class="label">${getSimplifiedName(item.name)} (å‡ä»“):</span>
                <span class="value green">${item.vol.toLocaleString()}æ‰‹ (rz ${item.rz.toLocaleString()})</span>
            </div>`;
    });
    
    legendContainer.innerHTML = html;
}

/**
 * æ›´æ–°æŒä»“é‡æ¨¡å¼çš„æ ‘çŠ¶å›¾å›¾ä¾‹
 * æ˜¾ç¤ºå¢ä»“å’Œå‡ä»“çš„æŒä»“é‡å‰ä¸‰å“ç§
 */
function updateTreemapLegendOi(data) {
    const legendContainer = document.getElementById('main6-treemap-legend');
    let html = '';
    
    // è·å–å¢ä»“å‰ä¸‰çš„å“ç§
    const topIncreases = [...data].sort((a, b) => b.rz - a.rz).filter(item => item.rz > 0).slice(0, 3);
    // è·å–å‡ä»“å‰ä¸‰çš„å“ç§  
    const topDecreases = [...data].sort((a, b) => a.rz - b.rz).filter(item => item.rz < 0).slice(0, 3);

    topIncreases.forEach(item => {
        const prevCcl = item.ccl - item.rz;
        let rzRatioText = '-';
        if (prevCcl !== 0) {
            rzRatioText = ((item.rz / prevCcl) * 100).toFixed(2) + '%';
        }
        html += `
            <div class="item">
                <span class="dot red"></span>
                <span class="label">${getSimplifiedName(item.name)} (å¢ä»“):</span>
                <span class="value red">${item.rz.toLocaleString()} (${rzRatioText})</span>
            </div>`;
    });

    if (topIncreases.length > 0 && topDecreases.length > 0) html += `<div style="margin: 2px 0;"> </div>`;

    topDecreases.forEach(item => {
        const prevCcl = item.ccl - item.rz;
        let rzRatioText = '-';
        if (prevCcl !== 0) {
            rzRatioText = ((item.rz / prevCcl) * 100).toFixed(2) + '%';
        }
        html += `
            <div class="item">
                <span class="dot green"></span>
                <span class="label">${getSimplifiedName(item.name)} (å‡ä»“):</span>
                <span class="value green">${item.rz.toLocaleString()} (${rzRatioText})</span>
            </div>`;
    });
    
    legendContainer.innerHTML = html;
}

// ==============================================
// å›¾è¡¨äº¤äº’åŠŸèƒ½
// å¤„ç†å›¾è¡¨ç‚¹å‡»äº‹ä»¶å’Œä¸‹è½½åŠŸèƒ½
// ==============================================

/**
 * ä¸ºå›¾è¡¨ç»‘å®šç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
 * ç‚¹å‡»å›¾è¡¨ä¸­çš„æ•°æ®é¡¹æ—¶è·³è½¬åˆ°å¯¹åº”çš„å“ç§è¯¦æƒ…é¡µé¢
 * @param {Object} chart - EChartså›¾è¡¨å®ä¾‹
 */
 function bindChartClick(chart) {
    // ç§»é™¤å·²å­˜åœ¨çš„ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…é‡å¤ç»‘å®š
    chart.off('click');

    // ç»‘å®šæ–°çš„ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
    chart.on('click', function(params) {
        // æ£€æŸ¥ç‚¹å‡»çš„æ•°æ®é¡¹æ˜¯å¦åŒ…å«å“ç§ä»£ç 
        if (params.data && params.data.dm) {
            const dm = params.data.dm;

            // æå–å“ç§ä»£ç çš„å­—æ¯éƒ¨åˆ†ï¼ˆå»é™¤æ•°å­—ï¼‰
            // ä¾‹å¦‚ï¼š'CU2101' -> 'CU', 'RB2005' -> 'RB'
            const codeWithoutNumbers = dm.replace(/\d+/g, '');

            // æ„å»ºè·³è½¬URLï¼Œè·³è½¬åˆ°å“ç§å¤šç©ºåˆ†æé¡µé¢
            const url = `https://wealth.want.biz/v1/longshort.html?variety=${codeWithoutNumbers}`;

            // åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€é“¾æ¥
            window.open(url, '_blank');
        }
    });
}

/**
 * ä¸‹è½½å›¾è¡¨ä¸ºPNGå›¾ç‰‡
 * @param {Object} chartInstance - EChartså›¾è¡¨å®ä¾‹
 * @param {string} fileName - ä¸‹è½½çš„æ–‡ä»¶å
 */
function downloadChart(chartInstance, fileName) {
    // è·å–å›¾è¡¨çš„æ•°æ®URLï¼Œè®¾ç½®ç™½è‰²èƒŒæ™¯å’Œé«˜åˆ†è¾¨ç‡
    const url = chartInstance.getDataURL({ 
        backgroundColor: '#fff',  // ç™½è‰²èƒŒæ™¯
        pixelRatio: 2            // 2å€åƒç´ æ¯”ï¼Œæé«˜æ¸…æ™°åº¦
    });
    
    // åˆ›å»ºä¸´æ—¶ä¸‹è½½é“¾æ¥
    const link = document.createElement('a');
    link.href = url;
    link.download = fileName;
    link.click(); // è§¦å‘ä¸‹è½½
}

// ==============================================
// è‡ªåŠ¨åˆ·æ–°æ§åˆ¶åŠŸèƒ½
// ç®¡ç†æ•°æ®çš„è‡ªåŠ¨åˆ·æ–°æœºåˆ¶
// ==============================================

/**
 * åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½çš„å¼€å¯/å…³é—­çŠ¶æ€
 * æ›´æ–°æŒ‰é’®æ–‡æœ¬å’Œæ ·å¼ï¼Œå¯åŠ¨æˆ–åœæ­¢è‡ªåŠ¨åˆ·æ–°
 */
function toggleAutoRefresh() {
    autoRefresh = !autoRefresh; // åˆ‡æ¢çŠ¶æ€
    const btn = document.getElementById('auto-refresh-btn');
    
    if (autoRefresh) {
        // å¼€å¯è‡ªåŠ¨åˆ·æ–°
        btn.textContent = 'â±ï¸ è‡ªåŠ¨åˆ·æ–°: å¼€å¯';
        btn.classList.remove('secondary');  // ç§»é™¤æ¬¡è¦æ ·å¼
        startAutoRefresh();
    } else {
        // å…³é—­è‡ªåŠ¨åˆ·æ–°
        btn.textContent = 'â±ï¸ è‡ªåŠ¨åˆ·æ–°: å…³é—­';
        btn.classList.add('secondary');     // æ·»åŠ æ¬¡è¦æ ·å¼
        stopAutoRefresh();
    }
}

/**
 * å¯åŠ¨è‡ªåŠ¨åˆ·æ–°æœºåˆ¶
 * æ¯15ç§’è‡ªåŠ¨è·å–ä¸€æ¬¡æ–°æ•°æ®ï¼ˆä»…åœ¨äº¤æ˜“æ—¶æ®µå†…ï¼‰
 */
 function startAutoRefresh() {
    // æ¸…é™¤å·²å­˜åœ¨çš„å®šæ—¶å™¨ï¼Œé¿å…é‡å¤åˆ›å»º
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }

    // åˆ›å»ºæ–°çš„å®šæ—¶å™¨ï¼Œæ¯15ç§’æ‰§è¡Œä¸€æ¬¡
    refreshInterval = setInterval(() => {
        // æ£€æŸ¥è‡ªåŠ¨åˆ·æ–°å¼€å…³å’Œäº¤æ˜“æ—¶æ®µçŠ¶æ€
        if (autoRefresh && getSessionType() !== 'closed') {
            fetchData(); // è·å–æ–°æ•°æ®
        }
    }, 15000); // 15ç§’é—´éš”
}

/**
 * åœæ­¢è‡ªåŠ¨åˆ·æ–°æœºåˆ¶
 * æ¸…é™¤å®šæ—¶å™¨å¹¶é‡ç½®ç›¸å…³å˜é‡
 */
function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
}

// ==============================================
// è‡ªå®šä¹‰æŒ‡æ ‡åº”ç”¨åŠŸèƒ½
// å¤„ç†ç”¨æˆ·åœ¨è®¾ç½®èœå•ä¸­é€‰æ‹©çš„è‡ªå®šä¹‰æŒ‡æ ‡
// ==============================================

/**
 * åº”ç”¨ç”¨æˆ·é€‰æ‹©çš„è‡ªå®šä¹‰æŒ‡æ ‡è®¾ç½®
 * é‡æ–°æ¸²æŸ“å›¾è¡¨5ä»¥æ˜¾ç¤ºæ–°çš„æŒ‡æ ‡ç»„åˆ
 */
function applyCustomMetrics() {
    if (currentData.length > 0) {
        // è·å–ç”¨æˆ·é€‰æ‹©çš„ä¸¤ä¸ªæŒ‡æ ‡
        const metric1 = document.getElementById('metric1-select').value || 'cdzj';
        const metric2 = document.getElementById('metric2-select').value || 'tjd';
        
        // é‡æ–°æ¸²æŸ“è‡ªå®šä¹‰æŒ‡æ ‡å¯¹æ¯”å›¾
        renderChart5([...currentData], metric1, metric2);
    }
}

// ==============================================
// å…¨å±åŠŸèƒ½å®ç°
// ä¸ºæ‰€æœ‰å›¾è¡¨æ·»åŠ å…¨å±æŸ¥çœ‹åŠŸèƒ½
// ==============================================

/**
 * ä¸ºæ‰€æœ‰å…¨å±æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
 * å®ç°å›¾è¡¨çš„å…¨å±æ˜¾ç¤ºå’Œé€€å‡ºåŠŸèƒ½
 */
function addFullscreenListeners() {
    // ä¸ºæ‰€æœ‰å…¨å±æŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶
    document.querySelectorAll('.fullscreen-btn').forEach(button => {
        button.addEventListener('click', () => {
            // è·å–æŒ‰é’®æ‰€åœ¨çš„å›¾è¡¨å®¹å™¨
            const chartContainer = button.closest('.chart-container');
            
            if (!document.fullscreenElement) {
                // å½“å‰æ²¡æœ‰å…¨å±å…ƒç´ ï¼Œè¿›å…¥å…¨å±
                if (chartContainer.requestFullscreen) {
                    chartContainer.requestFullscreen();
                } else if (chartContainer.webkitRequestFullscreen) {
                    // Safariæµè§ˆå™¨å…¼å®¹
                    chartContainer.webkitRequestFullscreen();
                } else if (chartContainer.msRequestFullscreen) {
                    // IEæµè§ˆå™¨å…¼å®¹
                    chartContainer.msRequestFullscreen();
                }
            } else if (document.fullscreenElement === chartContainer) {
                // å½“å‰å®¹å™¨å·²å…¨å±ï¼Œé€€å‡ºå…¨å±
                document.exitFullscreen();
            }
        });
    });
    
    // ç›‘å¬å…¨å±çŠ¶æ€å˜åŒ–äº‹ä»¶
    document.addEventListener('fullscreenchange', () => {
        if (document.fullscreenElement) {
            // è¿›å…¥å…¨å±æ¨¡å¼
            const chartContainer = document.fullscreenElement;
            const chartVarName = chartContainer.dataset.chartVar; // è·å–å›¾è¡¨å˜é‡å
            const chartInstance = window[chartVarName];           // è·å–å¯¹åº”çš„å›¾è¡¨å®ä¾‹
            
            // å»¶è¿Ÿè°ƒæ•´å›¾è¡¨å°ºå¯¸ï¼Œç¡®ä¿å®¹å™¨å°ºå¯¸å·²æ›´æ–°
            setTimeout(() => {
                if (chartInstance) chartInstance.resize();
            }, 150);
            
            // æ›´æ–°å…¨å±æŒ‰é’®æ–‡æœ¬
            const btn = chartContainer.querySelector('.fullscreen-btn');
            if (btn) btn.textContent = 'é€€å‡ºå…¨å±';
            
        } else {
            // é€€å‡ºå…¨å±æ¨¡å¼
            setTimeout(() => {
                // è°ƒæ•´æ‰€æœ‰å›¾è¡¨çš„å°ºå¯¸
                ['chart1','chart2','chart3','chart4','chart5','chart6','chart7','chart8'].forEach(chartVar => { 
                    const chartInstance = window[chartVar];
                    if (chartInstance) chartInstance.resize();
                });
                
                // æ¢å¤æ‰€æœ‰å…¨å±æŒ‰é’®çš„æ–‡æœ¬
                document.querySelectorAll('.fullscreen-btn').forEach(btn => btn.textContent = 'å…¨å±');
            }, 150);
        }
    });
    
    // åˆå§‹åŒ–æ‰€æœ‰å…¨å±æŒ‰é’®çš„æ–‡æœ¬
    document.querySelectorAll('.fullscreen-btn').forEach(button => {
        button.textContent = 'å…¨å±';
    });
}

// ==============================================
// æ–‡æ¡£ç»“æŸæ ‡è®°
// JavaScriptä»£ç åˆ°æ­¤ç»“æŸ
// ==============================================

</script>

</body>
</html>