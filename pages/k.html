<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>实时监控</title>
    
    <!-- 引入 ECharts 脚本库，用于图表绘制 -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    
    <style>
        /* ==============================================
           CSS变量定义 - 统一的颜色调色板
           使用CSS自定义属性，便于全局管理和主题切换
           ============================================== */
        :root {
          /* 背景色系 - 用于页面和卡片的背景渐变 */
          --bg-start:       #f0f4f8;    /* 渐变起始色 - 浅灰蓝 */
          --bg-end:         #e3eefc;    /* 渐变结束色 - 更浅的蓝色 */
          --card-bg:        rgba(255, 255, 255, 0.9); /* 卡片背景 - 半透明白色 */
          --border-light:   rgba(255, 255, 255, 0.5); /* 边框颜色 - 半透明白边框 */
      
          /* 主色调 (蓝色系) - 用于主要的交互元素 */
          --primary:        #1976D2;    /* 主蓝色 */
          --primary-dark:   #1565C0;    /* 深蓝色 - 用于hover状态 */
          --primary-light:  #bbdefb;    /* 浅蓝色 - 用于背景 */
          --primary-shadow: rgba(25, 118, 210, 0.3); /* 蓝色阴影 */
      
          /* 次要色调 (琥珀色系) - 用于警告和次要按钮 */
          --secondary:        #FFC107;  /* 琥珀色 */
          --secondary-dark:   #FFA000;  /* 深琥珀色 */
          --secondary-shadow: rgba(255, 193, 7, 0.3); /* 琥珀色阴影 */
      
          /* 成功色调 (绿色系) - 用于成功状态和下跌数据 */
          --success:        #388E3C;    /* 成功绿 */
          --success-light:  #C8E6C9;    /* 浅成功绿 */
          --success-shadow: rgba(56, 142, 60, 0.3); /* 绿色阴影 */
      
          /* 危险色调 (红色系) - 用于错误状态和上涨数据 */
          --danger:         #D32F2F;    /* 危险红 */
          --danger-light:   #FFCDD2;    /* 浅危险红 */
          --danger-shadow:  rgba(211, 47, 47, 0.3); /* 红色阴影 */
      
          /* 信息色调 (青色系) - 用于信息提示 */
          --info:           #0288D1;    /* 信息青 */
          --info-dark:      #0277BD;    /* 深信息青 */
          --info-shadow:    rgba(2, 136, 209, 0.3); /* 青色阴影 */
      
          /* 文字和阴影 */
          --text:           #333;       /* 主要文字颜色 */
          --text-dark:      #2c3e50;    /* 深色文字 */
          --shadow:         rgba(0, 0, 0, 0.1); /* 统一阴影 */
        }
      
        /* ==============================================
           Toast提示样式
           ============================================== */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text-dark);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--border-light);
            backdrop-filter: blur(10px);
            z-index: 9999;
            transform: translateX(120%);
            transition: transform 0.3s ease-in-out;
            max-width: 300px;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            background: var(--success-light);
            border-color: var(--success);
            color: var(--success);
        }
        
        .toast.error {
            background: var(--danger-light);
            border-color: var(--danger);
            color: var(--danger);
        }
      
        /* ==============================================
           一言组件样式
           ============================================== */
        .yiyan-container {
          background: var(--card-bg);
          border: 1px solid var(--border-light);
          border-radius: 15px;
          box-shadow: 0 4px 20px var(--shadow);
          backdrop-filter: blur(10px);
          padding: 20px;
          margin-bottom: 20px;
          text-align: center;
          position: relative;
          overflow: hidden;
        }
        
        .yiyan-content {
          font-size: 1.1rem;
          line-height: 1.6;
          color: var(--text-dark);
          margin-bottom: 10px;
          position: relative;
          z-index: 2;
        }
        
        .yiyan-source {
          font-size: 0.9rem;
          color: #666;
          font-style: italic;
          position: relative;
          z-index: 2;
        }
        
        .yiyan-actions {
          display: flex;
          justify-content: center;
          gap: 15px;
          margin-top: 15px;
          position: relative;
          z-index: 2;
        }
        
        .yiyan-btn {
          padding: 5px 15px;
          background: linear-gradient(45deg, var(--primary), var(--primary-dark));
          color: white;
          border: none;
          border-radius: 15px;
          cursor: pointer;
          font-size: 0.9rem;
          transition: all 0.3s ease;
          box-shadow: 0 2px 5px var(--primary-shadow);
        }
        
        .yiyan-btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 10px var(--primary-shadow);
        }
        
        .yiyan-btn.secondary {
          background: linear-gradient(45deg, var(--secondary), var(--secondary-dark));
          box-shadow: 0 2px 5px var(--secondary-shadow);
        }
        
        .yiyan-btn.secondary:hover {
          box-shadow: 0 4px 10px var(--secondary-shadow);
        }
        
        .yiyan-loading {
          display: none;
          justify-content: center;
          align-items: center;
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(255, 255, 255, 0.7);
          z-index: 10;
          border-radius: 15px;
        }
        
        .yiyan-spinner {
          width: 30px;
          height: 30px;
          border: 3px solid #f3f3f3;
          border-top: 3px solid var(--primary);
          border-radius: 50%;
          animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        
        .yiyan-decoration {
          position: absolute;
          bottom: -20px;
          right: -20px;
          width: 100px;
          height: 100px;
          border-radius: 50%;
          background: linear-gradient(135deg, var(--primary-light), var(--primary));
          opacity: 0.1;
          z-index: 1;
        }
      
        /* ==============================================
           全局重置和基础样式
           确保所有元素使用border-box，统一外边距内边距
           ============================================== */
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box; /* 让padding和border包含在元素宽高内 */
        }
        
        /* 页面主体样式 - 设置渐变背景和基础字体 */
        body {
          font-family: 'Microsoft YaHei', Arial, sans-serif; /* 优先使用微软雅黑 */
          background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%); /* 对角线渐变背景 */
          color: var(--text);
          min-height: 100vh; /* 最小高度为视窗高度 */
          overflow-x: hidden; /* 隐藏水平滚动条 */
        }
        
        /* 主容器 - 限制最大宽度并居中 */
        .container {
          max-width: 1400px; /* 最大宽度1400px */
          margin: 0 auto;    /* 水平居中 */
          padding: 20px;     /* 内边距 */
        }
      
        /* ==============================================
           页面标题样式
           带有玻璃态效果的标题栏
           ============================================== */
        h1 {
          text-align: center;
          font-size: 1.5rem;
          color: var(--text-dark);
          margin-bottom: 10px;
          padding: 20px;
          background: var(--card-bg);               /* 半透明背景 */
          border: 1px solid var(--border-light);   /* 半透明边框 */
          border-radius: 15px;                     /* 圆角 */
          box-shadow: 0 4px 20px var(--shadow);    /* 阴影效果 */
          text-shadow: 1px 1px 2px rgba(0,0,0,0.05); /* 文字阴影 */
          backdrop-filter: blur(10px);             /* 背景模糊，玻璃态效果 */
        }
      
        /* ==============================================
           状态面板 - 显示交易状态和控制按钮
           使用flexbox布局，支持响应式换行
           ============================================== */
        .status-panel {
          display: flex;
          flex-wrap: wrap;           /* 允许换行 */
          justify-content: space-between; /* 两端对齐 */
          align-items: center;       /* 垂直居中 */
          gap: 15px;                /* 元素间距 */
          background: var(--card-bg);
          padding: 5px 20px;
          border: 1px solid var(--border-light);
          border-radius: 15px;
          box-shadow: 0 4px 20px var(--shadow);
          backdrop-filter: blur(10px); /* 玻璃态效果 */
          margin-bottom: 20px;
          position: relative;
          z-index: 5;               /* 确保在其他元素之上 */
        }
        
        /* 状态面板左右两侧的容器 */
        .status-left,
        .status-right {
          display: flex;
          align-items: center;
          gap: 10px;
        }
        
        /* 状态文本样式 */
        .status-text {
          font-size: 1.1rem;
          font-weight: 500;
          color: var(--text-dark);
        }
        
        /* 交易状态指示器 - 显示当前是否在交易时间 */
        .trading-status {
          display: inline-flex;
          align-items: center;
          gap: 8px;
          padding: 5px 15px;
          border-radius: 20px;      /* 胶囊形状 */
          font-size: 0.9rem;
          font-weight: 500;
        }
        
        /* 交易活跃状态 - 绿色背景 */
        .trading-status.active {
          background: var(--success-light);
          color: var(--success);
          border: 1px solid var(--success);
        }
        
        /* 交易非活跃状态 - 红色背景 */
        .trading-status.inactive {
          background: var(--danger-light);
          color: var(--danger);
          border: 1px solid var(--danger-light);
        }
      
        /* ==============================================
           菜单系统 - 下拉菜单容器和按钮
           包含复杂的定位和动画效果
           ============================================== */
        .menu-container {
          position: relative;
          z-index: 100;            /* 高层级，确保菜单在最上层 */
        }
        
        /* 菜单触发按钮 */
        .menu-btn {
          display: inline-flex;
          align-items: center;
          gap: 8px;
          padding: 5px 10px;
          background: linear-gradient(45deg, var(--primary), var(--primary-dark)); /* 渐变背景 */
          color: #fff;
          font-size: 14px;
          font-weight: 500;
          border: none;
          border-radius: 20px;
          cursor: pointer;
          box-shadow: 0 2px 10px var(--primary-shadow);
          transition: transform 0.3s ease, box-shadow 0.3s ease; /* 平滑过渡动画 */
        }
        
        /* 菜单按钮悬停效果 */
        .menu-btn:hover {
          transform: translateY(-1px);              /* 轻微上移 */
          box-shadow: 0 4px 15px var(--primary-shadow); /* 增强阴影 */
        }
        
        /* 下拉菜单主体 */
        .dropdown-menu {
          position: absolute;
          top: calc(100% + 10px);   /* 位于按钮下方10px */
          right: 0;                 /* 右对齐 */
          min-width: 300px;
          background: var(--card-bg);
          border: 1px solid var(--border-light);
          border-radius: 10px;
          padding: 20px;
          box-shadow: 0 10px 40px var(--shadow); /* 深度阴影 */
          backdrop-filter: blur(10px);           /* 背景模糊 */
          opacity: 0;                            /* 初始透明 */
          transform: translateY(-10px);          /* 初始位置上移 */
          transition: opacity 0.3s ease, transform 0.3s ease; /* 显示动画 */
          display: none;
          z-index: 1001;            /* 确保在遮罩层之上 */
        }
        
        /* 菜单显示状态 */
        .dropdown-menu.show {
          display: block;
          opacity: 1;               /* 完全不透明 */
          transform: translateY(0); /* 移动到正确位置 */
        }
        
        /* 菜单区块容器 */
        .menu-section {
          margin-bottom: 20px;
        }
        .menu-section:last-child {
          margin-bottom: 0;
        }
        
        /* 菜单区块标题 */
        .menu-section-title {
          font-size: 0.95rem;
          font-weight: 600;
          color: var(--text-dark);
          margin-bottom: 10px;
          padding-bottom: 5px;
          border-bottom: 1px solid #e1e5e9; /* 下方分割线 */
        }
      
        /* ==============================================
           指标选择器 - 用于自定义图表指标
           垂直排列的表单元素组合
           ============================================== */
        .metric-selector {
          display: flex;
          flex-direction: column;
          gap: 10px;
        }
        
        /* 指标选择行 - 包含标签和下拉框 */
        .metric-row {
          display: flex;
          align-items: center;
          gap: 10px;
        }
        
        /* 指标标签 */
        .metric-row label {
          font-weight: 500;
          color: #444;
          min-width: 70px;         /* 固定最小宽度对齐 */
          font-size: 0.9rem;
        }
        
        /* 指标下拉选择框 */
        .metric-row select {
          flex: 1;                 /* 占据剩余空间 */
          padding: 8px 12px;
          border: 1px solid #ccd6e1;
          border-radius: 8px;
          background: #fff;
          font-size: 0.9rem;
          color: #333;
          appearance: none;        /* 移除默认样式 */
          /* 自定义下拉箭头 */
          background-image: url('data:image/svg+xml;utf8,<svg fill="%23666" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 6.05 6.879 4.636 8.293z"/></svg>');
          background-repeat: no-repeat;
          background-position: right 10px center;
          background-size: 14px;
          transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        /* 下拉框聚焦状态 */
        .metric-row select:focus {
          border-color: var(--primary);
          box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.2); /* 聚焦发光效果 */
          outline: none;
        }
      
        /* ==============================================
           菜单操作按钮和通用控制按钮
           统一的按钮样式，支持不同的主题色
           ============================================== */
        .menu-actions {
          display: flex;
          gap: 10px;
          justify-content: flex-end; /* 右对齐 */
        }
        
        /* 控制按钮基础样式 */
        .control-btn {
          padding: 8px 18px;
          font-size: 13px;
          font-weight: 500;
          color: #fff;
          background: linear-gradient(45deg, var(--primary), var(--primary-dark));
          border: none;
          border-radius: 15px;
          box-shadow: 0 2px 8px var(--primary-shadow);
          cursor: pointer;
          transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        /* 按钮悬停效果 */
        .control-btn:hover {
          transform: translateY(-1px);
          box-shadow: 0 4px 12px var(--primary-shadow);
        }
        
        /* 按钮按下效果 */
        .control-btn:active {
          transform: translateY(0);
          box-shadow: 0 1px 5px var(--primary-shadow);
        }
        
        /* 次要按钮样式（不同颜色主题） */
        .control-btn.secondary {
          background: linear-gradient(45deg, var(--secondary), var(--secondary-dark));
          box-shadow: 0 2px 8px var(--secondary-shadow);
        }
        .control-btn.secondary:hover {
          box-shadow: 0 4px 12px var(--secondary-shadow);
        }
      
        /* ==============================================
           图表网格布局和容器
           响应式网格，自动适应屏幕大小
           ============================================== */
        .chart-grid {
          display: grid;
          /* 自适应网格：每列最小600px，最大1fr（等分剩余空间） */
          grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
          gap: 30px;               /* 网格间距 */
          margin-bottom: 30px;
        }
        
        /* 图表容器 - 每个图表的包装器 */
        .chart-container {
          position: relative;
          overflow: hidden;        /* 防止内容溢出 */
          background: var(--card-bg);
          border: 1px solid var(--border-light);
          border-radius: 15px;
          padding: 20px;
          box-shadow: 0 8px 32px var(--shadow);
          backdrop-filter: blur(10px); /* 玻璃态效果 */
          transition: transform 0.3s ease, box-shadow 0.3s ease;
          z-index: 1;
        }
        
        /* 图表容器悬停效果 */
        .chart-container:hover {
          transform: translateY(-5px);              /* 上移 */
          box-shadow: 0 12px 40px var(--shadow);    /* 增强阴影 */
        }
        
        /* 图表主体区域 */
        .chart {
          width: 100%;
          height: 400px;          /* 固定高度 */
        }
        
        /* 图表标题 */
        .chart-title {
          text-align: center;
          font-size: 1.3rem;
          font-weight: 600;
          color: var(--text-dark);
          margin-bottom: 15px;
          padding-bottom: 10px;
          border-bottom: 2px solid #e1e5e9; /* 下边框分割线 */
        }
      
        /* ==============================================
           图表功能按钮 - 下载和全屏
           悬浮在图表右上角的功能按钮
           ============================================== */
        .download-btn,
        .fullscreen-btn {
          position: absolute;
          top: 15px;
          padding: 6px 12px;
          font-size: 12px;
          color: #fff;
          border: none;
          border-radius: 15px;
          display: flex;
          align-items: center;
          gap: 4px;
          cursor: pointer;
          transition: transform 0.3s ease, box-shadow 0.3s ease;
          z-index: 10;            /* 确保在图表之上 */
        }
        
        /* 下载按钮位置和样式 */
        .download-btn {
          right: 15px;
          background: linear-gradient(45deg, var(--success), var(--success-light));
          box-shadow: 0 2px 8px var(--success-shadow);
        }
        .download-btn:hover {
          transform: scale(1.05);  /* 轻微放大 */
          box-shadow: 0 4px 12px var(--success-shadow);
        }
        
        /* 全屏按钮位置和样式 */
        .fullscreen-btn {
          right: 85px;             /* 位于下载按钮左侧 */
          background: linear-gradient(45deg, var(--info), var(--info-dark));
          box-shadow: 0 2px 8px var(--info-shadow);
        }
        .fullscreen-btn:hover {
          transform: scale(1.05);
          box-shadow: 0 4px 12px var(--info-shadow);
        }
      
        /* ==============================================
           全屏模式样式
           当图表进入全屏模式时的特殊样式
           ============================================== */
        .chart-container:fullscreen {
          position: fixed !important;
          top: 0; left: 0;
          width: 100vw !important;  /* 占满整个视窗宽度 */
          height: 100vh !important; /* 占满整个视窗高度 */
          max-width: none !important;
          max-height: none !important;
          margin: 0 !important;
          padding: 20px !important;
          border-radius: 0 !important; /* 全屏时无圆角 */
          background: #fff;
          box-shadow: none !important;
          display: flex;
          flex-direction: column;
          overflow: auto;
          z-index: 99999;          /* 最高层级 */
        }
        
        /* 全屏模式下的图表区域 */
        .chart-container:fullscreen .chart {
          height: calc(100vh - 120px) !important; /* 减去标题和边距的高度 */
          margin-top: 20px;
          flex: 1;                 /* 占据剩余空间 */
          width: 100% !important;
        }
        
        /* 全屏模式下的标题 */
        .chart-container:fullscreen .chart-title {
          margin-bottom: 10px;
          flex-shrink: 0;          /* 不收缩 */
        }
        
        /* 全屏模式下的树状图图例 */
        .chart-container:fullscreen .treemap-top-list {
          margin-bottom: 15px;
          flex-shrink: 0;
        }
      
        /* ==============================================
           加载和错误状态样式
           用于显示数据加载和错误信息
           ============================================== */
        .loading {
          display: none;           /* 默认隐藏 */
          justify-content: center;
          align-items: center;
          height: 200px;
          font-size: 1.2rem;
          color: #666;
        }
        
        /* 加载动画旋转器 */
        .spinner {
          width: 40px;
          height: 40px;
          border: 4px solid #f3f3f3;        /* 灰色背景 */
          border-top: 4px solid var(--primary); /* 蓝色顶部 */
          border-radius: 50%;               /* 圆形 */
          animation: spin 1s linear infinite; /* 旋转动画 */
          margin-right: 15px;
        }
        
        /* 定义旋转动画 */
        @keyframes spin {
          0%   { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        
        /* 错误消息样式 */
        .error-message {
          background: var(--danger-light);
          color: var(--danger);
          padding: 15px;
          border-radius: 10px;
          margin: 20px 0;
          text-align: center;
          border: 1px solid #f5c6cb;
        }
        
        /* 无数据提示样式 */
        .no-data {
          text-align: center;
          color: #666;
          font-size: 1.1rem;
          padding: 40px;
        }
      
        /* ==============================================
           菜单遮罩层
           点击空白处关闭菜单的半透明遮罩
           ============================================== */
        .menu-overlay {
          position: fixed;
          top: 0; left: 0; right: 0; bottom: 0; /* 覆盖整个屏幕 */
          background: rgba(0, 0, 0, 0.1);      /* 半透明黑色 */
          display: none;
          z-index: 10000;         /* 在菜单按钮之上，在菜单内容之下 */
        }
        .menu-overlay.show {
          display: block;
        }
      
        /* ==============================================
           树状图顶部图例
           显示涨跌幅排行榜的小标签
           ============================================== */
        .treemap-top-list {
          display: flex;
          justify-content: center;
          gap: 8px;
          margin-bottom: 10px;
          font-size: 0.75rem;
          flex-wrap: wrap;         /* 允许换行 */
        }
        
        /* 图例项目 */
        .treemap-top-list .item {
          display: flex;
          align-items: center;
          gap: 5px;
        }
        
        /* 颜色指示点 */
        .treemap-top-list .dot {
          width: 8px;
          height: 8px;
          border-radius: 50%;
        }
        .treemap-top-list .dot.red   { background-color: var(--danger); }
        .treemap-top-list .dot.green { background-color: var(--success); }
        
        /* 数值颜色 */
        .treemap-top-list .value.red   { color: var(--danger);   font-weight: 500; }
        .treemap-top-list .value.green { color: var(--success); font-weight: 500; }
        .treemap-top-list .label       { color: #555; }
      
        /* ==============================================
           图表6和图表7的指标选择器
           内嵌在图表内的单选按钮组
           ============================================== */
        .chart-metric-selector {
          display: flex;
          justify-content: center;
          flex-wrap: wrap;
          gap: 15px;
          margin: 10px 0;
          font-size: 0.9rem;
          color: #444;
          text-align: center;
        }
        
        /* 选择器标签 */
        .chart-metric-selector label {
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 5px;
          font-weight: 500;
        }
        
        /* 单选按钮 */
        .chart-metric-selector input[type="radio"] {
          margin-right: 3px;
        }
        
        /* 图表7的大小图例说明 */
        #chart7-size-legend {
          margin-left: 20px;
          background: rgba(255,255,255,0.8);
          padding: 5px 10px;
          border-radius: 8px;
          font-size: 0.85rem;
          color: #333;
          box-shadow: 0 2px 8px var(--shadow);
          white-space: nowrap;     /* 防止换行 */
          z-index: 9;
        }
      
        /* ==============================================
           响应式设计 - 移动端适配 (≤768px)
           针对小屏幕设备的样式调整
           ============================================== */
        @media (max-width: 768px) {
          /* 容器间距调整 */
          .container { padding: 10px; }
          
          /* 标题字体缩小 */
          h1 {
            font-size: 1.8rem;
            padding: 15px;
          }
          
          /* 状态面板改为垂直布局 */
          .status-panel {
            flex-direction: column;
            align-items: stretch;    /* 拉伸子元素 */
            text-align: center;
          }
          
          /* 状态面板子元素居中 */
          .status-left,
          .status-right {
            justify-content: center;
          }
          
          /* 下拉菜单适配移动端 */
          .dropdown-menu {
            left: 0;
            right: 0;
            max-width: calc(100vw - 40px); /* 留出边距 */
            transform-origin: top center;
          }
          
          /* 图表网格改为单列 */
          .chart-grid {
            grid-template-columns: 1fr;
            gap: 20px;
          }
          
          /* 图表高度调整 */
          .chart { height: 300px; }
          
          /* 指标选择器改为垂直布局 */
          .metric-row {
            flex-direction: column;
            align-items: stretch;
          }
          .metric-row label {
            min-width: auto;
            text-align: left;
          }
          
          /* 功能按钮大小调整 */
          .download-btn {
            right: 10px;
            top: 10px;
            padding: 4px 8px;
            font-size: 10px;
          }
          .fullscreen-btn {
            right: 70px;
            top: 10px;
            padding: 4px 8px;
            font-size: 10px;
          }
          
          /* 图表指标选择器移动端布局 */
          .chart-metric-selector {
            flex-direction: column;
            align-items: flex-start;
            padding-left: 10px;
          }
          
          /* 图表7图例适配 */
          #chart7-size-legend {
            margin-left: 0;
            width: 100%;
            text-align: center;
          }
        }
      </style>
</head>

<body>
    <div class="container">
        <!-- 页面主标题，显示当前时间 -->
        <h1 id="current-time">🎗期货品种实时监控🎗</h1>
        
        <!-- 一言组件 -->
        <div class="yiyan-container">
            <div class="yiyan-decoration"></div>
            <div class="yiyan-loading" id="yiyan-loading">
                <div class="yiyan-spinner"></div>
            </div>
            <div class="yiyan-content" id="yiyan-content">正在获取今日一言...</div>
            <div class="yiyan-source" id="yiyan-source"></div>
            <div class="yiyan-actions">
                <button class="yiyan-btn secondary" id="yiyan-copy">复制</button>
                <button class="yiyan-btn" id="yiyan-refresh">换一句</button>
            </div>
        </div>
        
        <!-- 状态面板：显示交易状态、时间和控制按钮 -->
        <div class="status-panel">
            <!-- 左侧：交易状态和时间显示 -->
            <div class="status-left">
                <!-- 交易状态指示器，通过JavaScript动态更新 -->
                <span id="trading-status" class="trading-status"></span>
                <div class="status-text">
                     <!-- 实时时间显示 -->
                     <span id="current-time-display"></span>
                </div>
            </div>
            
            <!-- 右侧：控制按钮组 -->
            <div class="status-right">
                <!-- 手动刷新按钮 -->
                <button id="refresh-btn" class="control-btn secondary">🔄 刷新</button>
                <!-- 自动刷新开关按钮 -->
                <button id="auto-refresh-btn" class="control-btn">⏱️ 自动刷新</button>
                
                <!-- 设置菜单容器 -->
                <div class="menu-container" id="menu-container">
                    <!-- 设置菜单触发按钮 -->
                    <button id="menu-btn" class="menu-btn">
                        ⚙️ 设置
                        <span id="menu-arrow">▼</span>
                    </button>
                    
                    <!-- 菜单遮罩层，点击关闭菜单 -->
                    <div class="menu-overlay" id="menu-overlay"></div>
                    
                    <!-- 下拉菜单主体 -->
                    <div class="dropdown-menu" id="dropdown-menu">
                        <!-- 自定义指标设置区块 -->
                        <div class="menu-section">
                            <div class="menu-section-title">📊 自定义指标设置</div>
                            <div class="metric-selector">
                                <!-- 第一个指标选择 -->
                                <div class="metric-row">
                                    <label for="metric1-select">指标1:</label>
                                    <select id="metric1-select">
                                        <option value="cje">成交额</option>
                                        <option value="vol">成交量</option>
                                        <option value="tjd">投机度</option>
                                        <option value="ccl">持仓量</option>
                                        <option value="cdzj">沉淀资金</option>
                                        <option value="zf">振幅</option>
                                        <option value="lb">量比</option>
                                        <option value="zdf" selected>涨跌幅</option>
                                    </select>
                                </div>
                                <!-- 第二个指标选择 -->
                                <div class="metric-row">
                                    <label for="metric2-select">指标2:</label>
                                    <select id="metric2-select">
                                        <option value="zdf">涨跌幅</option>
                                        <option value="zdf3">3日涨幅</option>
                                        <option value="zdf5">5日涨幅</option>
                                        <option value="zdf20">20日涨幅</option>
                                        <option value="zdfly">今年涨幅</option>
                                        <option value="zdf250">250日涨幅</option>
                                        <option value="zdflm">本月涨幅</option>
                                        <option value="tjd" selected>投机度</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 菜单操作按钮 -->
                        <div class="menu-section">
                            <div class="menu-actions">
                                <!-- 应用设置按钮 -->
                                <button id="apply-metrics-btn" class="control-btn">📊 应用指标</button>
                                <!-- 关闭菜单按钮 -->
                                <button id="close-menu-btn" class="control-btn secondary">✖️ 关闭</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 加载状态提示 -->
        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <span>别着急，数据马上就更新...</span>
        </div>
        
        <!-- 错误信息容器 -->
        <div id="error-container"></div>
        
        <!-- 图表网格容器 - 包含所有8个图表 -->
        <div class="chart-grid" id="charts-container">
            
            <!-- 图表6：品种涨跌图（树状图） -->
            <div class="chart-container" data-chart-var="chart6">
                <div class="chart-title">品种涨跌图</div>
                <!-- 图表6的指标选择器 - 选择树状图面积代表的指标 -->
                <div class="chart-metric-selector" id="chart6-metric-selector">
                    <label>面积代表: </label>
                    <label>
                        <input type="radio" name="chart6-metric" value="cje" checked> 成交额
                    </label>
                    <label>
                        <input type="radio" name="chart6-metric" value="cdzj"> 沉淀资金
                    </label>
                    <label>
                        <input type="radio" name="chart6-metric" value="oiAnalysis"> 持仓量
                    </label>
                    <label>
                        <input type="radio" name="chart6-metric" value="volumeAnalysis"> 成交量
                    </label>
                </div>
                <!-- 树状图顶部图例 - 显示涨跌幅排行 -->
                <div id="main6-treemap-legend" class="treemap-top-list"></div>
                <!-- 图表主体区域 -->
                <div id="main6" class="chart"></div>
                <!-- 功能按钮 -->
                <button class="download-btn" onclick="downloadChart(chart6, '品种涨跌图.png')">📥 下载</button>
                <button class="fullscreen-btn">全屏</button>
            </div>
            
            <!-- 图表1：期货品种走势对比（K线图） -->
            <div class="chart-container" data-chart-var="chart1">
                <div class="chart-title">期货品种走势对比</div>
                <div id="main1" class="chart"></div>
                <button class="download-btn" onclick="downloadChart(chart1, '期货品种走势对比.png')">📥 下载</button>
                <button class="fullscreen-btn">全屏</button>
            </div>
            
            <!-- 图表7：涨跌幅与增仓比关系图（散点图） -->
            <div class="chart-container" data-chart-var="chart7">
                <div class="chart-title">涨跌幅与增仓比关系图</div>
                <!-- 图表7的指标选择器 - 选择气泡大小代表的指标 -->
                <div class="chart-metric-selector" id="chart7-metric-selector">
                    <label>气泡大小代表: </label>
                    <label>
                        <input type="radio" name="chart7-size-metric" value="cdzj" checked> 沉淀资金
                    </label>
                    <label>
                        <input type="radio" name="chart7-size-metric" value="cje"> 成交额
                    </label>
                    <label>
                        <input type="radio" name="chart7-size-metric" value="vol"> 成交量
                    </label>
                    <label>
                        <input type="radio" name="chart7-size-metric" value="ccl"> 持仓量
                    </label>
                </div>
                <div id="main7" class="chart"></div>
                <button class="download-btn" onclick="downloadChart(chart7, '涨跌幅与增仓比关系图.png')">📥 下载</button>
                <button class="fullscreen-btn">全屏</button>
            </div>
            
            <!-- 图表8：品种涨跌幅区间统计（饼图） -->
            <div class="chart-container" data-chart-var="chart8">
                <div class="chart-title">品种涨跌幅区间统计</div>
                <div id="main8" class="chart"></div>
                <button class="download-btn" onclick="downloadChart(chart8, '品种涨跌幅区间统计.png')">📥 下载</button>
                <button class="fullscreen-btn">全屏</button>
            </div>
            
            <!-- 图表2：投机度与涨跌幅对比（柱状图+折线图） -->
            <div class="chart-container" data-chart-var="chart2">
                <div class="chart-title">投机度与涨跌幅对比</div>
                <div id="main2" class="chart"></div>
                <button class="download-btn" onclick="downloadChart(chart2, '投机度与涨跌幅对比.png')">📥 下载</button>
                <button class="fullscreen-btn">全屏</button>
            </div>
            
            <!-- 图表3：增仓率与涨跌幅对比（柱状图+折线图） -->
            <div class="chart-container" data-chart-var="chart3">
                <div class="chart-title">增仓率与涨跌幅对比</div>
                <div id="main3" class="chart"></div>
                <button class="download-btn" onclick="downloadChart(chart3, '增仓率与涨跌幅对比.png')">📥 下载</button>
                <button class="fullscreen-btn">全屏</button>
            </div>
            
            <!-- 图表4：各周期涨跌幅对比（多条折线图） -->
            <div class="chart-container" data-chart-var="chart4">
                <div class="chart-title">各周期涨跌幅对比</div>
                <div id="main4" class="chart"></div>
                <button class="download-btn" onclick="downloadChart(chart4, '各周期涨跌幅对比.png')">📥 下载</button>
                <button class="fullscreen-btn">全屏</button>
            </div>
            
            <!-- 图表5：自定义指标对比（柱状图+折线图） -->
            <div class="chart-container" data-chart-var="chart5">
                <div class="chart-title" id="chart5-title">自定义指标对比</div>
                <div id="main5" class="chart"></div>
                <button class="download-btn" onclick="downloadChart(chart5, '自定义指标对比.png')">📥 下载</button>
                <button class="fullscreen-btn">全屏</button>
            </div>
        </div>
    </div>

<script>
// ==============================================
// 全局变量定义区
// 存储图表实例、状态标志和数据
// ==============================================

// ECharts图表实例变量 - 管理8个不同的图表
let chart1,  // K线图：品种走势对比
    chart2,  // 柱状图+折线图：投机度与涨跌幅对比  
    chart3,  // 柱状图+折线图：增仓率与涨跌幅对比
    chart4,  // 多折线图：各周期涨跌幅对比
    chart5,  // 自定义图：用户选择的两个指标对比
    chart6,  // 树状图：品种涨跌分布
    chart7,  // 散点图：涨跌幅与增仓比关系
    chart8;  // 饼图：涨跌幅区间统计

// 应用状态管理变量
let autoRefresh = true;        // 自动刷新开关，默认开启
let refreshInterval;           // 定时器ID，用于管理自动刷新
let currentData = [];          // 当前获取的原始数据
let chartOptions = {};         // 存储所有图表的配置选项

// 图表配置变量
let chart6Metric = 'cje';      // 图表6（树状图）当前选择的指标，默认为成交额
let chart7SizeMetric = 'cdzj'; // 图表7（散点图）气泡大小指标，默认为沉淀资金

// ==============================================
// 数据字段映射表
// 将API返回的字段名映射为中文显示名称
// ==============================================
const fieldMapping = {
    // 基础价格数据
    qrspj: '昨收盘价',    zjsj: '昨结算价',    o: '开盘价',       h: '最高价',
    l: '最低价',         p: '最新价',        j: '均价',         mrj: '买入价',
    mcj: '卖出价',       zt: '涨停',         dt: '跌停',        
    
    // 涨跌幅相关
    zdf: '涨跌幅',       zde: '涨跌额',       zdf3: '3日涨幅',    zdf5: '5日涨幅',
    zdf6: '6日涨幅',     zdf20: '20日涨幅',   zdf250: '250日涨幅', zdfly: '今年涨幅',
    zdf0: '近一年涨幅',   zdflm: '本月涨幅',   
    
    // 交易数据  
    vol: '成交量',       cje: '成交额',       ccl: '持仓量',      zccl: '昨持仓量',
    rz: '日增仓',        np: '内盘',         wp: '外盘',        cjbs: '成交笔数',
    
    // 技术指标
    tjd: '投机度',       zf: '振幅',         lb: '量比',        cdzj: '沉淀资金',
    
    // 其他字段
    dm: '代码',          name: '合约名称',    ly: '计算来源',     sc: '市场代码',
    jyzt: '交易状态',    xs: '现手',         xsfx: '现手方向',   
    utime: '更新时间',   kpsj: '开盘时间',    spsj: '收盘时间',   jysj: '交易时间'
};

// ==============================================
// 通用图表样式配置
// 定义图表坐标轴的统一样式，确保视觉一致性
// ==============================================
const commonAxisOptions = {
    // 坐标轴标签样式
    axisLabel: {
        fontSize: 11,           // 字体大小
        color: '#444',          // 字体颜色
        interval: 0,            // 强制显示所有标签
        rotate: 45              // 标签旋转45度，防止重叠
    },
    // 坐标轴线样式
    axisLine: { 
        lineStyle: { color: '#ccc' } 
    },
    // 网格线样式
    splitLine: { 
        lineStyle: { 
            color: '#f0f0f0',   // 浅灰色
            type: 'dashed'      // 虚线
        } 
    }
};

// ==============================================
// 工具函数区
// 提供数据处理和格式化的通用功能
// ==============================================

/**
 * 从完整合约名称中提取简化的品种名称
 * 例如：'沪深300股指2506' -> '沪深300股指'
 * @param {string} fullName - 完整的合约名称
 * @returns {string} 简化后的品种名称
 */
function getSimplifiedName(fullName) {
    // 使用正则表达式匹配开头的非数字字符
    const match = fullName.match(/^([^\d]+)/);
    if (match && match[1]) return match[1];
    return fullName; // 如果匹配失败，返回原名称
}

/**
 * 将数值格式化为以亿为单位的字符串
 * 主要用于成交额和沉淀资金的显示
 * @param {number} value - 要格式化的数值
 * @returns {string} 格式化后的字符串，如'123.45亿'
 */
function formatCjeToBillion(value) {
    if (value === null || value === undefined) return '-';
    return (value / 1e8).toFixed(2) + '亿';
}

/**
 * 格式化成交量或持仓量为易读的单位
 * 支持万手、亿手等单位自动转换
 * @param {number} value - 要格式化的数值
 * @returns {string} 格式化后的字符串
 */
function formatVolumeOrCCL(value) {
    if (value === null || value === undefined) return '-';
    if (value >= 100000000) return (value / 100000000).toFixed(2) + '亿手';
    if (value >= 10000) return (value / 10000).toFixed(2) + '万手';
    return value.toLocaleString() + '手';
}

// ==============================================
// 一言功能相关函数
// ==============================================

// 全局变量存储一言数据
let currentHitokoto = "";
let currentSource = "";

// 显示一言加载状态
function showYiyanLoading() {
    const loadingElement = document.getElementById('yiyan-loading');
    if (loadingElement) {
        loadingElement.style.display = 'flex';
    }
}

// 隐藏一言加载状态
function hideYiyanLoading() {
    const loadingElement = document.getElementById('yiyan-loading');
    if (loadingElement) {
        loadingElement.style.display = 'none';
    }
}

// 获取一言数据
async function fetchHitokoto() {
    showYiyanLoading();
    
    try {
        const response = await fetch('https://v1.hitokoto.cn/?c=a&c=b&c=c&c=d&c=e&c=f&c=g&c=h&c=i&c=j&c=k');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data && data.hitokoto) {
            // 保存数据
            currentHitokoto = data.hitokoto;
            currentSource = data.from_who ? 
                `${data.from_who}《${data.from}》` : 
                data.from;
            
            // 更新UI
            const contentElement = document.getElementById('yiyan-content');
            const sourceElement = document.getElementById('yiyan-source');
            
            if (contentElement && sourceElement) {
                contentElement.textContent = currentHitokoto;
                sourceElement.textContent = currentSource;
            }
            
            // 发送到微信接口
            sendToWeChat(currentHitokoto, currentSource);
        }
    } catch (error) {
        console.error('获取一言失败:', error);
        const contentElement = document.getElementById('yiyan-content');
        if (contentElement) {
            contentElement.textContent = '获取一言失败，请点击刷新重试';
        }
    } finally {
        hideYiyanLoading();
    }
}

// 发送一言到微信接口
async function sendToWeChat(content, title) {
    try {
        // 将来源信息也包含在内容中
        const fullContent = `${content}\n\n—— ${title}\n\n`;
        
        const response = await fetch('https://api.yuangs.cc/weixinpush', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                msgtype: "text",
                title: "一言",
                content: fullContent,
                to_user: "@all"
            })
        });
        
        if (!response.ok) {
            console.error('发送到微信接口失败:', response.status);
        }
    } catch (error) {
        console.error('发送到微信接口错误:', error);
    }
}

// 复制一言到剪贴板
function copyYiyan() {
    const textToCopy = `${currentHitokoto}\n${currentSource}`;
    
    navigator.clipboard.writeText(textToCopy)
        .then(() => {
            // 可以添加复制成功的提示
            alert('已复制到剪贴板');
        })
        .catch(err => {
            console.error('复制失败:', err);
            alert('复制失败，请重试');
        });
}

// 初始化一言功能
function initializeYiyan() {
    // 获取DOM元素
    const copyButton = document.getElementById('yiyan-copy');
    const refreshButton = document.getElementById('yiyan-refresh');
    
    // 绑定事件监听器
    if (copyButton) {
        copyButton.addEventListener('click', copyYiyan);
    }
    
    if (refreshButton) {
        refreshButton.addEventListener('click', fetchHitokoto);
    }
    
    // 首次获取一言
    fetchHitokoto();
}

// ==============================================
// 页面初始化
// DOM加载完成后执行的初始化流程
// ==============================================
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();        // 初始化所有图表实例
    initializeControls();      // 初始化控制按钮和事件监听
    initializeMenu();          // 初始化设置菜单功能
    initializeYiyan();         // 初始化一言功能
    fetchData();               // 首次获取数据
    startAutoRefresh();        // 启动自动刷新
    updateTimeDisplay();       // 更新时间显示
    addFullscreenListeners();  // 添加全屏功能监听
    
    // 启动时钟更新定时器，每秒更新一次时间显示
    setInterval(updateTimeDisplay, 1000);
});

// ==============================================
// 菜单系统初始化
// 设置下拉菜单的显示/隐藏逻辑和事件处理
// ==============================================
function initializeMenu() {
    // 获取菜单相关的DOM元素
    const menuBtn = document.getElementById('menu-btn');           // 菜单触发按钮
    const menuOverlay = document.getElementById('menu-overlay');   // 背景遮罩层
    const dropdownMenu = document.getElementById('dropdown-menu'); // 下拉菜单内容
    const closeMenuBtn = document.getElementById('close-menu-btn'); // 关闭按钮
    const menuArrow = document.getElementById('menu-arrow');       // 箭头指示器

    // 绑定菜单触发按钮点击事件
    menuBtn.addEventListener('click', function(e) {
        e.stopPropagation(); // 阻止事件冒泡，防止立即触发文档点击关闭
        toggleMenu();
    });

    // 点击遮罩层关闭菜单
    menuOverlay.addEventListener('click', function() { 
        closeMenu(); 
    });

    // 点击关闭按钮关闭菜单  
    closeMenuBtn.addEventListener('click', function() { 
        closeMenu(); 
    });

    // 阻止菜单内容区域的点击事件冒泡，防止误关闭
    dropdownMenu.addEventListener('click', function(e) { 
        e.stopPropagation(); 
    });

    // 按ESC键关闭菜单
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeMenu();
    });

    /**
     * 切换菜单显示状态
     * 根据当前状态决定是打开还是关闭菜单
     */
    function toggleMenu() {
        const isOpen = dropdownMenu.classList.contains('show');
        if (isOpen) closeMenu(); 
        else openMenu();
    }

    /**
     * 打开菜单
     * 显示菜单内容和背景遮罩，改变箭头方向
     */
    function openMenu() {
        dropdownMenu.classList.add('show');
        menuOverlay.classList.add('show');
        menuArrow.textContent = '▲'; // 箭头向上
    }

    /**
     * 关闭菜单  
     * 隐藏菜单内容和背景遮罩，恢复箭头方向
     */
    function closeMenu() {
        dropdownMenu.classList.remove('show');
        menuOverlay.classList.remove('show');
        menuArrow.textContent = '▼'; // 箭头向下
    }

    // 绑定"应用指标"按钮点击事件
    document.getElementById('apply-metrics-btn').addEventListener('click', function() {
        applyCustomMetrics(); // 应用自定义指标设置
        closeMenu();          // 关闭菜单
    });
}

// ==============================================
// 图表初始化
// 创建所有ECharts实例并设置响应式调整
// ==============================================
function initializeCharts() {
    // 初始化8个图表实例，绑定到对应的DOM元素
    chart1 = echarts.init(document.getElementById('main1')); // K线图
    chart2 = echarts.init(document.getElementById('main2')); // 投机度对比图  
    chart3 = echarts.init(document.getElementById('main3')); // 增仓率对比图
    chart4 = echarts.init(document.getElementById('main4')); // 多周期对比图
    chart5 = echarts.init(document.getElementById('main5')); // 自定义指标图
    chart6 = echarts.init(document.getElementById('main6')); // 树状图
    chart7 = echarts.init(document.getElementById('main7')); // 散点图
    chart8 = echarts.init(document.getElementById('main8')); // 饼图
    
    // 监听窗口大小变化，自动调整所有图表尺寸
    window.addEventListener('resize', () => {
        chart1.resize(); chart2.resize(); chart3.resize(); chart4.resize(); 
        chart5.resize(); chart6.resize(); chart7.resize(); chart8.resize();
    });
    
    // 设置自定义指标的默认值
    document.getElementById('metric1-select').value = 'cdzj'; // 默认指标1：沉淀资金
    document.getElementById('metric2-select').value = 'tjd';  // 默认指标2：投机度
}

// ==============================================
// 控制按钮初始化
// 设置刷新按钮、自动刷新开关和图表选项的事件监听
// ==============================================
function initializeControls() {
    // 手动刷新按钮
    document.getElementById('refresh-btn').addEventListener('click', fetchData);
    
    // 自动刷新开关按钮
    document.getElementById('auto-refresh-btn').addEventListener('click', toggleAutoRefresh);
    
    // 设置自动刷新按钮的初始状态显示
    const autoRefreshBtn = document.getElementById('auto-refresh-btn');
    if (autoRefresh) {
        autoRefreshBtn.textContent = '⏱️ 自动刷新: 开启';
        autoRefreshBtn.classList.remove('secondary');
    } else {
        autoRefreshBtn.textContent = '⏱️ 自动刷新: 关闭';
        autoRefreshBtn.classList.add('secondary');
    }

    // 图表6（树状图）指标选择器事件监听
    const metricRadios6 = document.querySelectorAll('input[name="chart6-metric"]');
    metricRadios6.forEach(radio => {
        radio.addEventListener('change', function() {
            chart6Metric = this.value; // 更新选中的指标
            if (currentData.length > 0) {
                renderChart6(currentData); // 重新渲染图表6
            }
        });
    });

    // 图表7（散点图）气泡大小指标选择器事件监听
    const metricRadios7 = document.querySelectorAll('input[name="chart7-size-metric"]');
    metricRadios7.forEach(radio => {
        radio.addEventListener('change', function() {
            chart7SizeMetric = this.value; // 更新选中的指标
            if (currentData.length > 0) {
                renderChart7(currentData); // 重新渲染图表7
            }
        });
    });

    // 获取当前选中的默认值
    const checkedRadio6 = document.querySelector('input[name="chart6-metric"]:checked');
    if (checkedRadio6) {
        chart6Metric = checkedRadio6.value;
    }
    const checkedRadio7 = document.querySelector('input[name="chart7-size-metric"]:checked');
    if (checkedRadio7) {
        chart7SizeMetric = checkedRadio7.value;
    }
}

// ==============================================
// 交易时段判断
// 根据当前时间判断是日盘、夜盘还是非交易时段
// ==============================================
function getSessionType(now = new Date()) {
    const hour = now.getHours();
    const minute = now.getMinutes();

    // 夜盘时间：21:00 - 次日02:30
    if (hour >= 21 || (hour >= 0 && hour < 2) || (hour === 2 && minute <= 30)) {
        return 'night';
    }
    
    // 日盘时间：09:00 - 11:30 和 13:30 - 15:00
    if ((hour >= 9 && (hour < 11 || (hour === 11 && minute < 30))) || 
        (hour >= 13 && (hour < 15 || (hour === 15 && minute === 0)))) {
        return 'day';
    }
    
    // 其他时间为非交易时段
    return 'closed';
}

// ==============================================
// 时间显示更新
// 更新页面上的时间显示和交易状态指示器
// ==============================================
function updateTimeDisplay() {
    const now = new Date();
    // 格式化当前时间为 HH:MM:SS 格式
    const timeString = now.toLocaleTimeString('zh-CN', { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit' 
    });
    document.getElementById('current-time-display').textContent = timeString;

    // 根据当前时间判断交易状态并更新显示
    const sessionType = getSessionType(now);
    const statusElement = document.getElementById('trading-status');

    if (sessionType === 'day') {
        statusElement.textContent = '● 日盘交易中';
        statusElement.className = 'trading-status active';   // 绿色活跃状态
    } else if (sessionType === 'night') {
        statusElement.textContent = '● 夜盘交易中';
        statusElement.className = 'trading-status active';   // 绿色活跃状态
    } else {
        statusElement.textContent = '● 非交易时段';
        statusElement.className = 'trading-status inactive'; // 红色非活跃状态
    }
}

// ==============================================
// API接口选择
// 根据当前交易时段选择相应的数据接口
// ==============================================
function getApiUrl() {
    const sessionType = getSessionType();
    // 夜盘使用专门的夜盘接口，其他时间使用默认接口
    if (sessionType === 'night') {
        return 'https://q.want.biz/night';
    }
    return 'https://q.want.biz';
}

// ==============================================
// 加载状态和错误处理
// 管理页面的加载提示和错误信息显示
// ==============================================

/**
 * 显示加载状态（当前实现为隐藏，根据需要可以修改）
 */
function showLoading() {
    document.getElementById('loading').style.display = 'none';
}

/**
 * 隐藏加载状态
 */
function hideLoading() {
    document.getElementById('loading').style.display = 'none';
}

/**
 * 显示错误信息
 * @param {string} message - 错误信息文本
 */
function showError(message) {
    const errorContainer = document.getElementById('error-container');
    errorContainer.innerHTML = `<div class="error-message">❌ ${message}</div>`;
}

/**
 * 清除错误信息显示
 */
function clearError() {
    document.getElementById('error-container').innerHTML = '';
}

// ==============================================
// 数据获取主函数
// 从API获取期货数据并进行处理和渲染
// ==============================================
async function fetchData() {
    showLoading();  // 显示加载状态
    clearError();   // 清除之前的错误信息
    
    try {
        // 获取数据接口URL并发起请求
        const apiUrl = getApiUrl();
        const response = await fetch(apiUrl);
        
        // 检查HTTP响应状态
        if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        
        // 解析JSON数据
        const apiData = await response.json();
        
        // 验证数据格式
        if (!apiData || !apiData.list || !Array.isArray(apiData.list)) {
            throw new Error('数据格式错误');
        }
        
        // 数据过滤：只保留沉淀资金大于15亿的品种
        let filteredData = apiData.list.filter(item => item.cdzj > 15 * 1e8); 
        if (filteredData.length === 0) {
            throw new Error('没有符合条件的数据 (沉淀资金 > 15亿)');
        }

        // 交易时段内进一步过滤活跃品种
        const sessionType = getSessionType();
        if (sessionType !== 'closed') {
            const hasOpenMarkets = filteredData.some(item => item.jyzt === 0);
            if (hasOpenMarkets) {
                // 只有存在活跃市场时才过滤，否则显示所有可用数据
                filteredData = filteredData.filter(item => item.jyzt === 0);
            }
        }
        
        // 最终数据验证
        if (filteredData.length === 0) {
            throw new Error('当前交易时段内，没有符合条件的活跃品种。');
        }

        // 保存数据并渲染所有图表
        currentData = filteredData;
        renderAllCharts(filteredData);
        
        // 更新页面标题显示当前时间
        document.getElementById('current-time').textContent = 
            `🎗期货品种实时监控🎗 (${new Date().toLocaleTimeString()})`;
            
    } catch (error) {
        console.error('数据获取失败:', error);
        showError(`数据获取失败: ${error.message}`);
    } finally {
        hideLoading(); // 无论成功失败都隐藏加载状态
    }
}

// ==============================================
// 图表渲染调度
// 统一调用所有图表的渲染函数
// ==============================================
function renderAllCharts(data) {
    try {
        // 渲染所有图表，传入数据副本以避免意外修改
        renderChart1([...data]);  // K线图
        renderChart2([...data]);  // 投机度对比图
        renderChart3([...data]);  // 增仓率对比图  
        renderChart4([...data]);  // 多周期对比图
        
        // 自定义指标图表，使用菜单中选择的指标
        const metric1 = document.getElementById('metric1-select').value || 'cdzj';
        const metric2 = document.getElementById('metric2-select').value || 'tjd';
        renderChart5([...data], metric1, metric2);
        
        renderChart6([...data]);  // 树状图
        renderChart7([...data]);  // 散点图
        renderChart8([...data]);  // 饼图
        
    } catch (error) {
        console.error('图表渲染失败:', error);
        showError(`图表渲染失败: ${error.message}`);
    }
}

// ==============================================
// 图表1：期货品种走势对比（K线图）
// 将涨跌幅转换为相对昨结算价的百分比变化，以K线形式展示
// ==============================================
function renderChart1(dataList) {
    // 数据预处理：计算相对昨结算价的百分比变化
    const processedData = dataList.map(item => {
        // 计算开盘价、收盘价、最低价、最高价相对昨结算价的涨跌幅
        const openChange = parseFloat(((item.o - item.zjsj) / item.zjsj * 100).toFixed(2));
        const closeChange = parseFloat(((item.p - item.zjsj) / item.zjsj * 100).toFixed(2));
        const lowChange = parseFloat(((item.l - item.zjsj) / item.zjsj * 100).toFixed(2));
        const highChange = parseFloat(((item.h - item.zjsj) / item.zjsj * 100).toFixed(2));
        
        return {
            name: getSimplifiedName(item.name),  // 简化品种名称
            fullName: item.name,                 // 完整品种名称
            dm: item.dm,                         // 品种代码
            value: [openChange, closeChange, lowChange, highChange], // K线数据
            closeChange,    // 收盘涨跌幅
            openChange,     // 开盘涨跌幅
            highChange,     // 最高涨跌幅
            lowChange,      // 最低涨跌幅
            // 保存原始数据用于tooltip显示
            rawValues: {
                open: item.o,           // 开盘价
                high: item.h,           // 最高价
                low: item.l,            // 最低价
                close: item.p,          // 收盘价
                prevClose: item.zjsj,   // 昨结算价
                volume: item.vol,       // 成交量
                turnover: item.cje,     // 成交额
                openInterest: item.ccl, // 持仓量
                depositFunds: item.cdzj,// 沉淀资金
                amplitude: item.zf,     // 振幅
                volumeRatio: item.lb    // 量比
            }
        };
    });

    // 按收盘涨跌幅降序排序
    const sortedData = processedData.sort((a, b) => b.closeChange - a.closeChange);
    const categories = sortedData.map(item => item.name);

    // 创建标记点：标注涨幅最高和跌幅最大的品种
    const markPointData = [];
    
    // 添加涨幅最高标记
    if (sortedData.length > 0) {
        const highestGainer = sortedData[0];
        if (highestGainer.closeChange > 0) {
            markPointData.push({
                name: '涨幅最高',
                value: highestGainer.closeChange,
                coord: [0, highestGainer.value[1]], // [x轴索引, y轴数值]
                itemStyle: { color: '#ef4444' }     // 红色标记
            });
        }
    }
    
    // 添加跌幅最大标记
    if (sortedData.length > 1) { 
        const biggestLoser = sortedData[sortedData.length - 1];
        if (biggestLoser.closeChange < 0) {
            markPointData.push({
                name: '跌幅最大',
                value: biggestLoser.closeChange,
                coord: [sortedData.length - 1, biggestLoser.value[1]],
                itemStyle: { color: '#22c553' }     // 绿色标记
            });
        }
    }

    // ECharts配置选项
    const option = {
        backgroundColor: 'transparent',
        tooltip: {
            trigger: 'axis',        // 坐标轴触发
            backgroundColor: 'rgba(0,0,0,0.8)',
            borderColor: '#777',
            textStyle: { color: '#fff' },
            // 自定义tooltip内容格式
            formatter: function (params) {
                const dataPoint = params[0];
                const data = dataPoint.data;
                const raw = data.rawValues; 
                
                if (raw) {
                    // 计算涨跌额和涨跌幅
                    const changeValue = (raw.close - raw.prevClose).toFixed(2);
                    const changePercent = data.closeChange.toFixed(2);
                    const openChangePercent = data.openChange.toFixed(2);
                    const highChangePercent = data.highChange.toFixed(2);
                    const lowChangePercent = data.lowChange.toFixed(2);
                    
                    // 根据涨跌设置颜色
                    const color = data.closeChange >= 0 ? '#ef4444' : '#22c55e';
                    const color2 = data.highChange >= 0 ? '#ef4444' : '#22c55e';
                    const color3 = data.lowChange >= 0 ? '#ef4444' : '#22c55e';
                    const color4 = data.openChange >= 0 ? '#ef4444' : '#22c55e';
                    
                    // 构建tooltip内容
                    return `<strong style="font-size: 16px; font-weight: bold;">${data.fullName}</strong><br/>` +
                    `最新价: <strong style="color:${color};">${changePercent}% (${raw.close}, ${changeValue})</strong><br/>` +
                    `开盘价: <strong style="color:${color4};">${openChangePercent}% (${raw.open}, ${(raw.open - raw.prevClose).toFixed(2)})</strong><br/>` +
                    `最高价: <strong style="color:${color2};">${highChangePercent}% (${raw.high}, ${(raw.high - raw.prevClose).toFixed(2)})</strong><br/>` +
                    `最低价: <strong style="color:${color3};">${lowChangePercent}% (${raw.low}, ${(raw.low - raw.prevClose).toFixed(2)})</strong><br/>` ;
         }
                return data.fullName;
            }
        },
        xAxis: {
            type: 'category',
            data: categories,
            axisLabel: commonAxisOptions.axisLabel,
            axisLine: commonAxisOptions.axisLine
        },
        yAxis: {
            type: 'value',
            axisLabel: {
                formatter: '{value}%',  // 显示百分比符号
                fontSize: commonAxisOptions.axisLabel.fontSize,
                color: commonAxisOptions.axisLabel.color
            },
            axisLine: commonAxisOptions.axisLine,
            splitLine: commonAxisOptions.splitLine
        },
        // 数据缩放组件
        dataZoom: [
            { type: 'inside', start: 0, end: 100 },    // 内置缩放
            { start: 0, end: 100, height: 20 }         // 滑块缩放
        ],
        series: [{
            type: 'candlestick',  // K线图类型
            data: sortedData, 
            itemStyle: {
                color: '#ef4444',        // 阳线颜色（红）
                color0: '#22c55e',       // 阴线颜色（绿）
                borderColor: '#ef4444',  // 阳线边框
                borderColor0: '#22c55e'  // 阴线边框
            },
            // 标记点配置
            markPoint: {
                symbol: 'pin',           // 图钉样式
                symbolSize: 40,
                tooltip: { show: false },
                label: {
                    fontSize: 10,
                    formatter: function(params) {
                        if (typeof params.value === 'number') {
                            return params.value.toFixed(2) + '%';
                        }
                        return '';
                    }
                },
                data: markPointData
            }
        }]
    };
    
    // 保存配置并设置图表
    chartOptions.chart1 = option;
    chart1.setOption(option);
    bindChartClick(chart1);  // 绑定点击事件
}

// ==============================================
// 图表2：投机度与涨跌幅对比
// 使用柱状图展示投机度，折线图展示涨跌幅
// ==============================================
function renderChart2(dataList) {
    // 按涨跌幅降序排序
    dataList.sort((a, b) => b.zdf - a.zdf);
    const categories = dataList.map(item => getSimplifiedName(item.name));
    
    const option = {
        backgroundColor: 'transparent',
        tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(0,0,0,0.8)',
            textStyle: { color: '#fff' },
            formatter: function(params) {
                const originalName = params[0].data.fullName;
                let tooltipContent = originalName + '<br/>';
                params.forEach(function(item) {
                    tooltipContent += `${item.marker}${item.seriesName}: ${item.value}<br/>`;
                });
                return tooltipContent;
            }
        },
        legend: {
            data: ['投机度', '涨跌幅'],
            top: 10,
            textStyle: { color: '#333' }
        },
        xAxis: {
            type: 'category',
            data: categories,
            axisLabel: commonAxisOptions.axisLabel,
            axisLine: commonAxisOptions.axisLine
        },
        // 双Y轴配置
        yAxis: [
            {
                type: 'value',
                name: '投机度',
                position: 'left',
                axisLabel: commonAxisOptions.axisLabel,
                axisLine: commonAxisOptions.axisLine,
                splitLine: commonAxisOptions.splitLine
            },
            {
                type: 'value',
                name: '涨跌幅(%)',
                position: 'right',
                axisLabel: {
                    formatter: '{value}%',
                    fontSize: commonAxisOptions.axisLabel.fontSize,
                    color: commonAxisOptions.axisLabel.color
                },
                axisLine: commonAxisOptions.axisLine,
                splitLine: { show: false }  // 右轴不显示网格线
            }
        ],
        dataZoom: [
            { type: 'inside', start: 0, end: 100 },
            { start: 0, end: 100, height: 20 }
        ],
        series: [
            {
                name: '投机度',
                type: 'bar',
                yAxisIndex: 0,    // 使用左Y轴
                itemStyle: { color: '#3b82f6' },
                data: dataList.map(item => ({
                    value: item.tjd,
                    dm: item.dm,
                    name: getSimplifiedName(item.name),
                    fullName: item.name
                }))
            },
            {
                name: '涨跌幅',
                type: 'line',
                yAxisIndex: 1,    // 使用右Y轴
                itemStyle: { color: '#ef4444' },
                data: dataList.map(item => ({
                    value: item.zdf,
                    dm: item.dm,
                    name: getSimplifiedName(item.name),
                    fullName: item.name
                }))
            }
        ]
    };
    
    chartOptions.chart2 = option;
    chart2.setOption(option);
    bindChartClick(chart2);
}

// ==============================================
// 图表3：增仓率与涨跌幅对比
// 计算增仓率并与涨跌幅进行对比显示
// ==============================================
function renderChart3(dataList) {
    dataList.sort((a, b) => b.zdf - a.zdf);
    
    const option = {
        backgroundColor: 'transparent',
        tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(0,0,0,0.8)',
            textStyle: { color: '#fff' },
            formatter: function(params) {
                const originalName = params[0].data.fullName;
                let tooltipContent = originalName + '<br/>';
                params.forEach(function(item) {
                    tooltipContent += `${item.marker}${item.seriesName}: ${item.value}%<br/>`;
                });
                return tooltipContent;
            }
        },
        legend: {
            data: ['增仓率', '涨跌幅'],
            top: 10,
            textStyle: { color: '#333' }
        },
        xAxis: {
            type: 'category',
            data: dataList.map(item => getSimplifiedName(item.name)),
            axisLabel: commonAxisOptions.axisLabel,
            axisLine: commonAxisOptions.axisLine
        },
        yAxis: [
            {
                type: 'value',
                name: '增仓率(%)',
                position: 'left',
                axisLabel: {
                    formatter: '{value}%',
                    fontSize: commonAxisOptions.axisLabel.fontSize,
                    color: commonAxisOptions.axisLabel.color
                },
                axisLine: commonAxisOptions.axisLine,
                splitLine: commonAxisOptions.splitLine
            },
            {
                type: 'value',
                name: '涨跌幅(%)',
                position: 'right',
                axisLabel: {
                    formatter: '{value}%',
                    fontSize: commonAxisOptions.axisLabel.fontSize,
                    color: commonAxisOptions.axisLabel.color
                },
                axisLine: commonAxisOptions.axisLine,
                splitLine: { show: false }
            }
        ],
        dataZoom: [
            { type: 'inside', start: 0, end: 100 },
            { start: 0, end: 100, height: 20 }
        ],
        series: [
            {
                name: '增仓率',
                type: 'bar',
                yAxisIndex: 0,
                itemStyle: { color: '#06b6d4' },
                data: dataList.map(item => {
                    // 计算增仓率：日增仓 / 昨持仓量 * 100%
                    const divisor = item.ccl - item.rz;  // 昨日持仓量
                    const rate = divisor === 0 ? 0 : parseFloat(((item.rz / divisor) * 100).toFixed(2));
                    return {
                        value: rate,
                        dm: item.dm,
                        name: getSimplifiedName(item.name),
                        fullName: item.name
                    };
                })
            },
            {
                name: '涨跌幅',
                type: 'line',
                yAxisIndex: 1,
                itemStyle: { color: '#ef4444' },
                data: dataList.map(item => ({
                    value: item.zdf,
                    dm: item.dm,
                    name: getSimplifiedName(item.name),
                    fullName: item.name
                }))
            }
        ]
    };
    
    chartOptions.chart3 = option;
    chart3.setOption(option);
    bindChartClick(chart3);
}

// ==============================================
// 图表4：各周期涨跌幅对比
// 显示不同时间周期的涨跌幅变化趋势
// ==============================================
function renderChart4(dataList) {
    dataList.sort((a, b) => b.zdf - a.zdf);
    
    // 定义各个周期的配置
    const seriesConfig = [
        { name: '当日涨幅', field: 'zdf', color: '#ef4444' },
        { name: '3日涨幅', field: 'zdf3', color: '#22c55e' },
        { name: '5日涨幅', field: 'zdf5', color: '#3b82f6' },
        { name: '20日涨幅', field: 'zdf20', color: '#a855f7' },
        { name: '今年涨幅', field: 'zdfly', color: '#f59e0b' },
        { name: '250日涨幅', field: 'zdf250', color: '#14b8a6' }
    ];
    
    const option = {
        backgroundColor: 'transparent',
        tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(0,0,0,0.8)',
            textStyle: { color: '#fff' },
            formatter: function(params) {
                const originalName = params[0].data.fullName;
                let tooltipContent = originalName + '<br/>';
                params.forEach(function(item) {
                    tooltipContent += `${item.marker}${item.seriesName}: ${item.value}%<br/>`;
                });
                return tooltipContent;
            }
        },
        legend: {
            data: seriesConfig.map(s => s.name),
            top: 10,
            type: 'scroll',      // 图例过多时可滚动
            textStyle: { color: '#333' }
        },
        xAxis: {
            type: 'category',
            data: dataList.map(item => getSimplifiedName(item.name)),
            axisLabel: commonAxisOptions.axisLabel,
            axisLine: commonAxisOptions.axisLine
        },
        yAxis: {
            type: 'value',
            name: '涨跌幅(%)',
            axisLabel: {
                formatter: '{value}%',
                fontSize: commonAxisOptions.axisLabel.fontSize,
                color: commonAxisOptions.axisLabel.color
            },
            axisLine: commonAxisOptions.axisLine,
            splitLine: commonAxisOptions.splitLine
        },
        dataZoom: [
            { type: 'inside', start: 0, end: 100 },
            { start: 0, end: 100, height: 20 }
        ],
        // 根据配置动态创建多条折线
        series: seriesConfig.map(s => ({
            name: s.name,
            type: 'line',
            itemStyle: { color: s.color },
            data: dataList.map(item => ({
                value: item[s.field],
                dm: item.dm,
                name: getSimplifiedName(item.name),
                fullName: item.name
            })),
            smooth: true         // 平滑曲线
        }))
    };
    
    chartOptions.chart4 = option;
    chart4.setOption(option);
    bindChartClick(chart4);
}

// ==============================================
// 图表5：自定义指标对比
// 根据用户选择的两个指标进行对比展示
// ==============================================
function renderChart5(dataList, metric1, metric2) {
    // 数据验证
    if (dataList.length === 0) {
        chart5.clear();
        document.getElementById('main5').innerHTML = '<div class="no-data">暂无符合条件的数据</div>';
        return;
    } else {
        const main5Element = document.getElementById('main5');
        if (main5Element.innerHTML.includes('no-data') || main5Element.innerHTML.includes('error-message')) {
            main5Element.innerHTML = '';
        }
    }
    
    // 按第一个指标排序
    dataList.sort((a, b) => b[metric1] - a[metric1]);
    const categories = dataList.map(item => getSimplifiedName(item.name));
    const metric1Data = dataList.map(item => item[metric1]);
    const metric2Data = dataList.map(item => item[metric2]);
    
    // 检查指标数据是否存在
    if (metric1Data.some(val => val === undefined) || metric2Data.some(val => val === undefined)) {
        chart5.clear();
        document.getElementById('main5').innerHTML = 
            `<div class="error-message">指定的指标 (${fieldMapping[metric1]} 或 ${fieldMapping[metric2]}) 在数据中不存在</div>`;
        return;
    }
    
    // 更新图表标题
    const title = `${fieldMapping[metric1]}与${fieldMapping[metric2]}对比`;
    document.getElementById('chart5-title').textContent = title;
    
    const option = {
        backgroundColor: 'transparent',
        tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(0,0,0,0.8)',
            textStyle: { color: '#fff' },
            formatter: function(params) {
                const originalName = params[0].data.fullName;
                let tooltipContent = originalName + '<br/>';
                params.forEach(function(item) {
                    let value = item.value;
                    // 根据指标类型格式化数值
                    if (item.seriesName.includes('涨幅') || item.seriesName.includes('率')) {
                        value = value.toFixed(2) + '%';
                    } else if (item.seriesName.includes('成交额') || item.seriesName.includes('沉淀资金')) {
                        value = formatCjeToBillion(value);
                    } else if (typeof value === 'number') {
                        value = value.toFixed(2);
                    }
                    tooltipContent += `${item.marker}${item.seriesName}: ${value}<br/>`;
                });
                return tooltipContent;
            }
        },
        legend: {
            data: [fieldMapping[metric1], fieldMapping[metric2]],
            top: 10,
            textStyle: { color: '#333' }
        },
        xAxis: {
            type: 'category',
            data: categories,
            axisLabel: commonAxisOptions.axisLabel,
            axisLine: commonAxisOptions.axisLine
        },
        yAxis: [
            {
                type: 'value',
                name: fieldMapping[metric1],
                position: 'left',
                axisLabel: {
                    formatter: function (value) { return value.toFixed(2); },
                    fontSize: commonAxisOptions.axisLabel.fontSize,
                    color: commonAxisOptions.axisLabel.color
                },
                axisLine: commonAxisOptions.axisLine,
                splitLine: commonAxisOptions.splitLine
            },
            {
                type: 'value',
                name: fieldMapping[metric2],
                position: 'right',
                axisLabel: {
                    formatter: function (value) { return value.toFixed(2); },
                    fontSize: commonAxisOptions.axisLabel.fontSize,
                    color: commonAxisOptions.axisLabel.color
                },
                axisLine: commonAxisOptions.axisLine,
                splitLine: { show: false }
            }
        ],
        dataZoom: [
            { type: 'inside', start: 0, end: 100 },
            { start: 0, end: 100, height: 20 }
        ],
        series: [
            {
                name: fieldMapping[metric1],
                type: 'bar',
                yAxisIndex: 0,
                itemStyle: { color: '#8b5cf6' },
                data: dataList.map(item => ({
                    value: item[metric1],
                    dm: item.dm,
                    name: getSimplifiedName(item.name),
                    fullName: item.name
                }))
            },
            {
                name: fieldMapping[metric2],
                type: 'line',
                yAxisIndex: 1,
                itemStyle: { color: '#f59e0b' },
                lineStyle: { width: 2 },
                data: dataList.map(item => ({
                    value: item[metric2],
                    dm: item.dm,
                    name: getSimplifiedName(item.name),
                    fullName: item.name
                }))
            }
        ]
    };
    
    chartOptions.chart5 = option;
    chart5.setOption(option);
    bindChartClick(chart5);
}

// ==============================================
// 颜色工具函数
// 根据数据值返回相应的颜色
// ==============================================

/**
 * 根据涨跌幅返回相应颜色
 * @param {number} zdf - 涨跌幅百分比
 * @returns {string} 颜色代码
 */
function getZdfTreemapColor(zdf) {
    const abs = Math.abs(zdf);
    if (zdf <= 0) {
        // 下跌颜色（绿色系）
        if (abs >= 5) return '#006400'; // 深绿
        if (abs >= 2) return '#22c55e'; // 绿色
        if (abs >= 1) return '#66bb6a'; // 浅绿
        return '#86efac';               // 很浅的绿
    } else {
        // 上涨颜色（红色系）
        if (abs >= 5) return '#8b0000'; // 深红
        if (abs >= 2) return '#ef4444'; // 红色
        if (abs >= 1) return '#ff8888'; // 浅红
        return '#fca5a5';               // 很浅的红
    }
}

/**
 * 根据增仓情况返回相应颜色
 * @param {number} rz - 日增仓量
 * @returns {string} 颜色代码
 */
function getOpenInterestChangeColor(rz) {
    if (rz > 0) return '#ef4444';   // 增仓：红色
    if (rz < 0) return '#22c55e';   // 减仓：绿色
    return '#9ca3af';               // 无变化：灰色
}

// ==============================================
// 图表6：品种涨跌图（树状图）
// 根据选择的指标以树状图形式展示品种分布
// ==============================================
function renderChart6(dataList) {
    let treemapData;
    let legendDataFunction = updateTreemapLegendZdf; // 默认图例函数

    // 根据当前选择的指标进行数据处理
    if (chart6Metric === 'volumeAnalysis') {
        // 成交量分析模式
        treemapData = dataList.filter(item => 
            typeof item.vol === 'number' && item.vol > 0 && typeof item.rz === 'number'
        );
        if (treemapData.length > 0) {
            treemapData.sort((a, b) => b.vol - a.vol); // 按成交量排序
        }
        legendDataFunction = updateTreemapLegendVolume;
        
    } else if (chart6Metric === 'oiAnalysis') {
        // 持仓量分析模式
        treemapData = dataList.filter(item => 
            typeof item.ccl === 'number' && typeof item.rz === 'number'
        );
        if (treemapData.length > 0) {
            treemapData.sort((a, b) => b.ccl - a.ccl); // 按持仓量排序
        }
        legendDataFunction = updateTreemapLegendOi;
        
    } else { 
        // 默认模式：成交额或沉淀资金
        treemapData = dataList.filter(item => 
            item.cje > 10 * 1e8 && item.hasOwnProperty('cdzj') && typeof item.zdf === 'number'
        );
        if (treemapData.length > 0) {
            treemapData.sort((a, b) => b[chart6Metric] - a[chart6Metric]);
        }
    }

    // 数据验证
    if (treemapData.length === 0) {
        chart6.clear();
        document.getElementById('main6').innerHTML = '<div class="no-data">暂无符合条件的品种数据</div>';
        document.getElementById('main6-treemap-legend').innerHTML = '';
        return;
    } else {
        const main6Element = document.getElementById('main6');
        if (main6Element.innerHTML.includes('no-data') || main6Element.innerHTML.includes('error-message')) {
            main6Element.innerHTML = '';
        }
    }

    // 构建树状图数据
    const treemapSeriesData = treemapData.map(item => {
        let value, color, labelFormatter, tooltipFormatterParams;

        if (chart6Metric === 'oiAnalysis') {
            // 持仓量分析模式
            value = Math.abs(item.ccl);
            color = getOpenInterestChangeColor(item.rz);
            const prevCcl = item.ccl - item.rz;
            let rzRatio = 0;
            if (prevCcl !== 0) {
                rzRatio = (item.rz / prevCcl) * 100;
            }
            
            tooltipFormatterParams = {
                fullName: item.name,
                ccl: item.ccl ? item.ccl.toLocaleString() : '-',
                rz: item.rz ? item.rz.toLocaleString() : '-',
                rzRatio: rzRatio.toFixed(2) + '%',
                metricType: 'oiAnalysis'
            };

            labelFormatter = function(params) {
                const cclFormatted = params.data.ccl ? (params.data.ccl / 10000).toFixed(2) + '万手' : '-';
                const rz = params.data.rz;
                const ccl = params.data.ccl;
                let rzText = '';
                if (typeof rz === 'number' && typeof ccl === 'number') {
                    const prevCcl = ccl - rz;
                    let rzRatio = 0;
                    if (prevCcl !== 0) {
                        rzRatio = (rz / prevCcl) * 100;
                    }
                    rzText = `\n增仓: ${rz.toLocaleString()} (${rzRatio.toFixed(1)}%)`;
                }
                return `${params.name}\n${cclFormatted}${rzText}`;
            };

        } else if (chart6Metric === 'volumeAnalysis') {
            // 成交量分析模式
            value = Math.abs(item.vol);
            color = getOpenInterestChangeColor(item.rz);
            
            tooltipFormatterParams = {
                fullName: item.name,
                vol: item.vol ? item.vol.toLocaleString() + '手' : '-',
                rz: item.rz ? item.rz.toLocaleString() : '-',
                metricType: 'volumeAnalysis'
            };

            labelFormatter = function(params) {
                const volFormatted = params.data.vol ? (params.data.vol / 10000).toFixed(2) + '万手' : '-';
                const rz = params.data.rz;
                const ccl = params.data.ccl;
                let rzText = '';
                if (typeof rz === 'number' && typeof ccl === 'number') {
                    const prevCcl = ccl - rz;
                    let rzRatio = 0;
                    if (prevCcl !== 0) {
                        rzRatio = (rz / prevCcl) * 100;
                    }
                    rzText = `\n增仓: ${rz.toLocaleString()} (${rzRatio.toFixed(1)}%)`;
                }
                return `${params.name}\n${volFormatted}${rzText}`;
            };

        } else { 
            // 默认模式：成交额或沉淀资金
            value = item[chart6Metric];
            color = getZdfTreemapColor(item.zdf);
            tooltipFormatterParams = {
                fullName: item.name,
                cje: formatCjeToBillion(item.cje),
                cdzj: formatCjeToBillion(item.cdzj),
                zdf: item.zdf ? item.zdf.toFixed(2) + '%' : '0.00%',
                metricType: chart6Metric
            };
            labelFormatter = function(params) {
                const metricValueFormatted = formatCjeToBillion(params.data.value);
                const zdfFormatted = params.data.zdf ? params.data.zdf.toFixed(2) + '%' : '0.00%';
                return `${params.name}\n${metricValueFormatted}\n${zdfFormatted}`;
            };
        }

        return {
            name: getSimplifiedName(item.name),
            value: value,
            dm: item.dm,
            fullName: item.name,
            // 存储相关数据用于tooltip/标签
            zdf: item.zdf,
            cje: item.cje,
            cdzj: item.cdzj,
            ccl: item.ccl,
            rz: item.rz,
            vol: item.vol,
            rzRatio: chart6Metric === 'oiAnalysis' ? tooltipFormatterParams.rzRatio : undefined,
            itemStyle: {
                color: color,
                borderColor: '#fff',
                borderWidth: 1
            },
            label: {
                show: true,
                position: 'inside',
                color: '#fff',
                fontSize: 12,
                formatter: labelFormatter,
                rich: {
                    name: { fontSize: 13, fontWeight: 'bold' },
                    value: { fontSize: 11 },
                    metric: { fontSize: 11 }
                },
                overflow: 'truncate',
                width: '90%',
                height: '90%',
                lineHeight: 14
            }
        };
    });

    const option = {
        backgroundColor: 'transparent',
        tooltip: {
            trigger: 'item',
            backgroundColor: 'rgba(0,0,0,0.8)',
            textStyle: { color: '#fff' },
            formatter: function(params) {
                if (!params.data) return '';
                const data = params.data;
                
                if (data.metricType === 'oiAnalysis') {
                     return `${data.fullName}<br/>` +
                            `持仓量: ${data.ccl ? data.ccl.toLocaleString() : '-'}<br/>` +
                            `日增仓: ${data.rz ? data.rz.toLocaleString() : '-'}<br/>` +
                            `增仓比: ${data.rzRatio || '0.00%'}`;
                } else if (data.metricType === 'volumeAnalysis') {
                    return `${data.fullName}<br/>` +
                           `成交量: ${data.vol ? data.vol.toLocaleString() + '手' : '-'}<br/>` +
                           `日增仓: ${data.rz ? data.rz.toLocaleString() : '-'}`;
                } else {
                    return `${data.fullName}<br/>` +
                           `成交额: ${formatCjeToBillion(data.cje)}<br/>` +
                           `沉淀资金: ${formatCjeToBillion(data.cdzj)}<br/>` +
                           `涨跌幅: ${data.zdf ? data.zdf.toFixed(2) + '%' : '0.00%'}`;
                }
            }
        },
        series: [{
            type: 'treemap',
            width: '100%',
            height: '100%',
            roam: false,         // 禁用漫游
            nodeClick: false,    // 禁用节点点击
            breadcrumb: { show: false },
            data: treemapSeriesData,
            levels: [
                {
                    itemStyle: { borderWidth: 1, borderColor: '#fff' },
                    upperLabel: { show: false }
                }
            ]
        }]
    };
    
    chartOptions.chart6 = option;
    chart6.setOption(option, true);
    bindChartClick(chart6);
    legendDataFunction(treemapData); // 调用相应的图例函数
}

// ==============================================
// 图表7：涨跌幅与增仓比关系图（散点图）
// 展示品种涨跌幅和增仓比的关系，气泡大小表示其他指标
// ==============================================
function renderChart7(dataList) {
    // 指标维度映射：用于从数据数组中取值
    const metricDimensionMap = {
        'cdzj': 2,  // 沉淀资金在value数组的索引
        'cje': 3,   // 成交额在value数组的索引
        'vol': 4,   // 成交量在value数组的索引
        'ccl': 5    // 持仓量在value数组的索引
    };

    // 指标格式化函数映射
    const metricFormatterMap = {
        'cdzj': formatCjeToBillion,
        'cje': formatCjeToBillion,
        'vol': formatVolumeOrCCL,
        'ccl': formatVolumeOrCCL
    };

    let minSizeMetric = Infinity;
    let maxSizeMetric = -Infinity;

    // 数据预处理
    const scatterData = dataList.map(item => {
        // 计算增仓比
        const prevCcl = item.ccl - item.rz;
        const rzRatio = prevCcl === 0 ? 0 : parseFloat(((item.rz / prevCcl) * 100).toFixed(2));
        
        // 获取各项指标数值
        const cdzjVal = item.cdzj || 0;
        const cjeVal = item.cje || 0;
        const volVal = item.vol || 0;
        const cclVal = item.ccl || 0;

        // 计算当前选择指标的最值，用于气泡大小映射
        const currentSizeMetricValue = item[chart7SizeMetric] || 0;
        if (currentSizeMetricValue < minSizeMetric) minSizeMetric = currentSizeMetricValue;
        if (currentSizeMetricValue > maxSizeMetric) maxSizeMetric = currentSizeMetricValue;

        return {
            name: getSimplifiedName(item.name),
            fullName: item.name,
            dm: item.dm,
            cdzj: cdzjVal,
            cje: cjeVal,
            vol: volVal,
            ccl: cclVal,
            // value数组：[涨跌幅, 增仓比, 沉淀资金, 成交额, 成交量, 持仓量]
            value: [item.zdf, rzRatio, cdzjVal, cjeVal, volVal, cclVal] 
        };
    }).filter(item => item.value[0] !== undefined && item.value[1] !== undefined);

    // 数据验证
    if (scatterData.length === 0) {
        chart7.clear();
        document.getElementById('main7').innerHTML = '<div class="no-data">暂无符合条件的数据</div>';
        return;
    }
    
    const option = {
        backgroundColor: 'transparent',
        tooltip: {
            trigger: 'item',
            backgroundColor: 'rgba(0,0,0,0.8)',
            textStyle: { color: '#fff' },
            formatter: function(params) {
                const data = params.data;
                const zdf = data.value[0];
                const rzRatio = data.value[1];
                const color = zdf >= 0 ? '#ef4444' : '#22c55e';
                const rzColor = rzRatio >= 0 ? '#ef4444' : '#22c55e';
                
                let tooltipContent = `<strong style="font-size: 16px; font-weight: bold;">${data.fullName}</strong><br/>` +
                       `涨跌幅: <strong style="color:${color};">${zdf.toFixed(2)}%</strong><br/>` +
                       `增仓比: <strong style="color:${rzColor};">${rzRatio.toFixed(2)}%</strong><br/>`;

                // 添加当前选择的指标信息
                const currentSizeMetricDisplayName = fieldMapping[chart7SizeMetric];
                const currentSizeMetricRawValue = data[chart7SizeMetric];
                const formatterFn = metricFormatterMap[chart7SizeMetric];
                const formattedValue = formatterFn ? formatterFn(currentSizeMetricRawValue) : currentSizeMetricRawValue;

                tooltipContent += `${currentSizeMetricDisplayName}: ${formattedValue}`;
                return tooltipContent;
            }
        },
        grid: {
            left: '10%',
            right: '10%',
            bottom: '15%',
            top: '10%'
        },
        xAxis: {
            type: 'value',
            name: '涨跌幅 (%)',
            nameLocation: 'middle',
            nameGap: 25,
            splitLine: { lineStyle: { type: 'dashed' } },
            axisLabel: { formatter: '{value}%' }
        },
        yAxis: {
            type: 'value',
            name: '增仓比 (%)',
            nameLocation: 'middle',
            nameGap: 45,
            splitLine: { lineStyle: { type: 'dashed' } },
            axisLabel: { formatter: '{value}%' }
        },
        dataZoom: [
            { type: 'inside', xAxisIndex: 0, yAxisIndex: 0 },
            { type: 'slider', xAxisIndex: 0, yAxisIndex: 0, height: 20 }
        ],
        // 视觉映射：根据选择的指标控制气泡大小
        visualMap: {
            type: 'continuous',
            dimension: metricDimensionMap[chart7SizeMetric], // 使用对应维度
            min: minSizeMetric,
            max: maxSizeMetric,
            show: false,          // 不显示视觉映射组件
            inRange: {
                symbolSize: [30, 100] // 气泡大小范围
            }
        },
        series: [{
            type: 'scatter',
            data: scatterData,
            itemStyle: {
                // 根据涨跌幅和增仓比组合确定颜色
                color: function(params) {
                    const zdf = params.data.value[0];
                    const rzRatio = params.data.value[1];
                    if (zdf > 0 && rzRatio > 0) return '#d92420'; // 强红：增仓上涨（最强）
                    if (zdf < 0 && rzRatio < 0) return '#00a65a'; // 强绿：减仓下跌（最弱）
                    if (zdf > 0 && rzRatio < 0) return '#f39c12'; // 橙黄：减仓上涨（多头离场）
                    if (zdf < 0 && rzRatio > 0) return '#0073b7'; // 亮蓝：增仓下跌（空头加仓）
                    return '#95a5a6';                             // 中性灰
                },
                opacity: 0.8,
                borderColor: 'rgba(255, 255, 255, 0.5)',
                borderWidth: 2
            },
            label: {
                show: true, 
                position: 'inside', 
                formatter: '{b}',     // 显示品种简称
                fontSize: 11,
                color: '#fff',
                fontWeight: 'bold'
            },
            emphasis: {
                focus: 'series', 
                label: {
                    show: true, 
                    position: 'top', 
                    formatter: '{b}',
                    fontSize: 12,
                    fontWeight: 'bold',
                    color: '#000' 
                }
            },
            labelLayout: { 
                hideOverlap: true    // 隐藏重叠标签
            }
        }]
    };

    chartOptions.chart7 = option;
    chart7.setOption(option, true);
    bindChartClick(chart7);
}

// ==============================================
// 图表8：品种涨跌幅区间统计（饼图）
// 统计并展示不同涨跌幅区间的品种分布
// ==============================================
function renderChart8(dataList) {
    // 初始化各个涨跌幅区间的计数器
    const counts = {
        'zt': { count: 0, color: '#FF4500', label: '涨停' },          // 橙红色
        'zdf_gt_5': { count: 0, color: '#DC143C', label: '上涨 > 5%' }, // 深红色
        'zdf_2_5': { count: 0, color: '#FF6347', label: '上涨 2-5%' },  // 番茄色
        'zdf_0_2': { count: 0, color: '#FFA07A', label: '上涨 0-2%' },  // 浅鲑鱼色
        'flat': { count: 0, color: '#808080', label: '平盘' },         // 灰色
        'zdf_neg_0_2': { count: 0, color: '#98FB98', label: '下跌 0-2%' }, // 浅绿色
        'zdf_neg_2_5': { count: 0, color: '#32CD32', label: '下跌 2-5%' }, // 酸橙绿
        'zdf_neg_gt_5': { count: 0, color: '#008000', label: '下跌 > 5%' }, // 绿色
        'dt': { count: 0, color: '#006400', label: '跌停' }           // 深绿色
    };

    // 统计上涨和下跌品种的数量及涨跌幅总和（用于计算平均值）
    let totalRiseCount = 0;
    let sumRiseZdf = 0;
    let totalFallCount = 0;
    let sumFallZdf = 0;

    // 遍历数据进行分类统计
    dataList.forEach(item => {
        const zdf = item.zdf;
        const isZT = item.zt === 1;  // 是否涨停
        const isDT = item.dt === 1;  // 是否跌停

        // 按涨跌幅区间分类
        if (isZT) {
            counts['zt'].count++;
        } else if (isDT) {
            counts['dt'].count++;
        } else if (zdf > 5) {
            counts['zdf_gt_5'].count++;
        } else if (zdf > 2 && zdf <= 5) {
            counts['zdf_2_5'].count++;
        } else if (zdf > 0 && zdf <= 2) {
            counts['zdf_0_2'].count++;
        } else if (zdf === 0) {
             counts['flat'].count++;
        } else if (zdf < 0 && zdf >= -2) {
            counts['zdf_neg_0_2'].count++;
        } else if (zdf < -2 && zdf >= -5) {
            counts['zdf_neg_2_5'].count++;
        } else if (zdf < -5) {
            counts['zdf_neg_gt_5'].count++;
        }

        // 统计总体上涨/下跌情况
        if (typeof zdf === 'number') {
            if (zdf > 0) {
                totalRiseCount++;
                sumRiseZdf += zdf;
            } else if (zdf < 0) {
                totalFallCount++;
                sumFallZdf += zdf; // 累加负值
            }
        }
    });

    // 计算平均涨跌幅
    const avgRiseZdf = totalRiseCount > 0 ? (sumRiseZdf / totalRiseCount).toFixed(2) : '0.00';
    const displayAvgFallZdf = totalFallCount > 0 ? (Math.abs(sumFallZdf) / totalFallCount).toFixed(2) : '0.00';

    // 过滤掉计数为0的分类（平盘除外，始终显示）
    const chartData = Object.keys(counts)
        .filter(key => counts[key].count > 0 || key === 'flat')
        .map(key => ({
            name: counts[key].label,
            value: counts[key].count,
            itemStyle: { color: counts[key].color }
        }));

    // 按预定义顺序排序
    const order = [
        '涨停', '上涨 > 5%', '上涨 2-5%', '上涨 0-2%', 
        '平盘', 
        '下跌 0-2%', '下跌 2-5%', '下跌 > 5%', '跌停'
    ];
    chartData.sort((a, b) => order.indexOf(a.name) - order.indexOf(b.name));

    // 数据验证
    if (chartData.length === 0) {
        chart8.clear();
        document.getElementById('main8').innerHTML = '<div class="no-data">暂无符合条件的品种数据</div>';
        return;
    } else {
        const main8Element = document.getElementById('main8');
        if (main8Element.innerHTML.includes('no-data') || main8Element.innerHTML.includes('error-message')) {
            main8Element.innerHTML = '';
        }
    }

    const option = {
        backgroundColor: 'transparent',
        tooltip: {
            trigger: 'item',
            formatter: '{b}: {c} 个 ({d}%)' // 显示名称、数量和百分比
        },
        legend: {
            orient: 'vertical',   // 垂直排列
            left: 'left',        // 靠左显示
            data: chartData.map(item => item.name),
            textStyle: { color: '#333' }
        },
        // 在图表中心显示统计信息
        graphic: [
            {
                type: 'text',
                left: '50%',
                top: '40%',
                style: {
                    text: `上涨：${totalRiseCount}个`,
                    fill: '#ef4444',
                    fontSize: 13,
                    fontWeight: 'bold',
                    textAlign: 'center'
                },
                onclick: function() {
                    window.open('https://wealth.want.biz/pages/ygs.html', '_blank');
                },
                cursor: 'pointer' 
            },
            {
                type: 'text',
                left: '50%',
                top: '45%',
                style: {
                    text: `均涨：${avgRiseZdf}%`,
                    fill: '#ef4444',
                    fontSize: 13,
                    textAlign: 'center'
                }
            },
            {
                type: 'text',
                left: '50%',
                top: '52%',
                style: {
                    text: `下跌：${totalFallCount}个`,
                    fill: '#22c55e',
                    fontSize: 13,
                    fontWeight: 'bold',
                    textAlign: 'center'
                },
                onclick: function() {
                    window.open('https://wealth.want.biz/pages/ygs.html', '_blank');
                },
                cursor: 'pointer' 
            },
            {
                type: 'text',
                left: '50%',
                top: '57%',
                style: {
                    text: `均跌：${displayAvgFallZdf}%`,
                    fill: '#22c55e',
                    fontSize: 13,
                    textAlign: 'center'
                }
            }
        ],
        series: [
            {
                name: '品种数量',
                type: 'pie',
                radius: ['40%', '70%'],  // 甜甜圈图
                center: ['55%', '50%'],  // 调整中心位置，为图例和中心文字留空间
                avoidLabelOverlap: false,
                label: {
                    show: true,
                    position: 'outer',   // 标签显示在外部
                    formatter: '{b}\n{c} ({d}%)', // 显示名称、数量和百分比
                    color: '#333',
                    fontSize: 12,
                    fontWeight: 'bold', 
                    overflow: 'breakAll', 
                    minMargin: 5 
                },
                labelLine: {
                    show: true,
                    length: 10,  
                    length2: 15, 
                    smooth: true 
                },
                data: chartData,
                emphasis: {
                    itemStyle: {
                        shadowBlur: 10,
                        shadowOffsetX: 0,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                }
            }
        ]
    };
    
    chartOptions.chart8 = option;
    chart8.setOption(option, true);
}

// ==============================================
// 树状图图例更新函数
// 为不同模式的树状图生成相应的图例
// ==============================================

/**
 * 更新涨跌幅模式的树状图图例
 * 显示涨幅前三和跌幅前三的品种
 */
function updateTreemapLegendZdf(data) {
    const legendContainer = document.getElementById('main6-treemap-legend');
    let html = '';
    
    // 获取涨幅前三的品种
    const topGainers = [...data].sort((a, b) => b.zdf - a.zdf).filter(item => item.zdf > 0).slice(0, 3);
    // 获取跌幅前三的品种
    const topLosers = [...data].sort((a, b) => a.zdf - b.zdf).filter(item => item.zdf < 0).slice(0, 3);
    
    // 生成涨幅图例
    topGainers.forEach(item => {
        html += `
            <div class="item">
                <span class="dot red"></span>
                <span class="label">${getSimplifiedName(item.name)}:</span>
                <span class="value red">${item.zdf.toFixed(2)}%</span>
            </div>`;
    });
    
    // 添加分隔符
    if (topGainers.length > 0 && topLosers.length > 0) html += `<div> </div>`;
    
    // 生成跌幅图例
    topLosers.forEach(item => {
        html += `
            <div class="item">
                <span class="dot green"></span>
                <span class="label">${getSimplifiedName(item.name)}:</span>
                <span class="value green">${item.zdf.toFixed(2)}%</span>
            </div>`;
    });
    
    legendContainer.innerHTML = html;
}

/**
 * 更新成交量模式的树状图图例
 * 显示增仓和减仓的成交量前三品种
 */
function updateTreemapLegendVolume(data) {
    const legendContainer = document.getElementById('main6-treemap-legend');
    let html = '';
    
    // 获取增仓前三的品种（按成交量）
    const topVolumeIncrease = [...data].sort((a, b) => b.rz - a.rz).filter(item => item.rz > 0).slice(0, 3);
    // 获取减仓前三的品种（按成交量）
    const topVolumeDecrease = [...data].sort((a, b) => a.rz - b.rz).filter(item => item.rz < 0).slice(0, 3);

    topVolumeIncrease.forEach(item => {
        html += `
            <div class="item">
                <span class="dot red"></span>
                <span class="label">${getSimplifiedName(item.name)} (增仓):</span>
                <span class="value red">${item.vol.toLocaleString()}手 (rz ${item.rz.toLocaleString()})</span>
            </div>`;
    });

    if (topVolumeIncrease.length > 0 && topVolumeDecrease.length > 0) html += `<div style="margin: 2px 0;"> </div>`;

    topVolumeDecrease.forEach(item => {
        html += `
            <div class="item">
                <span class="dot green"></span>
                <span class="label">${getSimplifiedName(item.name)} (减仓):</span>
                <span class="value green">${item.vol.toLocaleString()}手 (rz ${item.rz.toLocaleString()})</span>
            </div>`;
    });
    
    legendContainer.innerHTML = html;
}

/**
 * 更新持仓量模式的树状图图例
 * 显示增仓和减仓的持仓量前三品种
 */
function updateTreemapLegendOi(data) {
    const legendContainer = document.getElementById('main6-treemap-legend');
    let html = '';
    
    // 获取增仓前三的品种
    const topIncreases = [...data].sort((a, b) => b.rz - a.rz).filter(item => item.rz > 0).slice(0, 3);
    // 获取减仓前三的品种  
    const topDecreases = [...data].sort((a, b) => a.rz - b.rz).filter(item => item.rz < 0).slice(0, 3);

    topIncreases.forEach(item => {
        const prevCcl = item.ccl - item.rz;
        let rzRatioText = '-';
        if (prevCcl !== 0) {
            rzRatioText = ((item.rz / prevCcl) * 100).toFixed(2) + '%';
        }
        html += `
            <div class="item">
                <span class="dot red"></span>
                <span class="label">${getSimplifiedName(item.name)} (增仓):</span>
                <span class="value red">${item.rz.toLocaleString()} (${rzRatioText})</span>
            </div>`;
    });

    if (topIncreases.length > 0 && topDecreases.length > 0) html += `<div style="margin: 2px 0;"> </div>`;

    topDecreases.forEach(item => {
        const prevCcl = item.ccl - item.rz;
        let rzRatioText = '-';
        if (prevCcl !== 0) {
            rzRatioText = ((item.rz / prevCcl) * 100).toFixed(2) + '%';
        }
        html += `
            <div class="item">
                <span class="dot green"></span>
                <span class="label">${getSimplifiedName(item.name)} (减仓):</span>
                <span class="value green">${item.rz.toLocaleString()} (${rzRatioText})</span>
            </div>`;
    });
    
    legendContainer.innerHTML = html;
}

// ==============================================
// 图表交互功能
// 处理图表点击事件和下载功能
// ==============================================

/**
 * 为图表绑定点击事件监听器
 * 点击图表中的数据项时跳转到对应的品种详情页面
 * @param {Object} chart - ECharts图表实例
 */
 function bindChartClick(chart) {
    // 移除已存在的点击事件监听器，避免重复绑定
    chart.off('click');

    // 绑定新的点击事件监听器
    chart.on('click', function(params) {
        // 检查点击的数据项是否包含品种代码
        if (params.data && params.data.dm) {
            const dm = params.data.dm;

            // 提取品种代码的字母部分（去除数字）
            // 例如：'CU2101' -> 'CU', 'RB2005' -> 'RB'
            const codeWithoutNumbers = dm.replace(/\d+/g, '');

            // 构建跳转URL，跳转到品种多空分析页面
            const url = `https://wealth.want.biz/v1/longshort.html?variety=${codeWithoutNumbers}`;

            // 在新标签页中打开链接
            window.open(url, '_blank');
        }
    });
}

/**
 * 下载图表为PNG图片
 * @param {Object} chartInstance - ECharts图表实例
 * @param {string} fileName - 下载的文件名
 */
function downloadChart(chartInstance, fileName) {
    // 获取图表的数据URL，设置白色背景和高分辨率
    const url = chartInstance.getDataURL({ 
        backgroundColor: '#fff',  // 白色背景
        pixelRatio: 2            // 2倍像素比，提高清晰度
    });
    
    // 创建临时下载链接
    const link = document.createElement('a');
    link.href = url;
    link.download = fileName;
    link.click(); // 触发下载
}

// ==============================================
// 自动刷新控制功能
// 管理数据的自动刷新机制
// ==============================================

/**
 * 切换自动刷新功能的开启/关闭状态
 * 更新按钮文本和样式，启动或停止自动刷新
 */
function toggleAutoRefresh() {
    autoRefresh = !autoRefresh; // 切换状态
    const btn = document.getElementById('auto-refresh-btn');
    
    if (autoRefresh) {
        // 开启自动刷新
        btn.textContent = '⏱️ 自动刷新: 开启';
        btn.classList.remove('secondary');  // 移除次要样式
        startAutoRefresh();
    } else {
        // 关闭自动刷新
        btn.textContent = '⏱️ 自动刷新: 关闭';
        btn.classList.add('secondary');     // 添加次要样式
        stopAutoRefresh();
    }
}

/**
 * 启动自动刷新机制
 * 每15秒自动获取一次新数据（仅在交易时段内）
 */
 function startAutoRefresh() {
    // 清除已存在的定时器，避免重复创建
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }

    // 创建新的定时器，每15秒执行一次
    refreshInterval = setInterval(() => {
        // 检查自动刷新开关和交易时段状态
        if (autoRefresh && getSessionType() !== 'closed') {
            fetchData(); // 获取新数据
        }
    }, 15000); // 15秒间隔
}

/**
 * 停止自动刷新机制
 * 清除定时器并重置相关变量
 */
function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
}

// ==============================================
// 自定义指标应用功能
// 处理用户在设置菜单中选择的自定义指标
// ==============================================

/**
 * 应用用户选择的自定义指标设置
 * 重新渲染图表5以显示新的指标组合
 */
function applyCustomMetrics() {
    if (currentData.length > 0) {
        // 获取用户选择的两个指标
        const metric1 = document.getElementById('metric1-select').value || 'cdzj';
        const metric2 = document.getElementById('metric2-select').value || 'tjd';
        
        // 重新渲染自定义指标对比图
        renderChart5([...currentData], metric1, metric2);
    }
}

// ==============================================
// 全屏功能实现
// 为所有图表添加全屏查看功能
// ==============================================

/**
 * 为所有全屏按钮添加事件监听器
 * 实现图表的全屏显示和退出功能
 */
function addFullscreenListeners() {
    // 为所有全屏按钮绑定点击事件
    document.querySelectorAll('.fullscreen-btn').forEach(button => {
        button.addEventListener('click', () => {
            // 获取按钮所在的图表容器
            const chartContainer = button.closest('.chart-container');
            
            if (!document.fullscreenElement) {
                // 当前没有全屏元素，进入全屏
                if (chartContainer.requestFullscreen) {
                    chartContainer.requestFullscreen();
                } else if (chartContainer.webkitRequestFullscreen) {
                    // Safari浏览器兼容
                    chartContainer.webkitRequestFullscreen();
                } else if (chartContainer.msRequestFullscreen) {
                    // IE浏览器兼容
                    chartContainer.msRequestFullscreen();
                }
            } else if (document.fullscreenElement === chartContainer) {
                // 当前容器已全屏，退出全屏
                document.exitFullscreen();
            }
        });
    });
    
    // 监听全屏状态变化事件
    document.addEventListener('fullscreenchange', () => {
        if (document.fullscreenElement) {
            // 进入全屏模式
            const chartContainer = document.fullscreenElement;
            const chartVarName = chartContainer.dataset.chartVar; // 获取图表变量名
            const chartInstance = window[chartVarName];           // 获取对应的图表实例
            
            // 延迟调整图表尺寸，确保容器尺寸已更新
            setTimeout(() => {
                if (chartInstance) chartInstance.resize();
            }, 150);
            
            // 更新全屏按钮文本
            const btn = chartContainer.querySelector('.fullscreen-btn');
            if (btn) btn.textContent = '退出全屏';
            
        } else {
            // 退出全屏模式
            setTimeout(() => {
                // 调整所有图表的尺寸
                ['chart1','chart2','chart3','chart4','chart5','chart6','chart7','chart8'].forEach(chartVar => { 
                    const chartInstance = window[chartVar];
                    if (chartInstance) chartInstance.resize();
                });
                
                // 恢复所有全屏按钮的文本
                document.querySelectorAll('.fullscreen-btn').forEach(btn => btn.textContent = '全屏');
            }, 150);
        }
    });
    
    // 初始化所有全屏按钮的文本
    document.querySelectorAll('.fullscreen-btn').forEach(button => {
        button.textContent = '全屏';
    });
}

// ==============================================
// 文档结束标记
// JavaScript代码到此结束
// ==============================================

</script>

</body>
</html>