<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>期货市场概览</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <style>
    /* CSS变量定义 */
    :root {
      /* 亮色主题变量 */
      --header-bg: #a18cd1;
      --header-bg-end: #fbc2eb;
      --bg-color: #f0f1f8;
      --text-color: #333;
      --text-secondary: #666;
      --text-tertiary: #777;
      --positive-color: #ff7675;
      --negative-color: #55efc4;
      --neutral-color: #a29bfe;
      --border-color: #ddd;
      --card-bg: #ffffff;
      --card-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      --card-hover-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      --button-bg: rgba(255, 255, 255, 0.25);
      --button-hover-bg: rgba(255, 255, 255, 0.35);
      --button-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      --button-hover-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      --chart-grid-line: #eee;
      --progress-bg: #f0f0f0;
      --table-header-bg: #f8f9fa;
      --table-border: #eee;
      --table-hover-bg: #f5f5f5;
      --error-bg: rgba(255, 118, 117, 0.1);
      --error-color: #ff7675;
      --warning-color: #ff9800;
      --warning-bg: rgba(255, 193, 7, 0.1);
    }
    
    /* 暗色主题变量 */
    @media (prefers-color-scheme: dark) {
      :root {
        --header-bg: #614685;
        --header-bg-end: #a35f9e;
        --bg-color: #121212;
        --text-color: #a36b9c;
        --text-secondary: #b0b0b0;
        --text-tertiary: #909090;
        --positive-color: #ff7675;
        --negative-color: #55efc4;
        --neutral-color: #a29bfe;
        --border-color: #333;
        --card-bg: #1e1e1e;
        --card-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        --card-hover-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        --button-bg: rgba(255, 255, 255, 0.1);
        --button-hover-bg: rgba(255, 255, 255, 0.15);
        --button-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        --button-hover-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
        --chart-grid-line: #333;
        --progress-bg: #2a2a2a;
        --table-header-bg: #2a2a2a;
        --table-border: #333;
        --table-hover-bg: #252525;
        --error-bg: rgba(255, 118, 117, 0.15);
        --error-color: #ff7675;
        --warning-color: #ff9800;
        --warning-bg: rgba(255, 193, 7, 0.15);
      }
    }
    
    /* 现有的CSS样式 */
    body {
      font-family: 'PingFang SC', 'Microsoft YaHei', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      width: 380px;
      padding: 0;
      margin: 0;
      color: var(--text-color);
      background-color: var(--bg-color);
      overflow-x: hidden;
    }

    .container {
      padding: 12px;
      box-sizing: border-box;
    }

    .header {
      position: relative;
      padding: 10px 0;
      margin-bottom: 10px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      background: linear-gradient(135deg, var(--header-bg), var(--header-bg-end));
      color: white;
      box-shadow: var(--card-shadow);
      display: flex;
      justify-content: flex-start;
      align-items: center;
      padding-left: 20px;
    }

    .header-icon {
      margin-right: 12px;
      color: rgba(255, 255, 255, 0.9);
      transition: opacity 0.3s ease;
      font-size: 16px;
    }

    .header-icon:hover {
      opacity: 0.8;
    }

    .header h1 {
      margin: 0;
      flex-grow: 1;
      text-align: center;
      transform: translateX(-28px);
    }

    h1 {
      font-size: 18px;
      margin: 0;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .refresh-btn-header {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      background: var(--button-bg);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      box-shadow: var(--button-shadow);
      transition: all 0.3s ease;
    }

    .refresh-btn-header:hover {
      background: var(--button-hover-bg);
      box-shadow: var(--button-hover-shadow);
    }

    .refresh-btn-header:active {
      transform: translateY(-50%) scale(0.95);
    }

    .update-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      margin-bottom: 10px;
      background-color: var(--card-bg);
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      font-size: 13px;
    }

    .market-status {
      display: flex;
      align-items: center;
    }

    /* 添加刷新按钮暂停状态的样式 */
    .refresh-btn-header.paused {
      background-color: #ffa69e;
      color: white;
    }

    /* 添加状态指示器的样式 */
    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 5px;
    }

    .status-normal {
      background-color: #84fab0;
      animation: pulse 2s infinite;
    }

    .status-paused {
      background-color: #ffa69e;
    }

    .status-closed {
      background-color: #dfe6e9;
    }

    @keyframes pulse {
      0% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
      100% {
        opacity: 1;
      }
    }

    .data-time {
      color: var(--text-secondary);
      font-size: 12px;
    }

    .chart-container {
      width: 93%;
      margin-bottom: 15px;
      background-color: var(--card-bg);
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      overflow: hidden;
      transition: all 0.3s ease;
      padding: 12px;
    }

    .chart-container:hover {
      box-shadow: var(--card-hover-shadow);
      transform: translateY(-2px);
    }

    .data-summary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 15px;
    }

    .data-item {
      text-align: center;
      padding: 14px 10px;
      background-color: var(--card-bg);
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      transition: all 0.3s ease;
    }

    .data-item:hover {
      transform: translateY(-3px);
      box-shadow: var(--card-hover-shadow);
    }

    .data-label {
      font-size: 12px;
      color: var(--text-tertiary);
      margin-bottom: 6px;
    }

    .data-value {
      font-size: 18px;
      font-weight: 600;
    }

    .up {
      color: var(--positive-color);
    }

    .down {
      color: var(--negative-color);
    }

    .neutral {
      color: var(--neutral-color);
    }

    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    .progress-container {
      width: 200px;
      height: 8px;
      background-color: var(--progress-bg);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 15px;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #a18cd1, #fbc2eb);
      transition: width 0.3s ease;
      border-radius: 4px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      color: var(--error-color);
      text-align: center;
      padding: 15px;
      background-color: var(--error-bg);
      border-radius: 12px;
      margin: 15px 0;
    }

    .refresh-btn {
      background: linear-gradient(135deg, var(--header-bg), var(--header-bg-end));
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 500;
      display: block;
      margin: 20px auto;
      box-shadow: var(--button-shadow);
      transition: all 0.3s ease;
    }

    .refresh-btn:hover {
      background: linear-gradient(135deg, var(--header-bg), var(--header-bg-end));
      box-shadow: var(--button-hover-shadow);
      transform: translateY(-3px);
    }

    .refresh-btn:active {
      transform: translateY(1px);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    /* 添加合约详情视图的样式 */
    .contract-detail {
      display: none;
      background-color: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      position: relative;
    }

    .contract-detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }

    .contract-name {
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }

    .close-detail {
      position: absolute;
      top: 12px;
      right: 12px;
      background: none;
      border: none;
      font-size: 18px;
      color: #999;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 50%;
      line-height: 1;
    }

    .close-detail:hover {
      background-color: #f0f0f0;
      color: #666;
    }

    .contract-info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 10px;
    }

    .contract-info-item {
      padding: 8px;
      background-color: #f8f9fa;
      border-radius: 8px;
    }

    .contract-info-label {
      font-size: 12px;
      color: #777;
      margin-bottom: 4px;
    }

    .contract-info-value {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }

    .contract-chart {
      width: 100%;
      height: 220px;
      margin-top: 10px;
      background-color: #f8f9fa;
      border-radius: 8px;
    }

    /* 下拉选择器的样式 */
    .contract-selector {
      display: none;
      margin-bottom: 10px;
    }

    .select-wrapper {
      position: relative;
      margin-bottom: 10px;
    }

    select {
      width: 100%;
      padding: 10px 15px;
      border-radius: 8px;
      border: 1px solid #ddd;
      background-color: white;
      appearance: none;
      font-size: 14px;
      color: #333;
      cursor: pointer;
    }

    .select-arrow {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      width: 0;
      height: 0;
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
      border-top: 5px solid #666;
      pointer-events: none;
    }

    /* 返回按钮 */
    .back-btn {
      background: rgba(161, 140, 209, 0.2);
      color: #666;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 10px;
    }

    .back-btn:hover {
      background: rgba(161, 140, 209, 0.3);
      color: #333;
    }

    .back-btn svg {
      margin-right: 5px;
      width: 12px;
      height: 12px;
    }

    /* 合约表格 */
    .contracts-table {
      width: 100%;
      margin-top: 10px;
      border-collapse: collapse;
      font-size: 13px;
      display: none;
    }

    .contracts-table th, .contracts-table td {
      padding: 6px 6px;
      text-align: left;
      border-bottom: 1px solid #eee;
      font-size: 9px;
    }

    .contracts-table th {
      font-weight: 600;
      color: #666;
      background-color: #f8f9fa;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .contracts-table tbody tr {
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .contracts-table tbody tr:hover {
      background-color: #f5f5f5;
    }

    .price-up {
      color: #ff7675;
    }

    .price-down {
      color: #55efc4;
    }

    .table-container {
      max-height: 300px;
      overflow-y: auto;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      background-color: white;
      margin-top: 10px;
      display: none;
    }
    
    /* 刷新数据按钮 */
    .refresh-data-btn {
      background: linear-gradient(135deg, #a18cd1, #fbc2eb);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      margin: 10px 0;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
      display: block;
      text-align: center;
    }

    .refresh-data-btn:hover {
      background: linear-gradient(135deg, #8e72d6, #f9a8e0);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
    }
    
    /* 合约升贴水图表容器 */
    .premium-chart-container {
      width: 100%;
      height: 230px;
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-top: 10px;
      padding: 5px;
      box-sizing: border-box;
    }
    
    /* 错误信息样式 */
    .error-message {
      color: #ff7675;
      text-align: center;
      padding: 20px;
      background-color: rgba(255, 118, 117, 0.05);
      border-radius: 8px;
      margin: 10px 0;
      font-size: 13px;
    }

    /* 缓存数据警告样式 */
    .cache-warning {
      color: #ff9800;
      text-align: center;
      padding: 10px;
      background-color: rgba(255, 193, 7, 0.1);
      border-radius: 8px;
      margin: 5px 0;
      font-size: 12px;
    }

    /* 期货涨跌幅列表样式 */
    .futures-list {
      list-style: none;
      font-size: small;
      padding: 0;
      margin: 0;
    }

    .futures-list li {
      display: flex;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
    }

    .futures-list li:last-child {
      border-bottom: none;
    }

    .futures-list li:hover {
      background-color: rgba(0, 0, 0, 0.02);
    }

    .change-arrow {
      width: 0;
      height: 0;
      margin-right: 4px;
    }

    .change-arrow.up {
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-bottom: 6px solid #ff7675;
    }

    .change-arrow.down {
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-top: 6px solid #55efc4;
    }

    .change-arrow.neutral {
      width: 6px;
      height: 2px;
      background-color: #a29bfe;
      margin-top: 2px;
    }

    .futures-name {
      width: 80px; /* 固定宽度 */
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding-right: 5px;
    }

    .futures-posrate {
      width: 60px; /* 固定宽度 */
      text-align: right;
      font-weight: 500;
      font-size: 11x;
      padding-right: 5px;
      padding-left: 5px;
    }

    .futures-change {
      flex: 1;
      padding-right: 5px;
      min-width: 100px; /* 确保足够宽度容纳进度条 */
    }

    .change-bar {
      height: 12px;
      background-color: #f0f0f0;
      position: relative;
      border-radius: 3px;
      overflow: hidden;
    }

    .change-value {
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
      border-radius: 3px;
      max-width: 80%; /* 增加最大宽度，让进度条显得更长 */
    }

    .change-text {
      position: absolute;
      right: 5px;
      top: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      font-size: 12px;
      color: #333;
      font-weight: 500;
    }

    .chart-title {
      font-size: 13px;
      font-weight: 500;
      color: #333;
      text-align: center;
      margin-bottom: 8px;
      border-bottom: 1px solid #f0f0f0;
      padding-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .toggle-btn {
      font-size: 12px;
      background-color: rgba(161, 140, 209, 0.2);
      color: #666;
      border: none;
      padding: 4px 8px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .toggle-btn:hover {
      background-color: rgba(161, 140, 209, 0.4);
      color: #333;
    }
    
    /* 底部统计栏 */
    .stats-container {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
    }
    
    .stat-box {
      width: 31%;
      text-align: center;
      background-color: white;
      border-radius: 10px;
      padding: 10px 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .stat-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }
    
    .stat-value {
      font-size: 18px;
      font-weight: 600;
    }
    
    .stat-value.up {
      color: #ff7675;
    }
    
    .stat-value.down {
      color: #55efc4;
    }
    
    .stat-value.neutral {
      color: #a29bfe;
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <a href="https://i.want.biz/long-and-short-position" target="_blank" class="header-icon">
        <i class="fas fa-external-link-alt"></i>
      </a>
      <h1>期货市场概览</h1>
      <button id="refresh-btn-header" class="refresh-btn-header">暂停刷新</button>
    </header>
    
    <div class="update-info">
      <div class="market-status" id="market-status">
        <span class="status-indicator status-normal"></span>
        <span>状态: </span>
        <span id="market-status">-</span>
      </div>
      <div class="data-time">
        <span>更新时间: </span>
        <span id="update-time">-</span>
      </div>
    </div>
    
    <div id="loading" class="loading">
      <div class="loading-spinner"></div>
      <div>加载数据中...</div>
    </div>
    
    <div id="error" class="error" style="display: none;"></div>
    
    <div id="content" style="display: none;">
      <!-- 市场概览部分 -->
      <div id="overview-section">
        <div class="chart-container">
          <div class="chart-title">
            <a href="https://wealth.want.biz/pages/longshort.html" style="color: inherit; text-decoration: none; display: inline-flex; align-items: center;">
              期货品种涨跌幅及增仓率
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-left: 4px;">
                <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                <path d="M15 3h6v6"></path>
                <path d="M10 14L21 3"></path>
              </svg>
            </a>
            <button id="toggle-futures-btn" class="toggle-btn">展开全部</button>
          </div>
          <ul id="futures-list" class="futures-list">
            <!-- 期货品种列表将通过JavaScript生成 -->
          </ul>
        </div>
        
<!-- 底部统计栏 -->
<div class="stats-container">
  <div class="stat-box">
    <div class="stat-label">上涨</div>
    <div id="up-count" class="stat-value up">-</div>
  </div>
  
  <div class="stat-box">
    <div class="stat-label">下跌</div>
    <div id="down-count" class="stat-value down">-</div>
  </div>
  
  <div class="stat-box">
    <div class="stat-label">持平</div>
    <div id="neutral-count" class="stat-value neutral">-</div>
  </div>
</div>

<!-- 第二行统计栏 -->
<div class="stats-container" style="margin-top: 10px;">
  <div class="stat-box">
    <div class="stat-label">均涨</div>
    <div id="limit-up-count" class="stat-value up">-</div>
  </div>
  
  <div class="stat-box">
    <div class="stat-label">均跌</div>
    <div id="limit-down-count" class="stat-value down">-</div>
  </div>
  
  <div class="stat-box">
    <div class="stat-label">总计</div>
    <div id="total-count" class="stat-value">-</div>
  </div>
</div>
      </div>
      
      
      <!-- 品种选择器部分 -->
      <div id="contract-selector" class="contract-selector">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <button id="back-to-overview" class="back-btn">
            <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none">
              <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            返回概览
          </button>
          <button id="refresh-variety-data" class="refresh-data-btn">刷新数据</button>
          <div class="select-wrapper">
            <select id="variety-select">
              <option value="">请选择品种</option>
            </select>
            <div class="select-arrow"></div>
          </div>
        </div>
    
        
        <!-- <button id="refresh-variety-data" class="refresh-data-btn">刷新数据</button> -->
        
        <!-- 升贴水图表 -->
        <div id="premium-chart-container" class="premium-chart-container">
          <div id="premium-chart-wrapper" style="width: 100%; height: 100%;">
            <div id="premium-chart" style="width: 100%; height: 100%;"></div>
          </div>
        </div>
        
        <div id="table-container" class="table-container">
          <table id="contracts-table" class="contracts-table">
            <thead>
              <tr>
                <th>合约</th>
                <th>最新</th>
                <th>涨幅</th>
                <th>成交</th>
                <th>持仓</th>
                <th>金额</th>
                <th>沉淀</th>
                <th>增仓</th>
                <th>五日</th>
              </tr>
            </thead>
            <tbody id="contracts-body">
              <!-- 合约数据将通过JavaScript填充 -->
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- 合约详情视图 -->
      <div id="contract-detail" class="contract-detail">
        <div class="contract-detail-header">
          <div class="contract-name" id="contract-name"></div>
          <button id="close-detail" class="close-detail">×</button>
        </div>
        
        <div class="contract-info-grid">
          <div class="contract-info-item">
            <div class="contract-info-label">最新价</div>
            <div id="contract-price" class="contract-info-value">-</div>
          </div>
          <div class="contract-info-item">
            <div class="contract-info-label">涨跌幅</div>
            <div id="contract-change" class="contract-info-value">-</div>
          </div>
          <div class="contract-info-item">
            <div class="contract-info-label">成交量</div>
            <div id="contract-volume" class="contract-info-value">-</div>
          </div>
          <div class="contract-info-item">
            <div class="contract-info-label">持仓量</div>
            <div id="contract-position" class="contract-info-value">-</div>
          </div>
          <div class="contract-info-item">
            <div class="contract-info-label">成交额</div>
            <div id="contract-cje" class="contract-info-value">-</div>
          </div>
          <div class="contract-info-item">
            <div class="contract-info-label">沉淀资金</div>
            <div id="contract-cdzj" class="contract-info-value">-</div>
          </div>
          <div class="contract-info-item">
            <div class="contract-info-label">增仓率</div>
            <div id="contract-zcl" class="contract-info-value">-</div>
          </div>
          <div class="contract-info-item">
            <div class="contract-info-label">五日涨幅</div>
            <div id="contract-zdf5" class="contract-info-value">-</div>
          </div>
        </div>
        
        <div id="contract-premium-chart-wrapper" style="width: 100%; height: 220px; margin-top: 10px;">
          <div id="contract-premium-chart" class="contract-chart"></div>
        </div>
      </div>
    </div>
    
    <button id="refresh-btn" class="refresh-btn">刷新数据</button>
  </div>
  
  <script>
    // 全局变量
    let chart = null;
    let premiumChart = null;
    let contractDetailChart = null;
    let echartsLoadRetries = 0;
    const MAX_RETRIES = 3;
    let autoUpdateInterval = null;
    let isAutoUpdateEnabled = true;
    let futuresData = [];
    let contractsData = {};
    let varietyIdMap = {}; // 品种ID映射
    let currentVariety = null; // 当前选择的品种
    let showAllFutures = false; // 控制是否显示全部品种
    
    // 数据备份和回退机制
    let lastSuccessfulFuturesData = null; // 上次成功获取的期货数据
    let lastSuccessfulContractsData = {}; // 上次成功获取的合约数据
    let lastUpdateTime = null; // 上次成功更新的时间
    
    // 交易所映射表
    const EXCHANGE_MAP = {
      'SHFE': 113,
      'DCE': 114,
      'CZCE': 115,
      'GFEX': 225,
      'INE': 142,
      'CFFEX': 220
    };

    // 初始化页面
    document.addEventListener('DOMContentLoaded', function() {
      // 隐藏错误信息
      document.getElementById('error').style.display = 'none';
      
      // 添加页面卸载事件，确保在页面刷新或跳转时销毁图表
      window.addEventListener('beforeunload', function() {
        // 安全地销毁所有图表实例
        safeDisposeChart(premiumChart);
        safeDisposeChart(contractDetailChart);
        safeDisposeChart(chart);
      });
      
      // 绑定刷新按钮事件
      const refreshBtn = document.getElementById('refresh-btn');
      const refreshBtnHeader = document.getElementById('refresh-btn-header');
      const refreshVarietyBtn = document.getElementById('refresh-variety-data');
      
      // 初始化展开/折叠按钮
      const toggleBtn = document.getElementById('toggle-futures-btn');
      if (toggleBtn) {
        // 从localStorage读取用户偏好
        const savedPreference = localStorage.getItem('showAllFutures');
        if (savedPreference !== null) {
          showAllFutures = savedPreference === 'true';
          toggleBtn.textContent = showAllFutures ? '折叠列表' : '展开全部';
        }
        
        toggleBtn.addEventListener('click', function() {
          showAllFutures = !showAllFutures;
          this.textContent = showAllFutures ? '折叠列表' : '展开全部';
          
          // 保存用户偏好
          try {
            localStorage.setItem('showAllFutures', showAllFutures);
          } catch (e) {
            console.warn('无法保存用户偏好:', e);
          }
          
          // 重新渲染列表
          updateFuturesList(futuresData);
        });
      }
      
      refreshBtn.addEventListener('click', function() {
        fetchData();
      });
      
      refreshBtnHeader.addEventListener('click', function() {
        if (isAutoUpdateEnabled) {
          // 如果自动更新开启，点击按钮暂停
          stopAutoUpdate();
          refreshBtnHeader.textContent = '开启自动更新';
          refreshBtnHeader.classList.add('paused');
        } else {
          // 如果自动更新关闭，点击按钮开启
          startAutoUpdate();
          refreshBtnHeader.textContent = '暂停自动更新';
          refreshBtnHeader.classList.remove('paused');
        }
      });
      
      refreshVarietyBtn.addEventListener('click', function() {
        const variety = document.getElementById('variety-select').value;
        console.log('刷新品种数据按钮点击，选择的品种:', variety);
        
        if (variety) {
          fetchVarietyContracts(variety);
        } else {
          alert('请先选择品种');
        }
      });
      
      // 绑定后退按钮事件
      document.getElementById('back-to-overview').addEventListener('click', function() {
        // 返回概览前销毁图表
        safeDisposeChart(premiumChart);
        safeDisposeChart(contractDetailChart);
        showOverview();
      });
      
      // 绑定关闭合约详情按钮事件
      document.getElementById('close-detail').addEventListener('click', function() {
        // 关闭合约详情前销毁图表
        safeDisposeChart(contractDetailChart);
        document.getElementById('contract-detail').style.display = 'none';
        document.getElementById('contract-selector').style.display = 'block';
      });
      
      // 绑定品种选择器事件
      document.getElementById('variety-select').addEventListener('change', function() {
        const variety = this.value;
        console.log('品种选择变更:', variety);
        
        if (variety) {
          currentVariety = variety;
          fetchVarietyContracts(variety);
        } else {
          const premiumChartElement = document.getElementById('premium-chart');
          if (premiumChartElement) {
            premiumChartElement.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;color:#666;">请选择品种</div>';
          }
          const contractsBody = document.getElementById('contracts-body');
          if (contractsBody) {
            contractsBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">请选择品种</td></tr>';
          }
        }
      });
      
      // 从sessionStorage恢复当前品种（如果有）
      try {
        const savedVariety = sessionStorage.getItem('currentVariety');
        if (savedVariety) {
          currentVariety = savedVariety;
        }
      } catch (e) {
        console.warn('无法从sessionStorage读取当前品种:', e);
      }
      
      // 检查URL参数，处理从其他页面跳转过来的请求
      const urlParams = new URLSearchParams(window.location.search);
      const varietyParam = urlParams.get('variety');
      const showPremium = urlParams.get('showPremium');
      
      if (varietyParam && showPremium === 'true') {
        // 如果URL中包含品种参数和showPremium=true参数，直接显示升贴水页面
        currentVariety = varietyParam;
        showContractSelector(varietyParam);
      }
      
      // 检查ECharts是否加载
      checkEChartsLoaded();
      
      // 启动自动更新
      startAutoUpdate();
    });

    // 带超时的fetch请求
    async function fetchWithTimeout(url, options = {}, timeout = 10000) {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeout);
      
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });
        clearTimeout(id);
        return response;
      } catch (error) {
        clearTimeout(id);
        throw error;
      }
    }

    // 带重试的fetch请求
    async function fetchWithRetry(url, options = {}, retries = 2) {
      let lastError;
      
      for (let i = 0; i < retries; i++) {
        try {
          return await fetchWithTimeout(url, options);
        } catch (error) {
          console.warn(`请求失败(${i+1}/${retries}):`, error);
          lastError = error;
          // 等待一段时间再重试
          if (i < retries - 1) {
            await new Promise(r => setTimeout(r, 1000));
          }
        }
      }
      
      throw lastError;
    }

    // 从品种名称获取品种ID
    function getVarietyIdFromName(name) {
      if (!name) return '';
      
      // 提取不含数字的中文品种名
      const varietyName = extractVarietyCode(name);
      
      // 查找映射表中的品种ID
      if (varietyIdMap[varietyName]) {
        return varietyIdMap[varietyName];
      }
      
      // 如果没有找到，查找futuresData尝试构建ID
      const matchedItem = futuresData.find(item => {
        return extractVarietyCode(item.name) === varietyName;
      });
      
      if (matchedItem && matchedItem.uid) {
        // 解析UID得到交易所和品种代码
        const parts = matchedItem.uid.split('|');
        if (parts.length >= 2) {
          const exchange = parts[0];
          const code = parts[1];
          
          // 从代码中提取品种部分（去掉月份数字）
          const variety = code.replace(/\d+/g, '');
          
          // 组合成msgid格式
          if (EXCHANGE_MAP[exchange] && variety) {
            return `${EXCHANGE_MAP[exchange]}_${variety.toLowerCase()}`;
          }
        }
      }
      
      // 如果找不到，尝试直接将名称用作ID
      return varietyName.toLowerCase();
    }

    // 从UID提取纯字母品种代码
    function extractVarietyCodeFromUID(uid) {
      if (!uid) return '';
      
      const parts = uid.split('|');
      if (parts.length < 2) return '';
      
      const contractCode = parts[1];
      // 提取代码中的字母部分
      const letterMatches = contractCode.match(/[A-Za-z]+/);
      if (!letterMatches) return '';
      
      return letterMatches[0].toLowerCase();
    }

    // 开始自动更新 - 使用setTimeout代替setInterval，避免重叠执行
    function startAutoUpdate() {
      isAutoUpdateEnabled = true;
      // 立即获取一次数据
      fetchData()
        .catch(error => {
          console.error('初始数据加载失败:', error);
          showErrorMessage('初始数据加载失败: ' + error.message);
        })
        .finally(() => {
          // 设置下一次刷新
          if (isAutoUpdateEnabled) {
            if (autoUpdateInterval) clearTimeout(autoUpdateInterval);
            autoUpdateInterval = setTimeout(() => startAutoUpdate(), 30000);
          }
        });
    }

    // 停止自动更新
    function stopAutoUpdate() {
      isAutoUpdateEnabled = false;
      if (autoUpdateInterval) {
        clearTimeout(autoUpdateInterval);
        autoUpdateInterval = null;
      }
    }

    // 显示错误信息
    function showErrorMessage(message) {
      const errorElement = document.getElementById('error');
      if (errorElement) {
        errorElement.textContent = message;
        errorElement.style.display = 'block';
      }
    }

    // 创建缓存数据警告元素
    //在交易所数据更新时间段（15:30-17:00）强制获取最新数据,网络请求失败时自动使用缓存数据
    function createCacheWarning(message, container) {
      const warningDiv = document.createElement('div');
      warningDiv.className = 'cache-warning';
      warningDiv.textContent = message;
      
      if (container) {
        // 清空容器并添加警告
        container.innerHTML = '';
        container.appendChild(warningDiv);
        
        // 3秒后自动移除警告
        setTimeout(() => {
          if (warningDiv.parentNode === container) {
            container.removeChild(warningDiv);
          }
        }, 5000);
      }
      
      return warningDiv;
    }

    // 显示加载进度动画
    function showLoadingProgress() {
      const loadingIndicator = document.getElementById('loading');
      if (loadingIndicator) {
        let progress = 0;
        const interval = setInterval(() => {
          progress = Math.min(progress + Math.random() * 10, 100);
          loadingIndicator.innerHTML = `加载中 【${Math.floor(progress)}%】🌷 🌹 🌷   `;
          if (progress >= 100) clearInterval(interval);
        }, 300);
      }
    }

    // 检查ECharts是否加载
    function checkEChartsLoaded() {
      if (typeof echarts !== 'undefined') {
        console.log('ECharts已成功加载');
        // ECharts已加载，初始加载数据
        fetchData();
      } else if (echartsLoadRetries < MAX_RETRIES) {
        console.log(`ECharts未加载，尝试重新加载 (${echartsLoadRetries + 1}/${MAX_RETRIES})`);
        echartsLoadRetries++;
        
        // 尝试动态加载ECharts
        const script = document.createElement('script');
        // 使用CDN链接作为备选，以防本地文件加载失败
        script.src = 'https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js';
        script.onload = function() {
          console.log('ECharts动态加载成功');
          fetchData();
        };
        script.onerror = function() {
          console.error('ECharts动态加载失败');
          setTimeout(checkEChartsLoaded, 1000); // 1秒后重试
        };
        document.head.appendChild(script);
      } else {
        console.error('ECharts加载失败，已达到最大重试次数');
        const errorElement = document.getElementById('error');
        errorElement.textContent = 'ECharts加载失败，请检查网络连接';
        errorElement.style.display = 'block';
        document.getElementById('loading').style.display = 'none';
      }
    }

    // 获取当前时间并判断是否为日盘时段
    function isDaySession() {
        const now = new Date();
        const hours = now.getHours();
        const minutes = now.getMinutes();
        
        // 判断是否在日盘时段（8:30 - 15:30）
        const startOfDaySession = 8 * 60 + 30;  // 8:30 转换为分钟
        const endOfDaySession = 15 * 60 + 30;   // 15:30 转换为分钟
        const currentTimeInMinutes = hours * 60 + minutes;

        return currentTimeInMinutes >= startOfDaySession && currentTimeInMinutes <= endOfDaySession;
    }

    // 获取期货市场数据 - 增加数据备份和回退机制
    async function fetchData() {
      const loadingIndicator = document.getElementById('loading');
      const contentElement = document.getElementById('content');
      const errorElement = document.getElementById('error');
      
      // 显示加载指示器并启动进度条
      loadingIndicator.style.display = 'block';
      showLoadingProgress();
      contentElement.style.display = 'none';
      errorElement.style.display = 'none';
      
      try {
        // 检查ECharts是否可用
        if (typeof echarts === 'undefined') {
          throw new Error('ECharts未加载，无法显示图表');
        }
        
        // 检查当前时间是否为日盘时段，选择对应的 API 地址
        const apiUrl = isDaySession() ? 'https://q.want.biz/' : 'https://q.want.biz/night';
        console.log(`获取期货数据，使用API: ${apiUrl}`); // 调试输出
        
        // 获取期货数据
        const response = await fetchWithRetry(apiUrl);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        if (!data || !data.list || data.list.length === 0) {
          throw new Error('获取数据失败，数据结构不符合预期');
        }
        
        // 保存数据
        futuresData = data.list;
        
        // 同时保存成功的数据为备份
        lastSuccessfulFuturesData = [...data.list];
        lastUpdateTime = new Date();
        
        // 更新品种ID映射
        buildVarietyIdMap();
        
        // 分析数据
        const analysisResults = analyzeFuturesData(futuresData);
        
        // 先显示内容容器，因为图表需要可见的容器来计算尺寸
        contentElement.style.display = 'block';
        loadingIndicator.style.display = 'none';
        
        // 更新期货列表和摘要
        updateFuturesList(futuresData);
        updateSummary(analysisResults);
        
        // 如果有保存的当前品种并且在合约选择器视图，则自动加载它
        if (currentVariety && document.getElementById('contract-selector').style.display === 'block') {
          fetchVarietyContracts(currentVariety);
        }
        
      } catch (error) {
        console.error('获取或处理数据时出错:', error);
        
        // 如果有上次成功获取的数据，使用它
        if (lastSuccessfulFuturesData && lastSuccessfulFuturesData.length > 0) {
          console.log('使用上次缓存的数据', lastUpdateTime?.toLocaleString() || '未知时间');
          
          // 使用备份数据
          futuresData = [...lastSuccessfulFuturesData];
          
          // 分析备份数据
          const analysisResults = analyzeFuturesData(futuresData);
          analysisResults.lastUpdated += ' (缓存)';
          
          // 显示内容
          contentElement.style.display = 'block';
          loadingIndicator.style.display = 'none';
          
          // 更新UI使用备份数据
          updateFuturesList(futuresData);
          updateSummary(analysisResults);
          
          // 显示缓存数据警告
          const cacheWarning = document.createElement('div');
          cacheWarning.className = 'cache-warning';
          cacheWarning.textContent = `数据更新失败，使用缓存数据 (${error.message})`;
          
          // 添加到内容区域顶部
          if (contentElement.firstChild) {
            contentElement.insertBefore(cacheWarning, contentElement.firstChild);
          } else {
            contentElement.appendChild(cacheWarning);
          }
          
          // 5秒后自动移除警告
          setTimeout(() => {
            if (cacheWarning.parentNode) {
              cacheWarning.parentNode.removeChild(cacheWarning);
            }
          }, 5000);
          
          // 如果当前在合约选择器页面，尝试刷新合约数据
          if (currentVariety && document.getElementById('contract-selector').style.display === 'block') {
            fetchVarietyContracts(currentVariety);
          }
        } else {
          // 没有备份数据，显示错误信息
          errorElement.textContent = error.message || '加载数据失败';
          errorElement.style.display = 'block';
          loadingIndicator.style.display = 'none';
        }
      }
    }

    // 构建品种ID映射表
    function buildVarietyIdMap() {
      varietyIdMap = {};
      
      futuresData.forEach(item => {
        if (!item.uid || !item.name) return;
        
        const [exchange, code] = item.uid.split('|');
        if (!exchange || !code) return;
        
        // 从代码中提取品种部分（去掉月份数字）
        const variety = code.replace(/\d+/g, '');
        const varietyName = extractVarietyCode(item.name);
        
        if (variety && varietyName && EXCHANGE_MAP[exchange]) {
          const msgid = `${EXCHANGE_MAP[exchange]}_${variety.toLowerCase()}`;
          varietyIdMap[varietyName] = msgid;
          
          // 同时储存小写字母代码到映射表，方便查找
          varietyIdMap[variety.toLowerCase()] = msgid;
          
          // 添加更多映射关系，提高匹配成功率
          if (item.code) {
            varietyIdMap[item.code.toLowerCase()] = msgid;
          }
        }
      });
      
      console.log('已构建品种ID映射表:', varietyIdMap);
    }

    // 判断当前是否是夜盘交易时间
    function isTradingHours() {
        const now = new Date();
        
        // 排除周末（周六6，周日0）
        if ([0, 6].includes(now.getDay())) {
            return false;
        }

        const hours = now.getHours();
        const minutes = now.getMinutes();
        const totalMinutes = hours * 60 + minutes;

        // 日盘交易时段：9:00-11:30 和 13:30-15:00
        const daySession1 = (9 * 60) <= totalMinutes && totalMinutes < (11 * 60 + 30);
        const daySession2 = (13 * 60 + 30) <= totalMinutes && totalMinutes < (15 * 60);
        
        // 夜盘交易时段：21:00-次日2:30
        const nightSession = (totalMinutes >= 21 * 60) || (totalMinutes < 2 * 60 + 30);

        return daySession1 || daySession2 || nightSession;
    }

    // 计算增仓率 - 使用原始公式: rz/(ccl-rz)
    function calculatePositionChangeRate(item) {
      const rz = parseFloat(item.rz) || 0;
      const ccl = parseFloat(item.ccl) || 0;
      
      // 如果ccl或ccl-rz为0，返回0，避免除以0的错误
      if (ccl === 0 || ccl <= rz) return 0;
      
      // 计算增仓率
      const rate = (rz / (ccl - rz)) * 100;
      return rate.toFixed(2);
    }

    // 分析期货数据
    function analyzeFuturesData(futuresData) {
      // 默认值
      let result = {
        totalVolume: 0,
        totalContracts: 0,
        upCount: 0,
        downCount: 0,
        neutralCount: 0,
        avgUpChange: 0,
        avgDownChange: 0,
        lastUpdated: new Date().toLocaleString('zh-CN')
      };
      
      // 如果没有数据，返回默认值
      if (!futuresData || futuresData.length === 0) {
        return result;
      }
      
      try {
        // 计算上涨和下跌的品种数量
        const upCount = futuresData.filter(item => parseFloat(item.zdf) > 0).length;
        const downCount = futuresData.filter(item => parseFloat(item.zdf) < 0).length;
        const neutralCount = futuresData.filter(item => parseFloat(item.zdf) === 0 || isNaN(parseFloat(item.zdf))).length;
        
        // 计算平均涨跌幅
        const upItems = futuresData.filter(item => parseFloat(item.zdf) > 0);
        const downItems = futuresData.filter(item => parseFloat(item.zdf) < 0);
        
        const avgUpChange = upItems.length > 0 ? 
          (upItems.reduce((sum, item) => sum + parseFloat(item.zdf), 0) / upItems.length).toFixed(2) : 0;
        
        const avgDownChange = downItems.length > 0 ? 
          (downItems.reduce((sum, item) => sum + parseFloat(item.zdf), 0) / downItems.length).toFixed(2) : 0;
        
        // 获取当前时间
        const lastUpdated = new Date().toLocaleString('zh-CN');
        
        return {
          ...result,
          totalContracts: futuresData.length,
          upCount,
          downCount,
          neutralCount,
          avgUpChange,
          avgDownChange,
          lastUpdated
        };
      } catch (error) {
        console.error('分析期货数据出错:', error);
        // 出错时返回默认值
        return result;
      }
    }

    // 更新期货列表
    function updateFuturesList(futuresData) {
      const listContainer = document.getElementById('futures-list');
      if (!listContainer) return;
      
      // 添加点击标题事件，打开升贴水页面
      const titleElement = document.querySelector('.header h1');
      if (titleElement) {
        titleElement.style.cursor = 'pointer';
        titleElement.title = '点击查看升贴水页面';
        titleElement.addEventListener('click', function() {
          // 先跳转到首页，然后延迟一秒后再跳转到升贴水页面
          // 保存当前品种到sessionStorage，确保跳转后可以恢复
          try {
            if (currentVariety) {
              sessionStorage.setItem('currentVariety', currentVariety);
              sessionStorage.setItem('redirectToContractSelector', 'true');
            }
          } catch (e) {
            console.warn('无法保存跳转信息到sessionStorage:', e);
          }
          
          // 跳转到首页
          window.location.href = '../index.html';
        });
      }
      
      try {
        // 清空列表
        listContainer.innerHTML = '';
        
        // 按涨跌幅绝对值排序，根据showAllFutures决定是否只显示前10个
        const sortedData = [...futuresData]
          .sort((a, b) => Math.abs(parseFloat(b.zdf) || 0) - Math.abs(parseFloat(a.zdf) || 0));
        
        // 如果不是显示全部，则只取前10个
        const displayData = showAllFutures ? sortedData : sortedData.slice(0, 10);
        
        // 创建每个期货品种的列表项
        displayData.forEach(item => {
          const li = document.createElement('li');
          
          // 计算涨跌幅和增仓率
          const change = parseFloat(item.zdf) || 0;
          const posChangeRate = calculatePositionChangeRate(item);
          
          // 确定增仓率状态和颜色
          let posRateStatusClass = 'neutral';
          if (posChangeRate > 0) {
            posRateStatusClass = 'up';
          } else if (posChangeRate < 0) {
            posRateStatusClass = 'down';
          }
          
          // 检查是否为有效数字
          const absChange = isFinite(change) ? Math.abs(change) : 0;
        // 确定涨跌幅颜色
        const changeColor = change > 0 ? '#ff7675' : '#55efc4';

        // 使用非线性缩放，让小数值也能看到一定的进度条长度
        const scaledWidth = Math.min(Math.abs(change) * 10, 90);
    
        // 构建品种编码
        const msgid = getVarietyIdFromName(item.name);
        const varietyCode = msgid ? (msgid.split('_')[1] || '') : '';
    
        // 构建列表项内容，这里移除了内联 onclick 属性
        li.innerHTML = `
          <div class="change-arrow ${posRateStatusClass}"></div>
          <div class="futures-name">${item.name}</div>
          <div class="futures-change">
            <div class="change-bar">
              <div class="change-value" style="width: ${scaledWidth}%; background-color: ${changeColor}"></div>
              <div class="change-text">${change > 0 ? '+' : ''}${change}%</div>
            </div>
          </div>
          <div class="futures-posrate ${posRateStatusClass}" 
               style="cursor: pointer;" 
               title="点击查看${item.name}多空持仓">
            ${posChangeRate > 0 ? '+' : ''}${posChangeRate}%
          </div>
        `;
    
        // 为整个 li 添加点击事件（除了最右侧字段），调用升贴水页面的逻辑
        li.addEventListener('click', (event) => {
          // 获取品种ID
          const varietyId = getVarietyIdFromName(item.name);
          // 调用合约选择器显示升贴水页面
          showContractSelector(varietyId);
        });
    
        // 为增仓率（最右侧字段）添加点击事件，阻止事件冒泡，并在当前页打开龙虎榜页面
        const posrateElement = li.querySelector('.futures-posrate');
        posrateElement.addEventListener('click', (event) => {
          event.stopPropagation(); // 阻止触发 li 点击事件
          window.location.href = `https://wealth.want.biz/pages/longshort.html?variety=${varietyCode}`;
        });
    
        // 添加到列表
        listContainer.appendChild(li);      
        });
      } catch (error) {
        console.error('更新期货列表出错:', error);
        listContainer.innerHTML = '<div class="error-message">更新期货列表失败</div>';
      }
    }

    // 更新数据摘要
    function updateSummary(data) {
      const statusElement = document.getElementById('market-status');
      if (!statusElement) {
        console.error('状态元素未找到');
        return;
      }
      // 更新市场状态和时间
      const statusText = isTradingHours() ? '🟢 交易中' : '🔴 休市中';
      statusElement.style.color = isTradingHours() ? '#2ecc71' : '#95a5a6';
      document.getElementById('market-status').textContent = statusText;
      document.getElementById('update-time').textContent = data.lastUpdated;
      
      // 更新状态指示器样式
      const statusIndicator = document.querySelector('.status-indicator');
      if (statusIndicator) {
        if (isAutoUpdateEnabled) {
          statusIndicator.classList.remove('status-paused');
          statusIndicator.classList.add('status-normal');
        } else {
          statusIndicator.classList.remove('status-normal');
          statusIndicator.classList.add('status-paused');
        }
      }
      
      // 更新涨跌统计
      document.getElementById('up-count').textContent = data.upCount;
      document.getElementById('down-count').textContent = data.downCount;
      document.getElementById('neutral-count').textContent = data.neutralCount;
      
      // 更新平均涨跌幅和总计数据
      document.getElementById('limit-up-count').textContent = data.avgUpChange + '%';
      document.getElementById('limit-down-count').textContent = data.avgDownChange + '%';
      document.getElementById('total-count').textContent = data.totalContracts;
    }

    // 格式化数字
    function formatNumber(num) {
      if (isNaN(num)) return '0';
      
      if (num >= 1000000) {
        return (num / 100000000).toFixed(0) + '亿';
      } else if (num >= 10000) {
        return (num / 10000).toFixed(0) + '万';
      } else {
        return num.toString();
      }
    }

    // 显示合约选择器
    function showContractSelector(variety) {
      console.log('显示合约选择器，品种:', variety);
      
      // 保存当前品种到sessionStorage，确保刷新时可以恢复
      try {
        if (variety) {
          sessionStorage.setItem('currentVariety', variety);
          currentVariety = variety;
        }
      } catch (e) {
        console.warn('无法保存当前品种到sessionStorage:', e);
      }
      
      // 隐藏概览区域
      document.getElementById('overview-section').style.display = 'none';
      document.getElementById('contract-detail').style.display = 'none';
      
      // 显示选择器区域
      const contractSelector = document.getElementById('contract-selector');
      contractSelector.style.display = 'block';
      
      // 更新品种选择框
      updateVarietySelect(variety);
      
      // 检查是否有有效的variety
      if (!variety) {
        const premiumChartElement = document.getElementById('premium-chart');
        if (premiumChartElement) {
          premiumChartElement.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;color:#666;">请选择品种</div>';
        }
        const contractsBody = document.getElementById('contracts-body');
        if (contractsBody) {
          contractsBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">请选择品种</td></tr>';
        }
        return;
      }
      
      // 获取指定品种的合约列表并显示升贴水图表
      fetchVarietyContracts(variety);
    }

    // 更新品种选择框
    function updateVarietySelect(selectedVariety) {
      const varietySelect = document.getElementById('variety-select');
      if (!varietySelect) return;
      
      varietySelect.innerHTML = '<option value="">请选择品种</option>';
      
      try {
        // 获取所有期货品种
        const varieties = [];
        
        // 遍历futuresData提取品种信息
        futuresData.forEach(item => {
          if (!item.uid || !item.name) return;
          
          const [exchange, code] = item.uid.split('|');
          if (!code || !exchange) return;
          
          if (!EXCHANGE_MAP[exchange]) return;
          
          // 提取品种代码（去掉数字）和中文名称
          const variety = code.replace(/\d+/g, '');
          const name = extractVarietyCode(item.name);
          
          // 构建msgid格式
          const msgid = `${EXCHANGE_MAP[exchange]}_${variety.toLowerCase()}`;
          
          // 保存到varietyIdMap映射
          varietyIdMap[name] = msgid;
          varietyIdMap[variety.toLowerCase()] = msgid;
          
          // 检查是否已经添加过这个品种
          if (!varieties.some(v => v.msgid === msgid)) {
            varieties.push({
              code: variety,
              name: name,
              exchange: exchange,
              msgid: msgid
            });
          }
        });
        
        // 按名称排序
        varieties.sort((a, b) => a.name.localeCompare(b.name, 'zh-CN'));
        
        // 添加品种选项
        varieties.forEach(variety => {
          const option = document.createElement('option');
          option.value = variety.msgid;
          option.textContent = `${variety.name} (${variety.code})`;
          
          // 如果是当前选中的品种，设置为选中状态
          if (variety.msgid === selectedVariety) {
            option.selected = true;
          }
          
          varietySelect.appendChild(option);
        });
        
        console.log('品种选择框已更新，品种数量:', varieties.length);
      } catch (error) {
        console.error('更新品种选择框失败:', error);
      }
    }

    // 从品种名称中提取品种代码
    function extractVarietyCode(name) {
      if (!name) return '';
      
      // 移除所有数字和特殊字符，保留中文
      return name.replace(/[0-9()（）]/g, '').trim();
    }

    // 获取指定品种的合约列表 - 增加数据备份和回退机制
    async function fetchVarietyContracts(variety) {
      const premiumChartElement = document.getElementById('premium-chart');
      const contractsBody = document.getElementById('contracts-body');
      
      if (!premiumChartElement || !contractsBody) {
        console.error('找不到必要的DOM元素');
        return;
      }
      
      try {
        console.log(`获取${variety}的合约列表，msgid:${variety}`);
        
        // 显示加载状态
        
        premiumChartElement.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;color:#666;">loading🌷 🌹 🌷 🌹 🌷 🌹 🌷 ...</div>';
        contractsBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">加载中...</td></tr>';
        
        // 保证variety不为空
        if (!variety) {
          throw new Error('品种ID为空');
        }
        
        // 确保品种ID格式正确
        if (!variety.includes('_')) {
          // 尝试从映射表中获取正确的品种ID
          const mappedId = varietyIdMap[variety];
          if (mappedId) {
            console.log(`品种ID格式不正确，已从映射表中获取正确ID: ${variety} -> ${mappedId}`);
            variety = mappedId;
          } else {
            console.warn(`品种ID格式不正确且无法从映射表中获取: ${variety}`);
          }
        }
        
        // 1. 从API获取合约列表 - 使用try/catch分开处理每个步骤的错误
        let contractCodes = [];
        try {
          // 调试日志
          console.log(`请求URL: https://q.889.ink/redis?msgid=${encodeURIComponent(variety)}`);
          
          const contractsResponse = await fetchWithRetry(`https://q.889.ink/redis?msgid=${encodeURIComponent(variety)}`);
          if (!contractsResponse.ok) {
            throw new Error(`HTTP error! status: ${contractsResponse.status}`);
          }
          
          const responseText = await contractsResponse.text();
          console.log(`Redis API响应: ${responseText.substring(0, 200)}...`);
          
          let contractsData;
          try {
            contractsData = JSON.parse(responseText);
          } catch (e) {
            console.error('JSON解析错误:', e);
            throw new Error(`解析合约列表数据失败: ${e.message}`);
          }
          
          if (!contractsData || !Array.isArray(contractsData)) {
            throw new Error('获取合约列表失败，数据格式不正确');
          }
          
          console.log('获取到合约列表数据:', contractsData);
          
          // 过滤并提取合约代码
          contractCodes = contractsData
            .filter(item => item && item.code && /\d+/.test(item.code))
            .map(item => `${item.mktid}_${item.code}`);
          
          if (contractCodes.length === 0) {
            throw new Error('未找到有效的合约');
          }
          
          console.log('提取的合约代码:', contractCodes);
        } catch (contractError) {
          console.error('获取合约列表步骤失败:', contractError);
          
          // 尝试从缓存获取数据
          if (lastSuccessfulContractsData[variety]) {
            console.log(`使用缓存的${variety}合约数据`);
            
            // 显示缓存警告
            createCacheWarning(`使用缓存的合约数据 (${contractError.message})`, premiumChartElement);
            
            // 使用缓存数据更新UI
            setTimeout(() => {
              renderContractsTable(lastSuccessfulContractsData[variety]);
              renderPremiumChart(variety, lastSuccessfulContractsData[variety]);
            }, 500);
            
            return;
          }
          
          throw contractError; // 无缓存可用，重新抛出错误
        }
        
        // 2. 获取合约价格数据
        try {
          // 构建URL，确保合约代码正确编码
          const customUrl = `https://q.889.ink/custom/${contractCodes.join(',')}?orderBy=code&sort=asc&pageSize=100&pageIndex=0&callbackName=`;
          console.log('请求价格数据URL:', customUrl);
          
          const pricesResponse = await fetchWithRetry(customUrl);
          if (!pricesResponse.ok) {
            throw new Error(`获取价格数据HTTP错误! status: ${pricesResponse.status}`);
          }
          
          // 提取和处理JSONP响应
          const pricesText = await pricesResponse.text();
          console.log(`价格API响应的前100个字符: ${pricesText.substring(0, 100)}...`);
          
          // 提取JSON部分
          const jsonStr = pricesText.replace(/^[^({]*\(|\)[^}]*$/g, '');
          
          let pricesData;
          try {
            pricesData = JSON.parse(jsonStr);
          } catch (e) {
            console.error('JSON解析错误:', e, '原始字符串:', jsonStr);
            throw new Error(`解析价格数据失败: ${e.message}`);
          }
          
          if (!pricesData || !pricesData.list || !Array.isArray(pricesData.list)) {
            console.error('价格数据格式不正确:', pricesData);
            throw new Error('价格数据格式不正确');
          }
          
          const prices = pricesData.list;
          
          if (prices.length === 0) {
            throw new Error('未获取到任何价格数据');
          }
          
          // 转换数据为统一格式
          const formattedPrices = prices.map(item => {
            // 成交额 
            const cje = item.cje;
            
            // 沉淀资金 
            const cdzj = item.cdzj;
            
            // 计算增仓率 rz/(ccl-rz)，其中rz是增仓量
            let zcl = '0';
            if (item.rz && item.ccl) {
              const rz = parseFloat(item.rz || 0);
              const ccl = parseFloat(item.ccl || 0);
              if (ccl > rz && ccl - rz !== 0) {
                zcl = ((rz / (ccl - rz)) * 100).toFixed(2);
              }
            }
            
            return {
              code: item.name || '',
              price: item.p || '0',
              change: item.zdf || '0',
              volume: item.vol || '0',
              position: item.ccl || '0',
              cje: cje,
              cdzj: cdzj,
              zcl: zcl,
              zdf5: item.zdf5 || '0'
            };
          });
          
          // 保存数据 - 使用正确的品种名称作为键
          const varietyName = extractVarietyCode(prices[0]?.name || '');
          contractsData[varietyName] = formattedPrices;
          
          // 同时使用msgid作为键存储数据，确保可以通过两种方式访问
          contractsData[variety] = formattedPrices;
          
          // 同时保存到备份中
          lastSuccessfulContractsData[varietyName] = [...formattedPrices];
          lastSuccessfulContractsData[variety] = [...formattedPrices];
          
          console.log(`保存了品种数据: ${varietyName}, ${variety}`, formattedPrices);
          
          // 显示合约列表
          renderContractsTable(formattedPrices);
          
          // 显示升贴水图表
          renderPremiumChart(varietyName, formattedPrices);
          
        } catch (pricesError) {
          console.error('获取价格数据步骤失败:', pricesError);
          
          // 尝试从缓存获取数据
          if (lastSuccessfulContractsData[variety]) {
            console.log(`使用缓存的${variety}价格数据`);
            
            // 显示缓存警告
            createCacheWarning(`使用缓存的价格数据 (${pricesError.message})`, premiumChartElement);
            
            // 使用缓存数据更新UI
            setTimeout(() => {
              renderContractsTable(lastSuccessfulContractsData[variety]);
              renderPremiumChart(variety, lastSuccessfulContractsData[variety]);
            }, 500);
          } else {
            // 获取价格数据失败，显示错误信息
            if (premiumChartElement) {
              premiumChartElement.innerHTML = `<div style="display:flex;justify-content:center;align-items:center;height:100%;color:#ff7675;">价格数据加载失败: ${pricesError.message}</div>`;
            }
            
            if (contractsBody) {
              contractsBody.innerHTML = `<tr><td colspan="9" style="text-align:center;">获取价格数据失败: ${pricesError.message}</td></tr>`;
            }
          }
        }
        
      } catch (error) {
        console.error('获取合约列表失败:', error);
        
        // 更新DOM，显示错误信息
        if (premiumChartElement) {
          premiumChartElement.innerHTML = `<div style="display:flex;justify-content:center;align-items:center;height:100%;color:#ff7675;">加载失败: ${error.message}</div>`;
        }
        
        if (contractsBody) {
          contractsBody.innerHTML = `<tr><td colspan="9" style="text-align:center;">获取合约列表失败，${error.message}</td></tr>`;
        }
      }
    }

    // 渲染合约表格 - 增加错误处理
    function renderContractsTable(contracts) {
      const contractsBody = document.getElementById('contracts-body');
      const contractsTable = document.getElementById('contracts-table');
      const tableContainer = document.getElementById('table-container');
      
      if (!contractsBody || !contractsTable || !tableContainer) {
        console.error('找不到必要的DOM元素');
        return;
      }
      
      // 清空现有内容
      contractsBody.innerHTML = '';
      
      if (!contracts || contracts.length === 0) {
        contractsBody.innerHTML = '<tr><td colspan="9" style="text-align:center;">无合约数据</td></tr>';
        return;
      }
      
      try {
        // 按合约月份排序
        contracts.sort((a, b) => {
          const monthA = a.code.match(/\d+/) ? a.code.match(/\d+/)[0] : '';
          const monthB = b.code.match(/\d+/) ? b.code.match(/\d+/)[0] : '';
          return monthA.localeCompare(monthB);
        });
        
        // 填充表格
        contracts.forEach(contract => {
          const row = document.createElement('tr');
          
          // 为涨跌幅添加颜色样式
          const change = parseFloat(contract.change);
          const changeClass = change >= 0 ? 'price-up' : 'price-down';
          const changeSign = change >= 0 ? '+' : '';
          const changeText = change ? `${changeSign}${change}%` : '-';
          
          row.innerHTML = `
            <td>${contract.code || '-'}</td>
            <td>${contract.price || '-'}</td>
            <td class="${changeClass}">${changeText}</td>
            <td>${formatNumber(contract.volume)}</td>
            <td>${formatNumber(contract.position)}</td>
            <td>${formatNumber(contract.cje)}</td>
            <td>${formatNumber(contract.cdzj)}</td>
            <td>${contract.zcl || '-'}%</td>
            <td class="${parseFloat(contract.zdf5) >= 0 ? 'price-up' : 'price-down'}">${parseFloat(contract.zdf5) ? (parseFloat(contract.zdf5) >= 0 ? '+' : '') + contract.zdf5 + '%' : '-'}</td>
          `;
          
          // 为行添加点击事件 - 确保保存contract对象的副本
          row.addEventListener('click', function() {
            const contractCopy = {...contract};
            console.log('点击合约行:', contractCopy);
            showContractDetail(contractCopy);
          });
          
          contractsBody.appendChild(row);
        });
        
        // 显示表格容器
        tableContainer.style.display = 'block';
        contractsTable.style.display = 'table';
      } catch (error) {
        console.error('渲染合约表格失败:', error);
        contractsBody.innerHTML = `<tr><td colspan="9" style="text-align:center;">渲染表格失败: ${error.message}</td></tr>`;
      }
    }

    // 安全地销毁图表实例的通用函数 - 增强健壮性
    function safeDisposeChart(chartInstance) {
      if (!chartInstance) return;
      
      try {
        // 检查图表实例是否有效
        if (typeof chartInstance.getDom === 'function') {
          try {
            const dom = chartInstance.getDom();
            // 只有当DOM元素存在且在文档中时才尝试销毁
            if (dom && document.body.contains(dom)) {
              chartInstance.dispose();
              console.log('图表实例已安全销毁');
            } else {
              // DOM元素不在文档中，直接设置为null
              console.warn('图表DOM元素已不在文档中，跳过dispose');
            }
          } catch (domError) {
            // 获取DOM元素失败，可能是图表实例已部分损坏
            console.warn('获取图表DOM元素失败，尝试直接销毁:', domError);
            try {
              chartInstance.dispose();
            } catch (disposeError) {
              console.warn('直接销毁图表失败:', disposeError);
            }
          }
        } else {
          // 图表实例可能已损坏，直接设置为null
          console.warn('图表实例可能已损坏，跳过dispose');
        }
      } catch (e) {
        console.warn('销毁图表实例失败:', e);
      }
    }
    
    // 显示合约详情 - 增加错误处理
    function showContractDetail(contract) {
      if (!contract) {
        console.error('合约对象为空，无法显示详情');
        return;
      }
      
      console.log('显示合约详情:', contract);
      
      try {
        // 在切换视图前先销毁premiumChart图表实例，防止DOM元素移除导致的错误
        safeDisposeChart(premiumChart);
        premiumChart = null;
        
        // 隐藏合约选择器和概览
        document.getElementById('contract-selector').style.display = 'none';
        document.getElementById('overview-section').style.display = 'none';
        
        // 显示合约详情
        const detailElement = document.getElementById('contract-detail');
        detailElement.style.display = 'block';
        
        // 更新合约详情数据
        document.getElementById('contract-name').textContent = contract.code || '未知合约';
        document.getElementById('contract-price').textContent = contract.price || '-';
        
        const change = parseFloat(contract.change);
        const changeValue = document.getElementById('contract-change');
        changeValue.textContent = change ? `${change >= 0 ? '+' : ''}${change}%` : '-';
        changeValue.className = `contract-info-value ${change >= 0 ? 'up' : 'down'}`;
        
        document.getElementById('contract-volume').textContent = formatNumber(contract.volume);
        document.getElementById('contract-position').textContent = formatNumber(contract.position);
        
        // 添加新字段显示
        document.getElementById('contract-cje').textContent = formatNumber(contract.cje);
        document.getElementById('contract-cdzj').textContent = formatNumber(contract.cdzj);
        
        // 增仓率显示
        document.getElementById('contract-zcl').textContent = contract.zcl ? `${contract.zcl}%` : '-';
        
        // 五日涨幅显示
        const zdf5 = parseFloat(contract.zdf5);
        const zdf5Element = document.getElementById('contract-zdf5');
        zdf5Element.textContent = zdf5 ? `${zdf5 >= 0 ? '+' : ''}${contract.zdf5}%` : '-';
        zdf5Element.className = `contract-info-value ${zdf5 >= 0 ? 'up' : 'down'}`;
        
        // 生成并显示升贴水图表
        setTimeout(() => {
          renderContractPremiumChart(contract);
        }, 100);
      } catch (error) {
        console.error('显示合约详情失败:', error);
        alert('显示合约详情失败：' + error.message);
      }
    }

    // 渲染品种升贴水图表 (品种选择页面) - 增加错误处理和回退机制
    function renderPremiumChart(variety, contracts) {
      const chartWrapper = document.getElementById('premium-chart-wrapper');
      
      if (!chartWrapper) {
        console.error('找不到图表容器');
        return;
      }
      
      // 安全地销毁旧图表 - 使用通用函数
      safeDisposeChart(premiumChart);
      premiumChart = null;
      
      // 确保容器中只有一个图表元素
      chartWrapper.innerHTML = '<div id="premium-chart" style="width: 100%; height: 100%;"></div>';
      const chartContainer = document.getElementById('premium-chart');
      
      // 确保ECharts已加载
      if (typeof echarts === 'undefined') {
        chartContainer.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;color:#ff7675;">ECharts未加载</div>';
        return;
      }
      
      // 确保有合约数据
      if (!contracts || contracts.length === 0) {
        chartContainer.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;color:#666;">无合约数据</div>';
        return;
      }
      
      // 确保至少有价格数据的合约
      const validContracts = contracts.filter(c => c.price && !isNaN(parseFloat(c.price)));
      if (validContracts.length === 0) {
        chartContainer.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;color:#666;">无有效价格数据</div>';
        return;
      }
      
      try {
        // 按合约月份排序
        validContracts.sort((a, b) => {
          const monthA = a.code.match(/\d+/) ? a.code.match(/\d+/)[0] : '';
          const monthB = b.code.match(/\d+/) ? b.code.match(/\d+/)[0] : '';
          return monthA.localeCompare(monthB);
        });
        
        // 获取合约月份和价格
        const months = validContracts.map(c => {
          // 提取合约月份，例如从 "沪铜2310" 中提取 "2310"
          const match = c.code.match(/\d+/);
          return match ? match[0] : c.code;
        });
        
        const prices = validContracts.map(c => parseFloat(c.price) || 0);
        
        // 计算升贴水（相对于第一个合约）
        const basePrice = parseFloat(validContracts[0].price);
        const premium = prices.map(price => ((price - basePrice) / basePrice * 100).toFixed(2));
        
        // 获取持仓量数据并计算占比
        const positions = validContracts.map(c => parseInt(c.position) || 0);
        const totalPosition = positions.reduce((sum, pos) => sum + pos, 0);
        const positionRatio = positions.map(pos => totalPosition > 0 ? ((pos / totalPosition) * 100).toFixed(2) : 0);
        
        // 生成柱状图颜色
        const colors = premium.map((p, idx) => {
          // 当前合约为橙色
          if (idx === 0) return '#f8cda6';
          // 升水为红色，贴水为绿色
          return parseFloat(p) >= 0 ? '#ff7675' : '#55efc4';
        });
        
        // 图表已在函数开始时安全销毁
        
        // 创建新图表
        premiumChart = echarts.init(chartContainer);
        
        // 设置图表选项
        const option = {
          title: {
            text: `${variety}合约升贴水结构`,
            left: 'center',
            textStyle: {
              fontSize: 14,
              fontWeight: 'normal',
              color: '#333'
            }
          },
          tooltip: {
            trigger: 'axis',
            formatter: function(params) {
              let html = `${validContracts[params[0].dataIndex].code}<br/>`;
              params.forEach(param => {
                if (param.seriesName === '升贴水') {
                  html += `价格: ${validContracts[param.dataIndex].price}<br/>升贴水: ${param.value}%<br/>`;
                } else if (param.seriesName === '持仓占比') {
                  html += `持仓量: ${formatNumber(validContracts[param.dataIndex].position)}<br/>占比: ${param.value}%`;
                }
              });
              return html;
            }
          },
          grid: {
            left: '3%',
            right: '8%',  // 增加右侧空间以容纳第二个Y轴
            bottom: '5%', // 增加底部空间
            top: '35%',
            containLabel: true
          },
          legend: {
            data: ['升贴水', '持仓占比'],
            top: '10%',
            right: '30%',
            show: true
          },
          xAxis: {
            type: 'category',
            data: months,
            axisLabel: {
              interval: 0,
              fontSize: 11,
              color: '#666'
            }
          },
          yAxis: [
            {
              type: 'value',
              name: '升贴水(%)',
              nameTextStyle: {
                fontSize: 12,
                color: '#666'
              },
              axisLabel: {
                formatter: '{value}%',
                fontSize: 11,
                color: '#666'
              },
              splitLine: {
                lineStyle: {
                  color: '#eee'
                }
              }
            },
            {
              type: 'value',
              name: '持仓占比(%)',
              nameTextStyle: {
                fontSize: 12,
                color: '#3498db'
              },
              axisLabel: {
                formatter: '{value}%',
                fontSize: 11,
                color: '#3498db'
              },
              splitLine: {
                show: false
              }
            }
          ],
          series: [
            {
              name: '升贴水',
              type: 'bar',
              barWidth: '60%',
              data: premium.map((value, idx) => {
                return {
                  value: value,
                  itemStyle: {
                    color: colors[idx]
                  }
                };
              }),
              label: {
                show: true,
                position: 'top',
                formatter: '{c}%',
                fontSize: 10,
                color: '#666'
              }
            },
            {
              name: '持仓占比',
              type: 'line',
              yAxisIndex: 1,
              symbol: 'circle',
              symbolSize: 6,
              itemStyle: {
                color: '#3498db'
              },
              lineStyle: {
                width: 2,
                type: 'solid',
                color: '#3498db'
              },
              data: positionRatio,
              label: {
                show: false,
                position: 'inside',
                formatter: '{c}%',
                fontSize: 10,
                color: '#ffffff',
                backgroundColor: '#3498db',
                padding: [2, 4],
                borderRadius: 3
              }
            }
          ]
        };
        
        // 设置图表
        premiumChart.setOption(option);
        
        // 重新绑定窗口大小变化事件
        const resizeHandler = () => {
          if (premiumChart) {
            try {
              premiumChart.resize();
            } catch (e) {
              console.warn('图表调整大小失败:', e);
            }
          }
        };
        
        window.removeEventListener('resize', resizeHandler);
        window.addEventListener('resize', resizeHandler);
      } catch (error) {
        console.error('渲染升贴水图表失败:', error);
        chartContainer.innerHTML = `<div style="display:flex;justify-content:center;align-items:center;height:100%;color:#ff7675;">渲染图表失败: ${error.message}</div>`;
      }
    }

    // 渲染合约详情页的升贴水图表 - 增加错误处理和回退机制
    function renderContractPremiumChart(contract) {
      const chartWrapper = document.getElementById('contract-premium-chart-wrapper');
      
      if (!chartWrapper) {
        console.error('找不到合约详情图表容器');
        return;
      }
      
      // 安全地销毁旧图表 - 使用通用函数
      safeDisposeChart(contractDetailChart);
      contractDetailChart = null;
      
      // 确保容器中只有一个图表元素
      chartWrapper.innerHTML = '<div id="contract-premium-chart" class="contract-chart"></div>';
      const chartContainer = document.getElementById('contract-premium-chart');
      
      // 确保ECharts已加载
      if (typeof echarts === 'undefined') {
        chartContainer.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;color:#ff7675;">ECharts未加载</div>';
        return;
      }
      
      // 获取品种
      const variety = extractVarietyCode(contract.code);
      console.log('当前合约品种:', variety, '合约代码:', contract.code);
      
      // 查找合约数据，先从当前数据中找，再从缓存中找
      let contracts = null;
      let isUsingCache = false;
      
      // 使用保存的合约数据 - 优先使用品种名称，其次使用msgid
      if (contractsData[variety]) {
        contracts = contractsData[variety];
      } else if (contractsData[currentVariety]) {
        contracts = contractsData[currentVariety];
      } else if (lastSuccessfulContractsData[variety]) {
        // 尝试从缓存中获取
        contracts = lastSuccessfulContractsData[variety];
        isUsingCache = true;
      } else if (lastSuccessfulContractsData[currentVariety]) {
        contracts = lastSuccessfulContractsData[currentVariety];
        isUsingCache = true;
      }
      
      // 如果没有找到合约数据，显示错误
      if (!contracts || contracts.length === 0) {
        chartContainer.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;color:#ff7675;">无法获取品种合约数据</div>';
        return;
      }
      
      // 如果使用缓存，显示提示
      if (isUsingCache) {
        createCacheWarning('使用缓存的合约数据', chartContainer);
      }
      
      // 确保至少有价格数据的合约
      const validContracts = contracts.filter(c => c.price && !isNaN(parseFloat(c.price)));
      if (validContracts.length === 0) {
        chartContainer.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;color:#666;">无有效价格数据</div>';
        return;
      }
      
      try {
        // 按合约月份排序
        validContracts.sort((a, b) => {
          const monthA = a.code.match(/\d+/) ? a.code.match(/\d+/)[0] : '';
          const monthB = b.code.match(/\d+/) ? b.code.match(/\d+/)[0] : '';
          return monthA.localeCompare(monthB);
        });
        
        // 获取合约月份和价格
        const months = validContracts.map(c => {
          // 提取合约月份，例如从 "沪铜2310" 中提取 "2310"
          const match = c.code.match(/\d+/);
          return match ? match[0] : c.code;
        });
        
        const prices = validContracts.map(c => parseFloat(c.price) || 0);
        
        // 找出当前合约在列表中的位置
        const basePriceIndex = validContracts.findIndex(c => c.code === contract.code);
        
        const basePrice = parseFloat(contract.price) || (basePriceIndex >= 0 ? parseFloat(validContracts[basePriceIndex].price) : parseFloat(validContracts[0].price));
        
        // 计算升贴水（相对于当前合约）
        const premium = prices.map(price => ((price - basePrice) / basePrice * 100).toFixed(2));
        
        // 获取持仓量数据并计算占比
        const positions = validContracts.map(c => parseInt(c.position) || 0);
        const totalPosition = positions.reduce((sum, pos) => sum + pos, 0);
        const positionRatio = positions.map(pos => totalPosition > 0 ? ((pos / totalPosition) * 100).toFixed(2) : 0);
        
        // 生成柱状图颜色
        const colors = premium.map((p, idx) => {
          // 当前合约为橙色
          if ((basePriceIndex >= 0 && idx === basePriceIndex) || 
              (basePriceIndex < 0 && validContracts[idx].code === contract.code)) {
            return '#f8cda6';
          }
          // 升水为红色，贴水为绿色
          return parseFloat(p) >= 0 ? '#ff7675' : '#55efc4';
        });
        
        // 图表已在函数开始时安全销毁
        
        // 创建新图表
        contractDetailChart = echarts.init(chartContainer);
        
        // 设置图表选项
        const option = {
          title: {
            text: `${contract.code}升贴水结构`,
            left: 'center',
            textStyle: {
              fontSize: 14,
              fontWeight: 'normal',
              color: '#333'
            }
          },
          tooltip: {
            trigger: 'axis',
            formatter: function(params) {
              let html = `${validContracts[params[0].dataIndex].code}<br/>`;
              params.forEach(param => {
                if (param.seriesName === '升贴水') {
                  html += `价格: ${validContracts[param.dataIndex].price}<br/>升贴水: ${param.value}%<br/>`;
                } else if (param.seriesName === '持仓占比') {
                  html += `持仓量: ${formatNumber(validContracts[param.dataIndex].position)}<br/>占比: ${param.value}%`;
                }
              });
              return html;
            }
          },
          grid: {
            left: '3%',
            right: '8%',  // 增加右侧空间以容纳第二个Y轴
            bottom: '15%', // 增加底部空间
            top: '15%',
            containLabel: true
          },
          legend: {
            data: ['升贴水', '持仓占比'],
            top: '5%',
            right: '10%',
            show: false
          },
          xAxis: {
            type: 'category',
            data: months,
            axisLabel: {
              interval: 0,
              fontSize: 11,
              color: '#666'
            }
          },
          yAxis: [
            {
              type: 'value',
              name: '升贴水(%)',
              nameTextStyle: {
                fontSize: 12,
                color: '#ff7675'
              },
              axisLabel: {
                formatter: '{value}%',
                fontSize: 11,
                color: '#666'
              },
              splitLine: {
                lineStyle: {
                  color: '#eee'
                }
              }
            },
            {
              type: 'value',
              name: '持仓占比(%)',
              nameTextStyle: {
                fontSize: 12,
                color: '#ff7675'
              },
              axisLabel: {
                formatter: '{value}%',
                fontSize: 11,
                color: '#3498db'
              },
              splitLine: {
                show: false
              }
            }
          ],
          series: [
            {
              name: '升贴水',
              type: 'bar',
              barWidth: '60%',
              data: premium.map((value, idx) => {
                return {
                  value: value,
                  itemStyle: {
                    color: colors[idx]
                  }
                };
              }),
              label: {
                show: true,
                position: 'top',
                formatter: '{c}%',
                fontSize: 10,
                color: '#666'
              }
            },
            {
              name: '持仓占比',
              type: 'line',
              yAxisIndex: 1,
              symbol: 'circle',
              symbolSize: 6,
              itemStyle: {
                color: '#3498db'
              },
              lineStyle: {
                width: 2,
                type: 'solid',
                color: '#3498db'
              },
              data: positionRatio,
              label: {
                show: false,
                position: 'inside',
                formatter: '{c}%',
                fontSize: 10,
                color: '#ffffff',
                backgroundColor: '#3498db',
                padding: [2, 4],
                borderRadius: 3
              }
            }
          ]
        };
        
        // 设置图表
        contractDetailChart.setOption(option);
        
        // 重新绑定窗口大小变化事件
        const resizeHandler = () => {
          if (contractDetailChart) {
            try {
              contractDetailChart.resize();
            } catch (e) {
              console.warn('合约详情图表调整大小失败:', e);
            }
          }
        };
        
        window.removeEventListener('resize', resizeHandler);
        window.addEventListener('resize', resizeHandler);
      } catch (error) {
        console.error('渲染合约详情图表失败:', error);
        chartContainer.innerHTML = `<div style="display:flex;justify-content:center;align-items:center;height:100%;color:#ff7675;">渲染图表失败: ${error.message}</div>`;
      }
    }

    // 显示概览
    function showOverview() {
      document.getElementById('overview-section').style.display = 'block';
      document.getElementById('contract-selector').style.display = 'none';
      document.getElementById('contract-detail').style.display = 'none';
    }
  </script>
</body>
</html>