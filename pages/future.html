<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æœŸè´§å¸‚åœºæ¦‚è§ˆ</title>
  <!-- å¼•å…¥FontAwesomeå›¾æ ‡åº“ -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- å¼•å…¥EChartså¯è§†åŒ–åº“ -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <style>
    /* CSSå˜é‡å®šä¹‰ - ä½¿ç”¨CSSå˜é‡å®ç°ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½ */
    :root {
      /* äº®è‰²ä¸»é¢˜å˜é‡ - åŒ…å«é¢œè‰²ã€é˜´å½±ç­‰UIå…ƒç´ æ ·å¼ */
      --header-bg: #a18cd1; /* é¡µå¤´èƒŒæ™¯æ¸å˜èµ·å§‹è‰² */
      --header-bg-end: #fbc2eb; /* é¡µå¤´èƒŒæ™¯æ¸å˜ç»“æŸè‰² */
      --bg-color: #f0f1f8; /* é¡µé¢èƒŒæ™¯è‰² */
      --text-color: #333; /* ä¸»æ–‡æœ¬é¢œè‰² */
      --text-secondary: #666; /* æ¬¡è¦æ–‡æœ¬é¢œè‰² */
      --text-tertiary: #777; /* ç¬¬ä¸‰çº§æ–‡æœ¬é¢œè‰² */
      --positive-color: #ff7675; /* æ­£å€¼/ä¸Šæ¶¨é¢œè‰² */
      --negative-color: #55efc4; /* è´Ÿå€¼/ä¸‹è·Œé¢œè‰² */
      --neutral-color: #a29bfe; /* ä¸­æ€§å€¼é¢œè‰² */
      --border-color: #ddd; /* è¾¹æ¡†é¢œè‰² */
      --card-bg: #ffffff; /* å¡ç‰‡èƒŒæ™¯è‰² */
      --card-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); /* å¡ç‰‡é˜´å½± */
      --card-hover-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); /* å¡ç‰‡æ‚¬åœé˜´å½± */
      --button-bg: rgba(255, 255, 255, 0.25); /* æŒ‰é’®èƒŒæ™¯è‰² */
      --button-hover-bg: rgba(255, 255, 255, 0.35); /* æŒ‰é’®æ‚¬åœèƒŒæ™¯è‰² */
      --button-shadow: 0 1px 3px rgba(0, 0, 0, 0.2); /* æŒ‰é’®é˜´å½± */
      --button-hover-shadow: 0 2px 5px rgba(0, 0, 0, 0.3); /* æŒ‰é’®æ‚¬åœé˜´å½± */
      --chart-grid-line: #eee; /* å›¾è¡¨ç½‘æ ¼çº¿é¢œè‰² */
      --progress-bg: #f0f0f0; /* è¿›åº¦æ¡èƒŒæ™¯è‰² */
      --table-header-bg: #f8f9fa; /* è¡¨æ ¼å¤´éƒ¨èƒŒæ™¯è‰² */
      --table-border: #eee; /* è¡¨æ ¼è¾¹æ¡†é¢œè‰² */
      --table-hover-bg: #f5f5f5; /* è¡¨æ ¼è¡Œæ‚¬åœèƒŒæ™¯è‰² */
      --error-bg: rgba(255, 118, 117, 0.1); /* é”™è¯¯ä¿¡æ¯èƒŒæ™¯è‰² */
      --error-color: #ff7675; /* é”™è¯¯ä¿¡æ¯æ–‡æœ¬é¢œè‰² */
      --warning-color: #ff9800; /* è­¦å‘Šä¿¡æ¯æ–‡æœ¬é¢œè‰² */
      --warning-bg: rgba(255, 193, 7, 0.1); /* è­¦å‘Šä¿¡æ¯èƒŒæ™¯è‰² */
      /* å›¾è¡¨ç›¸å…³é¢œè‰² */
      --chart-bg: #ffffff; /* å›¾è¡¨èƒŒæ™¯è‰² */
      --chart-text: #333; /* å›¾è¡¨æ–‡æœ¬é¢œè‰² */
      --chart-title: #333; /* å›¾è¡¨æ ‡é¢˜é¢œè‰² */
      --chart-axis: #666; /* å›¾è¡¨åæ ‡è½´é¢œè‰² */
      --chart-grid: #eee; /* å›¾è¡¨ç½‘æ ¼é¢œè‰² */
    }
    
    /* æš—è‰²ä¸»é¢˜å˜é‡ - é€šè¿‡åª’ä½“æŸ¥è¯¢æ£€æµ‹ç³»ç»Ÿä¸»é¢˜åå¥½ */
    @media (prefers-color-scheme: dark) {
      :root {
        --header-bg: #614685; /* æš—è‰²æ¨¡å¼é¡µå¤´èƒŒæ™¯æ¸å˜èµ·å§‹è‰² */
        --header-bg-end: #a35f9e; /* æš—è‰²æ¨¡å¼é¡µå¤´èƒŒæ™¯æ¸å˜ç»“æŸè‰² */
        --bg-color: #121212; /* æš—è‰²æ¨¡å¼é¡µé¢èƒŒæ™¯è‰² */
        --text-color: #e0e0e0; /* æš—è‰²æ¨¡å¼ä¸»æ–‡æœ¬é¢œè‰² */
        --text-secondary: #b0b0b0; /* æš—è‰²æ¨¡å¼æ¬¡è¦æ–‡æœ¬é¢œè‰² */
        --text-tertiary: #909090; /* æš—è‰²æ¨¡å¼ç¬¬ä¸‰çº§æ–‡æœ¬é¢œè‰² */
        --positive-color: #ff7675; /* æš—è‰²æ¨¡å¼æ­£å€¼/ä¸Šæ¶¨é¢œè‰² */
        --negative-color: #55efc4; /* æš—è‰²æ¨¡å¼è´Ÿå€¼/ä¸‹è·Œé¢œè‰² */
        --neutral-color: #a29bfe; /* æš—è‰²æ¨¡å¼ä¸­æ€§å€¼é¢œè‰² */
        --border-color: #333; /* æš—è‰²æ¨¡å¼è¾¹æ¡†é¢œè‰² */
        --card-bg: #1e1e1e; /* æš—è‰²æ¨¡å¼å¡ç‰‡èƒŒæ™¯è‰² */
        --card-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); /* æš—è‰²æ¨¡å¼å¡ç‰‡é˜´å½± */
        --card-hover-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); /* æš—è‰²æ¨¡å¼å¡ç‰‡æ‚¬åœé˜´å½± */
        --button-bg: rgba(255, 255, 255, 0.1); /* æš—è‰²æ¨¡å¼æŒ‰é’®èƒŒæ™¯è‰² */
        --button-hover-bg: rgba(255, 255, 255, 0.15); /* æš—è‰²æ¨¡å¼æŒ‰é’®æ‚¬åœèƒŒæ™¯è‰² */
        --button-shadow: 0 1px 3px rgba(0, 0, 0, 0.3); /* æš—è‰²æ¨¡å¼æŒ‰é’®é˜´å½± */
        --button-hover-shadow: 0 2px 5px rgba(0, 0, 0, 0.4); /* æš—è‰²æ¨¡å¼æŒ‰é’®æ‚¬åœé˜´å½± */
        --chart-grid-line: #333; /* æš—è‰²æ¨¡å¼å›¾è¡¨ç½‘æ ¼çº¿é¢œè‰² */
        --progress-bg: #2a2a2a; /* æš—è‰²æ¨¡å¼è¿›åº¦æ¡èƒŒæ™¯è‰² */
        --table-header-bg: #2a2a2a; /* æš—è‰²æ¨¡å¼è¡¨æ ¼å¤´éƒ¨èƒŒæ™¯è‰² */
        --table-border: #333; /* æš—è‰²æ¨¡å¼è¡¨æ ¼è¾¹æ¡†é¢œè‰² */
        --table-hover-bg: #252525; /* æš—è‰²æ¨¡å¼è¡¨æ ¼è¡Œæ‚¬åœèƒŒæ™¯è‰² */
        --error-bg: rgba(255, 118, 117, 0.15); /* æš—è‰²æ¨¡å¼é”™è¯¯ä¿¡æ¯èƒŒæ™¯è‰² */
        --error-color: #ff7675; /* æš—è‰²æ¨¡å¼é”™è¯¯ä¿¡æ¯æ–‡æœ¬é¢œè‰² */
        --warning-color: #ff9800; /* æš—è‰²æ¨¡å¼è­¦å‘Šä¿¡æ¯æ–‡æœ¬é¢œè‰² */
        --warning-bg: rgba(255, 193, 7, 0.15); /* æš—è‰²æ¨¡å¼è­¦å‘Šä¿¡æ¯èƒŒæ™¯è‰² */
        /* å›¾è¡¨ç›¸å…³é¢œè‰² */
        --chart-bg: #1e1e1e; /* æš—è‰²æ¨¡å¼å›¾è¡¨èƒŒæ™¯è‰² */
        --chart-text: #e0e0e0; /* æš—è‰²æ¨¡å¼å›¾è¡¨æ–‡æœ¬é¢œè‰² */
        --chart-title: #e0e0e0; /* æš—è‰²æ¨¡å¼å›¾è¡¨æ ‡é¢˜é¢œè‰² */
        --chart-axis: #b0b0b0; /* æš—è‰²æ¨¡å¼å›¾è¡¨åæ ‡è½´é¢œè‰² */
        --chart-grid: #333; /* æš—è‰²æ¨¡å¼å›¾è¡¨ç½‘æ ¼é¢œè‰² */
      }
    }
    
    /* åŸºç¡€å¸ƒå±€æ ·å¼ */
    body {
      font-family: 'PingFang SC', 'Microsoft YaHei', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      width: 380px; /* å›ºå®šå®½åº¦ï¼Œé€‚åˆä½œä¸ºæ’ä»¶æˆ–å°å·¥å…· */
      padding: 0;
      margin: 0;
      color: var(--text-color);
      background-color: var(--bg-color);
      overflow-x: hidden;
    }

    .container {
      padding: 12px;
      box-sizing: border-box;
    }

    /* é¡µå¤´æ ·å¼ */
    .header {
      position: relative;
      padding: 10px 0;
      margin-bottom: 10px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      background: linear-gradient(135deg, var(--header-bg), var(--header-bg-end)); /* æ¸å˜èƒŒæ™¯ */
      color: white;
      box-shadow: var(--card-shadow);
      display: flex;
      justify-content: flex-start;
      align-items: center;
      padding-left: 20px;
    }

    .header-icon {
      margin-right: 12px;
      color: rgba(255, 255, 255, 0.9);
      transition: opacity 0.3s ease;
      font-size: 16px;
    }

    .header-icon:hover {
      opacity: 0.8;
    }

    .header h1 {
      margin: 0;
      flex-grow: 1;
      text-align: center;
      transform: translateX(-28px); /* æ ‡é¢˜å¾®è°ƒä½ç½® */
    }

    h1 {
      font-size: 18px;
      margin: 0;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    /* é¡µå¤´åˆ·æ–°æŒ‰é’®æ ·å¼ */
    .refresh-btn-header {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      background: var(--button-bg);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      box-shadow: var(--button-shadow);
      transition: all 0.3s ease;
    }

    .refresh-btn-header:hover {
      background: var(--button-hover-bg);
      box-shadow: var(--button-hover-shadow);
    }

    .refresh-btn-header:active {
      transform: translateY(-50%) scale(0.95); /* ç‚¹å‡»æ—¶ç¼©å°æ•ˆæœ */
    }

    /* æ•°æ®æ›´æ–°ä¿¡æ¯åŒºåŸŸæ ·å¼ */
    .update-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      margin-bottom: 10px;
      background-color: var(--card-bg);
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      font-size: 13px;
    }

    .market-status {
      display: flex;
      align-items: center;
    }

    /* åˆ·æ–°æŒ‰é’®æš‚åœçŠ¶æ€æ ·å¼ */
    .refresh-btn-header.paused {
      background-color: #ffa69e;
      color: white;
    }

    /* çŠ¶æ€æŒ‡ç¤ºå™¨æ ·å¼ */
    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 5px;
    }

    /* ä¸åŒçŠ¶æ€çš„æŒ‡ç¤ºå™¨æ ·å¼ */
    .status-normal {
      background-color: #84fab0;
      animation: pulse 2s infinite; /* è„‰å†²åŠ¨ç”» */
    }

    .status-paused {
      background-color: #ffa69e;
    }

    .status-closed {
      background-color: #dfe6e9;
    }

    /* çŠ¶æ€æŒ‡ç¤ºå™¨è„‰å†²åŠ¨ç”» */
    @keyframes pulse {
      0% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
      100% {
        opacity: 1;
      }
    }

    .data-time {
      color: var(--text-secondary);
      font-size: 12px;
    }

    /* å›¾è¡¨å®¹å™¨æ ·å¼ */
    .chart-container {
      width: 93%;
      margin-bottom: 15px;
      background-color: var(--card-bg);
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      overflow: hidden;
      transition: all 0.3s ease;
      padding: 12px;
    }

    .chart-container:hover {
      box-shadow: var(--card-hover-shadow);
      transform: translateY(-2px); /* æ‚¬åœæ—¶ä¸Šæµ®æ•ˆæœ */
    }

    /* æ•°æ®æ¦‚è§ˆåŒºåŸŸæ ·å¼ */
    .data-summary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 15px;
    }

    .data-item {
      text-align: center;
      padding: 14px 10px;
      background-color: var(--card-bg);
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      transition: all 0.3s ease;
    }

    .data-item:hover {
      transform: translateY(-3px); /* æ‚¬åœæ—¶ä¸Šæµ®æ•ˆæœ */
      box-shadow: var(--card-hover-shadow);
    }

    .data-label {
      font-size: 12px;
      color: var(--text-tertiary);
      margin-bottom: 6px;
    }

    .data-value {
      font-size: 18px;
      font-weight: 600;
    }

    /* æ¶¨è·Œé¢œè‰²æ ·å¼ */
    .up {
      color: var(--positive-color);
    }

    .down {
      color: var(--negative-color);
    }

    .neutral {
      color: var(--neutral-color);
    }

    /* åŠ è½½ä¸­æ ·å¼ */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    .progress-container {
      width: 200px;
      height: 8px;
      background-color: var(--progress-bg);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 15px;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--header-bg), var(--header-bg-end));
      transition: width 0.3s ease;
      border-radius: 4px;
    }

    /* åŠ è½½åŠ¨ç”» */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* é”™è¯¯æç¤ºæ ·å¼ */
    .error {
      color: var(--error-color);
      text-align: center;
      padding: 15px;
      background-color: var(--error-bg);
      border-radius: 12px;
      margin: 15px 0;
    }

    /* åˆ·æ–°æŒ‰é’®æ ·å¼ */
    .refresh-btn {
      background: linear-gradient(135deg, var(--header-bg), var(--header-bg-end));
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 500;
      display: block;
      margin: 20px auto;
      box-shadow: var(--button-shadow);
      transition: all 0.3s ease;
    }

    .refresh-btn:hover {
      background: linear-gradient(135deg, var(--header-bg), var(--header-bg-end));
      box-shadow: var(--button-hover-shadow);
      transform: translateY(-3px); /* æ‚¬åœæ—¶ä¸Šæµ®æ•ˆæœ */
    }

    .refresh-btn:active {
      transform: translateY(1px); /* ç‚¹å‡»æ—¶ä¸‹æ²‰æ•ˆæœ */
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    /* åˆçº¦è¯¦æƒ…è§†å›¾æ ·å¼ */
    .contract-detail {
      display: none; /* é»˜è®¤éšè— */
      background-color: var(--card-bg);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 10px;
      box-shadow: var(--card-shadow);
      position: relative;
    }

    .contract-detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 10px;
    }

    .contract-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-color);
    }

    .close-detail {
      position: absolute;
      top: 12px;
      right: 12px;
      background: none;
      border: none;
      font-size: 18px;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 50%;
      line-height: 1;
    }

    .close-detail:hover {
      background-color: var(--button-bg);
      color: var(--text-color);
    }

    /* åˆçº¦ä¿¡æ¯ç½‘æ ¼å¸ƒå±€ */
    .contract-info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 10px;
    }

    .contract-info-item {
      padding: 8px;
      background-color: var(--table-header-bg);
      border-radius: 8px;
    }

    .contract-info-label {
      font-size: 12px;
      color: var(--text-tertiary);
      margin-bottom: 4px;
    }

    .contract-info-value {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-color);
    }

    .contract-chart {
      width: 100%;
      height: 220px;
      margin-top: 10px;
      background-color: var(--chart-bg);
      border-radius: 8px;
    }

    /* ä¸‹æ‹‰é€‰æ‹©å™¨æ ·å¼ */
    .contract-selector {
      display: none; /* é»˜è®¤éšè— */
      margin-bottom: 10px;
    }

    .select-wrapper {
      position: relative;
      margin-bottom: 10px;
    }

    select {
      width: 100%;
      padding: 10px 15px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background-color: var(--card-bg);
      color: var(--text-color);
      appearance: none; /* ç§»é™¤é»˜è®¤æ ·å¼ */
      font-size: 14px;
      cursor: pointer;
    }

    /* è‡ªå®šä¹‰ä¸‹æ‹‰ç®­å¤´ */
    .select-arrow {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      width: 0;
      height: 0;
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
      border-top: 5px solid var(--text-secondary);
      pointer-events: none;
    }

    /* è¿”å›æŒ‰é’®æ ·å¼ */
    .back-btn {
      background: rgba(161, 140, 209, 0.2);
      color: var(--text-secondary);
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 10px;
    }

    .back-btn:hover {
      background: rgba(161, 140, 209, 0.3);
      color: var(--text-color);
    }

    .back-btn svg {
      margin-right: 5px;
      width: 12px;
      height: 12px;
    }

    /* åˆçº¦è¡¨æ ¼æ ·å¼ */
    .contracts-table {
      width: 100%;
      margin-top: 10px;
      border-collapse: collapse;
      font-size: 13px;
      display: none; /* é»˜è®¤éšè— */
    }

    .contracts-table th, .contracts-table td {
      padding: 6px 6px;
      text-align: left;
      border-bottom: 1px solid var(--table-border);
      font-size: 9px;
      color: var(--text-color);
    }

    .contracts-table th {
      font-weight: 600;
      color: var(--text-secondary);
      background-color: var(--table-header-bg);
      position: sticky; /* è¡¨å¤´å›ºå®š */
      top: 0;
      z-index: 1;
    }

    .contracts-table tbody tr {
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .contracts-table tbody tr:hover {
      background-color: var(--table-hover-bg);
    }

    /* ä»·æ ¼æ¶¨è·Œé¢œè‰² */
    .price-up {
      color: var(--positive-color);
    }

    .price-down {
      color: var(--negative-color);
    }

    /* è¡¨æ ¼å®¹å™¨æ ·å¼ */
    .table-container {
      max-height: 300px;
      overflow-y: auto; /* å‚ç›´æ»šåŠ¨ */
      border-radius: 10px;
      box-shadow: var(--card-shadow);
      background-color: var(--card-bg);
      margin-top: 10px;
      display: none; /* é»˜è®¤éšè— */
    }
    
    /* åˆ·æ–°æ•°æ®æŒ‰é’®æ ·å¼ */
    .refresh-data-btn {
      background: linear-gradient(135deg, var(--header-bg), var(--header-bg-end));
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      margin: 10px 0;
      box-shadow: var(--button-shadow);
      transition: all 0.3s ease;
      display: block;
      text-align: center;
    }

    .refresh-data-btn:hover {
      background: linear-gradient(135deg, var(--header-bg), var(--header-bg-end));
      box-shadow: var(--button-hover-shadow);
    }
    
    /* åˆçº¦å‡è´´æ°´å›¾è¡¨å®¹å™¨æ ·å¼ */
    .premium-chart-container {
      width: 100%;
      height: 280px;
      background-color: var(--chart-bg);
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      margin-top: 10px;
      padding: 5px;
      box-sizing: border-box;
    }
    
    /* é”™è¯¯ä¿¡æ¯æ ·å¼ */
    .error-message {
      color: var(--error-color);
      text-align: center;
      padding: 20px;
      background-color: var(--error-bg);
      border-radius: 8px;
      margin: 10px 0;
      font-size: 13px;
    }

    /* ç¼“å­˜æ•°æ®è­¦å‘Šæ ·å¼ */
    .cache-warning {
      color: var(--warning-color);
      text-align: center;
      padding: 10px;
      background-color: var(--warning-bg);
      border-radius: 8px;
      margin: 5px 0;
      font-size: 12px;
    }

    /* æœŸè´§æ¶¨è·Œå¹…åˆ—è¡¨æ ·å¼ */
    .futures-list {
      list-style: none;
      font-size: small;
      padding: 0;
      margin: 0;
    }

    .futures-list li {
      display: flex;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
    }

    .futures-list li:last-child {
      border-bottom: none;
    }

    .futures-list li:hover {
      background-color: var(--table-hover-bg);
    }

    /* æ¶¨è·Œç®­å¤´æ ·å¼ */
    .change-arrow {
      width: 0;
      height: 0;
      margin-right: 4px;
    }

    .change-arrow.up {
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-bottom: 6px solid var(--positive-color); /* ä¸Šæ¶¨ç®­å¤´ï¼ˆå‘ä¸Šï¼‰ */
    }

    .change-arrow.down {
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-top: 6px solid var(--negative-color); /* ä¸‹è·Œç®­å¤´ï¼ˆå‘ä¸‹ï¼‰ */
    }

    .change-arrow.neutral {
      width: 6px;
      height: 2px;
      background-color: var(--neutral-color); /* æŒå¹³ï¼ˆæ¨ªçº¿ï¼‰ */
      margin-top: 2px;
    }

    /* æœŸè´§å“ç§åˆ—è¡¨é¡¹æ ·å¼ */
    .futures-name {
      width: 80px; /* å›ºå®šå®½åº¦ */
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis; /* æ–‡æœ¬æº¢å‡ºæ˜¾ç¤ºçœç•¥å· */
      padding-right: 5px;
    }

    .futures-posrate {
      width: 60px; /* å›ºå®šå®½åº¦ */
      text-align: right;
      font-weight: 500;
      font-size: 11x;
      padding-right: 5px;
      padding-left: 5px;
    }

    .futures-change {
      flex: 1;
      padding-right: 5px;
      min-width: 100px; /* ç¡®ä¿è¶³å¤Ÿå®½åº¦å®¹çº³è¿›åº¦æ¡ */
    }

    /* æ¶¨è·Œå¹…è¿›åº¦æ¡æ ·å¼ */
    .change-bar {
      height: 12px;
      background-color: var(--progress-bg);
      position: relative;
      border-radius: 3px;
      overflow: hidden;
    }

    .change-value {
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
      border-radius: 3px;
      max-width: 80%; /* æœ€å¤§å®½åº¦é™åˆ¶ */
    }

    .change-text {
      position: absolute;
      right: 5px;
      top: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      font-size: 12px;
      color: var(--text-color);
      font-weight: 500;
    }

    /* å›¾è¡¨æ ‡é¢˜æ ·å¼ */
    .chart-title {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-color);
      text-align: center;
      margin-bottom: 8px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* åˆ‡æ¢æŒ‰é’®æ ·å¼ */
    .toggle-btn {
      font-size: 12px;
      background-color: rgba(161, 140, 209, 0.2);
      color: var(--text-secondary);
      border: none;
      padding: 4px 8px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .toggle-btn:hover {
      background-color: rgba(161, 140, 209, 0.4);
      color: var(--text-color);
    }
    
    /* åº•éƒ¨ç»Ÿè®¡æ æ ·å¼ */
    .stats-container {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
    }
    
    .stat-box {
      width: 31%;
      text-align: center;
      background-color: var(--card-bg);
      border-radius: 10px;
      padding: 10px 0;
      box-shadow: var(--card-shadow);
    }
    
    .stat-label {
      font-size: 12px;
      color: var(--text-tertiary);
      margin-bottom: 5px;
    }
    
    .stat-value {
      font-size: 18px;
      font-weight: 600;
    }
    
    .stat-value.up {
      color: var(--positive-color);
    }
    
    .stat-value.down {
      color: var(--negative-color);
    }
    
    .stat-value.neutral {
      color: var(--neutral-color);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- é¡µå¤´éƒ¨åˆ† -->
    <header class="header">
      <a href="https://i.want.biz/long-and-short-position" target="_blank" class="header-icon">
        <i class="fas fa-external-link-alt"></i>
      </a>
      <h1>æœŸè´§å¸‚åœºæ¦‚è§ˆ</h1>
      <button id="refresh-btn-header" class="refresh-btn-header">æš‚åœåˆ·æ–°</button>
    </header>
    
    <!-- å¸‚åœºçŠ¶æ€å’Œæ›´æ–°æ—¶é—´ä¿¡æ¯ -->
    <div class="update-info">
      <div class="market-status" id="market-status">
        <span class="status-indicator status-normal"></span>
        <span>çŠ¶æ€: </span>
        <span id="market-status">-</span>
      </div>
      <div class="data-time">
        <span>æ›´æ–°æ—¶é—´: </span>
        <span id="update-time">-</span>
      </div>
    </div>
    
    <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
    <div id="loading" class="loading">
      <div class="loading-spinner"></div>
      <div>åŠ è½½æ•°æ®ä¸­...</div>
    </div>
    
    <!-- é”™è¯¯ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ -->
    <div id="error" class="error" style="display: none;"></div>
    
    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div id="content" style="display: none;">
      <!-- å¸‚åœºæ¦‚è§ˆéƒ¨åˆ† -->
      <div id="overview-section">
        <div class="chart-container">
          <div class="chart-title">
            <a href="https://wealth.want.biz/pages/longshort.html" style="color: inherit; text-decoration: none; display: inline-flex; align-items: center;">
              æœŸè´§å“ç§æ¶¨è·Œå¹…åŠå¢ä»“ç‡
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-left: 4px;">
                <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                <path d="M15 3h6v6"></path>
                <path d="M10 14L21 3"></path>
              </svg>
            </a>
            <button id="toggle-futures-btn" class="toggle-btn">å±•å¼€å…¨éƒ¨</button>
          </div>
          <ul id="futures-list" class="futures-list">
            <!-- æœŸè´§å“ç§åˆ—è¡¨å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
          </ul>
        </div>
        
        <!-- åº•éƒ¨ç»Ÿè®¡æ  - ç¬¬ä¸€è¡Œæ˜¾ç¤ºä¸Šæ¶¨ã€ä¸‹è·Œã€æŒå¹³æ•°é‡ -->
        <div class="stats-container">
          <div class="stat-box">
            <div class="stat-label">ä¸Šæ¶¨</div>
            <div id="up-count" class="stat-value up">-</div>
          </div>
          
          <div class="stat-box">
            <div class="stat-label">ä¸‹è·Œ</div>
            <div id="down-count" class="stat-value down">-</div>
          </div>
          
          <div class="stat-box">
            <div class="stat-label">æŒå¹³</div>
            <div id="neutral-count" class="stat-value neutral">-</div>
          </div>
        </div>
        
        <!-- ç¬¬äºŒè¡Œç»Ÿè®¡æ  - æ˜¾ç¤ºå¹³å‡æ¶¨å¹…ã€å¹³å‡è·Œå¹…ã€æ€»è®¡æ•°æ® -->
        <div class="stats-container" style="margin-top: 10px;">
          <div class="stat-box">
            <div class="stat-label">å‡æ¶¨</div>
            <div id="limit-up-count" class="stat-value up">-</div>
          </div>
          
          <div class="stat-box">
            <div class="stat-label">å‡è·Œ</div>
            <div id="limit-down-count" class="stat-value down">-</div>
          </div>
          
          <div class="stat-box">
            <div class="stat-label">æ€»è®¡</div>
            <div id="total-count" class="stat-value">-</div>
          </div>
        </div>
      </div>
      
      
      <!-- å“ç§é€‰æ‹©å™¨éƒ¨åˆ† - ç”¨äºæŸ¥çœ‹ç‰¹å®šå“ç§çš„åˆçº¦è¯¦æƒ… -->
      <div id="contract-selector" class="contract-selector">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <button id="back-to-overview" class="back-btn">
            <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none">
              <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            è¿”å›æ¦‚è§ˆ
          </button>
          <button id="refresh-variety-data" class="refresh-data-btn">é¾™è™æ¦œ</button>
          <div class="select-wrapper">
            <select id="variety-select">
              <option value="">è¯·é€‰æ‹©å“ç§</option>
            </select>
            <div class="select-arrow"></div>
          </div>
        </div>
    
        
        <!-- <button id="refresh-variety-data" class="refresh-data-btn">åˆ·æ–°æ•°æ®</button> -->
        
        <!-- å‡è´´æ°´å›¾è¡¨ - æ˜¾ç¤ºå“ç§åˆçº¦çš„å‡è´´æ°´ç»“æ„ -->
        <div id="premium-chart-container" class="premium-chart-container">
          <div id="premium-chart-wrapper" style="width: 100%; height: 100%;">
            <div id="premium-chart" style="width: 100%; height: 100%;"></div>
          </div>
        </div>
        
        <!-- åˆçº¦è¡¨æ ¼ - æ˜¾ç¤ºå“ç§æ‰€æœ‰åˆçº¦çš„è¯¦ç»†æ•°æ® -->
        <div id="table-container" class="table-container">
          <table id="contracts-table" class="contracts-table">
            <thead>
              <tr>
                <th>åˆçº¦</th>
                <th>æœ€æ–°</th>
                <th>æ¶¨å¹…</th>
                <th>æˆäº¤</th>
                <th>æŒä»“</th>
                <th>é‡‘é¢</th>
                <th>æ²‰æ·€</th>
                <th>å¢ä»“</th>
                <th>äº”æ—¥</th>
              </tr>
            </thead>
            <tbody id="contracts-body">
              <!-- åˆçº¦æ•°æ®å°†é€šè¿‡JavaScriptå¡«å…… -->
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- åˆçº¦è¯¦æƒ…è§†å›¾ - æ˜¾ç¤ºå•ä¸ªåˆçº¦çš„è¯¦ç»†ä¿¡æ¯ -->
      <div id="contract-detail" class="contract-detail">
        <div class="contract-detail-header">
          <div class="contract-name" id="contract-name"></div>
          <button id="close-detail" class="close-detail">Ã—</button>
        </div>
        
        <!-- åˆçº¦ä¿¡æ¯ç½‘æ ¼ - æ˜¾ç¤ºåˆçº¦ä¸»è¦æŒ‡æ ‡ -->
        <div class="contract-info-grid">
          <div class="contract-info-item">
            <div class="contract-info-label">æœ€æ–°ä»·</div>
            <div id="contract-price" class="contract-info-value">-</div>
          </div>
          <div class="contract-info-item">
            <div class="contract-info-label">æ¶¨è·Œå¹…</div>
            <div id="contract-change" class="contract-info-value">-</div>
          </div>
          <div class="contract-info-item">
            <div class="contract-info-label">æˆäº¤é‡</div>
            <div id="contract-volume" class="contract-info-value">-</div>
          </div>
          <div class="contract-info-item">
            <div class="contract-info-label">æŒä»“é‡</div>
            <div id="contract-position" class="contract-info-value">-</div>
          </div>
          <div class="contract-info-item">
            <div class="contract-info-label">æˆäº¤é¢</div>
            <div id="contract-cje" class="contract-info-value">-</div>
          </div>
          <div class="contract-info-item">
            <div class="contract-info-label">æ²‰æ·€èµ„é‡‘</div>
            <div id="contract-cdzj" class="contract-info-value">-</div>
          </div>
          <div class="contract-info-item">
            <div class="contract-info-label">å¢ä»“ç‡</div>
            <div id="contract-zcl" class="contract-info-value">-</div>
          </div>
          <div class="contract-info-item">
            <div class="contract-info-label">äº”æ—¥æ¶¨å¹…</div>
            <div id="contract-zdf5" class="contract-info-value">-</div>
          </div>
        </div>
        
        <!-- åˆçº¦å‡è´´æ°´å›¾è¡¨ - å±•ç¤ºç›¸å¯¹äºå½“å‰åˆçº¦çš„å‡è´´æ°´ç»“æ„ -->
        <div id="contract-premium-chart-wrapper" style="width: 100%; height: 220px; margin-top: 10px;">
          <div id="contract-premium-chart" class="contract-chart"></div>
        </div>
      </div>
    </div>
    
    <!-- åº•éƒ¨åˆ·æ–°æŒ‰é’® -->
    <button id="refresh-btn" class="refresh-btn">åˆ·æ–°æ•°æ®</button>
  </div>
  
  <script>
    // å…¨å±€å˜é‡å®šä¹‰
    let chart = null; // ä¸»å›¾è¡¨å®ä¾‹
    let premiumChart = null; // å‡è´´æ°´å›¾è¡¨å®ä¾‹
    let contractDetailChart = null; // åˆçº¦è¯¦æƒ…å›¾è¡¨å®ä¾‹
    let echartsLoadRetries = 0; // EChartsåŠ è½½é‡è¯•æ¬¡æ•°
    const MAX_RETRIES = 3; // æœ€å¤§é‡è¯•æ¬¡æ•°
    let autoUpdateInterval = null; // è‡ªåŠ¨æ›´æ–°å®šæ—¶å™¨
    let isAutoUpdateEnabled = true; // æ˜¯å¦å¯ç”¨è‡ªåŠ¨æ›´æ–°
    let futuresData = []; // æœŸè´§æ•°æ®
    let contractsData = {}; // åˆçº¦æ•°æ®
    let varietyIdMap = {}; // å“ç§IDæ˜ å°„
    let currentVariety = null; // å½“å‰é€‰æ‹©çš„å“ç§
    let showAllFutures = false; // æ§åˆ¶æ˜¯å¦æ˜¾ç¤ºå…¨éƒ¨å“ç§
    
    // æ•°æ®å¤‡ä»½å’Œå›é€€æœºåˆ¶ - ç”¨äºå¤„ç†è¯·æ±‚å¤±è´¥æ—¶çš„å›é€€
    let lastSuccessfulFuturesData = null; // ä¸Šæ¬¡æˆåŠŸè·å–çš„æœŸè´§æ•°æ®
    let lastSuccessfulContractsData = {}; // ä¸Šæ¬¡æˆåŠŸè·å–çš„åˆçº¦æ•°æ®
    let lastUpdateTime = null; // ä¸Šæ¬¡æˆåŠŸæ›´æ–°çš„æ—¶é—´
    
    // äº¤æ˜“æ‰€æ˜ å°„è¡¨ - å°†äº¤æ˜“æ‰€ä»£ç æ˜ å°„åˆ°APIéœ€è¦çš„ID
    const EXCHANGE_MAP = {
      'SHFE': 113, // ä¸Šæµ·æœŸè´§äº¤æ˜“æ‰€
      'DCE': 114, // å¤§è¿å•†å“äº¤æ˜“æ‰€
      'CZCE': 115, // éƒ‘å·å•†å“äº¤æ˜“æ‰€
      'GFEX': 225, // å¹¿å·æœŸè´§äº¤æ˜“æ‰€
      'INE': 142, // ä¸Šæµ·å›½é™…èƒ½æºäº¤æ˜“ä¸­å¿ƒ
      'CFFEX': 220 // ä¸­å›½é‡‘èæœŸè´§äº¤æ˜“æ‰€
    };

    // åˆå§‹åŒ–é¡µé¢ - å½“DOMå†…å®¹åŠ è½½å®Œæˆåæ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', function() {
      // éšè—é”™è¯¯ä¿¡æ¯
      document.getElementById('error').style.display = 'none';
      
      // æ·»åŠ é¡µé¢å¸è½½äº‹ä»¶ï¼Œç¡®ä¿åœ¨é¡µé¢åˆ·æ–°æˆ–è·³è½¬æ—¶é”€æ¯å›¾è¡¨
      window.addEventListener('beforeunload', function() {
        // å®‰å…¨åœ°é”€æ¯æ‰€æœ‰å›¾è¡¨å®ä¾‹ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
        safeDisposeChart(premiumChart);
        safeDisposeChart(contractDetailChart);
        safeDisposeChart(chart);
      });
      
      // ç»‘å®šåˆ·æ–°æŒ‰é’®äº‹ä»¶
      const refreshBtn = document.getElementById('refresh-btn');
      const refreshBtnHeader = document.getElementById('refresh-btn-header');
      const refreshVarietyBtn = document.getElementById('refresh-variety-data');
      
      // åˆå§‹åŒ–å±•å¼€/æŠ˜å æŒ‰é’® - æ§åˆ¶æ˜¾ç¤ºæ‰€æœ‰å“ç§æˆ–ä»…æ˜¾ç¤ºå‰å‡ ä¸ª
      const toggleBtn = document.getElementById('toggle-futures-btn');
      if (toggleBtn) {
        // ä»localStorageè¯»å–ç”¨æˆ·åå¥½ - ä¿æŒç”¨æˆ·ç•Œé¢ä¸€è‡´æ€§
        const savedPreference = localStorage.getItem('showAllFutures');
        if (savedPreference !== null) {
          showAllFutures = savedPreference === 'true';
          toggleBtn.textContent = showAllFutures ? 'æŠ˜å åˆ—è¡¨' : 'å±•å¼€å…¨éƒ¨';
        }
        
        // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œåˆ‡æ¢æ˜¾ç¤ºæ¨¡å¼
        toggleBtn.addEventListener('click', function() {
          showAllFutures = !showAllFutures;
          this.textContent = showAllFutures ? 'æŠ˜å åˆ—è¡¨' : 'å±•å¼€å…¨éƒ¨';
          
          // ä¿å­˜ç”¨æˆ·åå¥½åˆ°localStorageä¸­
          try {
            localStorage.setItem('showAllFutures', showAllFutures);
          } catch (e) {
            console.warn('æ— æ³•ä¿å­˜ç”¨æˆ·åå¥½:', e);
          }
          
          // æ ¹æ®æ–°çš„æ˜¾ç¤ºæ¨¡å¼é‡æ–°æ¸²æŸ“åˆ—è¡¨
          updateFuturesList(futuresData);
        });
      }
      
      // ç»‘å®šåº•éƒ¨åˆ·æ–°æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      refreshBtn.addEventListener('click', function() {
        fetchData(); // æ‰‹åŠ¨åˆ·æ–°æ•°æ®
      });
      
      // ç»‘å®šé¡µå¤´åˆ·æ–°æŒ‰é’®ç‚¹å‡»äº‹ä»¶ - æ§åˆ¶è‡ªåŠ¨æ›´æ–°
      refreshBtnHeader.addEventListener('click', function() {
        if (isAutoUpdateEnabled) {
          // å¦‚æœè‡ªåŠ¨æ›´æ–°å¼€å¯ï¼Œç‚¹å‡»æŒ‰é’®æš‚åœ
          stopAutoUpdate();
          refreshBtnHeader.textContent = 'å¼€å¯è‡ªåŠ¨æ›´æ–°';
          refreshBtnHeader.classList.add('paused');
        } else {
          // å¦‚æœè‡ªåŠ¨æ›´æ–°å…³é—­ï¼Œç‚¹å‡»æŒ‰é’®å¼€å¯
          startAutoUpdate();
          refreshBtnHeader.textContent = 'æš‚åœè‡ªåŠ¨æ›´æ–°';
          refreshBtnHeader.classList.remove('paused');
        }
      });
      
      // ç»‘å®šé¾™è™æ¦œæŒ‰é’®ç‚¹å‡»äº‹ä»¶ - è·³è½¬åˆ°é¾™è™æ¦œé¡µé¢
      refreshVarietyBtn.addEventListener('click', function() {
        const variety = document.getElementById('variety-select').value;
        console.log('é¾™è™æ¦œæŒ‰é’®ç‚¹å‡»ï¼Œé€‰æ‹©çš„å“ç§:', variety);
        
        if (variety) {
          // æå–çº¯å“ç§ä»£ç ï¼ˆä¸å«äº¤æ˜“æ‰€å‰ç¼€ï¼‰
          const pureVariety = variety.split('_')[1] || variety;
          // è·³è½¬åˆ°è¯¥å“ç§çš„é¾™è™æ¦œé¡µé¢
          window.location.href = `longshort.html?variety=${encodeURIComponent(pureVariety)}`;
        } else {
          alert('è¯·å…ˆé€‰æ‹©å“ç§');
        }
      });
      
      // ç»‘å®šåé€€æŒ‰é’®äº‹ä»¶ - ä»åˆçº¦é€‰æ‹©å™¨è¿”å›æ¦‚è§ˆé¡µé¢
      document.getElementById('back-to-overview').addEventListener('click', function() {
        // è¿”å›æ¦‚è§ˆå‰é”€æ¯å›¾è¡¨å®ä¾‹ï¼Œé¿å…å†…å­˜æ³„æ¼
        safeDisposeChart(premiumChart);
        safeDisposeChart(contractDetailChart);
        showOverview();
      });
      
      // ç»‘å®šå…³é—­åˆçº¦è¯¦æƒ…æŒ‰é’®äº‹ä»¶
      document.getElementById('close-detail').addEventListener('click', function() {
        // å…³é—­åˆçº¦è¯¦æƒ…å‰é”€æ¯å›¾è¡¨å®ä¾‹
        safeDisposeChart(contractDetailChart);
        document.getElementById('contract-detail').style.display = 'none';
        document.getElementById('contract-selector').style.display = 'block';
      });
      
      // ç»‘å®šå“ç§é€‰æ‹©å™¨äº‹ä»¶ - å½“é€‰æ‹©ä¸åŒå“ç§æ—¶æ›´æ–°æ•°æ®
      document.getElementById('variety-select').addEventListener('change', function() {
        const variety = this.value;
        console.log('å“ç§é€‰æ‹©å˜æ›´:', variety);
        
        if (variety) {
          currentVariety = variety;
          fetchVarietyContracts(variety);
        } else {
          // æœªé€‰æ‹©å“ç§æ—¶æ˜¾ç¤ºæç¤ºä¿¡æ¯
          const premiumChartElement = document.getElementById('premium-chart');
          if (premiumChartElement) {
            premiumChartElement.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;color:var(--text-secondary);">è¯·é€‰æ‹©å“ç§</div>';
          }
          const contractsBody = document.getElementById('contracts-body');
          if (contractsBody) {
            contractsBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">è¯·é€‰æ‹©å“ç§</td></tr>';
          }
        }
      });
      
      // ä»sessionStorageæ¢å¤å½“å‰å“ç§ï¼ˆå¦‚æœæœ‰ï¼‰- ä¿æŒé¡µé¢è·³è½¬åçš„çŠ¶æ€ä¸€è‡´æ€§
      try {
        const savedVariety = sessionStorage.getItem('currentVariety');
        if (savedVariety) {
          currentVariety = savedVariety;
        }
      } catch (e) {
        console.warn('æ— æ³•ä»sessionStorageè¯»å–å½“å‰å“ç§:', e);
      }
      
      // æ£€æŸ¥URLå‚æ•°ï¼Œå¤„ç†ä»å…¶ä»–é¡µé¢è·³è½¬è¿‡æ¥çš„è¯·æ±‚
      const urlParams = new URLSearchParams(window.location.search);
      const varietyParam = urlParams.get('variety');
      const showPremium = urlParams.get('showPremium');
      
      if (varietyParam && showPremium === 'true') {
        // å¦‚æœURLä¸­åŒ…å«å“ç§å‚æ•°å’ŒshowPremium=trueå‚æ•°ï¼Œç›´æ¥æ˜¾ç¤ºå‡è´´æ°´é¡µé¢
        currentVariety = varietyParam;
        showContractSelector(varietyParam);
      }
      
      // æ£€æŸ¥EChartsæ˜¯å¦åŠ è½½
      checkEChartsLoaded();
      
      // å¯åŠ¨è‡ªåŠ¨æ›´æ–°
      startAutoUpdate();
      
      // ç›‘å¬ä¸»é¢˜å˜åŒ–ï¼Œä»¥æ›´æ–°å›¾è¡¨æ ·å¼
      const darkModeMediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
      darkModeMediaQuery.addEventListener('change', handleThemeChange);
    });
    
    // å¤„ç†ä¸»é¢˜å˜åŒ– - å½“ç³»ç»Ÿä¸»é¢˜åœ¨äº®è‰²/æš—è‰²é—´åˆ‡æ¢æ—¶æ›´æ–°å›¾è¡¨æ ·å¼
    function handleThemeChange() {
      console.log('ä¸»é¢˜å˜åŒ–è¢«æ£€æµ‹åˆ°');
      
      // å¦‚æœå›¾è¡¨å·²ç»åˆ›å»ºï¼Œæ›´æ–°å®ƒä»¬çš„ä¸»é¢˜
      if (premiumChart) {
        try {
          // å»¶è¿Ÿæ‰§è¡Œä»¥ç¡®ä¿CSSå˜é‡å·²æ›´æ–°
          setTimeout(() => {
            renderPremiumChart(currentVariety, contractsData[currentVariety] || []);
          }, 100);
        } catch (e) {
          console.warn('æ›´æ–°å‡è´´æ°´å›¾è¡¨ä¸»é¢˜å¤±è´¥:', e);
        }
      }
      
      if (contractDetailChart) {
        try {
          // è·å–å½“å‰æ˜¾ç¤ºçš„åˆçº¦è¯¦æƒ…
          const contractName = document.getElementById('contract-name').textContent;
          const contracts = contractsData[currentVariety] || [];
          const contract = contracts.find(c => c.code === contractName);
          
          if (contract) {
            setTimeout(() => {
              renderContractPremiumChart(contract);
            }, 100);
          }
        } catch (e) {
          console.warn('æ›´æ–°åˆçº¦è¯¦æƒ…å›¾è¡¨ä¸»é¢˜å¤±è´¥:', e);
        }
      }
    }

    // è·å–CSSå˜é‡çš„å½“å‰å€¼ - ç”¨äºåŠ¨æ€é€‚åº”ä¸»é¢˜
    function getCssVariable(varName, defaultValue = '') {
      return getComputedStyle(document.documentElement).getPropertyValue(varName).trim() || defaultValue;
    }

    // å¸¦è¶…æ—¶çš„fetchè¯·æ±‚ - é˜²æ­¢è¯·æ±‚é•¿æ—¶é—´æŒ‚èµ·
    async function fetchWithTimeout(url, options = {}, timeout = 10000) {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeout);
      
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });
        clearTimeout(id);
        return response;
      } catch (error) {
        clearTimeout(id);
        throw error;
      }
    }

    // å¸¦é‡è¯•çš„fetchè¯·æ±‚ - å¢å¼ºç½‘ç»œè¯·æ±‚çš„å¥å£®æ€§
    async function fetchWithRetry(url, options = {}, retries = 2) {
      let lastError;
      
      for (let i = 0; i < retries; i++) {
        try {
          return await fetchWithTimeout(url, options);
        } catch (error) {
          console.warn(`è¯·æ±‚å¤±è´¥(${i+1}/${retries}):`, error);
          lastError = error;
          // ç­‰å¾…ä¸€æ®µæ—¶é—´å†é‡è¯•
          if (i < retries - 1) {
            await new Promise(r => setTimeout(r, 1000));
          }
        }
      }
      
      throw lastError; // é‡è¯•è€—å°½åæŠ›å‡ºæœ€åçš„é”™è¯¯
    }

    // ä»å“ç§åç§°è·å–å“ç§ID - ç”¨äºAPIè¯·æ±‚
    function getVarietyIdFromName(name) {
      if (!name) return '';
      
      // æå–ä¸å«æ•°å­—çš„ä¸­æ–‡å“ç§å
      const varietyName = extractVarietyCode(name);
      
      // æŸ¥æ‰¾æ˜ å°„è¡¨ä¸­çš„å“ç§ID
      if (varietyIdMap[varietyName]) {
        return varietyIdMap[varietyName];
      }
      
      // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼ŒæŸ¥æ‰¾futuresDataå°è¯•æ„å»ºID
      const matchedItem = futuresData.find(item => {
        return extractVarietyCode(item.name) === varietyName;
      });
      
      if (matchedItem && matchedItem.uid) {
        // è§£æUIDå¾—åˆ°äº¤æ˜“æ‰€å’Œå“ç§ä»£ç 
        const parts = matchedItem.uid.split('|');
        if (parts.length >= 2) {
          const exchange = parts[0];
          const code = parts[1];
          
          // ä»ä»£ç ä¸­æå–å“ç§éƒ¨åˆ†ï¼ˆå»æ‰æœˆä»½æ•°å­—ï¼‰
          const variety = code.replace(/\d+/g, '');
          
          // ç»„åˆæˆmsgidæ ¼å¼
          if (EXCHANGE_MAP[exchange] && variety) {
            return `${EXCHANGE_MAP[exchange]}_${variety.toLowerCase()}`;
          }
        }
      }
      
      // å¦‚æœæ‰¾ä¸åˆ°ï¼Œå°è¯•ç›´æ¥å°†åç§°ç”¨ä½œID
      return varietyName.toLowerCase();
    }

    // ä»UIDæå–çº¯å­—æ¯å“ç§ä»£ç 
    function extractVarietyCodeFromUID(uid) {
      if (!uid) return '';
      
      const parts = uid.split('|');
      if (parts.length < 2) return '';
      
      const contractCode = parts[1];
      // æå–ä»£ç ä¸­çš„å­—æ¯éƒ¨åˆ†
      const letterMatches = contractCode.match(/[A-Za-z]+/);
      if (!letterMatches) return '';
      
      return letterMatches[0].toLowerCase();
    }

    // å¼€å§‹è‡ªåŠ¨æ›´æ–° - ä½¿ç”¨setTimeoutä»£æ›¿setIntervalï¼Œé¿å…é‡å æ‰§è¡Œ
    function startAutoUpdate() {
      isAutoUpdateEnabled = true;
      // ç«‹å³è·å–ä¸€æ¬¡æ•°æ®
      fetchData()
        .catch(error => {
          console.error('åˆå§‹æ•°æ®åŠ è½½å¤±è´¥:', error);
          showErrorMessage('åˆå§‹æ•°æ®åŠ è½½å¤±è´¥: ' + error.message);
        })
        .finally(() => {
          // è®¾ç½®ä¸‹ä¸€æ¬¡åˆ·æ–°
          if (isAutoUpdateEnabled) {
            if (autoUpdateInterval) clearTimeout(autoUpdateInterval);
            autoUpdateInterval = setTimeout(() => startAutoUpdate(), 30000); // 30ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡
          }
        });
    }

    // åœæ­¢è‡ªåŠ¨æ›´æ–°
    function stopAutoUpdate() {
      isAutoUpdateEnabled = false;
      if (autoUpdateInterval) {
        clearTimeout(autoUpdateInterval);
        autoUpdateInterval = null;
      }
    }

    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    function showErrorMessage(message) {
      const errorElement = document.getElementById('error');
      if (errorElement) {
        errorElement.textContent = message;
        errorElement.style.display = 'block';
      }
    }

    // åˆ›å»ºç¼“å­˜æ•°æ®è­¦å‘Šå…ƒç´  - åœ¨ä½¿ç”¨ç¼“å­˜æ•°æ®æ—¶æ˜¾ç¤ºæç¤º
    // åœ¨äº¤æ˜“æ‰€æ•°æ®æ›´æ–°æ—¶é—´æ®µï¼ˆ15:30-17:00ï¼‰å¼ºåˆ¶è·å–æœ€æ–°æ•°æ®,ç½‘ç»œè¯·æ±‚å¤±è´¥æ—¶è‡ªåŠ¨ä½¿ç”¨ç¼“å­˜æ•°æ®
    function createCacheWarning(message, container) {
      const warningDiv = document.createElement('div');
      warningDiv.className = 'cache-warning';
      warningDiv.textContent = message;
      
      if (container) {
        // æ¸…ç©ºå®¹å™¨å¹¶æ·»åŠ è­¦å‘Š
        container.innerHTML = '';
        container.appendChild(warningDiv);
        
        // 3ç§’åè‡ªåŠ¨ç§»é™¤è­¦å‘Š
        setTimeout(() => {
          if (warningDiv.parentNode === container) {
            container.removeChild(warningDiv);
          }
        }, 5000);
      }
      
      return warningDiv;
    }

    // æ˜¾ç¤ºåŠ è½½è¿›åº¦åŠ¨ç”» - æå‡ç”¨æˆ·ä½“éªŒ
    function showLoadingProgress() {
      const loadingIndicator = document.getElementById('loading');
      if (loadingIndicator) {
        let progress = 0;
        const interval = setInterval(() => {
          progress = Math.min(progress + Math.random() * 10, 100);
          loadingIndicator.innerHTML = `åŠ è½½ä¸­ ã€${Math.floor(progress)}%ã€‘ğŸŒ· ğŸŒ¹ ğŸŒ·   `;
          if (progress >= 100) clearInterval(interval);
        }, 300);
      }
    }

    // æ£€æŸ¥EChartsæ˜¯å¦åŠ è½½ - åŒ…å«æ•…éšœæ¢å¤é€»è¾‘
    function checkEChartsLoaded() {
      if (typeof echarts !== 'undefined') {
        console.log('EChartså·²æˆåŠŸåŠ è½½');
        // EChartså·²åŠ è½½ï¼Œåˆå§‹åŠ è½½æ•°æ®
        fetchData();
      } else if (echartsLoadRetries < MAX_RETRIES) {
        console.log(`EChartsæœªåŠ è½½ï¼Œå°è¯•é‡æ–°åŠ è½½ (${echartsLoadRetries + 1}/${MAX_RETRIES})`);
        echartsLoadRetries++;
        
        // å°è¯•åŠ¨æ€åŠ è½½ECharts
        const script = document.createElement('script');
        // ä½¿ç”¨CDNé“¾æ¥ä½œä¸ºå¤‡é€‰ï¼Œä»¥é˜²æœ¬åœ°æ–‡ä»¶åŠ è½½å¤±è´¥
        script.src = 'https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js';
        script.onload = function() {
          console.log('EChartsåŠ¨æ€åŠ è½½æˆåŠŸ');
          fetchData();
        };
        script.onerror = function() {
          console.error('EChartsåŠ¨æ€åŠ è½½å¤±è´¥');
          setTimeout(checkEChartsLoaded, 1000); // 1ç§’åé‡è¯•
        };
        document.head.appendChild(script);
      } else {
        console.error('EChartsåŠ è½½å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°');
        const errorElement = document.getElementById('error');
        errorElement.textContent = 'EChartsåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
        errorElement.style.display = 'block';
        document.getElementById('loading').style.display = 'none';
      }
    }

    // è·å–å½“å‰æ—¶é—´å¹¶åˆ¤æ–­æ˜¯å¦ä¸ºæ—¥ç›˜æ—¶æ®µ
    function isDaySession() {
        const now = new Date();
        const hours = now.getHours();
        const minutes = now.getMinutes();
        
        // åˆ¤æ–­æ˜¯å¦åœ¨æ—¥ç›˜æ—¶æ®µï¼ˆ8:30 - 15:30ï¼‰
        const startOfDaySession = 8 * 60 + 30;  // 8:30 è½¬æ¢ä¸ºåˆ†é’Ÿ
        const endOfDaySession = 15 * 60 + 30;   // 15:30 è½¬æ¢ä¸ºåˆ†é’Ÿ
        const currentTimeInMinutes = hours * 60 + minutes;

        return currentTimeInMinutes >= startOfDaySession && currentTimeInMinutes <= endOfDaySession;
    }

    // è·å–æœŸè´§å¸‚åœºæ•°æ® - å¢åŠ æ•°æ®å¤‡ä»½å’Œå›é€€æœºåˆ¶
    async function fetchData() {
      const loadingIndicator = document.getElementById('loading');
      const contentElement = document.getElementById('content');
      const errorElement = document.getElementById('error');
      
      // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨å¹¶å¯åŠ¨è¿›åº¦æ¡
      loadingIndicator.style.display = 'block';
      showLoadingProgress();
      contentElement.style.display = 'none';
      errorElement.style.display = 'none';
      
      try {
        // æ£€æŸ¥EChartsæ˜¯å¦å¯ç”¨
        if (typeof echarts === 'undefined') {
          throw new Error('EChartsæœªåŠ è½½ï¼Œæ— æ³•æ˜¾ç¤ºå›¾è¡¨');
        }
        
        // æ£€æŸ¥å½“å‰æ—¶é—´æ˜¯å¦ä¸ºæ—¥ç›˜æ—¶æ®µï¼Œé€‰æ‹©å¯¹åº”çš„ API åœ°å€
        const apiUrl = isDaySession() ? 'https://q.want.biz/' : 'https://q.want.biz/night';
        console.log(`è·å–æœŸè´§æ•°æ®ï¼Œä½¿ç”¨API: ${apiUrl}`); // è°ƒè¯•è¾“å‡º
        
        // è·å–æœŸè´§æ•°æ®
        const response = await fetchWithRetry(apiUrl);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        if (!data || !data.list || data.list.length === 0) {
          throw new Error('è·å–æ•°æ®å¤±è´¥ï¼Œæ•°æ®ç»“æ„ä¸ç¬¦åˆé¢„æœŸ');
        }
        
        // ä¿å­˜æ•°æ®
        futuresData = data.list;
        
        // åŒæ—¶ä¿å­˜æˆåŠŸçš„æ•°æ®ä¸ºå¤‡ä»½ï¼Œç”¨äºæ•…éšœæ¢å¤
        lastSuccessfulFuturesData = [...data.list];
        lastUpdateTime = new Date();
        
        // æ›´æ–°å“ç§IDæ˜ å°„
        buildVarietyIdMap();
        
        // åˆ†ææ•°æ®
        const analysisResults = analyzeFuturesData(futuresData);
        
        // å…ˆæ˜¾ç¤ºå†…å®¹å®¹å™¨ï¼Œå› ä¸ºå›¾è¡¨éœ€è¦å¯è§çš„å®¹å™¨æ¥è®¡ç®—å°ºå¯¸
        contentElement.style.display = 'block';
        loadingIndicator.style.display = 'none';
        
        // æ›´æ–°æœŸè´§åˆ—è¡¨å’Œæ‘˜è¦
        updateFuturesList(futuresData);
        updateSummary(analysisResults);
        
        // å¦‚æœæœ‰ä¿å­˜çš„å½“å‰å“ç§å¹¶ä¸”åœ¨åˆçº¦é€‰æ‹©å™¨è§†å›¾ï¼Œåˆ™è‡ªåŠ¨åŠ è½½å®ƒ
        if (currentVariety && document.getElementById('contract-selector').style.display === 'block') {
          fetchVarietyContracts(currentVariety);
        }
        
      } catch (error) {
        console.error('è·å–æˆ–å¤„ç†æ•°æ®æ—¶å‡ºé”™:', error);
        
        // å¦‚æœæœ‰ä¸Šæ¬¡æˆåŠŸè·å–çš„æ•°æ®ï¼Œä½¿ç”¨å®ƒï¼ˆæ•…éšœæ¢å¤æœºåˆ¶ï¼‰
        if (lastSuccessfulFuturesData && lastSuccessfulFuturesData.length > 0) {
          console.log('ä½¿ç”¨ä¸Šæ¬¡ç¼“å­˜çš„æ•°æ®', lastUpdateTime?.toLocaleString() || 'æœªçŸ¥æ—¶é—´');
          
          // ä½¿ç”¨å¤‡ä»½æ•°æ®
          futuresData = [...lastSuccessfulFuturesData];
          
          // åˆ†æå¤‡ä»½æ•°æ®
          const analysisResults = analyzeFuturesData(futuresData);
          analysisResults.lastUpdated += ' (ç¼“å­˜)';
          
          // æ˜¾ç¤ºå†…å®¹
          contentElement.style.display = 'block';
          loadingIndicator.style.display = 'none';
          
          // æ›´æ–°UIä½¿ç”¨å¤‡ä»½æ•°æ®
          updateFuturesList(futuresData);
          updateSummary(analysisResults);
          
          // æ˜¾ç¤ºç¼“å­˜æ•°æ®è­¦å‘Š
          const cacheWarning = document.createElement('div');
          cacheWarning.className = 'cache-warning';
          cacheWarning.textContent = `æ•°æ®æ›´æ–°å¤±è´¥ï¼Œä½¿ç”¨ç¼“å­˜æ•°æ® (${error.message})`;
          
          // æ·»åŠ åˆ°å†…å®¹åŒºåŸŸé¡¶éƒ¨
          if (contentElement.firstChild) {
            contentElement.insertBefore(cacheWarning, contentElement.firstChild);
          } else {
            contentElement.appendChild(cacheWarning);
          }
          
          // 5ç§’åè‡ªåŠ¨ç§»é™¤è­¦å‘Š
          setTimeout(() => {
            if (cacheWarning.parentNode) {
              cacheWarning.parentNode.removeChild(cacheWarning);
            }
          }, 5000);
          
          // å¦‚æœå½“å‰åœ¨åˆçº¦é€‰æ‹©å™¨é¡µé¢ï¼Œå°è¯•åˆ·æ–°åˆçº¦æ•°æ®
          if (currentVariety && document.getElementById('contract-selector').style.display === 'block') {
            fetchVarietyContracts(currentVariety);
          }
        } else {
          // æ²¡æœ‰å¤‡ä»½æ•°æ®ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
          errorElement.textContent = error.message || 'åŠ è½½æ•°æ®å¤±è´¥';
          errorElement.style.display = 'block';
          loadingIndicator.style.display = 'none';
        }
      }
    }

    // æ„å»ºå“ç§IDæ˜ å°„è¡¨ - ç”¨äºAPIè¯·æ±‚å’Œæ•°æ®åŒ¹é…
    function buildVarietyIdMap() {
      varietyIdMap = {};
      
      futuresData.forEach(item => {
        if (!item.uid || !item.name) return;
        
        const [exchange, code] = item.uid.split('|');
        if (!exchange || !code) return;
        
        // ä»ä»£ç ä¸­æå–å“ç§éƒ¨åˆ†ï¼ˆå»æ‰æœˆä»½æ•°å­—ï¼‰
        const variety = code.replace(/\d+/g, '');
        const varietyName = extractVarietyCode(item.name);
        
        if (variety && varietyName && EXCHANGE_MAP[exchange]) {
          const msgid = `${EXCHANGE_MAP[exchange]}_${variety.toLowerCase()}`;
          varietyIdMap[varietyName] = msgid;
          
          // åŒæ—¶å‚¨å­˜å°å†™å­—æ¯ä»£ç åˆ°æ˜ å°„è¡¨ï¼Œæ–¹ä¾¿æŸ¥æ‰¾
          varietyIdMap[variety.toLowerCase()] = msgid;
          
          // æ·»åŠ æ›´å¤šæ˜ å°„å…³ç³»ï¼Œæé«˜åŒ¹é…æˆåŠŸç‡
          if (item.code) {
            varietyIdMap[item.code.toLowerCase()] = msgid;
          }
        }
      });
      
      console.log('å·²æ„å»ºå“ç§IDæ˜ å°„è¡¨:', varietyIdMap);
    }

    // åˆ¤æ–­å½“å‰æ˜¯å¦æ˜¯å¤œç›˜äº¤æ˜“æ—¶é—´
    function isTradingHours() {
        const now = new Date();
        
        // æ’é™¤å‘¨æœ«ï¼ˆå‘¨å…­6ï¼Œå‘¨æ—¥0ï¼‰
        if ([0, 6].includes(now.getDay())) {
            return false;
        }

        const hours = now.getHours();
        const minutes = now.getMinutes();
        const totalMinutes = hours * 60 + minutes;

        // æ—¥ç›˜äº¤æ˜“æ—¶æ®µï¼š9:00-11:30 å’Œ 13:30-15:00
        const daySession1 = (9 * 60) <= totalMinutes && totalMinutes < (11 * 60 + 30);
        const daySession2 = (13 * 60 + 30) <= totalMinutes && totalMinutes < (15 * 60);
        
        // å¤œç›˜äº¤æ˜“æ—¶æ®µï¼š21:00-æ¬¡æ—¥2:30
        const nightSession = (totalMinutes >= 21 * 60) || (totalMinutes < 2 * 60 + 30);

        return daySession1 || daySession2 || nightSession;
    }

    // è®¡ç®—å¢ä»“ç‡ - ä½¿ç”¨åŸå§‹å…¬å¼: rz/(ccl-rz)
    // rzæ˜¯å¢ä»“é‡ï¼Œcclæ˜¯æŒä»“é‡
    function calculatePositionChangeRate(item) {
      const rz = parseFloat(item.rz) || 0;
      const ccl = parseFloat(item.ccl) || 0;
      
      // å¦‚æœcclæˆ–ccl-rzä¸º0ï¼Œè¿”å›0ï¼Œé¿å…é™¤ä»¥0çš„é”™è¯¯
      if (ccl === 0 || ccl <= rz) return 0;
      
      // è®¡ç®—å¢ä»“ç‡ = å¢ä»“é‡/(æŒä»“é‡-å¢ä»“é‡) * 100%
      const rate = (rz / (ccl - rz)) * 100;
      return rate.toFixed(2);
    }

    // åˆ†ææœŸè´§æ•°æ® - è®¡ç®—æ¶¨è·Œç»Ÿè®¡ã€å¹³å‡æ¶¨è·Œå¹…ç­‰
    function analyzeFuturesData(futuresData) {
      // é»˜è®¤å€¼
      let result = {
        totalVolume: 0,
        totalContracts: 0,
        upCount: 0,
        downCount: 0,
        neutralCount: 0,
        avgUpChange: 0,
        avgDownChange: 0,
        lastUpdated: new Date().toLocaleString('zh-CN')
      };
      
      // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œè¿”å›é»˜è®¤å€¼
      if (!futuresData || futuresData.length === 0) {
        return result;
      }
      
      try {
        // è®¡ç®—ä¸Šæ¶¨å’Œä¸‹è·Œçš„å“ç§æ•°é‡
        const upCount = futuresData.filter(item => parseFloat(item.zdf) > 0).length;
        const downCount = futuresData.filter(item => parseFloat(item.zdf) < 0).length;
        const neutralCount = futuresData.filter(item => parseFloat(item.zdf) === 0 || isNaN(parseFloat(item.zdf))).length;
        
        // è®¡ç®—å¹³å‡æ¶¨è·Œå¹…
        const upItems = futuresData.filter(item => parseFloat(item.zdf) > 0);
        const downItems = futuresData.filter(item => parseFloat(item.zdf) < 0);
        
        const avgUpChange = upItems.length > 0 ? 
          (upItems.reduce((sum, item) => sum + parseFloat(item.zdf), 0) / upItems.length).toFixed(2) : 0;
        
        const avgDownChange = downItems.length > 0 ? 
          (downItems.reduce((sum, item) => sum + parseFloat(item.zdf), 0) / downItems.length).toFixed(2) : 0;
        
        // è·å–å½“å‰æ—¶é—´
        const lastUpdated = new Date().toLocaleString('zh-CN');
        
        return {
          ...result,
          totalContracts: futuresData.length,
          upCount,
          downCount,
          neutralCount,
          avgUpChange,
          avgDownChange,
          lastUpdated
        };
      } catch (error) {
        console.error('åˆ†ææœŸè´§æ•°æ®å‡ºé”™:', error);
        // å‡ºé”™æ—¶è¿”å›é»˜è®¤å€¼
        return result;
      }
    }

    // æ›´æ–°æœŸè´§åˆ—è¡¨ - æ˜¾ç¤ºæŒ‰æ¶¨è·Œå¹…æ’åºçš„æœŸè´§å“ç§
    function updateFuturesList(futuresData) {
      const listContainer = document.getElementById('futures-list');
      if (!listContainer) return;
      
      // æ·»åŠ ç‚¹å‡»æ ‡é¢˜äº‹ä»¶ï¼Œæ‰“å¼€å‡è´´æ°´é¡µé¢
      const titleElement = document.querySelector('.header h1');
      if (titleElement) {
        titleElement.style.cursor = 'pointer';
        titleElement.title = 'ç‚¹å‡»æŸ¥çœ‹å‡è´´æ°´é¡µé¢';
        titleElement.addEventListener('click', function() {
          // å…ˆè·³è½¬åˆ°é¦–é¡µï¼Œç„¶åå»¶è¿Ÿä¸€ç§’åå†è·³è½¬åˆ°å‡è´´æ°´é¡µé¢
          // ä¿å­˜å½“å‰å“ç§åˆ°sessionStorageï¼Œç¡®ä¿è·³è½¬åå¯ä»¥æ¢å¤
          try {
            if (currentVariety) {
              sessionStorage.setItem('currentVariety', currentVariety);
              sessionStorage.setItem('redirectToContractSelector', 'true');
            }
          } catch (e) {
            console.warn('æ— æ³•ä¿å­˜è·³è½¬ä¿¡æ¯åˆ°sessionStorage:', e);
          }
          
          // è·³è½¬åˆ°é¦–é¡µ
          window.location.href = 'https://wealth.want.biz/pages/hotmap.html';
        });
      }
      
      try {
        // æ¸…ç©ºåˆ—è¡¨
        listContainer.innerHTML = '';
        
        // æŒ‰æ¶¨è·Œå¹…ç»å¯¹å€¼æ’åºï¼Œæ ¹æ®showAllFutureså†³å®šæ˜¯å¦åªæ˜¾ç¤ºå‰10ä¸ª
        const sortedData = [...futuresData]
          .sort((a, b) => Math.abs(parseFloat(b.zdf) || 0) - Math.abs(parseFloat(a.zdf) || 0));
        
        // å¦‚æœä¸æ˜¯æ˜¾ç¤ºå…¨éƒ¨ï¼Œåˆ™åªå–å‰10ä¸ª
        const displayData = showAllFutures ? sortedData : sortedData.slice(0, 10);
        
        // åˆ›å»ºæ¯ä¸ªæœŸè´§å“ç§çš„åˆ—è¡¨é¡¹
        displayData.forEach(item => {
          const li = document.createElement('li');
          
          // è®¡ç®—æ¶¨è·Œå¹…å’Œå¢ä»“ç‡
          const change = parseFloat(item.zdf) || 0;
          const posChangeRate = calculatePositionChangeRate(item);
          
          // ç¡®å®šå¢ä»“ç‡çŠ¶æ€å’Œé¢œè‰²
          let posRateStatusClass = 'neutral';
          if (posChangeRate > 0) {
            posRateStatusClass = 'up';
          } else if (posChangeRate < 0) {
            posRateStatusClass = 'down';
          }
          
          // æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆæ•°å­—
          const absChange = isFinite(change) ? Math.abs(change) : 0;
        // ç¡®å®šæ¶¨è·Œå¹…é¢œè‰²
        const changeColor = change > 0 ? 'var(--positive-color)' : 'var(--negative-color)';

        // ä½¿ç”¨éçº¿æ€§ç¼©æ”¾ï¼Œè®©å°æ•°å€¼ä¹Ÿèƒ½çœ‹åˆ°ä¸€å®šçš„è¿›åº¦æ¡é•¿åº¦
        const scaledWidth = Math.min(Math.abs(change) * 10, 90);
    
        // æ„å»ºå“ç§ç¼–ç 
        const msgid = getVarietyIdFromName(item.name);
        // ç›´æ¥æå–çº¯å“ç§ä»£ç ï¼Œä¸å«äº¤æ˜“æ‰€å‰ç¼€
        const varietyCode = msgid ? (msgid.split('_')[1] || msgid) : '';
    
        // æ„å»ºåˆ—è¡¨é¡¹å†…å®¹
        li.innerHTML = `
          <div class="change-arrow ${posRateStatusClass}"></div>
          <div class="futures-name">${item.name}</div>
          <div class="futures-change">
            <div class="change-bar">
              <div class="change-value" style="width: ${scaledWidth}%; background-color: ${changeColor}"></div>
              <div class="change-text">${change > 0 ? '+' : ''}${change}%</div>
            </div>
          </div>
          <div class="futures-posrate ${posRateStatusClass}" 
               style="cursor: pointer;" 
               title="ç‚¹å‡»æŸ¥çœ‹${item.name}å¤šç©ºæŒä»“">
            ${posChangeRate > 0 ? '+' : ''}${posChangeRate}%
          </div>
        `;
    
        // ä¸ºæ•´ä¸ª li æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆé™¤äº†æœ€å³ä¾§å­—æ®µï¼‰ï¼Œè°ƒç”¨å‡è´´æ°´é¡µé¢çš„é€»è¾‘
        li.addEventListener('click', (event) => {
          // è·å–å“ç§ID
          const varietyId = getVarietyIdFromName(item.name);
          // è°ƒç”¨åˆçº¦é€‰æ‹©å™¨æ˜¾ç¤ºå‡è´´æ°´é¡µé¢
          showContractSelector(varietyId);
        });
    
        // ä¸ºå¢ä»“ç‡ï¼ˆæœ€å³ä¾§å­—æ®µï¼‰æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œé˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œå¹¶åœ¨å½“å‰é¡µæ‰“å¼€é¾™è™æ¦œé¡µé¢
        const posrateElement = li.querySelector('.futures-posrate');
        posrateElement.addEventListener('click', (event) => {
          event.stopPropagation(); // é˜»æ­¢è§¦å‘ li ç‚¹å‡»äº‹ä»¶
          window.location.href = `https://wealth.want.biz/pages/longshort.html?variety=${varietyCode}`;
        });
    
        // æ·»åŠ åˆ°åˆ—è¡¨
        listContainer.appendChild(li);      
        });
      } catch (error) {
        console.error('æ›´æ–°æœŸè´§åˆ—è¡¨å‡ºé”™:', error);
        listContainer.innerHTML = '<div class="error-message">æ›´æ–°æœŸè´§åˆ—è¡¨å¤±è´¥</div>';
      }
    }

    // æ›´æ–°æ•°æ®æ‘˜è¦ - æ˜¾ç¤ºå¸‚åœºçŠ¶æ€å’Œæ¶¨è·Œç»Ÿè®¡
    function updateSummary(data) {
      const statusElement = document.getElementById('market-status');
      if (!statusElement) {
        console.error('çŠ¶æ€å…ƒç´ æœªæ‰¾åˆ°');
        return;
      }
      // æ›´æ–°å¸‚åœºçŠ¶æ€å’Œæ—¶é—´
      const statusText = isTradingHours() ? 'ğŸŸ¢ äº¤æ˜“ä¸­' : 'ğŸ”´ ä¼‘å¸‚ä¸­';
      statusElement.style.color = isTradingHours() ? '#2ecc71' : '#95a5a6';
      document.getElementById('market-status').textContent = statusText;
      document.getElementById('update-time').textContent = data.lastUpdated;
      
      // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨æ ·å¼
      const statusIndicator = document.querySelector('.status-indicator');
      if (statusIndicator) {
        if (isAutoUpdateEnabled) {
          statusIndicator.classList.remove('status-paused');
          statusIndicator.classList.add('status-normal');
        } else {
          statusIndicator.classList.remove('status-normal');
          statusIndicator.classList.add('status-paused');
        }
      }
      
      // æ›´æ–°æ¶¨è·Œç»Ÿè®¡
      document.getElementById('up-count').textContent = data.upCount;
      document.getElementById('down-count').textContent = data.downCount;
      document.getElementById('neutral-count').textContent = data.neutralCount;
      
      // æ›´æ–°å¹³å‡æ¶¨è·Œå¹…å’Œæ€»è®¡æ•°æ®
      document.getElementById('limit-up-count').textContent = data.avgUpChange + '%';
      document.getElementById('limit-down-count').textContent = data.avgDownChange + '%';
      document.getElementById('total-count').textContent = data.totalContracts;
    }

    // æ ¼å¼åŒ–æ•°å­— - å°†å¤§æ•°è½¬æ¢ä¸ºæ›´æ˜“è¯»çš„æ ¼å¼ï¼ˆä¸‡ã€äº¿ï¼‰
    function formatNumber(num) {
      if (isNaN(num)) return '0';
      
      if (num >= 1000000) {
        return (num / 100000000).toFixed(0) + 'äº¿';
      } else if (num >= 10000) {
        return (num / 10000).toFixed(0) + 'ä¸‡';
      } else {
        return num.toString();
      }
    }

    // æ˜¾ç¤ºåˆçº¦é€‰æ‹©å™¨ - åˆ‡æ¢åˆ°å“ç§è¯¦æƒ…é¡µé¢
    function showContractSelector(variety) {
      console.log('æ˜¾ç¤ºåˆçº¦é€‰æ‹©å™¨ï¼Œå“ç§:', variety);
      
      // ä¿å­˜å½“å‰å“ç§åˆ°sessionStorageï¼Œç¡®ä¿åˆ·æ–°æ—¶å¯ä»¥æ¢å¤
      try {
        if (variety) {
          sessionStorage.setItem('currentVariety', variety);
          currentVariety = variety;
        }
      } catch (e) {
        console.warn('æ— æ³•ä¿å­˜å½“å‰å“ç§åˆ°sessionStorage:', e);
      }
      
      // éšè—æ¦‚è§ˆåŒºåŸŸ
      document.getElementById('overview-section').style.display = 'none';
      document.getElementById('contract-detail').style.display = 'none';
      
      // æ˜¾ç¤ºé€‰æ‹©å™¨åŒºåŸŸ
      const contractSelector = document.getElementById('contract-selector');
      contractSelector.style.display = 'block';
      
      // æ›´æ–°å“ç§é€‰æ‹©æ¡†
      updateVarietySelect(variety);
      
      // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„variety
      if (!variety) {
        const premiumChartElement = document.getElementById('premium-chart');
        if (premiumChartElement) {
          premiumChartElement.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;color:var(--text-secondary);">è¯·é€‰æ‹©å“ç§</div>';
        }
        const contractsBody = document.getElementById('contracts-body');
        if (contractsBody) {
          contractsBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">è¯·é€‰æ‹©å“ç§</td></tr>';
        }
        return;
      }
      
      // è·å–æŒ‡å®šå“ç§çš„åˆçº¦åˆ—è¡¨å¹¶æ˜¾ç¤ºå‡è´´æ°´å›¾è¡¨
      fetchVarietyContracts(variety);
    }

    // æ›´æ–°å“ç§é€‰æ‹©æ¡† - æ ¹æ®å¯ç”¨å“ç§æ•°æ®å¡«å……ä¸‹æ‹‰èœå•
    function updateVarietySelect(selectedVariety) {
      const varietySelect = document.getElementById('variety-select');
      if (!varietySelect) return;
      
      varietySelect.innerHTML = '<option value="">è¯·é€‰æ‹©å“ç§</option>';
      
      try {
        // è·å–æ‰€æœ‰æœŸè´§å“ç§
        const varieties = [];
        
        // éå†futuresDataæå–å“ç§ä¿¡æ¯
        futuresData.forEach(item => {
          if (!item.uid || !item.name) return;
          
          const [exchange, code] = item.uid.split('|');
          if (!code || !exchange) return;
          
          if (!EXCHANGE_MAP[exchange]) return;
          
          // æå–å“ç§ä»£ç ï¼ˆå»æ‰æ•°å­—ï¼‰å’Œä¸­æ–‡åç§°
          const variety = code.replace(/\d+/g, '');
          const name = extractVarietyCode(item.name);
          
          // æ„å»ºmsgidæ ¼å¼
          const msgid = `${EXCHANGE_MAP[exchange]}_${variety.toLowerCase()}`;
          
          // ä¿å­˜åˆ°varietyIdMapæ˜ å°„
          varietyIdMap[name] = msgid;
          varietyIdMap[variety.toLowerCase()] = msgid;
          
          // æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ è¿‡è¿™ä¸ªå“ç§
          if (!varieties.some(v => v.msgid === msgid)) {
            varieties.push({
              code: variety,
              name: name,
              exchange: exchange,
              msgid: msgid
            });
          }
        });
        
        // æŒ‰åç§°æ’åº
        varieties.sort((a, b) => a.name.localeCompare(b.name, 'zh-CN'));
        
        // æ·»åŠ å“ç§é€‰é¡¹
        varieties.forEach(variety => {
          const option = document.createElement('option');
          option.value = variety.msgid;
          option.textContent = `${variety.name} (${variety.code})`;
          
          // å¦‚æœæ˜¯å½“å‰é€‰ä¸­çš„å“ç§ï¼Œè®¾ç½®ä¸ºé€‰ä¸­çŠ¶æ€
          if (variety.msgid === selectedVariety) {
            option.selected = true;
          }
          
          varietySelect.appendChild(option);
        });
        
        console.log('å“ç§é€‰æ‹©æ¡†å·²æ›´æ–°ï¼Œå“ç§æ•°é‡:', varieties.length);
      } catch (error) {
        console.error('æ›´æ–°å“ç§é€‰æ‹©æ¡†å¤±è´¥:', error);
      }
    }

    // ä»å“ç§åç§°ä¸­æå–å“ç§ä»£ç  - å»é™¤æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦
    function extractVarietyCode(name) {
      if (!name) return '';
      
      // ç§»é™¤æ‰€æœ‰æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦ï¼Œä¿ç•™ä¸­æ–‡
      return name.replace(/[0-9()ï¼ˆï¼‰]/g, '').trim();
    }

    // è·å–æŒ‡å®šå“ç§çš„åˆçº¦åˆ—è¡¨ - å¢åŠ æ•°æ®å¤‡ä»½å’Œå›é€€æœºåˆ¶
    async function fetchVarietyContracts(variety) {
      const premiumChartElement = document.getElementById('premium-chart');
      const contractsBody = document.getElementById('contracts-body');
      
      if (!premiumChartElement || !contractsBody) {
        console.error('æ‰¾ä¸åˆ°å¿…è¦çš„DOMå…ƒç´ ');
        return;
      }
      
      try {
        console.log(`è·å–${variety}çš„åˆçº¦åˆ—è¡¨ï¼Œmsgid:${variety}`);
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        
        premiumChartElement.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;color:var(--text-secondary);">loadingğŸŒ· ğŸŒ¹ ğŸŒ· ğŸŒ¹ ğŸŒ· ğŸŒ¹ ğŸŒ· ...</div>';
        contractsBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">åŠ è½½ä¸­...</td></tr>';
        
        // ä¿è¯varietyä¸ä¸ºç©º
        if (!variety) {
          throw new Error('å“ç§IDä¸ºç©º');
        }
        
        // ç¡®ä¿å“ç§IDæ ¼å¼æ­£ç¡®
        if (!variety.includes('_')) {
          // å°è¯•ä»æ˜ å°„è¡¨ä¸­è·å–æ­£ç¡®çš„å“ç§ID
          const mappedId = varietyIdMap[variety];
          if (mappedId) {
            console.log(`å“ç§IDæ ¼å¼ä¸æ­£ç¡®ï¼Œå·²ä»æ˜ å°„è¡¨ä¸­è·å–æ­£ç¡®ID: ${variety} -> ${mappedId}`);
            variety = mappedId;
          } else {
            console.warn(`å“ç§IDæ ¼å¼ä¸æ­£ç¡®ä¸”æ— æ³•ä»æ˜ å°„è¡¨ä¸­è·å–: ${variety}`);
          }
        }
        
        // 1. ä»APIè·å–åˆçº¦åˆ—è¡¨ - ä½¿ç”¨try/catchåˆ†å¼€å¤„ç†æ¯ä¸ªæ­¥éª¤çš„é”™è¯¯
        let contractCodes = [];
        try {
          // è°ƒè¯•æ—¥å¿—
          console.log(`è¯·æ±‚URL: https://q.889.ink/redis?msgid=${encodeURIComponent(variety)}`);
          
          const contractsResponse = await fetchWithRetry(`https://q.889.ink/redis?msgid=${encodeURIComponent(variety)}`);
          if (!contractsResponse.ok) {
            throw new Error(`HTTP error! status: ${contractsResponse.status}`);
          }
          
          const responseText = await contractsResponse.text();
          console.log(`Redis APIå“åº”: ${responseText.substring(0, 200)}...`);
          
          let contractsData;
          try {
            contractsData = JSON.parse(responseText);
          } catch (e) {
            console.error('JSONè§£æé”™è¯¯:', e);
            throw new Error(`è§£æåˆçº¦åˆ—è¡¨æ•°æ®å¤±è´¥: ${e.message}`);
          }
          
          if (!contractsData || !Array.isArray(contractsData)) {
            throw new Error('è·å–åˆçº¦åˆ—è¡¨å¤±è´¥ï¼Œæ•°æ®æ ¼å¼ä¸æ­£ç¡®');
          }
          
          console.log('è·å–åˆ°åˆçº¦åˆ—è¡¨æ•°æ®:', contractsData);
          
          // è¿‡æ»¤å¹¶æå–åˆçº¦ä»£ç 
          contractCodes = contractsData
            .filter(item => item && item.code && /\d+/.test(item.code))
            .map(item => `${item.mktid}_${item.code}`);
          
          if (contractCodes.length === 0) {
            throw new Error('æœªæ‰¾åˆ°æœ‰æ•ˆçš„åˆçº¦');
          }
          
          console.log('æå–çš„åˆçº¦ä»£ç :', contractCodes);
        } catch (contractError) {
          console.error('è·å–åˆçº¦åˆ—è¡¨æ­¥éª¤å¤±è´¥:', contractError);
          
          // å°è¯•ä»ç¼“å­˜è·å–æ•°æ®
          if (lastSuccessfulContractsData[variety]) {
            console.log(`ä½¿ç”¨ç¼“å­˜çš„${variety}åˆçº¦æ•°æ®`);
            
            // æ˜¾ç¤ºç¼“å­˜è­¦å‘Š
            createCacheWarning(`ä½¿ç”¨ç¼“å­˜çš„åˆçº¦æ•°æ® (${contractError.message})`, premiumChartElement);
            
            // ä½¿ç”¨ç¼“å­˜æ•°æ®æ›´æ–°UI
            setTimeout(() => {
              renderContractsTable(lastSuccessfulContractsData[variety]);
              renderPremiumChart(variety, lastSuccessfulContractsData[variety]);
            }, 500);
            
            return;
          }
          
          throw contractError; // æ— ç¼“å­˜å¯ç”¨ï¼Œé‡æ–°æŠ›å‡ºé”™è¯¯
        }
        
        // 2. è·å–åˆçº¦ä»·æ ¼æ•°æ®
        try {
          // æ„å»ºURLï¼Œç¡®ä¿åˆçº¦ä»£ç æ­£ç¡®ç¼–ç 
          const customUrl = `https://q.889.ink/custom/${contractCodes.join(',')}?orderBy=code&sort=asc&pageSize=100&pageIndex=0&callbackName=`;
          console.log('è¯·æ±‚ä»·æ ¼æ•°æ®URL:', customUrl);
          
          const pricesResponse = await fetchWithRetry(customUrl);
          if (!pricesResponse.ok) {
            throw new Error(`è·å–ä»·æ ¼æ•°æ®HTTPé”™è¯¯! status: ${pricesResponse.status}`);
          }
          
          // æå–å’Œå¤„ç†JSONPå“åº”
          const pricesText = await pricesResponse.text();
          console.log(`ä»·æ ¼APIå“åº”çš„å‰100ä¸ªå­—ç¬¦: ${pricesText.substring(0, 100)}...`);
          
          // æå–JSONéƒ¨åˆ†
          const jsonStr = pricesText.replace(/^[^({]*\(|\)[^}]*$/g, '');
          
          let pricesData;
          try {
            pricesData = JSON.parse(jsonStr);
          } catch (e) {
            console.error('JSONè§£æé”™è¯¯:', e, 'åŸå§‹å­—ç¬¦ä¸²:', jsonStr);
            throw new Error(`è§£æä»·æ ¼æ•°æ®å¤±è´¥: ${e.message}`);
          }
          
          if (!pricesData || !pricesData.list || !Array.isArray(pricesData.list)) {
            console.error('ä»·æ ¼æ•°æ®æ ¼å¼ä¸æ­£ç¡®:', pricesData);
            throw new Error('ä»·æ ¼æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
          }
          
          const prices = pricesData.list;
          
          if (prices.length === 0) {
            throw new Error('æœªè·å–åˆ°ä»»ä½•ä»·æ ¼æ•°æ®');
          }
          
          // è½¬æ¢æ•°æ®ä¸ºç»Ÿä¸€æ ¼å¼
          const formattedPrices = prices.map(item => {
            // æˆäº¤é¢ 
            const cje = item.cje;
            
            // æ²‰æ·€èµ„é‡‘ 
            const cdzj = item.cdzj;
            
            // è®¡ç®—å¢ä»“ç‡ rz/(ccl-rz)ï¼Œå…¶ä¸­rzæ˜¯å¢ä»“é‡
            let zcl = '0';
            if (item.rz && item.ccl) {
              const rz = parseFloat(item.rz || 0);
              const ccl = parseFloat(item.ccl || 0);
              if (ccl > rz && ccl - rz !== 0) {
                zcl = ((rz / (ccl - rz)) * 100).toFixed(2);
              }
            }
            
            return {
              code: item.name || '',
              price: item.p || '0',
              change: item.zdf || '0',
              volume: item.vol || '0',
              position: item.ccl || '0',
              cje: cje,
              cdzj: cdzj,
              zcl: zcl,
              zdf5: item.zdf5 || '0'
            };
          });
          
          // ä¿å­˜æ•°æ® - ä½¿ç”¨æ­£ç¡®çš„å“ç§åç§°ä½œä¸ºé”®
          const varietyName = extractVarietyCode(prices[0]?.name || '');
          contractsData[varietyName] = formattedPrices;
          
          // åŒæ—¶ä½¿ç”¨msgidä½œä¸ºé”®å­˜å‚¨æ•°æ®ï¼Œç¡®ä¿å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼è®¿é—®
          contractsData[variety] = formattedPrices;
          
          // åŒæ—¶ä¿å­˜åˆ°å¤‡ä»½ä¸­
          lastSuccessfulContractsData[varietyName] = [...formattedPrices];
          lastSuccessfulContractsData[variety] = [...formattedPrices];
          
          console.log(`ä¿å­˜äº†å“ç§æ•°æ®: ${varietyName}, ${variety}`, formattedPrices);
          
          // æ˜¾ç¤ºåˆçº¦åˆ—è¡¨
          renderContractsTable(formattedPrices);
          
          // æ˜¾ç¤ºå‡è´´æ°´å›¾è¡¨
          renderPremiumChart(varietyName, formattedPrices);
          
        } catch (pricesError) {
          console.error('è·å–ä»·æ ¼æ•°æ®æ­¥éª¤å¤±è´¥:', pricesError);
          
          // å°è¯•ä»ç¼“å­˜è·å–æ•°æ®
          if (lastSuccessfulContractsData[variety]) {
            console.log(`ä½¿ç”¨ç¼“å­˜çš„${variety}ä»·æ ¼æ•°æ®`);
            
            // æ˜¾ç¤ºç¼“å­˜è­¦å‘Š
            createCacheWarning(`ä½¿ç”¨ç¼“å­˜çš„ä»·æ ¼æ•°æ® (${pricesError.message})`, premiumChartElement);
            
            // ä½¿ç”¨ç¼“å­˜æ•°æ®æ›´æ–°UI
            setTimeout(() => {
              renderContractsTable(lastSuccessfulContractsData[variety]);
              renderPremiumChart(variety, lastSuccessfulContractsData[variety]);
            }, 500);
          } else {
            // è·å–ä»·æ ¼æ•°æ®å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            if (premiumChartElement) {
              premiumChartElement.innerHTML = `<div style="display:flex;justify-content:center;align-items:center;height:100%;color:var(--error-color);">ä»·æ ¼æ•°æ®åŠ è½½å¤±è´¥: ${pricesError.message}</div>`;
            }
            
            if (contractsBody) {
              contractsBody.innerHTML = `<tr><td colspan="9" style="text-align:center;">è·å–ä»·æ ¼æ•°æ®å¤±è´¥: ${pricesError.message}</td></tr>`;
            }
          }
        }
        
      } catch (error) {
        console.error('è·å–åˆçº¦åˆ—è¡¨å¤±è´¥:', error);
        
        // æ›´æ–°DOMï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        if (premiumChartElement) {
          premiumChartElement.innerHTML = `<div style="display:flex;justify-content:center;align-items:center;height:100%;color:var(--error-color);">åŠ è½½å¤±è´¥: ${error.message}</div>`;
        }
        
        if (contractsBody) {
          contractsBody.innerHTML = `<tr><td colspan="9" style="text-align:center;">è·å–åˆçº¦åˆ—è¡¨å¤±è´¥ï¼Œ${error.message}</td></tr>`;
        }
      }
    }

    // æ¸²æŸ“åˆçº¦è¡¨æ ¼ - å¢åŠ é”™è¯¯å¤„ç†
    function renderContractsTable(contracts) {
      const contractsBody = document.getElementById('contracts-body');
      const contractsTable = document.getElementById('contracts-table');
      const tableContainer = document.getElementById('table-container');
      
      if (!contractsBody || !contractsTable || !tableContainer) {
        console.error('æ‰¾ä¸åˆ°å¿…è¦çš„DOMå…ƒç´ ');
        return;
      }
      
      // æ¸…ç©ºç°æœ‰å†…å®¹
      contractsBody.innerHTML = '';
      
      if (!contracts || contracts.length === 0) {
        contractsBody.innerHTML = '<tr><td colspan="9" style="text-align:center;">æ— åˆçº¦æ•°æ®</td></tr>';
        return;
      }
      
      try {
        // æŒ‰åˆçº¦æœˆä»½æ’åº
        contracts.sort((a, b) => {
          const monthA = a.code.match(/\d+/) ? a.code.match(/\d+/)[0] : '';
          const monthB = b.code.match(/\d+/) ? b.code.match(/\d+/)[0] : '';
          return monthA.localeCompare(monthB);
        });
        
        // å¡«å……è¡¨æ ¼
        contracts.forEach(contract => {
          const row = document.createElement('tr');
          
          // ä¸ºæ¶¨è·Œå¹…æ·»åŠ é¢œè‰²æ ·å¼
          const change = parseFloat(contract.change);
          const changeClass = change >= 0 ? 'price-up' : 'price-down';
          const changeSign = change >= 0 ? '+' : '';
          const changeText = change ? `${changeSign}${change}%` : '-';
          
          row.innerHTML = `
            <td>${contract.code || '-'}</td>
            <td>${contract.price || '-'}</td>
            <td class="${changeClass}">${changeText}</td>
            <td>${formatNumber(contract.volume)}</td>
            <td>${formatNumber(contract.position)}</td>
            <td>${formatNumber(contract.cje)}</td>
            <td>${formatNumber(contract.cdzj)}</td>
            <td>${contract.zcl || '-'}%</td>
            <td class="${parseFloat(contract.zdf5) >= 0 ? 'price-up' : 'price-down'}">${parseFloat(contract.zdf5) ? (parseFloat(contract.zdf5) >= 0 ? '+' : '') + contract.zdf5 + '%' : '-'}</td>
          `;
          
          // ä¸ºè¡Œæ·»åŠ ç‚¹å‡»äº‹ä»¶ - ç¡®ä¿ä¿å­˜contractå¯¹è±¡çš„å‰¯æœ¬
          row.addEventListener('click', function() {
            const contractCopy = {...contract};
            console.log('ç‚¹å‡»åˆçº¦è¡Œ:', contractCopy);
            showContractDetail(contractCopy);
          });
          
          contractsBody.appendChild(row);
        });
        
        // æ˜¾ç¤ºè¡¨æ ¼å®¹å™¨
        tableContainer.style.display = 'block';
        contractsTable.style.display = 'table';
      } catch (error) {
        console.error('æ¸²æŸ“åˆçº¦è¡¨æ ¼å¤±è´¥:', error);
        contractsBody.innerHTML = `<tr><td colspan="9" style="text-align:center;">æ¸²æŸ“è¡¨æ ¼å¤±è´¥: ${error.message}</td></tr>`;
      }
    }

    // å®‰å…¨åœ°é”€æ¯å›¾è¡¨å®ä¾‹çš„é€šç”¨å‡½æ•° - å¢å¼ºå¥å£®æ€§
    function safeDisposeChart(chartInstance) {
      if (!chartInstance) return;
      
      try {
        // æ£€æŸ¥å›¾è¡¨å®ä¾‹æ˜¯å¦æœ‰æ•ˆ
        if (typeof chartInstance.getDom === 'function') {
          try {
            const dom = chartInstance.getDom();
            // åªæœ‰å½“DOMå…ƒç´ å­˜åœ¨ä¸”åœ¨æ–‡æ¡£ä¸­æ—¶æ‰å°è¯•é”€æ¯
            if (dom && document.body.contains(dom)) {
              chartInstance.dispose();
              console.log('å›¾è¡¨å®ä¾‹å·²å®‰å…¨é”€æ¯');
            } else {
              // DOMå…ƒç´ ä¸åœ¨æ–‡æ¡£ä¸­ï¼Œç›´æ¥è®¾ç½®ä¸ºnull
              console.warn('å›¾è¡¨DOMå…ƒç´ å·²ä¸åœ¨æ–‡æ¡£ä¸­ï¼Œè·³è¿‡dispose');
            }
          } catch (domError) {
            // è·å–DOMå…ƒç´ å¤±è´¥ï¼Œå¯èƒ½æ˜¯å›¾è¡¨å®ä¾‹å·²éƒ¨åˆ†æŸå
            console.warn('è·å–å›¾è¡¨DOMå…ƒç´ å¤±è´¥ï¼Œå°è¯•ç›´æ¥é”€æ¯:', domError);
            try {
              chartInstance.dispose();
            } catch (disposeError) {
              console.warn('ç›´æ¥é”€æ¯å›¾è¡¨å¤±è´¥:', disposeError);
            }
          }
        } else {
          // å›¾è¡¨å®ä¾‹å¯èƒ½å·²æŸåï¼Œç›´æ¥è®¾ç½®ä¸ºnull
          console.warn('å›¾è¡¨å®ä¾‹å¯èƒ½å·²æŸåï¼Œè·³è¿‡dispose');
        }
      } catch (e) {
        console.warn('é”€æ¯å›¾è¡¨å®ä¾‹å¤±è´¥:', e);
      }
    }
    
    // æ˜¾ç¤ºåˆçº¦è¯¦æƒ… - å¢åŠ é”™è¯¯å¤„ç†
    function showContractDetail(contract) {
      if (!contract) {
        console.error('åˆçº¦å¯¹è±¡ä¸ºç©ºï¼Œæ— æ³•æ˜¾ç¤ºè¯¦æƒ…');
        return;
      }
      
      console.log('æ˜¾ç¤ºåˆçº¦è¯¦æƒ…:', contract);
      
      try {
        // åœ¨åˆ‡æ¢è§†å›¾å‰å…ˆé”€æ¯premiumChartå›¾è¡¨å®ä¾‹ï¼Œé˜²æ­¢DOMå…ƒç´ ç§»é™¤å¯¼è‡´çš„é”™è¯¯
        safeDisposeChart(premiumChart);
        premiumChart = null;
        
        // éšè—åˆçº¦é€‰æ‹©å™¨å’Œæ¦‚è§ˆ
        document.getElementById('contract-selector').style.display = 'none';
        document.getElementById('overview-section').style.display = 'none';
        
        // æ˜¾ç¤ºåˆçº¦è¯¦æƒ…
        const detailElement = document.getElementById('contract-detail');
        detailElement.style.display = 'block';
        
        // æ›´æ–°åˆçº¦è¯¦æƒ…æ•°æ®
        document.getElementById('contract-name').textContent = contract.code || 'æœªçŸ¥åˆçº¦';
        document.getElementById('contract-price').textContent = contract.price || '-';
        
        const change = parseFloat(contract.change);
        const changeValue = document.getElementById('contract-change');
        changeValue.textContent = change ? `${change >= 0 ? '+' : ''}${change}%` : '-';
        changeValue.className = `contract-info-value ${change >= 0 ? 'up' : 'down'}`;
        
        document.getElementById('contract-volume').textContent = formatNumber(contract.volume);
        document.getElementById('contract-position').textContent = formatNumber(contract.position);
        
        // æ·»åŠ æ–°å­—æ®µæ˜¾ç¤º
        document.getElementById('contract-cje').textContent = formatNumber(contract.cje);
        document.getElementById('contract-cdzj').textContent = formatNumber(contract.cdzj);
        
        // å¢ä»“ç‡æ˜¾ç¤º
        document.getElementById('contract-zcl').textContent = contract.zcl ? `${contract.zcl}%` : '-';
        
        // äº”æ—¥æ¶¨å¹…æ˜¾ç¤º
        const zdf5 = parseFloat(contract.zdf5);
        const zdf5Element = document.getElementById('contract-zdf5');
        zdf5Element.textContent = zdf5 ? `${zdf5 >= 0 ? '+' : ''}${contract.zdf5}%` : '-';
        zdf5Element.className = `contract-info-value ${zdf5 >= 0 ? 'up' : 'down'}`;
        
        // ç”Ÿæˆå¹¶æ˜¾ç¤ºå‡è´´æ°´å›¾è¡¨ - å»¶è¿Ÿæ‰§è¡Œä»¥ç¡®ä¿DOMå·²æ›´æ–°
        setTimeout(() => {
          renderContractPremiumChart(contract);
        }, 100);
      } catch (error) {
        console.error('æ˜¾ç¤ºåˆçº¦è¯¦æƒ…å¤±è´¥:', error);
        alert('æ˜¾ç¤ºåˆçº¦è¯¦æƒ…å¤±è´¥ï¼š' + error.message);
      }
    }

    // æ¸²æŸ“å“ç§å‡è´´æ°´å›¾è¡¨ (å“ç§é€‰æ‹©é¡µé¢) - ä¿®å¤æš—è‰²ä¸»é¢˜æ”¯æŒ
    function renderPremiumChart(variety, contracts) {
      const chartWrapper = document.getElementById('premium-chart-wrapper');
      
      if (!chartWrapper) {
        console.error('æ‰¾ä¸åˆ°å›¾è¡¨å®¹å™¨');
        return;
      }
      
      // å®‰å…¨åœ°é”€æ¯æ—§å›¾è¡¨
      safeDisposeChart(premiumChart);
      premiumChart = null;
      
      // ç¡®ä¿å®¹å™¨ä¸­åªæœ‰ä¸€ä¸ªå›¾è¡¨å…ƒç´ 
      chartWrapper.innerHTML = '<div id="premium-chart" style="width: 100%; height: 100%;"></div>';
      const chartContainer = document.getElementById('premium-chart');
      
      // ç¡®ä¿EChartså·²åŠ è½½
      if (typeof echarts === 'undefined') {
        chartContainer.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;color:var(--error-color);">EChartsæœªåŠ è½½</div>';
        return;
      }
      
      // ç¡®ä¿æœ‰åˆçº¦æ•°æ®
      if (!contracts || contracts.length === 0) {
        chartContainer.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;color:var(--text-secondary);">æ— åˆçº¦æ•°æ®</div>';
        return;
      }
      
      // ç¡®ä¿è‡³å°‘æœ‰ä»·æ ¼æ•°æ®çš„åˆçº¦
      const validContracts = contracts.filter(c => c.price && !isNaN(parseFloat(c.price)));
      if (validContracts.length === 0) {
        chartContainer.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;color:var(--text-secondary);">æ— æœ‰æ•ˆä»·æ ¼æ•°æ®</div>';
        return;
      }
      
      try {
        // è·å–CSSå˜é‡å½“å‰å€¼ - é€‚åº”å½“å‰ä¸»é¢˜
        const chartBg = getCssVariable('--chart-bg', '#ffffff');
        const chartText = getCssVariable('--chart-text', '#333');
        const chartTitle = getCssVariable('--chart-title', '#333');
        const chartAxis = getCssVariable('--chart-axis', '#666');
        const chartGrid = getCssVariable('--chart-grid', '#eee');
        const borderColor = getCssVariable('--border-color', '#ddd');
        const cardBg = getCssVariable('--card-bg', '#ffffff');
        const positiveColor = getCssVariable('--positive-color', '#ff7675');
        const negativeColor = getCssVariable('--negative-color', '#55efc4');
        
        // æŒ‰åˆçº¦æœˆä»½æ’åº
        validContracts.sort((a, b) => {
          const monthA = a.code.match(/\d+/) ? a.code.match(/\d+/)[0] : '';
          const monthB = b.code.match(/\d+/) ? b.code.match(/\d+/)[0] : '';
          return monthA.localeCompare(monthB);
        });
        
        // è·å–åˆçº¦æœˆä»½å’Œä»·æ ¼
        const months = validContracts.map(c => {
          // æå–åˆçº¦æœˆä»½ï¼Œä¾‹å¦‚ä» "æ²ªé“œ2310" ä¸­æå– "2310"
          const match = c.code.match(/\d+/);
          return match ? match[0] : c.code;
        });
        
        const prices = validContracts.map(c => parseFloat(c.price) || 0);
        
        // è®¡ç®—å‡è´´æ°´ï¼ˆç›¸å¯¹äºç¬¬ä¸€ä¸ªåˆçº¦ï¼‰
        const basePrice = parseFloat(validContracts[0].price);
        const premium = prices.map(price => ((price - basePrice) / basePrice * 100).toFixed(2));
        
        // è·å–æŒä»“é‡æ•°æ®å¹¶è®¡ç®—å æ¯”
        const positions = validContracts.map(c => parseInt(c.position) || 0);
        const totalPosition = positions.reduce((sum, pos) => sum + pos, 0);
        const positionRatio = positions.map(pos => totalPosition > 0 ? ((pos / totalPosition) * 100).toFixed(2) : 0);
        
        // ç”ŸæˆæŸ±çŠ¶å›¾é¢œè‰²
        const colors = premium.map((p, idx) => {
          // å½“å‰åˆçº¦ä¸ºæ©™è‰²
          if (idx === 0) return '#f8cda6';
          // å‡æ°´ä¸ºçº¢è‰²ï¼Œè´´æ°´ä¸ºç»¿è‰²
          return parseFloat(p) >= 0 ? positiveColor : negativeColor;
        });
        
        // åˆ›å»ºæ–°å›¾è¡¨
        premiumChart = echarts.init(chartContainer);
        
        // è®¾ç½®å›¾è¡¨é€‰é¡¹
        const option = {
          backgroundColor: chartBg,
          title: {
            text: `${variety}åˆçº¦å‡è´´æ°´ç»“æ„`,
            left: 'center',
            textStyle: {
              fontSize: 14,
              fontWeight: 'normal',
              color: chartTitle
            }
          },
          tooltip: {
            trigger: 'axis',
            formatter: function(params) {
              let html = `${validContracts[params[0].dataIndex].code}<br/>`;
              params.forEach(param => {
                if (param.seriesName === 'å‡è´´æ°´') {
                  html += `ä»·æ ¼: ${validContracts[param.dataIndex].price}<br/>å‡è´´æ°´: ${param.value}%<br/>`;
                } else if (param.seriesName === 'æŒä»“å æ¯”') {
                  html += `æŒä»“é‡: ${formatNumber(validContracts[param.dataIndex].position)}<br/>å æ¯”: ${param.value}%`;
                }
              });
              return html;
            },
            backgroundColor: cardBg,
            borderColor: borderColor,
            textStyle: {
              color: chartText
            }
          },
          grid: {
            left: '3%',
            right: '8%',  // å¢åŠ å³ä¾§ç©ºé—´ä»¥å®¹çº³ç¬¬äºŒä¸ªYè½´
            bottom: '5%', // å¢åŠ åº•éƒ¨ç©ºé—´
            top: '35%',
            containLabel: true
          },
          legend: {
            data: ['å‡è´´æ°´', 'æŒä»“å æ¯”'],
            top: '10%',
            right: '30%',
            show: true,
            textStyle: {
              color: chartText
            }
          },
          xAxis: {
            type: 'category',
            data: months,
            axisLabel: {
              interval: 0,
              fontSize: 11,
              color: chartAxis
            },
            axisLine: {
              lineStyle: {
                color: borderColor
              }
            },
            splitLine: {
              show: false
            }
          },
          yAxis: [
            {
              type: 'value',
              name: 'å‡è´´æ°´(%)',
              nameTextStyle: {
                fontSize: 12,
                color: chartAxis
              },
              axisLabel: {
                formatter: '{value}%',
                fontSize: 11,
                color: chartAxis
              },
              splitLine: {
                lineStyle: {
                  color: chartGrid
                }
              },
              axisLine: {
                lineStyle: {
                  color: borderColor
                }
              }
            },
            {
              type: 'value',
              name: 'æŒä»“å æ¯”(%)',
              nameTextStyle: {
                fontSize: 12,
                color: '#3498db'
              },
              axisLabel: {
                formatter: '{value}%',
                fontSize: 11,
                color: '#3498db'
              },
              splitLine: {
                show: false
              },
              axisLine: {
                lineStyle: {
                  color: borderColor
                }
              }
            }
          ],
          series: [
            {
              name: 'å‡è´´æ°´',
              type: 'bar',
              barWidth: '60%',
              data: premium.map((value, idx) => {
                return {
                  value: value,
                  itemStyle: {
                    color: colors[idx]
                  }
                };
              }),
              label: {
                show: true,
                position: 'top',
                formatter: '{c}%',
                fontSize: 10,
                color: chartText
              }
            },
            {
              name: 'æŒä»“å æ¯”',
              type: 'line',
              yAxisIndex: 1,
              symbol: 'circle',
              symbolSize: 6,
              itemStyle: {
                color: '#3498db'
              },
              lineStyle: {
                width: 2,
                type: 'solid',
                color: '#3498db'
              },
              data: positionRatio,
              label: {
                show: false,
                position: 'inside',
                formatter: '{c}%',
                fontSize: 10,
                color: '#ffffff',
                backgroundColor: '#3498db',
                padding: [2, 4],
                borderRadius: 3
              }
            }
          ]
        };
        
        // è®¾ç½®å›¾è¡¨
        premiumChart.setOption(option);
        
        // é‡æ–°ç»‘å®šçª—å£å¤§å°å˜åŒ–äº‹ä»¶
        const resizeHandler = () => {
          if (premiumChart) {
            try {
              premiumChart.resize();
            } catch (e) {
              console.warn('å›¾è¡¨è°ƒæ•´å¤§å°å¤±è´¥:', e);
            }
          }
        };
        
        window.removeEventListener('resize', resizeHandler);
        window.addEventListener('resize', resizeHandler);
      } catch (error) {
        console.error('æ¸²æŸ“å‡è´´æ°´å›¾è¡¨å¤±è´¥:', error);
        chartContainer.innerHTML = `<div style="display:flex;justify-content:center;align-items:center;height:100%;color:var(--error-color);">æ¸²æŸ“å›¾è¡¨å¤±è´¥: ${error.message}</div>`;
      }
    }

    // æ¸²æŸ“åˆçº¦è¯¦æƒ…é¡µçš„å‡è´´æ°´å›¾è¡¨ - ä¿®å¤æš—è‰²ä¸»é¢˜æ”¯æŒ
    function renderContractPremiumChart(contract) {
      const chartWrapper = document.getElementById('contract-premium-chart-wrapper');
      
      if (!chartWrapper) {
        console.error('æ‰¾ä¸åˆ°åˆçº¦è¯¦æƒ…å›¾è¡¨å®¹å™¨');
        return;
      }
      
      // å®‰å…¨åœ°é”€æ¯æ—§å›¾è¡¨
      safeDisposeChart(contractDetailChart);
      contractDetailChart = null;
      
      // ç¡®ä¿å®¹å™¨ä¸­åªæœ‰ä¸€ä¸ªå›¾è¡¨å…ƒç´ 
      chartWrapper.innerHTML = '<div id="contract-premium-chart" class="contract-chart"></div>';
      const chartContainer = document.getElementById('contract-premium-chart');
      
      // ç¡®ä¿EChartså·²åŠ è½½
      if (typeof echarts === 'undefined') {
        chartContainer.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;color:var(--error-color);">EChartsæœªåŠ è½½</div>';
        return;
      }
      
      // è·å–å“ç§
      const variety = extractVarietyCode(contract.code);
      console.log('å½“å‰åˆçº¦å“ç§:', variety, 'åˆçº¦ä»£ç :', contract.code);
      
      // æŸ¥æ‰¾åˆçº¦æ•°æ®ï¼Œå…ˆä»å½“å‰æ•°æ®ä¸­æ‰¾ï¼Œå†ä»ç¼“å­˜ä¸­æ‰¾
      let contracts = null;
      let isUsingCache = false;
      
      // ä½¿ç”¨ä¿å­˜çš„åˆçº¦æ•°æ® - ä¼˜å…ˆä½¿ç”¨å“ç§åç§°ï¼Œå…¶æ¬¡ä½¿ç”¨msgid
      if (contractsData[variety]) {
        contracts = contractsData[variety];
      } else if (contractsData[currentVariety]) {
        contracts = contractsData[currentVariety];
      } else if (lastSuccessfulContractsData[variety]) {
        // å°è¯•ä»ç¼“å­˜ä¸­è·å–
        contracts = lastSuccessfulContractsData[variety];
        isUsingCache = true;
      } else if (lastSuccessfulContractsData[currentVariety]) {
        contracts = lastSuccessfulContractsData[currentVariety];
        isUsingCache = true;
      }
      
      // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆçº¦æ•°æ®ï¼Œæ˜¾ç¤ºé”™è¯¯
      if (!contracts || contracts.length === 0) {
        chartContainer.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;color:var(--error-color);">æ— æ³•è·å–å“ç§åˆçº¦æ•°æ®</div>';
        return;
      }
      
      // å¦‚æœä½¿ç”¨ç¼“å­˜ï¼Œæ˜¾ç¤ºæç¤º
      if (isUsingCache) {
        createCacheWarning('ä½¿ç”¨ç¼“å­˜çš„åˆçº¦æ•°æ®', chartContainer);
      }
      
      // ç¡®ä¿è‡³å°‘æœ‰ä»·æ ¼æ•°æ®çš„åˆçº¦
      const validContracts = contracts.filter(c => c.price && !isNaN(parseFloat(c.price)));
      if (validContracts.length === 0) {
        chartContainer.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;color:var(--text-secondary);">æ— æœ‰æ•ˆä»·æ ¼æ•°æ®</div>';
        return;
      }
      
      try {
        // è·å–CSSå˜é‡å½“å‰å€¼ - é€‚åº”å½“å‰ä¸»é¢˜
        const chartBg = getCssVariable('--chart-bg', '#ffffff');
        const chartText = getCssVariable('--chart-text', '#333');
        const chartTitle = getCssVariable('--chart-title', '#333');
        const chartAxis = getCssVariable('--chart-axis', '#666');
        const chartGrid = getCssVariable('--chart-grid', '#eee');
        const borderColor = getCssVariable('--border-color', '#ddd');
        const cardBg = getCssVariable('--card-bg', '#ffffff');
        const positiveColor = getCssVariable('--positive-color', '#ff7675');
        const negativeColor = getCssVariable('--negative-color', '#55efc4');
        
        // æŒ‰åˆçº¦æœˆä»½æ’åº
        validContracts.sort((a, b) => {
          const monthA = a.code.match(/\d+/) ? a.code.match(/\d+/)[0] : '';
          const monthB = b.code.match(/\d+/) ? b.code.match(/\d+/)[0] : '';
          return monthA.localeCompare(monthB);
        });
        
        // è·å–åˆçº¦æœˆä»½å’Œä»·æ ¼
        const months = validContracts.map(c => {
          // æå–åˆçº¦æœˆä»½ï¼Œä¾‹å¦‚ä» "æ²ªé“œ2310" ä¸­æå– "2310"
          const match = c.code.match(/\d+/);
          return match ? match[0] : c.code;
        });
        
        const prices = validContracts.map(c => parseFloat(c.price) || 0);
        
        // æ‰¾å‡ºå½“å‰åˆçº¦åœ¨åˆ—è¡¨ä¸­çš„ä½ç½®
        const basePriceIndex = validContracts.findIndex(c => c.code === contract.code);
        
        const basePrice = parseFloat(contract.price) || (basePriceIndex >= 0 ? parseFloat(validContracts[basePriceIndex].price) : parseFloat(validContracts[0].price));
        
        // è®¡ç®—å‡è´´æ°´ï¼ˆç›¸å¯¹äºå½“å‰åˆçº¦ï¼‰
        const premium = prices.map(price => ((price - basePrice) / basePrice * 100).toFixed(2));
        
        // è·å–æŒä»“é‡æ•°æ®å¹¶è®¡ç®—å æ¯”
        const positions = validContracts.map(c => parseInt(c.position) || 0);
        const totalPosition = positions.reduce((sum, pos) => sum + pos, 0);
        const positionRatio = positions.map(pos => totalPosition > 0 ? ((pos / totalPosition) * 100).toFixed(2) : 0);
        
        // ç”ŸæˆæŸ±çŠ¶å›¾é¢œè‰²
        const colors = premium.map((p, idx) => {
          // å½“å‰åˆçº¦ä¸ºæ©™è‰²
          if ((basePriceIndex >= 0 && idx === basePriceIndex) || 
              (basePriceIndex < 0 && validContracts[idx].code === contract.code)) {
            return '#f8cda6';
          }
          // å‡æ°´ä¸ºçº¢è‰²ï¼Œè´´æ°´ä¸ºç»¿è‰²
          return parseFloat(p) >= 0 ? positiveColor : negativeColor;
        });
        
        // åˆ›å»ºæ–°å›¾è¡¨
        contractDetailChart = echarts.init(chartContainer);
        
        // è®¾ç½®å›¾è¡¨é€‰é¡¹
        const option = {
          backgroundColor: chartBg,
          title: {
            text: `${contract.code}å‡è´´æ°´ç»“æ„`,
            left: 'center',
            textStyle: {
              fontSize: 14,
              fontWeight: 'normal',
              color: chartTitle
            }
          },
          tooltip: {
            trigger: 'axis',
            formatter: function(params) {
              let html = `${validContracts[params[0].dataIndex].code}<br/>`;
              params.forEach(param => {
                if (param.seriesName === 'å‡è´´æ°´') {
                  html += `ä»·æ ¼: ${validContracts[param.dataIndex].price}<br/>å‡è´´æ°´: ${param.value}%<br/>`;
                } else if (param.seriesName === 'æŒä»“å æ¯”') {
                  html += `æŒä»“é‡: ${formatNumber(validContracts[param.dataIndex].position)}<br/>å æ¯”: ${param.value}%`;
                }
              });
              return html;
            },
            backgroundColor: cardBg,
            borderColor: borderColor,
            textStyle: {
              color: chartText
            }
          },
          grid: {
            left: '3%',
            right: '8%',  // å¢åŠ å³ä¾§ç©ºé—´ä»¥å®¹çº³ç¬¬äºŒä¸ªYè½´
            bottom: '8%', // å¢åŠ åº•éƒ¨ç©ºé—´
            top: '25%',
            containLabel: true
          },
          legend: {
            data: ['å‡è´´æ°´', 'æŒä»“å æ¯”'],
            top: '5%',
            right: '10%',
            show: false,
            textStyle: {
              color: chartText
            }
          },
          xAxis: {
            type: 'category',
            data: months,
            axisLabel: {
              interval: 0,
              fontSize: 11,
              color: chartAxis
            },
            axisLine: {
              lineStyle: {
                color: borderColor
              }
            },
            splitLine: {
              show: false
            }
          },
          yAxis: [
            {
              type: 'value',
              name: 'å‡è´´æ°´(%)',
              nameTextStyle: {
                fontSize: 12,
                color: positiveColor
              },
              axisLabel: {
                formatter: '{value}%',
                fontSize: 11,
                color: chartAxis
              },
              splitLine: {
                lineStyle: {
                  color: chartGrid
                }
              },
              axisLine: {
                lineStyle: {
                  color: borderColor
                }
              }
            },
            {
              type: 'value',
              name: 'æŒä»“å æ¯”(%)',
              nameTextStyle: {
                fontSize: 12,
                color: positiveColor
              },
              axisLabel: {
                formatter: '{value}%',
                fontSize: 11,
                color: '#3498db'
              },
              splitLine: {
                show: false
              },
              axisLine: {
                lineStyle: {
                  color: borderColor
                }
              }
            }
          ],
          series: [
            {
              name: 'å‡è´´æ°´',
              type: 'bar',
              barWidth: '60%',
              data: premium.map((value, idx) => {
                return {
                  value: value,
                  itemStyle: {
                    color: colors[idx]
                  }
                };
              }),
              label: {
                show: true,
                position: 'top',
                formatter: '{c}%',
                fontSize: 10,
                color: chartText
              }
            },
            {
              name: 'æŒä»“å æ¯”',
              type: 'line',
              yAxisIndex: 1,
              symbol: 'circle',
              symbolSize: 6,
              itemStyle: {
                color: '#3498db'
              },
              lineStyle: {
                width: 2,
                type: 'solid',
                color: '#3498db'
              },
              data: positionRatio,
              label: {
                show: false,
                position: 'inside',
                formatter: '{c}%',
                fontSize: 10,
                color: '#ffffff',
                backgroundColor: '#3498db',
                padding: [2, 4],
                borderRadius: 3
              }
            }
          ]
        };
        
        // è®¾ç½®å›¾è¡¨
        contractDetailChart.setOption(option);
        
        // é‡æ–°ç»‘å®šçª—å£å¤§å°å˜åŒ–äº‹ä»¶
        const resizeHandler = () => {
          if (contractDetailChart) {
            try {
              contractDetailChart.resize();
            } catch (e) {
              console.warn('åˆçº¦è¯¦æƒ…å›¾è¡¨è°ƒæ•´å¤§å°å¤±è´¥:', e);
            }
          }
        };
        
        window.removeEventListener('resize', resizeHandler);
        window.addEventListener('resize', resizeHandler);
      } catch (error) {
        console.error('æ¸²æŸ“åˆçº¦è¯¦æƒ…å›¾è¡¨å¤±è´¥:', error);
        chartContainer.innerHTML = `<div style="display:flex;justify-content:center;align-items:center;height:100%;color:var(--error-color);">æ¸²æŸ“å›¾è¡¨å¤±è´¥: ${error.message}</div>`;
      }
    }

    // æ˜¾ç¤ºæ¦‚è§ˆ - è¿”å›åˆ°ä¸»é¡µé¢
    function showOverview() {
      document.getElementById('overview-section').style.display = 'block';
      document.getElementById('contract-selector').style.display = 'none';
      document.getElementById('contract-detail').style.display = 'none';
    }
  </script>
</body>
</html>