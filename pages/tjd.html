<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœŸè´§å“ç§å¯¹æ¯”</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        #main, #main2 {
            width: 100%;
            height: 400px;
        }
        #download-btn {
            margin: 20px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        #download-btn:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>

<!-- ç¬¬ä¸€ä¸ªå›¾è¡¨å®¹å™¨ï¼šæŠ•æœºåº¦ vs æ¶¨å¹… -->
<div id="main"></div>

<!-- ç¬¬äºŒä¸ªå›¾è¡¨å®¹å™¨ï¼šå¢ä»“ç‡ vs æ¶¨è·Œå¹… -->
<div id="main2"></div>

<!-- ä¸‹è½½æŒ‰é’® -->
<button id="download-btn">ä¸‹è½½å›¾ç‰‡</button>

<script>
    const apiUrl = 'https://q.want.biz';

    // å£°æ˜ä¸¤ä¸ªå›¾è¡¨å®ä¾‹
    const chart1 = echarts.init(document.getElementById('main'));
    const chart2 = echarts.init(document.getElementById('main2'));

    // è·å–æ•°æ®å¹¶è°ƒç”¨ç»˜å›¾å‡½æ•°
    async function fetchData() {
        try {
            const response = await fetch(apiUrl);
            const apiData = await response.json(); // å‡è®¾è¿”å›çš„æ•°æ®ç»“æ„ä¸ä¹‹å‰çš„ç›¸ä¼¼

            // è¿‡æ»¤æ•°æ®ï¼Œåªä¿ç•™æ²‰æ·€èµ„é‡‘ cdzj å¤§äº 20 äº¿çš„å“ç§
            const filteredData = apiData.list.filter(item => item.cdzj > 2000000000);

            // è°ƒç”¨ä¸¤ä¸ªå›¾è¡¨çš„ç»˜åˆ¶å‡½æ•°
            renderChart1(filteredData);  // æŠ•æœºåº¦ vs æ¶¨å¹…å›¾è¡¨
            renderChart2(filteredData);  // å¢ä»“ç‡ vs æ¶¨è·Œå¹…å›¾è¡¨
        } catch (error) {
            console.error('æ•°æ®è·å–å¤±è´¥:', error);
        }
    }

    // ç»˜åˆ¶ç¬¬ä¸€ä¸ªå›¾è¡¨: æŠ•æœºåº¦ vs æ¶¨å¹…
    function renderChart1(dataList) {
        // æå–å“ç§åç§°ã€æŠ•æœºåº¦å’Œæ¶¨å¹…
        const categories = dataList.map(item => item.name); // å“ç§åç§°
        const tjdData = dataList.map(item => item.tjd);     // æŠ•æœºåº¦
        const zdfData = dataList.map(item => item.zdf);     // æ¶¨å¹…

        const barWidth = 30;  // è®¾å®šæŸ±å­å’Œæ–¹å—çš„å®½åº¦

        // é…ç½®é¡¹
        const option = {
            title: {
                text: 'æœŸè´§å“ç§æŠ•æœºåº¦ä¸æ¶¨å¹…å¯¹æ¯”'
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross'
                },
                formatter: function (params) {
                    let result = `<b>${params[0].name}</b><br>`;
                    params.forEach(param => {
                        if (param.seriesName === 'æ¶¨å¹…') {
                            const color = param.value >= 0 ? 'çº¢è‰²ğŸŸ¥' : 'ç»¿è‰²ğŸŸ©';
                            result += `${param.seriesName}: <span style="color:${color}">${param.value.toFixed(2)}%</span><br>`;
                        } else {
                            result += `${param.seriesName}: ${param.value.toFixed(2)}%<br>`;
                        }
                    });
                    return result;
                }
            },
            xAxis: {
                type: 'category',
                data: categories,  // æ¨ªè½´æ˜¾ç¤ºå“ç§åç§°
                axisLabel: {
                    interval: 0,
                    rotate: 30 // å“ç§åç§°æ—‹è½¬ï¼Œé˜²æ­¢é‡å 
                }
            },
            yAxis: [
                {
                    type: 'value',
                    name: 'æŠ•æœºåº¦ (%)',
                    position: 'left',
                    axisLabel: {
                        formatter: '{value} %'
                    }
                },
            ],
            series: [
                {
                    name: 'æŠ•æœºåº¦',
                    type: 'bar',
                    data: tjdData, // æŠ•æœºåº¦æ•°æ®
                    yAxisIndex: 0, // ä½¿ç”¨å·¦ä¾§ y è½´
                    barWidth: barWidth, // è®¾ç½®æŸ±å½¢å›¾çš„å®½åº¦
                    itemStyle: {
                        color: '#4CAF50'
                    }
                },
                {
                    name: 'æ¶¨å¹…',
                    type: 'scatter',
                    symbol: 'rect', // ä½¿ç”¨æ–¹å—ä½œä¸ºæ ‡è®°
                    symbolSize: [barWidth, barWidth], // è®¾ç½®æ–¹å—å¤§å°ä¸æŸ±å­å®½åº¦ä¸€è‡´
                    data: zdfData.map(value => ({
                        value,
                        itemStyle: {
                            color: value >= 0 ? '#FF0000' : '#00FF00' // æ­£æ¶¨å¹…ç”¨çº¢è‰²ï¼Œè´Ÿæ¶¨å¹…ç”¨ç»¿è‰²
                        }
                    })),
                    yAxisIndex: 0, // æ¶¨å¹…ä»ç„¶ä½¿ç”¨å·¦ä¾§ y è½´
                }
            ]
        };

        // ä½¿ç”¨é…ç½®é¡¹å’Œæ•°æ®æ˜¾ç¤ºå›¾è¡¨
        chart1.setOption(option);
    }

    // ç»˜åˆ¶ç¬¬äºŒä¸ªå›¾è¡¨: å¢ä»“ç‡ vs æ¶¨è·Œå¹…
    function renderChart2(dataList) {
        // æå–å“ç§åç§°ã€å¢ä»“ç‡å’Œæ¶¨è·Œå¹…
        const categories = dataList.map(item => item.name); // å“ç§åç§°
        const zdfData = dataList.map(item => item.zdf);     // æ¶¨è·Œå¹…
        const zclData = dataList.map(item => {
            return (item.rz / (item.ccl - item.rz)) * 100;  // å¢ä»“ç‡ï¼Œè½¬ä¸ºç™¾åˆ†æ¯”
        });

        const barWidth = 30;  // è®¾å®šæŸ±å­å’Œæ–¹å—çš„å®½åº¦

        // é…ç½®é¡¹
        const option = {
            title: {
                text: 'æœŸè´§å“ç§å¢ä»“ç‡ä¸æ¶¨è·Œå¹…å¯¹æ¯”'
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross'
                },
                formatter: function (params) {
                    let result = `<b>${params[0].name}</b><br>`;
                    params.forEach(param => {
                        if (param.seriesName === 'æ¶¨è·Œå¹…') {
                            const color = param.value >= 0 ? 'çº¢è‰²ğŸŸ¥' : 'ç»¿è‰²ğŸŸ©';
                            result += `${param.seriesName}: <span style="color:${color}">${param.value.toFixed(2)}%</span><br>`;
                        } else {
                            result += `${param.seriesName}: ${param.value.toFixed(2)}%<br>`;
                        }
                    });
                    return result;
                }
            },
            xAxis: {
                type: 'category',
                data: categories,  // æ¨ªè½´æ˜¾ç¤ºå“ç§åç§°
                axisLabel: {
                    interval: 0,
                    rotate: 30 // å“ç§åç§°æ—‹è½¬ï¼Œé˜²æ­¢é‡å 
                }
            },
            yAxis: [
                {
                    type: 'value',
                    name: 'å¢ä»“ç‡ (%)',
                    position: 'left',
                    axisLabel: {
                        formatter: '{value} %'
                    }
                },
            ],
            series: [
                {
                    name: 'å¢ä»“ç‡',
                    type: 'bar',
                    data: zclData, // å¢ä»“ç‡æ•°æ®
                    yAxisIndex: 0, // ä½¿ç”¨å·¦ä¾§ y è½´
                    barWidth: barWidth, // è®¾ç½®æŸ±å½¢å›¾çš„å®½åº¦
                    itemStyle: {
                        color: '#3498DB'
                    }
                },
                {
                    name: 'æ¶¨è·Œå¹…',
                    type: 'scatter',
                    symbol: 'rect', // ä½¿ç”¨æ–¹å—ä½œä¸ºæ ‡è®°
                    symbolSize: [barWidth, barWidth], // è®¾ç½®æ–¹å—å¤§å°ä¸æŸ±å­å®½åº¦ä¸€è‡´
                    data: zdfData.map(value => ({
                        value,
                        itemStyle: {
                            color: value >= 0 ? '#FF0000' : '#00FF00' // æ­£æ¶¨å¹…ç”¨çº¢è‰²ï¼Œè´Ÿæ¶¨å¹…ç”¨ç»¿è‰²
                        }
                    })),
                    yAxisIndex: 0, // æ¶¨å¹…ä»ç„¶ä½¿ç”¨å·¦ä¾§ y è½´
                }
            ]
        };

        // ä½¿ç”¨é…ç½®é¡¹å’Œæ•°æ®æ˜¾ç¤ºå›¾è¡¨
        chart2.setOption(option);
    }

    // æ·»åŠ ä¸‹è½½å›¾ç‰‡åŠŸèƒ½
    document.getElementById('download-btn').addEventListener('click', function () {
        // è·å–ç¬¬ä¸€ä¸ªå›¾è¡¨çš„ Base64 å›¾ç‰‡ URL
        const imgURL1 = chart1.getDataURL({
            type: 'png',      // å›¾ç‰‡ç±»å‹
            pixelRatio: 2,    // åƒç´ æ¯”ï¼Œå€¼è¶Šé«˜å›¾ç‰‡è¶Šæ¸…æ™°
            backgroundColor: '#fff' // èƒŒæ™¯é¢œè‰²
        });

        // è·å–ç¬¬äºŒä¸ªå›¾è¡¨çš„ Base64 å›¾ç‰‡ URL
        const imgURL2 = chart2.getDataURL({
            type: 'png',
            pixelRatio: 2,
            backgroundColor: '#fff'
        });

        // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ <a> æ ‡ç­¾å¹¶è§¦å‘ä¸‹è½½
        const link1 = document.createElement('a');
        link1.href = imgURL1;
        link1.download = 'chart1.png'; // ä¸‹è½½çš„æ–‡ä»¶å
        link1.click(); // è§¦å‘ç‚¹å‡»äº‹ä»¶ï¼Œä¸‹è½½ç¬¬ä¸€ä¸ªå›¾è¡¨

        const link2 = document.createElement('a');
        link2.href = imgURL2;
        link2.download = 'chart2.png'; // ä¸‹è½½çš„æ–‡ä»¶å
        link2.click(); // è§¦å‘ç‚¹å‡»äº‹ä»¶ï¼Œä¸‹è½½ç¬¬äºŒä¸ªå›¾è¡¨
    });

    // é¡µé¢åŠ è½½æ—¶è°ƒç”¨ fetchData()
    fetchData();

    // æ¯20ç§’æ›´æ–°ä¸€æ¬¡æ•°æ®
    setInterval(fetchData, 20000);

</script>

</body>
</html>