<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœŸè´§æŠ•èµ„ç»¼åˆDashboardï¼ˆçœŸå®æ•°æ®ï¼‰</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.1/dist/echarts.min.js"></script>
    <script src="real_data_fetcher.js?v=20260203"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --bg-card: #1c2128;
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --color-primary: #58a6ff;
            --color-success: #3fb950;
            --color-warning: #d29922;
            --color-danger: #f85149;
            --chart-up: #f85149;
            --chart-down: #3fb950;
            --border-color: #30363d;
            --radius-md: 8px;
            --radius-lg: 12px;
            --transition-normal: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background-color: rgba(22, 27, 34, 0.8);
            backdrop-filter: blur(10px);
            padding: 12px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .status-info {
            display: flex;
            align-items: center;
            font-size: 13px;
            color: var(--text-secondary);
            background: var(--bg-secondary);
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-active {
            background-color: var(--color-success);
            box-shadow: 0 0 8px var(--color-success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.5;
                transform: scale(1.2);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }

        .card:hover {
            border-color: var(--color-primary);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .grid-6 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        @media (min-width: 768px) {
            .grid-6 {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (min-width: 1200px) {
            .grid-6 {
                grid-template-columns: repeat(6, 1fr);
            }
        }

        .stat-card {
            background-color: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: 12px;
            text-align: center;
            border: 1px solid transparent;
            transition: all 0.3s;
        }

        .stat-card:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-color);
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 992px) {
            .grid-2 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .chart-container {
            height: 350px;
            width: 100%;
            margin-top: 10px;
        }

        .text-up {
            color: var(--color-danger) !important;
            font-weight: 600;
        }

        .text-down {
            color: var(--color-success) !important;
            font-weight: 600;
        }

        .stat-up {
            color: var(--color-danger);
        }

        .stat-down {
            color: var(--color-success);
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(13, 17, 23, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-success {
            background: rgba(63, 185, 80, 0.15);
            color: #3fb950;
            border: 1px solid rgba(63, 185, 80, 0.3);
        }

        .badge-warning {
            background: rgba(210, 153, 34, 0.15);
            color: #d29922;
            border: 1px solid rgba(210, 153, 34, 0.3);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .table th {
            text-align: left;
            padding: 12px 10px;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
            font-weight: 500;
        }

        .table td {
            padding: 12px 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .variety-list::-webkit-scrollbar,
        .table-container::-webkit-scrollbar,
        .news-list::-webkit-scrollbar {
            width: 4px;
        }

        .variety-list::-webkit-scrollbar-thumb,
        .table-container::-webkit-scrollbar-thumb,
        .news-list::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 2px;
        }

        .market-main-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }

        @media (min-width: 1200px) {
            .market-main-grid {
                grid-template-columns: 2fr 1fr;
            }
        }

        .heatmaps-stack {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .variety-list {
            max-height: 850px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .variety-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            margin-bottom: 4px;
            background: var(--bg-secondary);
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .table-dragon-tiger th {
            font-size: 12px;
            padding: 8px 4px;
        }

        .table-dragon-tiger td {
            font-size: 12px;
            padding: 10px 4px;
        }

        .table-dragon-tiger tr:nth-child(even) {
            background: rgba(139, 148, 158, 0.03);
        }

        .change-up {
            color: #f85149;
        }

        .change-down {
            color: #3fb950;
        }

        .variety-row:hover {
            background-color: var(--bg-tertiary);
            border-color: var(--color-primary);
        }

        .v-info {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .v-name {
            font-weight: 600;
            min-width: 65px;
            white-space: nowrap;
        }

        .v-change {
            width: 70px;
            text-align: right;
        }

        .v-oi {
            width: 90px;
            text-align: right;
            color: var(--text-secondary);
            font-size: 11px;
        }

        .mini-progress {
            width: 40px;
            height: 3px;
            background: var(--border-color);
            border-radius: 2px;
            overflow: hidden;
        }

        .mini-fill {
            height: 100%;
            transition: width 0.3s;
        }

        .news-item {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }

        .news-item:hover {
            background-color: var(--bg-secondary);
        }

        .news-title {
            font-size: 14px;
            margin-bottom: 6px;
            line-height: 1.4;
        }

        .news-meta {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: white;
        }

        .btn-sm {
            padding: 4px 10px;
            font-size: 12px;
        }

        .btn-outline {
            background: transparent;
        }

        .select-variety {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 13px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <header class="header">
        <h1>ğŸ“Š Futures Insights - æœŸè´§æŠ•èµ„ç»¼åˆDashboard</h1>
        <div style="display: flex; align-items: center; gap: 20px;">
            <div class="status-info" id="trading-status">
                <span class="status-indicator"></span>
                <span id="status-text">æ•°æ®æ›´æ–°ä¸­...</span>
            </div>
            <button class="btn btn-sm" onclick="loadAllData()"
                style="background: var(--color-primary); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                <i class="fas fa-sync-alt"></i> åˆ·æ–°æ•°æ®
            </button>
        </div>
    </header>

    <div class="container">
        <!-- åŠ è½½çŠ¶æ€ -->
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p>æ­£åœ¨åŠ è½½çœŸå®æ•°æ®...</p>
        </div>

        <!-- ==================== ç¬¬ä¸€è¡Œï¼šå¸‚åœºæ¦‚è§ˆ ==================== -->
        <div class="grid-6" style="margin-bottom: 24px;">
            <div class="card stat-card">
                <div class="stat-label">ä¸Šæ¶¨å“ç§</div>
                <div class="stat-value text-up" id="upCount">-</div>
            </div>
            <div class="card stat-card">
                <div class="stat-label">ä¸‹è·Œå“ç§</div>
                <div class="stat-value text-down" id="downCount">-</div>
            </div>
            <div class="card stat-card">
                <div class="stat-label">å¹³å‡æ¶¨è·Œ</div>
                <div id="marketAvgChange" class="stat-value">-%</div>
            </div>
            <div class="card stat-card">
                <div class="stat-label">å¹³å‡åŸºå·®</div>
                <div class="stat-value text-primary" id="basisValue">-</div>
            </div>
            <div class="card stat-card">
                <div class="stat-label">åˆçº¦æ€»æ•°</div>
                <div class="stat-value" id="totalCount">-</div>
            </div>
            <div class="card stat-card">
                <div class="stat-label">å¸‚åœºæƒ…ç»ª</div>
                <div class="stat-value" id="emotionValueMini">-</div>
                <div id="emotionLabelMini" style="font-size: 11px; opacity: 0.8;">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- ==================== ç¬¬äºŒè¡Œï¼šæ ¸å¿ƒå›¾è¡¨ ==================== -->
        <div class="grid-2" style="margin-bottom: 24px;">
            <div class="card" style="margin-bottom: 0;">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-chart-line"></i> å¸‚åœºç»¼åˆæŒ‡æ•°è¶‹åŠ¿</h2>
                </div>
                <div id="marketIndexTrend" style="height: 300px; width: 100%;"></div>
            </div>

            <div class="card" style="margin-bottom: 0;">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-heartbeat"></i> æŠ•èµ„è€…å¤šç©ºæƒ…ç»ªè§‚å¯Ÿ (å®æ—¶æ³¢åŠ¨)</h2>
                    <div id="emotionUpdateInfo" style="font-size: 12px; color: var(--text-secondary);">æ›´æ–°äº: --:--</div>
                </div>
                <div id="emotionTrendChart" style="height: 300px; width: 100%;"></div>
            </div>
        </div>

        <!-- ==================== ç¬¬ä¸‰è¡Œï¼šçƒ­åŠ›å›¾ä¸å“ç§åˆ—è¡¨ ==================== -->
        <div class="market-main-grid">
            <div class="heatmaps-stack">
                <div class="card" style="margin-bottom: 0;">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-layer-group"></i> è¡Œä¸šèµ„é‡‘çƒ­å›¾</h2>
                        <span class="badge badge-success">å®æ—¶</span>
                    </div>
                    <div id="industryHeatmap" class="chart-container"></div>
                </div>
                <div class="card" style="margin-bottom: 0;">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-fire"></i> å“ç§èµ„é‡‘æµå‘</h2>
                        <span class="badge badge-success">å®æ—¶</span>
                    </div>
                    <div id="varietyHeatmap" class="chart-container"></div>
                </div>
            </div>

            <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column;">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-list-ul"></i> è¡Œæƒ…å¼‚åŠ¨ (å¢ä»“ç‡)</h2>
                    <div style="display: flex; gap: 4px;">
                        <button id="toggleVarietyListBtn" class="btn btn-sm"
                            onclick="toggleVarietyDisplay()">å…¨éƒ¨</button>
                    </div>
                </div>
                <div id="varietyList" class="variety-list"></div>
            </div>
        </div>

        <!-- ==================== ç¬¬å››è¡Œï¼šä¸»åŠ›åˆçº¦ä¸å¤šç©ºå¯¹æ¯” ==================== -->
        <div class="grid-2">
            <div class="card" style="margin-bottom: 0;">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-crown"></i> æ´»è·ƒä¸»åŠ›åˆçº¦ (æˆäº¤é¢Top)</h2>
                </div>
                <div class="table-container" style="max-height: 550px; overflow-y: auto;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ä»£ç </th>
                                <th>åç§°</th>
                                <th>ä»·æ ¼</th>
                                <th>æ¶¨è·Œ</th>
                            </tr>
                        </thead>
                        <tbody id="mainContractsTable">
                            <tr>
                                <td colspan="4"
                                    style="text-align: center; color: var(--text-secondary); padding: 40px;">æ•°æ®åŠ è½½ä¸­...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card" style="margin-bottom: 0;">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-balance-scale"></i> ä¸»åŠ›å¤šç©ºåŠ›é‡å¯¹æ¯” (TOP 15)</h2>
                </div>
                <div id="varietyPositionDiffChart" class="chart-container" style="height: 550px; padding: 10px;"></div>
            </div>
        </div>

        <!-- ==================== ç¬¬äº”è¡Œï¼šèµ„è®¯ä¸­å¿ƒ ==================== -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header">
                <h2 class="card-title"><i class="far fa-newspaper"></i> å¸‚åœºèµ„è®¯</h2>
            </div>
            <div class="grid-2" style="margin-bottom: 20px;">
                <div>
                    <h3 style="font-size: 14px; margin-bottom: 12px; color: var(--color-primary);">åŒèŠ±é¡ºæ–°é—»</h3>
                    <div id="thsNewsList" class="news-list" style="max-height: 400px; overflow-y: auto;"></div>
                </div>
                <div>
                    <h3 style="font-size: 14px; margin-bottom: 12px; color: var(--color-warning);">ä¸œæ–¹è´¢å¯Œèµ„è®¯ </h3>
                    <div id="emNewsList" class="news-list" style="max-height: 400px; overflow-y: auto;"></div>
                </div>
            </div>
            <div>
                <h3 style="font-size: 14px; margin-bottom: 12px; color: var(--color-primary);">åå°”è¡—è§é—»</h3>
                <div id="wallStreetNewsList" class="news-list" style="max-height: 250px; overflow-y: auto;"></div>
            </div>
        </div>

        <!-- ==================== ç¬¬å…­è¡Œï¼šé¾™è™æ¦œ ==================== -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header">
                <h2 class="card-title"><i class="fas fa-dragon"></i> æœºæ„é¾™è™æ¦œåŠ¨æ€</h2>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <input type="date" id="dragonDate" class="btn btn-sm"
                        style="background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); height: 32px; padding: 0 8px;">
                    <select id="dragon-variety-select" class="select-variety" style="width: 150px; height: 32px;"
                        onchange="loadDragonTiger()">
                        <option value="113_cu">æ²ªé“œ (cu)</option>
                    </select>
                    <button class="btn btn-sm" onclick="loadDragonTiger()"><i class="fas fa-search"></i> æŸ¥è¯¢</button>
                    <a id="goToLongShort" href="#" target="_blank" class="btn btn-sm btn-outline"
                        style="border:1px solid var(--color-primary); color:var(--color-primary); text-decoration:none; padding: 4px 10px; border-radius:4px; font-size:12px;">
                        <i class="fas fa-eye"></i> å¤šç©ºåˆ†å¸ƒ
                    </a>
                </div>
            </div>
            <div
                style="margin-bottom: 12px; font-weight: 500; font-size: 14px; color: var(--text-secondary); border-left: 3px solid var(--color-primary); padding-left: 10px;">
                é€‰ä¸­å“ç§æŒä»“æ¦œå•: <span id="currentVarietyName" style="color: var(--text-primary);">åŠ è½½ä¸­...</span>
            </div>
            <div class="table-container">
                <table class="table table-dragon-tiger">
                    <thead>
                        <tr>
                            <th style="width: 40px;">æ’å</th>
                            <th colspan="3"
                                style="text-align: center; color: #f85149; background: rgba(248, 81, 73, 0.05);">å¤šå¤´æŒä»“
                            </th>
                            <th colspan="3"
                                style="text-align: center; color: #3fb950; background: rgba(63, 185, 80, 0.05);">ç©ºå¤´æŒä»“
                            </th>
                        </tr>
                        <tr>
                            <th>#</th>
                            <th>å¸­ä½åç§°</th>
                            <th>æŒä»“é‡</th>
                            <th>å¢å‡</th>
                            <th>å¸­ä½åç§°</th>
                            <th>æŒä»“é‡</th>
                            <th>å¢å‡</th>
                        </tr>
                    </thead>
                    <tbody id="dragonTigerTable">
                        <tr>
                            <td colspan="7" style="text-align:center">æ•°æ®åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ==================== ç¬¬ä¸ƒè¡Œï¼šè¿›é˜¶åˆ†æ ==================== -->
        <div class="grid-2" style="margin-bottom: 20px;">
            <div class="card" style="grid-column: span 2;">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-chart-scatter"></i> æ¶¨è·Œå¹…ä¸å¢ä»“æ¯”å…³ç³»å›¾</h2>
                    <div style="display: flex; gap: 12px; align-items: center; font-size: 13px;">
                        <span style="color: var(--text-secondary);">æ°”æ³¡å¤§å°ä»£è¡¨:</span>
                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                            <input type="radio" name="bubbleMetric" value="cdzj" checked
                                onchange="updateAnalysisCharts()"> èµ„é‡‘
                        </label>
                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                            <input type="radio" name="bubbleMetric" value="cje" onchange="updateAnalysisCharts()"> æˆäº¤é¢
                        </label>
                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                            <input type="radio" name="bubbleMetric" value="vol" onchange="updateAnalysisCharts()"> æˆäº¤é‡
                        </label>
                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                            <input type="radio" name="bubbleMetric" value="ccl" onchange="updateAnalysisCharts()"> æŒä»“é‡
                        </label>
                    </div>
                </div>
                <div id="bubbleChartAnalysis" style="height: 500px; width: 100%;"></div>
            </div>

            <div class="card" style="grid-column: span 2;">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-align-left"></i> å…¨å“ç§ç›¸å¯¹å¼ºå¼±èµ°åŠ¿å¯¹æ¯”</h2>
                </div>
                <div id="trendComparisonChart" style="height: 550px; width: 100%;"></div>
            </div>
        </div>

        <!-- ==================== ç¬¬å…«è¡Œï¼šå“ç§æ·±åº¦åˆ†æ ==================== -->
        <div class="card" id="variety-analysis-section" style="margin-bottom: 20px;">
            <div class="card-header">
                <h2 class="card-title"><i class="fas fa-chart-line"></i> å“ç§æ·±åº¦ç»“æ„åˆ†æ</h2>
                <div style="display: flex; gap: 12px;">
                    <select id="variety-select-analysis" class="select-variety"
                        onchange="handleVarietyAnalysisChange()">
                        <option value="">é€‰æ‹©å“ç§è¿›è¡Œæ·±åº¦åˆ†æ...</option>
                    </select>
                    <button class="btn btn-sm" onclick="fetchVarietyAnalysis()">åˆ†æ</button>
                </div>
            </div>
            <div class="grid-2">
                <div id="premiumStructureChart" class="chart-container"></div>
                <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>åˆçº¦</th>
                                <th>æœ€æ–°</th>
                                <th>æ¶¨å¹…</th>
                                <th>æˆäº¤</th>
                                <th>æŒä»“</th>
                            </tr>
                        </thead>
                        <tbody id="varietyContractsBody">
                            <tr>
                                <td colspan="5"
                                    style="text-align: center; color: var(--text-secondary); padding: 40px;">è¯·é€‰æ‹©å“ç§æŸ¥çœ‹åˆçº¦ç»“æ„
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let charts = {};
        let currentDate = new Date();
        let showAllVarieties = false;
        let lastRawVarietyList = [];
        let nightVarieties = new Set(); // å­˜å‚¨å¤œç›˜å“ç§ä»£ç 
        let isNightSession = false; // æ˜¯å¦ä¸ºå¤œç›˜æ—¶æ®µ

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }

        const DIRECT_VARIETY_MAP = {
            'cu': '113_cu', 'al': '113_al', 'zn': '113_zn', 'pb': '113_pb', 'ni': '113_ni',
            'sn': '113_sn', 'au': '113_au', 'ag': '113_ag', 'rb': '113_rb', 'wr': '113_wr',
            'hc': '113_hc', 'ss': '113_ss', 'bu': '113_bu', 'ru': '113_ru', 'sp': '113_sp',
            'fu': '113_fu', 'ad': '113_ad', 'ao': '113_ao', 'br': '113_br',
            'c': '114_c', 'cs': '114_cs', 'a': '114_a', 'b': '114_b', 'm': '114_m',
            'y': '114_y', 'p': '114_p', 'jd': '114_jd', 'rr': '114_rr', 'l': '114_l',
            'v': '114_v', 'pp': '114_pp', 'j': '114_j', 'jm': '114_jm', 'i': '114_i',
            'eg': '114_eg', 'eb': '114_eb', 'pg': '114_pg', 'lh': '114_lh', 'lg': '114_lg',
            'oi': '115_oi', 'rm': '115_rm', 'cf': '115_cf', 'sr': '115_sr', 'ta': '115_ta',
            'ma': '115_ma', 'fg': '115_fg', 'ap': '115_ap', 'ur': '115_ur', 'sa': '115_sa',
            'wh': '115_wh', 'pm': '115_pm', 'ri': '115_ri', 'jr': '115_jr', 'lr': '115_lr',
            'rs': '115_rs', 'cy': '115_cy', 'zc': '115_zc', 'sf': '115_sf', 'sm': '115_sm',
            'cj': '115_cj', 'pf': '115_pf', 'pk': '115_pk', 'px': '115_px', 'sh': '115_sh',
            'sc': '142_sc', 'lu': '142_lu', 'nr': '142_nr', 'bc': '142_bc', 'ec': '142_ec',
            'if': '220_if', 'ic': '220_ic', 'ih': '220_ih', 'im': '220_im',
            'tf': '220_tf', 't': '220_t', 'ts': '220_ts', '2y': '220_2y',
            '5y': '220_5y', '10y': '220_10y', '30y': '220_30y',
            'si': '225_si', 'lc': '225_lc', 'ps': '225_ps'
        };

        function updateTradingStatus() {
            const now = new Date();
            const hour = now.getHours();
            const min = now.getMinutes();
            const day = now.getDay();

            let isActive = false;
            let statusText = "éäº¤æ˜“æ—¶æ®µ";

            if (day >= 1 && day <= 5) {
                if ((hour === 9) || (hour === 10 && min <= 15) || (hour === 10 && min >= 30) || (hour === 11 && min <= 30) || (hour >= 13 && hour < 15)) {
                    isActive = true;
                    statusText = "æ—¥ç›˜äº¤æ˜“ä¸­";
                    isNightSession = false;
                } else if (hour >= 21 || hour < 3) {
                    isActive = true;
                    statusText = "å¤œç›˜äº¤æ˜“ä¸­";
                    isNightSession = true;
                } else {
                    isNightSession = false;
                }
            } else {
                isNightSession = false;
            }

            const indicator = document.querySelector('.status-indicator');
            const statusTextEl = document.getElementById('status-text');
            if (indicator && statusTextEl) {
                indicator.className = `status-indicator ${isActive ? 'status-active' : ''}`;
                statusTextEl.textContent = `å¸‚åœºçŠ¶æ€: ${statusText} (${now.toLocaleTimeString()})`;
            }
        }

        // åˆ¤æ–­å“ç§æ˜¯å¦ä¸ºå¤œç›˜å“ç§
        function isNightVariety(varietyCode) {
            if (!varietyCode) return false;
            const code = varietyCode.toLowerCase().replace(/\d+$/, '');
            return nightVarieties.has(code);
        }

        // ä»å¤œç›˜æ•°æ®ä¸­æå–å¤œç›˜å“ç§ä»£ç 
        function extractNightVarieties(nightData) {
            nightVarieties.clear();
            if (nightData && nightData.list) {
                nightData.list.forEach(item => {
                    if (item.dm) {
                        const code = item.dm.toLowerCase().replace(/\d+$/, '');
                        if (code) {
                            nightVarieties.add(code);
                        }
                    }
                });
            }
            console.log(`æå–å¤œç›˜å“ç§æ•°é‡: ${nightVarieties.size}ä¸ª`, Array.from(nightVarieties));
        }

        // è¿‡æ»¤æ•°æ®ï¼šå¦‚æœæ˜¯å¤œç›˜æ—¶æ®µï¼Œåªä¿ç•™å¤œç›˜å“ç§
        function filterBySession(list) {
            if (!list || !Array.isArray(list)) return list;

            if (!isNightSession || nightVarieties.size === 0) {
                return list;
            }

            return list.filter(item => {
                const code = item.dm ? item.dm.toLowerCase().replace(/\d+$/, '') : '';
                return nightVarieties.has(code);
            });
        }

        async function loadAllData() {
            try {
                updateTradingStatus();

                // é¦–å…ˆåŠ è½½å¤œç›˜æ•°æ®ä»¥æå–å¤œç›˜å“ç§
                const nightData = await realDataFetcher.getNightVarietyList();
                if (nightData) {
                    extractNightVarieties(nightData);
                }

                const safeExecute = async (name, fn) => {
                    try {
                        await fn();
                    } catch (e) {
                        console.error(`Failed to load ${name}:`, e);
                    }
                };

                await Promise.all([
                    safeExecute('Industry Heatmap', async () => {
                        const data = await realDataFetcher.getIndustryHeatmap();
                        if (data) renderIndustryHeatmap(data);
                    }),
                    safeExecute('Variety Heatmap', async () => {
                        const data = await realDataFetcher.getVarietyHeatmap();
                        if (data) renderVarietyHeatmap(data);
                    }),
                    safeExecute('Main Contracts', loadMainContracts),
                    safeExecute('Market Data', async () => {
                        const marketData = await realDataFetcher.getMarketOverview();
                        const upDownData = await realDataFetcher.getMarketUpDown();
                        if (marketData && marketData.list) {
                            renderVarietyList(marketData.list);
                            populateVarietySelect(marketData.list, 'variety-select-analysis');
                            populateVarietySelect(marketData.list, 'dragon-variety-select');
                        }
                        if (upDownData && upDownData.result) {
                            renderMarketUpDown(upDownData, marketData.list);
                        }
                    }),
                    safeExecute('Basis', async () => {
                        const basisData = await realDataFetcher.getBasis();
                        if (basisData) renderBasis(basisData);
                    }),
                    safeExecute('Index Trend', async () => {
                        const indexTrend = await realDataFetcher.getMarketIndexTrend();
                        if (indexTrend) renderMarketIndexTrend(indexTrend);
                    }),
                    safeExecute('Emotion', async () => {
                        const [emotion, history] = await Promise.all([
                            realDataFetcher.getEmotionIndex(),
                            realDataFetcher.getEmotionHistory()
                        ]);
                        if (emotion) renderEmotionIndex(emotion);
                        if (history) renderEmotionTrendChart(history);
                    })
                ]);

                await safeExecute('News & Dragon Tiger', async () => {
                    await Promise.all([loadNews(), loadDragonTiger()]);
                });

                await safeExecute('Analysis Charts', updateAnalysisCharts);

                setTimeout(() => {
                    const defaultVariety = '113_cu';
                    const analysisSelect = document.getElementById('variety-select-analysis');
                    if (analysisSelect && (!analysisSelect.value || analysisSelect.value === "")) {
                        analysisSelect.value = defaultVariety;
                        fetchVarietyAnalysis(defaultVariety);
                    }
                }, 500);

            } catch (error) {
                console.error('åŠ è½½ç³»ç»Ÿå‘ç”Ÿä¸¥é‡é”™è¯¯:', error);
            } finally {
                const loading = document.getElementById('loading');
                if (loading) loading.style.display = 'none';
            }
        }

        let currentVarietyId = '113_cu';
        let allVarietiesList = [];

        function populateVarietySelect(list, selectId = 'variety-select-analysis') {
            const select = document.getElementById(selectId);
            if (!select) return;

            if (selectId === 'variety-select-analysis') {
                allVarietiesList = list;
            }

            while (select.options.length > 1) {
                select.remove(1);
            }

            const sortedList = [...list].sort((a, b) => a.name.localeCompare(b.name, 'zh-Hans-CN'));
            sortedList.forEach(item => {
                const uidParts = item.uid.split('|');
                const marketCode = uidParts[0];
                const rawCode = uidParts[1]?.toLowerCase();
                const varietyCode = rawCode ? rawCode.replace(/\d+$/, '') : '';

                if (varietyCode) {
                    const varietyId = `${marketCode}_${varietyCode}`;
                    if (!Array.from(select.options).some(o => o.value === varietyId)) {
                        const opt = document.createElement('option');
                        opt.value = varietyId;
                        opt.textContent = `${item.name.replace('åŠ æƒ', '')} (${varietyCode.toUpperCase()})`;
                        select.appendChild(opt);
                    }
                }
            });

            if (currentVarietyId) {
                select.value = currentVarietyId;
            }
        }

        async function syncVariety(inputId, options = {}) {
            if (!inputId) return;

            const defaultOptions = {
                switchTab: false,
                tab: 'realtime',
                scrollTo: false,
                targetId: 'variety-analysis-section'
            };
            const mergedOptions = { ...defaultOptions, ...options };

            console.log('Syncing variety:', inputId, mergedOptions);

            let finalId = null;

            if (typeof inputId === 'string' && inputId.includes('_')) {
                finalId = inputId;
            } else if (DIRECT_VARIETY_MAP[inputId.toLowerCase()]) {
                finalId = DIRECT_VARIETY_MAP[inputId.toLowerCase()];
            } else {
                const searchStr = inputId.toLowerCase();
                const matched = allVarietiesList.find(i =>
                    i.name.toLowerCase().includes(searchStr) ||
                    (i.uid && i.uid.toLowerCase().includes(searchStr))
                );

                if (matched && matched.uid) {
                    const parts = matched.uid.split('|');
                    const market = parts[0];
                    const code = parts[1].toLowerCase().replace(/\d+$/, '');
                    finalId = `${market}_${code}`;
                }
            }

            if (!finalId) {
                console.warn('Could not resolve variety ID for:', inputId);
                return;
            }

            currentVarietyId = finalId;

            const selectors = ['variety-select-analysis', 'dragon-variety-select'];
            selectors.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    if (!Array.from(el.options).some(o => o.value === finalId)) {
                        const opt = document.createElement('option');
                        opt.value = finalId;
                        opt.textContent = `${finalId} (åŒæ­¥)`;
                        el.appendChild(opt);
                    }
                    el.value = finalId;
                }
            });

            await Promise.all([
                handleVarietyAnalysisChange(),
                loadDragonTiger()
            ]);

            if (mergedOptions.scrollTo && mergedOptions.targetId) {
                setTimeout(() => {
                    const el = document.getElementById(mergedOptions.targetId);
                    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 150);
            }
        }

        async function handleVarietyAnalysisChange() {
            const select = document.getElementById('variety-select-analysis');
            if (select && select.value !== currentVarietyId) {
                currentVarietyId = select.value;
                const dragonSelect = document.getElementById('dragon-variety-select');
                if (dragonSelect) dragonSelect.value = currentVarietyId;
            }

            if (!currentVarietyId) return;
            await fetchVarietyAnalysis(currentVarietyId);
        }

        async function fetchVarietyAnalysis(varietyId) {
            const container = document.getElementById('varietyContractsBody');
            container.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px;">æ•°æ®è§£æä¸­...</td></tr>';

            try {
                const redisData = await realDataFetcher.getVarietyContracts(varietyId);
                if (!redisData || !Array.isArray(redisData)) throw new Error("æ— æ³•è¯»å–åˆçº¦åˆ—è¡¨");

                const codes = redisData
                    .filter(i => i.code && /\d/.test(i.code))
                    .map(i => `${i.mktid}_${i.code}`);

                if (codes.length === 0) throw new Error("æœªæ‰¾åˆ°æœ‰æ•ˆåˆçº¦");

                const pricesData = await realDataFetcher.getContractPrices(codes.slice(0, 20).join(','));
                if (!pricesData || !pricesData.list) throw new Error("ä»·æ ¼è§£æå¤±è´¥");

                const contracts = pricesData.list.map(item => ({
                    code: item.name,
                    price: parseFloat(item.p) || 0,
                    change: parseFloat(item.zdf) || 0,
                    volume: parseInt(item.cj) || 0,
                    position: parseInt(item.ccl) || 0
                })).sort((a, b) => {
                    const monthA = a.code.match(/\d+/) ? parseInt(a.code.match(/\d+/)[0]) : 0;
                    const monthB = b.code.match(/\d+/) ? parseInt(b.code.match(/\d+/)[0]) : 0;
                    return monthA - monthB;
                });

                renderVarietyContractsTable(contracts);
                renderVarietyStructureChart(contracts);
            } catch (e) {
                container.innerHTML = `<tr><td colspan="5" style="text-align: center; color: var(--color-danger); padding: 40px;">åˆ†æå¤±è´¥: ${e.message}</td></tr>`;
            }
        }

        function renderVarietyContractsTable(contracts) {
            const tbody = document.getElementById('varietyContractsBody');
            tbody.innerHTML = contracts.map(c => `
                <tr>
                    <td><strong>${c.code}</strong></td>
                    <td>${c.price}</td>
                    <td class="${c.change >= 0 ? 'text-up' : 'text-down'}">${c.change >= 0 ? '+' : ''}${c.change.toFixed(2)}%</td>
                    <td>${(c.volume / 10000).toFixed(1)}w</td>
                    <td>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span>${(c.position / 10000).toFixed(1)}w</span>
                            <a href="pages/future.html?variety=${currentVarietyId}&showPremium=true" target="_blank" title="æŸ¥çœ‹è¯¦æƒ…" style="color:var(--color-primary); font-size:12px;">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function renderVarietyStructureChart(contracts) {
            const chartDom = document.getElementById('premiumStructureChart');
            if (!chartDom) return;
            const chart = echarts.init(chartDom);

            const xData = contracts.map(c => c.code.match(/\d+/)?.[0] || c.code);
            const priceData = contracts.map(c => c.price);
            const volData = contracts.map(c => c.volume);
            const posData = contracts.map(c => c.position);

            const option = {
                title: { text: 'æœˆé—´åˆçº¦å¯¹æ¯” (æœŸé™ç»“æ„)', textStyle: { color: '#8b949e', fontSize: 13 }, left: 'center', top: 5 },
                tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
                legend: { data: ['ä»·æ ¼', 'æˆäº¤é‡', 'æŒä»“é‡'], bottom: 0, textStyle: { color: '#8b949e' } },
                grid: { left: '3%', right: '8%', bottom: '15%', top: '15%', containLabel: true },
                xAxis: { type: 'category', data: xData, axisLabel: { color: '#8b949e' } },
                yAxis: [
                    { type: 'value', name: 'ä»·æ ¼', position: 'left', scale: true, nameTextStyle: { color: '#58a6ff' }, axisLabel: { color: '#58a6ff' }, splitLine: { lineStyle: { color: '#30363d' } } },
                    { type: 'value', name: 'æˆäº¤/æŒä»“', position: 'right', nameTextStyle: { color: '#8b949e' }, axisLabel: { color: '#8b949e' }, splitLine: { show: false } }
                ],
                dataZoom: [{ type: 'inside', start: 0, end: 100 }, { type: 'slider', height: 20, bottom: 25 }],
                series: [
                    { name: 'ä»·æ ¼', type: 'line', smooth: true, symbol: 'circle', symbolSize: 8, lineStyle: { color: '#58a6ff', width: 3 }, itemStyle: { color: '#58a6ff' }, data: priceData },
                    { name: 'æˆäº¤é‡', type: 'bar', yAxisIndex: 1, itemStyle: { color: '#3fb950', opacity: 0.7 }, data: volData },
                    { name: 'æŒä»“é‡', type: 'bar', yAxisIndex: 1, itemStyle: { color: '#d29922', opacity: 0.7 }, data: posData }
                ]
            };
            chart.setOption(option, true);
            charts.premiumStructure = chart;
            setTimeout(() => chart.resize(), 100);
        }

        function renderIndustryHeatmap(data) {
            const chart = echarts.init(document.getElementById('industryHeatmap'));

            let list = [];
            if (data && data.result && data.result.list) list = data.result.list;
            else if (data && data.list) list = data.list;
            else if (Array.isArray(data)) list = data;

            if (list.length === 0) {
                document.getElementById('industryHeatmap').innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;color:var(--text-secondary);">çƒ­åŠ›å›¾æ•°æ®åŠ è½½ä¸­...</div>';
                return;
            }

            const treemapData = list.filter(item => {
                const amount = parseFloat(item.cdzj);
                const change = parseFloat(item.zdf);
                return !isNaN(amount) && !isNaN(change) && amount > 0;
            }).map(item => {
                const amount = parseFloat(item.cdzj);
                const change = parseFloat(item.zdf);
                return {
                    name: item.name.replace(/(æ¿å—|äº§ä¸š)/, ''),
                    value: [amount, change],
                    itemStyle: { color: change >= 0 ? '#f85149' : '#3fb950' }
                };
            });

            if (treemapData.length === 0) {
                document.getElementById('industryHeatmap').innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;color:var(--text-secondary);">æš‚æ— æœ‰æ•ˆè¡Œä¸šèµ„é‡‘æ•°æ®</div>';
                return;
            }

            chart.setOption({
                tooltip: {
                    formatter: function (info) {
                        var value = info.value;
                        return `<div style="font-size:14px;font-weight:bold">${echarts.format.encodeHTML(info.name)}</div>æ²‰æ·€èµ„é‡‘: ${(value[0] / 100000000).toFixed(2)}äº¿<br/>æ¶¨è·Œå¹…: ${value[1].toFixed(2)}%`;
                    }
                },
                series: [{
                    type: 'treemap', width: '100%', height: '100%', roam: false, nodeClick: false, breadcrumb: { show: false },
                    label: { show: true, formatter: '{b}\n{@[1]}%', fontSize: 14 },
                    itemStyle: { borderColor: '#1c2128', borderWidth: 2 },
                    data: treemapData
                }]
            });
            charts.industryHeatmap = chart;
        }

        function renderVarietyHeatmap(data) {
            const chart = echarts.init(document.getElementById('varietyHeatmap'));

            let list = [];
            if (data && data.result && data.result.list) list = data.result.list;
            else if (data && data.list) list = data.list;
            else if (Array.isArray(data)) list = data;

            if (list.length === 0) {
                document.getElementById('varietyHeatmap').innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;color:var(--text-secondary);">çƒ­åŠ›å›¾æ•°æ®åŠ è½½ä¸­...</div>';
                return;
            }

            // å¤œç›˜æ—¶æ®µè¿‡æ»¤ï¼šåªæ˜¾ç¤ºå¤œç›˜å“ç§
            list = filterBySession(list);

            const treemapData = list.filter(item => {
                const amount = parseFloat(item.cdzj);
                const change = parseFloat(item.zdf);
                return !isNaN(amount) && !isNaN(change) && amount > 0;
            }).map(item => {
                const amount = parseFloat(item.cdzj);
                const change = parseFloat(item.zdf);
                return {
                    name: item.name.replace('åŠ æƒ', ''),
                    value: [amount, change],
                    itemStyle: { color: change >= 0 ? '#f85149' : '#3fb950' }
                };
            });

            if (treemapData.length === 0) {
                document.getElementById('varietyHeatmap').innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;color:var(--text-secondary);">' + (isNightSession ? 'å¤œç›˜æ—¶æ®µæš‚æ— æ´»è·ƒå“ç§' : 'æš‚æ— æœ‰æ•ˆå“ç§èµ„é‡‘æ•°æ®') + '</div>';
                return;
            }

            chart.setOption({
                tooltip: {
                    formatter: function (info) {
                        var value = info.value;
                        return `<div style="font-size:14px;font-weight:bold">${echarts.format.encodeHTML(info.name)}</div>æ²‰æ·€èµ„é‡‘: ${(value[0] / 100000000).toFixed(2)}äº¿<br/>æ¶¨è·Œå¹…: ${value[1].toFixed(2)}%`;
                    }
                },
                series: [{
                    type: 'treemap', width: '100%', height: '100%', roam: false, nodeClick: false, breadcrumb: { show: false },
                    label: { show: true, formatter: '{b}\n{@[1]}%', fontSize: 12 },
                    itemStyle: { borderColor: '#1c2128', borderWidth: 1 },
                    data: treemapData
                }]
            });
            charts.varietyHeatmap = chart;

            chart.on('click', function (params) {
                if (params.data && params.data.name) {
                    const name = params.data.name;
                    const item = allVarietiesList.find(i => i.name.includes(name));
                    if (item) {
                        const code = item.uid.split('|')[1]?.toLowerCase().replace(/\d+$/, '');
                        syncVariety(code, { switchTab: false, scrollTo: true, targetId: 'variety-analysis-section' });
                    }
                }
            });
        }

        async function loadMainContracts() {
            const data = await realDataFetcher.getMainContracts();
            if (data) renderMainContracts(data);
        }

        function renderMainContracts(data) {
            const tbody = document.getElementById('mainContractsTable');

            let list = [];
            if (data && data.list) list = data.list;
            else if (Array.isArray(data)) list = data;

            // å¤œç›˜æ—¶æ®µè¿‡æ»¤ï¼šåªæ˜¾ç¤ºå¤œç›˜å“ç§
            list = filterBySession(list);

            if (list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">' + (isNightSession ? 'å¤œç›˜æ—¶æ®µæš‚æ— æ´»è·ƒåˆçº¦' : 'æš‚æ— åˆçº¦æ•°æ®') + '</td></tr>';
                return;
            }

            list = list.slice(0, 15);

            tbody.innerHTML = list.map(c => {
                const price = parseFloat(c.p) || 0;
                const changePercent = parseFloat(c.zdf) || 0;
                const dm = c.dm;

                return `
                <tr style="cursor: pointer;" onclick="syncVariety('${dm.replace(/\d+$/, '')}', { switchTab: false, scrollTo: true, targetId: 'variety-analysis-section' })">
                    <td><strong>${dm}</strong></td>
                    <td>${c.name}</td>
                    <td>${price.toFixed(price < 10 ? 3 : 2)}</td>
                    <td class="${changePercent >= 0 ? 'text-up' : 'text-down'}">${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%</td>
                </tr>
            `}).join('');
        }

        function renderMarketUpDown(data, list = []) {
            if (data && data.result) {
                const res = data.result;
                document.getElementById('upCount').textContent = res.z || '0';
                document.getElementById('downCount').textContent = res.d || '0';
                document.getElementById('totalCount').textContent = res.total || '0';

                if (list && list.length > 0) {
                    const changes = list.map(i => parseFloat(i.zdf) || 0);
                    const avgChange = (changes.reduce((a, b) => a + b, 0) / changes.length).toFixed(2);
                    const avgElem = document.getElementById('marketAvgChange');
                    if (avgElem) {
                        avgElem.textContent = (avgChange >= 0 ? '+' : '') + avgChange + '%';
                        avgElem.className = 'stat-value ' + (avgChange >= 0 ? 'text-up' : 'text-down');
                    }
                }
            }
        }

        function renderVarietyList(list) {
            if (list) lastRawVarietyList = list;
            let dataToRender = list || lastRawVarietyList;

            // å¤œç›˜æ—¶æ®µè¿‡æ»¤ï¼šåªæ˜¾ç¤ºå¤œç›˜å“ç§
            dataToRender = filterBySession(dataToRender);

            const container = document.getElementById('varietyList');
            if (!dataToRender || dataToRender.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px;">' + (isNightSession ? 'å¤œç›˜æ—¶æ®µæš‚æ— äº¤æ˜“å“ç§' : 'æš‚æ— æ•°æ®') + '</div>';
                return;
            }

            const sortedList = [...dataToRender].sort((a, b) => {
                const absA = Math.abs(parseFloat(a.zdf) || 0);
                const absB = Math.abs(parseFloat(b.zdf) || 0);
                return absB - absA;
            });

            const displayList = showAllVarieties ? sortedList : sortedList.slice(0, 40);

            container.innerHTML = displayList.map(item => {
                const change = parseFloat(item.zdf) || 0;
                const oiChangeRate = item.zccl ? (((item.ccl - item.zccl) / item.zccl) * 100).toFixed(2) : '0.00';
                const isUp = change >= 0;
                const oiIsUp = parseFloat(oiChangeRate) >= 0;

                return `
                <div class="variety-row" onclick="syncVariety('${item.uid.split('|')[1]?.toLowerCase().replace(/\d+$/, '')}', { switchTab: false, scrollTo: true, targetId: 'variety-analysis-section' })">
                    <div class="v-info">
                        <a href="pages/future.html?variety=${item.uid.split('|')[0]}_${item.uid.split('|')[1]?.toLowerCase().replace(/\d+$/, '')}&showPremium=true" target="_blank" class="v-name" style="color: inherit; text-decoration: none;" onclick="event.stopPropagation()">
                            ${item.name} <i class="fas fa-external-link-alt" style="font-size: 10px; opacity: 0.5;"></i>
                        </a>
                        <div class="mini-progress">
                            <div class="mini-fill" style="width: ${Math.min(Math.abs(change) * 5, 100)}%; background: ${isUp ? 'var(--color-danger)' : 'var(--color-success)'}"></div>
                        </div>
                    </div>
                    <div class="v-change ${isUp ? 'text-up' : 'text-down'}">${isUp ? '+' : ''}${change.toFixed(2)}%</div>
                    <div class="v-oi" style="color: ${oiIsUp ? 'var(--color-danger)' : 'var(--color-success)'}">${oiIsUp ? 'å¢' : 'å‡'}${Math.abs(oiChangeRate)}%</div>
                </div>
            `;
            }).join('');
        }

        function toggleVarietyDisplay() {
            showAllVarieties = !showAllVarieties;
            const btn = document.getElementById('toggleVarietyListBtn');
            if (btn) btn.textContent = showAllVarieties ? 'æ”¶èµ·åˆ—è¡¨' : 'æ˜¾ç¤ºå…¨éƒ¨';
            renderVarietyList(lastRawVarietyList);
        }

        function renderBasis(data) {
            if (data && data.data && Array.isArray(data.data)) {
                let totalBasis = 0;
                let count = 0;
                data.data.forEach(item => {
                    if (item.basisContractList) {
                        const defaultBasis = item.basisContractList.find(b => b.defaultValue === 'Y');
                        if (defaultBasis && defaultBasis.closeBasisValue) {
                            totalBasis += parseFloat(defaultBasis.closeBasisValue);
                            count++;
                        }
                    }
                });
                const avgBasis = count > 0 ? (totalBasis / count).toFixed(2) : '-';
                const basisElem = document.getElementById('basisValue');
                if (basisElem) {
                    basisElem.textContent = avgBasis;
                    basisElem.className = 'stat-value ' + (parseFloat(avgBasis) >= 0 ? 'text-up' : 'text-down');
                }
            }
        }

        async function loadNews() {
            const [thsNews, emNews, wallStreetNews] = await Promise.all([
                realDataFetcher.getTHSNews(),
                realDataFetcher.getEMNews(),
                realDataFetcher.getWallStreetNews()
            ]);

            if (thsNews) renderNewsList(thsNews, 'thsNewsList', 'åŒèŠ±é¡º');
            if (emNews) renderNewsList(emNews, 'emNewsList', 'ä¸œæ–¹è´¢å¯Œ');
            if (wallStreetNews) renderNewsList(wallStreetNews, 'wallStreetNewsList', 'åå°”è¡—');
        }

        function renderNewsList(data, containerId, source) {
            const container = document.getElementById(containerId);
            if (!container) return;

            let list = [];
            if (source === 'åŒèŠ±é¡º' && data && Array.isArray(data.data)) list = data.data;
            else if (source === 'ä¸œæ–¹è´¢å¯Œ' && data && data.data && Array.isArray(data.data.list)) list = data.data.list;
            else if (source === 'åå°”è¡—' && data && data.data && Array.isArray(data.data.items)) list = data.data.items;
            else if (Array.isArray(data)) list = data;

            if (!Array.isArray(list) || list.length === 0) {
                container.innerHTML = '<div class="news-item">æš‚æ— ç›¸å…³èµ„è®¯</div>';
                return;
            }

            container.innerHTML = list.slice(0, 8).map(n => {
                let title, timeStr, url;

                if (source === 'ä¸œæ–¹è´¢å¯Œ') {
                    title = n.Art_Title || 'æ— æ ‡é¢˜';
                    timeStr = n.Art_ShowTime || '';
                    url = n.Art_Url || n.Art_OriginUrl || '#';
                } else if (source === 'åå°”è¡—') {
                    title = n.title || n.content_text || 'æ— æ ‡é¢˜';
                    timeStr = n.display_time || '';
                    url = n.uri ? `https://wallstreetcn.com/articles/${n.id}` : '#';
                } else {
                    title = n.title || 'æ— æ ‡é¢˜';
                    timeStr = n.time || (n.utime ? new Date(n.utime * 1000).toLocaleTimeString() : '');
                    url = n.url || '#';
                }

                return `
                <div class="news-item">
                    <div class="news-title"><a href="${url}" target="_blank" style="color: inherit; text-decoration: none;">${title}</a></div>
                    <div class="news-meta">
                        <span class="badge badge-warning">${source}</span>
                        <span>â€¢ ${timeStr}</span>
                    </div>
                </div>
            `}).join('');
        }

        async function loadDragonTiger() {
            const dateInput = document.getElementById('dragonDate');
            const date = dateInput && dateInput.value ? dateInput.value.replace(/-/g, '') : formatDate(new Date());

            const varietySelect = document.getElementById('dragon-variety-select');

            if (varietySelect && varietySelect.value && varietySelect.value !== currentVarietyId) {
                currentVarietyId = varietySelect.value;
                const analysisSelect = document.getElementById('variety-select-analysis');
                if (analysisSelect) analysisSelect.value = currentVarietyId;
                await handleVarietyAnalysisChange();
            }

            const varietyUid = currentVarietyId || '113_cu';
            const varietyCode = varietyUid.includes('_') ? varietyUid.split('_')[1] : varietyUid;
            const marketCode = varietyUid.includes('_') ? varietyUid.split('_')[0] : '113';

            const varietyNameDisplay = document.getElementById('currentVarietyName');
            if (varietyNameDisplay && varietySelect && varietySelect.selectedIndex >= 0) {
                const name = varietySelect.options[varietySelect.selectedIndex].text;
                varietyNameDisplay.textContent = name + ' (' + varietyCode.toUpperCase() + ')';

                const longShortLink = document.getElementById('goToLongShort');
                if (longShortLink) {
                    longShortLink.href = `pages/longshort.html?variety=${varietyCode}`;
                }
            }

            const [dragonTiger, varietyPositionDiff] = await Promise.all([
                realDataFetcher.getDragonTigerVarietySummary(date, marketCode, varietyCode),
                realDataFetcher.getVarietyPositionDiff()
            ]);

            if (dragonTiger) renderDragonTiger(dragonTiger, varietyCode);
            if (varietyPositionDiff) renderVarietyPositionDiff(varietyPositionDiff);
        }

        function renderDragonTiger(data, varietyCode) {
            const tbody = document.getElementById('dragonTigerTable');

            if (!data || !data.data) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center">æš‚æ— æ¦œå•æ•°æ®</td></tr>';
                return;
            }

            const d = data.data;
            const longList = d.longInfoList || [];
            const shortList = d.shortInfoList || [];

            let rowsHtml = '';

            for (let i = 0; i < 20; i++) {
                const long = longList[i] || {};
                const short = shortList[i] || {};

                const longBrokerName = long.futureCompanyName ? long.futureCompanyName.replace('(ä»£å®¢)', '') : '-';
                const shortBrokerName = short.futureCompanyName ? short.futureCompanyName.replace('(ä»£å®¢)', '') : '-';

                const longChange = long.longChange !== undefined ? parseInt(long.longChange) : null;
                const shortChange = short.shortChange !== undefined ? parseInt(short.shortChange) : null;

                rowsHtml += `
                    <tr>
                        <td style="color: var(--text-secondary);">${i + 1}</td>
                        <td style="font-weight: 500;">
                            ${long.futureCompanyName ? `<a href="pages/companyholding.html?company=${encodeURIComponent(long.futureCompanyName)}&code=${varietyCode}" target="_blank" style="color:inherit; text-decoration:none;" title="æŸ¥çœ‹è¯¥æœºæ„æŒä»“">${longBrokerName}</a>` : '-'}
                        </td>
                        <td style="text-align: right;">${long.longNum || '-'}</td>
                        <td class="${(longChange || 0) >= 0 ? 'change-up' : 'change-down'}" style="text-align: right;">${longChange !== null ? (longChange > 0 ? '+' : '') + longChange : '-'}</td>
                        <td style="font-weight: 500;">
                            ${short.futureCompanyName ? `<a href="pages/companyholding.html?company=${encodeURIComponent(short.futureCompanyName)}&code=${varietyCode}" target="_blank" style="color:inherit; text-decoration:none;" title="æŸ¥çœ‹è¯¥æœºæ„æŒä»“">${shortBrokerName}</a>` : '-'}
                        </td>
                        <td style="text-align: right;">${short.shortNum || '-'}</td>
                        <td class="${(shortChange || 0) <= 0 ? 'change-up' : 'change-down'}" style="text-align: right;">${shortChange !== null ? (shortChange > 0 ? '+' : '') + shortChange : '-'}</td>
                    </tr>
                `;
            }

            tbody.innerHTML = rowsHtml;
        }

        function renderVarietyPositionDiff(data) {
            const containerChartHome = document.getElementById('varietyPositionDiffChart');

            let list = [];
            if (data && data.data && data.data.quoteGenralVarietyPositions) {
                list = data.data.quoteGenralVarietyPositions.slice(0, 15);
            }

            if (!containerChartHome || list.length === 0) return;

            const chart = echarts.init(containerChartHome);
            const categories = list.map(v => v.varietyName).reverse();
            const longData = list.map(v => (v.totalLongRate * 100).toFixed(1)).reverse();
            const shortData = list.map(v => (v.totalShortRate * 100).toFixed(1)).reverse();

            chart.setOption({
                backgroundColor: 'transparent',
                tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' }, backgroundColor: '#1c2128', borderColor: '#30363d', textStyle: { color: '#adbac7' }, formatter: function (params) { let res = '<strong>' + params[0].name + '</strong><br/>'; params.forEach(p => res += p.marker + p.seriesName + ': ' + p.value + '%<br/>'); return res; } },
                grid: { left: '15%', right: '5%', bottom: '2%', top: '2%', containLabel: false },
                xAxis: { show: false },
                yAxis: { type: 'category', data: categories, axisLine: { show: false }, axisTick: { show: false }, axisLabel: { color: '#adbac7', fontSize: 12, margin: 12 } },
                series: [
                    { name: 'å¤šå¤´å æ¯”', type: 'bar', stack: 'total', barWidth: 20, label: { show: true, position: 'inside', formatter: '{c}%', color: '#fff', fontSize: 11, fontWeight: 'bold' }, itemStyle: { color: '#f85149', borderRadius: [4, 0, 0, 4] }, data: longData },
                    { name: 'ç©ºå¤´å æ¯”', type: 'bar', stack: 'total', label: { show: true, position: 'inside', formatter: '{c}%', color: '#fff', fontSize: 11, fontWeight: 'bold' }, itemStyle: { color: '#3fb950', borderRadius: [0, 4, 4, 0] }, data: shortData }
                ]
            });
            charts.varietyPositionDiff = chart;
        }

        function renderMarketIndexTrend(data) {
            const chart = echarts.init(document.getElementById('marketIndexTrend'));

            let qt = null;
            if (data && data.qt) qt = data.qt;
            if (!qt) return;

            const dates = ['æ˜¨æ—¥æ”¶ç›˜', 'ä»Šæ—¥å¼€ç›˜', 'ä»Šæ—¥æœ€ä½', 'ä»Šæ—¥æœ€é«˜', 'å½“å‰ä»·'];
            const indexValues = [qt.qrspj, qt.o, qt.l, qt.h, qt.p].map(v => parseFloat(v));

            chart.setOption({
                tooltip: { trigger: 'axis' },
                xAxis: { type: 'category', data: dates, axisLabel: { color: '#8b949e' } },
                yAxis: { type: 'value', min: 'dataMin', max: 'dataMax', axisLabel: { color: '#8b949e' }, splitLine: { lineStyle: { color: '#30363d' } } },
                series: [{ name: qt.name || 'ç»¼åˆæŒ‡æ•°', type: 'line', data: indexValues, smooth: true, lineStyle: { color: '#58a6ff', width: 3 }, areaStyle: { color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{ offset: 0, color: 'rgba(88, 166, 255, 0.3)' }, { offset: 1, color: 'rgba(88, 166, 255, 0)' }]) }, markLine: { data: [{ type: 'average', name: 'å¹³å‡å€¼' }] } }]
            });
            charts.marketIndexTrend = chart;
        }

        function renderEmotionIndex(data) {
            const emotionValueMini = document.getElementById('emotionValueMini');
            const emotionLabelMini = document.getElementById('emotionLabelMini');

            let value = 50;
            if (data && data.data && data.data.emotion_index) value = parseFloat(data.data.emotion_index);
            else if (data && data.re && data.re.length > 0) value = parseFloat(data.re[0].value) * 100;
            else if (typeof data === 'number') value = data;

            const valStr = value.toFixed(1);

            let label = "ä¸­æ€§";
            let colorClass = "text-secondary";
            if (value >= 80) { label = "æåº¦äº¢å¥‹"; colorClass = "text-up"; }
            else if (value >= 60) { label = "åå‘å¤šå¤´"; colorClass = "text-up"; }
            else if (value <= 20) { label = "æåº¦æ‚²è§‚"; colorClass = "text-down"; }
            else if (value <= 40) { label = "åå‘ç©ºå¤´"; colorClass = "text-down"; }

            if (emotionValueMini) {
                emotionValueMini.textContent = valStr;
                emotionValueMini.className = 'stat-value ' + colorClass;
            }
            if (emotionLabelMini) {
                emotionLabelMini.textContent = label;
                emotionLabelMini.style.color = (value > 50 ? 'var(--color-danger)' : (value < 50 ? 'var(--color-success)' : 'var(--text-secondary)'));
            }
        }

        function renderEmotionTrendChart(data) {
            const container = document.getElementById('emotionTrendChart');
            if (!container) return;
            const chart = echarts.init(container);

            let list = [];
            if (data && data.re) list = data.re;
            else if (Array.isArray(data)) list = data;

            if (list.length === 0) return;

            const xData = list.map(item => {
                const d = new Date(item.time);
                return d.getHours().toString().padStart(2, '0') + ':' + d.getMinutes().toString().padStart(2, '0');
            });
            const yData = list.map(item => (parseFloat(item.value) * 100).toFixed(2));
            const latestValue = yData[yData.length - 1];
            const latestLabel = latestValue >= 60 ? 'åå¤š' : (latestValue <= 40 ? 'åç©º' : 'ä¸­æ€§');

            chart.setOption({
                tooltip: { trigger: 'axis', formatter: '{b} æƒ…ç»ªå€¼: {c}', axisPointer: { type: 'cross', lineStyle: { color: '#30363d' } } },
                grid: { left: '40', right: '40', top: '30', bottom: '30' },
                xAxis: { type: 'category', data: xData, axisLabel: { color: '#8b949e', fontSize: 10 }, axisLine: { lineStyle: { color: '#30363d' } } },
                yAxis: { type: 'value', min: 0, max: 100, splitLine: { lineStyle: { color: '#30363d', type: 'dashed' } }, axisLabel: { color: '#8b949e' } },
                visualMap: { show: false, pieces: [{ gt: 0, lte: 30, color: '#3fb950' }, { gt: 30, lte: 70, color: '#8b949e' }, { gt: 70, lte: 100, color: '#f85149' }] },
                series: [{
                    name: 'æƒ…ç»ªæŒ‡æ•°', type: 'line', data: yData, smooth: true, showSymbol: false, lineStyle: { width: 3, color: '#DAA520' },
                    areaStyle: { color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{ offset: 0, color: 'rgba(218, 165, 32, 0.2)' }, { offset: 1, color: 'rgba(218, 165, 32, 0)' }]) },
                    markLine: {
                        silent: true, symbol: ['none', 'arrow'], symbolSize: 8,
                        data: [{ yAxis: latestValue, label: { position: 'end', formatter: latestValue + ' (' + latestLabel + ')', color: '#f85149', fontWeight: 'bold' }, lineStyle: { type: 'dashed', color: '#f85149', width: 2 } }]
                    }
                }]
            });
            charts.emotionTrend = chart;
        }

        async function updateAnalysisCharts() {
            console.log('Updating analysis charts...');
            try {
                const [dayData, nightData] = await Promise.all([
                    realDataFetcher.getVarietyList(),
                    realDataFetcher.getNightVarietyList()
                ]);

                let combinedMap = new Map();
                
                if (dayData && dayData.list) dayData.list.forEach(item => combinedMap.set(item.dm, {...item, source: 'day'}));
                
                if (nightData && nightData.list) {
                    nightData.list.forEach(item => {
                        const existing = combinedMap.get(item.dm);
                        if (item.p !== '-' || !existing) combinedMap.set(item.dm, {...(existing || {}), ...item, source: 'night'});
                    });
                }

                let combinedList = Array.from(combinedMap.values());
                console.log(`Combined analysis data: ${combinedList.length} items`);

                // å¤œç›˜æ—¶æ®µè¿‡æ»¤ï¼šåªæ˜¾ç¤ºå¤œç›˜å“ç§
                combinedList = filterBySession(combinedList);
                console.log(`After session filtering: ${combinedList.length} items`);

                const validList = combinedList.filter(item => {
                    const price = safeParse(item.p, -1);
                    const base = safeParse(item.zjsj, safeParse(item.qrspj, -1));
                    return base > 0 && (price > 0 || item.zdf !== '-');
                });
                
                console.log(`Valid items for charts: ${validList.length}`);
                
                if (validList.length > 0) {
                    renderChangePositionBubbleChart(validList);
                    renderVarietyTrendChart(validList);
                } else {
                    console.warn('No valid items found after merging day and night data.');
                }
            } catch (err) {
                console.error('Failed to update analysis charts:', err);
            }
        }

        function safeParse(val, defaultVal = 0) {
            if (val === '-' || val === undefined || val === null) return defaultVal;
            const parsed = parseFloat(val);
            return isNaN(parsed) ? defaultVal : parsed;
        }

        function renderChangePositionBubbleChart(list) {
            const container = document.getElementById('bubbleChartAnalysis');
            if (!container) return;

            console.log('Rendering bubble chart with', list.length, 'items');

            if (charts.bubbleAnalysis) charts.bubbleAnalysis.dispose();

            const chart = echarts.init(container);
            const metric = document.querySelector('input[name="bubbleMetric"]:checked')?.value || 'cdzj';

            const processedData = list.filter(item => {
                const ccl = safeParse(item.ccl);
                return ccl > 0;
            }).map(item => {
                const zdf = safeParse(item.zdf);
                const rz = safeParse(item.rz);
                const ccl = safeParse(item.ccl, 1);
                const metricValue = safeParse(item[metric]);
                const rzRatio = ((rz / (ccl - rz || 1)) * 100);
                return [zdf, rzRatio, metricValue, item.name, zdf >= 0 ? (rz >= 0 ? 'å¤šå¤´å¼ºåŠ¿' : 'å¤šå¤´è·åˆ©') : (rz >= 0 ? 'ç©ºå¤´å¼ºåŠ¿' : 'ç©ºå¤´å¹³ä»“'), item];
            });

            if (processedData.length === 0) {
                container.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;color:var(--text-secondary);">æš‚æ— æœ‰æ•ˆæ•°æ®</div>';
                return;
            }

            const option = {
                backgroundColor: 'transparent',
                grid: { left: '80', right: '40', top: '40', bottom: '60' },
                tooltip: {
                    formatter: function (params) {
                        const d = params.data[5];
                        return `<div style="padding:10px;"><strong style="font-size:14px;color:#58a6ff;">${d.name} (${d.dm})</strong><br/>æ¶¨è·Œå¹…: <span style="color:${d.zdf >= 0 ? '#f85149' : '#3fb950'}">${d.zdf}%</span><br/>å¢ä»“æ¯”: ${params.data[1].toFixed(2)}%<br/>æ²‰æ·€èµ„é‡‘: ${(d.cdzj / 100000000).toFixed(2)} äº¿<br/>æˆäº¤é¢: ${(d.cje / 100000000).toFixed(2)} äº¿</div>`;
                    }
                },
                xAxis: { name: 'æ¶¨è·Œå¹… (%)', nameLocation: 'center', nameGap: 30, splitLine: { lineStyle: { color: '#30363d', type: 'dashed' } }, axisLine: { lineStyle: { color: '#8b949e' } }, scale: true, axisLabel: { color: '#8b949e' } },
                yAxis: { name: 'å¢ä»“æ¯” (%)', splitLine: { lineStyle: { color: '#30363d', type: 'dashed' } }, axisLine: { lineStyle: { color: '#8b949e' } }, scale: true, axisLabel: { color: '#8b949e' } },
                series: [{
                    type: 'scatter', data: processedData,
                    itemStyle: {
                        color: function (params) {
                            const x = params.data[0];
                            const y = params.data[1];
                            if (x >= 0) return y >= 0 ? '#f85149' : '#f39c12';
                            return y >= 0 ? '#0073b7' : '#3fb950';
                        }, opacity: 0.7, borderWidth: 1, borderColor: 'rgba(255,255,255,0.2)'
                    },
                    label: { show: true, formatter: '{@[3]}', color: '#fff', fontSize: 10, position: 'inside', textShadowBlur: 2, textShadowColor: '#000' },
                    markLine: { lineStyle: { type: 'solid', color: '#58a6ff', opacity: 0.5 }, data: [{ xAxis: 0 }, { yAxis: 0 }] }
                }]
            };

            const values = processedData.map(d => d[2]);
            const maxVal = Math.max(...values, 1000000);
            option.series[0].symbolSize = function (data) {
                const val = data[2];
                const ratio = Math.sqrt(val / maxVal);
                return ratio * 70 + 12;
            };

            chart.setOption(option);
            charts.bubbleAnalysis = chart;

            chart.on('click', function (params) {
                if (params.data && params.data[5]) {
                    const d = params.data[5];
                    const code = d.dm.toLowerCase().replace(/\d+$/, '');
                    syncVariety(code, { switchTab: false, scrollTo: false });
                }
            });
        }

        function renderVarietyTrendChart(list) {
            const container = document.getElementById('trendComparisonChart');
            if (!container) return;

            if (charts.trendComparison) charts.trendComparison.dispose();

            const chart = echarts.init(container);

            const sorted = [...list]
                .filter(item => item.o !== '-' && item.h !== '-' && item.l !== '-')
                .sort((a, b) => safeParse(b.zdf) - safeParse(a.zdf))
                .slice(0, 50);

            if (sorted.length === 0) {
                container.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;color:var(--text-secondary);">æš‚æ— æœ‰æ•ˆæ•°æ®</div>';
                return;
            }

            const xData = sorted.map(item => item.name);
            const yData = sorted.map(item => {
                const base = safeParse(item.zjsj, 1);
                return [
                    ((safeParse(item.o) - base) / base * 100).toFixed(2),
                    ((safeParse(item.p) - base) / base * 100).toFixed(2),
                    ((safeParse(item.l) - base) / base * 100).toFixed(2),
                    ((safeParse(item.h) - base) / base * 100).toFixed(2)
                ];
            });

            chart.setOption({
                backgroundColor: 'transparent',
                tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' }, formatter: function (params) { const p = params[0]; const d = sorted[p.dataIndex]; return `<div style="padding:10px;"><strong>${d.name} ç›¸å¯¹èµ°åŠ¿</strong><br/>å¼€ç›˜: ${p.data[0]}%<br/>æ”¶ç›˜: ${p.data[1]}%<br/>æœ€é«˜: ${p.data[3]}%<br/>æœ€ä½: ${p.data[2]}%</div>`; } },
                grid: { left: '80', right: '30', top: '40', bottom: '80' },
                xAxis: { type: 'category', data: xData, axisLabel: { color: '#8b949e', rotate: 45, fontSize: 10 }, axisLine: { lineStyle: { color: '#30363d' } } },
                yAxis: { type: 'value', name: 'ç›¸å¯¹æ¶¨è·Œå¹… (%)', splitLine: { lineStyle: { color: '#30363d', type: 'dashed' } }, axisLabel: { color: '#8b949e' } },
                dataZoom: [{ type: 'inside', start: 0, end: 100 }, { type: 'slider', height: 20, bottom: 10 }],
                series: [{
                    type: 'candlestick', data: yData,
                    itemStyle: { color: '#f85149', color0: '#3fb950', borderColor: '#f85149', borderColor0: '#3fb950' },
                    markPoint: { data: [{ type: 'max', name: 'æœ€å¤§æ¶¨å¹…', itemStyle: { color: '#f85149' } }, { type: 'min', name: 'æœ€å¤§è·Œå¹…', itemStyle: { color: '#3fb950' } }], label: { formatter: '{c}%', fontSize: 10 } }
                }]
            });
            charts.trendComparison = chart;

            chart.on('click', function (params) {
                const d = sorted[params.dataIndex];
                if (d) {
                    const code = d.dm.toLowerCase().replace(/\d+$/, '');
                    syncVariety(code, { switchTab: false, scrollTo: false });
                }
            });
        }

        window.addEventListener('resize', function () {
            Object.values(charts).forEach(chart => chart && chart.resize());
        });

        window.onload = function () {
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            const dateInput = document.getElementById('dragonDate');
            if (dateInput) dateInput.value = dateStr;

            loadAllData().then(() => {
                const params = new URLSearchParams(window.location.search);
                const varietyParam = params.get('variety');
                if (varietyParam) {
                    console.log('Handling initial variety parameter:', varietyParam);
                    setTimeout(() => {
                        syncVariety(varietyParam, { switchTab: false, scrollTo: true, targetId: 'variety-analysis-section' });
                    }, 800);
                }
            });
        };
    </script>
</body>

</html>