<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœŸè´§æŠ•èµ„ç»¼åˆDashboardï¼ˆçœŸå®æ•°æ®ï¼‰</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.1/dist/echarts.min.js"></script>
    <script src="real_data_fetcher.js?v=20260203"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --bg-card: #1c2128;
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --color-primary: #58a6ff;
            --color-success: #3fb950;
            --color-warning: #d29922;
            --color-danger: #f85149;
            --chart-up: #f85149;
            --chart-down: #3fb950;
            --border-color: #30363d;
            --radius-md: 8px;
            --radius-lg: 12px;
            --transition-normal: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background-color: rgba(22, 27, 34, 0.8);
            backdrop-filter: blur(10px);
            padding: 12px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-info {
            display: flex;
            align-items: center;
            font-size: 13px;
            color: var(--text-secondary);
            background: var(--bg-secondary);
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-active {
            background-color: var(--color-success);
            box-shadow: 0 0 8px var(--color-success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }

        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .card:hover {
            border-color: var(--color-primary);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .grid-6 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        @media (min-width: 768px) { .grid-6 { grid-template-columns: repeat(3, 1fr); } }
        @media (min-width: 1200px) { .grid-6 { grid-template-columns: repeat(6, 1fr); } }

        .stat-card {
            background-color: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: 12px;
            text-align: center;
            border: 1px solid transparent;
            transition: all 0.3s;
        }

        .stat-card:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-color);
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        /* å¢ä»“ç®­å¤´ */
        .change-arrow {
            width: 0; height: 0;
            display: inline-block;
            margin-right: 6px;
        }
        .change-arrow.up { border-left: 5px solid transparent; border-right: 5px solid transparent; border-bottom: 8px solid var(--color-danger); }
        .change-arrow.down { border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 8px solid var(--color-success); }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 992px) {
            .grid-2 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .chart-container {
            height: 350px;
            width: 100%;
            margin-top: 10px;
        }

        .text-up { color: var(--color-danger) !important; font-weight: 600; }
        .text-down { color: var(--color-success) !important; font-weight: 600; }

        .stat-up { color: var(--color-danger); }
        .stat-down { color: var(--color-success); }

        .loading {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(13, 17, 23, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .badge-success { background: rgba(63, 185, 80, 0.15); color: #3fb950; border: 1px solid rgba(63, 185, 80, 0.3); }
        .badge-warning { background: rgba(210, 153, 34, 0.15); color: #d29922; border: 1px solid rgba(210, 153, 34, 0.3); }

        .header-nav { display: flex; gap: 4px; }
        .header-nav a {
            padding: 8px 16px;
            border-radius: 6px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 14px;
            transition: all 0.2s;
        }
        .header-nav a:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .header-nav a.active { background: var(--color-primary); color: white; }

        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .table th {
            text-align: left;
            padding: 12px 10px;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
            font-weight: 500;
        }
        .table td {
            padding: 12px 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .variety-list::-webkit-scrollbar, .table-container::-webkit-scrollbar {
            width: 4px;
        }
        .variety-list::-webkit-scrollbar-thumb, .table-container::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 2px;
        }

        /* å¸ƒå±€å¢å¼º */
        .market-main-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }
        @media (min-width: 1200px) {
            .market-main-grid {
                grid-template-columns: 2fr 1fr;
            }
        }
        .heatmaps-stack {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .variety-list {
            max-height: 850px;
            overflow-y: auto;
            padding-right: 4px;
        }

        /* ä¼˜åŒ–å“ç§è¡Œ */
        .variety-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            margin-bottom: 4px;
            background: var(--bg-secondary);
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .table-dragon-tiger th {
            font-size: 12px;
            padding: 8px 4px;
        }
        .table-dragon-tiger td {
            font-size: 12px;
            padding: 10px 4px;
        }
        .table-dragon-tiger tr:nth-child(even) {
            background: rgba(139, 148, 158, 0.03);
        }
        .change-up { color: #f85149; }
        .change-down { color: #3fb950; }
        .variety-row:hover { 
            background-color: var(--bg-secondary);
            cursor: pointer;
            border-color: var(--color-primary);
        }
        .v-info { display: flex; align-items: center; gap: 8px; flex: 1; }
        .v-name { font-weight: 600; min-width: 65px; white-space: nowrap; }
        .v-change { width: 70px; text-align: right; }
        .v-oi { width: 90px; text-align: right; color: var(--text-secondary); font-size: 11px; }
        .mini-progress { width: 40px; height: 3px; background: var(--border-color); border-radius: 2px; overflow: hidden; }
        .mini-fill { height: 100%; transition: width 0.3s; }
    </style>
</head>
<body>
    <header class="header">
        <h1>ğŸ“Š Futures Insights</h1>
        <div style="display: flex; align-items: center; gap: 20px;">
            <div class="status-info" id="trading-status">
                <span class="status-indicator"></span>
                <span id="status-text">æ•°æ®æ›´æ–°ä¸­...</span>
            </div>
            <nav class="header-nav">
            <nav class="header-nav">
                <a href="#" class="active" onclick="switchTab('realtime', event)">å®æ—¶è¡Œæƒ…</a>
                <a href="#" onclick="switchTab('news', event)">èµ„è®¯ä¸­å¿ƒ</a>
                <a href="#" onclick="switchTab('dragon', event)">é¾™è™åŠ¨æ€</a>
                <a href="#" onclick="switchTab('analysis', event)">è¿›é˜¶åˆ†æ</a>
            </nav>
            </nav>
        </div>
    </header>

    <div class="container">
        <!-- åŠ è½½çŠ¶æ€ -->
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p>æ­£åœ¨åŠ è½½çœŸå®æ•°æ®...</p>
        </div>

        <!-- å®æ—¶è¡Œæƒ…Tab -->
        <div id="tab-realtime" class="tab-content active">
            <!-- å¸‚åœºå…³é”®æ¦‚è§ˆ -->
            <div class="grid-6" style="margin-bottom: 24px;">
                <div class="card stat-card">
                    <div class="stat-label">ä¸Šæ¶¨å“ç§</div>
                    <div class="stat-value text-up" id="upCount">-</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-label">ä¸‹è·Œå“ç§</div>
                    <div class="stat-value text-down" id="downCount">-</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-label">å¹³å‡æ¶¨è·Œ</div>
                    <div id="marketAvgChange" class="stat-value">-%</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-label">å¹³å‡åŸºå·®</div>
                    <div class="stat-value text-primary" id="basisValue">-</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-label">åˆçº¦æ€»æ•°</div>
                    <div class="stat-value" id="totalCount">-</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-label">å¸‚åœºæƒ…ç»ª</div>
                    <div class="stat-value" id="emotionValueMini">-</div>
                    <div id="emotionLabelMini" style="font-size: 11px; opacity: 0.8;">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <!-- æ ¸å¿ƒæŒ‡æ•°ä¸æƒ…ç»ª (å¹¶åˆ—æ˜¾ç¤º) -->
            <div class="grid-2" style="margin-bottom: 24px;">
                <!-- å¸‚åœºç»¼åˆæŒ‡æ•°è¶‹åŠ¿ -->
                <div class="card" style="margin-bottom: 0;">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-chart-line"></i> å¸‚åœºç»¼åˆæŒ‡æ•°è¶‹åŠ¿</h2>
                        <button class="btn btn-sm" onclick="loadAllData()">åˆ·æ–°</button>
                    </div>
                    <div id="marketIndexTrend" style="height: 300px; width: 100%;"></div>
                </div>
                
                <!-- æŠ•èµ„è€…æƒ…ç»ªè¶‹åŠ¿å›¾ -->
                <div class="card" style="margin-bottom: 0;">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-heartbeat"></i> æŠ•èµ„è€…å¤šç©ºæƒ…ç»ªè§‚å¯Ÿ (å®æ—¶æ³¢åŠ¨)</h2>
                        <div id="emotionUpdateInfo" style="font-size: 12px; color: var(--text-secondary);">æ›´æ–°äº: --:--</div>
                    </div>
                    <div id="emotionTrendChart" style="height: 300px; width: 100%;"></div>
                </div>
            </div>

            <div class="market-main-grid">
                <!-- å·¦ä¾§çƒ­åŠ›å›¾å †å  -->
                <div class="heatmaps-stack">
                    <!-- è¡Œä¸šçƒ­åŠ›å›¾ -->
                    <div class="card" style="margin-bottom: 0;">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-layer-group"></i> è¡Œä¸šèµ„é‡‘çƒ­å›¾</h2>
                            <span class="badge badge-success">å®æ—¶</span>
                        </div>
                        <div id="industryHeatmap" class="chart-container"></div>
                    </div>
                    <!-- å“ç§çƒ­åŠ›å›¾ -->
                    <div class="card" style="margin-bottom: 0;">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-fire"></i> å“ç§èµ„é‡‘æµå‘</h2>
                            <span class="badge badge-success">å®æ—¶</span>
                        </div>
                        <div id="varietyHeatmap" class="chart-container"></div>
                    </div>
                </div>

                <!-- å³ä¾§å“ç§è¡Œæƒ…åˆ—è¡¨ -->
                <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column;">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-list-ul"></i> è¡Œæƒ…å¼‚åŠ¨ (å¢ä»“ç‡)</h2>
                        <div style="display: flex; gap: 4px;">
                            <button id="toggleVarietyListBtn" class="btn btn-sm" onclick="toggleVarietyDisplay()">å…¨éƒ¨</button>
                            <button class="btn btn-sm" onclick="loadAllData()"><i class="fas fa-sync-alt"></i></button>
                        </div>
                    </div>
                    <div id="varietyList" class="variety-list">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- äºŒçº§æ•°æ®è¡Œï¼šä¸»åŠ›åˆçº¦ ä¸ å“ç§å¯¹æ¯” -->
            <div class="grid-2">
                <div class="card" style="margin-bottom: 0;">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-crown"></i> æ´»è·ƒä¸»åŠ›åˆçº¦ (æˆäº¤é‡Top)</h2>
                        <button class="btn btn-sm" onclick="loadMainContracts()">åˆ·æ–°</button>
                    </div>
                    <div class="table-container" style="max-height: 550px; overflow-y: auto;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ä»£ç </th>
                                    <th>åç§°</th>
                                    <th>ä»·æ ¼</th>
                                    <th>æ¶¨è·Œ</th>
                                </tr>
                            </thead>
                            <tbody id="mainContractsTable">
                                <tr><td colspan="4" style="text-align: center; color: var(--text-secondary); padding: 40px;">æ•°æ®åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card" style="margin-bottom: 0;">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-balance-scale"></i> ä¸»åŠ›å¤šç©ºåŠ›é‡å¯¹æ¯” (TOP 15)</h2>
                    </div>
                    <div id="varietyPositionDiffChart" class="chart-container" style="height: 550px; padding: 10px;"></div>
                </div>
            </div>

            <!-- åŸæœ‰çš„å“ç§æ·±åº¦åˆ†æ -->
            <div class="card" id="variety-analysis-section" style="margin-top: 20px;">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-chart-line"></i> å“ç§æ·±åº¦ç»“æ„åˆ†æ</h2>
                    <div style="display: flex; gap: 12px;">
                        <select id="variety-select-analysis" class="select-variety" onchange="handleVarietyAnalysisChange()">
                            <option value="">é€‰æ‹©å“ç§è¿›è¡Œæ·±åº¦åˆ†æ...</option>
                        </select>
                        <button class="btn btn-sm" onclick="fetchVarietyAnalysis()">åˆ†æ</button>
                    </div>
                </div>
                <div class="grid-2">
                    <div id="premiumStructureChart" class="chart-container"></div>
                    <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>åˆçº¦</th>
                                    <th>æœ€æ–°</th>
                                    <th>æ¶¨å¹…</th>
                                    <th>æˆäº¤</th>
                                    <th>æŒä»“</th>
                                </tr>
                            </thead>
                            <tbody id="varietyContractsBody">
                                <tr><td colspan="4" style="text-align: center; color: var(--text-secondary); padding: 40px;">è¯·é€‰æ‹©å“ç§æŸ¥çœ‹åˆçº¦ç»“æ„</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- èµ„è®¯ä¸­å¿ƒ -->
            <div id="tab-news" class="tab-content">
                <div class="grid-2">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="far fa-newspaper"></i> åŒèŠ±é¡ºæ–°é—»</h2>
                            <button class="btn btn-sm" onclick="loadNews()">åˆ·æ–°</button>
                        </div>
                        <div id="thsNewsList" class="news-list" style="max-height: 500px; overflow-y: auto;"></div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="far fa-newspaper"></i> åå°”è¡—è§é—»</h2>
                            <button class="btn btn-sm" onclick="loadNews()">åˆ·æ–°</button>
                        </div>
                        <div id="wallStreetNewsList" class="news-list" style="max-height: 500px; overflow-y: auto;"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="far fa-newspaper"></i> ä¸œæ–¹è´¢å¯Œèµ„è®¯ (æš‚æ—¶ä¸å¯ç”¨)</h2>
                        <button class="btn btn-sm" onclick="loadNews()">åˆ·æ–°</button>
                    </div>
                    <div id="emNewsList" class="news-list" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
            </div>

        <!-- è¿›é˜¶åˆ†æTab -->
        <div id="tab-analysis" class="tab-content">
            <div class="grid-2">
                <!-- æ¶¨è·Œå¹…ä¸å¢ä»“æ¯”å…³ç³»å›¾ -->
                <div class="card" style="grid-column: span 2;">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-chart-scatter"></i> æ¶¨è·Œå¹…ä¸å¢ä»“æ¯”å…³ç³»å›¾</h2>
                        <div style="display: flex; gap: 12px; align-items: center; font-size: 13px;">
                            <span style="color: var(--text-secondary);">æ°”æ³¡å¤§å°ä»£è¡¨:</span>
                            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                                <input type="radio" name="bubbleMetric" value="cdzj" checked onchange="updateAnalysisCharts()"> èµ„é‡‘
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                                <input type="radio" name="bubbleMetric" value="cje" onchange="updateAnalysisCharts()"> æˆäº¤é¢
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                                <input type="radio" name="bubbleMetric" value="vol" onchange="updateAnalysisCharts()"> æˆäº¤é‡
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                                <input type="radio" name="bubbleMetric" value="ccl" onchange="updateAnalysisCharts()"> æŒä»“é‡
                            </label>
                        </div>
                    </div>
                    <div id="bubbleChartAnalysis" style="height: 500px; width: 100%;"></div>
                </div>

                <!-- å“ç§èµ°åŠ¿å¯¹æ¯” (ç›¸å¯¹Kçº¿) -->
                <div class="card" style="grid-column: span 2;">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-align-left"></i> å…¨å“ç§ç›¸å¯¹å¼ºå¼±èµ°åŠ¿å¯¹æ¯”</h2>
                    </div>
                    <div id="trendComparisonChart" style="height: 550px; width: 100%;"></div>
                </div>
            </div>
        </div>

        <!-- é¾™è™æ¦œTab -->
        <div id="tab-dragon" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-dragon"></i> æœºæ„é¾™è™æ¦œåŠ¨æ€</h2>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <input type="date" id="dragonDate" class="btn btn-sm" style="background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); height: 32px; padding: 0 8px;">
                        <select id="dragon-variety-select" class="select-variety" style="width: 150px; height: 32px; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px;" onchange="loadDragonTiger()">
                            <option value="113_cu">æ²ªé“œ (cu)</option>
                        </select>
                        <button class="btn btn-sm" onclick="loadDragonTiger()"><i class="fas fa-search"></i> æŸ¥è¯¢</button>
                    </div>
                </div>
                <div style="margin-bottom: 12px; font-weight: 500; font-size: 14px; color: var(--text-secondary); border-left: 3px solid var(--color-primary); padding-left: 10px;">
                    é€‰ä¸­å“ç§æŒä»“æ¦œå•: <span id="currentVarietyName" style="color: var(--text-primary);">åŠ è½½ä¸­...</span>
                </div>
                <div class="table-container">
                    <table class="table table-dragon-tiger">
                        <thead>
                            <tr>
                                <th style="width: 40px;">æ’å</th>
                                <th colspan="3" style="text-align: center; color: #f85149; background: rgba(248, 81, 73, 0.05);">å¤šå¤´æŒä»“</th>
                                <th colspan="3" style="text-align: center; color: #3fb950; background: rgba(63, 185, 80, 0.05);">ç©ºå¤´æŒä»“</th>
                            </tr>
                            <tr>
                                <th>#</th>
                                <th>å¸­ä½åç§°</th>
                                <th>æŒä»“é‡</th>
                                <th>å¢å‡</th>
                                <th>å¸­ä½åç§°</th>
                                <th>æŒä»“é‡</th>
                                <th>å¢å‡</th>
                            </tr>
                        </thead>
                        <tbody id="dragonTigerTable">
                            <tr><td colspan="7" style="text-align:center">æ•°æ®åŠ è½½ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        </div>

    </div>

    <script>
        // å…¨å±€å˜é‡
        let charts = {};
        let currentDate = new Date();
        let showAllVarieties = false;
        let lastRawVarietyList = [];
        
        // æ ¼å¼åŒ–æ—¥æœŸä¸ºYYYYMMDD
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }

        // Tabåˆ‡æ¢
        function switchTab(tabId, event) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.header-nav a').forEach(link => {
                link.classList.remove('active');
            });
            
            const targetTab = document.getElementById('tab-' + tabId);
            if (targetTab) targetTab.classList.add('active');
            
            if (tabId === 'analysis') {
                updateAnalysisCharts();
            }

            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            } else {
                // å¦‚æœæ²¡ä¼ eventï¼Œå°è¯•æ ¹æ®tabIdæ‰‹åŠ¨é«˜äº®
                document.querySelectorAll('.header-nav a').forEach(link => {
                    if (link.getAttribute('onclick')?.includes(tabId)) {
                        link.classList.add('active');
                    }
                });
            }
            
            // åˆ‡æ¢Tabåé‡ç»˜æ‰€æœ‰å›¾è¡¨ä»¥é˜²å®¹å™¨å¤§å°å˜åŠ¨
            setTimeout(() => {
                Object.values(charts).forEach(chart => chart && chart.resize());
            }, 100);
        }

        // å¸¸é‡å®šä¹‰
        const DIRECT_VARIETY_MAP = {
            'cu': '113_cu', 'al': '113_al', 'zn': '113_zn', 'pb': '113_pb', 'ni': '113_ni', 
            'sn': '113_sn', 'au': '113_au', 'ag': '113_ag', 'rb': '113_rb', 'wr': '113_wr', 
            'hc': '113_hc', 'ss': '113_ss', 'bu': '113_bu', 'ru': '113_ru', 'sp': '113_sp',
            'fu': '113_fu','ad': '113_ad','ao': '113_ao', 'br': '113_br',
            'c': '114_c', 'cs': '114_cs', 'a': '114_a', 'b': '114_b', 'm': '114_m', 
            'y': '114_y', 'p': '114_p', 'jd': '114_jd', 'rr': '114_rr', 'l': '114_l', 
            'v': '114_v', 'pp': '114_pp', 'j': '114_j', 'jm': '114_jm', 'i': '114_i', 
            'eg': '114_eg', 'eb': '114_eb', 'pg': '114_pg', 'lh': '114_lh',
            'oi': '115_oi', 'rm': '115_rm', 'cf': '115_cf', 'sr': '115_sr', 'ta': '115_ta', 
            'ma': '115_ma', 'fg': '115_fg', 'ap': '115_ap', 'ur': '115_ur', 'sa': '115_sa'
        };

        // åŠ è½½å¹¶æ›´æ–°äº¤æ˜“çŠ¶æ€
        function updateTradingStatus() {
            const now = new Date();
            const hour = now.getHours();
            const min = now.getMinutes();
            const day = now.getDay();
            
            let isActive = false;
            let statusText = "éäº¤æ˜“æ—¶æ®µ";
            
            if (day >= 1 && day <= 5) { // å‘¨ä¸€åˆ°å‘¨äº”
                // æ—¥ç›˜: 9:00-10:15, 10:30-11:30, 13:30-15:00
                if ((hour === 9) || (hour === 10 && min <= 15) || (hour === 10 && min >= 30) || (hour === 11 && min <= 30) || (hour >= 13 && hour < 15)) {
                    isActive = true;
                    statusText = "æ—¥ç›˜äº¤æ˜“ä¸­";
                } 
                // å¤œç›˜: 21:00-02:30 (ä¸åŒå“ç§ç»“æŸæ—¶é—´ä¸åŒï¼Œç»Ÿä¸€åˆ°02:30)
                else if (hour >= 21 || hour < 3) {
                    isActive = true;
                    statusText = "å¤œç›˜äº¤æ˜“ä¸­";
                }
            }
            
            const indicator = document.querySelector('.status-indicator');
            const statusTextEl = document.getElementById('status-text');
            if (indicator && statusTextEl) {
                indicator.className = `status-indicator ${isActive ? 'status-active' : ''}`;
                statusTextEl.textContent = `å¸‚åœºçŠ¶æ€: ${statusText} (${now.toLocaleTimeString()})`;
            }
        }

        // åŠ è½½æ‰€æœ‰æ•°æ®
        async function loadAllData() {
            try {
                updateTradingStatus();
                
                const safeExecute = async (name, fn) => {
                    try {
                        await fn();
                    } catch (e) {
                        console.error(`Failed to load ${name}:`, e);
                    }
                };

                // å¹¶è¡ŒåŠ è½½éä¾èµ–é¡¹
                await Promise.all([
                    safeExecute('Industry Heatmap', async () => {
                        const data = await realDataFetcher.getIndustryHeatmap();
                        if (data) renderIndustryHeatmap(data);
                    }),
                    safeExecute('Variety Heatmap', async () => {
                        const data = await realDataFetcher.getVarietyHeatmap();
                        if (data) renderVarietyHeatmap(data);
                    }),
                    safeExecute('Main Contracts', loadMainContracts),
                    safeExecute('Market Data', async () => {
                        const marketData = await realDataFetcher.getMarketOverview();
                        const upDownData = await realDataFetcher.getMarketUpDown();
                        if (marketData && marketData.list) {
                            renderVarietyList(marketData.list);
                            populateVarietySelect(marketData.list, 'variety-select-analysis');
                            populateVarietySelect(marketData.list, 'dragon-variety-select');
                        }
                        if (upDownData && upDownData.result) {
                            renderMarketUpDown(upDownData, marketData.list);
                        }
                    }),
                    safeExecute('Basis', async () => {
                        const basisData = await realDataFetcher.getBasis();
                        if (basisData) renderBasis(basisData);
                    }),
                    safeExecute('Index Trend', async () => {
                        const indexTrend = await realDataFetcher.getMarketIndexTrend();
                        if (indexTrend) renderMarketIndexTrend(indexTrend);
                    }),
                    safeExecute('Emotion', async () => {
                        const [emotion, history] = await Promise.all([
                            realDataFetcher.getEmotionIndex(),
                            realDataFetcher.getEmotionHistory()
                        ]);
                        if (emotion) renderEmotionIndex(emotion);
                        if (history) renderEmotionTrendChart(history);
                    })
                ]);

                // èµ„è®¯å’Œé¾™è™æ¦œ
                await safeExecute('News & Dragon Tiger', async () => {
                    await Promise.all([loadNews(), loadDragonTiger()]);
                });

                // é¢„åŠ è½½ä¸€ä¸ªå“ç§çš„æ·±åº¦åˆ†æ (é»˜è®¤é“œ cu)
                setTimeout(() => {
                    const defaultVariety = '113_cu';
                    const analysisSelect = document.getElementById('variety-select-analysis');
                    if (analysisSelect && (!analysisSelect.value || analysisSelect.value === "")) {
                        analysisSelect.value = defaultVariety;
                        fetchVarietyAnalysis(defaultVariety);
                    }
                }, 500);

            } catch (error) {
                console.error('åŠ è½½ç³»ç»Ÿå‘ç”Ÿä¸¥é‡é”™è¯¯:', error);
            } finally {
                // ç¡®ä¿æ— è®ºå¦‚ä½•éƒ½éšè—åŠ è½½çŠ¶æ€
                const loading = document.getElementById('loading');
                if (loading) loading.style.display = 'none';
            }
        }

        function populateVarietySelect(list, selectId = 'variety-select-analysis') {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            // é˜²æ­¢é‡å¤å¡«å……
            if (select.options.length > 1) return;

            const sortedList = [...list].sort((a,b) => a.name.localeCompare(b.name, 'zh-Hans-CN'));
            sortedList.forEach(item => {
                const code = item.uid.split('|')[1]?.toLowerCase();
                const msgid = DIRECT_VARIETY_MAP[code];
                if (msgid) {
                    const opt = document.createElement('option');
                    opt.value = msgid;
                    opt.textContent = `${item.name} (${code.toUpperCase()})`;
                    select.appendChild(opt);
                }
            });
        }

        async function handleVarietyAnalysisChange() {
            const varietyId = document.getElementById('variety-select-analysis').value;
            if (!varietyId) return;
            await fetchVarietyAnalysis(varietyId);
        }

        async function fetchVarietyAnalysis(varietyId) {
            const container = document.getElementById('varietyContractsBody');
            container.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px;">æ•°æ®è§£æä¸­...</td></tr>';
            
            try {
                // 1. è·å–åˆçº¦åˆ—è¡¨
                const redisData = await realDataFetcher.getVarietyContracts(varietyId);
                if (!redisData || !Array.isArray(redisData)) throw new Error("æ— æ³•è¯»å–åˆçº¦åˆ—è¡¨");
                
                const codes = redisData
                    .filter(i => i.code && /\d/.test(i.code))
                    .map(i => `${i.mktid}_${i.code}`);
                
                if (codes.length === 0) throw new Error("æœªæ‰¾åˆ°æœ‰æ•ˆåˆçº¦");

                // 2. è·å–ä»·æ ¼è¯¦æƒ…
                const pricesData = await realDataFetcher.getContractPrices(codes.slice(0, 20).join(','));
                if (!pricesData || !pricesData.list) throw new Error("ä»·æ ¼è§£æå¤±è´¥");
                
                const contracts = pricesData.list.map(item => ({
                    code: item.name,
                    price: parseFloat(item.p) || 0,
                    change: parseFloat(item.zdf) || 0,
                    volume: parseInt(item.cj) || 0,
                    position: parseInt(item.ccl) || 0
                })).sort((a,b) => {
                    const monthA = a.code.match(/\d+/) ? parseInt(a.code.match(/\d+/)[0]) : 0;
                    const monthB = b.code.match(/\d+/) ? parseInt(b.code.match(/\d+/)[0]) : 0;
                    return monthA - monthB;
                });

                renderVarietyContractsTable(contracts);
                renderVarietyStructureChart(contracts);
            } catch (e) {
                container.innerHTML = `<tr><td colspan="4" style="text-align: center; color: var(--color-danger); padding: 40px;">åˆ†æå¤±è´¥: ${e.message}</td></tr>`;
            }
        }

        function renderVarietyContractsTable(contracts) {
            const tbody = document.getElementById('varietyContractsBody');
            tbody.innerHTML = contracts.map(c => `
                <tr>
                    <td><strong>${c.code}</strong></td>
                    <td>${c.price}</td>
                    <td class="${c.change >= 0 ? 'text-up' : 'text-down'}">${c.change >= 0 ? '+' : ''}${c.change.toFixed(2)}%</td>
                    <td>${(c.volume / 10000).toFixed(1)}w</td>
                    <td>${(c.position / 10000).toFixed(1)}w</td>
                </tr>
            `).join('');
        }

        function renderVarietyStructureChart(contracts) {
            const chartDom = document.getElementById('premiumStructureChart');
            if (!chartDom) return;
            const chart = echarts.init(chartDom);
            
            const xData = contracts.map(c => c.code.match(/\d+/)?.[0] || c.code);
            const priceData = contracts.map(c => c.price);
            const volData = contracts.map(c => c.volume);
            const posData = contracts.map(c => c.position);

            const option = {
                title: { text: 'æœˆé—´åˆçº¦å¯¹æ¯” (æœŸé™ç»“æ„)', textStyle: { color: '#8b949e', fontSize: 13 }, left: 'center', top: 5 },
                tooltip: { 
                    trigger: 'axis',
                    axisPointer: { type: 'cross' }
                },
                legend: { data: ['ä»·æ ¼', 'æˆäº¤é‡', 'æŒä»“é‡'], bottom: 0, textStyle: { color: '#8b949e' } },
                grid: { left: '3%', right: '8%', bottom: '15%', top: '15%', containLabel: true },
                xAxis: { type: 'category', data: xData, axisLabel: { color: '#8b949e' } },
                yAxis: [
                    { 
                        type: 'value', 
                        name: 'ä»·æ ¼', 
                        position: 'left',
                        scale: true,
                        nameTextStyle: { color: '#58a6ff' }, 
                        axisLabel: { color: '#58a6ff' }, 
                        splitLine: { lineStyle: { color: '#30363d' } } 
                    },
                    { 
                        type: 'value', 
                        name: 'æˆäº¤/æŒä»“', 
                        position: 'right',
                        nameTextStyle: { color: '#8b949e' }, 
                        axisLabel: { color: '#8b949e' }, 
                        splitLine: { show: false } 
                    }
                ],
                dataZoom: [{ type: 'inside', start: 0, end: 100 }, { type: 'slider', height: 20, bottom: 25 }],
                series: [
                    {
                        name: 'ä»·æ ¼', type: 'line', smooth: true, symbol: 'circle', symbolSize: 8,
                        lineStyle: { color: '#58a6ff', width: 3 },
                        itemStyle: { color: '#58a6ff' },
                        data: priceData
                    },
                    {
                        name: 'æˆäº¤é‡', type: 'bar', yAxisIndex: 1,
                        itemStyle: { color: '#3fb950', opacity: 0.7 },
                        data: volData
                    },
                    {
                        name: 'æŒä»“é‡', type: 'bar', yAxisIndex: 1,
                        itemStyle: { color: '#d29922', opacity: 0.7 },
                        data: posData
                    }
                ]
            };
            chart.setOption(option, true);
            charts.premiumStructure = chart;
            setTimeout(() => chart.resize(), 100);
        }

        // æ¸²æŸ“è¡Œä¸šçƒ­åŠ›å›¾ (Treemap)
        function renderIndustryHeatmap(data) {
            const chart = echarts.init(document.getElementById('industryHeatmap'));
            
            // å¤„ç†APIæ•°æ®
            // APIè¿”å›æ ¼å¼: { msg: "...", result: { list: [ { name, cdzj, zdf, ... } ] } }
            // å¦‚æœfetcherå·²ç»è¿”å›äº†jsonï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®ç»“æ„å–æ•°æ®
            // realDataFetcher.getIndustryHeatmap() ç›´æ¥è¿”å› response.json()
            
            let list = [];
            if (data && data.result && data.result.list) {
                list = data.result.list;
            } else if (data && data.list) {
                list = data.list;
            } else if (Array.isArray(data)) {
                list = data;
            }

            if (list.length === 0) {
                console.warn('Industry heatmap data is empty');
                document.getElementById('industryHeatmap').innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;color:var(--text-secondary);">çƒ­åŠ›å›¾æ•°æ®åŠ è½½ä¸­...</div>';
                return;
            }

            const treemapData = list.filter(item => {
                const amount = parseFloat(item.cdzj);
                const change = parseFloat(item.zdf);
                return !isNaN(amount) && !isNaN(change) && amount > 0;
            }).map(item => {
                const amount = parseFloat(item.cdzj);
                const change = parseFloat(item.zdf);
                return {
                    name: item.name.replace(/(æ¿å—|äº§ä¸š)/, ''), 
                    value: [amount, change],
                    itemStyle: {
                        color: change >= 0 ? '#f85149' : '#3fb950'
                    }
                };
            });

            if (treemapData.length === 0) {
                console.warn('No valid data for Industry heatmap');
                document.getElementById('industryHeatmap').innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;color:var(--text-secondary);">æš‚æ— æœ‰æ•ˆè¡Œä¸šèµ„é‡‘æ•°æ®</div>';
                return;
            }

            const option = {
                tooltip: {
                    formatter: function (info) {
                        var value = info.value;
                        var amount = value[0];
                        var change = value[1];
                        return [
                            '<div style="font-size:14px;font-weight:bold">' + echarts.format.encodeHTML(info.name) + '</div>',
                            'æ²‰æ·€èµ„é‡‘: ' + (amount / 100000000).toFixed(2) + 'äº¿',
                            'æ¶¨è·Œå¹…: ' + change.toFixed(2) + '%'
                        ].join('<br>');
                    }
                },
                series: [{
                    type: 'treemap',
                    width: '100%',
                    height: '100%',
                    roam: false,
                    nodeClick: false,
                    breadcrumb: { show: false },
                    label: {
                        show: true,
                        formatter: '{b}\n{@[1]}%',
                        fontSize: 14
                    },
                    itemStyle: {
                        borderColor: '#1c2128',
                        borderWidth: 2
                    },
                    data: treemapData
                }]
            };

            chart.setOption(option);
            charts.industryHeatmap = chart;
        }

        // æ¸²æŸ“å“ç§çƒ­åŠ›å›¾ (Treemap)
        function renderVarietyHeatmap(data) {
            const chart = echarts.init(document.getElementById('varietyHeatmap'));
            
            let list = [];
            if (data && data.result && data.result.list) {
                list = data.result.list;
            } else if (data && data.list) {
                list = data.list;
            } else if (Array.isArray(data)) {
                list = data;
            }

            if (list.length === 0) {
                console.warn('Variety heatmap data is empty');
                document.getElementById('varietyHeatmap').innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;color:var(--text-secondary);">çƒ­åŠ›å›¾æ•°æ®åŠ è½½ä¸­...</div>';
                return;
            }

            const treemapData = list.filter(item => {
                const amount = parseFloat(item.cdzj);
                const change = parseFloat(item.zdf);
                return !isNaN(amount) && !isNaN(change) && amount > 0;
            }).map(item => {
                const amount = parseFloat(item.cdzj);
                const change = parseFloat(item.zdf);
                return {
                    name: item.name.replace('åŠ æƒ', ''), 
                    value: [amount, change],
                    itemStyle: {
                        color: change >= 0 ? '#f85149' : '#3fb950'
                    }
                };
            });

            if (treemapData.length === 0) {
                console.warn('No valid data for Variety heatmap');
                document.getElementById('varietyHeatmap').innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;color:var(--text-secondary);">æš‚æ— æœ‰æ•ˆå“ç§èµ„é‡‘æ•°æ®</div>';
                return;
            }

            const option = {
                tooltip: {
                    formatter: function (info) {
                        var value = info.value;
                        var amount = value[0];
                        var change = value[1];
                        return [
                            '<div style="font-size:14px;font-weight:bold">' + echarts.format.encodeHTML(info.name) + '</div>',
                            'æ²‰æ·€èµ„é‡‘: ' + (amount / 100000000).toFixed(2) + 'äº¿',
                            'æ¶¨è·Œå¹…: ' + change.toFixed(2) + '%'
                        ].join('<br>');
                    }
                },
                series: [{
                    type: 'treemap',
                    width: '100%',
                    height: '100%',
                    roam: false,
                    nodeClick: false,
                    breadcrumb: { show: false },
                    label: {
                        show: true,
                        formatter: '{b}\n{@[1]}%',
                        fontSize: 12
                    },
                    itemStyle: {
                        borderColor: '#1c2128',
                        borderWidth: 1
                    },
                    data: treemapData
                }]
            };

            chart.setOption(option);
            charts.varietyHeatmap = chart;
        }

        // åŠ è½½ä¸»åŠ›åˆçº¦
        async function loadMainContracts() {
            const data = await realDataFetcher.getMainContracts();
            if (data) {
                renderMainContracts(data);
            }
        }

        // æ¸²æŸ“ä¸»åŠ›åˆçº¦
        function renderMainContracts(data) {
            const tbody = document.getElementById('mainContractsTable');
            
            let list = [];
            if (data && data.list) {
                list = data.list.slice(0, 15); // åªæ˜¾ç¤ºå‰15ä¸ª
            } else if (Array.isArray(data)) {
                list = data.slice(0, 15);
            }

            if (list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">æš‚æ— åˆçº¦æ•°æ®</td></tr>';
                return;
            }

            tbody.innerHTML = list.map(c => {
                const price = parseFloat(c.p) || 0;
                const changePercent = parseFloat(c.zdf) || 0;
                const time = c.utime ? new Date(c.utime * 1000).toLocaleTimeString() : new Date().toLocaleTimeString();
                const dm = c.dm;
                const market = c.market || (dm.startsWith('au') || dm.startsWith('ag') || dm.startsWith('cu') || dm.startsWith('rb') ? '113' : '114');
                
                return `
                <tr style="cursor: pointer;" onclick="renderTop20Holdings('${dm}', '${market}')">
                    <td><strong>${dm}</strong></td>
                    <td>${c.name}</td>
                    <td>${price.toFixed(price < 10 ? 3 : 2)}</td>
                    <td class="${changePercent >= 0 ? 'text-up' : 'text-down'}">
                        ${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%
                    </td>
                    <td>${time}</td>
                </tr>
            `}).join('');
        }

        // æ¸²æŸ“å¸‚åœºæ¶¨è·Œ
        function renderMarketUpDown(data, list = []) {
            if (data && data.result) {
                const res = data.result;
                document.getElementById('upCount').textContent = res.z || '0';
                document.getElementById('downCount').textContent = res.d || '0';
                document.getElementById('totalCount').textContent = res.total || '0';
                
                if (list && list.length > 0) {
                    const changes = list.map(i => parseFloat(i.zdf) || 0);
                    const avgChange = (changes.reduce((a,b) => a+b, 0) / changes.length).toFixed(2);
                    const avgElem = document.getElementById('marketAvgChange');
                    if (avgElem) {
                        avgElem.textContent = (avgChange >= 0 ? '+' : '') + avgChange + '%';
                        avgElem.className = 'stat-value ' + (avgChange >= 0 ? 'text-up' : 'text-down');
                    }
                }
            }
        }

        // æ¸²æŸ“å“ç§åˆ—è¡¨ (æ¶¨è·Œå¹…åŠå¢ä»“ç‡)
        function renderVarietyList(list) {
            if (list) lastRawVarietyList = list;
            const dataToRender = list || lastRawVarietyList;

            const container = document.getElementById('varietyList');
            if (!dataToRender || dataToRender.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px;">æš‚æ— æ•°æ®</div>';
                return;
            }

            // æŒ‰æ¶¨è·Œå¹…ç»å¯¹å€¼é™åºæ’åˆ—
            const sortedList = [...dataToRender].sort((a, b) => {
                const absA = Math.abs(parseFloat(a.zdf) || 0);
                const absB = Math.abs(parseFloat(b.zdf) || 0);
                return absB - absA;
            });

            // å¦‚æœä¸æ˜¯â€œæ˜¾ç¤ºå…¨éƒ¨â€ï¼Œåˆ™åªæ˜¾ç¤ºå‰40ä¸ª
            const displayList = showAllVarieties ? sortedList : sortedList.slice(0, 40);

            container.innerHTML = displayList.map(item => {
                const change = parseFloat(item.zdf) || 0;
                const oiChangeRate = item.zccl ? (((item.ccl - item.zccl) / item.zccl) * 100).toFixed(2) : '0.00';
                const isUp = change >= 0;
                const oiIsUp = parseFloat(oiChangeRate) >= 0;
                
                return `
                <div class="variety-row" onclick="scrollToAnalysis('${item.uid.split('|')[1]?.toLowerCase()}')">
                    <div class="v-info">
                        <span class="v-name">${item.name}</span>
                        <div class="mini-progress">
                            <div class="mini-fill" style="width: ${Math.min(Math.abs(change) * 5, 100)}%; background: ${isUp ? 'var(--color-danger)' : 'var(--color-success)'}"></div>
                        </div>
                    </div>
                    <div class="v-change ${isUp ? 'text-up' : 'text-down'}">
                        ${isUp ? '+' : ''}${change.toFixed(2)}%
                    </div>
                    <div class="v-oi" style="color: ${oiIsUp ? 'var(--color-danger)' : 'var(--color-success)'}">
                        ${oiIsUp ? 'å¢' : 'å‡'}${Math.abs(oiChangeRate)}%
                    </div>
                </div>
            `;
            }).join('');
        }

        function toggleVarietyDisplay() {
            showAllVarieties = !showAllVarieties;
            const btn = document.getElementById('toggleVarietyListBtn');
            if (btn) btn.textContent = showAllVarieties ? 'æ”¶èµ·åˆ—è¡¨' : 'æ˜¾ç¤ºå…¨éƒ¨';
            renderVarietyList(lastRawVarietyList);
        }

        function scrollToAnalysis(code) {
            const select = document.getElementById('variety-select-analysis');
            const msgid = DIRECT_VARIETY_MAP[code];
            if (msgid) {
                select.value = msgid;
                switchTab('realtime'); 
                handleVarietyAnalysisChange();
                setTimeout(() => {
                    const section = document.getElementById('variety-analysis-section');
                    if (section) section.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            } else {
                // å¦‚æœåœ¨DIRECT_VARIETY_MAPæ²¡æ‰¾åˆ°ï¼Œå°è¯•æ¨¡ç³ŠåŒ¹é…
                const opt = Array.from(select.options).find(o => o.textContent.toLowerCase().includes(code.toLowerCase()));
                if (opt) {
                    select.value = opt.value;
                    switchTab('realtime');
                    handleVarietyAnalysisChange();
                    setTimeout(() => {
                        const section = document.getElementById('variety-analysis-section');
                        if (section) section.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100);
                }
            }
        }

        // æ¸²æŸ“åŸºå·®
        function renderBasis(data) {
            if (data && data.data && Array.isArray(data.data)) {
                let totalBasis = 0;
                let count = 0;
                data.data.forEach(item => {
                    if (item.basisContractList) {
                        const defaultBasis = item.basisContractList.find(b => b.defaultValue === 'Y');
                        if (defaultBasis && defaultBasis.closeBasisValue) {
                            totalBasis += parseFloat(defaultBasis.closeBasisValue);
                            count++;
                        }
                    }
                });
                const avgBasis = count > 0 ? (totalBasis / count).toFixed(2) : '-';
                const basisElem = document.getElementById('basisValue');
                if (basisElem) {
                    basisElem.textContent = avgBasis;
                    basisElem.className = 'stat-value ' + (parseFloat(avgBasis) >= 0 ? 'text-up' : 'text-down');
                }
            }
        }

        // åŠ è½½èµ„è®¯
        async function loadNews() {
            const [thsNews, emNews, wallStreetNews] = await Promise.all([
                realDataFetcher.getTHSNews(),
                realDataFetcher.getEMNews(),
                realDataFetcher.getWallStreetNews()
            ]);

            if (thsNews) {
                renderNewsList(thsNews, 'thsNewsList', 'åŒèŠ±é¡º');
            }
            if (emNews) {
                renderNewsList(emNews, 'emNewsList', 'ä¸œæ–¹è´¢å¯Œ');
            }
            if (wallStreetNews) {
                renderNewsList(wallStreetNews, 'wallStreetNewsList', 'åå°”è¡—');
            }
        }

        // æ¸²æŸ“èµ„è®¯åˆ—è¡¨
        function renderNewsList(data, containerId, source) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            let list = [];
            // å¤„ç†ä¸åŒæ–°é—»æ¥æºçš„æ•°æ®ç»“æ„
            if (data && Array.isArray(data.data)) { // THS
                list = data.data;
            } else if (data && data.result && Array.isArray(data.result.list)) { // EM
                list = data.result.list;
            } else if (data && data.data && Array.isArray(data.data.items)) { // WallStreet
                list = data.data.items;
            } else if (Array.isArray(data)) {
                list = data;
            }

            if (!Array.isArray(list) || list.length === 0) {
                container.innerHTML = '<div class="news-item">æš‚æ— ç›¸å…³èµ„è®¯</div>';
                return;
            }

            container.innerHTML = list.slice(0, 8).map(n => {
                const title = n.title || n.content_text || n.show_name || 'æ— æ ‡é¢˜';
                const timeStr = n.time || n.display_time || (n.utime ? new Date(n.utime * 1000).toLocaleTimeString() : '');
                const url = n.url || '#';
                
                return `
                <div class="news-item">
                    <div class="news-title"><a href="${url}" target="_blank" style="color: inherit; text-decoration: none;">${title}</a></div>
                    <div class="news-meta">
                        <span class="badge badge-warning">${source}</span>
                        <span>â€¢ ${timeStr}</span>
                    </div>
                </div>
            `}).join('');
        }

        // åŠ è½½é¾™è™æ¦œ
        async function loadDragonTiger() {
            const dateInput = document.getElementById('dragonDate');
            const date = dateInput && dateInput.value ? dateInput.value.replace(/-/g, '') : formatDate(new Date());
            
            const varietySelect = document.getElementById('dragon-variety-select');
            const varietyUid = (varietySelect && varietySelect.value) ? varietySelect.value : '113_cu'; 
            const varietyCode = varietyUid.includes('_') ? varietyUid.split('_')[1] : varietyUid;
            const marketCode = varietyUid.includes('_') ? varietyUid.split('_')[0] : '113';

            const varietyNameDisplay = document.getElementById('currentVarietyName');
            if (varietyNameDisplay && varietySelect && varietySelect.selectedIndex >= 0) {
                varietyNameDisplay.textContent = varietySelect.options[varietySelect.selectedIndex].text + ' (' + varietyCode + ')';
            }
            
            // ä½¿ç”¨å“ç§æ±‡æ€»é¾™è™æ¦œ
            const [dragonTiger, varietyPositionDiff] = await Promise.all([
                realDataFetcher.getDragonTigerVarietySummary(date, marketCode, varietyCode),
                realDataFetcher.getVarietyPositionDiff()
            ]);

            if (dragonTiger) {
                renderDragonTiger(dragonTiger);
                // æ¸²æŸ“å‰20æŒä»“è¯¦æƒ…
                renderTop20Holdings(varietyCode, marketCode, dragonTiger);
            }
            if (varietyPositionDiff) {
                renderVarietyPositionDiff(varietyPositionDiff);
            }
        }

        // æ¸²æŸ“é¾™è™æ¦œ
        function renderDragonTiger(data) {
            const tbody = document.getElementById('dragonTigerTable');
            
            if (!data || !data.data) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center">æš‚æ— æ¦œå•æ•°æ®</td></tr>';
                return;
            }

            const d = data.data;
            const longList = d.longInfoList || [];
            const shortList = d.shortInfoList || [];
            
            const maxLength = Math.max(longList.length, shortList.length, 20);
            let rowsHtml = '';
            
            for (let i = 0; i < 20; i++) {
                const long = longList[i] || {};
                const short = shortList[i] || {};
                
                rowsHtml += `
                    <tr>
                        <td style="color: var(--text-secondary);">${i + 1}</td>
                        <td style="font-weight: 500;">${long.futureCompanyName ? long.futureCompanyName.replace('(ä»£å®¢)','') : '-'}</td>
                        <td style="text-align: right;">${long.longNum || '-'}</td>
                        <td class="${(long.longNumChange || 0) >= 0 ? 'change-up' : 'change-down'}" style="text-align: right;">
                            ${long.longNumChange ? (long.longNumChange > 0 ? '+' : '') + long.longNumChange : '-'}
                        </td>
                        <td style="font-weight: 500;">${short.futureCompanyName ? short.futureCompanyName.replace('(ä»£å®¢)','') : '-'}</td>
                        <td style="text-align: right;">${short.shortNum || '-'}</td>
                        <td class="${(short.shortNumChange || 0) <= 0 ? 'change-up' : 'change-down'}" style="text-align: right;">
                            ${short.shortNumChange ? (short.shortNumChange > 0 ? '+' : '') + short.shortNumChange : '-'}
                        </td>
                    </tr>
                `;
            }

            tbody.innerHTML = rowsHtml;
        }

        // æ¸²æŸ“å“ç§å¤šç©ºåˆ†æ­§ (å›¾è¡¨åŒ–)
        function renderVarietyPositionDiff(data) {
            const containerHtml = document.getElementById('varietyPositionDiff');
            const containerChartHome = document.getElementById('varietyPositionDiffChart');
            const containerChartDragon = document.getElementById('varietyPositionDiffChartDragon');
            
            let list = [];
            if (data && data.data && data.data.quoteGenralVarietyPositions) {
                list = data.data.quoteGenralVarietyPositions.slice(0, 15);
            }
            
            // æ—§çš„ HTML æ¸²æŸ“ (ä¸ºé¾™è™æ¦œè¯¦æƒ…é¡µä¿ç•™)
            if (containerHtml) {
                if (list.length === 0) {
                    containerHtml.innerHTML = 'æš‚æ— å¤šç©ºæ•°æ®';
                } else {
                    containerHtml.innerHTML = list.map(v => {
                        const longRate = (v.totalLongRate * 100).toFixed(1);
                        const shortRate = (v.totalShortRate * 100).toFixed(1);
                        return `
                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 12px;">
                                <span>${v.varietyName}</span>
                                <span>å¤š ${longRate}% / ç©º ${shortRate}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${longRate}%; background: ${v.totalLongRate > v.totalShortRate ? '#f85149' : '#3fb950'}"></div>
                            </div>
                        </div>
                    `}).join('');
                }
            }

            // å›¾è¡¨æ¸²æŸ“é€šç”¨å‡½æ•°
            const drawDiffChart = (container) => {
                if (!container) return;
                const chart = echarts.init(container);
                const categories = list.map(v => v.varietyName).reverse();
                const longData = list.map(v => (v.totalLongRate * 100).toFixed(1)).reverse();
                const shortData = list.map(v => (v.totalShortRate * 100).toFixed(1)).reverse();

                const option = {
                    backgroundColor: 'transparent',
                    tooltip: { 
                        trigger: 'axis', 
                        axisPointer: { type: 'shadow' },
                        backgroundColor: '#1c2128',
                        borderColor: '#30363d',
                        textStyle: { color: '#adbac7' },
                        formatter: function(params) {
                            let res = '<strong>' + params[0].name + '</strong><br/>';
                            params.forEach(p => {
                                res += p.marker + p.seriesName + ': ' + p.value + '%<br/>';
                            });
                            return res;
                        }
                    },
                    grid: { left: '15%', right: '5%', bottom: '2%', top: '2%', containLabel: false },
                    xAxis: { show: false },
                    yAxis: { 
                        type: 'category', 
                        data: categories, 
                        axisLine: { show: false },
                        axisTick: { show: false },
                        axisLabel: { 
                            color: '#adbac7',
                            fontSize: 12,
                            margin: 12
                        }
                    },
                    series: [
                        { 
                            name: 'å¤šå¤´å æ¯”', 
                            type: 'bar', 
                            stack: 'total', 
                            barWidth: 20,
                            label: { show: true, position: 'inside', formatter: '{c}%', color: '#fff', fontSize: 11, fontWeight: 'bold' }, 
                            itemStyle: { 
                                color: '#f85149',
                                borderRadius: [4, 0, 0, 4]
                            }, 
                            data: longData 
                        },
                        { 
                            name: 'ç©ºå¤´å æ¯”', 
                            type: 'bar', 
                            stack: 'total', 
                            label: { show: true, position: 'inside', formatter: '{c}%', color: '#fff', fontSize: 11, fontWeight: 'bold' }, 
                            itemStyle: { 
                                color: '#3fb950',
                                borderRadius: [0, 4, 4, 0]
                            }, 
                            data: shortData 
                        }
                    ]
                };
                chart.setOption(option);
            };

            if (containerChartHome) drawDiffChart(containerChartHome);
            if (containerChartDragon) drawDiffChart(containerChartDragon);
        }

        // æ¸²æŸ“å‰20æŒä»“ (Clustered Bar Chart)
        async function renderTop20Holdings(contract, market = '113', data = null) {
            if (!contract) return;
            const container = document.getElementById('top20Holdings');
            
            try {
                let d = null;
                if (data && data.data && data.data.contract === contract) {
                    d = data.data;
                } else {
                    container.innerHTML = '<div style="padding: 20px; text-align: center;"><i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...</div>';
                    const date = document.getElementById('dragonDate')?.value.replace(/-/g, '') || formatDate(new Date());
                    const response = await realDataFetcher.getDragonTigerList(date, market, contract);
                    if (response && response.data) {
                        d = response.data;
                    }
                }
                
                if (d) {
                    const longList = (d.longInfoList || []).slice(0, 10);
                    const shortList = (d.shortInfoList || []).slice(0, 10);
                    
                    // åˆå¹¶å¸­ä½ä»¥è¿›è¡Œå¯¹æ¯”
                    const brokers = Array.from(new Set([...longList.map(l => l.futureCompanyName), ...shortList.map(s => s.futureCompanyName)])).slice(0, 12);
                    
                    const chart = echarts.init(container);
                    const option = {
                        tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                        legend: { data: ['å¤šå¤´æŒä»“', 'ç©ºå¤´æŒä»“'], textStyle: { color: '#adbac7' }, bottom: 0 },
                        grid: { left: '3%', right: '4%', bottom: '10%', top: '10%', containLabel: true },
                        xAxis: { 
                            type: 'category', 
                            data: brokers.map(b => b.replace('(ä»£å®¢)', '')),
                            axisLabel: { color: '#adbac7', rotate: 30, fontSize: 10 }
                        },
                        yAxis: { 
                            type: 'value',
                            axisLabel: { color: '#adbac7' },
                            splitLine: { lineStyle: { color: '#30363d' } }
                        },
                        series: [
                            {
                                name: 'å¤šå¤´æŒä»“',
                                type: 'bar',
                                data: brokers.map(b => {
                                    const broker = longList.find(l => l.futureCompanyName === b);
                                    return broker ? broker.longNum : 0;
                                }),
                                itemStyle: { color: '#f85149' }
                            },
                            {
                                name: 'ç©ºå¤´æŒä»“',
                                type: 'bar',
                                data: brokers.map(b => {
                                    const broker = shortList.find(s => s.futureCompanyName === b);
                                    return broker ? broker.shortNum : 0;
                                }),
                                itemStyle: { color: '#3fb950' }
                            }
                        ]
                    };
                    chart.setOption(option);
                    charts.top20Holdings = chart;
                } else {
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: #8b949e;">æš‚æ— æŒä»“è¯¦æƒ…</div>';
                }
            } catch (e) {
                console.error('Error rendering top 20:', e);
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #f85149;">åŠ è½½å‡ºé”™</div>';
            }
        }

        // æ¸²æŸ“å¸‚åœºæŒ‡æ•°è¶‹åŠ¿
        function renderMarketIndexTrend(data) {
            const chart = echarts.init(document.getElementById('marketIndexTrend'));
            
            // å¦‚æœåªæœ‰å•ç‚¹æ•°æ®ï¼Œæ˜¾ç¤ºæ—¥å†…åˆ†æ—¶æ¨¡æ‹Ÿ(åŸºäºOHLC)
            let qt = null;
            if (data && data.qt) {
                qt = data.qt;
            }

            if (!qt) {
                console.warn('Market index data is empty');
                return;
            }

            const dates = ['æ˜¨æ—¥æ”¶ç›˜', 'ä»Šæ—¥å¼€ç›˜', 'ä»Šæ—¥æœ€ä½', 'ä»Šæ—¥æœ€é«˜', 'å½“å‰ä»·'];
            const indexValues = [qt.qrspj, qt.o, qt.l, qt.h, qt.p].map(v => parseFloat(v));

            const option = {
                tooltip: { trigger: 'axis' },
                xAxis: {
                    type: 'category',
                    data: dates,
                    axisLabel: { color: '#8b949e' }
                },
                yAxis: {
                    type: 'value',
                    min: 'dataMin',
                    max: 'dataMax',
                    axisLabel: { color: '#8b949e' },
                    splitLine: { lineStyle: { color: '#30363d' } }
                },
                series: [{
                    name: qt.name || 'ç»¼åˆæŒ‡æ•°',
                    type: 'line',
                    data: indexValues,
                    smooth: true,
                    lineStyle: { color: '#58a6ff', width: 3 },
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(88, 166, 255, 0.3)' },
                            { offset: 1, color: 'rgba(88, 166, 255, 0)' }
                        ])
                    },
                    markLine: {
                        data: [{ type: 'average', name: 'å¹³å‡å€¼' }]
                    }
                }]
            };

            chart.setOption(option);
            charts.marketIndexTrend = chart;
        }

        // æ¸²æŸ“æƒ…ç»ªæŒ‡æ•°
        function renderEmotionIndex(data) {
            const emotionValueMini = document.getElementById('emotionValueMini');
            const emotionLabelMini = document.getElementById('emotionLabelMini');
            
            let value = 50;
            if (data && data.data && data.data.emotion_index) {
                value = parseFloat(data.data.emotion_index);
            } else if (data && data.re && data.re.length > 0) {
                value = parseFloat(data.re[0].value) * 100;
            } else if (typeof data === 'number') {
                value = data;
            }

            const valStr = value.toFixed(1);
            
            // è¯­ä¹‰æ ‡ç­¾æ˜ å°„
            let label = "ä¸­æ€§";
            let colorClass = "text-secondary";
            if (value >= 80) { label = "æåº¦äº¢å¥‹"; colorClass = "text-up"; }
            else if (value >= 60) { label = "åå‘å¤šå¤´"; colorClass = "text-up"; }
            else if (value <= 20) { label = "æåº¦æ‚²è§‚"; colorClass = "text-down"; }
            else if (value <= 40) { label = "åå‘ç©ºå¤´"; colorClass = "text-down"; }

            if (emotionValueMini) {
                emotionValueMini.textContent = valStr;
                emotionValueMini.className = 'stat-value ' + colorClass;
            }
            if (emotionLabelMini) {
                emotionLabelMini.textContent = label;
                emotionLabelMini.style.color = (value > 50 ? 'var(--color-danger)' : (value < 50 ? 'var(--color-success)' : 'var(--text-secondary)'));
            }
        }

        // æ¸²æŸ“æƒ…ç»ªè¶‹åŠ¿å›¾ (å¯¹é½ GubaInvestorEmotion è®¾è®¡)
        function renderEmotionTrendChart(data) {
            const container = document.getElementById('emotionTrendChart');
            if (!container) return;
            const chart = echarts.init(container);
            
            let list = [];
            if (data && data.re) {
                list = data.re;
            } else if (Array.isArray(data)) {
                list = data;
            }
            
            if (list.length === 0) return;

            const xData = list.map(item => {
                const d = new Date(item.time);
                return d.getHours().toString().padStart(2, '0') + ':' + d.getMinutes().toString().padStart(2, '0');
            });
            const yData = list.map(item => (parseFloat(item.value) * 100).toFixed(2));
            const latestValue = yData[yData.length - 1];
            const latestLabel = latestValue >= 60 ? 'åå¤š' : (latestValue <= 40 ? 'åç©º' : 'ä¸­æ€§');

            const option = {
                tooltip: {
                    trigger: 'axis',
                    formatter: '{b} æƒ…ç»ªå€¼: {c}',
                    axisPointer: { type: 'cross', lineStyle: { color: '#30363d' } }
                },
                grid: { left: '40', right: '40', top: '30', bottom: '30' },
                xAxis: {
                    type: 'category',
                    data: xData,
                    axisLabel: { color: '#8b949e', fontSize: 10 },
                    axisLine: { lineStyle: { color: '#30363d' } }
                },
                yAxis: {
                    type: 'value',
                    min: 0,
                    max: 100,
                    splitLine: { lineStyle: { color: '#30363d', type: 'dashed' } },
                    axisLabel: { color: '#8b949e' }
                },
                visualMap: {
                    show: false,
                    pieces: [
                        { gt: 0, lte: 30, color: '#3fb950' },
                        { gt: 30, lte: 70, color: '#8b949e' },
                        { gt: 70, lte: 100, color: '#f85149' }
                    ]
                },
                series: [{
                    name: 'æƒ…ç»ªæŒ‡æ•°',
                    type: 'line',
                    data: yData,
                    smooth: true,
                    showSymbol: false,
                    lineStyle: { width: 3, color: '#DAA520' },
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(218, 165, 32, 0.2)' },
                            { offset: 1, color: 'rgba(218, 165, 32, 0)' }
                        ])
                    },
                    markLine: {
                        silent: true,
                        symbol: ['none', 'arrow'],
                        symbolSize: 8,
                        data: [{
                            yAxis: latestValue,
                            label: {
                                position: 'end',
                                formatter: latestValue + ' (' + latestLabel + ')',
                                color: '#f85149',
                                fontWeight: 'bold'
                            },
                            lineStyle: { type: 'dashed', color: '#f85149', width: 2 }
                        }]
                    }
                }]
            };

            chart.setOption(option);
            charts.emotionTrend = chart;
            
        }

        // --- è¿›é˜¶åˆ†ææ¨¡å—å›¾è¡¨æ¸²æŸ“ ---

        /**
         * åŠ è½½å¹¶æ›´æ–°è¿›é˜¶åˆ†æå›¾è¡¨
         */
        async function updateAnalysisCharts() {
            console.log('Updating analysis charts...');
            try {
                // åŒæ—¶è·å–ç™½ç›˜å’Œå¤œç›˜æ•°æ®ï¼Œè¿›è¡Œæ··åˆåˆå¹¶
                const [dayData, nightData] = await Promise.all([
                    realDataFetcher.getVarietyList(),
                    realDataFetcher.getNightVarietyList()
                ]);

                // åˆå¹¶é€»è¾‘ï¼šä»¥ç™½ç›˜å…¨é›†ä¸ºåŸºå‡†ï¼Œç”¨å¤œç›˜æ´»è·ƒæ•°æ®è¿›è¡Œçƒ­æ›´æ–°
                let combinedMap = new Map();
                
                if (dayData && dayData.list) {
                    dayData.list.forEach(item => combinedMap.set(item.dm, {...item, source: 'day'}));
                }
                
                if (nightData && nightData.list) {
                    nightData.list.forEach(item => {
                        const existing = combinedMap.get(item.dm);
                        // å¦‚æœå¤œç›˜æ•°æ®æ›´â€œæ´»â€ï¼ˆä»·æ ¼ä¸æ˜¯'-'ï¼‰ï¼Œåˆ™è¦†ç›–
                        if (item.p !== '-' || !existing) {
                            combinedMap.set(item.dm, {...(existing || {}), ...item, source: 'night'});
                        }
                    });
                }

                const combinedList = Array.from(combinedMap.values());
                console.log(`Combined analysis data: ${combinedList.length} items`);

                // æ›´åŠ å®½æ¾çš„è¿‡æ»¤ï¼šåªè¦æœ‰åŸºæœ¬çš„å‚è€ƒä»·å’Œæ¶¨è·Œå¹…å³å¯
                const validList = combinedList.filter(item => {
                    const price = safeParse(item.p, -1);
                    const base = safeParse(item.zjsj, safeParse(item.qrspj, -1));
                    return base > 0 && (price > 0 || item.zdf !== '-');
                });
                
                console.log(`Valid items for charts: ${validList.length}`);
                
                if (validList.length > 0) {
                    renderChangePositionBubbleChart(validList);
                    renderVarietyTrendChart(validList);
                } else {
                    console.warn('No valid items found after merging day and night data.');
                }
            } catch (err) {
                console.error('Failed to update analysis charts:', err);
            }
        }

        // å®‰å…¨è§£ææ•°å€¼ï¼Œå¤„ç† "-"
        function safeParse(val, defaultVal = 0) {
            if (val === '-' || val === undefined || val === null) return defaultVal;
            const parsed = parseFloat(val);
            return isNaN(parsed) ? defaultVal : parsed;
        }

        /**
         * æ¸²æŸ“æ¶¨è·Œå¹…ä¸å¢ä»“æ¯”å…³ç³»å›¾ (Bubble)
         */
        function renderChangePositionBubbleChart(list) {
            const container = document.getElementById('bubbleChartAnalysis');
            if (!container) return;
            const chart = echarts.init(container);
            
            const metric = document.querySelector('input[name="bubbleMetric"]:checked')?.value || 'cdzj';
            
            const processedData = list.filter(item => safeParse(item.ccl) > 0).map(item => {
                const zdf = safeParse(item.zdf);
                const rz = safeParse(item.rz);
                const ccl = safeParse(item.ccl, 1);
                // è®¡ç®—å¢ä»“æ¯”: å¢ä»“é‡ / (å½“å‰æŒä»“ - å¢ä»“é‡)
                const rzRatio = ((rz / (ccl - rz || 1)) * 100);
                
                return [
                    zdf,        // x
                    rzRatio,    // y
                    safeParse(item[metric]), // size metric
                    item.name,  // label
                    zdf >= 0 ? (rz >= 0 ? 'å¤šå¤´å¼ºåŠ¿' : 'å¤šå¤´è·åˆ©') : (rz >= 0 ? 'ç©ºå¤´å¼ºåŠ¿' : 'ç©ºå¤´å¹³ä»“'), // quadrant
                    item // raw
                ];
            });

            const option = {
                backgroundColor: 'transparent',
                grid: { left: '80', right: '40', top: '40', bottom: '60' },
                tooltip: {
                    formatter: function(params) {
                        const d = params.data[5];
                        return `<div style="padding:10px;">
                            <strong style="font-size:14px;color:#58a6ff;">${d.name} (${d.dm})</strong><br/>
                            æ¶¨è·Œå¹…: <span style="color:${d.zdf >= 0 ? '#f85149' : '#3fb950'}">${d.zdf}%</span><br/>
                            å¢ä»“æ¯”: ${params.data[1].toFixed(2)}%<br/>
                            æ²‰æ·€èµ„é‡‘: ${(d.cdzj / 100000000).toFixed(2)} äº¿<br/>
                            æˆäº¤é¢: ${(d.cje / 100000000).toFixed(2)} äº¿
                        </div>`;
                    }
                },
                xAxis: {
                    name: 'æ¶¨è·Œå¹… (%)',
                    nameLocation: 'center',
                    nameGap: 30,
                    splitLine: { lineStyle: { color: '#30363d', type: 'dashed' } },
                    axisLine: { lineStyle: { color: '#8b949e' } },
                    scale: true,
                    axisLabel: { color: '#8b949e' }
                },
                yAxis: {
                    name: 'å¢ä»“æ¯” (%)',
                    splitLine: { lineStyle: { color: '#30363d', type: 'dashed' } },
                    axisLine: { lineStyle: { color: '#8b949e' } },
                    scale: true,
                    axisLabel: { color: '#8b949e' }
                },
                series: [{
                    type: 'scatter',
                    data: processedData,
                    itemStyle: {
                        color: function(params) {
                            const x = params.data[0];
                            const y = params.data[1];
                            if (x >= 0) return y >= 0 ? '#f85149' : '#f39c12';
                            return y >= 0 ? '#0073b7' : '#3fb950';
                        },
                        opacity: 0.7,
                        borderWidth: 1,
                        borderColor: 'rgba(255,255,255,0.2)'
                    },
                    label: {
                        show: true,
                        formatter: '{@[3]}',
                        color: '#fff',
                        fontSize: 10,
                        position: 'inside',
                        textShadowBlur: 2,
                        textShadowColor: '#000'
                    },
                    markLine: {
                        lineStyle: { type: 'solid', color: '#58a6ff', opacity: 0.5 },
                        data: [{ xAxis: 0 }, { yAxis: 0 }]
                    }
                }]
            };

            // åŠ¨æ€è°ƒæ•´æ°”æ³¡å¤§å°æ˜ å°„
            const values = processedData.map(d => d[2]);
            const maxVal = Math.max(...values, 1000000); // é¿å…åˆ†æ¯è¿‡å°
            option.series[0].symbolSize = function(data) {
                const val = data[2];
                // ä½¿ç”¨å¼€æ–¹ç¼©æ”¾ä½¿å¤§å°åˆ†å¸ƒæ›´å‡åŒ€
                const ratio = Math.sqrt(val / maxVal);
                return ratio * 70 + 12;
            };

            chart.setOption(option);
            charts.bubbleAnalysis = chart;
        }

        /**
         * æ¸²æŸ“å…¨å“ç§ç›¸å¯¹å¼ºå¼±èµ°åŠ¿å¯¹æ¯” (ç›¸å¯¹Candlestick)
         */
        function renderVarietyTrendChart(list) {
            const container = document.getElementById('trendComparisonChart');
            if (!container) return;
            const chart = echarts.init(container);

            // æ’åº: æŒ‰æ¶¨è·Œå¹…ï¼Œå¹¶å†æ¬¡è¿‡æ»¤ç¡®ä¿ K çº¿å››ä¸ªæ ¸å¿ƒå€¼æœ‰æ•ˆ
            const sorted = [...list]
                .filter(item => item.o !== '-' && item.h !== '-' && item.l !== '-')
                .sort((a, b) => safeParse(b.zdf) - safeParse(a.zdf))
                .slice(0, 50);

            const xData = sorted.map(item => item.name);
            const yData = sorted.map(item => {
                const base = safeParse(item.zjsj, 1);
                return [
                    ((safeParse(item.o) - base) / base * 100).toFixed(2), // å¼€ç›˜%
                    ((safeParse(item.p) - base) / base * 100).toFixed(2), // æ”¶ç›˜%
                    ((safeParse(item.l) - base) / base * 100).toFixed(2), // æœ€ä½%
                    ((safeParse(item.h) - base) / base * 100).toFixed(2)  // æœ€é«˜%
                ];
            });

            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: function(params) {
                        const p = params[0];
                        const d = sorted[p.dataIndex];
                        return `<div style="padding:10px;">
                            <strong>${d.name} ç›¸å¯¹èµ°åŠ¿</strong><br/>
                            å¼€ç›˜: ${p.data[0]}%<br/>
                            æ”¶ç›˜: ${p.data[1]}%<br/>
                            æœ€é«˜: ${p.data[3]}%<br/>
                            æœ€ä½: ${p.data[2]}%
                        </div>`;
                    }
                },
                grid: { left: '80', right: '30', top: '40', bottom: '80' },
                xAxis: {
                    type: 'category',
                    data: xData,
                    axisLabel: { 
                        color: '#8b949e', 
                        rotate: 45,
                        fontSize: 10
                    },
                    axisLine: { lineStyle: { color: '#30363d' } }
                },
                yAxis: {
                    type: 'value',
                    name: 'ç›¸å¯¹æ¶¨è·Œå¹… (%)',
                    splitLine: { lineStyle: { color: '#30363d', type: 'dashed' } },
                    axisLabel: { color: '#8b949e' }
                },
                dataZoom: [{ type: 'inside', start: 0, end: 100 }, { type: 'slider', height: 20, bottom: 10 }],
                series: [{
                    type: 'candlestick',
                    data: yData,
                    itemStyle: {
                        color: '#f85149',
                        color0: '#3fb950',
                        borderColor: '#f85149',
                        borderColor0: '#3fb950'
                    },
                    markPoint: {
                        data: [
                            { type: 'max', name: 'æœ€å¤§æ¶¨å¹…', itemStyle: { color: '#f85149' } },
                            { type: 'min', name: 'æœ€å¤§è·Œå¹…', itemStyle: { color: '#3fb950' } }
                        ],
                        label: { formatter: '{c}%', fontSize: 10 }
                    }
                }]
            };

            chart.setOption(option);
            charts.trendComparison = chart;
        }

        // å“åº”å¼
        window.addEventListener('resize', function() {
            Object.values(charts).forEach(chart => chart && chart.resize());
        });

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            // è®¾ç½®æ—¥æœŸé€‰æ‹©å™¨é»˜è®¤å€¼
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            const dateInput = document.getElementById('dragonDate');
            if (dateInput) {
                dateInput.value = dateStr;
            }
            
            // åŠ è½½æ‰€æœ‰æ•°æ®
            loadAllData();
        };
    </script>
</body>
</html>
