# 诗词分类判断逻辑说明

## 📊 数据统计

根据 `poetry_data.json` (1,425首)：
- **诗**：804首 (56.4%)
- **词**：621首 (43.6%)

其中纳兰性德：262首，全部为词 ✓

---

## 🔍 判断依据

### 一、朝代判断（在 merge_poetry.py 中）

#### 1. **作者名匹配**（优先级最高）

维护了各朝代作者数据库：

```python
# 先秦作者
pre_qin_authors = ['屈原', '宋玉', '荀子', '庄子', '孟子', '孔子', '老子', '韩非子']

# 汉代作者
han_authors = ['司马相如', '卓文君', '刘邦', '项羽', '刘彻']

# 魏晋作者
weijin_authors = ['曹操', '曹丕', '曹植', '陶渊明', '阮籍', '嵇康', '谢灵运', '鲍照']

# 唐代作者
tang_authors = ['李白', '杜甫', '王维', '白居易', '孟浩然', '王昌龄', '李商隐', '杜牧', ...]

# 南唐作者
southern_tang_authors = ['李煜', '李璟', '冯延巳']

# 宋代作者
song_authors = ['苏轼', '李清照', '辛弃疾', '柳永', '岳飞', '陆游', '欧阳修', ...]

# 清代作者
qing_authors = ['纳兰性德', '纳兰容若', '顾贞观', '陈维崧', '朱彝尊']

# 现代作者
modern_authors = ['毛泽东']
```

**示例**：
- 作者 = "纳兰性德" → 在 `qing_authors` 中 → 添加 `['清']` 标签

#### 2. **标题关键词匹配**

```python
if '楚辞' in rhythmic or '九歌' in rhythmic or '离骚' in rhythmic:
    tags.append('楚辞')
```

#### 3. **现有标签保留**

如果数据中已有 `'诗经'`、`'蒙学'` 等标签，则保留并补充朝代标签。

---

### 二、诗/词类型判断

#### 在 merge_poetry.py 中（数据生成时）

根据朝代和作者自动添加类型标签：

```python
# 清代作者 → 添加 '清词'
if author in qing_authors:
    tags.insert(0, '清')
    tags.append('清词')

# 唐代作者 → 添加 '唐诗'
if author in tang_authors or '唐诗' in tags:
    tags.insert(0, '唐')
    tags.insert(1, '唐诗')

# 宋代作者 → 添加 '宋词'
if author in song_authors or '宋词' in tags:
    tags.insert(0, '宋')
    tags.insert(1, '宋词')

# 南唐作者 → 添加 '词'
if author in southern_tang_authors:
    tags.insert(0, '南唐')
    tags.append('词')
```

#### 在 shici.html 中（显示时）

根据 tags 判断 source 字段：

```javascript
// 检查 tags 中是否包含 '词' 相关标签
let source = 'poem'; // 默认为诗
const tagsArray = Array.isArray(item.tags) ? item.tags : [];

if (tagsArray.some(tag => 
    tag.includes('词') ||      // 包含"词"字
    tag === '宋词' || 
    tag === '清词' || 
    tag === '南唐'
)) {
    source = 'ci';  // 标记为词
}
```

---

## 📋 纳兰性德示例

### 数据结构：
```json
{
  "author": "纳兰性德",
  "rhythmic": "木兰花·拟古决绝词柬友",
  "paragraphs": ["人生若只如初见，何事秋风悲画扇。", ...],
  "tags": ["清", "清词", "纳兰词", "思乡", "山水"]
}
```

### 判断流程：

1. **朝代判断**：
   - 作者 "纳兰性德" 在 `qing_authors` 列表中
   - → 添加 `'清'` 标签

2. **类型判断**：
   - 清代作者
   - → 添加 `'清词'` 标签

3. **显示判断**：
   - tags 包含 `'清词'`（含"词"字）
   - → `source = 'ci'`
   - → 显示为"词" ✓

---

## 🎯 判断规则总结

| 条件 | 朝代标签 | 类型标签 | source |
|------|---------|---------|--------|
| 纳兰性德 | 清 | 清词 | ci |
| 李白 | 唐 | 唐诗 | poem |
| 苏轼 | 宋 | 宋词 | ci |
| 李煜 | 南唐 | 词 | ci |
| 屈原 | 先秦 | 楚辞 | poem |
| 诗经 | 先秦 | 诗经 | poem |

---

## 🔧 最新修复

**问题**：之前所有条目的 `source` 都被硬编码为 `'poem'`

**解决**：在 shici.html 第4078-4084行添加了基于 tags 的判断逻辑

**结果**：
- 诗：804首（包括唐诗、诗经、楚辞等）
- 词：621首（包括宋词、清词、南唐词等）
- 纳兰性德的262首作品全部正确标记为"词" ✓

---

## 📝 注意事项

1. **优先级**：作者匹配 > 标题关键词 > 现有标签
2. **扩展性**：可以通过修改 `merge_poetry.py` 中的作者列表来添加新作者
3. **灵活性**：tags 可以包含多个标签，如 `['清', '清词', '纳兰词', '思乡']`
4. **准确性**：基于历史作者数据库，准确率高

现在刷新页面后，纳兰性德的词应该正确显示为"词"了！
