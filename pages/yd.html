<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股票行情异动</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 15px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
            cursor: pointer;
        }
        th.sortable::after {
            content: '\2195';
            margin-left: 5px;
            opacity: 0.5;
        }
        th.sortable.asc::after {
            content: '\2191';
            opacity: 1;
        }
        th.sortable.desc::after {
            content: '\2193';
            opacity: 1;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .filter-container {
            margin: 20px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        .filter-button {
            padding: 8px 12px;
            margin: 5px;
            cursor: pointer;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            transition: all 0.3s;
        }
        .filter-button.active {
            background-color: #007bff;
            color: white;
            border-color: #0056b3;
        }
        .positive {
            color: #ff3333;
        }
        .negative {
            color: #00aa00;
        }
        .loading {
            text-align: center;
            margin: 20px;
        }
        
        /* 顶部导航栏样式 */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        /* 移动端样式 */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                font-size: 16px;
            }
            h1 {
                font-size: 1.5rem;
                margin-bottom: 10px;
            }
            .filter-container {
                display: none; /* 在移动端隐藏原始筛选按钮 */
            }
            .top-bar {
                position: relative;
            }
            .mobile-filter-container {
                position: relative;
            }
            .mobile-filter-button {
                background-color: #007bff;
                color: white;
                border: none;
                padding: 8px 12px;
                border-radius: 4px;
                font-size: 16px;
                cursor: pointer;
            }
            .mobile-filter-dropdown {
                display: none;
                position: absolute;
                right: 0;
                top: 100%;
                background-color: white;
                border: 1px solid #ddd;
                border-radius: 4px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                z-index: 1000;
                max-height: 300px;
                overflow-y: auto;
                width: 200px;
            }
            .mobile-filter-dropdown.show {
                display: block;
            }
            .mobile-filter-item {
                padding: 10px 15px;
                border-bottom: 1px solid #eee;
                cursor: pointer;
            }
            .mobile-filter-item:last-child {
                border-bottom: none;
            }
            .mobile-filter-item.active {
                background-color: #f0f8ff;
                color: #007bff;
            }
            
            .mobile-filter-header {
                background-color: #eaeaea;
                font-weight: bold;
                color: #555;
                pointer-events: none;
            }
            th, td {
                padding: 8px 5px;
                font-size: 15px;
            }
            table {
                font-size: 15px;
            }
            /* 优化表格在移动端的显示 */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
        }
        /* 桌面端隐藏移动筛选器 */
        .mobile-filter-container {
            display: none;
        }
        @media (max-width: 768px) {
            .mobile-filter-container {
                display: block;
            }
        }
        
        /* 高级筛选样式 */
        .advanced-filter-container {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f8f8;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .advanced-filter-container h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #333;
            font-size: 18px;
        }
        
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .filter-group label {
            margin-right: 8px;
            font-weight: bold;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        .filter-group input {
            width: 80px;
        }
        
        .apply-filter-button,
        .reset-filter-button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .apply-filter-button {
            background-color: #007bff;
            color: white;
        }
        
        .reset-filter-button {
            background-color: #f0f0f0;
            color: #333;
            margin-left: 10px;
        }
        
        /* 移动端高级筛选样式 */
        @media (max-width: 768px) {
            .advanced-filter-container {
                padding: 10px;
            }
            
            .filter-row {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .filter-group {
                flex-wrap: wrap;
            }
            
            .filter-group label {
                width: 100%;
                margin-bottom: 5px;
            }
            
            .filter-group select,
            .filter-group input {
                width: 100%;
            }
            
            .apply-filter-button,
            .reset-filter-button {
                width: 100%;
                margin: 5px 0;
            }
            
            .reset-filter-button {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>

<!-- 顶部导航栏 -->
<div class="top-bar">
    <h1>股票行情异动</h1>
    
    <!-- 移动端筛选器 -->
    <div class="mobile-filter-container">
        <button class="mobile-filter-button" id="mobile-filter-btn">筛选 ▼</button>
        <div class="mobile-filter-dropdown" id="mobile-filter-dropdown">
            <div class="mobile-filter-item active" data-type="all">所有</div>
            <div class="mobile-filter-item" data-type="8201">火箭发射</div>
            <div class="mobile-filter-item" data-type="8202">快速反弹</div>
            <div class="mobile-filter-item" data-type="8193">大笔买入</div>
            <div class="mobile-filter-item" data-type="4">封涨停板</div>
            <div class="mobile-filter-item" data-type="32">打开跌停板</div>
            <div class="mobile-filter-item" data-type="64">有大买盘</div>
            <div class="mobile-filter-item" data-type="8207">竞价上涨</div>
            <div class="mobile-filter-item" data-type="8209">高开5日线</div>
            <div class="mobile-filter-item" data-type="8211">向上缺口</div>
            <div class="mobile-filter-item" data-type="8213">60日新高</div>
            <div class="mobile-filter-item" data-type="8215">60日大幅上涨</div>
            <div class="mobile-filter-item" data-type="8204">加速下跌</div>
            <div class="mobile-filter-item" data-type="8203">高台跳水</div>
            <div class="mobile-filter-item" data-type="8194">大笔卖出</div>
            <div class="mobile-filter-item" data-type="8">封跌停板</div>
            <div class="mobile-filter-item" data-type="16">打开涨停板</div>
            <div class="mobile-filter-item" data-type="128">有大卖盘</div>
            <div class="mobile-filter-item" data-type="8208">竞价下跌</div>
            <div class="mobile-filter-item" data-type="8210">低开5日线</div>
            <div class="mobile-filter-item" data-type="8212">向下缺口</div>
            <div class="mobile-filter-item" data-type="8214">60日新低</div>
            <div class="mobile-filter-item" data-type="8216">60日大幅下跌</div>
            <div class="mobile-filter-item mobile-filter-header">涨跌幅筛选</div>
            <div class="mobile-filter-item" data-percent="gt5">大于5%</div>
            <div class="mobile-filter-item" data-percent="gt3">大于3%</div>
            <div class="mobile-filter-item" data-percent="gt0">上涨</div>
            <div class="mobile-filter-item" data-percent="lt0">下跌</div>
            <div class="mobile-filter-item" data-percent="lt-3">小于-3%</div>
            <div class="mobile-filter-item" data-percent="lt-5">小于-5%</div>
        </div>
    </div>
</div>

<!-- 桌面端筛选器 -->
<div class="filter-container" id="filters">
  <button class="filter-button active" data-type="all">所有</button>
  <button class="filter-button" data-type="8201">火箭发射</button>
  <button class="filter-button" data-type="8202">快速反弹</button>
  <button class="filter-button" data-type="8193">大笔买入</button>
  <button class="filter-button" data-type="4">封涨停板</button>
  <button class="filter-button" data-type="32">打开跌停板</button>
  <button class="filter-button" data-type="64">有大买盘</button>
  <button class="filter-button" data-type="8207">竞价上涨</button>
  <button class="filter-button" data-type="8209">高开5日线</button>
  <button class="filter-button" data-type="8211">向上缺口</button>
  <button class="filter-button" data-type="8213">60日新高</button>
  <button class="filter-button" data-type="8215">60日大幅上涨</button>
  <button class="filter-button" data-type="8204">加速下跌</button>
  <button class="filter-button" data-type="8203">高台跳水</button>
  <button class="filter-button" data-type="8194">大笔卖出</button>
  <button class="filter-button" data-type="8">封跌停板</button>
  <button class="filter-button" data-type="16">打开涨停板</button>
  <button class="filter-button" data-type="128">有大卖盘</button>
  <button class="filter-button" data-type="8208">竞价下跌</button>
  <button class="filter-button" data-type="8210">低开5日线</button>
  <button class="filter-button" data-type="8212">向下缺口</button>
  <button class="filter-button" data-type="8214">60日新低</button>
  <button class="filter-button" data-type="8216">60日大幅下跌</button>
</div>

<!-- 高级筛选条件 -->
<div class="advanced-filter-container">
  <h3>高级筛选</h3>
  <div class="filter-row">
    <div class="filter-group">
      <label>异动类型：</label>
      <select id="type-filter">
        <option value="all">全部</option>
        <option value="8201">火箭发射</option>
        <option value="8202">快速反弹</option>
        <option value="8193">大笔买入</option>
        <option value="4">封涨停板</option>
        <option value="32">打开跌停板</option>
        <option value="64">有大买盘</option>
        <option value="8207">竞价上涨</option>
        <option value="8209">高开5日线</option>
        <option value="8211">向上缺口</option>
        <option value="8213">60日新高</option>
        <option value="8215">60日大幅上涨</option>
        <option value="8204">加速下跌</option>
        <option value="8203">高台跳水</option>
        <option value="8194">大笔卖出</option>
        <option value="8">封跌停板</option>
        <option value="16">打开涨停板</option>
        <option value="128">有大卖盘</option>
        <option value="8208">竞价下跌</option>
        <option value="8210">低开5日线</option>
        <option value="8212">向下缺口</option>
        <option value="8214">60日新低</option>
        <option value="8216">60日大幅下跌</option>
      </select>
    </div>
    <div class="filter-group">
      <label>涨跌幅范围：</label>
      <select id="percent-filter">
        <option value="all">全部</option>
        <option value="gt5">大于5%</option>
        <option value="gt3">大于3%</option>
        <option value="gt0">上涨</option>
        <option value="lt0">下跌</option>
        <option value="lt-3">小于-3%</option>
        <option value="lt-5">小于-5%</option>
      </select>
    </div>
    <div class="filter-group">
      <label>价格区间：</label>
      <input type="number" id="price-min" placeholder="最低价" min="0" step="0.01">
      <span>-</span>
      <input type="number" id="price-max" placeholder="最高价" min="0" step="0.01">
    </div>
    <button id="apply-filters" class="apply-filter-button">应用筛选</button>
    <button id="reset-filters" class="reset-filter-button">重置</button>
  </div>
</div>

<div id="loading" class="loading">正在加载数据...</div>

<div class="table-container">
<table>
  <thead>
    <tr>
      <th>异动类型</th>
      <th>股票名称</th>
      <th>股票代码</th>
      <th class="sortable" data-sort="price">当前价/量信息</th>
      <th class="sortable" data-sort="percent">涨跌幅</th>
      <th class="sortable" data-sort="time">时间</th>
    </tr>
  </thead>
  <tbody id="stock-data">
  </tbody>
</table>
</div>

<script>
  // 异动类型映射
  const typeMap = {
    "8201": "火箭发射",
    "8202": "快速反弹",
    "8193": "大笔买入",
    "4": "封涨停板",
    "32": "打开跌停板",
    "64": "有大买盘",
    "8207": "竞价上涨",
    "8209": "高开5日线",
    "8211": "向上缺口",
    "8213": "60日新高",
    "8215": "60日大幅上涨",
    "8204": "加速下跌",
    "8203": "高台跳水",
    "8194": "大笔卖出",
    "8": "封跌停板",
    "16": "打开涨停板",
    "128": "有大卖盘",
    "8208": "竞价下跌",
    "8210": "低开5日线",
    "8212": "向下缺口",
    "8214": "60日新低",
    "8216": "60日大幅下跌"
  };

  // 当前选中的过滤器
  let currentFilter = 'all';
  let stockData = [];
  
  // 高级筛选条件
  let advancedFilters = {
    typeFilter: 'all',
    percentFilter: 'all',
    priceMin: null,
    priceMax: null
  };
  
  // 排序状态
  let sortConfig = {
    column: 'time', // 默认按时间排序
    direction: 'desc' // 默认降序（最新的在前面）
  };
  
  // 格式化大数字，转换为万或亿单位
  function formatLargeNumber(num) {
    if (!num || isNaN(num)) return '0';
    
    num = parseFloat(num);
    
    if (num >= 100000000) { // 亿
      return (num / 100000000).toFixed(2) + '亿';
    } else if (num >= 10000) { // 万
      return (num / 10000).toFixed(2) + '万';
    } else {
      return num.toString();
    }
  }

  // 初始化页面
  document.addEventListener('DOMContentLoaded', function() {
    // 移动端筛选器下拉菜单
    const mobileFilterBtn = document.getElementById('mobile-filter-btn');
    const mobileFilterDropdown = document.getElementById('mobile-filter-dropdown');
    const mobileFilterItems = document.querySelectorAll('.mobile-filter-item');
    
    // 点击筛选按钮显示/隐藏下拉菜单
    if (mobileFilterBtn) {
      mobileFilterBtn.addEventListener('click', function() {
        mobileFilterDropdown.classList.toggle('show');
      });
    }
    
    // 点击页面其他地方关闭下拉菜单
    document.addEventListener('click', function(event) {
      if (!event.target.closest('.mobile-filter-container')) {
        mobileFilterDropdown.classList.remove('show');
      }
    });
    
    // 移动端筛选项点击事件
    mobileFilterItems.forEach(item => {
      item.addEventListener('click', function() {
        // 如果是筛选标题，不做任何操作
        if (this.classList.contains('mobile-filter-header')) {
          return;
        }
        
        // 检查是否是涨跌幅筛选
        const percentFilter = this.getAttribute('data-percent');
        
        if (percentFilter) {
          // 设置涨跌幅筛选
          advancedFilters.percentFilter = percentFilter;
          // 同步桌面端筛选器
          document.getElementById('percent-filter').value = percentFilter;
          // 更新筛选按钮文本
          mobileFilterBtn.textContent = '筛选: 涨跌幅' + this.textContent + ' ▼';
        } else {
          // 常规类型筛选
          // 移除所有active类
          mobileFilterItems.forEach(i => {
            if (!i.classList.contains('mobile-filter-header') && 
                !i.hasAttribute('data-percent')) {
              i.classList.remove('active');
            }
          });
          // 添加active类到当前项
          this.classList.add('active');
          // 设置当前过滤器
          currentFilter = this.getAttribute('data-type');
          // 更新桌面端筛选按钮状态
          const desktopButtons = document.querySelectorAll('.filter-button');
          desktopButtons.forEach(btn => {
            btn.classList.remove('active');
            if (btn.getAttribute('data-type') === currentFilter) {
              btn.classList.add('active');
            }
          });
          // 更新筛选按钮文本
          mobileFilterBtn.textContent = '筛选: ' + (this.textContent || '所有') + ' ▼';
        }
        
        // 关闭下拉菜单
        mobileFilterDropdown.classList.remove('show');
        // 过滤和渲染数据
        renderStockData();
      });
    });
    
    // 注册桌面端过滤器点击事件
    const filterButtons = document.querySelectorAll('.filter-button');
    filterButtons.forEach(button => {
      button.addEventListener('click', function() {
        // 移除所有active类
        filterButtons.forEach(btn => btn.classList.remove('active'));
        // 添加active类到当前按钮
        this.classList.add('active');
        // 设置当前过滤器
        currentFilter = this.getAttribute('data-type');
        // 同步移动端筛选器状态
        const mobileItems = document.querySelectorAll('.mobile-filter-item');
        mobileItems.forEach(item => {
          item.classList.remove('active');
          if (item.getAttribute('data-type') === currentFilter) {
            item.classList.add('active');
            // 更新筛选按钮文本
            if (mobileFilterBtn) {
              mobileFilterBtn.textContent = '筛选: ' + (item.textContent || '所有') + ' ▼';
            }
          }
        });
        // 过滤和渲染数据
        renderStockData();
      });
    });
    
    // 注册高级筛选事件
    const typeFilter = document.getElementById('type-filter');
    const percentFilter = document.getElementById('percent-filter');
    const priceMin = document.getElementById('price-min');
    const priceMax = document.getElementById('price-max');
    const applyFiltersBtn = document.getElementById('apply-filters');
    const resetFiltersBtn = document.getElementById('reset-filters');
    
    // 应用筛选按钮点击事件
    if (applyFiltersBtn) {
      applyFiltersBtn.addEventListener('click', function() {
        // 获取筛选值
        advancedFilters.typeFilter = typeFilter.value;
        advancedFilters.percentFilter = percentFilter.value;
        advancedFilters.priceMin = priceMin.value ? parseFloat(priceMin.value) : null;
        advancedFilters.priceMax = priceMax.value ? parseFloat(priceMax.value) : null;
        
        // 如果选择了特定类型，同步更新currentFilter
        if (advancedFilters.typeFilter !== 'all') {
          currentFilter = advancedFilters.typeFilter;
          
          // 同步更新桌面端和移动端筛选按钮状态
          const desktopButtons = document.querySelectorAll('.filter-button');
          desktopButtons.forEach(btn => {
            btn.classList.remove('active');
            if (btn.getAttribute('data-type') === currentFilter) {
              btn.classList.add('active');
            }
          });
          
          const mobileItems = document.querySelectorAll('.mobile-filter-item');
          mobileItems.forEach(item => {
            if (!item.classList.contains('mobile-filter-header') && 
                !item.hasAttribute('data-percent')) {
              item.classList.remove('active');
              if (item.getAttribute('data-type') === currentFilter) {
                item.classList.add('active');
                if (mobileFilterBtn) {
                  mobileFilterBtn.textContent = '筛选: ' + (item.textContent || '所有') + ' ▼';
                }
              }
            }
          });
        } else {
          // 如果选择了"全部"
          currentFilter = 'all';
          
          // 同步更新桌面端和移动端筛选按钮状态
          const desktopButtons = document.querySelectorAll('.filter-button');
          desktopButtons.forEach(btn => {
            btn.classList.remove('active');
            if (btn.getAttribute('data-type') === 'all') {
              btn.classList.add('active');
            }
          });
          
          const mobileItems = document.querySelectorAll('.mobile-filter-item');
          mobileItems.forEach(item => {
            if (!item.classList.contains('mobile-filter-header') && 
                !item.hasAttribute('data-percent')) {
              item.classList.remove('active');
              if (item.getAttribute('data-type') === 'all') {
                item.classList.add('active');
                if (mobileFilterBtn) {
                  mobileFilterBtn.textContent = '筛选: 所有 ▼';
                }
              }
            }
          });
        }
        
        // 重新渲染数据
        renderStockData();
      });
    }
    
    // 重置筛选按钮点击事件
    if (resetFiltersBtn) {
      resetFiltersBtn.addEventListener('click', function() {
        // 重置所有筛选条件
        typeFilter.value = 'all';
        percentFilter.value = 'all';
        priceMin.value = '';
        priceMax.value = '';
        
        // 重置高级筛选条件对象
        advancedFilters = {
          typeFilter: 'all',
          percentFilter: 'all',
          priceMin: null,
          priceMax: null
        };
        
        // 重置当前过滤器
        currentFilter = 'all';
        
        // 重新渲染数据
        renderStockData();
      });
    }
    
    // 注册表头排序点击事件
    const sortableHeaders = document.querySelectorAll('th.sortable');
    sortableHeaders.forEach(header => {
      header.addEventListener('click', function() {
        const sortType = this.getAttribute('data-sort');
        
        // 如果点击的是当前排序列，则切换排序方向
        if (sortConfig.column === sortType) {
          sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
        } else {
          // 否则，设置新的排序列，并默认为降序（除了涨跌幅，默认为升序）
          sortConfig.column = sortType;
          sortConfig.direction = sortType === 'percent' ? 'asc' : 'desc';
        }
        
        // 更新表头样式
        updateSortHeaderStyles();
        
        // 重新渲染数据
        renderStockData();
      });
    });

    // 获取数据
    fetchStockData();
    
    // 初始化排序表头样式
    updateSortHeaderStyles();
  });
  
  // 更新排序表头样式
  function updateSortHeaderStyles() {
    const headers = document.querySelectorAll('th.sortable');
    headers.forEach(header => {
      const sortType = header.getAttribute('data-sort');
      // 移除所有排序样式
      header.classList.remove('asc', 'desc');
      
      // 为当前排序列添加样式
      if (sortConfig.column === sortType) {
        header.classList.add(sortConfig.direction);
      }
    });
  }

  // 从接口获取数据
  function fetchStockData() {
    const apiUrl = 'https://push2ex.eastmoney.com/getAllStockChanges?type=8201,8202,8193,4,32,64,8207,8209,8211,8213,8215,8204,8203,8194,8,16,128,8208,8210,8212,8214,8216&ut=7eea3edcaed734bea9cbfc24409ed989&pageindex=1&pagesize=6000&dpt=wzchanges';
    
    fetch(apiUrl)
      .then(response => {
        if (!response.ok) {
          throw new Error('网络响应不正常');
        }
        return response.json();
      })
      .then(data => {
        document.getElementById('loading').style.display = 'none';
        if (data && data.data && data.data.allstock) {
          stockData = data.data.allstock;
          renderStockData();
        } else {
          document.getElementById('stock-data').innerHTML = '<tr><td colspan="6">没有找到数据</td></tr>';
        }
      })
      .catch(error => {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('stock-data').innerHTML = `<tr><td colspan="6">获取数据失败: ${error.message}</td></tr>`;
        console.error('获取数据失败:', error);
      });
  }

  // 渲染股票数据
  function renderStockData() {
    const tableBody = document.getElementById('stock-data');
    tableBody.innerHTML = '';
    
    // 根据过滤器过滤数据
    let filteredData = currentFilter === 'all' 
      ? [...stockData] 
      : [...stockData.filter(item => item.t.toString() === currentFilter)];
    
    // 同步更新高级筛选中的类型筛选下拉菜单
    const typeFilterElement = document.getElementById('type-filter');
    if (typeFilterElement && typeFilterElement.value !== currentFilter) {
      typeFilterElement.value = currentFilter;
    }
    
    // 应用高级筛选条件
    // 1. 涨跌幅筛选
    if (advancedFilters.percentFilter !== 'all') {
      filteredData = filteredData.filter(item => {
        let changePercent = 0;
        if (item.i) {
          const parts = item.i.split(',');
          if (parts.length > 0) {
            const lastPart = parts[parts.length - 1];
            changePercent = parseFloat(lastPart);
          }
        }
        
        switch(advancedFilters.percentFilter) {
          case 'gt5': return changePercent > 0.05;
          case 'gt3': return changePercent > 0.03;
          case 'gt0': return changePercent > 0;
          case 'lt0': return changePercent < 0;
          case 'lt-3': return changePercent < -0.03;
          case 'lt-5': return changePercent < -0.05;
          default: return true;
        }
      });
    }
    
    // 2. 价格区间筛选
    if (advancedFilters.priceMin !== null || advancedFilters.priceMax !== null) {
      filteredData = filteredData.filter(item => {
        let price = 0;
        if (item.i) {
          const parts = item.i.split(',');
          if (parts.length > 1) {
            price = parseFloat(parts[1] || 0);
          }
        }
        
        let passMin = true, passMax = true;
        
        if (advancedFilters.priceMin !== null && !isNaN(advancedFilters.priceMin)) {
          passMin = price >= advancedFilters.priceMin;
        }
        
        if (advancedFilters.priceMax !== null && !isNaN(advancedFilters.priceMax)) {
          passMax = price <= advancedFilters.priceMax;
        }
        
        return passMin && passMax;
      });
    }
    
    if (filteredData.length === 0) {
      tableBody.innerHTML = '<tr><td colspan="6">没有符合条件的数据</td></tr>';
      return;
    }

    // 根据当前排序配置排序数据
    sortData(filteredData);

    // 渲染数据
    filteredData.forEach(item => {
      const row = document.createElement('tr');
      
      // 解析涨跌幅
      let changePercent = 0;
      if (item.i) {
        const parts = item.i.split(',');
        if (parts.length > 0) {
          const lastPart = parts[parts.length - 1];
          changePercent = parseFloat(lastPart);
        }
      }
      
      // 格式化涨跌幅显示
      const formattedChangePercent = (changePercent * 100).toFixed(2) + '%';
      const changeClass = changePercent >= 0 ? 'positive' : 'negative';
      
      // 格式化时间
      const hours = Math.floor(item.tm / 10000);
      const minutes = Math.floor((item.tm % 10000) / 100);
      const seconds = item.tm % 100;
      const formattedTime = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      
      // 解析价格和成交量
      let currentPrice = '';
      let volume = '';
      if (item.i) {
        const parts = item.i.split(',');
        if (parts.length > 1) {
          currentPrice = parts[1] || '';
        }
        if (parts.length > 2) {
          volume = parts[2] || '';
        }
      }
      
      // 格式化价格/量信息显示
      let priceVolumeInfo = currentPrice;
      if (volume) {
        // 格式化成交量，转换为万或亿单位
        const formattedVolume = formatLargeNumber(volume);
        priceVolumeInfo += ` / ${formattedVolume}`;
      }
      
      // 设置行内容
      row.innerHTML = `
        <td>${typeMap[item.t] || item.t}</td>
        <td>${item.n}</td>
        <td>${item.c}</td>
        <td>${priceVolumeInfo}</td>
        <td class="${changeClass}">${formattedChangePercent}</td>
        <td>${formattedTime}</td>
      `;
      
      tableBody.appendChild(row);
    });
  }

  // 排序数据
  function sortData(data) {
    data.sort((a, b) => {
      let valueA, valueB;
      
      // 根据不同的列提取不同的值
      switch(sortConfig.column) {
        case 'price':
          // 提取价格
          valueA = parseFloat(a.i ? a.i.split(',')[1] || 0 : 0);
          valueB = parseFloat(b.i ? b.i.split(',')[1] || 0 : 0);
          break;
        case 'percent':
          // 提取涨跌幅
          valueA = parseFloat(a.i ? a.i.split(',')[a.i.split(',').length - 1] || 0 : 0);
          valueB = parseFloat(b.i ? b.i.split(',')[b.i.split(',').length - 1] || 0 : 0);
          break;
        case 'time':
          // 使用时间戳
          valueA = a.tm;
          valueB = b.tm;
          break;
        default:
          return 0;
      }
      
      // 处理升序/降序
      if (sortConfig.direction === 'asc') {
        return valueA - valueB;
      } else {
        return valueB - valueA;
      }
    });
  }
  
  // 设置定时刷新数据，每60秒刷新一次
  setInterval(fetchStockData, 60000);
</script>

</body>
</html>