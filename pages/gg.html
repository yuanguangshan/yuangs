<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Closing Price vs Net Financing Buy</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.0.2/dist/echarts.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        #chart {
            width: 100%;
            height: 400px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        table, th, td {
            border: 1px solid #ddd;
        }
        th, td {
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f4f4f4;
        }
    </style>
</head>
<body>

<h2>Closing Price vs Net Financing Buy over Time</h2>

<!-- Echarts 图表容器 -->
<div id="chart"></div>

<!-- 数据表格 -->
<table id="data-table">
    <thead>
        <tr>
            <th>Date</th>
            <th>Closing Price (SPJ)</th>
            <th>Net Financing Buy (RZJME)</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
    // 从 URL 查询参数中提取 scode 和 displayCount
    function getQueryParams() {
        const params = new URLSearchParams(window.location.search);
        const scode = params.get('scode') || '300059';  // 默认证券代码 300059
        const displayCount = parseInt(params.get('displayCount')) || 40;  // 默认展示 40 条数据
        return { scode, displayCount };
    }

    // 调用 API 获取数据
    async function fetchData(scode) {
        const url = 'https://datacenter-web.eastmoney.com/api/data/v1/get';
        const params = new URLSearchParams({
            'reportName': 'RPTA_WEB_RZRQ_GGMX',
            'columns': 'ALL',
            'source': 'WEB',
            'sortColumns': 'DATE',
            'sortTypes': '-1',
            'pageNumber': '1',
            'pageSize': '500',
            'filter': `(scode=${scode})`
        });

        const response = await fetch(`${url}?${params}`);
        const data = await response.json();
        return data.result.data;
    }

    // 初始化图表
    function initChart(dates, spjData, rzjmeData) {
        const chartDom = document.getElementById('chart');
        const myChart = echarts.init(chartDom);
        const option = {
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross'
                }
            },
            xAxis: {
                type: 'category',
                data: dates,
                axisLabel: {
                    rotate: 45
                }
            },
            yAxis: [
                {
                    type: 'value',
                    name: 'Net Financing Buy (RZJME)',
                    position: 'left',
                    axisLine: {
                        lineStyle: {
                            color: 'green'
                        }
                    }
                },
                {
                    type: 'value',
                    name: 'Closing Price (SPJ)',
                    position: 'right',
                    axisLine: {
                        lineStyle: {
                            color: 'blue'
                        }
                    }
                }
            ],
            series: [
                {
                    name: 'Net Financing Buy (RZJME)',
                    type: 'bar',
                    data: rzjmeData,
                    itemStyle: {
                        color: 'green'
                    }
                },
                {
                    name: 'Closing Price (SPJ)',
                    type: 'line',
                    yAxisIndex: 1,
                    data: spjData,
                    lineStyle: {
                        color: 'blue',
                        width: 2
                    }
                }
            ]
        };
        myChart.setOption(option);
    }

    // 填充表格数据
    function fillTable(dates, spjData, rzjmeData) {
        const tableBody = document.querySelector('#data-table tbody');
        tableBody.innerHTML = ''; // 清空表格

        dates.forEach((date, index) => {
            const row = `<tr>
                <td>${date}</td>
                <td>${spjData[index]}</td>
                <td>${rzjmeData[index]}</td>
            </tr>`;
            tableBody.innerHTML += row;
        });
    }

    // 主函数，处理数据并展示图表和表格
    async function main() {
        // 获取 URL 参数
        const { scode, displayCount } = getQueryParams();

        // 请求数据
        const data = await fetchData(scode);

        // 仅展示最近的 displayCount 条数据
        const slicedData = data.slice(-displayCount);

        // 提取日期、收盘价（spj）和融资净买入额（rzjme）
        const dates = slicedData.map(item => item.DATE.split(' ')[0]);
        const spjData = slicedData.map(item => parseFloat(item.SPJ));
        const rzjmeData = slicedData.map(item => parseFloat(item.RZJME));

        // 初始化图表和表格
        initChart(dates, spjData, rzjmeData);
        fillTable(dates, spjData, rzjmeData);
    }

    // 执行主函数
    main();
</script>

</body>
</html>