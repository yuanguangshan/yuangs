<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>每日融资融券数据</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
            text-align: left;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        th, td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
        }
        th {
            background-color: #f5f5f5;
            color: #333;
        }
        th.sortable:hover {
            background-color: #e0e0e0;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #f1f1f1;
        }
        .loading {
            text-align: center;
            font-size: 18px;
            margin-top: 20px;
        }
        .title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            cursor: pointer;
        }
        .title h2 {
            margin: 0;
        }
        .date-display {
            font-size: 16px;
            color: #666;
        }
        .highlight-red {
            background-color: #fbe4e6;
        }
        .highlight-green {
            background-color: #e0f7e9;
        }
        .highlight-accelerating {
            color: red; /* 加速融资买入的记录用红色字体显示 */
        }
        .highlight-slowing {
            color: green; /* 减缓融资买入的记录用绿色字体显示 */
        }
    </style>
</head>
<body>

    <div class="title" id="title-link">
        <h2>每日沪深融资数据</h2>
        <div id="date" class="date-display">日期: 加载中...</div>
    </div>

    <div id="table-container" class="loading">正在加载数据...</div>

    <script>
    
       //获取过去几个工作日的日期（使用北京时间）
function getPreviousWorkdays(daysAgo = 2) {
    // 创建一个以北京时间为基础的日期对象
    const today = new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Shanghai" }));
    let dates = [];
    let day = today.getDay(); // 当前是星期几（0=周日, 1=周一, ..., 6=周六）

    for (let i = 1; i <= daysAgo; i++) {
        let offset = i;
        
        // 如果今天是周日，跳过周末，取最近的工作日
        if (day === 0) {
            offset += 1;
        }
        // 如果今天是周一，跳过周末，取上周五
        else if (day === 1) {
            offset += 2;
        }
        let pastDate = new Date(today);
        pastDate.setDate(today.getDate() - offset);
        dates.push(pastDate.toISOString().split('T')[0]);
    }

    return dates;
}


        // 获取最近两个工作日
        const previousWorkdays = getPreviousWorkdays(3);

        // API URL 和参数
        const apiUrl = "https://datacenter-web.eastmoney.com/api/data/v1/get";
        const params = {
            reportName: "RPTA_WEB_RZRQ_GGMX",
            columns: "ALL",
            source: "WEB",
            pageNumber: 1,
            pageSize: 500,
            sortColumns: "rzjme",
            sortTypes: -1,
            pageNo: 1,
            p: 1,
            pageNum: 1,
            _: new Date().getTime()
        };

        // 构造URL参数字符串
        function constructUrl(url, params, date) {
            const queryParams = { ...params, filter: `(DATE='${date}')` };
            const queryString = Object.keys(queryParams)
                .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(queryParams[key])}`)
                .join('&');
            return `${url}?${queryString}`;
        }

        // 获取数据并展示
        async function fetchData() {
            let allData = [];

            // 遍历最近两个工作日的日期，获取数据
            for (let i = 0; i < previousWorkdays.length; i++) {
                const url 
                = constructUrl(apiUrl, params, previousWorkdays[i]);
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    allData = allData.concat(data.result.data);
                } catch (error) {
                    console.error(`Error fetching data for ${previousWorkdays[i]}:`, error);
                }
            }

            // 去重并显示数据
            const uniqueData = deduplicateData(allData);
            displayData(uniqueData);
            displayDate(previousWorkdays[0]);  // 显示最近日期
        }

        // 去重逻辑：根据股票代码去重，并保留最新数据
        function deduplicateData(data) {
            const uniqueDataMap = new Map();

            data.forEach(item => {
                if (!uniqueDataMap.has(item.SCODE)) {
                    uniqueDataMap.set(item.SCODE, item);
                } else {
                    const existingItem = uniqueDataMap.get(item.SCODE);
                    // 如果当前日期比已有项更新，替换掉旧数据
                    if (item.DATE > existingItem.DATE) {
                        uniqueDataMap.set(item.SCODE, item);
                    }
                }
            });

            return Array.from(uniqueDataMap.values());
        }

        // 在标题旁边显示日期
        function displayDate(dateString) {
            const date = new Date(dateString).toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            document.getElementById('date').innerText = `日期: ${date}`;
        }

        // 将数字转换为以“亿”为单位
        function formatToBillion(value) {
            return (value / 1e8).toFixed(2);
        }

        // 展示数据为表格
        function displayData(data) {
            // 过滤融资余额大于 10 亿的股票
            const filteredData = data.filter(item => item.RZYE > 1e9);

            if (filteredData.length === 0) {
                document.getElementById('table-container').innerHTML = '没有满足条件的数据。';
                return;
            }

            let tableHTML = `
                <table id="data-table">
                    <thead>
                        <tr>
                            <th class="sortable" data-column="SCODE" data-order="asc">代码</th>
                            <th class="sortable" data-column="SECNAME" data-order="asc">名称</th>
                            <th class="sortable" data-column="RZYE" data-order="asc">融资余额(亿)</th>
                            <th class="sortable" data-column="RZJME" data-order="asc">净买入</th>
                            <th class="sortable" data-column="SPJ" data-order="asc">收盘</th>
                            <th class="sortable" data-column="ZDF" data-order="asc">涨幅 (%)</th>
                            <th class="sortable" data-column="RZJME3D" data-order="asc">3日净买</th>
                            <th class="sortable" data-column="RZJME5D" data-order="asc">5日净买</th>
                            <th class="sortable" data-column="RZJME10D" data-order="asc">10日净买</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            filteredData.forEach(item => {
                const rzBalanceChange = item.RZJME;  // 融资余额变化（与前一日相比）
                const absChange = Math.abs(rzBalanceChange); // 变化的绝对值

                // 判断加速买入 (3日净买入 > 5日净买入 > 10日净买入)
                const isAcceleratingBuy = item.RZJME3D > item.RZJME5D && item.RZJME5D > item.RZJME10D;

                // 判断减缓买入 (3日净买入 < 5日净买入 < 10日净买入)
                const isSlowingBuy = item.RZJME3D < item.RZJME5D && item.RZJME5D < item.RZJME10D;

                // 设置行的背景颜色，如果变化绝对值大于 1 亿则标红或标绿
                let rowClass = '';
                if (absChange > 1e8) {
                    rowClass = rzBalanceChange > 0 ? 'highlight-red' : 'highlight-green';
                }

                // 根据不同条件应用不同的字体颜色
                let fontClass = '';
                if (isAcceleratingBuy) {
                    fontClass = 'highlight-accelerating';  // 加速买入，红色字体
                } else if (isSlowingBuy) {
                    fontClass = 'highlight-slowing';  // 减缓买入，绿色字体
                }

                tableHTML += `
                    <tr class="${rowClass}">
                        <td class="${fontClass}" onclick="window.location.href='https://blog.want.biz/pages/gg.html?code=${item.SCODE}&days=30&n=7'">${item.SCODE}</td>
                        <td class="${fontClass}">${item.SECNAME}</td>
                        <td class="${fontClass}">${formatToBillion(item.RZYE)}</td>
                        <td class="${fontClass}">${formatToBillion(rzBalanceChange)}</td>
                        <td class="${fontClass}">${item.SPJ}</td>
                        <td class="${fontClass}">${item.ZDF.toFixed(2)}</td>
                        <td class="${fontClass}">${formatToBillion(item.RZJME3D)}</td>
                        <td class="${fontClass}">${formatToBillion(item.RZJME5D)}</td>
                        <td class="${fontClass}">${formatToBillion(item.RZJME10D)}</td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            document.getElementById('table-container').innerHTML = tableHTML;

            // 添加排序功能
            addSortListeners(filteredData);
        }

        // 添加表格排序功能
        function addSortListeners(data) {
            const headers = document.querySelectorAll('.sortable');
            
            headers.forEach(header => {
                header.addEventListener('click', () => {
                    const column = header.getAttribute('data-column');
                    const order = header.getAttribute('data-order');
                    const sortedData = sortData(data, column, order);
                    
                    // 更新排序顺序
                    header.setAttribute('data-order', order === 'asc' ? 'desc' : 'asc');
                    
                    // 重新渲染表格
                    updateTable(sortedData);
                });
            });
        }

        // 数据排序逻辑
        function sortData(data, column, order) {
            return data.slice().sort((a, b) => {
                let aValue = a[column];
                let bValue = b[column];

                // 特别处理数字列
                if (!isNaN(aValue) && !isNaN(bValue)) {
                    aValue = parseFloat(aValue);
                    bValue = parseFloat(bValue);
                }

                if (order === 'asc') {
                    return aValue > bValue ? 1 : -1;
                } else {
                    return aValue < bValue ? 1 : -1;
                }
            });
        }

        // 更新表格内容
        function updateTable(data) {
            let tableBody = '';
            data.forEach(item => {
                const rzBalanceChange = item.RZJME;
                const absChange = Math.abs(rzBalanceChange);
                let rowClass = '';

                if (absChange > 1e8) {
                    rowClass = rzBalanceChange > 0 ? 'highlight-red' : 'highlight-green';
                }

                const isAcceleratingBuy = item.RZJME3D > item.RZJME5D && item.RZJME5D > item.RZJME10D;
                const isSlowingBuy = item.RZJME3D < item.RZJME5D && item.RZJME5D < item.RZJME10D;
                
                let fontClass = '';
                if (isAcceleratingBuy) {
                    fontClass = 'highlight-accelerating';
                } else if (isSlowingBuy) {
                    fontClass = 'highlight-slowing';
                }

                tableBody += `
                    <tr class="${rowClass}">
                        <td class="${fontClass}" onclick="window.location.href='https://blog.want.biz/pages/gg.html?code=${item.SCODE}&days=30&n=7'">${item.SCODE}</td>
                        <td class="${fontClass}">${item.SECNAME}</td>
                        <td class="${fontClass}">${formatToBillion(item.RZYE)}</td>
                        <td class="${fontClass}">${formatToBillion(rzBalanceChange)}</td>
                        <td class="${fontClass}">${item.SPJ}</td>
                        <td class="${fontClass}">${item.ZDF.toFixed(2)}</td>
                        <td class="${fontClass}">${formatToBillion(item.RZJME3D)}</td>
                        <td class="${fontClass}">${formatToBillion(item.RZJME5D)}</td>
                        <td class="${fontClass}">${formatToBillion(item.RZJME10D)}</td>
                    </tr>
                `;
            });

            document.querySelector('#data-table tbody').innerHTML = tableBody;
        }

        // 页面加载时调用
        fetchData();

        // 点击标题跳转到指定页面
        document.getElementById('title-link').addEventListener('click', () => {
            const targetUrl = `https://emdata.eastmoney.com/rzrq/index.html`;
            window.location.href = targetUrl;
        });
    </script>

</body>
</html>
