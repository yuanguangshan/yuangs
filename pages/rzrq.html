<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>每日融资融券数据</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
            text-align: left;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        th, td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
            cursor: pointer; /* 添加光标指示 */
        }
        th {
            background-color: #f5f5f5;
            color: #333;
        }
        th.sortable:hover {
            background-color: #e0e0e0; /* 鼠标悬停时的效果 */
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #f1f1f1;
        }
        .loading {
            text-align: center;
            font-size: 18px;
            margin-top: 20px;
        }
        .title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            cursor: pointer; /* 添加光标指示 */
        }
        .title h2 {
            margin: 0;
        }
        .date-display {
            font-size: 16px;
            color: #666;
        }
        /* 红涨绿跌的颜色 */
        .highlight-red {
            background-color: #fbe4e6; /* 红色高亮 (涨) */
        }
        .highlight-green {
            background-color: #e0f7e9; /* 绿色高亮 (跌) */
        }
        /* 波浪线样式 */
        .strikethrough {
            text-decoration: line-through;
        }
        /* 绿色小点 */
        .green-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #28a745;
            border-radius: 50%;
            margin-left: 5px;
        }
    </style>
</head>
<body>

    <div class="title" id="title-link">
        <h2>每日沪深融资数据</h2>
        <div id="date" class="date-display">日期: 加载中...</div>
    </div>

    <div id="table-container" class="loading">正在加载数据...</div>

    <script>
        // 获取前一个工作日
        function getPreviousWorkday(daysAgo = 1) {
            const today = new Date();
            let day = today.getDay(); // 0 (Sun) -> 6 (Sat)
            let offset = daysAgo; // 默认偏移指定天数

            // 如果今天是周日
            if (day === 0) {
                offset += 1;
            }
            // 如果今天是周一，算上周末
            else if (day === 1) {
                offset += 2;
            }
            today.setDate(today.getDate() - offset);

            return today.toISOString().split('T')[0]; // 返回YYYY-MM-DD格式
        }

        // 获取过去三天的工作日日期
        const previousWorkdays = [
            getPreviousWorkday(1),
            getPreviousWorkday(2),
            getPreviousWorkday(3)
        ];

        // API URL 和参数
        const apiUrl = "https://datacenter-web.eastmoney.com/api/data/v1/get";
        const params = {
            reportName: "RPTA_WEB_RZRQ_GGMX",
            columns: "ALL",
            source: "WEB",
            pageNumber: 1,
            pageSize: 500,
            sortColumns: "RZJME",
            sortTypes: -1,
            pageNo: 1,
            p: 1,
            pageNum: 1,
            _: new Date().getTime()
        };

        // 构造URL参数字符串
        function constructUrl(date) {
            const queryParams = { ...params, filter: `(DATE='${date}')` };
            const queryString = Object.keys(queryParams)
                .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(queryParams[key])}`)
                .join('&');
            return `${apiUrl}?${queryString}`;
        }

        // 获取数据并展示
        async function fetchData() {
            let allData = [];

            // 遍历最近三天的日期，获取数据
            for (let i = 0; i < previousWorkdays.length; i++) {
                const url = constructUrl(previousWorkdays[i]);
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    allData = allData.concat(data.result.data);
                } catch (error) {
                    console.error(`Error fetching data for ${previousWorkdays[i]}:`, error);
                }
            }

            // 去重并显示数据
            const uniqueData = deduplicateData(allData);
            displayData(uniqueData);
            displayDate(previousWorkdays[0]);  // 显示最近日期
        }

        // 去重逻辑：根据股票代码去重并保留最新数据
        function deduplicateData(data) {
            const uniqueDataMap = new Map();
            data.forEach(item => {
                if (!uniqueDataMap.has(item.SCODE)) {
                    uniqueDataMap.set(item.SCODE, item);
                } else {
                    const existingItem = uniqueDataMap.get(item.SCODE);
                    if (item.DATE > existingItem.DATE) {
                        uniqueDataMap.set(item.SCODE, item);
                    }
                }
            });
            return Array.from(uniqueDataMap.values());
        }

        // 在标题旁边显示日期
        function displayDate(dateString) {
            const date = new Date(dateString).toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            document.getElementById('date').innerText = `日期: ${date}`;
        }

        // 将数字转换为以“亿”为单位
        function formatToBillion(value) {
            return (value / 1e8).toFixed(2);
        }

        // 展示数据为表格
        function displayData(data) {
            const latestDate = previousWorkdays[0];
            const secondLatestDate = previousWorkdays[1];

            // 过滤融资余额大于 10 亿的股票
            const filteredData = data.filter(item => item.RZYE > 1e9);

            if (filteredData.length === 0) {
                document.getElementById('table-container').innerHTML = '没有满足条件的数据。';
                return;
            }

            let tableHTML = `
                <table id="data-table">
                    <thead>
                        <tr>
                            <th class="sortable" data-column="SCODE" data-order="asc">代码</th>
                            <th class="sortable" data-column="SECNAME" data-order="asc">名称</th>
                            <th class="sortable" data-column="RZYE" data-order="asc">余额(亿)</th>
                            <th class="sortable" data-column="RZJME" data-order="asc">变化(亿)</th>
                            <th class="sortable" data-column="SPJ" data-order="asc">收盘</th>
                            <th class="sortable" data-column="ZDF" data-order="asc">涨幅 (%)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            filteredData.forEach(item => {
                const rzBalanceChange = item.RZJME;  // 融资余额变化（与前一日相比）
                const absChange = Math.abs(rzBalanceChange); // 变化的绝对值

                // 设置行的背景颜色，如果变化绝对值大于 1 亿则标红或标绿
                let rowClass = '';
                if (absChange > 1e8) {
                    rowClass = rzBalanceChange > 0 ? 'highlight-red' : 'highlight-green';
                }

                // 判断是否是最新日期
                let secName = item.SECNAME;
                let greenDot = '';

                // 如果是最新日期，显示绿色小点
                if (item.DATE === latestDate) {
                    greenDot = `<span class="green-dot"></span>`;
                } 
                // 如果比最新日期早一天，名称加波浪线
                else if (item.DATE === secondLatestDate) {
                    secName = `<del>${secName}</del>`;
                }

                tableHTML += `
                    <tr class="${rowClass}">
                        <td onclick="window.location.href='https://emdata.eastmoney.com/rzrq/singlestockrzrq.html?fc=${item.SCODE}'">${item.SCODE}</td>
                        <td>${secName} ${greenDot}</td>
                        <td>${formatToBillion(item.RZYE)}</td>
                        <td>${formatToBillion(rzBalanceChange)}</td>
                        <td>${item.SPJ}</td>
                        <td>${item.ZDF.toFixed(2)}</td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            document.getElementById('table-container').innerHTML = tableHTML;

            // 添加排序功能
            addSortListeners(filteredData);
        }

        // 添加表格排序功能
        function addSortListeners(data) {
            const headers = document.querySelectorAll('.sortable');
            
            headers.forEach(header => {
                header.addEventListener('click', () => {
                    const column = header.getAttribute('data-column');
                    const order = header.getAttribute('data-order');
                    const sortedData = sortData(data, column, order);
                    
                    // 更新排序顺序
                    header.setAttribute('data-order', order === 'asc' ? 'desc' : 'asc');
                    
                    // 重新渲染表格
                    updateTable(sortedData);
                });
            });
        }

        // 数据排序逻辑
        function sortData(data, column, order) {
            return data.slice().sort((a, b) => {
                let aValue = a[column];
                let bValue = b[column];

                // 特别处理数字列
                if (!isNaN(aValue) && !isNaN(bValue)) {
                    aValue = parseFloat(aValue);
                    bValue = parseFloat(bValue);
                }

                if (order === 'asc') {
                    return aValue > bValue ? 1 : -1;
                } else {
                    return aValue < bValue ? 1 : -1;
                }
            });
        }

        // 更新表格内容
        function updateTable(data) {
            let tableBody = '';
            const latestDate = previousWorkdays[0];
            const secondLatestDate = previousWorkdays[1];

            data.forEach(item => {
                const rzBalanceChange = item.RZJME;
                const absChange = Math.abs(rzBalanceChange);
                let rowClass = '';

                if (absChange > 1e8) {
                    rowClass = rzBalanceChange > 0 ? 'highlight-red' : 'highlight-green';
                }

                let secName = item.SECNAME;
                let greenDot = '';

                // 如果是最新日期，显示绿色小点
                if (item.DATE === latestDate) {
                    greenDot = `<span class="green-dot"></span>`;
                } 
                // 如果比最新日期早一天，名称加波浪线
                else if (item.DATE === secondLatestDate) {
                    secName = `<del>${secName}</del>`;
                }

                tableBody += `
                    <tr class="${rowClass}">
                        <td onclick="window.location.href='https://wap.eastmoney.com/quote/stock/0.${item.SCODE}.html'">${item.SCODE}</td>
                        <td>${secName} ${greenDot}</td>
                        <td>${formatToBillion(item.RZYE)}</td>
                        <td>${formatToBillion(rzBalanceChange)}</td>
                        <td>${item.SPJ}</td>
                        <td>${item.ZDF.toFixed(2)}</td>
                    </tr>
                `;
            });

            document.querySelector('#data-table tbody').innerHTML = tableBody;
        }

        // 页面加载时调用
        fetchData();

        // 点击标题跳转到指定页面
        document.getElementById('title-link').addEventListener('click', () => {
            const targetUrl = `https://emdata.eastmoney.com/rzrq/index.html`;
            window.location.href = targetUrl;
        });
    </script>

</body>
</html>