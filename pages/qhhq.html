<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœŸè´§è¡Œæƒ…WSJ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: rgba(0, 0, 0, 0.7);
            background-image: url('/pics/IMG_4151.jpeg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #fff;
            margin: 0;
            padding: 16px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 12px;
            backdrop-filter: blur(5px);
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .title {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .update-info {
            font-size: 0.8rem;
            color: #888;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .tab-button {
            background-color: transparent;
            border: none;
            color: #888;
            padding: 10px 20px;
            font-size: 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .tab-button.active {
            color: #fff;
            border-bottom: 2px solid #00c853;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }
        
        .card {
            background-color: rgba(60, 64, 67, 0.85);
            border-radius: 12px;
            padding: 16px;
            transition: transform 0.2s, background-color 0.3s;
            position: relative;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        .card:hover {
            transform: translateY(-5px);
            background-color: rgba(45, 48, 50, 0.9);
        }
        
        .star-button {
            position: absolute;
            top: 12px;
            right: 12px;
            background: transparent;
            border: none;
            color: #888;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 10;
        }
        
        .star-button.active {
            color: #ffeb3b;
        }
        
        .card-title {
            font-size: 1.2rem;
            margin-bottom: 10px;
            margin-right: 30px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .card-price {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .card-change {
            font-size: 1.2rem;
            margin-bottom: 15px;
        }
        
        .negative {
            color: #00c853;
        }
        
        .positive {
            color: #ff5252;
        }
        
        .card-details {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #888;
            position: relative;
        }
        
        /* æ·»åŠ è¡Œæƒ…å›¾æ ‡æŒ‰é’®æ ·å¼ */
        .chart-button {
            position: absolute;
            bottom: 0;
            right: 0;
            background: transparent;
            border: none;
            color: #00c853;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 3px;
            padding: 3px 6px;
            border-radius: 4px;
        }
        
        .chart-button:hover {
            background-color: rgba(0, 200, 83, 0.15);
            color: #38ff92;
        }
        
        .error-message {
            color: #ff5252;
            padding: 20px;
            font-size: small;
            text-align: center;
            background-color: rgba(255, 82, 82, 0.1);
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .loading {
            text-align: center;
            padding: 5px;
            font-size: small;
            margin-top: -35px;
            color: #d0dc95;
        }
        
        .watchlist-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .watchlist-sort {
            display: flex;
            gap: 8px;
        }
        
        .sort-button {
            background-color: #333;
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .watchlist-empty {
            text-align: center;
            padding: 40px;
            color: #888;
            background-color: #1a1a1a;
            border-radius: 12px;
        }
        
        .drag-handle {
            display: none;
            position: absolute;
            top: 10px;
            left: 10px;
            cursor: grab;
            color: #888;
            font-size: 1.2rem;
            z-index: 10;
        }
        
        .watchlist-mode .card {
            padding-left: 35px;
        }
        
        .watchlist-mode .drag-handle {
            display: block;
        }
        
        .drag-ghost {
            opacity: 0.5;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
            
            .card-price {
                font-size: 1.8rem;
            }
            
            .card-change {
                font-size: 1.1rem;
            }
            
            .chart-button {
                font-size: 1rem;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 8px;
            }
            
            .container {
                padding: 12px;
                border-radius: 10px;
            }
            
            .header {
                margin-bottom: 12px;
            }
            
            .title {
                font-size: 1.3rem;
            }
            
            .grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .card {
                padding: 10px;
                border-radius: 10px;
                transform: none;
            }
            
            .card:hover {
                transform: translateY(-3px);
            }
            
            .card-title {
                font-size: 0.9rem;
                margin-bottom: 6px;
                white-space: normal;
                height: auto;
                min-height: 36px;
                line-height: 1.2;
            }
            
            .card-price {
                font-size: 1.4rem;
                margin-bottom: 4px;
            }
            
            .card-change {
                font-size: 0.85rem;
                margin-bottom: 8px;
            }
            
            .card-details {
                font-size: 0.8rem;
                flex-direction: column;
                gap: 4px;
                padding-right: 30px; /* ä¸ºè¡Œæƒ…æŒ‰é’®ç•™å‡ºç©ºé—´ */
            }
            
            .star-button {
                top: 8px;
                right: 8px;
                font-size: 1rem;
            }
            
            .chart-button {
                font-size: 0.9rem;
                padding: 2px 4px;
                bottom: 0;
                right: 0;
            }
            
            .tab-button {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            .footer {
                margin-top: 20px;
            }
        }
        
        .footer {
            margin-top: 40px;
            padding: 15px 0;
            border-top: 1px solid #333;
            text-align: center;
        }
        
        .footer p {
            margin: 0;
            font-size: 0.8rem;
            color: #888;
        }
        
        /* æ–°é—»åŒºåŸŸæ ·å¼ - è°ƒæ•´å */
        .news-section {
            margin-top: 40px;
        }
        
        .news-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .news-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0;
            color: #fff;
        }
        
        .news-controls {
            display: flex;
            gap: 10px;
        }
        
        .news-button {
            background-color: rgba(0, 200, 83, 0.2);
            border: 1px solid rgba(0, 200, 83, 0.5);
            color: #00c853;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .news-button:hover {
            background-color: rgba(0, 200, 83, 0.3);
            box-shadow: 0 2px 8px rgba(0, 200, 83, 0.3);
        }
        
        .news-item {
            background-color: rgba(60, 66, 74, 0.85);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            transition: transform 0.2s, background-color 0.3s;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(90, 200, 120, 0.2);
        }
        
        .news-item:hover {
            transform: translateY(-3px);
            background-color: rgba(65, 72, 80, 0.9);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
            border-color: rgba(90, 200, 120, 0.3);
        }
        
        .news-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .news-author {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .news-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid rgba(90, 200, 120, 0.3);
        }
        
        .news-author-name {
            font-size: 0.9rem;
            color: #a6e0af;
            font-weight: 500;
        }
        
        .news-time {
            font-size: 0.8rem;
            color: #aaa;
        }
        
        .news-content {
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 0;
            color: #f0f0f0;
        }
        
        .news-footer {
            text-align: center;
            margin-top: 20px;
        }
        
        .news-empty {
            text-align: center;
            padding: 40px;
            color: #bbb;
            background-color: rgba(50, 55, 60, 0.7);
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid rgba(90, 200, 120, 0.15);
        }
        
        /* æ–‡ç« é“¾æ¥æ ·å¼ - è°ƒæ•´å */
        .news-article-link {
            margin-top: 12px;
            text-align: right;
        }
        
        .article-link-button {
            display: inline-block;
            background-color: rgba(0, 200, 83, 0.2);
            border: 1px solid rgba(0, 200, 83, 0.5);
            color: #00d15b;
            padding: 6px 12px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.85rem;
            transition: all 0.3s;
        }
        
        .article-link-button:hover {
            background-color: rgba(0, 200, 83, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 200, 83, 0.3);
        }
        
        @media (max-width: 480px) {
            .news-item {
                padding: 12px;
                border-radius: 8px;
                margin-bottom: 10px;
            }
            
            .news-title {
                font-size: 1.2rem;
            }
            
            .news-content {
                font-size: 0.9rem;
                line-height: 1.5;
            }
            
            .news-button {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            
            .article-link-button {
                padding: 4px 10px;
                font-size: 0.8rem;
            }
            
            .news-article-link {
                margin-top: 8px;
            }
        }
        
        /* é‡ç‚¹æ–°é—»æ ·å¼ */
        .important-news {
            border: 1px solid rgba(255, 215, 0, 0.4);
            background-color: rgba(65, 72, 80, 0.95);
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.15);
        }
        
        .news-important-tag {
            background-color: rgba(255, 215, 0, 0.2);
            color: #ffd700;
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">æœŸè´§è¡Œæƒ…</div>
            <div class="update-info">
                æœ€åæ›´æ–°: <span id="last-update">-</span>
                <div>è‡ªåŠ¨åˆ·æ–°: <span id="countdown">20</span>s</div>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab-button" data-tab="watchlist">è‡ªé€‰</button>
            <button class="tab-button active" data-tab="commodity">å•†å“</button>
            <button class="tab-button" data-tab="forex">å¤–æ±‡</button>
            <button class="tab-button" data-tab="bond">å€ºåˆ¸</button>
            <button class="tab-button" data-tab="news">èµ„è®¯</button>
            <!-- <button class="tab-button" data-tab="watchlist">è‡ªé€‰</button> -->
        </div>
        
        <div id="commodity-tab" class="tab-content active">
            <div id="commodity-status" class="loading">åŠ è½½æ•°æ®ä¸­...</div>
            <div id="commodity-grid" class="grid"></div>
        </div>
        
        <div id="forex-tab" class="tab-content">
            <div id="forex-status" class="loading">åŠ è½½æ•°æ®ä¸­...</div>
            <div id="forex-grid" class="grid"></div>
        </div>
        
        <div id="bond-tab" class="tab-content">
            <div id="bond-status" class="loading">åŠ è½½æ•°æ®ä¸­...</div>
            <div id="bond-grid" class="grid"></div>
        </div>
        
        <div id="watchlist-tab" class="tab-content">
            <div class="watchlist-controls">
                <button id="edit-watchlist" class="sort-button">ç¼–è¾‘</button>
                <div class="watchlist-sort">
                    <button id="sort-name" class="sort-button">æŒ‰åç§°</button>
                    <button id="sort-change" class="sort-button">æŒ‰æ¶¨è·Œå¹…</button>
                </div>
            </div>
            <div id="watchlist-status" class="loading">åŠ è½½è‡ªé€‰...</div>
            <div id="watchlist-grid" class="grid"></div>
        </div>
        
        <div id="news-tab" class="tab-content">
            <div class="watchlist-controls">
                <button id="toggle-important-news" class="sort-button">æ˜¾ç¤ºå…¨éƒ¨</button>
                <div class="watchlist-sort">
                    <button id="refresh-news-tab" class="sort-button">åˆ·æ–°</button>
                </div>
            </div>
            <div id="news-tab-status" class="loading">åŠ è½½èµ„è®¯ä¸­...</div>
            <div id="news-tab-container"></div>
            <div class="news-footer">
                <button id="load-more-news-tab" class="news-button">åŠ è½½æ›´å¤š</button>
            </div>
        </div>
    </div>

    <!-- æ–°é—»åŒºåŸŸ -->
    <div class="news-section">
        <div class="container">
            <div class="news-header">
                <h2 class="news-title">7x24å¿«è®¯</h2>
                <div class="news-controls">
                    <button id="refresh-news" class="news-button">åˆ·æ–°</button>
                </div>
            </div>
            <div id="news-status" class="loading">åŠ è½½æ–°é—»ä¸­...</div>
            <div id="news-container"></div>
            <div class="news-footer">
                <button id="load-more-news" class="news-button">åŠ è½½æ›´å¤š</button>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p>Created by è‹‘å¹¿å±± @2025</p>
        </div>
    </footer>

    <script>
        // API URLs
        const API_URLS = {
            commodity: 'https://api-ddc-wscn.awtmt.com/market/rank?market_type=forexdata&stk_type=commodity&order_by=none&sort_field=px_change_rate&limit=300&fields=prod_name%2Cprod_en_name%2Cprod_code%2Csymbol%2Clast_px%2Cpx_change%2Cpx_change_rate%2Chigh_px%2Clow_px%2Cweek_52_high%2Cweek_52_low%2Cprice_precision%2Cupdate_time',
            forex: 'https://api-ddc-wscn.awtmt.com/market/rank?market_type=forexdata&stk_type=forex&order_by=none&sort_field=px_change_rate&limit=100&fields=prod_name%2Cprod_en_name%2Cprod_code%2Csymbol%2Clast_px%2Cpx_change%2Cpx_change_rate%2Chigh_px%2Clow_px%2Cweek_52_high%2Cweek_52_low%2Cprice_precision%2Cupdate_time',
            bond: 'https://api-ddc-wscn.awtmt.com/market/rank?market_type=forexdata&stk_type=bond&order_by=none&sort_field=px_change_rate&limit=100&fields=prod_name%2Cprod_en_name%2Cprod_code%2Csymbol%2Clast_px%2Cpx_change%2Cpx_change_rate%2Chigh_px%2Clow_px%2Cweek_52_high%2Cweek_52_low%2Cprice_precision%2Cupdate_time',
            news: 'https://api-one-wscn.awtmt.com/apiv1/content/lives?channel=global-channel&accept=live%2Cvip-live&limit=20&cursor='
        };
        
        // Store all market data
        const marketData = {
            commodity: [],
            forex: [],
            bond: []
        };
        
        // Store news data
        let newsData = [];
        let newsCursor = '';
        let isLoadingNews = false;
        let showImportantOnly = true; // æ˜¯å¦åªæ˜¾ç¤ºé‡ç‚¹æ–°é—»çš„æ ‡å¿—
        
        // èµ„è®¯è‡ªåŠ¨åˆ·æ–°è®¡æ—¶å™¨
        let newsRefreshTimer = null;
        let newsCountdown = 30; // èµ„è®¯åˆ·æ–°å€’è®¡æ—¶ï¼Œ30ç§’
        
        // Watchlist management
        let watchlist = [];
        let isEditMode = false;
        
        // Tracking active fetches
        let activeFetches = {
            commodity: null,
            forex: null,
            bond: null
        };
        
        // Load watchlist from localStorage
        function loadWatchlist() {
            const savedWatchlist = localStorage.getItem('marketWatchlist');
            if (savedWatchlist) {
                try {
                    watchlist = JSON.parse(savedWatchlist);
                } catch (e) {
                    console.error('Failed to parse watchlist from localStorage', e);
                    watchlist = [];
                }
            }
        }
        
        // Save watchlist to localStorage
        function saveWatchlist() {
            localStorage.setItem('marketWatchlist', JSON.stringify(watchlist));
        }
        
        // Add or remove item from watchlist
        function toggleWatchlist(type, symbol) {
            const index = watchlist.findIndex(item => item.symbol === symbol);
            
            if (index !== -1) {
                // Remove from watchlist
                watchlist.splice(index, 1);
            } else {
                // Find the item data from the marketData
                const item = marketData[type].find(item => item[3] === symbol);
                if (item) {
                    watchlist.push({
                        type,
                        symbol,
                        order: watchlist.length // Add at the end by default
                    });
                }
            }
            
            saveWatchlist();
            renderWatchlist();
            
            // Also update the star in the original tab
            const starButton = document.querySelector(`.${type}-card[data-symbol="${symbol}"] .star-button`);
            if (starButton) {
                starButton.classList.toggle('active', isInWatchlist(symbol));
            }
        }
        
        // Check if an item is in the watchlist
        function isInWatchlist(symbol) {
            return watchlist.some(item => item.symbol === symbol);
        }
        
        // Format date/time
        function formatDateTime(timestamp) {
            const date = new Date(timestamp * 1000);
            return date.toLocaleString('zh-CN');
        }
        
        // Format price based on precision
        function formatPrice(price, precision) {
            precision = parseInt(precision) || 2;
            return parseFloat(price).toFixed(precision);
        }
        
        // Update countdown timer
        function updateCountdown(seconds) {
            document.getElementById('countdown').textContent = seconds;
        }
        
        // Show status message
        function showStatusMessage(tabId, message, isError = false) {
            const statusElement = document.getElementById(`${tabId}-status`);
            statusElement.textContent = message;
            statusElement.className = isError ? 'error-message' : 'loading';
            statusElement.style.display = message ? 'block' : 'none';
        }
        
        // Get market page URL for the symbol
        function getMarketPageUrl(symbol) {
            return `https://wallstreetcn.com/markets/codes/${symbol}.OTC`;
        }
        
        // Create a card for a market item
        function createCard(type, item, isWatchlist = false) {
            const name = item[0];
            const symbol = item[3];
            const price = parseFloat(item[4]);
            const change = parseFloat(item[5]);
            const changeRate = parseFloat(item[6]);
            const high = parseFloat(item[7]);
            const low = parseFloat(item[8]);
            const precision = item[11];
            const updateTime = parseInt(item[12]);
            const isPositive = change >= 0;
            
            const card = document.createElement('div');
            card.className = `card ${type}-card`;
            card.dataset.symbol = symbol;
            card.dataset.type = type;
            
            // Handle icon for the watchlist mode
            const dragHandle = `<div class="drag-handle" draggable="true">â˜°</div>`;
            
            // Star button for watchlist
            const starActive = isInWatchlist(symbol) ? 'active' : '';
            
            // æ·»åŠ è¡Œæƒ…é“¾æ¥æŒ‰é’®
            const chartUrl = getMarketPageUrl(symbol);
            
            card.innerHTML = `
                ${isWatchlist ? dragHandle : ''}
                <button class="star-button ${starActive}" title="${starActive ? 'ä»è‡ªé€‰ä¸­åˆ é™¤' : 'æ·»åŠ åˆ°è‡ªé€‰'}">â˜…</button>
                <div class="card-title">${name} (${symbol})</div>
                <div class="card-price ${isPositive ? 'positive' : 'negative'}">${formatPrice(price, precision)}</div>
                <div class="card-change ${isPositive ? 'positive' : 'negative'}">
                    ${change >= 0 ? '+' : ''}${formatPrice(change, precision)} ${changeRate >= 0 ? '+' : ''}${changeRate.toFixed(2)}%
                </div>
                <div class="card-details">
                    <span>æœ€é«˜: ${formatPrice(high, precision)}</span>
                    <span>æœ€ä½: ${formatPrice(low, precision)}</span>
                    <a href="${chartUrl}" class="chart-button" title="æŸ¥çœ‹è¡Œæƒ…" target="_blank">
                        <span>ğŸ’¹</span>
                    </a>
                </div>
            `;
            
            // Add event listener for the star button
            const starButton = card.querySelector('.star-button');
            starButton.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleWatchlist(type, symbol);
            });
            
            // Add drag and drop functionality for watchlist items
            if (isWatchlist) {
                const handle = card.querySelector('.drag-handle');
                
                handle.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', symbol);
                    setTimeout(() => {
                        card.classList.add('drag-ghost');
                    }, 0);
                });
                
                handle.addEventListener('dragend', () => {
                    card.classList.remove('drag-ghost');
                });
                
                card.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });
                
                card.addEventListener('dragenter', (e) => {
                    e.preventDefault();
                    card.style.borderTop = '2px solid #00c853';
                });
                
                card.addEventListener('dragleave', () => {
                    card.style.borderTop = '';
                });
                
                card.addEventListener('drop', (e) => {
                    e.preventDefault();
                    card.style.borderTop = '';
                    
                    const draggedSymbol = e.dataTransfer.getData('text/plain');
                    if (draggedSymbol === symbol) return; // Same card, do nothing
                    
                    // Reorder the watchlist
                    const draggedIndex = watchlist.findIndex(item => item.symbol === draggedSymbol);
                    const dropIndex = watchlist.findIndex(item => item.symbol === symbol);
                    
                    if (draggedIndex !== -1 && dropIndex !== -1) {
                        const [removed] = watchlist.splice(draggedIndex, 1);
                        watchlist.splice(dropIndex, 0, removed);
                        
                        // Update orders
                        watchlist.forEach((item, index) => {
                            item.order = index;
                        });
                        
                        saveWatchlist();
                        renderWatchlist();
                    }
                });
            }
            
            return card;
        }
        
        // Render data cards for a specific tab
        function renderCards(tabId, data) {
            const grid = document.getElementById(`${tabId}-grid`);
            grid.innerHTML = '';
            
            if (!data || !data.length) {
                showStatusMessage(tabId, 'æ²¡æœ‰å¯ç”¨æ•°æ®', true);
                return;
            }
            
            // Hide status message
            showStatusMessage(tabId, '');
            
            data.forEach(item => {
                const card = createCard(tabId, item);
                grid.appendChild(card);
            });
        }
        
        // Render the watchlist
        function renderWatchlist() {
            const grid = document.getElementById('watchlist-grid');
            grid.innerHTML = '';
            
            if (isEditMode) {
                grid.classList.add('watchlist-mode');
            } else {
                grid.classList.remove('watchlist-mode');
            }
            
            if (!watchlist.length) {
                showStatusMessage('watchlist', '');
                
                const emptyMessage = document.createElement('div');
                emptyMessage.className = 'watchlist-empty';
                emptyMessage.textContent = 'æ‚¨çš„è‡ªé€‰åˆ—è¡¨æ˜¯ç©ºçš„ã€‚è¯·åœ¨å…¶ä»–æ ‡ç­¾é¡µä¸­ç‚¹å‡»æ˜Ÿæ ‡æ·»åŠ é¡¹ç›®åˆ°è‡ªé€‰ã€‚';
                grid.appendChild(emptyMessage);
                return;
            }
            
            showStatusMessage('watchlist', '');
            
            // Sort watchlist by order (default)
            const sortedWatchlist = [...watchlist].sort((a, b) => a.order - b.order);
            
            sortedWatchlist.forEach(item => {
                const itemData = marketData[item.type].find(data => data[3] === item.symbol);
                if (itemData) {
                    const card = createCard(item.type, itemData, true);
                    grid.appendChild(card);
                }
            });
        }
        
        // Sort watchlist by name
        function sortWatchlistByName() {
            const grid = document.getElementById('watchlist-grid');
            const cards = Array.from(grid.children);
            
            cards.sort((a, b) => {
                const nameA = a.querySelector('.card-title').textContent;
                const nameB = b.querySelector('.card-title').textContent;
                return nameA.localeCompare(nameB);
            });
            
            grid.innerHTML = '';
            cards.forEach(card => grid.appendChild(card));
            
            // Update order in the watchlist
            updateWatchlistOrder();
        }
        
        // Sort watchlist by change rate
        function sortWatchlistByChange() {
            const grid = document.getElementById('watchlist-grid');
            const cards = Array.from(grid.children);
            
            cards.sort((a, b) => {
                const changeA = parseFloat(a.querySelector('.card-change').textContent.split('%')[0].split(' ').pop());
                const changeB = parseFloat(b.querySelector('.card-change').textContent.split('%')[0].split(' ').pop());
                return changeB - changeA; // Descending order (highest first)
            });
            
            grid.innerHTML = '';
            cards.forEach(card => grid.appendChild(card));
            
            // Update order in the watchlist
            updateWatchlistOrder();
        }
        
        // Update the order in the watchlist based on current DOM order
        function updateWatchlistOrder() {
            const grid = document.getElementById('watchlist-grid');
            const cards = Array.from(grid.children);
            
            cards.forEach((card, index) => {
                const symbol = card.dataset.symbol;
                const watchlistItem = watchlist.find(item => item.symbol === symbol);
                if (watchlistItem) {
                    watchlistItem.order = index;
                }
            });
            
            saveWatchlist();
        }
        
        // Fetch data from API
        async function fetchData(tabId) {
            // Cancel previous fetch if still pending
            if (activeFetches[tabId]) {
                activeFetches[tabId].aborted = true;
            }
            
            // Create a new AbortController for this request
            const controller = new AbortController();
            activeFetches[tabId] = { controller, aborted: false };
            
            try {
                showStatusMessage(tabId, 'è·å–æ•°æ®ä¸­...');
                
                const url = API_URLS[tabId];
                const response = await fetch(url, { signal: controller.signal });
                
                // If this request was aborted, don't proceed
                if (activeFetches[tabId].aborted) {
                    return [];
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Update last update time
                document.getElementById('last-update').textContent = new Date().toLocaleTimeString('zh-CN');
                
                if (data && data.code === 20000 && data.data && data.data.candle) {
                    // Store the data for the watchlist to use
                    marketData[tabId] = data.data.candle;
                    return data.data.candle;
                } else {
                    throw new Error('Invalid data format');
                }
            } catch (error) {
                // Don't show errors for aborted requests
                if (error.name === 'AbortError' || activeFetches[tabId].aborted) {
                    return [];
                }
                
                console.error(`è·å–${tabId}æ•°æ®å¤±è´¥:`, error);
                showStatusMessage(tabId, `æ²¡æœ‰æ–°æ•°æ®ï¼`, true);
                return [];
            } finally {
                // Clear the active fetch reference
                activeFetches[tabId] = null;
            }
        }
        
        // Update data for a specific tab
        async function updateTabData(tabId) {
            const data = await fetchData(tabId);
            renderCards(tabId, data);
            
            // If watchlist tab is active, update it too with the new data
            if (document.querySelector('.tab-button[data-tab="watchlist"]').classList.contains('active')) {
                renderWatchlist();
            }
        }
        
        // Update all tab data
        async function updateAllData() {
            // Get the active tab
            const activeTab = document.querySelector('.tab-button.active').getAttribute('data-tab');
            
            if (activeTab === 'watchlist') {
                // For watchlist, make sure we update all market data first
                await Promise.all([
                    updateTabData('commodity'),
                    updateTabData('forex'),
                    updateTabData('bond')
                ]);
                renderWatchlist();
            } else {
                // Update the active tab first for better user experience
                await updateTabData(activeTab);
                
                // Then update other tabs in the background
                for (const tabId of Object.keys(marketData)) {
                    if (tabId !== activeTab) {
                        updateTabData(tabId);
                    }
                }
            }
            
            // Reset and start countdown
            let count = 20;
            updateCountdown(count);
            
            const timer = setInterval(() => {
                count--;
                updateCountdown(count);
                
                if (count <= 0) {
                    clearInterval(timer);
                }
            }, 1000);
        }
        
        // Fetch news data from API
        async function fetchNews(refresh = false) {
            if (isLoadingNews) return;
            
            isLoadingNews = true;
            showStatusMessage('news', 'è·å–æ–°é—»ä¸­...');
            
            try {
                // Reset cursor if refreshing
                if (refresh) {
                    newsCursor = '';
                }
                
                // æ„å»ºURLï¼Œæ³¨æ„åŠ å…¥clientå’Œfirst_pageå‚æ•°
                const url = API_URLS.news + newsCursor + (newsCursor ? '&first_page=false' : '') + '&client=pc';
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data && data.code === 20000 && data.data) {
                    // If refreshing, replace the data, otherwise append
                    if (refresh) {
                        newsData = data.data.items || [];
                    } else {
                        // ç¡®ä¿ä¸é‡å¤æ·»åŠ 
                        const newItems = (data.data.items || []).filter(item => 
                            !newsData.some(existing => existing.id === item.id)
                        );
                        newsData = [...newsData, ...newItems];
                    }
                    
                    // Store the next_cursor for pagination
                    if (data.data.next_cursor) {
                        newsCursor = data.data.next_cursor;
                    } else {
                        // æ²¡æœ‰æ›´å¤šæ•°æ®äº†
                        newsCursor = '';
                    }
                    
                    renderNews(refresh);
                    
                    // Hide the loading message
                    showStatusMessage('news', '');
                    
                    // Show or hide load more button based on whether there's more data
                    const loadMoreButton = document.getElementById('load-more-news');
                    loadMoreButton.style.display = data.data.next_cursor ? 'inline-block' : 'none';
                } else {
                    throw new Error('Invalid news data format');
                }
            } catch (error) {
                console.error('è·å–æ–°é—»æ•°æ®å¤±è´¥:', error);
                showStatusMessage('news', `è·å–æ–°é—»å¤±è´¥: ${error.message}`, true);
            } finally {
                isLoadingNews = false;
            }
        }
        
        // Format news date
        function formatNewsDate(timestamp) {
            const date = new Date(timestamp * 1000);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffMins < 1) {
                return 'åˆšåˆš';
            } else if (diffMins < 60) {
                return `${diffMins}åˆ†é’Ÿå‰`;
            } else if (diffHours < 24) {
                return `${diffHours}å°æ—¶å‰`;
            } else if (diffDays < 7) {
                return `${diffDays}å¤©å‰`;
            } else {
                return date.toLocaleDateString('zh-CN');
            }
        }
        
        // Render news items
        function renderNews(refresh = false, targetId = 'news-container') {
            const container = document.getElementById(targetId);
            const isNewsTab = targetId === 'news-tab-container';
            const statusId = isNewsTab ? 'news-tab' : 'news';
            
            // Hide status message
            showStatusMessage(statusId, '');
            
            if (!newsData || newsData.length === 0) {
                container.innerHTML = '<div class="news-empty">æš‚æ— æ–°é—»æ•°æ®</div>';
                return;
            }
            
            // Clear container if refreshing
            if (refresh) {
                container.innerHTML = '';
            }
            
            // è¿‡æ»¤æ–°é—»æ•°æ®ï¼Œå¦‚æœåœ¨èµ„è®¯æ ‡ç­¾é¡µä¸”åªçœ‹é‡ç‚¹æ¨¡å¼å¼€å¯ï¼Œåˆ™åªæ˜¾ç¤ºscoreä¸º2çš„æ–°é—»
            const filteredNews = isNewsTab && showImportantOnly 
                ? newsData.filter(item => item.score === 2)
                : newsData;
            
            if (isNewsTab && showImportantOnly && filteredNews.length === 0) {
                container.innerHTML = '<div class="news-empty">æš‚æ— é‡ç‚¹æ–°é—»</div>';
                return;
            }
            
            filteredNews.forEach(item => {
                // Skip items that are already rendered in this container
                if (container.querySelector(`.news-item[data-id="${item.id}"]`)) {
                    return;
                }
                
                const newsItem = document.createElement('div');
                newsItem.className = 'news-item';
                newsItem.dataset.id = item.id;
                
                // å¦‚æœæ˜¯é‡ç‚¹æ–°é—»ï¼ˆscoreä¸º2ï¼‰ï¼Œæ·»åŠ ç‰¹æ®Šæ ·å¼
                if (item.score === 2) {
                    newsItem.classList.add('important-news');
                }
                
                // Create author info if available
                let authorHtml = '';
                if (item.author && item.author.display_name) {
                    authorHtml = `
                        <div class="news-author">
                            ${item.author.avatar ? `<img src="${item.author.avatar}" alt="${item.author.display_name}" class="news-avatar">` : ''}
                            <span class="news-author-name">${item.title || item.author.display_name}</span>
                            ${item.score === 2 ? '<span class="news-important-tag">é‡ç‚¹</span>' : ''}
                        </div>
                    `;
                } else if (item.title) {
                    authorHtml = `
                        <div class="news-author">
                            <span class="news-author-name">${item.title}</span>
                            ${item.score === 2 ? '<span class="news-important-tag">é‡ç‚¹</span>' : ''}
                        </div>
                    `;
                }
                
                // Format the content (remove HTML tags for safety if needed)
                const content = item.content_text || item.content || '';
                
                // æ£€æŸ¥æ˜¯å¦æœ‰å…³è”æ–‡ç« 
                let articleLinkHtml = '';
                if (item.article && item.article.id) {
                    const articleUrl = `https://wallstreetcn.com/articles/${item.article.id}`;
                    articleLinkHtml = `
                        <div class="news-article-link">
                            <a href="${articleUrl}" target="_blank" class="article-link-button">æŸ¥çœ‹å®Œæ•´æ–‡ç« </a>
                        </div>
                    `;
                }
                
                newsItem.innerHTML = `
                    <div class="news-item-header">
                        ${authorHtml}
                        <div class="news-time">${formatNewsDate(item.display_time)}</div>
                    </div>
                    <div class="news-content">${content}</div>
                    ${articleLinkHtml}
                `;
                
                container.appendChild(newsItem);
            });
            
            // Show/hide load more button based on data availability
            const loadMoreBtnId = isNewsTab ? 'load-more-news-tab' : 'load-more-news';
            document.getElementById(loadMoreBtnId).style.display = newsCursor ? 'block' : 'none';
        }
        
        // Initialize the app
        function init() {
            // Tab switching functionality
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    // Remove active class from all tabs
                    document.querySelectorAll('.tab-button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Add active class to clicked tab
                    button.classList.add('active');
                    const tabId = button.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    // If watchlist tab is selected, render it
                    if (tabId === 'watchlist') {
                        renderWatchlist();
                    }
                    // If news tab is selected, render it
                    else if (tabId === 'news') {
                        // å¦‚æœèµ„è®¯æ ‡ç­¾é¡µæ²¡æœ‰å†…å®¹ï¼Œåˆ™åŠ è½½æ–°é—»
                        if (document.getElementById('news-tab-container').children.length === 0) {
                            renderNews(false, 'news-tab-container');
                        }
                    }
                });
            });
            
            // Edit watchlist button
            document.getElementById('edit-watchlist').addEventListener('click', function() {
                isEditMode = !isEditMode;
                this.textContent = isEditMode ? 'å®Œæˆ' : 'ç¼–è¾‘';
                renderWatchlist();
            });
            
            // Sort watchlist buttons
            document.getElementById('sort-name').addEventListener('click', sortWatchlistByName);
            document.getElementById('sort-change').addEventListener('click', sortWatchlistByChange);
            
            // News buttons
            document.getElementById('refresh-news').addEventListener('click', () => fetchNews(true));
            document.getElementById('load-more-news').addEventListener('click', () => fetchNews());
            
            // èµ„è®¯æ ‡ç­¾é¡µæŒ‰é’®
            document.getElementById('toggle-important-news').addEventListener('click', function() {
                showImportantOnly = !showImportantOnly;
                this.textContent = showImportantOnly ? 'æ˜¾ç¤ºå…¨éƒ¨' : 'åªçœ‹é‡ç‚¹';
                renderNews(true, 'news-tab-container');
            });
            
            // æ ‡ç­¾åˆ‡æ¢æ—¶å¤„ç†èµ„è®¯è‡ªåŠ¨åˆ·æ–°
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    
                    // æ¸…é™¤ç°æœ‰çš„èµ„è®¯åˆ·æ–°è®¡æ—¶å™¨
                    if (newsRefreshTimer) {
                        clearInterval(newsRefreshTimer);
                        newsRefreshTimer = null;
                    }
                    
                    // å¦‚æœåˆ‡æ¢åˆ°èµ„è®¯æ ‡ç­¾ï¼Œå¯åŠ¨èµ„è®¯è‡ªåŠ¨åˆ·æ–°
                    if (tabId === 'news') {
                        startNewsAutoRefresh();
                    }
                });
            });
            document.getElementById('refresh-news-tab').addEventListener('click', () => {
                fetchNews(true);
                renderNews(true, 'news-tab-container');
                
                // é‡ç½®èµ„è®¯åˆ·æ–°å€’è®¡æ—¶
                newsCountdown = 30;
                if (document.querySelector('.tab-button[data-tab="news"]').classList.contains('active')) {
                    startNewsAutoRefresh();
                }
            });
            document.getElementById('load-more-news-tab').addEventListener('click', () => {
                fetchNews().then(() => renderNews(false, 'news-tab-container'));
            });
            
            // Load watchlist from localStorage
            loadWatchlist();
            
            // Initial data load
            updateAllData();
            fetchNews(true);
            
            // Auto-refresh every 20 seconds
            setInterval(updateAllData, 20000);
            // Auto-refresh news every 5 minutes (ä½œä¸ºå¤‡ç”¨ï¼Œç¡®ä¿å³ä½¿è‡ªåŠ¨åˆ·æ–°å¤±è´¥ä¹Ÿèƒ½æ›´æ–°)
            setInterval(() => {
                fetchNews(true);
                // å¦‚æœèµ„è®¯æ ‡ç­¾é¡µæ˜¯æ´»è·ƒçš„ï¼Œä¹Ÿæ›´æ–°å®ƒ
                if (document.querySelector('.tab-button[data-tab="news"]').classList.contains('active')) {
                    renderNews(true, 'news-tab-container');
                    // é‡ç½®èµ„è®¯åˆ·æ–°å€’è®¡æ—¶
                    newsCountdown = 30;
                }
            }, 300000);
            
            // å¯åŠ¨èµ„è®¯è‡ªåŠ¨åˆ·æ–°
            startNewsAutoRefresh();
        }
        
        // å¯åŠ¨èµ„è®¯è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½
        function startNewsAutoRefresh() {
            // æ¸…é™¤ç°æœ‰è®¡æ—¶å™¨
            if (newsRefreshTimer) {
                clearInterval(newsRefreshTimer);
            }
            
            // é‡ç½®å€’è®¡æ—¶
            newsCountdown = 30;
            
            // åˆ›å»ºæ–°çš„è®¡æ—¶å™¨
            newsRefreshTimer = setInterval(() => {
                // æ›´æ–°å€’è®¡æ—¶
                newsCountdown--;
                
                // åœ¨èµ„è®¯æ ‡ç­¾é¡µæ˜¾ç¤ºå€’è®¡æ—¶
                const newsTabStatus = document.getElementById('news-tab-status');
                if (newsTabStatus && document.querySelector('.tab-button[data-tab="news"]').classList.contains('active')) {
                    newsTabStatus.textContent = `è‡ªåŠ¨åˆ·æ–°å€’è®¡æ—¶: ${newsCountdown}ç§’`;
                    newsTabStatus.style.display = 'block';
                    newsTabStatus.className = 'loading';
                }
                
                // å½“å€’è®¡æ—¶ç»“æŸæ—¶åˆ·æ–°æ•°æ®
                if (newsCountdown <= 0) {
                    // é‡ç½®å€’è®¡æ—¶
                    newsCountdown = 30;
                    
                    // åˆ·æ–°èµ„è®¯æ•°æ®
                    fetchNews(true).then(() => {
                        // å¦‚æœèµ„è®¯æ ‡ç­¾é¡µæ˜¯æ´»è·ƒçš„ï¼Œæ›´æ–°æ˜¾ç¤º
                        if (document.querySelector('.tab-button[data-tab="news"]').classList.contains('active')) {
                            renderNews(true, 'news-tab-container');
                        }
                    });
                }
            }, 1000);
        }
        
        // Initialize the app when the DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
        
        // é¡µé¢å…³é—­æˆ–éšè—æ—¶æ¸…é™¤è®¡æ—¶å™¨
        window.addEventListener('beforeunload', () => {
            if (newsRefreshTimer) {
                clearInterval(newsRefreshTimer);
            }
        });
        
        // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶å¤„ç†è®¡æ—¶å™¨
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // é¡µé¢éšè—æ—¶æš‚åœè®¡æ—¶å™¨
                if (newsRefreshTimer) {
                    clearInterval(newsRefreshTimer);
                    newsRefreshTimer = null;
                }
            } else {
                // é¡µé¢å¯è§ä¸”èµ„è®¯æ ‡ç­¾é¡µæ´»è·ƒæ—¶é‡å¯è®¡æ—¶å™¨
                if (document.querySelector('.tab-button[data-tab="news"]').classList.contains('active')) {
                    startNewsAutoRefresh();
                }
            }
        });
    </script>
</body>
</html>