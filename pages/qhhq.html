<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Future WSJ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: rgba(0, 0, 0, 0.7);
            background-image: url('/pics/IMG_4151.jpeg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #fff;
            margin: 0;
            padding: 16px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 12px;
            backdrop-filter: blur(5px);
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .title {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .update-info {
            font-size: 0.8rem;
            color: #888;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .tab-button {
            background-color: transparent;
            border: none;
            color: #888;
            padding: 10px 20px;
            font-size: 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .tab-button.active {
            color: #00c853;
            border-bottom: 2px solid #00c853;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }
        
        .card {
            background-color: rgba(60, 64, 67, 0.85);
            border-radius: 12px;
            padding: 16px;
            transition: transform 0.2s, background-color 0.3s;
            position: relative;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        .card:hover {
            transform: translateY(-5px);
            background-color: rgba(45, 48, 50, 0.9);
        }
        
        .star-button {
            position: absolute;
            top: 12px;
            right: 12px;
            background: transparent;
            border: none;
            color: #888;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 10;
        }
        
        .star-button.active {
            color: #ffeb3b;
        }
        
        .card-title {
            font-size: 1.2rem;
            margin-bottom: 10px;
            margin-right: 30px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .card-price {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .card-change {
            font-size: 1.2rem;
            margin-bottom: 15px;
        }
        
        .negative {
            color: #00c853;
        }
        
        .positive {
            color: #ff5252;
        }
        
        .card-details {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #888;
            position: relative;
        }
        
        /* Ê∑ªÂä†Ë°åÊÉÖÂõæÊ†áÊåâÈíÆÊ†∑Âºè */
        .chart-button {
            position: absolute;
            bottom: 0;
            right: 0;
            background: transparent;
            border: none;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 3px;
            padding: 3px 6px;
            border-radius: 4px;
        }
        
        .chart-button:hover {
            background-color: rgba(0, 200, 83, 0.15);
            color: #38ff92;
        }
        
        .error-message {
            color: #ff5252;
            padding: 20px;
            font-size: small;
            text-align: center;
            background-color: rgba(255, 82, 82, 0.1);
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .loading {
            text-align: center;
            padding: 5px;
            font-size: small;
            margin-top: -35px;
            color: #d0dc95;
        }
        
        .watchlist-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .watchlist-sort {
            display: flex;
            gap: 8px;
        }
        
        .sort-button {
            background-color: #333;
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .watchlist-empty {
            text-align: center;
            padding: 40px;
            color: #888;
            background-color: #1a1a1a;
            border-radius: 12px;
        }
        
        .drag-handle {
            display: none;
            position: absolute;
            top: 10px;
            left: 10px;
            cursor: grab;
            color: #888;
            font-size: 1.2rem;
            z-index: 10;
        }
        
        .watchlist-mode .card {
            padding-left: 35px;
        }
        
        .watchlist-mode .drag-handle {
            display: block;
        }
        
        .drag-ghost {
            opacity: 0.5;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
            
            .card-price {
                font-size: 1.8rem;
            }
            
            .card-change {
                font-size: 1.1rem;
            }
            
            .chart-button {
                font-size: 1rem;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 8px;
            }
            
            .container {
                padding: 12px;
                border-radius: 10px;
            }
            
            .header {
                margin-bottom: 12px;
            }
            
            .title {
                font-size: 1.3rem;
            }
            
            .grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .card {
                padding: 10px;
                border-radius: 10px;
                transform: none;
            }
            
            .card:hover {
                transform: translateY(-3px);
            }
            
            .card-title {
                font-size: 0.9rem;
                margin-bottom: 6px;
                white-space: normal;
                height: auto;
                min-height: 36px;
                line-height: 1.2;
            }
            
            .card-price {
                font-size: 1.4rem;
                margin-bottom: 4px;
            }
            
            .card-change {
                font-size: 0.85rem;
                margin-bottom: 8px;
            }
            
            .card-details {
                font-size: 0.8rem;
                flex-direction: column;
                gap: 4px;
                padding-right: 30px; /* ‰∏∫Ë°åÊÉÖÊåâÈíÆÁïôÂá∫Á©∫Èó¥ */
            }
            
            .star-button {
                top: 8px;
                right: 8px;
                font-size: 1rem;
            }
            
            .chart-button {
                font-size: 0.9rem;
                padding: 2px 4px;
                bottom: 0;
                right: 0;
            }
            
            .tab-button {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            .footer {
                margin-top: 20px;
            }
        }
        
        .footer {
            margin-top: 40px;
            padding: 15px 0;
            border-top: 1px solid #333;
            text-align: center;
        }
        
        .footer p {
            margin: 0;
            font-size: 0.8rem;
            color: #888;
        }
        
        /* Êñ∞ÈóªÂå∫ÂüüÊ†∑Âºè - Ë∞ÉÊï¥Âêé */
        .news-section {
            margin-top: 40px;
        }
        
        .news-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .news-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0;
            color: #fff;
        }
        
        .news-controls {
            display: flex;
            gap: 10px;
        }
        
        .news-button {
            background-color: rgba(0, 200, 83, 0.2);
            border: 1px solid rgba(0, 200, 83, 0.5);
            color: #00c853;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .news-button:hover {
            background-color: rgba(0, 200, 83, 0.3);
            box-shadow: 0 2px 8px rgba(0, 200, 83, 0.3);
        }
        
        .news-item {
            background-color: rgba(60, 66, 74, 0.85);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            transition: transform 0.2s, background-color 0.3s;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(90, 200, 120, 0.2);
        }
        
        .news-item:hover {
            transform: translateY(-3px);
            background-color: rgba(65, 72, 80, 0.9);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
            border-color: rgba(90, 200, 120, 0.3);
        }
        
        .news-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .news-author {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .news-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid rgba(90, 200, 120, 0.3);
        }
        
        .news-author-name {
            font-size: 0.9rem;
            color: #a6e0af;
            font-weight: 500;
        }
        
        .news-time {
            font-size: 0.8rem;
            color: #aaa;
        }
        
        .news-content {
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 0;
            color: #f0f0f0;
        }
        
        .news-title-content {
            font-size: 1.1rem;
            font-weight: 500;
            margin: 8px 0;
            color: #ffffff;
        }
        
        .news-footer {
            text-align: center;
            margin-top: 20px;
        }
        
        .news-empty {
            text-align: center;
            padding: 40px;
            color: #bbb;
            background-color: rgba(50, 55, 60, 0.7);
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid rgba(90, 200, 120, 0.15);
        }
        
        /* ÊñáÁ´†ÈìæÊé•Ê†∑Âºè - Ë∞ÉÊï¥Âêé */
        .news-article-link {
            margin-top: 12px;
            text-align: right;
        }
        
        .article-link-button {
            display: inline-block;
            background-color: rgba(0, 200, 83, 0.2);
            border: 1px solid rgba(0, 200, 83, 0.5);
            color: #00d15b;
            padding: 6px 12px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.85rem;
            transition: all 0.3s;
        }
        
        .article-link-button:hover {
            background-color: rgba(0, 200, 83, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 200, 83, 0.3);
        }
        
        @media (max-width: 480px) {
            .news-item {
                padding: 12px;
                border-radius: 8px;
                margin-bottom: 10px;
            }
            
            .news-title {
                font-size: 1.2rem;
            }
            
            .news-content {
                font-size: 0.9rem;
                line-height: 1.6;
            }
            
            .news-title-content {
                font-size: 1rem;
                margin: 6px 0;
            }
            
            .news-button {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            
            .article-link-button {
                padding: 4px 10px;
                font-size: 0.8rem;
            }
            
            .news-article-link {
                margin-top: 8px;
            }
            
            .news-interactions {
                gap: 8px;
                margin-top: 8px;
                font-size: 0.75rem;
            }
            
            .interaction-icon {
                font-size: 0.8rem;
            }
        }
        
        /* ÈáçÁÇπÊñ∞ÈóªÊ†∑Âºè */
        .important-news {
            border: 1px solid rgba(255, 215, 0, 0.4);
            background-color: rgba(65, 72, 80, 0.95);
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.15);
        }
        
        /* Êñ∞ÈóªÊù•Ê∫êÊ†áÁ≠æÊ†∑Âºè */
        .news-source {
            font-size: 0.8rem;
            color: #aaa;
            margin-left: 8px;
            padding: 2px 6px;
            background-color: rgba(0, 200, 83, 0.1);
            border-radius: 4px;
        }
        
        /* ‰∏úÊñπË¥¢ÂØåÊ†∑Âºè */
        .eastmoney-item {
            border-left: 3px solid #f57c00;
        }
        
        .eastmoney-source {
            background-color: rgba(245, 124, 0, 0.1);
            color: #f57c00;
        }
        
        /* ‰∏úÊñπË¥¢ÂØåÊñ∞ÈóªÂå∫ÂüüÊ†∑Âºè */
        .eastmoney-item {
            border-left: 3px solid #f57c00;
            position: relative;
        }
        
        .eastmoney-source {
            background-color: rgba(245, 124, 0, 0.1);
            color: #f57c00;
        }
        
        .news-interactions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-top: 12px;
            color: #888;
            font-size: 0.8rem;
            flex-wrap: wrap;
        }
        
        .interaction-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .interaction-icon {
            font-size: 0.9rem;
        }
        
        .news-item-image {
            margin-top: 12px;
            width: 100%;
            max-height: 154px;
            border-radius: 8px;
            object-fit: cover;
            overflow: hidden;
        }
        
        .news-item-image img {
            width: 100%;
            height: auto;
            transition: transform 0.3s;
        }
        
        .news-item:hover .news-item-image img {
            transform: scale(1.05);
        }
        

        .eastmoney-hot {
            position: absolute;
            top: 12px;
            left: 0px;
            color: #ff3b30;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">ÊúüË¥ßË°åÊÉÖ</div>
            <div class="update-info">
                Êõ¥Êñ∞: <span id="last-update">-</span>
                <div>Ëá™Âä®Âà∑Êñ∞: <span id="countdown">20</span></div>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab-button" data-tab="watchlist">Ëá™ÈÄâ</button>
            <button class="tab-button active" data-tab="commodity">ÂïÜÂìÅ</button>
            <button class="tab-button" data-tab="forex">Â§ñÊ±á</button>
            <button class="tab-button" data-tab="bond">ÂÄ∫Âà∏</button>
            <button class="tab-button" data-tab="news">ËµÑËÆØ</button>
            <!-- <button class="tab-button" data-tab="watchlist">Ëá™ÈÄâ</button> -->
        </div>
        
        <div id="commodity-tab" class="tab-content active">
            <div id="commodity-status" class="loading">Âä†ËΩΩÊï∞ÊçÆ‰∏≠...</div>
            <div id="commodity-grid" class="grid"></div>
        </div>
        
        <div id="forex-tab" class="tab-content">
            <div id="forex-status" class="loading">Âä†ËΩΩÊï∞ÊçÆ‰∏≠...</div>
            <div id="forex-grid" class="grid"></div>
        </div>
        
        <div id="bond-tab" class="tab-content">
            <div id="bond-status" class="loading">Âä†ËΩΩÊï∞ÊçÆ‰∏≠...</div>
            <div id="bond-grid" class="grid"></div>
        </div>
        
        <div id="watchlist-tab" class="tab-content">
            <div class="watchlist-controls">
                <button id="edit-watchlist" class="sort-button">ÁºñËæë</button>
                <div class="watchlist-sort">
                    <button id="sort-name" class="sort-button">ÊåâÂêçÁß∞</button>
                    <button id="sort-change" class="sort-button">ÊåâÊ∂®Ë∑åÂπÖ</button>
                </div>
            </div>
            <div id="watchlist-status" class="loading">Âä†ËΩΩËá™ÈÄâ...</div>
            <div id="watchlist-grid" class="grid"></div>
        </div>
        
        <div id="news-tab" class="tab-content">
            <div class="watchlist-controls">
                <button id="toggle-important-news" class="sort-button">ÊòæÁ§∫ÂÖ®ÈÉ®</button>
                <div class="watchlist-sort">
                    <button id="refresh-news-tab" class="sort-button">Âà∑Êñ∞</button>
                </div>
            </div>
            <div id="news-tab-status" class="loading">Âä†ËΩΩËµÑËÆØ‰∏≠...</div>
            <div id="news-tab-container"></div>
            <div class="news-footer">
                <button id="load-more-news-tab" class="news-button">Âä†ËΩΩÊõ¥Â§ö</button>
            </div>
        </div>
    </div>

    <!-- Êñ∞ÈóªÂå∫Âüü -->
         <!-- ‰∏úÊñπË¥¢ÂØåÊñ∞ÈóªÂå∫Âüü -->
    <div class="news-section">
        <div class="container">
            <div class="news-header">
                <h2 class="news-title">‰∏úÊñπË¥¢ÂØåË¶ÅÈóª</h2>
                <div class="news-controls">
                    <button id="refresh-eastmoney-news" class="news-button">Âà∑Êñ∞</button>
                </div>
            </div>
            <div id="eastmoney-news-status" class="loading">Âä†ËΩΩ‰∏úÊñπË¥¢ÂØåÊñ∞Èóª‰∏≠...</div>
            <div id="eastmoney-news-container"></div>
            <div class="news-footer">
                <button id="load-more-eastmoney-news" class="news-button">Âä†ËΩΩÊõ¥Â§ö</button>
            </div>
        </div>
    </div>

    <div class="news-section">
        <div class="container">
            <div class="news-header">
                <h2 class="news-title">ÂçéÂ∞îË°óËßÅÈóª7x24Âø´ËÆØ</h2>
                <div class="news-controls">
                    <button id="refresh-news" class="news-button">Âà∑Êñ∞</button>
                </div>
            </div>
            <div id="news-status" class="loading">Âä†ËΩΩÊñ∞Èóª‰∏≠...</div>
            <div id="news-container"></div>
            <div class="news-footer">
                <button id="load-more-news" class="news-button">Âä†ËΩΩÊõ¥Â§ö</button>
            </div>
        </div>
    </div>
    

    <footer class="footer">
        <div class="container">
            <p>Created by ËãëÂπøÂ±± @2025</p>
        </div>
    </footer>

    <script>
        // API URLs
        const API_URLS = {
            commodity: 'https://api-ddc-wscn.awtmt.com/market/rank?market_type=forexdata&stk_type=commodity&order_by=none&sort_field=px_change_rate&limit=300&fields=prod_name%2Cprod_en_name%2Cprod_code%2Csymbol%2Clast_px%2Cpx_change%2Cpx_change_rate%2Chigh_px%2Clow_px%2Cweek_52_high%2Cweek_52_low%2Cprice_precision%2Cupdate_time',
            forex: 'https://api-ddc-wscn.awtmt.com/market/rank?market_type=forexdata&stk_type=forex&order_by=none&sort_field=px_change_rate&limit=100&fields=prod_name%2Cprod_en_name%2Cprod_code%2Csymbol%2Clast_px%2Cpx_change%2Cpx_change_rate%2Chigh_px%2Clow_px%2Cweek_52_high%2Cweek_52_low%2Cprice_precision%2Cupdate_time',
            bond: 'https://api-ddc-wscn.awtmt.com/market/rank?market_type=forexdata&stk_type=bond&order_by=none&sort_field=px_change_rate&limit=100&fields=prod_name%2Cprod_en_name%2Cprod_code%2Csymbol%2Clast_px%2Cpx_change%2Cpx_change_rate%2Chigh_px%2Clow_px%2Cweek_52_high%2Cweek_52_low%2Cprice_precision%2Cupdate_time',
            news: 'https://api-one-wscn.awtmt.com/apiv1/content/lives?channel=global-channel&accept=live%2Cvip-live&limit=20&cursor=',
            eastmoneyNews: 'https://q.889.ink/em_news?interact=1&client=wap_sf&biz=wap_stock&fcolName=columns&fcolValue=345&type=1,20&order=1&pageIndex=1&pageSize=8'
        };
        
        // Store all market data
        const marketData = {
            commodity: [],
            forex: [],
            bond: []
        };
        
        // Store news data
        let newsData = [];
        let newsCursor = '';
        let isLoadingNews = false;
        let showImportantOnly = true; // ÊòØÂê¶Âè™ÊòæÁ§∫ÈáçÁÇπÊñ∞ÈóªÁöÑÊ†áÂøó
        
        // ‰∏úÊñπË¥¢ÂØåÊñ∞ÈóªÊï∞ÊçÆ
        let eastmoneyNewsData = [];
        let eastmoneyPageIndex = 1;
        let isLoadingEastmoneyNews = false;
        
        // ËµÑËÆØËá™Âä®Âà∑Êñ∞ËÆ°Êó∂Âô®
        let newsRefreshTimer = null;
        let newsCountdown = 30; // ËµÑËÆØÂà∑Êñ∞ÂÄíËÆ°Êó∂Ôºå30Áßí
        
        // Watchlist management
        let watchlist = [];
        let isEditMode = false;
        
        // Tracking active fetches
        let activeFetches = {
            commodity: null,
            forex: null,
            bond: null
        };
        
        // Load watchlist from localStorage
        function loadWatchlist() {
            const savedWatchlist = localStorage.getItem('marketWatchlist');
            if (savedWatchlist) {
                try {
                    watchlist = JSON.parse(savedWatchlist);
                } catch (e) {
                    console.error('Failed to parse watchlist from localStorage', e);
                    watchlist = [];
                }
            }
        }
        
        // Save watchlist to localStorage
        function saveWatchlist() {
            localStorage.setItem('marketWatchlist', JSON.stringify(watchlist));
        }
        
        // Add or remove item from watchlist
        function toggleWatchlist(type, symbol) {
            const index = watchlist.findIndex(item => item.symbol === symbol);
            
            if (index !== -1) {
                // Remove from watchlist
                watchlist.splice(index, 1);
            } else {
                // Find the item data from the marketData
                const item = marketData[type].find(item => item[3] === symbol);
                if (item) {
                    watchlist.push({
                        type,
                        symbol,
                        order: watchlist.length // Add at the end by default
                    });
                }
            }
            
            saveWatchlist();
            renderWatchlist();
            
            // Also update the star in the original tab
            const starButton = document.querySelector(`.${type}-card[data-symbol="${symbol}"] .star-button`);
            if (starButton) {
                starButton.classList.toggle('active', isInWatchlist(symbol));
            }
        }
        
        // Check if an item is in the watchlist
        function isInWatchlist(symbol) {
            return watchlist.some(item => item.symbol === symbol);
        }
        
        // Format date/time
        function formatDateTime(timestamp) {
            const date = new Date(timestamp * 1000);
            return date.toLocaleString('zh-CN');
        }
        
        // Format price based on precision
        function formatPrice(price, precision) {
            precision = parseInt(precision) || 2;
            return parseFloat(price).toFixed(precision);
        }
        
        // Update countdown timer
        function updateCountdown(seconds) {
            document.getElementById('countdown').textContent = `${seconds} Áßí`;
        }
        
        // Show status message
        function showStatusMessage(tabId, message, isError = false) {
            const statusElement = document.getElementById(`${tabId}-status`);
            statusElement.textContent = message;
            statusElement.className = isError ? 'error-message' : 'loading';
            statusElement.style.display = message ? 'block' : 'none';
        }
        
        // Get market page URL for the symbol
        function getMarketPageUrl(symbol) {
            return `https://wallstreetcn.com/markets/codes/${symbol}.OTC`;
        }
        
        // Create a card for a market item
        function createCard(type, item, isWatchlist = false) {
            const name = item[0];
            const symbol = item[3];
            const price = parseFloat(item[4]);
            const change = parseFloat(item[5]);
            const changeRate = parseFloat(item[6]);
            const high = parseFloat(item[7]);
            const low = parseFloat(item[8]);
            const precision = item[11];
            const updateTime = parseInt(item[12]);
            const isPositive = change >= 0;
            
            const card = document.createElement('div');
            card.className = `card ${type}-card`;
            card.dataset.symbol = symbol;
            card.dataset.type = type;
            
            // Handle icon for the watchlist mode
            const dragHandle = `<div class="drag-handle" draggable="true">‚ò∞</div>`;
            
            // Star button for watchlist
            const starActive = isInWatchlist(symbol) ? 'active' : '';
            
            // Ê∑ªÂä†Ë°åÊÉÖÈìæÊé•ÊåâÈíÆ
            const chartUrl = getMarketPageUrl(symbol);
            
            card.innerHTML = `
                ${isWatchlist ? dragHandle : ''}
                <button class="star-button ${starActive}" title="${starActive ? '‰ªéËá™ÈÄâ‰∏≠Âà†Èô§' : 'Ê∑ªÂä†Âà∞Ëá™ÈÄâ'}">‚òÖ</button>
                <div class="card-title">${name} (${symbol})</div>
                <div class="card-price ${isPositive ? 'positive' : 'negative'}">${formatPrice(price, precision)}</div>
                <div class="card-change ${isPositive ? 'positive' : 'negative'}">
                    ${change >= 0 ? '+' : ''}${formatPrice(change, precision)} ${changeRate >= 0 ? '+' : ''}${changeRate.toFixed(2)}%
                </div>
                <div class="card-details">
                    <span>ÊúÄÈ´ò: ${formatPrice(high, precision)}</span>
                    <span>ÊúÄ‰Ωé: ${formatPrice(low, precision)}</span>
                    <a href="${chartUrl}" class="chart-button" title="Êü•ÁúãË°åÊÉÖ" target="_blank">
                        <span>üíπ</span>
                    </a>
                </div>
            `;
            
            // Add event listener for the star button
            const starButton = card.querySelector('.star-button');
            starButton.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleWatchlist(type, symbol);
            });
            
            // Add drag and drop functionality for watchlist items
            if (isWatchlist) {
                const handle = card.querySelector('.drag-handle');
                
                handle.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', symbol);
                    setTimeout(() => {
                        card.classList.add('drag-ghost');
                    }, 0);
                });
                
                handle.addEventListener('dragend', () => {
                    card.classList.remove('drag-ghost');
                });
                
                card.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });
                
                card.addEventListener('dragenter', (e) => {
                    e.preventDefault();
                    card.style.borderTop = '2px solid #00c853';
                });
                
                card.addEventListener('dragleave', () => {
                    card.style.borderTop = '';
                });
                
                card.addEventListener('drop', (e) => {
                    e.preventDefault();
                    card.style.borderTop = '';
                    
                    const draggedSymbol = e.dataTransfer.getData('text/plain');
                    if (draggedSymbol === symbol) return; // Same card, do nothing
                    
                    // Reorder the watchlist
                    const draggedIndex = watchlist.findIndex(item => item.symbol === draggedSymbol);
                    const dropIndex = watchlist.findIndex(item => item.symbol === symbol);
                    
                    if (draggedIndex !== -1 && dropIndex !== -1) {
                        const [removed] = watchlist.splice(draggedIndex, 1);
                        watchlist.splice(dropIndex, 0, removed);
                        
                        // Update orders
                        watchlist.forEach((item, index) => {
                            item.order = index;
                        });
                        
                        saveWatchlist();
                        renderWatchlist();
                    }
                });
            }
            
            return card;
        }
        
        // Render data cards for a specific tab
        function renderCards(tabId, data) {
            const grid = document.getElementById(`${tabId}-grid`);
            grid.innerHTML = '';
            
            if (!data || !data.length) {
                showStatusMessage(tabId, 'Ê≤°ÊúâÂèØÁî®Êï∞ÊçÆ', true);
                return;
            }
            
            // Hide status message
            showStatusMessage(tabId, '');
            
            data.forEach(item => {
                const card = createCard(tabId, item);
                grid.appendChild(card);
            });
        }
        
        // Render the watchlist
        function renderWatchlist() {
            const grid = document.getElementById('watchlist-grid');
            grid.innerHTML = '';
            
            if (isEditMode) {
                grid.classList.add('watchlist-mode');
            } else {
                grid.classList.remove('watchlist-mode');
            }
            
            if (!watchlist.length) {
                showStatusMessage('watchlist', '');
                
                const emptyMessage = document.createElement('div');
                emptyMessage.className = 'watchlist-empty';
                emptyMessage.textContent = 'ÊÇ®ÁöÑËá™ÈÄâÂàóË°®ÊòØÁ©∫ÁöÑ„ÄÇËØ∑Âú®ÂÖ∂‰ªñÊ†áÁ≠æÈ°µ‰∏≠ÁÇπÂáªÊòüÊ†áÊ∑ªÂä†È°πÁõÆÂà∞Ëá™ÈÄâ„ÄÇ';
                grid.appendChild(emptyMessage);
                return;
            }
            
            showStatusMessage('watchlist', '');
            
            // Sort watchlist by order (default)
            const sortedWatchlist = [...watchlist].sort((a, b) => a.order - b.order);
            
            sortedWatchlist.forEach(item => {
                const itemData = marketData[item.type].find(data => data[3] === item.symbol);
                if (itemData) {
                    const card = createCard(item.type, itemData, true);
                    grid.appendChild(card);
                }
            });
        }
        
        // Sort watchlist by name
        function sortWatchlistByName() {
            const grid = document.getElementById('watchlist-grid');
            const cards = Array.from(grid.children);
            
            cards.sort((a, b) => {
                const nameA = a.querySelector('.card-title').textContent;
                const nameB = b.querySelector('.card-title').textContent;
                return nameA.localeCompare(nameB);
            });
            
            grid.innerHTML = '';
            cards.forEach(card => grid.appendChild(card));
            
            // Update order in the watchlist
            updateWatchlistOrder();
        }
        
        // Sort watchlist by change rate
        function sortWatchlistByChange() {
            const grid = document.getElementById('watchlist-grid');
            const cards = Array.from(grid.children);
            
            cards.sort((a, b) => {
                const changeA = parseFloat(a.querySelector('.card-change').textContent.split('%')[0].split(' ').pop());
                const changeB = parseFloat(b.querySelector('.card-change').textContent.split('%')[0].split(' ').pop());
                return changeB - changeA; // Descending order (highest first)
            });
            
            grid.innerHTML = '';
            cards.forEach(card => grid.appendChild(card));
            
            // Update order in the watchlist
            updateWatchlistOrder();
        }
        
        // Update the order in the watchlist based on current DOM order
        function updateWatchlistOrder() {
            const grid = document.getElementById('watchlist-grid');
            const cards = Array.from(grid.children);
            
            cards.forEach((card, index) => {
                const symbol = card.dataset.symbol;
                const watchlistItem = watchlist.find(item => item.symbol === symbol);
                if (watchlistItem) {
                    watchlistItem.order = index;
                }
            });
            
            saveWatchlist();
        }
        
        // Fetch data from API
        async function fetchData(tabId) {
            // Cancel previous fetch if still pending
            if (activeFetches[tabId]) {
                activeFetches[tabId].aborted = true;
            }
            
            // Create a new AbortController for this request
            const controller = new AbortController();
            activeFetches[tabId] = { controller, aborted: false };
            
            try {
                showStatusMessage(tabId, 'Ëé∑ÂèñÊï∞ÊçÆ‰∏≠...');
                
                const url = API_URLS[tabId];
                const response = await fetch(url, { signal: controller.signal });
                
                // If this request was aborted, don't proceed
                if (activeFetches[tabId].aborted) {
                    return [];
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Update last update time
                document.getElementById('last-update').textContent = new Date().toLocaleTimeString('zh-CN');
                
                if (data && data.code === 20000 && data.data && data.data.candle) {
                    // Store the data for the watchlist to use
                    marketData[tabId] = data.data.candle;
                    return data.data.candle;
                } else {
                    throw new Error('Invalid data format');
                }
            } catch (error) {
                // Don't show errors for aborted requests
                if (error.name === 'AbortError' || activeFetches[tabId].aborted) {
                    return [];
                }
                
                console.error(`Ëé∑Âèñ${tabId}Êï∞ÊçÆÂ§±Ë¥•:`, error);
                showStatusMessage(tabId, `Ê≤°ÊúâÊñ∞Êï∞ÊçÆÔºÅ`, true);
                return [];
            } finally {
                // Clear the active fetch reference
                activeFetches[tabId] = null;
            }
        }
        
        // Update data for a specific tab
        async function updateTabData(tabId) {
            const data = await fetchData(tabId);
            renderCards(tabId, data);
            
            // If watchlist tab is active, update it too with the new data
            if (document.querySelector('.tab-button[data-tab="watchlist"]').classList.contains('active')) {
                renderWatchlist();
            }
        }
        
        // Update all tab data
        async function updateAllData() {
            // Get the active tab
            const activeTab = document.querySelector('.tab-button.active').getAttribute('data-tab');
            
            if (activeTab === 'watchlist') {
                // For watchlist, make sure we update all market data first
                await Promise.all([
                    updateTabData('commodity'),
                    updateTabData('forex'),
                    updateTabData('bond')
                ]);
                renderWatchlist();
            } else {
                // Update the active tab first for better user experience
                await updateTabData(activeTab);
                
                // Then update other tabs in the background
                for (const tabId of Object.keys(marketData)) {
                    if (tabId !== activeTab) {
                        updateTabData(tabId);
                    }
                }
            }
            
            // Reset and start countdown
            let count = 20;
            updateCountdown(count);
            
            const timer = setInterval(() => {
                count--;
                updateCountdown(count);
                
                if (count <= 0) {
                    clearInterval(timer);
                }
            }, 1000);
        }
        
        // Fetch news data from API
        async function fetchNews(refresh = false) {
            if (isLoadingNews) return;
            
            isLoadingNews = true;
            showStatusMessage('news', 'Ëé∑ÂèñÊñ∞Èóª‰∏≠...');
            
            try {
                // Reset cursor if refreshing
                if (refresh) {
                    newsCursor = '';
                }
                
                // ÊûÑÂª∫URLÔºåÊ≥®ÊÑèÂä†ÂÖ•clientÂíåfirst_pageÂèÇÊï∞
                const url = API_URLS.news + newsCursor + (newsCursor ? '&first_page=false' : '') + '&client=pc';
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data && data.code === 20000 && data.data) {
                    // If refreshing, replace the data, otherwise append
                    if (refresh) {
                        newsData = data.data.items || [];
                    } else {
                        // Á°Æ‰øù‰∏çÈáçÂ§çÊ∑ªÂä†
                        const newItems = (data.data.items || []).filter(item => 
                            !newsData.some(existing => existing.id === item.id)
                        );
                        newsData = [...newsData, ...newItems];
                    }
                    
                    // Store the next_cursor for pagination
                    if (data.data.next_cursor) {
                        newsCursor = data.data.next_cursor;
                    } else {
                        // Ê≤°ÊúâÊõ¥Â§öÊï∞ÊçÆ‰∫Ü
                        newsCursor = '';
                    }
                    
                    renderNews(refresh);
                    
                    // Hide the loading message
                    showStatusMessage('news', '');
                    
                    // Show or hide load more button based on whether there's more data
                    const loadMoreButton = document.getElementById('load-more-news');
                    loadMoreButton.style.display = data.data.next_cursor ? 'inline-block' : 'none';
                } else {
                    throw new Error('Invalid news data format');
                }
            } catch (error) {
                console.error('Ëé∑ÂèñÊñ∞ÈóªÊï∞ÊçÆÂ§±Ë¥•:', error);
                showStatusMessage('news', `Ëé∑ÂèñÊñ∞ÈóªÂ§±Ë¥•: ${error.message}`, true);
            } finally {
                isLoadingNews = false;
            }
        }
        
        // Ëé∑Âèñ‰∏úÊñπË¥¢ÂØåÊñ∞ÈóªÊï∞ÊçÆ
        async function fetchEastmoneyNews(refresh = false) {
            if (isLoadingEastmoneyNews) return;
            
            isLoadingEastmoneyNews = true;
            showStatusMessage('eastmoney-news', 'Ëé∑Âèñ‰∏úÊñπË¥¢ÂØåÊñ∞Èóª‰∏≠...');
            
            try {
                if (refresh) {
                    eastmoneyPageIndex = 1;
                }
                
                // ÊûÑÂª∫URL
                const url = API_URLS.eastmoneyNews.replace('pageIndex=1', `pageIndex=${eastmoneyPageIndex}`);
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data && data.code === 1 && data.data && data.data.list) {
                    // Â¶ÇÊûúÊòØÂà∑Êñ∞ÔºåÊõøÊç¢Êï∞ÊçÆÔºåÂê¶ÂàôËøΩÂä†
                    if (refresh) {
                        eastmoneyNewsData = data.data.list || [];
                    } else {
                        // Á°Æ‰øù‰∏çÈáçÂ§çÊ∑ªÂä†
                        const newItems = (data.data.list || []).filter(item => 
                            !eastmoneyNewsData.some(existing => existing.Art_Code === item.Art_Code)
                        );
                        eastmoneyNewsData = [...eastmoneyNewsData, ...newItems];
                    }
                    
                    // Â¢ûÂä†È°µÁ†ÅÁî®‰∫é‰∏ãÊ¨°Âä†ËΩΩÊõ¥Â§ö
                    eastmoneyPageIndex++;
                    
                    renderEastmoneyNews(refresh);
                    
                    // ÈöêËóèÂä†ËΩΩÊ∂àÊÅØ
                    showStatusMessage('eastmoney-news', '');
                    
                    // Ê†πÊçÆÊòØÂê¶ÊúâÊõ¥Â§öÊï∞ÊçÆÊòæÁ§∫ÊàñÈöêËóèÂä†ËΩΩÊõ¥Â§öÊåâÈíÆ
                    const loadMoreButton = document.getElementById('load-more-eastmoney-news');
                    if (loadMoreButton) {
                        loadMoreButton.style.display = data.data.list.length > 0 ? 'inline-block' : 'none';
                    }
                } else {
                    throw new Error('Êó†ÊïàÁöÑ‰∏úÊñπË¥¢ÂØåÊñ∞ÈóªÊï∞ÊçÆÊ†ºÂºè');
                }
            } catch (error) {
                console.error('Ëé∑Âèñ‰∏úÊñπË¥¢ÂØåÊñ∞ÈóªÊï∞ÊçÆÂ§±Ë¥•:', error);
                showStatusMessage('eastmoney-news', `Ëé∑Âèñ‰∏úÊñπË¥¢ÂØåÊñ∞ÈóªÂ§±Ë¥•: ${error.message}`, true);
            } finally {
                isLoadingEastmoneyNews = false;
            }
        }
        
        // Format news date
        function formatNewsDate(timestamp) {
            const date = new Date(timestamp * 1000);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffMins < 1) {
                return 'ÂàöÂàö';
            } else if (diffMins < 60) {
                return `${diffMins}ÂàÜÈíüÂâç`;
            } else if (diffHours < 24) {
                return `${diffHours}Â∞èÊó∂Ââç`;
            } else if (diffDays < 7) {
                return `${diffDays}Â§©Ââç`;
            } else {
                return date.toLocaleDateString('zh-CN');
            }
        }
        
        // Format date string
        function formatDateString(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffMins < 1) {
                return 'ÂàöÂàö';
            } else if (diffMins < 60) {
                return `${diffMins}ÂàÜÈíüÂâç`;
            } else if (diffHours < 24) {
                return `${diffHours}Â∞èÊó∂Ââç`;
            } else if (diffDays < 7) {
                return `${diffDays}Â§©Ââç`;
            } else {
                return date.toLocaleDateString('zh-CN');
            }
        }
        
        // Render news items
        function renderNews(refresh = false, targetId = 'news-container') {
            const container = document.getElementById(targetId);
            const isNewsTab = targetId === 'news-tab-container';
            const statusId = isNewsTab ? 'news-tab' : 'news';
            
            // Hide status message
            showStatusMessage(statusId, '');
            
            if (!newsData || newsData.length === 0) {
                container.innerHTML = '<div class="news-empty">ÊöÇÊó†Êñ∞ÈóªÊï∞ÊçÆ</div>';
                return;
            }
            
            // Clear container if refreshing
            if (refresh) {
                container.innerHTML = '';
            }
            
            // ËøáÊª§Êñ∞ÈóªÊï∞ÊçÆÔºåÂ¶ÇÊûúÂú®ËµÑËÆØÊ†áÁ≠æÈ°µ‰∏îÂè™ÁúãÈáçÁÇπÊ®°ÂºèÂºÄÂêØÔºåÂàôÂè™ÊòæÁ§∫score‰∏∫2ÁöÑÊñ∞Èóª
            const filteredNews = isNewsTab && showImportantOnly 
                ? newsData.filter(item => item.score === 2)
                : newsData;
            
            if (isNewsTab && showImportantOnly && filteredNews.length === 0) {
                container.innerHTML = '<div class="news-empty">ÊöÇÊó†ÈáçÁÇπÊñ∞Èóª</div>';
                return;
            }
            
            filteredNews.forEach(item => {
                // Skip items that are already rendered in this container
                if (container.querySelector(`.news-item[data-id="${item.id}"]`)) {
                    return;
                }
                
                const newsItem = document.createElement('div');
                newsItem.className = 'news-item';
                newsItem.dataset.id = item.id;
                newsItem.dataset.source = 'wsj'; // Ê†áËÆ∞‰∏∫ÂçéÂ∞îË°óËßÅÈóªÊù•Ê∫ê
                
                // Â¶ÇÊûúÊòØÈáçÁÇπÊñ∞ÈóªÔºàscore‰∏∫2ÔºâÔºåÊ∑ªÂä†ÁâπÊÆäÊ†∑Âºè
                if (item.score === 2) {
                    newsItem.classList.add('important-news');
                }
                
                // Create author info if available
                let authorHtml = '';
                if (item.author && item.author.display_name) {
                    authorHtml = `
                        <div class="news-author">
                            ${item.author.avatar ? `<img src="${item.author.avatar}" alt="${item.author.display_name}" class="news-avatar">` : ''}
                            <span class="news-author-name">${item.title || item.author.display_name}</span>
                            
                            ${item.score === 2 ? '<span class="news-important-tag">üî•</span>' : ''}
                        </div>
                    `;
                } else if (item.title) {
                    authorHtml = `
                        <div class="news-author">
                            <span class="news-author-name">${item.title}</span>
                            <span class="news-source">ÂçéÂ∞îË°óËßÅÈóª</span>
                            ${item.score === 2 ? '<span class="news-important-tag">ÈáçÁÇπ</span>' : ''}
                        </div>
                    `;
                }
                
                // Format the content (remove HTML tags for safety if needed)
                const content = item.content_text || item.content || '';
                
                // Ê£ÄÊü•ÊòØÂê¶ÊúâÂÖ≥ËÅîÊñáÁ´†
                let articleLinkHtml = '';
                if (item.article && item.article.id) {
                    const articleUrl = `https://wallstreetcn.com/articles/${item.article.id}`;
                    articleLinkHtml = `
                        <div class="news-article-link">
                            <a href="${articleUrl}" target="_blank" class="article-link-button">Êü•ÁúãÂÆåÊï¥ÊñáÁ´†</a>
                        </div>
                    `;
                }
                
                newsItem.innerHTML = `
                    <div class="news-item-header">
                        ${authorHtml}
                        <div class="news-time">${formatNewsDate(item.display_time)}</div>
                    </div>
                    <div class="news-content">${content}</div>
                    ${articleLinkHtml}
                `;
                
                container.appendChild(newsItem);
            });
            
            // Show/hide load more button based on data availability
            const loadMoreBtnId = isNewsTab ? 'load-more-news-tab' : 'load-more-news';
            document.getElementById(loadMoreBtnId).style.display = newsCursor ? 'block' : 'none';
        }
        
        // Ê∏≤Êüì‰∏úÊñπË¥¢ÂØåÊñ∞Èóª
        function renderEastmoneyNews(refresh = false) {
            const container = document.getElementById('eastmoney-news-container');
            
            // ÈöêËóèÁä∂ÊÄÅÊ∂àÊÅØ
            showStatusMessage('eastmoney-news', '');
            
            if (!eastmoneyNewsData || eastmoneyNewsData.length === 0) {
                container.innerHTML = '<div class="news-empty">ÊöÇÊó†‰∏úÊñπË¥¢ÂØåÊñ∞ÈóªÊï∞ÊçÆ</div>';
                return;
            }
            
            // Â¶ÇÊûúÊòØÂà∑Êñ∞ÔºåÊ∏ÖÁ©∫ÂÆπÂô®
            if (refresh) {
                container.innerHTML = '';
            }
            
            eastmoneyNewsData.forEach(item => {
                // Ë∑≥ËøáÂ∑≤ÁªèÊ∏≤ÊüìÁöÑÈ°πÁõÆ
                if (container.querySelector(`.news-item[data-id="${item.Art_Code}"]`)) {
                    return;
                }
                
                const newsItem = document.createElement('div');
                newsItem.className = 'news-item eastmoney-item';
                newsItem.dataset.id = item.Art_Code;
                newsItem.dataset.source = 'eastmoney';
                
                // Âà§Êñ≠ÊòØÂê¶ÁÉ≠Èó® (‰ΩøÁî®ÁÇπÂáªÈáèÂà§Êñ≠)
                const isHot = item.Interact && item.Interact.click_Num > 100000;
                
                // ÊûÑÂª∫HTMLÂÜÖÂÆπ
                const mediaName = item.Art_MediaName || '‰∏úÊñπË¥¢ÂØåÁΩë';
                const title = item.Art_Title || '‰∏úÊñπË¥¢ÂØåÂø´ËÆØ';
                const url = item.Art_Url || '';
                
                // ÁÇπÂáªÈáè„ÄÅËØÑËÆ∫Êï∞Á≠â‰∫íÂä®Êï∞ÊçÆ
                const clicks = item.Interact?.click_Num || 0;
                const comments = item.Interact?.pinglun_Num || 0;
                const likes = item.Interact?.like_Num || 0;
                const shares = item.Interact?.share_Num || 0;
                
                // ÂèëÂ∏ÉÊó∂Èó¥
                const publishTime = formatDateString(item.Art_ShowTime);
                
                // ÂõæÁâá
                const hasImage = !!item.Art_Image;
                
                let imageHtml = '';
                if (hasImage) {
                    imageHtml = `
                        <div class="news-item-image">
                            <img src="${item.Art_Image}" alt="${title}">
                        </div>
                    `;
                }
                
                // ÁÉ≠Èó®Ê†áÁ≠æ
                const hotLabel = isHot ? `<div class="eastmoney-hot">üî•</div>` : '';
                
                newsItem.innerHTML = `
                    ${hotLabel}
                    <div class="news-item-header">
                        <div class="news-author">
                            <span class="news-source eastmoney-source">${mediaName}</span>
                        </div>
                        <div class="news-time">${publishTime}</div>
                    </div>
                    <div class="news-content news-title-content">${title}</div>
                    <!-- ${imageHtml} -->
                    <div class="news-interactions">
                        <div class="interaction-item">
                            <span class="interaction-icon">üëÄ</span>
                            <span>${clicks.toLocaleString()}</span>
                        </div>
                        <div class="interaction-item">
                            <span class="interaction-icon">‚úçÔ∏è</span>
                            <span>${comments}</span>
                        </div>
                        <div class="interaction-item">
                            <span class="interaction-icon">üëç</span>
                            <span>${likes}</span>
                        </div>
                        <div class="interaction-item">
                            <span class="interaction-icon">üéâ</span>
                            <span>${shares}</span>
                        </div>
                    </div>
                    <div class="news-article-link">
                        <a href="${url}" target="_blank" class="article-link-button">Êü•ÁúãÂÖ®Êñá</a>
                    </div>
                `;
                
                container.appendChild(newsItem);
            });
            
            // ÊòæÁ§∫ÊàñÈöêËóèÂä†ËΩΩÊõ¥Â§öÊåâÈíÆ
            const loadMoreBtn = document.getElementById('load-more-eastmoney-news');
            if (loadMoreBtn) {
                loadMoreBtn.style.display = eastmoneyNewsData.length > 0 ? 'inline-block' : 'none';
            }
        }
        
        // Initialize the app
        function init() {
            // Tab switching functionality
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    // Remove active class from all tabs
                    document.querySelectorAll('.tab-button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Add active class to clicked tab
                    button.classList.add('active');
                    const tabId = button.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    // If watchlist tab is selected, render it
                    if (tabId === 'watchlist') {
                        renderWatchlist();
                    }
                    // If news tab is selected, render it
                    else if (tabId === 'news') {
                        // Â¶ÇÊûúËµÑËÆØÊ†áÁ≠æÈ°µÊ≤°ÊúâÂÜÖÂÆπÔºåÂàôÂä†ËΩΩÊñ∞Èóª
                        if (document.getElementById('news-tab-container').children.length === 0) {
                            renderNews(false, 'news-tab-container');
                        }
                    }
                });
            });
            
            // Edit watchlist button
            document.getElementById('edit-watchlist').addEventListener('click', function() {
                isEditMode = !isEditMode;
                this.textContent = isEditMode ? 'ÂÆåÊàê' : 'ÁºñËæë';
                renderWatchlist();
            });
            
            // Sort watchlist buttons
            document.getElementById('sort-name').addEventListener('click', sortWatchlistByName);
            document.getElementById('sort-change').addEventListener('click', sortWatchlistByChange);
            
            // News buttons
            document.getElementById('refresh-news').addEventListener('click', () => fetchNews(true));
            document.getElementById('load-more-news').addEventListener('click', () => fetchNews());
            
            // ‰∏úÊñπË¥¢ÂØåÊñ∞ÈóªÊåâÈíÆ
            document.getElementById('refresh-eastmoney-news').addEventListener('click', () => fetchEastmoneyNews(true));
            document.getElementById('load-more-eastmoney-news').addEventListener('click', () => fetchEastmoneyNews());
            
            // ËµÑËÆØÊ†áÁ≠æÈ°µÊåâÈíÆ
            document.getElementById('toggle-important-news').addEventListener('click', function() {
                showImportantOnly = !showImportantOnly;
                this.textContent = showImportantOnly ? 'ÊòæÁ§∫ÂÖ®ÈÉ®' : 'Âè™ÁúãÈáçÁÇπ';
                renderNews(true, 'news-tab-container');
            });
            
            // Ê†áÁ≠æÂàáÊç¢Êó∂Â§ÑÁêÜËµÑËÆØËá™Âä®Âà∑Êñ∞
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    
                    // Ê∏ÖÈô§Áé∞ÊúâÁöÑËµÑËÆØÂà∑Êñ∞ËÆ°Êó∂Âô®
                    if (newsRefreshTimer) {
                        clearInterval(newsRefreshTimer);
                        newsRefreshTimer = null;
                    }
                    
                    // Â¶ÇÊûúÂàáÊç¢Âà∞ËµÑËÆØÊ†áÁ≠æÔºåÂêØÂä®ËµÑËÆØËá™Âä®Âà∑Êñ∞
                    if (tabId === 'news') {
                        startNewsAutoRefresh();
                    }
                });
            });
            document.getElementById('refresh-news-tab').addEventListener('click', () => {
                fetchNews(true);
                renderNews(true, 'news-tab-container');
                
                // ÈáçÁΩÆËµÑËÆØÂà∑Êñ∞ÂÄíËÆ°Êó∂
                newsCountdown = 30;
                if (document.querySelector('.tab-button[data-tab="news"]').classList.contains('active')) {
                    startNewsAutoRefresh();
                }
            });
            document.getElementById('load-more-news-tab').addEventListener('click', () => {
                fetchNews().then(() => renderNews(false, 'news-tab-container'));
            });
            
            // Load watchlist from localStorage
            loadWatchlist();
            
            // Initial data load
            updateAllData();
            fetchNews(true);
            fetchEastmoneyNews(true);
            
            // Auto-refresh every 20 seconds
            setInterval(updateAllData, 20000);
            // Auto-refresh news every 5 minutes (‰Ωú‰∏∫Â§áÁî®ÔºåÁ°Æ‰øùÂç≥‰ΩøËá™Âä®Âà∑Êñ∞Â§±Ë¥•‰πüËÉΩÊõ¥Êñ∞)
            setInterval(() => {
                fetchNews(true);
                // Â¶ÇÊûúËµÑËÆØÊ†áÁ≠æÈ°µÊòØÊ¥ªË∑ÉÁöÑÔºå‰πüÊõ¥Êñ∞ÂÆÉ
                if (document.querySelector('.tab-button[data-tab="news"]').classList.contains('active')) {
                    renderNews(true, 'news-tab-container');
                    // ÈáçÁΩÆËµÑËÆØÂà∑Êñ∞ÂÄíËÆ°Êó∂
                    newsCountdown = 30;
                }
                
                // Ëá™Âä®Âà∑Êñ∞‰∏úÊñπË¥¢ÂØåÊñ∞Èóª
                fetchEastmoneyNews(true);
            }, 300000);
            
            // ÂêØÂä®ËµÑËÆØËá™Âä®Âà∑Êñ∞
            startNewsAutoRefresh();
        }
        
        // ÂêØÂä®ËµÑËÆØËá™Âä®Âà∑Êñ∞ÂäüËÉΩ
        function startNewsAutoRefresh() {
            // Ê∏ÖÈô§Áé∞ÊúâËÆ°Êó∂Âô®
            if (newsRefreshTimer) {
                clearInterval(newsRefreshTimer);
            }
            
            // ÈáçÁΩÆÂÄíËÆ°Êó∂
            newsCountdown = 30;
            
            // ÂàõÂª∫Êñ∞ÁöÑËÆ°Êó∂Âô®
            newsRefreshTimer = setInterval(() => {
                // Êõ¥Êñ∞ÂÄíËÆ°Êó∂
                newsCountdown--;
                
                // Âú®ËµÑËÆØÊ†áÁ≠æÈ°µÊòæÁ§∫ÂÄíËÆ°Êó∂
                const newsTabStatus = document.getElementById('news-tab-status');
                if (newsTabStatus && document.querySelector('.tab-button[data-tab="news"]').classList.contains('active')) {
                    newsTabStatus.textContent = `Ëá™Âä®Âà∑Êñ∞ÂÄíËÆ°Êó∂: ${newsCountdown}Áßí`;
                    newsTabStatus.style.display = 'block';
                    newsTabStatus.className = 'loading';
                }
                
                // ÂΩìÂÄíËÆ°Êó∂ÁªìÊùüÊó∂Âà∑Êñ∞Êï∞ÊçÆ
                if (newsCountdown <= 0) {
                    // ÈáçÁΩÆÂÄíËÆ°Êó∂
                    newsCountdown = 30;
                    
                    // Âà∑Êñ∞ËµÑËÆØÊï∞ÊçÆ
                    fetchNews(true).then(() => {
                        // Â¶ÇÊûúËµÑËÆØÊ†áÁ≠æÈ°µÊòØÊ¥ªË∑ÉÁöÑÔºåÊõ¥Êñ∞ÊòæÁ§∫
                        if (document.querySelector('.tab-button[data-tab="news"]').classList.contains('active')) {
                            renderNews(true, 'news-tab-container');
                        }
                    });
                }
            }, 1000);
        }
        
        // Initialize the app when the DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
        
        // È°µÈù¢ÂÖ≥Èó≠ÊàñÈöêËóèÊó∂Ê∏ÖÈô§ËÆ°Êó∂Âô®
        window.addEventListener('beforeunload', () => {
            if (newsRefreshTimer) {
                clearInterval(newsRefreshTimer);
            }
        });
        
        // È°µÈù¢ÂèØËßÅÊÄßÂèòÂåñÊó∂Â§ÑÁêÜËÆ°Êó∂Âô®
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // È°µÈù¢ÈöêËóèÊó∂ÊöÇÂÅúËÆ°Êó∂Âô®
                if (newsRefreshTimer) {
                    clearInterval(newsRefreshTimer);
                    newsRefreshTimer = null;
                }
            } else {
                // È°µÈù¢ÂèØËßÅ‰∏îËµÑËÆØÊ†áÁ≠æÈ°µÊ¥ªË∑ÉÊó∂ÈáçÂêØËÆ°Êó∂Âô®
                if (document.querySelector('.tab-button[data-tab="news"]').classList.contains('active')) {
                    startNewsAutoRefresh();
                }
            }
        });
    </script>
</body>
</html>